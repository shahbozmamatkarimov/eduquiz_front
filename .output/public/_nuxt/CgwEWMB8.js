import{z as L5,y as ih}from"./Dj6-4mtL.js";function k5(ba,nh){for(var so=0;so<nh.length;so++){const Ai=nh[so];if(typeof Ai!="string"&&!Array.isArray(Ai)){for(const Bt in Ai)if(Bt!=="default"&&!(Bt in ba)){const $t=Object.getOwnPropertyDescriptor(Ai,Bt);$t&&Object.defineProperty(ba,Bt,$t.get?$t:{enumerable:!0,get:()=>Ai[Bt]})}}}return Object.freeze(Object.defineProperty(ba,Symbol.toStringTag,{value:"Module"}))}var wN={exports:{}};(function(ba,nh){(function(so,Ai){ba.exports=Ai()})(ih,function(){function so(t,e){return e.forEach(function(i){i&&typeof i!="string"&&!Array.isArray(i)&&Object.keys(i).forEach(function(n){if(n!=="default"&&!(n in t)){var r=Object.getOwnPropertyDescriptor(i,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return i[n]}})}})}),Object.freeze(t)}var Ai=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof ih<"u"?ih:typeof self<"u"?self:{};function Bt(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var $t=function(t){try{return!!t()}catch{return!0}},sd=!$t(function(){var t=(function(){}).bind();return typeof t!="function"||t.hasOwnProperty("prototype")}),lf=sd,uf=Function.prototype,rh=uf.call,PN=lf&&uf.bind.bind(rh,rh),le=lf?PN:function(t){return function(){return rh.apply(t,arguments)}},ei=le({}.isPrototypeOf),wa=function(t){return t&&t.Math===Math&&t},re=wa(typeof globalThis=="object"&&globalThis)||wa(typeof window=="object"&&window)||wa(typeof self=="object"&&self)||wa(typeof Ai=="object"&&Ai)||wa(typeof Ai=="object"&&Ai)||function(){return this}()||Function("return this")(),LN=sd,hf=Function.prototype,pf=hf.apply,_f=hf.call,Oa=typeof Reflect=="object"&&Reflect.apply||(LN?_f.bind(pf):function(){return _f.apply(pf,arguments)}),Ef=le,kN=Ef({}.toString),MN=Ef("".slice),Yn=function(t){return MN(kN(t),8,-1)},UN=Yn,xN=le,Na=function(t){if(UN(t)==="Function")return xN(t)},sh=typeof document=="object"&&document.all,xe=sh===void 0&&sh!==void 0?function(t){return typeof t=="function"||t===sh}:function(t){return typeof t=="function"},od={},mi=!$t(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7}),VN=sd,ad=Function.prototype.call,We=VN?ad.bind(ad):function(){return ad.apply(ad,arguments)},cd={},mf={}.propertyIsEnumerable,ff=Object.getOwnPropertyDescriptor,FN=ff&&!mf.call({1:2},1);cd.f=FN?function(t){var e=ff(this,t);return!!e&&e.enumerable}:mf;var Ur,dd,xr=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},BN=$t,jN=Yn,oh=Object,GN=le("".split),ld=BN(function(){return!oh("z").propertyIsEnumerable(0)})?function(t){return jN(t)==="String"?GN(t,""):oh(t)}:oh,oo=function(t){return t==null},WN=oo,HN=TypeError,ms=function(t){if(WN(t))throw new HN("Can't call method on "+t);return t},KN=ld,YN=ms,Vr=function(t){return KN(YN(t))},qN=xe,fi=function(t){return typeof t=="object"?t!==null:qN(t)},zi={},ah=zi,ch=re,zN=xe,gf=function(t){return zN(t)?t:void 0},di=function(t,e){return arguments.length<2?gf(ah[t])||gf(ch[t]):ah[t]&&ah[t][e]||ch[t]&&ch[t][e]},Tf=re.navigator,Sf=Tf&&Tf.userAgent,Er=Sf?String(Sf):"",Rf=re,dh=Er,vf=Rf.process,Cf=Rf.Deno,If=vf&&vf.versions||Cf&&Cf.version,yf=If&&If.v8;yf&&(dd=(Ur=yf.split("."))[0]>0&&Ur[0]<4?1:+(Ur[0]+Ur[1])),!dd&&dh&&(!(Ur=dh.match(/Edge\/(\d+)/))||Ur[1]>=74)&&(Ur=dh.match(/Chrome\/(\d+)/))&&(dd=+Ur[1]);var fs=dd,Af=fs,JN=$t,XN=re.String,ao=!!Object.getOwnPropertySymbols&&!JN(function(){var t=Symbol("symbol detection");return!XN(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&Af&&Af<41}),bf=ao&&!Symbol.sham&&typeof Symbol.iterator=="symbol",QN=di,ZN=xe,$N=ei,tD=Object,Da=bf?function(t){return typeof t=="symbol"}:function(t){var e=QN("Symbol");return ZN(e)&&$N(e.prototype,tD(t))},eD=String,co=function(t){try{return eD(t)}catch{return"Object"}},iD=xe,nD=co,rD=TypeError,Li=function(t){if(iD(t))return t;throw new rD(nD(t)+" is not a function")},sD=Li,oD=oo,ud=function(t,e){var i=t[e];return oD(i)?void 0:sD(i)},wf=We,Of=xe,Nf=fi,aD=TypeError,Df={exports:{}},cD=!0,Pf=re,dD=Object.defineProperty,lD=re,uD=function(t,e){try{dD(Pf,t,{value:e,configurable:!0,writable:!0})}catch{Pf[t]=e}return e},Lf="__core-js_shared__",kf=Df.exports=lD[Lf]||uD(Lf,{});(kf.versions||(kf.versions=[])).push({version:"3.39.0",mode:"pure",copyright:"© 2014-2024 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.39.0/LICENSE",source:"https://github.com/zloirock/core-js"});var lh=Df.exports,Mf=lh,lo=function(t,e){return Mf[t]||(Mf[t]=e||{})},hD=ms,pD=Object,qn=function(t){return pD(hD(t))},_D=qn,ED=le({}.hasOwnProperty),He=Object.hasOwn||function(t,e){return ED(_D(t),e)},mD=le,fD=0,gD=Math.random(),TD=mD(1 .toString),uh=function(t){return"Symbol("+(t===void 0?"":t)+")_"+TD(++fD+gD,36)},SD=lo,Uf=He,RD=uh,vD=ao,CD=bf,uo=re.Symbol,hh=SD("wks"),ID=CD?uo.for||uo:uo&&uo.withoutSetter||RD,me=function(t){return Uf(hh,t)||(hh[t]=vD&&Uf(uo,t)?uo[t]:ID("Symbol."+t)),hh[t]},yD=We,xf=fi,Vf=Da,AD=ud,bD=function(t,e){var i,n;if(Of(i=t.toString)&&!Nf(n=wf(i,t))||Of(i=t.valueOf)&&!Nf(n=wf(i,t)))return n;throw new aD("Can't convert object to primitive value")},wD=TypeError,OD=me("toPrimitive"),ND=function(t,e){if(!xf(t)||Vf(t))return t;var i,n=AD(t,OD);if(n){if(i=yD(n,t,e),!xf(i)||Vf(i))return i;throw new wD("Can't convert object to primitive value")}return bD(t)},DD=Da,ph=function(t){var e=ND(t,"string");return DD(e)?e:e+""},Ff=fi,_h=re.document,PD=Ff(_h)&&Ff(_h.createElement),Eh=function(t){return PD?_h.createElement(t):{}},LD=Eh,Bf=!mi&&!$t(function(){return Object.defineProperty(LD("div"),"a",{get:function(){return 7}}).a!==7}),kD=mi,MD=We,UD=cd,xD=xr,VD=Vr,FD=ph,BD=He,jD=Bf,jf=Object.getOwnPropertyDescriptor;od.f=kD?jf:function(t,e){if(t=VD(t),e=FD(e),jD)try{return jf(t,e)}catch{}if(BD(t,e))return xD(!MD(UD.f,t,e),t[e])};var GD=$t,WD=xe,HD=/#|\.prototype\./,Pa=function(t,e){var i=YD[KD(t)];return i===zD||i!==qD&&(WD(e)?GD(e):!!e)},KD=Pa.normalize=function(t){return String(t).replace(HD,".").toLowerCase()},YD=Pa.data={},qD=Pa.NATIVE="N",zD=Pa.POLYFILL="P",Gf=Pa,JD=Li,XD=sd,QD=Na(Na.bind),Fr=function(t,e){return JD(t),e===void 0?t:XD?QD(t,e):function(){return t.apply(e,arguments)}},cn={},Wf=mi&&$t(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!==42}),ZD=fi,$D=String,tP=TypeError,bi=function(t){if(ZD(t))return t;throw new tP($D(t)+" is not an object")},eP=mi,iP=Bf,nP=Wf,hd=bi,Hf=ph,rP=TypeError,mh=Object.defineProperty,sP=Object.getOwnPropertyDescriptor,fh="enumerable",gh="configurable",Th="writable";cn.f=eP?nP?function(t,e,i){if(hd(t),e=Hf(e),hd(i),typeof t=="function"&&e==="prototype"&&"value"in i&&Th in i&&!i[Th]){var n=sP(t,e);n&&n[Th]&&(t[e]=i.value,i={configurable:gh in i?i[gh]:n[gh],enumerable:fh in i?i[fh]:n[fh],writable:!1})}return mh(t,e,i)}:mh:function(t,e,i){if(hd(t),e=Hf(e),hd(i),iP)try{return mh(t,e,i)}catch{}if("get"in i||"set"in i)throw new rP("Accessors not supported");return"value"in i&&(t[e]=i.value),t};var oP=cn,aP=xr,gs=mi?function(t,e,i){return oP.f(t,e,aP(1,i))}:function(t,e,i){return t[e]=i,t},La=re,cP=Oa,dP=Na,lP=xe,uP=od.f,hP=Gf,ho=zi,pP=Fr,po=gs,Kf=He,_P=function(t){var e=function(i,n,r){if(this instanceof e){switch(arguments.length){case 0:return new t;case 1:return new t(i);case 2:return new t(i,n)}return new t(i,n,r)}return cP(t,this,arguments)};return e.prototype=t.prototype,e},bt=function(t,e){var i,n,r,s,o,a,c,d,l,u=t.target,h=t.global,p=t.stat,T=t.proto,m=h?La:p?La[u]:La[u]&&La[u].prototype,f=h?ho:ho[u]||po(ho,u,{})[u],R=f.prototype;for(s in e)n=!(i=hP(h?s:u+(p?".":"#")+s,t.forced))&&m&&Kf(m,s),a=f[s],n&&(c=t.dontCallGetSet?(l=uP(m,s))&&l.value:m[s]),o=n&&c?c:e[s],(i||T||typeof a!=typeof o)&&(d=t.bind&&n?pP(o,La):t.wrap&&n?_P(o):T&&lP(o)?dP(o):o,(t.sham||o&&o.sham||a&&a.sham)&&po(d,"sham",!0),po(f,s,d),T&&(Kf(ho,r=u+"Prototype")||po(ho,r,{}),po(ho[r],s,o),t.real&&R&&(i||!R[s])&&po(R,s,o)))},EP=Math.ceil,mP=Math.floor,fP=Math.trunc||function(t){var e=+t;return(e>0?mP:EP)(e)},gP=fP,Sh=function(t){var e=+t;return e!=e||e===0?0:gP(e)},TP=Sh,SP=Math.max,RP=Math.min,Rh=function(t,e){var i=TP(t);return i<0?SP(i+e,0):RP(i,e)},vP=Sh,CP=Math.min,Yf=function(t){var e=vP(t);return e>0?CP(e,9007199254740991):0},IP=Yf,Br=function(t){return IP(t.length)},yP=Vr,AP=Rh,bP=Br,qf=function(t){return function(e,i,n){var r=yP(e),s=bP(r);if(s===0)return!t&&-1;var o,a=AP(n,s);if(t&&i!=i){for(;s>a;)if((o=r[a++])!=o)return!0}else for(;s>a;a++)if((t||a in r)&&r[a]===i)return t||a||0;return!t&&-1}},vh={includes:qf(!0),indexOf:qf(!1)},wP=vh.includes;bt({target:"Array",proto:!0,forced:$t(function(){return!Array(1).includes()})},{includes:function(t){return wP(this,t,arguments.length>1?arguments[1]:void 0)}});var OP=re,NP=zi,dn=function(t,e){var i=NP[t+"Prototype"],n=i&&i[e];if(n)return n;var r=OP[t],s=r&&r.prototype;return s&&s[e]},DP=dn("Array","includes"),PP=fi,LP=Yn,kP=me("match"),zf=function(t){var e;return PP(t)&&((e=t[kP])!==void 0?!!e:LP(t)==="RegExp")},MP=zf,UP=TypeError,Jf={};Jf[me("toStringTag")]="z";var Ch=String(Jf)==="[object z]",xP=Ch,VP=xe,pd=Yn,FP=me("toStringTag"),BP=Object,jP=pd(function(){return arguments}())==="Arguments",mr=xP?pd:function(t){var e,i,n;return t===void 0?"Undefined":t===null?"Null":typeof(i=function(r,s){try{return r[s]}catch{}}(e=BP(t),FP))=="string"?i:jP?pd(e):(n=pd(e))==="Object"&&VP(e.callee)?"Arguments":n},GP=mr,WP=String,ki=function(t){if(GP(t)==="Symbol")throw new TypeError("Cannot convert a Symbol value to a string");return WP(t)},HP=me("match"),KP=bt,YP=function(t){if(MP(t))throw new UP("The method doesn't accept regular expressions");return t},qP=ms,Xf=ki,zP=function(t){var e=/./;try{"/./"[t](e)}catch{try{return e[HP]=!1,"/./"[t](e)}catch{}}return!1},JP=le("".indexOf);KP({target:"String",proto:!0,forced:!zP("includes")},{includes:function(t){return!!~JP(Xf(qP(this)),Xf(YP(t)),arguments.length>1?arguments[1]:void 0)}});var XP=dn("String","includes"),Qf=ei,QP=DP,ZP=XP,Ih=Array.prototype,yh=String.prototype,$P=function(t){var e=t.includes;return t===Ih||Qf(Ih,t)&&e===Ih.includes?QP:typeof t=="string"||t===yh||Qf(yh,t)&&e===yh.includes?ZP:e},B=Bt($P),tL=Li,eL=qn,iL=ld,nL=Br,Zf=TypeError,$f="Reduce of empty array with no initial value",tg=function(t){return function(e,i,n,r){var s=eL(e),o=iL(s),a=nL(s);if(tL(i),a===0&&n<2)throw new Zf($f);var c=t?a-1:0,d=t?-1:1;if(n<2)for(;;){if(c in o){r=o[c],c+=d;break}if(c+=d,t?c<0:a<=c)throw new Zf($f)}for(;t?c>=0:a>c;c+=d)c in o&&(r=i(r,o[c],c,s));return r}},rL={left:tg(!1),right:tg(!0)},sL=$t,_d=function(t,e){var i=[][t];return!!i&&sL(function(){i.call(null,e||function(){return 1},1)})},ka=re,oL=Er,aL=Yn,Ed=function(t){return oL.slice(0,t.length)===t},Ah=Ed("Bun/")?"BUN":Ed("Cloudflare-Workers")?"CLOUDFLARE":Ed("Deno/")?"DENO":Ed("Node.js/")?"NODE":ka.Bun&&typeof Bun.version=="string"?"BUN":ka.Deno&&typeof Deno.version=="object"?"DENO":aL(ka.process)==="process"?"NODE":ka.window&&ka.document?"BROWSER":"REST",md=Ah==="NODE",cL=rL.left;bt({target:"Array",proto:!0,forced:!md&&fs>79&&fs<83||!_d("reduce")},{reduce:function(t){var e=arguments.length;return cL(this,t,e,e>1?arguments[1]:void 0)}});var dL=dn("Array","reduce"),lL=ei,uL=dL,bh=Array.prototype,hL=function(t){var e=t.reduce;return t===bh||lL(bh,t)&&e===bh.reduce?uL:e},eg=hL,wn=Bt(eg),pL=Yn,Ma=Array.isArray||function(t){return pL(t)==="Array"},_L=bt,EL=Ma,mL=le([].reverse),ig=[1,2];_L({target:"Array",proto:!0,forced:String(ig)===String(ig.reverse())},{reverse:function(){return EL(this)&&(this.length=this.length),mL(this)}});var fL=dn("Array","reverse"),gL=ei,TL=fL,wh=Array.prototype,SL=function(t){var e=t.reverse;return t===wh||gL(wh,t)&&e===wh.reverse?TL:e},ng=SL,rg=Bt(ng),RL=uh,sg=lo("keys"),fd=function(t){return sg[t]||(sg[t]=RL(t))},vL=!$t(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}),CL=He,IL=xe,yL=qn,AL=vL,og=fd("IE_PROTO"),Oh=Object,bL=Oh.prototype,Nh=AL?Oh.getPrototypeOf:function(t){var e=yL(t);if(CL(e,og))return e[og];var i=e.constructor;return IL(i)&&e instanceof i?i.prototype:e instanceof Oh?bL:null},wL=le,OL=Li,NL=fi,DL=function(t){return NL(t)||t===null},PL=String,LL=TypeError,kL=function(t,e,i){try{return wL(OL(Object.getOwnPropertyDescriptor(t,e)[i]))}catch{}},ML=fi,UL=ms,xL=function(t){if(DL(t))return t;throw new LL("Can't set "+PL(t)+" as a prototype")},VL=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,i={};try{(t=kL(Object.prototype,"__proto__","set"))(i,[]),e=i instanceof Array}catch{}return function(n,r){return UL(n),xL(r),ML(n)&&(e?t(n,r):n.__proto__=r),n}}():void 0),gd={},Td={},Dh=He,FL=Vr,BL=vh.indexOf,jL=Td,ag=le([].push),cg=function(t,e){var i,n=FL(t),r=0,s=[];for(i in n)!Dh(jL,i)&&Dh(n,i)&&ag(s,i);for(;e.length>r;)Dh(n,i=e[r++])&&(~BL(s,i)||ag(s,i));return s},Ph=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],GL=cg,WL=Ph.concat("length","prototype");gd.f=Object.getOwnPropertyNames||function(t){return GL(t,WL)};var Ua={};Ua.f=Object.getOwnPropertySymbols;var HL=di,KL=gd,YL=Ua,qL=bi,zL=le([].concat),JL=HL("Reflect","ownKeys")||function(t){var e=KL.f(qL(t)),i=YL.f;return i?zL(e,i(t)):e},dg=He,XL=JL,QL=od,ZL=cn,Lh={},$L=cg,tk=Ph,Sd=Object.keys||function(t){return $L(t,tk)},ek=mi,ik=Wf,nk=cn,rk=bi,sk=Vr,ok=Sd;Lh.f=ek&&!ik?Object.defineProperties:function(t,e){rk(t);for(var i,n=sk(e),r=ok(e),s=r.length,o=0;s>o;)nk.f(t,i=r[o++],n[i]);return t};var Rd,lg=di("document","documentElement"),ak=bi,ck=Lh,ug=Ph,dk=Td,lk=lg,uk=Eh,kh="prototype",Mh="script",hg=fd("IE_PROTO"),Uh=function(){},pg=function(t){return"<"+Mh+">"+t+"</"+Mh+">"},_g=function(t){t.write(pg("")),t.close();var e=t.parentWindow.Object;return t=null,e},vd=function(){try{Rd=new ActiveXObject("htmlfile")}catch{}var t,e,i;vd=typeof document<"u"?document.domain&&Rd?_g(Rd):(e=uk("iframe"),i="java"+Mh+":",e.style.display="none",lk.appendChild(e),e.src=String(i),(t=e.contentWindow.document).open(),t.write(pg("document.F=Object")),t.close(),t.F):_g(Rd);for(var n=ug.length;n--;)delete vd[kh][ug[n]];return vd()};dk[hg]=!0;var xa=Object.create||function(t,e){var i;return t!==null?(Uh[kh]=ak(t),i=new Uh,Uh[kh]=null,i[hg]=t):i=vd(),e===void 0?i:ck.f(i,e)},hk=fi,pk=gs,Eg=Error,_k=le("".replace),Ek=String(new Eg("zxcasd").stack),mg=/\n\s*at [^:]*:[^\n]*/,mk=mg.test(Ek),fk=xr,gk=!$t(function(){var t=new Error("a");return!("stack"in t)||(Object.defineProperty(t,"stack",fk(1,7)),t.stack!==7)}),Tk=gs,Sk=function(t,e){if(mk&&typeof t=="string"&&!Eg.prepareStackTrace)for(;e--;)t=_k(t,mg,"");return t},Rk=gk,fg=Error.captureStackTrace,Ts={},vk=Ts,Ck=me("iterator"),Ik=Array.prototype,gg=function(t){return t!==void 0&&(vk.Array===t||Ik[Ck]===t)},yk=mr,Tg=ud,Ak=oo,bk=Ts,wk=me("iterator"),Cd=function(t){if(!Ak(t))return Tg(t,wk)||Tg(t,"@@iterator")||bk[yk(t)]},Ok=We,Nk=Li,Dk=bi,Pk=co,Lk=Cd,kk=TypeError,xh=function(t,e){var i=arguments.length<2?Lk(t):e;if(Nk(i))return Dk(Ok(i,t));throw new kk(Pk(t)+" is not iterable")},Mk=We,Sg=bi,Uk=ud,Rg=function(t,e,i){var n,r;Sg(t);try{if(!(n=Uk(t,"return"))){if(e==="throw")throw i;return i}n=Mk(n,t)}catch(s){r=!0,n=s}if(e==="throw")throw i;if(r)throw n;return Sg(n),i},xk=Fr,Vk=We,Fk=bi,Bk=co,jk=gg,Gk=Br,vg=ei,Wk=xh,Hk=Cd,Cg=Rg,Kk=TypeError,Id=function(t,e){this.stopped=t,this.result=e},Ig=Id.prototype,Va=function(t,e,i){var n,r,s,o,a,c,d,l=i&&i.that,u=!(!i||!i.AS_ENTRIES),h=!(!i||!i.IS_RECORD),p=!(!i||!i.IS_ITERATOR),T=!(!i||!i.INTERRUPTED),m=xk(e,l),f=function(v){return n&&Cg(n,"normal",v),new Id(!0,v)},R=function(v){return u?(Fk(v),T?m(v[0],v[1],f):m(v[0],v[1])):T?m(v,f):m(v)};if(h)n=t.iterator;else if(p)n=t;else{if(!(r=Hk(t)))throw new Kk(Bk(t)+" is not iterable");if(jk(r)){for(s=0,o=Gk(t);o>s;s++)if((a=R(t[s]))&&vg(Ig,a))return a;return new Id(!1)}n=Wk(t,r)}for(c=h?t.next:n.next;!(d=Vk(c,n)).done;){try{a=R(d.value)}catch(v){Cg(n,"throw",v)}if(typeof a=="object"&&a&&vg(Ig,a))return a}return new Id(!1)},Yk=ki,qk=bt,zk=ei,Jk=Nh,yd=VL,Xk=function(t,e,i){for(var n=XL(e),r=ZL.f,s=QL.f,o=0;o<n.length;o++){var a=n[o];dg(t,a)||i&&dg(i,a)||r(t,a,s(e,a))}},yg=xa,Vh=gs,Fh=xr,Qk=function(t,e){hk(e)&&"cause"in e&&pk(t,"cause",e.cause)},Zk=function(t,e,i,n){Rk&&(fg?fg(t,e):Tk(t,"stack",Sk(i,n)))},$k=Va,t1=function(t,e){return t===void 0?arguments.length<2?"":e:Yk(t)},e1=me("toStringTag"),Ad=Error,i1=[].push,_o=function(t,e){var i,n=zk(Bh,this);yd?i=yd(new Ad,n?Jk(this):Bh):(i=n?this:yg(Bh),Vh(i,e1,"Error")),e!==void 0&&Vh(i,"message",t1(e)),Zk(i,_o,i.stack,1),arguments.length>2&&Qk(i,arguments[2]);var r=[];return $k(t,i1,{that:r}),Vh(i,"errors",r),i};yd?yd(_o,Ad):Xk(_o,Ad,{name:!0});var Bh=_o.prototype=yg(Ad.prototype,{constructor:Fh(1,_o),message:Fh(1,""),name:Fh(1,"AggregateError")});qk({global:!0,constructor:!0,arity:2},{AggregateError:_o});var bd,Fa,wd,n1=xe,Ag=re.WeakMap,r1=n1(Ag)&&/native code/.test(String(Ag)),bg=re,s1=fi,o1=gs,jh=He,Gh=lh,a1=fd,c1=Td,wg="Object already initialized",Wh=bg.TypeError,d1=bg.WeakMap;if(r1||Gh.state){var zn=Gh.state||(Gh.state=new d1);zn.get=zn.get,zn.has=zn.has,zn.set=zn.set,bd=function(t,e){if(zn.has(t))throw new Wh(wg);return e.facade=t,zn.set(t,e),e},Fa=function(t){return zn.get(t)||{}},wd=function(t){return zn.has(t)}}else{var Eo=a1("state");c1[Eo]=!0,bd=function(t,e){if(jh(t,Eo))throw new Wh(wg);return e.facade=t,o1(t,Eo,e),e},Fa=function(t){return jh(t,Eo)?t[Eo]:{}},wd=function(t){return jh(t,Eo)}}var Ss,Og,Ng,Rs={set:bd,get:Fa,has:wd,enforce:function(t){return wd(t)?Fa(t):bd(t,{})},getterFor:function(t){return function(e){var i;if(!s1(e)||(i=Fa(e)).type!==t)throw new Wh("Incompatible receiver, "+t+" required");return i}}},Hh=mi,l1=He,Dg=Function.prototype,u1=Hh&&Object.getOwnPropertyDescriptor,Kh=l1(Dg,"name"),Pg={EXISTS:Kh,PROPER:Kh&&(function(){}).name==="something",CONFIGURABLE:Kh&&(!Hh||Hh&&u1(Dg,"name").configurable)},h1=gs,jr=function(t,e,i,n){return n&&n.enumerable?t[e]=i:h1(t,e,i),t},p1=$t,_1=xe,E1=fi,m1=xa,Lg=Nh,f1=jr,Yh=me("iterator"),kg=!1;[].keys&&("next"in(Ng=[].keys())?(Og=Lg(Lg(Ng)))!==Object.prototype&&(Ss=Og):kg=!0);var g1=!E1(Ss)||p1(function(){var t={};return Ss[Yh].call(t)!==t});_1((Ss=g1?{}:m1(Ss))[Yh])||f1(Ss,Yh,function(){return this});var Mg={IteratorPrototype:Ss,BUGGY_SAFARI_ITERATORS:kg},T1=mr,S1=Ch?{}.toString:function(){return"[object "+T1(this)+"]"},R1=Ch,v1=cn.f,C1=gs,I1=He,y1=S1,Ug=me("toStringTag"),fr=function(t,e,i,n){var r=i?t:t&&t.prototype;r&&(I1(r,Ug)||v1(r,Ug,{configurable:!0,value:e}),n&&!R1&&C1(r,"toString",y1))},A1=Mg.IteratorPrototype,b1=xa,w1=xr,O1=fr,N1=Ts,D1=function(){return this},qh=function(t,e,i,n){var r=e+" Iterator";return t.prototype=b1(A1,{next:w1(+!n,i)}),O1(t,r,!1,!0),N1[r]=D1,t},P1=bt,L1=We,k1=Pg,M1=qh,U1=Nh,x1=fr,xg=jr,Vg=Ts,V1=Mg,F1=k1.PROPER,Od=V1.BUGGY_SAFARI_ITERATORS,zh=me("iterator"),Fg="keys",Nd="values",Bg="entries",B1=function(){return this},jg=function(t,e,i,n,r,s,o){M1(i,e,n);var a,c,d,l=function(R){if(R===r&&m)return m;if(!Od&&R&&R in p)return p[R];switch(R){case Fg:case Nd:case Bg:return function(){return new i(this,R)}}return function(){return new i(this)}},u=e+" Iterator",h=!1,p=t.prototype,T=p[zh]||p["@@iterator"]||r&&p[r],m=!Od&&T||l(r),f=e==="Array"&&p.entries||T;if(f&&(a=U1(f.call(new t)))!==Object.prototype&&a.next&&(x1(a,u,!0,!0),Vg[u]=B1),F1&&r===Nd&&T&&T.name!==Nd&&(h=!0,m=function(){return L1(T,this)}),r)if(c={values:l(Nd),keys:s?m:l(Fg),entries:l(Bg)},o)for(d in c)(Od||h||!(d in p))&&xg(p,d,c[d]);else P1({target:e,proto:!0,forced:Od||h},c);return o&&p[zh]!==m&&xg(p,zh,m,{name:r}),Vg[e]=m,c},Dd=function(t,e){return{value:t,done:e}},j1=Vr,Gg=Ts,Wg=Rs;cn.f;var G1=jg,Pd=Dd,Hg="Array Iterator",W1=Wg.set,H1=Wg.getterFor(Hg);G1(Array,"Array",function(t,e){W1(this,{type:Hg,target:j1(t),index:0,kind:e})},function(){var t=H1(this),e=t.target,i=t.index++;if(!e||i>=e.length)return t.target=null,Pd(void 0,!0);switch(t.kind){case"keys":return Pd(i,!1);case"values":return Pd(e[i],!1)}return Pd([i,e[i]],!1)},"values"),Gg.Arguments=Gg.Array;var K1=cn,Ld=function(t,e,i){return K1.f(t,e,i)},Y1=di,q1=Ld,z1=mi,Kg=me("species"),J1=ei,X1=TypeError,Jh=function(t,e){if(J1(e,t))return t;throw new X1("Incorrect invocation")},Q1=xe,Xh=lh,Z1=le(Function.toString);Q1(Xh.inspectSource)||(Xh.inspectSource=function(t){return Z1(t)});var Yg=Xh.inspectSource,$1=le,tM=$t,qg=xe,eM=mr,iM=Yg,zg=function(){},Jg=di("Reflect","construct"),Qh=/^\s*(?:class|function)\b/,nM=$1(Qh.exec),rM=!Qh.test(zg),Ba=function(t){if(!qg(t))return!1;try{return Jg(zg,[],t),!0}catch{return!1}},Xg=function(t){if(!qg(t))return!1;switch(eM(t)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return rM||!!nM(Qh,iM(t))}catch{return!0}};Xg.sham=!0;var ja,mo,Qg,Zh,kd=!Jg||tM(function(){var t;return Ba(Ba.call)||!Ba(Object)||!Ba(function(){t=!0})||t})?Xg:Ba,sM=kd,oM=co,aM=TypeError,Zg=bi,cM=function(t){if(sM(t))return t;throw new aM(oM(t)+" is not a constructor")},dM=oo,lM=me("species"),$h=function(t,e){var i,n=Zg(t).constructor;return n===void 0||dM(i=Zg(n)[lM])?e:cM(i)},Gr=le([].slice),uM=TypeError,vs=function(t,e){if(t<e)throw new uM("Not enough arguments");return t},$g=/(?:ipad|iphone|ipod).*applewebkit/i.test(Er),Ji=re,hM=Oa,pM=Fr,tT=xe,_M=He,eT=$t,iT=lg,EM=Gr,nT=Eh,mM=vs,fM=$g,gM=md,tp=Ji.setImmediate,ep=Ji.clearImmediate,TM=Ji.process,ip=Ji.Dispatch,SM=Ji.Function,rT=Ji.MessageChannel,RM=Ji.String,np=0,Ga={},sT="onreadystatechange";eT(function(){ja=Ji.location});var rp=function(t){if(_M(Ga,t)){var e=Ga[t];delete Ga[t],e()}},sp=function(t){return function(){rp(t)}},oT=function(t){rp(t.data)},aT=function(t){Ji.postMessage(RM(t),ja.protocol+"//"+ja.host)};tp&&ep||(tp=function(t){mM(arguments.length,1);var e=tT(t)?t:SM(t),i=EM(arguments,1);return Ga[++np]=function(){hM(e,void 0,i)},mo(np),np},ep=function(t){delete Ga[t]},gM?mo=function(t){TM.nextTick(sp(t))}:ip&&ip.now?mo=function(t){ip.now(sp(t))}:rT&&!fM?(Zh=(Qg=new rT).port2,Qg.port1.onmessage=oT,mo=pM(Zh.postMessage,Zh)):Ji.addEventListener&&tT(Ji.postMessage)&&!Ji.importScripts&&ja&&ja.protocol!=="file:"&&!eT(aT)?(mo=aT,Ji.addEventListener("message",oT,!1)):mo=sT in nT("script")?function(t){iT.appendChild(nT("script"))[sT]=function(){iT.removeChild(this),rp(t)}}:function(t){setTimeout(sp(t),0)});var Md={set:tp,clear:ep},cT=re,vM=mi,CM=Object.getOwnPropertyDescriptor,dT=function(t){if(!vM)return cT[t];var e=CM(cT,t);return e&&e.value},lT=function(){this.head=null,this.tail=null};lT.prototype={add:function(t){var e={item:t,next:null},i=this.tail;i?i.next=e:this.head=e,this.tail=e},get:function(){var t=this.head;if(t)return(this.head=t.next)===null&&(this.tail=null),t.item}};var fo,op,ap,cp,uT,hT=lT,IM=/ipad|iphone|ipod/i.test(Er)&&typeof Pebble<"u",yM=/web0s(?!.*chrome)/i.test(Er),go=re,AM=dT,pT=Fr,dp=Md.set,bM=hT,wM=$g,OM=IM,NM=yM,lp=md,_T=go.MutationObserver||go.WebKitMutationObserver,ET=go.document,mT=go.process,Ud=go.Promise,up=AM("queueMicrotask");if(!up){var xd=new bM,Vd=function(){var t,e;for(lp&&(t=mT.domain)&&t.exit();e=xd.get();)try{e()}catch(i){throw xd.head&&fo(),i}t&&t.enter()};wM||lp||NM||!_T||!ET?!OM&&Ud&&Ud.resolve?((cp=Ud.resolve(void 0)).constructor=Ud,uT=pT(cp.then,cp),fo=function(){uT(Vd)}):lp?fo=function(){mT.nextTick(Vd)}:(dp=pT(dp,go),fo=function(){dp(Vd)}):(op=!0,ap=ET.createTextNode(""),new _T(Vd).observe(ap,{characterData:!0}),fo=function(){ap.data=op=!op}),up=function(t){xd.head||fo(),xd.add(t)}}var fT=up,To=function(t){try{return{error:!1,value:t()}}catch(e){return{error:!0,value:e}}},Cs=re.Promise,DM=re,Wa=Cs,PM=xe,LM=Gf,kM=Yg,MM=me,gT=Ah,hp=fs,TT=Wa&&Wa.prototype,UM=MM("species"),ST=!1,RT=PM(DM.PromiseRejectionEvent),xM=LM("Promise",function(){var t=kM(Wa),e=t!==String(Wa);if(!e&&hp===66||!TT.catch||!TT.finally)return!0;if(!hp||hp<51||!/native code/.test(t)){var i=new Wa(function(r){r(1)}),n=function(r){r(function(){},function(){})};if((i.constructor={})[UM]=n,!(ST=i.then(function(){})instanceof n))return!0}return!(e||gT!=="BROWSER"&&gT!=="DENO"||RT)}),Ha={CONSTRUCTOR:xM,REJECTION_EVENT:RT,SUBCLASSING:ST},Jn={},vT=Li,VM=TypeError,FM=function(t){var e,i;this.promise=new t(function(n,r){if(e!==void 0||i!==void 0)throw new VM("Bad Promise constructor");e=n,i=r}),this.resolve=vT(e),this.reject=vT(i)};Jn.f=function(t){return new FM(t)};var pp,CT,BM=bt,Fd=md,Wr=re,Ka=We,jM=jr,GM=fr,WM=function(t){var e=Y1(t);z1&&e&&!e[Kg]&&q1(e,Kg,{configurable:!0,get:function(){return this}})},HM=Li,_p=xe,KM=fi,YM=Jh,qM=$h,IT=Md.set,Ep=fT,zM=function(t,e){try{arguments.length===1?console.error(t):console.error(t,e)}catch{}},JM=To,XM=hT,yT=Rs,mp=Cs,AT=Ha,bT=Jn,Bd="Promise",wT=AT.CONSTRUCTOR,QM=AT.REJECTION_EVENT,fp=yT.getterFor(Bd),ZM=yT.set,$M=mp&&mp.prototype,Ya=mp,gp=$M,OT=Wr.TypeError,Tp=Wr.document,Sp=Wr.process,Rp=bT.f,tU=Rp,eU=!!(Tp&&Tp.createEvent&&Wr.dispatchEvent),NT="unhandledrejection",DT=function(t){var e;return!(!KM(t)||!_p(e=t.then))&&e},PT=function(t,e){var i,n,r,s=e.value,o=e.state===1,a=o?t.ok:t.fail,c=t.resolve,d=t.reject,l=t.domain;try{a?(o||(e.rejection===2&&nU(e),e.rejection=1),a===!0?i=s:(l&&l.enter(),i=a(s),l&&(l.exit(),r=!0)),i===t.promise?d(new OT("Promise-chain cycle")):(n=DT(i))?Ka(n,i,c,d):c(i)):d(s)}catch(u){l&&!r&&l.exit(),d(u)}},LT=function(t,e){t.notified||(t.notified=!0,Ep(function(){for(var i,n=t.reactions;i=n.get();)PT(i,t);t.notified=!1,e&&!t.rejection&&iU(t)}))},kT=function(t,e,i){var n,r;eU?((n=Tp.createEvent("Event")).promise=e,n.reason=i,n.initEvent(t,!1,!0),Wr.dispatchEvent(n)):n={promise:e,reason:i},!QM&&(r=Wr["on"+t])?r(n):t===NT&&zM("Unhandled promise rejection",i)},iU=function(t){Ka(IT,Wr,function(){var e,i=t.facade,n=t.value;if(MT(t)&&(e=JM(function(){Fd?Sp.emit("unhandledRejection",n,i):kT(NT,i,n)}),t.rejection=Fd||MT(t)?2:1,e.error))throw e.value})},MT=function(t){return t.rejection!==1&&!t.parent},nU=function(t){Ka(IT,Wr,function(){var e=t.facade;Fd?Sp.emit("rejectionHandled",e):kT("rejectionhandled",e,t.value)})},So=function(t,e,i){return function(n){t(e,n,i)}},Ro=function(t,e,i){t.done||(t.done=!0,i&&(t=i),t.value=e,t.state=2,LT(t,!0))},vp=function(t,e,i){if(!t.done){t.done=!0,i&&(t=i);try{if(t.facade===e)throw new OT("Promise can't be resolved itself");var n=DT(e);n?Ep(function(){var r={done:!1};try{Ka(n,e,So(vp,r,t),So(Ro,r,t))}catch(s){Ro(r,s,t)}}):(t.value=e,t.state=1,LT(t,!1))}catch(r){Ro({done:!1},r,t)}}};wT&&(gp=(Ya=function(t){YM(this,gp),HM(t),Ka(pp,this);var e=fp(this);try{t(So(vp,e),So(Ro,e))}catch(i){Ro(e,i)}}).prototype,(pp=function(t){ZM(this,{type:Bd,done:!1,notified:!1,parent:!1,reactions:new XM,rejection:!1,state:0,value:null})}).prototype=jM(gp,"then",function(t,e){var i=fp(this),n=Rp(qM(this,Ya));return i.parent=!0,n.ok=!_p(t)||t,n.fail=_p(e)&&e,n.domain=Fd?Sp.domain:void 0,i.state===0?i.reactions.add(n):Ep(function(){PT(n,i)}),n.promise}),CT=function(){var t=new pp,e=fp(t);this.promise=t,this.resolve=So(vp,e),this.reject=So(Ro,e)},bT.f=Rp=function(t){return t===Ya||t===void 0?new CT(t):tU(t)}),BM({global:!0,constructor:!0,wrap:!0,forced:wT},{Promise:Ya}),GM(Ya,Bd,!1,!0),WM(Bd);var UT=me("iterator"),xT=!1;try{var rU=0,VT={next:function(){return{done:!!rU++}},return:function(){xT=!0}};VT[UT]=function(){return this},Array.from(VT,function(){throw 2})}catch{}var sU=Cs,oU=function(t,e){try{if(!e&&!xT)return!1}catch{return!1}var i=!1;try{var n={};n[UT]=function(){return{next:function(){return{done:i=!0}}}},t(n)}catch{}return i},jd=Ha.CONSTRUCTOR||!oU(function(t){sU.all(t).then(void 0,function(){})}),aU=We,cU=Li,dU=Jn,lU=To,uU=Va;bt({target:"Promise",stat:!0,forced:jd},{all:function(t){var e=this,i=dU.f(e),n=i.resolve,r=i.reject,s=lU(function(){var o=cU(e.resolve),a=[],c=0,d=1;uU(t,function(l){var u=c++,h=!1;d++,aU(o,e,l).then(function(p){h||(h=!0,a[u]=p,--d||n(a))},r)}),--d||n(a)});return s.error&&r(s.value),i.promise}});var hU=bt,pU=Ha.CONSTRUCTOR;Cs&&Cs.prototype,hU({target:"Promise",proto:!0,forced:pU,real:!0},{catch:function(t){return this.then(void 0,t)}});var _U=We,EU=Li,mU=Jn,fU=To,gU=Va;bt({target:"Promise",stat:!0,forced:jd},{race:function(t){var e=this,i=mU.f(e),n=i.reject,r=fU(function(){var s=EU(e.resolve);gU(t,function(o){_U(s,e,o).then(i.resolve,n)})});return r.error&&n(r.value),i.promise}});var TU=Jn;bt({target:"Promise",stat:!0,forced:Ha.CONSTRUCTOR},{reject:function(t){var e=TU.f(this);return(0,e.reject)(t),e.promise}});var SU=bi,RU=fi,vU=Jn,FT=function(t,e){if(SU(t),RU(e)&&e.constructor===t)return e;var i=vU.f(t);return(0,i.resolve)(e),i.promise},CU=bt,IU=Cs,yU=Ha.CONSTRUCTOR,AU=FT,bU=di("Promise"),wU=!yU;CU({target:"Promise",stat:!0,forced:!0},{resolve:function(t){return AU(wU&&this===bU?IU:this,t)}});var OU=We,NU=Li,DU=Jn,PU=To,LU=Va;bt({target:"Promise",stat:!0,forced:jd},{allSettled:function(t){var e=this,i=DU.f(e),n=i.resolve,r=i.reject,s=PU(function(){var o=NU(e.resolve),a=[],c=0,d=1;LU(t,function(l){var u=c++,h=!1;d++,OU(o,e,l).then(function(p){h||(h=!0,a[u]={status:"fulfilled",value:p},--d||n(a))},function(p){h||(h=!0,a[u]={status:"rejected",reason:p},--d||n(a))})}),--d||n(a)});return s.error&&r(s.value),i.promise}});var kU=We,MU=Li,UU=di,xU=Jn,VU=To,FU=Va,BT="No one promise resolved";bt({target:"Promise",stat:!0,forced:jd},{any:function(t){var e=this,i=UU("AggregateError"),n=xU.f(e),r=n.resolve,s=n.reject,o=VU(function(){var a=MU(e.resolve),c=[],d=0,l=1,u=!1;FU(t,function(h){var p=d++,T=!1;l++,kU(a,e,h).then(function(m){T||u||(u=!0,r(m))},function(m){T||u||(T=!0,c[p]=m,--l||s(new i(c,BT)))})}),--l||s(new i(c,BT))});return o.error&&s(o.value),n.promise}});var BU=bt,jU=Oa,GU=Gr,WU=Jn,HU=Li,jT=To,Cp=re.Promise,GT=!1;BU({target:"Promise",stat:!0,forced:!Cp||!Cp.try||jT(function(){Cp.try(function(t){GT=t===8},8)}).error||!GT},{try:function(t){var e=arguments.length>1?GU(arguments,1):[],i=WU.f(this),n=jT(function(){return jU(HU(t),void 0,e)});return(n.error?i.reject:i.resolve)(n.value),i.promise}});var KU=Jn;bt({target:"Promise",stat:!0},{withResolvers:function(){var t=KU.f(this);return{promise:t.promise,resolve:t.resolve,reject:t.reject}}});var YU=bt,Ip=Cs,qU=$t,zU=di,JU=xe,XU=$h,WT=FT,QU=Ip&&Ip.prototype;YU({target:"Promise",proto:!0,real:!0,forced:!!Ip&&qU(function(){QU.finally.call({then:function(){}},function(){})})},{finally:function(t){var e=XU(this,zU("Promise")),i=JU(t);return this.then(i?function(n){return WT(e,t()).then(function(){return n})}:t,i?function(n){return WT(e,t()).then(function(){throw n})}:t)}});var yp=le,ZU=Sh,$U=ki,t2=ms,e2=yp("".charAt),HT=yp("".charCodeAt),i2=yp("".slice),KT=function(t){return function(e,i){var n,r,s=$U(t2(e)),o=ZU(i),a=s.length;return o<0||o>=a?t?"":void 0:(n=HT(s,o))<55296||n>56319||o+1===a||(r=HT(s,o+1))<56320||r>57343?t?e2(s,o):n:t?i2(s,o,o+2):r-56320+(n-55296<<10)+65536}},Ap={codeAt:KT(!1),charAt:KT(!0)},n2=Ap.charAt,r2=ki,YT=Rs,s2=jg,qT=Dd,zT="String Iterator",o2=YT.set,a2=YT.getterFor(zT);s2(String,"String",function(t){o2(this,{type:zT,string:r2(t),index:0})},function(){var t,e=a2(this),i=e.string,n=e.index;return n>=i.length?qT(void 0,!0):(t=n2(i,n),e.index+=t.length,qT(t,!1))});var c2=zi.Promise,d2={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},l2=re,u2=fr,JT=Ts;for(var bp in d2)u2(l2[bp],bp),JT[bp]=JT.Array;var XT=c2,G=Bt(XT),h2=dn("Array","values"),p2=mr,_2=He,E2=ei,m2=h2,wp=Array.prototype,f2={DOMTokenList:!0,NodeList:!0},g2=function(t){var e=t.values;return t===wp||E2(wp,t)&&e===wp.values||_2(f2,p2(t))?m2:e},Mi=Bt(g2),T2=bt,S2=le,R2=Rh,v2=RangeError,QT=String.fromCharCode,ZT=String.fromCodePoint,C2=S2([].join);T2({target:"String",stat:!0,arity:1,forced:!!ZT&&ZT.length!==1},{fromCodePoint:function(t){for(var e,i=[],n=arguments.length,r=0;n>r;){if(e=+arguments[r++],R2(e,1114111)!==e)throw new v2(e+" is not a valid code point");i[r]=e<65536?QT(e):QT(55296+((e-=65536)>>10),e%1024+56320)}return C2(i,"")}});var I2=$t,y2=cD,A2=me("iterator"),Gd=!I2(function(){var t=new URL("b?a=1&b=2&c=3","https://a"),e=t.searchParams,i=new URLSearchParams("a=1&a=2&b=3"),n="";return t.pathname="c%20d",e.forEach(function(r,s){e.delete("b"),n+=s+r}),i.delete("a",2),i.delete("b",void 0),!t.toJSON||!i.has("a",1)||i.has("a",2)||!i.has("a",void 0)||i.has("b")||!e.size&&y2||!e.sort||t.href!=="https://a/c%20d?a=1&c=3"||e.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!e[A2]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("https://тест").host!=="xn--e1aybc"||new URL("https://a#б").hash!=="#%D0%B1"||n!=="a1c3"||new URL("https://x",void 0).host!=="x"}),b2=jr,$T=Gr,w2=Math.floor,Op=function(t,e){var i=t.length;if(i<8)for(var n,r,s=1;s<i;){for(r=s,n=t[s];r&&e(t[r-1],n)>0;)t[r]=t[--r];r!==s++&&(t[r]=n)}else for(var o=w2(i/2),a=Op($T(t,0,o),e),c=Op($T(t,o),e),d=a.length,l=c.length,u=0,h=0;u<d||h<l;)t[u+h]=u<d&&h<l?e(a[u],c[h])<=0?a[u++]:c[h++]:u<d?a[u++]:c[h++];return t},tS=Op,Np=bt,eS=re,Dp=dT,O2=di,Wd=We,On=le,qa=mi,iS=Gd,nS=jr,N2=Ld,D2=function(t,e,i){for(var n in e)i&&i.unsafe&&t[n]?t[n]=e[n]:b2(t,n,e[n],i);return t},P2=fr,L2=qh,Pp=Rs,rS=Jh,Lp=xe,k2=He,M2=Fr,U2=mr,x2=bi,sS=fi,wi=ki,V2=xa,oS=xr,aS=xh,F2=Cd,Hd=Dd,vo=vs,B2=tS,j2=me("iterator"),Co="URLSearchParams",cS=Co+"Iterator",dS=Pp.set,ln=Pp.getterFor(Co),G2=Pp.getterFor(cS),lS=Dp("fetch"),Kd=Dp("Request"),za=Dp("Headers"),kp=Kd&&Kd.prototype,uS=za&&za.prototype,W2=eS.TypeError,H2=eS.encodeURIComponent,K2=String.fromCharCode,Y2=O2("String","fromCodePoint"),q2=parseInt,Yd=On("".charAt),hS=On([].join),Hr=On([].push),pS=On("".replace),z2=On([].shift),_S=On([].splice),ES=On("".split),mS=On("".slice),J2=On(/./.exec),X2=/\+/g,Q2=/^[0-9a-f]+$/i,fS=function(t,e){var i=mS(t,e,e+2);return J2(Q2,i)?q2(i,16):NaN},Z2=function(t){for(var e=0,i=128;i>0&&t&i;i>>=1)e++;return e},$2=function(t){var e=null;switch(t.length){case 1:e=t[0];break;case 2:e=(31&t[0])<<6|63&t[1];break;case 3:e=(15&t[0])<<12|(63&t[1])<<6|63&t[2];break;case 4:e=(7&t[0])<<18|(63&t[1])<<12|(63&t[2])<<6|63&t[3]}return e>1114111?null:e},gS=function(t){for(var e=(t=pS(t,X2," ")).length,i="",n=0;n<e;){var r=Yd(t,n);if(r==="%"){if(Yd(t,n+1)==="%"||n+3>e){i+="%",n++;continue}var s=fS(t,n+1);if(s!=s){i+=r,n++;continue}n+=2;var o=Z2(s);if(o===0)r=K2(s);else{if(o===1||o>4){i+="�",n++;continue}for(var a=[s],c=1;c<o&&!(++n+3>e||Yd(t,n)!=="%");){var d=fS(t,n+1);if(d!=d){n+=3;break}if(d>191||d<128)break;Hr(a,d),n+=2,c++}if(a.length!==o){i+="�";continue}var l=$2(a);l===null?i+="�":r=Y2(l)}}i+=r,n++}return i},tx=/[!'()~]|%20/g,ex={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},ix=function(t){return ex[t]},TS=function(t){return pS(H2(t),tx,ix)},Mp=L2(function(t,e){dS(this,{type:cS,target:ln(t).entries,index:0,kind:e})},Co,function(){var t=G2(this),e=t.target,i=t.index++;if(!e||i>=e.length)return t.target=null,Hd(void 0,!0);var n=e[i];switch(t.kind){case"keys":return Hd(n.key,!1);case"values":return Hd(n.value,!1)}return Hd([n.key,n.value],!1)},!0),SS=function(t){this.entries=[],this.url=null,t!==void 0&&(sS(t)?this.parseObject(t):this.parseQuery(typeof t=="string"?Yd(t,0)==="?"?mS(t,1):t:wi(t)))};SS.prototype={type:Co,bindURL:function(t){this.url=t,this.update()},parseObject:function(t){var e,i,n,r,s,o,a,c=this.entries,d=F2(t);if(d)for(i=(e=aS(t,d)).next;!(n=Wd(i,e)).done;){if(s=(r=aS(x2(n.value))).next,(o=Wd(s,r)).done||(a=Wd(s,r)).done||!Wd(s,r).done)throw new W2("Expected sequence with length 2");Hr(c,{key:wi(o.value),value:wi(a.value)})}else for(var l in t)k2(t,l)&&Hr(c,{key:l,value:wi(t[l])})},parseQuery:function(t){if(t)for(var e,i,n=this.entries,r=ES(t,"&"),s=0;s<r.length;)(e=r[s++]).length&&(i=ES(e,"="),Hr(n,{key:gS(z2(i)),value:gS(hS(i,"="))}))},serialize:function(){for(var t,e=this.entries,i=[],n=0;n<e.length;)t=e[n++],Hr(i,TS(t.key)+"="+TS(t.value));return hS(i,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var qd=function(){rS(this,Io);var t=dS(this,new SS(arguments.length>0?arguments[0]:void 0));qa||(this.size=t.entries.length)},Io=qd.prototype;if(D2(Io,{append:function(t,e){var i=ln(this);vo(arguments.length,2),Hr(i.entries,{key:wi(t),value:wi(e)}),qa||this.length++,i.updateURL()},delete:function(t){for(var e=ln(this),i=vo(arguments.length,1),n=e.entries,r=wi(t),s=i<2?void 0:arguments[1],o=s===void 0?s:wi(s),a=0;a<n.length;){var c=n[a];if(c.key!==r||o!==void 0&&c.value!==o)a++;else if(_S(n,a,1),o!==void 0)break}qa||(this.size=n.length),e.updateURL()},get:function(t){var e=ln(this).entries;vo(arguments.length,1);for(var i=wi(t),n=0;n<e.length;n++)if(e[n].key===i)return e[n].value;return null},getAll:function(t){var e=ln(this).entries;vo(arguments.length,1);for(var i=wi(t),n=[],r=0;r<e.length;r++)e[r].key===i&&Hr(n,e[r].value);return n},has:function(t){for(var e=ln(this).entries,i=vo(arguments.length,1),n=wi(t),r=i<2?void 0:arguments[1],s=r===void 0?r:wi(r),o=0;o<e.length;){var a=e[o++];if(a.key===n&&(s===void 0||a.value===s))return!0}return!1},set:function(t,e){var i=ln(this);vo(arguments.length,1);for(var n,r=i.entries,s=!1,o=wi(t),a=wi(e),c=0;c<r.length;c++)(n=r[c]).key===o&&(s?_S(r,c--,1):(s=!0,n.value=a));s||Hr(r,{key:o,value:a}),qa||(this.size=r.length),i.updateURL()},sort:function(){var t=ln(this);B2(t.entries,function(e,i){return e.key>i.key?1:-1}),t.updateURL()},forEach:function(t){for(var e,i=ln(this).entries,n=M2(t,arguments.length>1?arguments[1]:void 0),r=0;r<i.length;)n((e=i[r++]).value,e.key,this)},keys:function(){return new Mp(this,"keys")},values:function(){return new Mp(this,"values")},entries:function(){return new Mp(this,"entries")}},{enumerable:!0}),nS(Io,j2,Io.entries,{name:"entries"}),nS(Io,"toString",function(){return ln(this).serialize()},{enumerable:!0}),qa&&N2(Io,"size",{get:function(){return ln(this).entries.length},configurable:!0,enumerable:!0}),P2(qd,Co),Np({global:!0,constructor:!0,forced:!iS},{URLSearchParams:qd}),!iS&&Lp(za)){var nx=On(uS.has),rx=On(uS.set),RS=function(t){if(sS(t)){var e,i=t.body;if(U2(i)===Co)return e=t.headers?new za(t.headers):new za,nx(e,"content-type")||rx(e,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),V2(t,{body:oS(0,wi(i)),headers:oS(0,e)})}return t};if(Lp(lS)&&Np({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(t){return lS(t,arguments.length>1?RS(arguments[1]):{})}}),Lp(Kd)){var Up=function(t){return rS(this,kp),new Kd(t,arguments.length>1?RS(arguments[1]):{})};kp.constructor=Up,Up.prototype=kp,Np({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:Up})}}var un,sx={URLSearchParams:qd,getState:ln},ox=zi.URLSearchParams,vS=mi,ax=le,cx=We,dx=$t,xp=Sd,lx=Ua,ux=cd,hx=qn,px=ld,yo=Object.assign,CS=Object.defineProperty,_x=ax([].concat),Ex=!yo||dx(function(){if(vS&&yo({b:1},yo(CS({},"a",{enumerable:!0,get:function(){CS(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var t={},e={},i=Symbol("assign detection"),n="abcdefghijklmnopqrst";return t[i]=7,n.split("").forEach(function(r){e[r]=r}),yo({},t)[i]!==7||xp(yo({},e)).join("")!==n})?function(t,e){for(var i=hx(t),n=arguments.length,r=1,s=lx.f,o=ux.f;n>r;)for(var a,c=px(arguments[r++]),d=s?_x(xp(c),s(c)):xp(c),l=d.length,u=0;l>u;)a=d[u++],vS&&!cx(o,c,a)||(i[a]=c[a]);return i}:yo,mx=bi,fx=Rg,gx=mi,Tx=cn,Sx=xr,Vp=function(t,e,i){gx?Tx.f(t,e,Sx(0,i)):t[e]=i},Rx=Fr,vx=We,Cx=qn,Ix=function(t,e,i,n){try{return n?e(mx(i)[0],i[1]):e(i)}catch(r){fx(t,"throw",r)}},yx=gg,Ax=kd,bx=Br,IS=Vp,wx=xh,Ox=Cd,yS=Array,Is=le,Fp=2147483647,Nx=/[^\0-\u007E]/,AS=/[.\u3002\uFF0E\uFF61]/g,bS="Overflow: input needs wider integers to process",wS=RangeError,Dx=Is(AS.exec),Ao=Math.floor,Bp=String.fromCharCode,OS=Is("".charCodeAt),NS=Is([].join),Kr=Is([].push),Px=Is("".replace),Lx=Is("".split),kx=Is("".toLowerCase),DS=function(t){return t+22+75*(t<26)},Mx=function(t,e,i){var n=0;for(t=i?Ao(t/700):t>>1,t+=Ao(t/e);t>455;)t=Ao(t/35),n+=36;return Ao(n+36*t/(t+38))},Ux=function(t){var e=[];t=function(R){for(var v=[],A=0,O=R.length;A<O;){var w=OS(R,A++);if(w>=55296&&w<=56319&&A<O){var b=OS(R,A++);(64512&b)==56320?Kr(v,((1023&w)<<10)+(1023&b)+65536):(Kr(v,w),A--)}else Kr(v,w)}return v}(t);var i,n,r=t.length,s=128,o=0,a=72;for(i=0;i<t.length;i++)(n=t[i])<128&&Kr(e,Bp(n));var c=e.length,d=c;for(c&&Kr(e,"-");d<r;){var l=Fp;for(i=0;i<t.length;i++)(n=t[i])>=s&&n<l&&(l=n);var u=d+1;if(l-s>Ao((Fp-o)/u))throw new wS(bS);for(o+=(l-s)*u,s=l,i=0;i<t.length;i++){if((n=t[i])<s&&++o>Fp)throw new wS(bS);if(n===s){for(var h=o,p=36;;){var T=p<=a?1:p>=a+26?26:p-a;if(h<T)break;var m=h-T,f=36-T;Kr(e,Bp(DS(T+m%f))),h=Ao(m/f),p+=36}Kr(e,Bp(DS(h))),a=Mx(o,u,d===c),o=0,d++}}o++,s++}return NS(e,"")},xx=bt,jp=mi,Vx=Gd,Gp=re,PS=Fr,hn=le,zd=jr,pn=Ld,Fx=Jh,Wp=He,Hp=Ex,bo=function(t){var e=Cx(t),i=Ax(this),n=arguments.length,r=n>1?arguments[1]:void 0,s=r!==void 0;s&&(r=Rx(r,n>2?arguments[2]:void 0));var o,a,c,d,l,u,h=Ox(e),p=0;if(!h||this===yS&&yx(h))for(o=bx(e),a=i?new this(o):yS(o);o>p;p++)u=s?r(e[p],p):e[p],IS(a,p,u);else for(a=i?new this:[],l=(d=wx(e,h)).next;!(c=vx(l,d)).done;p++)u=s?Ix(d,r,[c.value,p],!0):c.value,IS(a,p,u);return a.length=p,a},Nn=Gr,Bx=Ap.codeAt,jx=function(t){var e,i,n=[],r=Lx(Px(kx(t),AS,"."),".");for(e=0;e<r.length;e++)i=r[e],Kr(n,Dx(Nx,i)?"xn--"+Ux(i):i);return NS(n,".")},gr=ki,Gx=fr,Wx=vs,LS=sx,kS=Rs,Hx=kS.set,Jd=kS.getterFor("URL"),Kx=LS.URLSearchParams,Yx=LS.getState,Ja=Gp.URL,Kp=Gp.TypeError,Xd=Gp.parseInt,qx=Math.floor,MS=Math.pow,_n=hn("".charAt),Dn=hn(/./.exec),Xa=hn([].join),zx=hn(1 .toString),Jx=hn([].pop),wo=hn([].push),Yp=hn("".replace),Xx=hn([].shift),Qx=hn("".split),Qa=hn("".slice),Qd=hn("".toLowerCase),Zx=hn([].unshift),qp="Invalid scheme",ys="Invalid host",US="Invalid port",xS=/[a-z]/i,$x=/[\d+-.a-z]/i,zp=/\d/,tV=/^0x/i,eV=/^[0-7]+$/,iV=/^\d+$/,VS=/^[\da-f]+$/i,nV=/[\0\t\n\r #%/:<>?@[\\\]^|]/,rV=/[\0\t\n\r #/:<>?@[\\\]^|]/,sV=/^[\u0000-\u0020]+/,oV=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,aV=/[\t\n\r]/g,Za=function(t){var e,i,n,r;if(typeof t=="number"){for(e=[],i=0;i<4;i++)Zx(e,t%256),t=qx(t/256);return Xa(e,".")}if(typeof t=="object"){for(e="",n=function(s){for(var o=null,a=1,c=null,d=0,l=0;l<8;l++)s[l]!==0?(d>a&&(o=c,a=d),c=null,d=0):(c===null&&(c=l),++d);return d>a?c:o}(t),i=0;i<8;i++)r&&t[i]===0||(r&&(r=!1),n===i?(e+=i?":":"::",r=!0):(e+=zx(t[i],16),i<7&&(e+=":")));return"["+e+"]"}return t},Zd={},FS=Hp({},Zd,{" ":1,'"':1,"<":1,">":1,"`":1}),BS=Hp({},FS,{"#":1,"?":1,"{":1,"}":1}),Jp=Hp({},BS,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),Yr=function(t,e){var i=Bx(t,0);return i>32&&i<127&&!Wp(e,t)?t:encodeURIComponent(t)},$d={ftp:21,file:null,http:80,https:443,ws:80,wss:443},$a=function(t,e){var i;return t.length===2&&Dn(xS,_n(t,0))&&((i=_n(t,1))===":"||!e&&i==="|")},jS=function(t){var e;return t.length>1&&$a(Qa(t,0,2))&&(t.length===2||(e=_n(t,2))==="/"||e==="\\"||e==="?"||e==="#")},cV=function(t){return t==="."||Qd(t)==="%2e"},Xp={},GS={},Qp={},WS={},HS={},Zp={},KS={},YS={},tl={},el={},$p={},t_={},e_={},i_={},qS={},n_={},Oo={},Xn={},zS={},As={},Tr={},r_=function(t,e,i){var n,r,s,o=gr(t);if(e){if(r=this.parse(o))throw new Kp(r);this.searchParams=null}else{if(i!==void 0&&(n=new r_(i,!0)),r=this.parse(o,null,n))throw new Kp(r);(s=Yx(new Kx)).bindURL(this),this.searchParams=s}};r_.prototype={type:"URL",parse:function(t,e,i){var n,r,s,o,a,c=this,d=e||Xp,l=0,u="",h=!1,p=!1,T=!1;for(t=gr(t),e||(c.scheme="",c.username="",c.password="",c.host=null,c.port=null,c.path=[],c.query=null,c.fragment=null,c.cannotBeABaseURL=!1,t=Yp(t,sV,""),t=Yp(t,oV,"$1")),t=Yp(t,aV,""),n=bo(t);l<=n.length;){switch(r=n[l],d){case Xp:if(!r||!Dn(xS,r)){if(e)return qp;d=Qp;continue}u+=Qd(r),d=GS;break;case GS:if(r&&(Dn($x,r)||r==="+"||r==="-"||r==="."))u+=Qd(r);else{if(r!==":"){if(e)return qp;u="",d=Qp,l=0;continue}if(e&&(c.isSpecial()!==Wp($d,u)||u==="file"&&(c.includesCredentials()||c.port!==null)||c.scheme==="file"&&!c.host))return;if(c.scheme=u,e)return void(c.isSpecial()&&$d[c.scheme]===c.port&&(c.port=null));u="",c.scheme==="file"?d=i_:c.isSpecial()&&i&&i.scheme===c.scheme?d=WS:c.isSpecial()?d=YS:n[l+1]==="/"?(d=HS,l++):(c.cannotBeABaseURL=!0,wo(c.path,""),d=zS)}break;case Qp:if(!i||i.cannotBeABaseURL&&r!=="#")return qp;if(i.cannotBeABaseURL&&r==="#"){c.scheme=i.scheme,c.path=Nn(i.path),c.query=i.query,c.fragment="",c.cannotBeABaseURL=!0,d=Tr;break}d=i.scheme==="file"?i_:Zp;continue;case WS:if(r!=="/"||n[l+1]!=="/"){d=Zp;continue}d=tl,l++;break;case HS:if(r==="/"){d=el;break}d=Xn;continue;case Zp:if(c.scheme=i.scheme,r===un)c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=Nn(i.path),c.query=i.query;else if(r==="/"||r==="\\"&&c.isSpecial())d=KS;else if(r==="?")c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=Nn(i.path),c.query="",d=As;else{if(r!=="#"){c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=Nn(i.path),c.path.length--,d=Xn;continue}c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=Nn(i.path),c.query=i.query,c.fragment="",d=Tr}break;case KS:if(!c.isSpecial()||r!=="/"&&r!=="\\"){if(r!=="/"){c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,d=Xn;continue}d=el}else d=tl;break;case YS:if(d=tl,r!=="/"||_n(u,l+1)!=="/")continue;l++;break;case tl:if(r!=="/"&&r!=="\\"){d=el;continue}break;case el:if(r==="@"){h&&(u="%40"+u),h=!0,s=bo(u);for(var m=0;m<s.length;m++){var f=s[m];if(f!==":"||T){var R=Yr(f,Jp);T?c.password+=R:c.username+=R}else T=!0}u=""}else if(r===un||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(h&&u==="")return"Invalid authority";l-=bo(u).length+1,u="",d=$p}else u+=r;break;case $p:case t_:if(e&&c.scheme==="file"){d=n_;continue}if(r!==":"||p){if(r===un||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(c.isSpecial()&&u==="")return ys;if(e&&u===""&&(c.includesCredentials()||c.port!==null))return;if(o=c.parseHost(u))return o;if(u="",d=Oo,e)return;continue}r==="["?p=!0:r==="]"&&(p=!1),u+=r}else{if(u==="")return ys;if(o=c.parseHost(u))return o;if(u="",d=e_,e===t_)return}break;case e_:if(!Dn(zp,r)){if(r===un||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()||e){if(u!==""){var v=Xd(u,10);if(v>65535)return US;c.port=c.isSpecial()&&v===$d[c.scheme]?null:v,u=""}if(e)return;d=Oo;continue}return US}u+=r;break;case i_:if(c.scheme="file",r==="/"||r==="\\")d=qS;else{if(!i||i.scheme!=="file"){d=Xn;continue}switch(r){case un:c.host=i.host,c.path=Nn(i.path),c.query=i.query;break;case"?":c.host=i.host,c.path=Nn(i.path),c.query="",d=As;break;case"#":c.host=i.host,c.path=Nn(i.path),c.query=i.query,c.fragment="",d=Tr;break;default:jS(Xa(Nn(n,l),""))||(c.host=i.host,c.path=Nn(i.path),c.shortenPath()),d=Xn;continue}}break;case qS:if(r==="/"||r==="\\"){d=n_;break}i&&i.scheme==="file"&&!jS(Xa(Nn(n,l),""))&&($a(i.path[0],!0)?wo(c.path,i.path[0]):c.host=i.host),d=Xn;continue;case n_:if(r===un||r==="/"||r==="\\"||r==="?"||r==="#"){if(!e&&$a(u))d=Xn;else if(u===""){if(c.host="",e)return;d=Oo}else{if(o=c.parseHost(u))return o;if(c.host==="localhost"&&(c.host=""),e)return;u="",d=Oo}continue}u+=r;break;case Oo:if(c.isSpecial()){if(d=Xn,r!=="/"&&r!=="\\")continue}else if(e||r!=="?")if(e||r!=="#"){if(r!==un&&(d=Xn,r!=="/"))continue}else c.fragment="",d=Tr;else c.query="",d=As;break;case Xn:if(r===un||r==="/"||r==="\\"&&c.isSpecial()||!e&&(r==="?"||r==="#")){if((a=Qd(a=u))===".."||a==="%2e."||a===".%2e"||a==="%2e%2e"?(c.shortenPath(),r==="/"||r==="\\"&&c.isSpecial()||wo(c.path,"")):cV(u)?r==="/"||r==="\\"&&c.isSpecial()||wo(c.path,""):(c.scheme==="file"&&!c.path.length&&$a(u)&&(c.host&&(c.host=""),u=_n(u,0)+":"),wo(c.path,u)),u="",c.scheme==="file"&&(r===un||r==="?"||r==="#"))for(;c.path.length>1&&c.path[0]==="";)Xx(c.path);r==="?"?(c.query="",d=As):r==="#"&&(c.fragment="",d=Tr)}else u+=Yr(r,BS);break;case zS:r==="?"?(c.query="",d=As):r==="#"?(c.fragment="",d=Tr):r!==un&&(c.path[0]+=Yr(r,Zd));break;case As:e||r!=="#"?r!==un&&(r==="'"&&c.isSpecial()?c.query+="%27":c.query+=r==="#"?"%23":Yr(r,Zd)):(c.fragment="",d=Tr);break;case Tr:r!==un&&(c.fragment+=Yr(r,FS))}l++}},parseHost:function(t){var e,i,n;if(_n(t,0)==="["){if(_n(t,t.length-1)!=="]"||(e=function(r){var s,o,a,c,d,l,u,h=[0,0,0,0,0,0,0,0],p=0,T=null,m=0,f=function(){return _n(r,m)};if(f()===":"){if(_n(r,1)!==":")return;m+=2,T=++p}for(;f();){if(p===8)return;if(f()!==":"){for(s=o=0;o<4&&Dn(VS,f());)s=16*s+Xd(f(),16),m++,o++;if(f()==="."){if(o===0||(m-=o,p>6))return;for(a=0;f();){if(c=null,a>0){if(!(f()==="."&&a<4))return;m++}if(!Dn(zp,f()))return;for(;Dn(zp,f());){if(d=Xd(f(),10),c===null)c=d;else{if(c===0)return;c=10*c+d}if(c>255)return;m++}h[p]=256*h[p]+c,++a!=2&&a!==4||p++}if(a!==4)return;break}if(f()===":"){if(m++,!f())return}else if(f())return;h[p++]=s}else{if(T!==null)return;m++,T=++p}}if(T!==null)for(l=p-T,p=7;p!==0&&l>0;)u=h[p],h[p--]=h[T+l-1],h[T+--l]=u;else if(p!==8)return;return h}(Qa(t,1,-1)),!e))return ys;this.host=e}else if(this.isSpecial()){if(t=jx(t),Dn(nV,t)||(e=function(r){var s,o,a,c,d,l,u,h=Qx(r,".");if(h.length&&h[h.length-1]===""&&h.length--,(s=h.length)>4)return r;for(o=[],a=0;a<s;a++){if((c=h[a])==="")return r;if(d=10,c.length>1&&_n(c,0)==="0"&&(d=Dn(tV,c)?16:8,c=Qa(c,d===8?1:2)),c==="")l=0;else{if(!Dn(d===10?iV:d===8?eV:VS,c))return r;l=Xd(c,d)}wo(o,l)}for(a=0;a<s;a++)if(l=o[a],a===s-1){if(l>=MS(256,5-s))return null}else if(l>255)return null;for(u=Jx(o),a=0;a<o.length;a++)u+=o[a]*MS(256,3-a);return u}(t),e===null))return ys;this.host=e}else{if(Dn(rV,t))return ys;for(e="",i=bo(t),n=0;n<i.length;n++)e+=Yr(i[n],Zd);this.host=e}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme==="file"},includesCredentials:function(){return this.username!==""||this.password!==""},isSpecial:function(){return Wp($d,this.scheme)},shortenPath:function(){var t=this.path,e=t.length;!e||this.scheme==="file"&&e===1&&$a(t[0],!0)||t.length--},serialize:function(){var t=this,e=t.scheme,i=t.username,n=t.password,r=t.host,s=t.port,o=t.path,a=t.query,c=t.fragment,d=e+":";return r!==null?(d+="//",t.includesCredentials()&&(d+=i+(n?":"+n:"")+"@"),d+=Za(r),s!==null&&(d+=":"+s)):e==="file"&&(d+="//"),d+=t.cannotBeABaseURL?o[0]:o.length?"/"+Xa(o,"/"):"",a!==null&&(d+="?"+a),c!==null&&(d+="#"+c),d},setHref:function(t){var e=this.parse(t);if(e)throw new Kp(e);this.searchParams.update()},getOrigin:function(){var t=this.scheme,e=this.port;if(t==="blob")try{return new No(t.path[0]).origin}catch{return"null"}return t!=="file"&&this.isSpecial()?t+"://"+Za(this.host)+(e!==null?":"+e:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(t){this.parse(gr(t)+":",Xp)},getUsername:function(){return this.username},setUsername:function(t){var e=bo(gr(t));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var i=0;i<e.length;i++)this.username+=Yr(e[i],Jp)}},getPassword:function(){return this.password},setPassword:function(t){var e=bo(gr(t));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var i=0;i<e.length;i++)this.password+=Yr(e[i],Jp)}},getHost:function(){var t=this.host,e=this.port;return t===null?"":e===null?Za(t):Za(t)+":"+e},setHost:function(t){this.cannotBeABaseURL||this.parse(t,$p)},getHostname:function(){var t=this.host;return t===null?"":Za(t)},setHostname:function(t){this.cannotBeABaseURL||this.parse(t,t_)},getPort:function(){var t=this.port;return t===null?"":gr(t)},setPort:function(t){this.cannotHaveUsernamePasswordPort()||((t=gr(t))===""?this.port=null:this.parse(t,e_))},getPathname:function(){var t=this.path;return this.cannotBeABaseURL?t[0]:t.length?"/"+Xa(t,"/"):""},setPathname:function(t){this.cannotBeABaseURL||(this.path=[],this.parse(t,Oo))},getSearch:function(){var t=this.query;return t?"?"+t:""},setSearch:function(t){(t=gr(t))===""?this.query=null:(_n(t,0)==="?"&&(t=Qa(t,1)),this.query="",this.parse(t,As)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var t=this.fragment;return t?"#"+t:""},setHash:function(t){(t=gr(t))!==""?(_n(t,0)==="#"&&(t=Qa(t,1)),this.fragment="",this.parse(t,Tr)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var No=function(t){var e=Fx(this,Oi),i=Wx(arguments.length,1)>1?arguments[1]:void 0,n=Hx(e,new r_(t,!1,i));jp||(e.href=n.serialize(),e.origin=n.getOrigin(),e.protocol=n.getProtocol(),e.username=n.getUsername(),e.password=n.getPassword(),e.host=n.getHost(),e.hostname=n.getHostname(),e.port=n.getPort(),e.pathname=n.getPathname(),e.search=n.getSearch(),e.searchParams=n.getSearchParams(),e.hash=n.getHash())},Oi=No.prototype,En=function(t,e){return{get:function(){return Jd(this)[t]()},set:e&&function(i){return Jd(this)[e](i)},configurable:!0,enumerable:!0}};if(jp&&(pn(Oi,"href",En("serialize","setHref")),pn(Oi,"origin",En("getOrigin")),pn(Oi,"protocol",En("getProtocol","setProtocol")),pn(Oi,"username",En("getUsername","setUsername")),pn(Oi,"password",En("getPassword","setPassword")),pn(Oi,"host",En("getHost","setHost")),pn(Oi,"hostname",En("getHostname","setHostname")),pn(Oi,"port",En("getPort","setPort")),pn(Oi,"pathname",En("getPathname","setPathname")),pn(Oi,"search",En("getSearch","setSearch")),pn(Oi,"searchParams",En("getSearchParams")),pn(Oi,"hash",En("getHash","setHash"))),zd(Oi,"toJSON",function(){return Jd(this).serialize()},{enumerable:!0}),zd(Oi,"toString",function(){return Jd(this).serialize()},{enumerable:!0}),Ja){var JS=Ja.createObjectURL,XS=Ja.revokeObjectURL;JS&&zd(No,"createObjectURL",PS(JS,Ja)),XS&&zd(No,"revokeObjectURL",PS(XS,Ja))}Gx(No,"URL"),xx({global:!0,constructor:!0,forced:!Vx,sham:!jp},{URL:No});var dV=bt,QS=$t,lV=vs,ZS=ki,uV=Gd,s_=di("URL"),hV=uV&&QS(function(){s_.canParse()}),pV=QS(function(){return s_.canParse.length!==1});dV({target:"URL",stat:!0,forced:!hV||pV},{canParse:function(t){var e=lV(arguments.length,1),i=ZS(t),n=e<2||arguments[1]===void 0?void 0:ZS(arguments[1]);try{return!!new s_(i,n)}catch{return!1}}});var _V=bt,EV=vs,$S=ki,mV=Gd,fV=di("URL");_V({target:"URL",stat:!0,forced:!mV},{parse:function(t){var e=EV(arguments.length,1),i=$S(t),n=e<2||arguments[1]===void 0?void 0:$S(arguments[1]);try{return new fV(i,n)}catch{return null}}});var il=Bt(zi.URL);let tR=!0,eR=!0;function nl(t,e,i){const n=t.match(e);return n&&n.length>=i&&parseInt(n[i],10)}function bs(t,e,i){if(!t.RTCPeerConnection)return;const n=t.RTCPeerConnection.prototype,r=n.addEventListener;n.addEventListener=function(o,a){if(o!==e)return r.apply(this,arguments);const c=d=>{const l=i(d);l&&(a.handleEvent?a.handleEvent(l):a(l))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),r.apply(this,[o,c])};const s=n.removeEventListener;n.removeEventListener=function(o,a){if(o!==e||!this._eventMap||!this._eventMap[e])return s.apply(this,arguments);if(!this._eventMap[e].has(a))return s.apply(this,arguments);const c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[o,c])},Object.defineProperty(n,"on"+e,{get(){return this["_on"+e]},set(o){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),o&&this.addEventListener(e,this["_on"+e]=o)},enumerable:!0,configurable:!0})}function gV(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(tR=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function TV(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(eR=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function iR(){if(typeof window=="object"){if(tR)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function o_(t,e){eR&&console.warn(t+" is deprecated, please use "+e+" instead.")}function nR(t){return Object.prototype.toString.call(t)==="[object Object]"}function rR(t){var e;return nR(t)?wn(e=Object.keys(t)).call(e,function(i,n){const r=nR(t[n]),s=r?rR(t[n]):t[n],o=r&&!Object.keys(s).length;return s===void 0||o?i:Object.assign(i,{[n]:s})},{}):t}function a_(t,e,i){e&&!i.has(e.id)&&(i.set(e.id,e),Object.keys(e).forEach(n=>{n.endsWith("Id")?a_(t,t.get(e[n]),i):n.endsWith("Ids")&&e[n].forEach(r=>{a_(t,t.get(r),i)})}))}function sR(t,e,i){const n=i?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;const s=[];return t.forEach(o=>{o.type==="track"&&o.trackIdentifier===e.id&&s.push(o)}),s.forEach(o=>{t.forEach(a=>{a.type===n&&a.trackId===o.id&&a_(t,a,r)})}),r}const oR=iR;function aR(t,e){const i=t&&t.navigator;if(!i.mediaDevices)return;const n=function(o){if(typeof o!="object"||o.mandatory||o.optional)return o;const a={};return Object.keys(o).forEach(c=>{if(c==="require"||c==="advanced"||c==="mediaSource")return;const d=typeof o[c]=="object"?o[c]:{ideal:o[c]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);const l=function(u,h){return u?u+h.charAt(0).toUpperCase()+h.slice(1):h==="deviceId"?"sourceId":h};if(d.ideal!==void 0){a.optional=a.optional||[];let u={};typeof d.ideal=="number"?(u[l("min",c)]=d.ideal,a.optional.push(u),u={},u[l("max",c)]=d.ideal,a.optional.push(u)):(u[l("",c)]=d.ideal,a.optional.push(u))}d.exact!==void 0&&typeof d.exact!="number"?(a.mandatory=a.mandatory||{},a.mandatory[l("",c)]=d.exact):["min","max"].forEach(u=>{d[u]!==void 0&&(a.mandatory=a.mandatory||{},a.mandatory[l(u,c)]=d[u])})}),o.advanced&&(a.optional=(a.optional||[]).concat(o.advanced)),a},r=function(o,a){if(e.version>=61)return a(o);if((o=JSON.parse(JSON.stringify(o)))&&typeof o.audio=="object"){const c=function(d,l,u){l in d&&!(u in d)&&(d[u]=d[l],delete d[l])};c((o=JSON.parse(JSON.stringify(o))).audio,"autoGainControl","googAutoGainControl"),c(o.audio,"noiseSuppression","googNoiseSuppression"),o.audio=n(o.audio)}if(o&&typeof o.video=="object"){let c=o.video.facingMode;c=c&&(typeof c=="object"?c:{ideal:c});const d=e.version<66;if(c&&(c.exact==="user"||c.exact==="environment"||c.ideal==="user"||c.ideal==="environment")&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||d)){let l;if(delete o.video.facingMode,c.exact==="environment"||c.ideal==="environment"?l=["back","rear"]:c.exact!=="user"&&c.ideal!=="user"||(l=["front"]),l)return i.mediaDevices.enumerateDevices().then(u=>{let h=(u=u.filter(p=>p.kind==="videoinput")).find(p=>l.some(T=>{var m;return B(m=p.label.toLowerCase()).call(m,T)}));return!h&&u.length&&B(l).call(l,"back")&&(h=u[u.length-1]),h&&(o.video.deviceId=c.exact?{exact:h.deviceId}:{ideal:h.deviceId}),o.video=n(o.video),oR("chrome: "+JSON.stringify(o)),a(o)})}o.video=n(o.video)}return oR("chrome: "+JSON.stringify(o)),a(o)},s=function(o){return e.version>=64?o:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[o.name]||o.name,message:o.message,constraint:o.constraint||o.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=(function(o,a,c){r(o,d=>{i.webkitGetUserMedia(d,a,l=>{c&&c(s(l))})})}).bind(i),i.mediaDevices.getUserMedia){const o=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(a){return r(a,c=>o(c).then(d=>{if(c.audio&&!d.getAudioTracks().length||c.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(l=>{l.stop()}),new DOMException("","NotFoundError");return d},d=>G.reject(s(d))))}}}function cR(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function dR(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(i){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=i)},enumerable:!0,configurable:!0});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",n=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(o=>o.track&&o.track.id===n.track.id):{track:n.track};const s=new Event("track");s.track=n.track,s.receiver=r,s.transceiver={receiver:r},s.streams=[i.stream],this.dispatchEvent(s)}),i.stream.getTracks().forEach(n=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(o=>o.track&&o.track.id===n.id):{track:n};const s=new Event("track");s.track=n,s.receiver=r,s.transceiver={receiver:r},s.streams=[i.stream],this.dispatchEvent(s)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else bs(t,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function lR(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const e=function(r,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=r.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:r}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(o,a){let c=r.apply(this,arguments);return c||(c=e(this,o),this._senders.push(c)),c};const s=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(o){s.apply(this,arguments);const a=this._senders.indexOf(o);a!==-1&&this._senders.splice(a,1)}}const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(r){this._senders=this._senders||[],i.apply(this,[r]),r.getTracks().forEach(s=>{this._senders.push(e(this,s))})};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(r){this._senders=this._senders||[],n.apply(this,[r]),r.getTracks().forEach(s=>{const o=this._senders.find(a=>a.track===s);o&&this._senders.splice(this._senders.indexOf(o),1)})}}else if(typeof t=="object"&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){const i=e.apply(this,[]);return i.forEach(n=>n._pc=this),i},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function uR(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[i,n,r]=arguments;if(arguments.length>0&&typeof i=="function")return e.apply(this,arguments);if(e.length===0&&(arguments.length===0||typeof i!="function"))return e.apply(this,[]);const s=function(a){const c={};return a.result().forEach(d=>{const l={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach(u=>{l[u]=d.stat(u)}),c[l.id]=l}),c},o=function(a){return new Map(Object.keys(a).map(c=>[c,a[c]]))};if(arguments.length>=2){const a=function(c){n(o(s(c)))};return e.apply(this,[a,i])}return new G((a,c)=>{e.apply(this,[function(d){a(o(s(d)))},c])}).then(n,r)}}function hR(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){const i=t.RTCPeerConnection.prototype.getSenders;i&&(t.RTCPeerConnection.prototype.getSenders=function(){const r=i.apply(this,[]);return r.forEach(s=>s._pc=this),r});const n=t.RTCPeerConnection.prototype.addTrack;n&&(t.RTCPeerConnection.prototype.addTrack=function(){const r=n.apply(this,arguments);return r._pc=this,r}),t.RTCRtpSender.prototype.getStats=function(){const r=this;return this._pc.getStats().then(s=>sR(s,r.track,!0))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const i=t.RTCPeerConnection.prototype.getReceivers;i&&(t.RTCPeerConnection.prototype.getReceivers=function(){const n=i.apply(this,[]);return n.forEach(r=>r._pc=this),n}),bs(t,"track",n=>(n.receiver._pc=n.srcElement,n)),t.RTCRtpReceiver.prototype.getStats=function(){const n=this;return this._pc.getStats().then(r=>sR(r,n.track,!1))}}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const i=arguments[0];let n,r,s;return this.getSenders().forEach(o=>{o.track===i&&(n?s=!0:n=o)}),this.getReceivers().forEach(o=>(o.track===i&&(r?s=!0:r=o),o.track===i)),s||n&&r?G.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):n?n.getStats():r?r.getStats():G.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function pR(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(s=>this._shimmedLocalStreams[s][0])};const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(s,o){if(!o)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const a=e.apply(this,arguments);return this._shimmedLocalStreams[o.id]?this._shimmedLocalStreams[o.id].indexOf(a)===-1&&this._shimmedLocalStreams[o.id].push(a):this._shimmedLocalStreams[o.id]=[o,a],a};const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(s){this._shimmedLocalStreams=this._shimmedLocalStreams||{},s.getTracks().forEach(c=>{if(this.getSenders().find(l=>l.track===c))throw new DOMException("Track already exists.","InvalidAccessError")});const o=this.getSenders();i.apply(this,arguments);const a=this.getSenders().filter(c=>o.indexOf(c)===-1);this._shimmedLocalStreams[s.id]=[s].concat(a)};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[s.id],n.apply(this,arguments)};const r=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},s&&Object.keys(this._shimmedLocalStreams).forEach(o=>{const a=this._shimmedLocalStreams[o].indexOf(s);a!==-1&&this._shimmedLocalStreams[o].splice(a,1),this._shimmedLocalStreams[o].length===1&&delete this._shimmedLocalStreams[o]}),r.apply(this,arguments)}}function _R(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return pR(t);const i=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){const c=i.apply(this);return this._reverseStreams=this._reverseStreams||{},c.map(d=>this._reverseStreams[d.id])};const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(c){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.getTracks().forEach(d=>{if(this.getSenders().find(u=>u.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[c.id]){const d=new t.MediaStream(c.getTracks());this._streams[c.id]=d,this._reverseStreams[d.id]=c,c=d}n.apply(this,[c])};const r=t.RTCPeerConnection.prototype.removeStream;function s(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(u=>{const h=c._reverseStreams[u],p=c._streams[h.id];l=l.replace(new RegExp(p.id,"g"),h.id)}),new RTCSessionDescription({type:d.type,sdp:l})}t.RTCPeerConnection.prototype.removeStream=function(c){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[c.id]||c]),delete this._reverseStreams[this._streams[c.id]?this._streams[c.id].id:c.id],delete this._streams[c.id]},t.RTCPeerConnection.prototype.addTrack=function(c,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const l=[].slice.call(arguments,1);if(l.length!==1||!l[0].getTracks().find(p=>p===c))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(p=>p.track===c))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const h=this._streams[d.id];if(h)h.addTrack(c),G.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const p=new t.MediaStream([c]);this._streams[d.id]=p,this._reverseStreams[p.id]=d,this.addStream(p)}return this.getSenders().find(p=>p.track===c)},["createOffer","createAnswer"].forEach(function(c){const d=t.RTCPeerConnection.prototype[c],l={[c](){const u=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[h=>{const p=s(this,h);u[0].apply(null,[p])},h=>{u[1]&&u[1].apply(null,h)},arguments[2]]):d.apply(this,arguments).then(h=>s(this,h))}};t.RTCPeerConnection.prototype[c]=l[c]});const o=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(u=>{const h=c._reverseStreams[u],p=c._streams[h.id];l=l.replace(new RegExp(h.id,"g"),p.id)}),new RTCSessionDescription({type:d.type,sdp:l})}(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const c=a.get.apply(this);return c.type===""?c:s(this,c)}}),t.RTCPeerConnection.prototype.removeTrack=function(c){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!c._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(c._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let d;this._streams=this._streams||{},Object.keys(this._streams).forEach(l=>{this._streams[l].getTracks().find(u=>c.track===u)&&(d=this._streams[l])}),d&&(d.getTracks().length===1?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(c.track),this.dispatchEvent(new Event("negotiationneeded")))}}function c_(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(i){const n=t.RTCPeerConnection.prototype[i],r={[i](){return arguments[0]=new(i==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};t.RTCPeerConnection.prototype[i]=r[i]})}function ER(t,e){bs(t,"negotiationneeded",i=>{const n=i.target;if(!(e.version<72||n.getConfiguration&&n.getConfiguration().sdpSemantics==="plan-b")||n.signalingState==="stable")return i})}var mR=Object.freeze({__proto__:null,fixNegotiationNeeded:ER,shimAddTrackRemoveTrack:_R,shimAddTrackRemoveTrackWithNative:pR,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(typeof e=="function"?t.navigator.mediaDevices.getDisplayMedia=function(i){return e(i).then(n=>{const r=i.video&&i.video.width,s=i.video&&i.video.height,o=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxFrameRate:o||3}},r&&(i.video.mandatory.maxWidth=r),s&&(i.video.mandatory.maxHeight=s),t.navigator.mediaDevices.getUserMedia(i)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:lR,shimGetStats:uR,shimGetUserMedia:aR,shimMediaStream:cR,shimOnTrack:dR,shimPeerConnection:c_,shimSenderReceiverGetStats:hR});function fR(t,e){const i=t&&t.navigator,n=t&&t.MediaStreamTrack;if(i.getUserMedia=function(r,s,o){o_("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(r).then(s,o)},!(e.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const r=function(o,a,c){a in o&&!(c in o)&&(o[c]=o[a],delete o[a])},s=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(o){return typeof o=="object"&&typeof o.audio=="object"&&(o=JSON.parse(JSON.stringify(o)),r(o.audio,"autoGainControl","mozAutoGainControl"),r(o.audio,"noiseSuppression","mozNoiseSuppression")),s(o)},n&&n.prototype.getSettings){const o=n.prototype.getSettings;n.prototype.getSettings=function(){const a=o.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(n&&n.prototype.applyConstraints){const o=n.prototype.applyConstraints;n.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[a])}}}}function gR(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function d_(t,e){if(typeof t!="object"||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const s=t.RTCPeerConnection.prototype[r],o={[r](){return arguments[0]=new(r==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};t.RTCPeerConnection.prototype[r]=o[r]});const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[r,s,o]=arguments;return n.apply(this,[r||null]).then(a=>{if(e.version<53&&!s)try{a.forEach(c=>{c.type=i[c.type]||c.type})}catch(c){if(c.name!=="TypeError")throw c;a.forEach((d,l)=>{a.set(l,Object.assign({},d,{type:i[d.type]||d.type}))})}return a}).then(s,o)}}function TR(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const n=e.apply(this,[]);return n.forEach(r=>r._pc=this),n});const i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){const n=i.apply(this,arguments);return n._pc=this,n}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):G.resolve(new Map)}}function SR(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const i=e.apply(this,[]);return i.forEach(n=>n._pc=this),i}),bs(t,"track",i=>(i.receiver._pc=i.srcElement,i)),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function RR(t){t.RTCPeerConnection&&!("removeStream"in t.RTCPeerConnection.prototype)&&(t.RTCPeerConnection.prototype.removeStream=function(e){o_("removeStream","removeTrack"),this.getSenders().forEach(i=>{var n;i.track&&B(n=e.getTracks()).call(n,i.track)&&this.removeTrack(i)})})}function vR(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function CR(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];const n=i.length>0;n&&i.forEach(s=>{if("rid"in s&&!/^[a-z0-9]{0,16}$/i.test(s.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in s&&!(parseFloat(s.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in s&&!(parseFloat(s.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const r=e.apply(this,arguments);if(n){const{sender:s}=r,o=s.getParameters();(!("encodings"in o)||o.encodings.length===1&&Object.keys(o.encodings[0]).length===0)&&(o.encodings=i,s.sendEncodings=i,this.setParametersPromises.push(s.setParameters(o).then(()=>{delete s.sendEncodings}).catch(()=>{delete s.sendEncodings})))}return r})}function IR(t){if(typeof t!="object"||!t.RTCRtpSender)return;const e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){const i=e.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function yR(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?G.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function AR(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?G.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var bR=Object.freeze({__proto__:null,shimAddTransceiver:CR,shimCreateAnswer:AR,shimCreateOffer:yR,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,G.reject(n)}return i.video===!0?i.video={mediaSource:e}:i.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(i)})},shimGetParameters:IR,shimGetUserMedia:fR,shimOnTrack:gR,shimPeerConnection:d_,shimRTCDataChannel:vR,shimReceiverGetStats:SR,shimRemoveStream:RR,shimSenderGetStats:TR});function wR(t){if(typeof t=="object"&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(i){var n;this._localStreams||(this._localStreams=[]),B(n=this._localStreams).call(n,i)||this._localStreams.push(i),i.getAudioTracks().forEach(r=>e.call(this,r,i)),i.getVideoTracks().forEach(r=>e.call(this,r,i))},t.RTCPeerConnection.prototype.addTrack=function(i){for(var n=arguments.length,r=new Array(n>1?n-1:0),s=1;s<n;s++)r[s-1]=arguments[s];return r&&r.forEach(o=>{var a;this._localStreams?B(a=this._localStreams).call(a,o)||this._localStreams.push(o):this._localStreams=[o]}),e.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(e);if(i===-1)return;this._localStreams.splice(i,1);const n=e.getTracks();this.getSenders().forEach(r=>{B(n).call(n,r.track)&&this.removeTrack(r)})})}}function OR(t){if(typeof t=="object"&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(i){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=i),this.addEventListener("track",this._onaddstreampoly=n=>{n.streams.forEach(r=>{var s;if(this._remoteStreams||(this._remoteStreams=[]),B(s=this._remoteStreams).call(s,r))return;this._remoteStreams.push(r);const o=new Event("addstream");o.stream=r,this.dispatchEvent(o)})})}});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(n){n.streams.forEach(r=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(r)>=0)return;i._remoteStreams.push(r);const s=new Event("addstream");s.stream=r,i.dispatchEvent(s)})}),e.apply(i,arguments)}}}function NR(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype,i=e.createOffer,n=e.createAnswer,r=e.setLocalDescription,s=e.setRemoteDescription,o=e.addIceCandidate;e.createOffer=function(c,d){const l=arguments.length>=2?arguments[2]:arguments[0],u=i.apply(this,[l]);return d?(u.then(c,d),G.resolve()):u},e.createAnswer=function(c,d){const l=arguments.length>=2?arguments[2]:arguments[0],u=n.apply(this,[l]);return d?(u.then(c,d),G.resolve()):u};let a=function(c,d,l){const u=r.apply(this,[c]);return l?(u.then(d,l),G.resolve()):u};e.setLocalDescription=a,a=function(c,d,l){const u=s.apply(this,[c]);return l?(u.then(d,l),G.resolve()):u},e.setRemoteDescription=a,a=function(c,d,l){const u=o.apply(this,[c]);return l?(u.then(d,l),G.resolve()):u},e.addIceCandidate=a}function DR(t){const e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const i=e.mediaDevices,n=i.getUserMedia.bind(i);e.mediaDevices.getUserMedia=r=>n(PR(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(i,n,r){e.mediaDevices.getUserMedia(i).then(n,r)}).bind(e))}function PR(t){return t&&t.video!==void 0?Object.assign({},t,{video:rR(t.video)}):t}function LR(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection;t.RTCPeerConnection=function(i,n){if(i&&i.iceServers){const r=[];for(let s=0;s<i.iceServers.length;s++){let o=i.iceServers[s];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(o_("RTCIceServer.url","RTCIceServer.urls"),o=JSON.parse(JSON.stringify(o)),o.urls=o.url,delete o.url,r.push(o)):r.push(i.iceServers[s])}i.iceServers=r}return new e(i,n)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function kR(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function MR(t){const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(i){if(i){i.offerToReceiveAudio!==void 0&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const n=this.getTransceivers().find(s=>s.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):i.offerToReceiveAudio!==!0||n||this.addTransceiver("audio",{direction:"recvonly"}),i.offerToReceiveVideo!==void 0&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const r=this.getTransceivers().find(s=>s.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):i.offerToReceiveVideo!==!0||r||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function UR(t){typeof t!="object"||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var xR=Object.freeze({__proto__:null,shimAudioContext:UR,shimCallbacksAPI:NR,shimConstraints:PR,shimCreateOfferLegacy:MR,shimGetUserMedia:DR,shimLocalStreamsAPI:wR,shimRTCIceServerUrls:LR,shimRemoteStreamsAPI:OR,shimTrackEventTransceiver:kR}),VR=`	
\v\f\r                　\u2028\u2029\uFEFF`,SV=ms,RV=ki,l_=VR,FR=le("".replace),vV=RegExp("^["+l_+"]+"),CV=RegExp("(^|[^"+l_+"])["+l_+"]+$"),u_=function(t){return function(e){var i=RV(SV(e));return 1&t&&(i=FR(i,vV,"")),2&t&&(i=FR(i,CV,"$1")),i}},IV={start:u_(1),end:u_(2),trim:u_(3)},yV=Pg.PROPER,AV=$t,BR=VR,bV=IV.trim;bt({target:"String",proto:!0,forced:function(t){return AV(function(){return!!BR[t]()||"​᠎"[t]()!=="​᠎"||yV&&BR[t].name!==t})}("trim")},{trim:function(){return bV(this)}});var wV=dn("String","trim"),OV=ei,NV=wV,h_=String.prototype,DV=function(t){var e=t.trim;return typeof t=="string"||t===h_||OV(h_,t)&&e===h_.trim?NV:e},Xe=Bt(DV),jR={exports:{}};(function(t){const e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(i){return i.trim().split(`
`).map(n=>n.trim())},e.splitSections=function(i){return i.split(`
m=`).map((n,r)=>(r>0?"m="+n:n).trim()+`\r
`)},e.getDescription=function(i){const n=e.splitSections(i);return n&&n[0]},e.getMediaSections=function(i){const n=e.splitSections(i);return n.shift(),n},e.matchPrefix=function(i,n){return e.splitLines(i).filter(r=>r.indexOf(n)===0)},e.parseCandidate=function(i){let n;n=i.indexOf("a=candidate:")===0?i.substring(12).split(" "):i.substring(10).split(" ");const r={foundation:n[0],component:{1:"rtp",2:"rtcp"}[n[1]]||n[1],protocol:n[2].toLowerCase(),priority:parseInt(n[3],10),ip:n[4],address:n[4],port:parseInt(n[5],10),type:n[7]};for(let s=8;s<n.length;s+=2)switch(n[s]){case"raddr":r.relatedAddress=n[s+1];break;case"rport":r.relatedPort=parseInt(n[s+1],10);break;case"tcptype":r.tcpType=n[s+1];break;case"ufrag":r.ufrag=n[s+1],r.usernameFragment=n[s+1];break;default:r[n[s]]===void 0&&(r[n[s]]=n[s+1])}return r},e.writeCandidate=function(i){const n=[];n.push(i.foundation);const r=i.component;r==="rtp"?n.push(1):r==="rtcp"?n.push(2):n.push(r),n.push(i.protocol.toUpperCase()),n.push(i.priority),n.push(i.address||i.ip),n.push(i.port);const s=i.type;return n.push("typ"),n.push(s),s!=="host"&&i.relatedAddress&&i.relatedPort&&(n.push("raddr"),n.push(i.relatedAddress),n.push("rport"),n.push(i.relatedPort)),i.tcpType&&i.protocol.toLowerCase()==="tcp"&&(n.push("tcptype"),n.push(i.tcpType)),(i.usernameFragment||i.ufrag)&&(n.push("ufrag"),n.push(i.usernameFragment||i.ufrag)),"candidate:"+n.join(" ")},e.parseIceOptions=function(i){return i.substring(14).split(" ")},e.parseRtpMap=function(i){let n=i.substring(9).split(" ");const r={payloadType:parseInt(n.shift(),10)};return n=n[0].split("/"),r.name=n[0],r.clockRate=parseInt(n[1],10),r.channels=n.length===3?parseInt(n[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(i){let n=i.payloadType;i.preferredPayloadType!==void 0&&(n=i.preferredPayloadType);const r=i.channels||i.numChannels||1;return"a=rtpmap:"+n+" "+i.name+"/"+i.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(i){const n=i.substring(9).split(" ");return{id:parseInt(n[0],10),direction:n[0].indexOf("/")>0?n[0].split("/")[1]:"sendrecv",uri:n[1],attributes:n.slice(2).join(" ")}},e.writeExtmap=function(i){return"a=extmap:"+(i.id||i.preferredId)+(i.direction&&i.direction!=="sendrecv"?"/"+i.direction:"")+" "+i.uri+(i.attributes?" "+i.attributes:"")+`\r
`},e.parseFmtp=function(i){const n={};let r;const s=i.substring(i.indexOf(" ")+1).split(";");for(let o=0;o<s.length;o++)r=s[o].trim().split("="),n[r[0].trim()]=r[1];return n},e.writeFmtp=function(i){let n="",r=i.payloadType;if(i.preferredPayloadType!==void 0&&(r=i.preferredPayloadType),i.parameters&&Object.keys(i.parameters).length){const s=[];Object.keys(i.parameters).forEach(o=>{i.parameters[o]!==void 0?s.push(o+"="+i.parameters[o]):s.push(o)}),n+="a=fmtp:"+r+" "+s.join(";")+`\r
`}return n},e.parseRtcpFb=function(i){const n=i.substring(i.indexOf(" ")+1).split(" ");return{type:n.shift(),parameter:n.join(" ")}},e.writeRtcpFb=function(i){let n="",r=i.payloadType;return i.preferredPayloadType!==void 0&&(r=i.preferredPayloadType),i.rtcpFeedback&&i.rtcpFeedback.length&&i.rtcpFeedback.forEach(s=>{n+="a=rtcp-fb:"+r+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`}),n},e.parseSsrcMedia=function(i){const n=i.indexOf(" "),r={ssrc:parseInt(i.substring(7,n),10)},s=i.indexOf(":",n);return s>-1?(r.attribute=i.substring(n+1,s),r.value=i.substring(s+1)):r.attribute=i.substring(n+1),r},e.parseSsrcGroup=function(i){const n=i.substring(13).split(" ");return{semantics:n.shift(),ssrcs:n.map(r=>parseInt(r,10))}},e.getMid=function(i){const n=e.matchPrefix(i,"a=mid:")[0];if(n)return n.substring(6)},e.parseFingerprint=function(i){const n=i.substring(14).split(" ");return{algorithm:n[0].toLowerCase(),value:n[1].toUpperCase()}},e.getDtlsParameters=function(i,n){return{role:"auto",fingerprints:e.matchPrefix(i+n,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(i,n){let r="a=setup:"+n+`\r
`;return i.fingerprints.forEach(s=>{r+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`}),r},e.parseCryptoLine=function(i){const n=i.substring(9).split(" ");return{tag:parseInt(n[0],10),cryptoSuite:n[1],keyParams:n[2],sessionParams:n.slice(3)}},e.writeCryptoLine=function(i){return"a=crypto:"+i.tag+" "+i.cryptoSuite+" "+(typeof i.keyParams=="object"?e.writeCryptoKeyParams(i.keyParams):i.keyParams)+(i.sessionParams?" "+i.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(i){if(i.indexOf("inline:")!==0)return null;const n=i.substring(7).split("|");return{keyMethod:"inline",keySalt:n[0],lifeTime:n[1],mkiValue:n[2]?n[2].split(":")[0]:void 0,mkiLength:n[2]?n[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(i){return i.keyMethod+":"+i.keySalt+(i.lifeTime?"|"+i.lifeTime:"")+(i.mkiValue&&i.mkiLength?"|"+i.mkiValue+":"+i.mkiLength:"")},e.getCryptoParameters=function(i,n){return e.matchPrefix(i+n,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(i,n){const r=e.matchPrefix(i+n,"a=ice-ufrag:")[0],s=e.matchPrefix(i+n,"a=ice-pwd:")[0];return r&&s?{usernameFragment:r.substring(12),password:s.substring(10)}:null},e.writeIceParameters=function(i){let n="a=ice-ufrag:"+i.usernameFragment+`\r
a=ice-pwd:`+i.password+`\r
`;return i.iceLite&&(n+=`a=ice-lite\r
`),n},e.parseRtpParameters=function(i){const n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=e.splitLines(i)[0].split(" ");n.profile=r[2];for(let o=3;o<r.length;o++){const a=r[o],c=e.matchPrefix(i,"a=rtpmap:"+a+" ")[0];if(c){const d=e.parseRtpMap(c),l=e.matchPrefix(i,"a=fmtp:"+a+" ");switch(d.parameters=l.length?e.parseFmtp(l[0]):{},d.rtcpFeedback=e.matchPrefix(i,"a=rtcp-fb:"+a+" ").map(e.parseRtcpFb),n.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(d.name.toUpperCase())}}}e.matchPrefix(i,"a=extmap:").forEach(o=>{n.headerExtensions.push(e.parseExtmap(o))});const s=e.matchPrefix(i,"a=rtcp-fb:* ").map(e.parseRtcpFb);return n.codecs.forEach(o=>{s.forEach(a=>{o.rtcpFeedback.find(c=>c.type===a.type&&c.parameter===a.parameter)||o.rtcpFeedback.push(a)})}),n},e.writeRtpDescription=function(i,n){let r="";r+="m="+i+" ",r+=n.codecs.length>0?"9":"0",r+=" "+(n.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=n.codecs.map(o=>o.preferredPayloadType!==void 0?o.preferredPayloadType:o.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,n.codecs.forEach(o=>{r+=e.writeRtpMap(o),r+=e.writeFmtp(o),r+=e.writeRtcpFb(o)});let s=0;return n.codecs.forEach(o=>{o.maxptime>s&&(s=o.maxptime)}),s>0&&(r+="a=maxptime:"+s+`\r
`),n.headerExtensions&&n.headerExtensions.forEach(o=>{r+=e.writeExtmap(o)}),r},e.parseRtpEncodingParameters=function(i){const n=[],r=e.parseRtpParameters(i),s=r.fecMechanisms.indexOf("RED")!==-1,o=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=e.matchPrefix(i,"a=ssrc:").map(h=>e.parseSsrcMedia(h)).filter(h=>h.attribute==="cname"),c=a.length>0&&a[0].ssrc;let d;const l=e.matchPrefix(i,"a=ssrc-group:FID").map(h=>h.substring(17).split(" ").map(p=>parseInt(p,10)));l.length>0&&l[0].length>1&&l[0][0]===c&&(d=l[0][1]),r.codecs.forEach(h=>{if(h.name.toUpperCase()==="RTX"&&h.parameters.apt){let p={ssrc:c,codecPayloadType:parseInt(h.parameters.apt,10)};c&&d&&(p.rtx={ssrc:d}),n.push(p),s&&(p=JSON.parse(JSON.stringify(p)),p.fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},n.push(p))}}),n.length===0&&c&&n.push({ssrc:c});let u=e.matchPrefix(i,"b=");return u.length&&(u=u[0].indexOf("b=TIAS:")===0?parseInt(u[0].substring(7),10):u[0].indexOf("b=AS:")===0?1e3*parseInt(u[0].substring(5),10)*.95-16e3:void 0,n.forEach(h=>{h.maxBitrate=u})),n},e.parseRtcpParameters=function(i){const n={},r=e.matchPrefix(i,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];r&&(n.cname=r.value,n.ssrc=r.ssrc);const s=e.matchPrefix(i,"a=rtcp-rsize");n.reducedSize=s.length>0,n.compound=s.length===0;const o=e.matchPrefix(i,"a=rtcp-mux");return n.mux=o.length>0,n},e.writeRtcpParameters=function(i){let n="";return i.reducedSize&&(n+=`a=rtcp-rsize\r
`),i.mux&&(n+=`a=rtcp-mux\r
`),i.ssrc!==void 0&&i.cname&&(n+="a=ssrc:"+i.ssrc+" cname:"+i.cname+`\r
`),n},e.parseMsid=function(i){let n;const r=e.matchPrefix(i,"a=msid:");if(r.length===1)return n=r[0].substring(7).split(" "),{stream:n[0],track:n[1]};const s=e.matchPrefix(i,"a=ssrc:").map(o=>e.parseSsrcMedia(o)).filter(o=>o.attribute==="msid");return s.length>0?(n=s[0].value.split(" "),{stream:n[0],track:n[1]}):void 0},e.parseSctpDescription=function(i){const n=e.parseMLine(i),r=e.matchPrefix(i,"a=max-message-size:");let s;r.length>0&&(s=parseInt(r[0].substring(19),10)),isNaN(s)&&(s=65536);const o=e.matchPrefix(i,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:n.fmt,maxMessageSize:s};const a=e.matchPrefix(i,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:s}}},e.writeSctpDescription=function(i,n){let r=[];return r=i.protocol!=="DTLS/SCTP"?["m="+i.kind+" 9 "+i.protocol+" "+n.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+n.port+`\r
`]:["m="+i.kind+" 9 "+i.protocol+" "+n.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+n.port+" "+n.protocol+` 65535\r
`],n.maxMessageSize!==void 0&&r.push("a=max-message-size:"+n.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(i,n,r){let s;const o=n!==void 0?n:2;return s=i||e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+s+" "+o+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(i,n){const r=e.splitLines(i);for(let s=0;s<r.length;s++)switch(r[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[s].substring(2)}return n?e.getDirection(n):"sendrecv"},e.getKind=function(i){return e.splitLines(i)[0].split(" ")[0].substring(2)},e.isRejected=function(i){return i.split(" ",2)[1]==="0"},e.parseMLine=function(i){const n=e.splitLines(i)[0].substring(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},e.parseOLine=function(i){const n=e.matchPrefix(i,"o=")[0].substring(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},e.isValidSDP=function(i){if(typeof i!="string"||i.length===0)return!1;const n=e.splitLines(i);for(let r=0;r<n.length;r++)if(n[r].length<2||n[r].charAt(1)!=="=")return!1;return!0},t.exports=e})(jR);var GR=jR.exports,Do=Bt(GR),PV=so({__proto__:null,default:Do},[GR]);function rl(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;const e=t.RTCIceCandidate;t.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&((i=JSON.parse(JSON.stringify(i))).candidate=i.candidate.substr(2)),i.candidate&&i.candidate.length){const n=new e(i),r=Do.parseCandidate(i.candidate),s=Object.assign(n,r);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new e(i)},t.RTCIceCandidate.prototype=e.prototype,bs(t,"icecandidate",i=>(i.candidate&&Object.defineProperty(i,"candidate",{value:new t.RTCIceCandidate(i.candidate),writable:"false"}),i))}function p_(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||bs(t,"icecandidate",e=>{if(e.candidate){const i=Do.parseCandidate(e.candidate.candidate);i.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[i.priority>>24])}return e})}function sl(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:n}=this.getConfiguration();n==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(function(n){if(!n||!n.sdp)return!1;const r=Do.splitSections(n.sdp);return r.shift(),r.some(s=>{const o=Do.parseMLine(s);return o&&o.kind==="application"&&o.protocol.indexOf("SCTP")!==-1})}(arguments[0])){const n=function(c){const d=c.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(d===null||d.length<2)return-1;const l=parseInt(d[1],10);return l!=l?-1:l}(arguments[0]),r=function(c){let d=65536;return e.browser==="firefox"&&(d=e.version<57?c===-1?16384:2147483637:e.version<60?e.version===57?65535:65536:2147483637),d}(n),s=function(c,d){let l=65536;e.browser==="firefox"&&e.version===57&&(l=65535);const u=Do.matchPrefix(c.sdp,"a=max-message-size:");return u.length>0?l=parseInt(u[0].substr(19),10):e.browser==="firefox"&&d!==-1&&(l=2147483637),l}(arguments[0],n);let o;o=r===0&&s===0?Number.POSITIVE_INFINITY:r===0||s===0?Math.max(r,s):Math.min(r,s);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>o}),this._sctp=a}return i.apply(this,arguments)}}function ol(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function e(n,r){const s=n.send;n.send=function(){const o=arguments[0],a=o.length||o.size||o.byteLength;if(n.readyState==="open"&&r.sctp&&a>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return s.apply(n,arguments)}}const i=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){const n=i.apply(this,arguments);return e(n,this),n},bs(t,"datachannel",n=>(e(n.channel,n.target),n))}function __(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;const e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(i){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),i&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=i)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(i=>{const n=e[i];e[i]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const s=r.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const o=new Event("connectionstatechange",r);s.dispatchEvent(o)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}})}function E_(t,e){if(!t.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;const i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(n){if(n&&n.sdp&&n.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const r=n.sdp.split(`
`).filter(s=>Xe(s).call(s)!=="a=extmap-allow-mixed").join(`
`);t.RTCSessionDescription&&n instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:n.type,sdp:r}):n.sdp=r}return i.apply(this,arguments)}}function al(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const i=t.RTCPeerConnection.prototype.addIceCandidate;i&&i.length!==0&&(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?G.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),G.resolve())})}function cl(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const i=t.RTCPeerConnection.prototype.setLocalDescription;i&&i.length!==0&&(t.RTCPeerConnection.prototype.setLocalDescription=function(){let n=arguments[0]||{};if(typeof n!="object"||n.type&&n.sdp)return i.apply(this,arguments);if(n={type:n.type,sdp:n.sdp},!n.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":n.type="offer";break;default:n.type="answer"}return n.sdp||n.type!=="offer"&&n.type!=="answer"?i.apply(this,[n]):(n.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(r=>i.apply(this,[r]))})}var LV=Object.freeze({__proto__:null,removeExtmapAllowMixed:E_,shimAddIceCandidateNullOrEmpty:al,shimConnectionState:__,shimMaxMessageSize:sl,shimParameterlessSetLocalDescription:cl,shimRTCIceCandidate:rl,shimRTCIceCandidateRelayProtocol:p_,shimSendThrowTypeError:ol});(function(){let{window:t}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const i=iR,n=function(s){const o={browser:null,version:null};if(s===void 0||!s.navigator)return o.browser="Not a browser.",o;const{navigator:a}=s;if(a.mozGetUserMedia)o.browser="firefox",o.version=nl(a.userAgent,/Firefox\/(\d+)\./,1);else if(a.webkitGetUserMedia||s.isSecureContext===!1&&s.webkitRTCPeerConnection)o.browser="chrome",o.version=nl(a.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!s.RTCPeerConnection||!a.userAgent.match(/AppleWebKit\/(\d+)\./))return o.browser="Not a supported browser.",o;o.browser="safari",o.version=nl(a.userAgent,/AppleWebKit\/(\d+)\./,1),o.supportsUnifiedPlan=s.RTCRtpTransceiver&&"currentDirection"in s.RTCRtpTransceiver.prototype}return o}(t),r={browserDetails:n,commonShim:LV,extractVersion:nl,disableLog:gV,disableWarnings:TV,sdp:PV};switch(n.browser){case"chrome":if(!mR||!c_||!e.shimChrome)return i("Chrome shim is not included in this adapter release."),r;if(n.version===null)return i("Chrome shim can not determine version, not shimming."),r;i("adapter.js shimming chrome."),r.browserShim=mR,al(t,n),cl(t),aR(t,n),cR(t),c_(t,n),dR(t),_R(t,n),lR(t),uR(t),hR(t),ER(t,n),rl(t),p_(t),__(t),sl(t,n),ol(t),E_(t,n);break;case"firefox":if(!bR||!d_||!e.shimFirefox)return i("Firefox shim is not included in this adapter release."),r;i("adapter.js shimming firefox."),r.browserShim=bR,al(t,n),cl(t),fR(t,n),d_(t,n),gR(t),RR(t),TR(t),SR(t),vR(t),CR(t),IR(t),yR(t),AR(t),rl(t),__(t),sl(t,n),ol(t);break;case"safari":if(!xR||!e.shimSafari)return i("Safari shim is not included in this adapter release."),r;i("adapter.js shimming safari."),r.browserShim=xR,al(t,n),cl(t),LR(t),MR(t),NR(t),wR(t),OR(t),kR(t),DR(t),UR(t),rl(t),p_(t),sl(t,n),ol(t),E_(t,n);break;default:i("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var WR=co,kV=TypeError,HR=Er.match(/firefox\/(\d+)/i),MV=!!HR&&+HR[1],UV=/MSIE|Trident/.test(Er),KR=Er.match(/AppleWebKit\/(\d+)\./),xV=!!KR&&+KR[1],VV=bt,YR=le,FV=Li,BV=qn,qR=Br,jV=function(t,e){if(!delete t[e])throw new kV("Cannot delete property "+WR(e)+" of "+WR(t))},zR=ki,m_=$t,GV=tS,WV=_d,JR=MV,HV=UV,XR=fs,QR=xV,qr=[],ZR=YR(qr.sort),KV=YR(qr.push),YV=m_(function(){qr.sort(void 0)}),qV=m_(function(){qr.sort(null)}),zV=WV("sort"),$R=!m_(function(){if(XR)return XR<70;if(!(JR&&JR>3)){if(HV)return!0;if(QR)return QR<603;var t,e,i,n,r="";for(t=65;t<76;t++){switch(e=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(n=0;n<47;n++)qr.push({k:e+n,v:i})}for(qr.sort(function(s,o){return o.v-s.v}),n=0;n<qr.length;n++)e=qr[n].k.charAt(0),r.charAt(r.length-1)!==e&&(r+=e);return r!=="DGBEFHACIJK"}});VV({target:"Array",proto:!0,forced:YV||!qV||!zV||!$R},{sort:function(t){t!==void 0&&FV(t);var e=BV(this);if($R)return t===void 0?ZR(e):ZR(e,t);var i,n,r=[],s=qR(e);for(n=0;n<s;n++)n in e&&KV(r,e[n]);for(GV(r,function(o){return function(a,c){return c===void 0?-1:a===void 0?1:o!==void 0?+o(a,c)||0:zR(a)>zR(c)?1:-1}}(t)),i=qR(r),n=0;n<i;)e[n]=r[n++];for(;n<s;)jV(e,n++);return e}});var JV=dn("Array","sort"),XV=ei,QV=JV,f_=Array.prototype,ZV=function(t){var e=t.sort;return t===f_||XV(f_,t)&&e===f_.sort?QV:e},tc=Bt(ZV),g_=re;bt({global:!0,forced:g_.globalThis!==g_},{globalThis:g_});var tv=Bt(re),T_={exports:{}};(function(t,e){(function(i,n){var r="function",s="undefined",o="object",a="string",c="major",d="model",l="name",u="type",h="vendor",p="version",T="architecture",m="console",f="mobile",R="tablet",v="smarttv",A="wearable",O="embedded",w="Amazon",b="Apple",L="ASUS",x="BlackBerry",W="Browser",K="Chrome",ht="Firefox",pt="Google",Vt="Huawei",ce="LG",ne="Microsoft",Ei="Motorola",k="Opera",F="Samsung",X="Sharp",M="Sony",E="Xiaomi",I="Zebra",y="Facebook",V="Chromium OS",st="Mac OS",Lt=function(Se){for(var we={},Wt=0;Wt<Se.length;Wt++)we[Se[Wt].toUpperCase()]=Se[Wt];return we},be=function(Se,we){return typeof Se===a&&Ii(we).indexOf(Ii(Se))!==-1},Ii=function(Se){return Se.toLowerCase()},Mr=function(Se,we){if(typeof Se===a)return Se=Se.replace(/^\s\s*/,""),typeof we===s?Se:Se.substring(0,350)},no=function(Se,we){for(var Wt,Pi,_r,de,vt,yi,Es=0;Es<we.length&&!vt;){var Kn=we[Es],bN=we[Es+1];for(Wt=Pi=0;Wt<Kn.length&&!vt&&Kn[Wt];)if(vt=Kn[Wt++].exec(Se))for(_r=0;_r<bN.length;_r++)yi=vt[++Pi],typeof(de=bN[_r])===o&&de.length>0?de.length===2?typeof de[1]==r?this[de[0]]=de[1].call(this,yi):this[de[0]]=de[1]:de.length===3?typeof de[1]!==r||de[1].exec&&de[1].test?this[de[0]]=yi?yi.replace(de[1],de[2]):n:this[de[0]]=yi?de[1].call(this,yi,de[2]):n:de.length===4&&(this[de[0]]=yi?de[3].call(this,yi.replace(de[1],de[2])):n):this[de]=yi||n;Es+=2}},id=function(Se,we){for(var Wt in we)if(typeof we[Wt]===o&&we[Wt].length>0){for(var Pi=0;Pi<we[Wt].length;Pi++)if(be(we[Wt][Pi],Se))return Wt==="?"?n:Wt}else if(be(we[Wt],Se))return Wt==="?"?n:Wt;return Se},th={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},eh={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[l,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[l,p],[/opios[\/ ]+([\w\.]+)/i],[p,[l,k+" Mini"]],[/\bopr\/([\w\.]+)/i],[p,[l,k]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[l,p],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[l,"UC"+W]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[p,[l,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[p,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[l,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[l,"IE"]],[/yabrowser\/([\w\.]+)/i],[p,[l,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure "+W],p],[/\bfocus\/([\w\.]+)/i],[p,[l,ht+" Focus"]],[/\bopt\/([\w\.]+)/i],[p,[l,k+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[l,k+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[l,"MIUI "+W]],[/fxios\/([-\w\.]+)/i],[p,[l,ht]],[/\bqihu|(qi?ho?o?|360)browser/i],[[l,"360 "+W]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1 "+W],p],[/(comodo_dragon)\/([\w\.]+)/i],[[l,/_/g," "],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[l,p],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[l],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[l,y],p],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[l,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[l,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[l,K+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[l,K+" WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[l,"Android "+W]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[l,p],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[p,[l,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[p,l],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[l,[p,id,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[l,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[l,"Netscape"],p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[l,ht+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[l,p],[/(cobalt)\/([\w\.]+)/i],[l,[p,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[T,"amd64"]],[/(ia32(?=;))/i],[[T,Ii]],[/((?:i[346]|x)86)[;\)]/i],[[T,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[T,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[T,"armhf"]],[/windows (ce|mobile); ppc;/i],[[T,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[T,/ower/,"",Ii]],[/(sun4\w)[;\)]/i],[[T,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[T,Ii]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[h,F],[u,R]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[d,[h,F],[u,f]],[/\((ip(?:hone|od)[\w ]*);/i],[d,[h,b],[u,f]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[h,b],[u,R]],[/(macintosh);/i],[d,[h,b]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[h,X],[u,f]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[h,Vt],[u,R]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[h,Vt],[u,f]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[d,/_/g," "],[h,E],[u,f]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[h,E],[u,R]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[h,"OPPO"],[u,f]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[h,"Vivo"],[u,f]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[d,[h,"Realme"],[u,f]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[h,Ei],[u,f]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[h,Ei],[u,R]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[h,ce],[u,R]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[h,ce],[u,f]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[h,"Lenovo"],[u,R]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[h,"Nokia"],[u,f]],[/(pixel c)\b/i],[d,[h,pt],[u,R]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[h,pt],[u,f]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[h,M],[u,f]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[h,M],[u,R]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[h,"OnePlus"],[u,f]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[h,w],[u,R]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[h,w],[u,f]],[/(playbook);[-\w\),; ]+(rim)/i],[d,h,[u,R]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[h,x],[u,f]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[h,L],[u,R]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[h,L],[u,f]],[/(nexus 9)/i],[d,[h,"HTC"],[u,R]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[h,[d,/_/g," "],[u,f]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[h,"Acer"],[u,R]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[h,"Meizu"],[u,f]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[h,d,[u,f]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[h,d,[u,R]],[/(surface duo)/i],[d,[h,ne],[u,R]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[h,"Fairphone"],[u,f]],[/(u304aa)/i],[d,[h,"AT&T"],[u,f]],[/\bsie-(\w*)/i],[d,[h,"Siemens"],[u,f]],[/\b(rct\w+) b/i],[d,[h,"RCA"],[u,R]],[/\b(venue[\d ]{2,7}) b/i],[d,[h,"Dell"],[u,R]],[/\b(q(?:mv|ta)\w+) b/i],[d,[h,"Verizon"],[u,R]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[h,"Barnes & Noble"],[u,R]],[/\b(tm\d{3}\w+) b/i],[d,[h,"NuVision"],[u,R]],[/\b(k88) b/i],[d,[h,"ZTE"],[u,R]],[/\b(nx\d{3}j) b/i],[d,[h,"ZTE"],[u,f]],[/\b(gen\d{3}) b.+49h/i],[d,[h,"Swiss"],[u,f]],[/\b(zur\d{3}) b/i],[d,[h,"Swiss"],[u,R]],[/\b((zeki)?tb.*\b) b/i],[d,[h,"Zeki"],[u,R]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[h,"Dragon Touch"],d,[u,R]],[/\b(ns-?\w{0,9}) b/i],[d,[h,"Insignia"],[u,R]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[h,"NextBook"],[u,R]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[h,"Voice"],d,[u,f]],[/\b(lvtel\-)?(v1[12]) b/i],[[h,"LvTel"],d,[u,f]],[/\b(ph-1) /i],[d,[h,"Essential"],[u,f]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[h,"Envizen"],[u,R]],[/\b(trio[-\w\. ]+) b/i],[d,[h,"MachSpeed"],[u,R]],[/\btu_(1491) b/i],[d,[h,"Rotor"],[u,R]],[/(shield[\w ]+) b/i],[d,[h,"Nvidia"],[u,R]],[/(sprint) (\w+)/i],[h,d,[u,f]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[h,ne],[u,f]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[h,I],[u,R]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[h,I],[u,f]],[/smart-tv.+(samsung)/i],[h,[u,v]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[h,F],[u,v]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[h,ce],[u,v]],[/(apple) ?tv/i],[h,[d,b+" TV"],[u,v]],[/crkey/i],[[d,K+"cast"],[h,pt],[u,v]],[/droid.+aft(\w)( bui|\))/i],[d,[h,w],[u,v]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[h,X],[u,v]],[/(bravia[\w ]+)( bui|\))/i],[d,[h,M],[u,v]],[/(mitv-\w{5}) bui/i],[d,[h,E],[u,v]],[/Hbbtv.*(technisat) (.*);/i],[h,d,[u,v]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[h,Mr],[d,Mr],[u,v]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[u,v]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[h,d,[u,m]],[/droid.+; (shield) bui/i],[d,[h,"Nvidia"],[u,m]],[/(playstation [345portablevi]+)/i],[d,[h,M],[u,m]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[h,ne],[u,m]],[/((pebble))app/i],[h,d,[u,A]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[h,b],[u,A]],[/droid.+; (glass) \d/i],[d,[h,pt],[u,A]],[/droid.+; (wt63?0{2,3})\)/i],[d,[h,I],[u,A]],[/(quest( 2| pro)?)/i],[d,[h,y],[u,A]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[h,[u,O]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[d,[u,f]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[u,R]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[u,R]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[u,f]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[h,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[l,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[l,p],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,l]],os:[[/microsoft (windows) (vista|xp)/i],[l,p],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[l,[p,id,th]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[l,"Windows"],[p,id,th]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[l,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[l,st],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[p,l],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[l,p],[/\(bb(10);/i],[p,[l,x]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[p,[l,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[l,ht+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[l,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[p,[l,"watchOS"]],[/crkey\/([\d\.]+)/i],[p,[l,K+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[l,V],p],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[l,p],[/(sunos) ?([\w\.\d]*)/i],[[l,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[l,p]]},an=function(Se,we){if(typeof Se===o&&(we=Se,Se=n),!(this instanceof an))return new an(Se,we).getResult();var Wt=typeof i!==s&&i.navigator?i.navigator:n,Pi=Se||(Wt&&Wt.userAgent?Wt.userAgent:""),_r=Wt&&Wt.userAgentData?Wt.userAgentData:n,de=we?function(vt,yi){var Es={};for(var Kn in vt)yi[Kn]&&yi[Kn].length%2==0?Es[Kn]=yi[Kn].concat(vt[Kn]):Es[Kn]=vt[Kn];return Es}(eh,we):eh;return this.getBrowser=function(){var vt={};return vt[l]=n,vt[p]=n,no.call(vt,Pi,de.browser),vt[c]=function(yi){return typeof yi===a?yi.replace(/[^\d\.]/g,"").split(".")[0]:n}(vt[p]),Wt&&Wt.brave&&typeof Wt.brave.isBrave==r&&(vt[l]="Brave"),vt},this.getCPU=function(){var vt={};return vt[T]=n,no.call(vt,Pi,de.cpu),vt},this.getDevice=function(){var vt={};return vt[h]=n,vt[d]=n,vt[u]=n,no.call(vt,Pi,de.device),!vt[u]&&_r&&_r.mobile&&(vt[u]=f),vt[d]=="Macintosh"&&Wt&&typeof Wt.standalone!==s&&Wt.maxTouchPoints&&Wt.maxTouchPoints>2&&(vt[d]="iPad",vt[u]=R),vt},this.getEngine=function(){var vt={};return vt[l]=n,vt[p]=n,no.call(vt,Pi,de.engine),vt},this.getOS=function(){var vt={};return vt[l]=n,vt[p]=n,no.call(vt,Pi,de.os),!vt[l]&&_r&&_r.platform!="Unknown"&&(vt[l]=_r.platform.replace(/chrome os/i,V).replace(/macos/i,st)),vt},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return Pi},this.setUA=function(vt){return Pi=typeof vt===a&&vt.length>350?Mr(vt,350):vt,this},this.setUA(Pi),this};an.VERSION="0.7.34",an.BROWSER=Lt([l,p,c]),an.CPU=Lt([T]),an.DEVICE=Lt([d,h,u,m,f,v,R,A,O]),an.ENGINE=an.OS=Lt([l,p]),t.exports&&(e=t.exports=an),e.UAParser=an;var _s=typeof i!==s&&(i.jQuery||i.Zepto);if(_s&&!_s.ua){var ro=new an;_s.ua=ro.getResult(),_s.ua.get=function(){return ro.getUA()},_s.ua.set=function(Se){ro.setUA(Se);var we=ro.getResult();for(var Wt in we)_s.ua[Wt]=we[Wt]}}})(typeof window=="object"?window:Ai)})(T_,T_.exports);var $V=Bt(T_.exports),tF=mr,eF=He,iF=oo,nF=Ts,rF=me("iterator"),sF=Object,oF=function(t){if(iF(t))return!1;var e=sF(t);return e[rF]!==void 0||"@@iterator"in e||eF(nF,tF(e))},aF=Bt(oF),ev=Md.clear;bt({global:!0,bind:!0,enumerable:!0,forced:re.clearImmediate!==ev},{clearImmediate:ev});var iv=re,cF=Oa,dF=xe,lF=Ah,uF=Er,hF=Gr,pF=vs,_F=iv.Function,EF=/MSIE .\./.test(uF)||lF==="BUN"&&function(){var t=iv.Bun.version.split(".");return t.length<3||t[0]==="0"&&(t[1]<3||t[1]==="3"&&t[2]==="0")}(),mF=bt,nv=re,rv=Md.set,fF=function(t,e){var i=1;return EF?function(n,r){var s=pF(arguments.length,1)>i,o=dF(n)?n:_F(n),a=s?hF(arguments,i):[],c=s?function(){cF(o,this,a)}:o;return t(c)}:t},sv=nv.setImmediate?fF(rv):rv;mF({global:!0,bind:!0,enumerable:!0,forced:nv.setImmediate!==sv},{setImmediate:sv});var ov=Bt(zi.setImmediate),gF=re,TF=fT,SF=Li,RF=vs,vF=mi;bt({global:!0,enumerable:!0,dontCallGetSet:!0,forced:$t(function(){return vF&&Object.getOwnPropertyDescriptor(gF,"queueMicrotask").value.length!==1})},{queueMicrotask:function(t){RF(arguments.length,1),TF(SF(t))}});var av=Bt(zi.queueMicrotask);function cv(t,e){return function(){return t.apply(e,arguments)}}const{toString:CF}=Object.prototype,{getPrototypeOf:S_}=Object,dl=(R_=Object.create(null),t=>{const e=CF.call(t);return R_[e]||(R_[e]=e.slice(8,-1).toLowerCase())});var R_;const Pn=t=>(t=t.toLowerCase(),e=>dl(e)===t),ll=t=>e=>typeof e===t,{isArray:Po}=Array,ec=ll("undefined"),dv=Pn("ArrayBuffer"),IF=ll("string"),Xi=ll("function"),lv=ll("number"),ul=t=>t!==null&&typeof t=="object",hl=t=>{if(dl(t)!=="object")return!1;const e=S_(t);return!(e!==null&&e!==Object.prototype&&Object.getPrototypeOf(e)!==null||Symbol.toStringTag in t||aF(t))},yF=Pn("Date"),AF=Pn("File"),bF=Pn("Blob"),wF=Pn("FileList"),OF=Pn("URLSearchParams"),[NF,DF,PF,LF]=["ReadableStream","Request","Response","Headers"].map(Pn);function ic(t,e){let i,n,{allOwnKeys:r=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(t!=null)if(typeof t!="object"&&(t=[t]),Po(t))for(i=0,n=t.length;i<n;i++)e.call(null,t[i],i,t);else{const s=r?Object.getOwnPropertyNames(t):Object.keys(t),o=s.length;let a;for(i=0;i<o;i++)a=s[i],e.call(null,t[a],a,t)}}function uv(t,e){e=e.toLowerCase();const i=Object.keys(t);let n,r=i.length;for(;r-- >0;)if(n=i[r],e===n.toLowerCase())return n;return null}const ws=tv!==void 0?tv:typeof self<"u"?self:typeof window<"u"?window:ih,hv=t=>!ec(t)&&t!==ws,kF=(v_=typeof Uint8Array<"u"&&S_(Uint8Array),t=>v_&&t instanceof v_);var v_;const MF=Pn("HTMLFormElement"),pv=(t=>{let{hasOwnProperty:e}=t;return(i,n)=>e.call(i,n)})(Object.prototype),UF=Pn("RegExp"),_v=(t,e)=>{const i=Object.getOwnPropertyDescriptors(t),n={};ic(i,(r,s)=>{let o;(o=e(r,s,t))!==!1&&(n[s]=o||r)}),Object.defineProperties(t,n)},C_="abcdefghijklmnopqrstuvwxyz",Ev="0123456789",mv={DIGIT:Ev,ALPHA:C_,ALPHA_DIGIT:C_+C_.toUpperCase()+Ev},xF=Pn("AsyncFunction"),fv=(gv=typeof ov=="function",Tv=Xi(ws.postMessage),gv?ov:Tv?(I_="axios@".concat(Math.random()),pl=[],ws.addEventListener("message",t=>{let{source:e,data:i}=t;e===ws&&i===I_&&pl.length&&pl.shift()()},!1),t=>{pl.push(t),ws.postMessage(I_,"*")}):t=>setTimeout(t));var gv,Tv,I_,pl;const VF=av!==void 0?av.bind(ws):typeof process<"u"&&process.nextTick||fv;var j={isArray:Po,isArrayBuffer:dv,isBuffer:function(t){return t!==null&&!ec(t)&&t.constructor!==null&&!ec(t.constructor)&&Xi(t.constructor.isBuffer)&&t.constructor.isBuffer(t)},isFormData:t=>{let e;return t&&(typeof FormData=="function"&&t instanceof FormData||Xi(t.append)&&((e=dl(t))==="formdata"||e==="object"&&Xi(t.toString)&&t.toString()==="[object FormData]"))},isArrayBufferView:function(t){let e;return e=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&dv(t.buffer),e},isString:IF,isNumber:lv,isBoolean:t=>t===!0||t===!1,isObject:ul,isPlainObject:hl,isReadableStream:NF,isRequest:DF,isResponse:PF,isHeaders:LF,isUndefined:ec,isDate:yF,isFile:AF,isBlob:bF,isRegExp:UF,isFunction:Xi,isStream:t=>ul(t)&&Xi(t.pipe),isURLSearchParams:OF,isTypedArray:kF,isFileList:wF,forEach:ic,merge:function t(){const{caseless:e}=hv(this)&&this||{},i={},n=(r,s)=>{const o=e&&uv(i,s)||s;hl(i[o])&&hl(r)?i[o]=t(i[o],r):hl(r)?i[o]=t({},r):Po(r)?i[o]=r.slice():i[o]=r};for(let r=0,s=arguments.length;r<s;r++)arguments[r]&&ic(arguments[r],n);return i},extend:function(t,e,i){let{allOwnKeys:n}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return ic(e,(r,s)=>{i&&Xi(r)?t[s]=cv(r,i):t[s]=r},{allOwnKeys:n}),t},trim:t=>Xe(t)?Xe(t).call(t):t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),inherits:(t,e,i,n)=>{t.prototype=Object.create(e.prototype,n),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),i&&Object.assign(t.prototype,i)},toFlatObject:(t,e,i,n)=>{let r,s,o;const a={};if(e=e||{},t==null)return e;do{for(r=Object.getOwnPropertyNames(t),s=r.length;s-- >0;)o=r[s],n&&!n(o,t,e)||a[o]||(e[o]=t[o],a[o]=!0);t=i!==!1&&S_(t)}while(t&&(!i||i(t,e))&&t!==Object.prototype);return e},kindOf:dl,kindOfTest:Pn,endsWith:(t,e,i)=>{t=String(t),(i===void 0||i>t.length)&&(i=t.length),i-=e.length;const n=t.indexOf(e,i);return n!==-1&&n===i},toArray:t=>{if(!t)return null;if(Po(t))return t;let e=t.length;if(!lv(e))return null;const i=new Array(e);for(;e-- >0;)i[e]=t[e];return i},forEachEntry:(t,e)=>{const i=(t&&t[Symbol.iterator]).call(t);let n;for(;(n=i.next())&&!n.done;){const r=n.value;e.call(t,r[0],r[1])}},matchAll:(t,e)=>{let i;const n=[];for(;(i=t.exec(e))!==null;)n.push(i);return n},isHTMLForm:MF,hasOwnProperty:pv,hasOwnProp:pv,reduceDescriptors:_v,freezeMethods:t=>{_v(t,(e,i)=>{if(Xi(t)&&["arguments","caller","callee"].indexOf(i)!==-1)return!1;const n=t[i];Xi(n)&&(e.enumerable=!1,"writable"in e?e.writable=!1:e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+i+"'")}))})},toObjectSet:(t,e)=>{const i={},n=r=>{r.forEach(s=>{i[s]=!0})};return Po(t)?n(t):n(String(t).split(e)),i},toCamelCase:t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,i,n){return i.toUpperCase()+n}),noop:()=>{},toFiniteNumber:(t,e)=>t!=null&&Number.isFinite(t=+t)?t:e,findKey:uv,global:ws,isContextDefined:hv,ALPHABET:mv,generateString:function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:mv.ALPHA_DIGIT,i="";const{length:n}=e;for(;t--;)i+=e[Math.random()*n|0];return i},isSpecCompliantForm:function(t){return!!(t&&Xi(t.append)&&t[Symbol.toStringTag]==="FormData"&&t[Symbol.iterator])},toJSONObject:t=>{const e=new Array(10),i=(n,r)=>{if(ul(n)){if(e.indexOf(n)>=0)return;if(!("toJSON"in n)){e[r]=n;const s=Po(n)?[]:{};return ic(n,(o,a)=>{const c=i(o,r+1);!ec(c)&&(s[a]=c)}),e[r]=void 0,s}}return n};return i(t,0)},isAsyncFn:xF,isThenable:t=>t&&(ul(t)||Xi(t))&&Xi(t.then)&&Xi(t.catch),setImmediate:fv,asap:VF};function Dt(t,e,i,n,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",e&&(this.code=e),i&&(this.config=i),n&&(this.request=n),r&&(this.response=r,this.status=r.status?r.status:null)}j.inherits(Dt,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:j.toJSONObject(this.config),code:this.code,status:this.status}}});const Sv=Dt.prototype,Rv={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{Rv[t]={value:t}}),Object.defineProperties(Dt,Rv),Object.defineProperty(Sv,"isAxiosError",{value:!0}),Dt.from=(t,e,i,n,r,s)=>{const o=Object.create(Sv);return j.toFlatObject(t,o,function(a){return a!==Error.prototype},a=>a!=="isAxiosError"),Dt.call(o,t.message,e,i,n,r),o.cause=t,o.name=t.name,s&&Object.assign(o,s),o};function y_(t){return j.isPlainObject(t)||j.isArray(t)}function vv(t){return j.endsWith(t,"[]")?t.slice(0,-2):t}function Cv(t,e,i){return t?t.concat(e).map(function(n,r){return n=vv(n),!i&&r?"["+n+"]":n}).join(i?".":""):e}const FF=j.toFlatObject(j,{},null,function(t){return/^is[A-Z]/.test(t)});function _l(t,e,i){if(!j.isObject(t))throw new TypeError("target must be an object");e=e||new FormData;const n=(i=j.toFlatObject(i,{metaTokens:!0,dots:!1,indexes:!1},!1,function(h,p){return!j.isUndefined(p[h])})).metaTokens,r=i.visitor||d,s=i.dots,o=i.indexes,a=(i.Blob||typeof Blob<"u"&&Blob)&&j.isSpecCompliantForm(e);if(!j.isFunction(r))throw new TypeError("visitor must be a function");function c(h){if(h===null)return"";if(j.isDate(h))return h.toISOString();if(!a&&j.isBlob(h))throw new Dt("Blob is not supported. Use a Buffer instead.");return j.isArrayBuffer(h)||j.isTypedArray(h)?a&&typeof Blob=="function"?new Blob([h]):Buffer.from(h):h}function d(h,p,T){let m=h;if(h&&!T&&typeof h=="object"){if(j.endsWith(p,"{}"))p=n?p:p.slice(0,-2),h=JSON.stringify(h);else if(j.isArray(h)&&function(f){return j.isArray(f)&&!f.some(y_)}(h)||(j.isFileList(h)||j.endsWith(p,"[]"))&&(m=j.toArray(h)))return p=vv(p),m.forEach(function(f,R){!j.isUndefined(f)&&f!==null&&e.append(o===!0?Cv([p],R,s):o===null?p:p+"[]",c(f))}),!1}return!!y_(h)||(e.append(Cv(T,p,s),c(h)),!1)}const l=[],u=Object.assign(FF,{defaultVisitor:d,convertValue:c,isVisitable:y_});if(!j.isObject(t))throw new TypeError("data must be an object");return function h(p,T){if(!j.isUndefined(p)){if(l.indexOf(p)!==-1)throw Error("Circular reference detected in "+T.join("."));l.push(p),j.forEach(p,function(m,f){(!(j.isUndefined(m)||m===null)&&r.call(e,m,j.isString(f)?Xe(f).call(f):f,T,u))===!0&&h(m,T?T.concat(f):[f])}),l.pop()}}(t),e}function Iv(t){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(i){return e[i]})}function A_(t,e){this._pairs=[],t&&_l(t,this,e)}const yv=A_.prototype;function BF(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Av(t,e,i){if(!e)return t;const n=i&&i.encode||BF;j.isFunction(i)&&(i={serialize:i});const r=i&&i.serialize;let s;if(s=r?r(e,i):j.isURLSearchParams(e)?e.toString():new A_(e,i).toString(n),s){const o=t.indexOf("#");o!==-1&&(t=t.slice(0,o)),t+=(t.indexOf("?")===-1?"?":"&")+s}return t}yv.append=function(t,e){this._pairs.push([t,e])},yv.toString=function(t){const e=t?function(i){return t.call(this,i,Iv)}:Iv;return this._pairs.map(function(i){return e(i[0])+"="+e(i[1])},"").join("&")};var bv=class{constructor(){this.handlers=[]}use(t,e,i){return this.handlers.push({fulfilled:t,rejected:e,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1}eject(t){this.handlers[t]&&(this.handlers[t]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(t){j.forEach(this.handlers,function(e){e!==null&&t(e)})}},wv={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},Ov={exports:{}},jF=bt,GF=mi,Nv=cn.f;jF({target:"Object",stat:!0,forced:Object.defineProperty!==Nv,sham:!GF},{defineProperty:Nv});var Dv=zi.Object,WF=Ov.exports=function(t,e,i){return Dv.defineProperty(t,e,i)};Dv.defineProperty.sham&&(WF.sham=!0);var Pv=Bt(Ov.exports),HF=TypeError,Lv=Ma,KF=kd,YF=fi,qF=me("species"),kv=Array,zF=function(t){var e;return Lv(t)&&(e=t.constructor,(KF(e)&&(e===kv||Lv(e.prototype))||YF(e)&&(e=e[qF])===null)&&(e=void 0)),e===void 0?kv:e},Mv=function(t,e){return new(zF(t))(e===0?0:e)},JF=$t,XF=fs,QF=me("species"),Uv=function(t){return XF>=51||!JF(function(){var e=[];return(e.constructor={})[QF]=function(){return{foo:1}},e[t](Boolean).foo!==1})},ZF=bt,$F=$t,tB=Ma,eB=fi,iB=qn,nB=Br,xv=function(t){if(t>9007199254740991)throw HF("Maximum allowed index exceeded");return t},Vv=Vp,rB=Mv,sB=Uv,oB=fs,Fv=me("isConcatSpreadable"),aB=oB>=51||!$F(function(){var t=[];return t[Fv]=!1,t.concat()[0]!==t}),cB=function(t){if(!eB(t))return!1;var e=t[Fv];return e!==void 0?!!e:tB(t)};ZF({target:"Array",proto:!0,arity:1,forced:!aB||!sB("concat")},{concat:function(t){var e,i,n,r,s,o=iB(this),a=rB(o,0),c=0;for(e=-1,n=arguments.length;e<n;e++)if(cB(s=e===-1?o:arguments[e]))for(r=nB(s),xv(c+r),i=0;i<r;i++,c++)i in s&&Vv(a,c,s[i]);else xv(c+1),Vv(a,c++,s);return a.length=c,a}});var Bv={},dB=Yn,lB=Vr,jv=gd.f,uB=Gr,Gv=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];Bv.f=function(t){return Gv&&dB(t)==="Window"?function(e){try{return jv(e)}catch{return uB(Gv)}}(t):jv(lB(t))};var Lo={},hB=me;Lo.f=hB;var Wv=zi,pB=He,_B=Lo,EB=cn.f,Pe=function(t){var e=Wv.Symbol||(Wv.Symbol={});pB(e,t)||EB(e,t,{value:_B.f(t)})},mB=We,fB=di,gB=me,TB=jr,Hv=function(){var t=fB("Symbol"),e=t&&t.prototype,i=e&&e.valueOf,n=gB("toPrimitive");e&&!e[n]&&TB(e,n,function(r){return mB(i,this)},{arity:1})},SB=Fr,RB=ld,vB=qn,CB=Br,IB=Mv,Kv=le([].push),zr=function(t){var e=t===1,i=t===2,n=t===3,r=t===4,s=t===6,o=t===7,a=t===5||s;return function(c,d,l,u){for(var h,p,T=vB(c),m=RB(T),f=CB(m),R=SB(d,l),v=0,A=u||IB,O=e?A(c,f):i||o?A(c,0):void 0;f>v;v++)if((a||v in m)&&(p=R(h=m[v],v,T),t))if(e)O[v]=p;else if(p)switch(t){case 3:return!0;case 5:return h;case 6:return v;case 2:Kv(O,h)}else switch(t){case 4:return!1;case 7:Kv(O,h)}return s?-1:n||r?r:O}},Yv={forEach:zr(0),map:zr(1),filter:zr(2),some:zr(3),every:zr(4),find:zr(5),findIndex:zr(6),filterReject:zr(7)},El=bt,nc=re,b_=We,yB=le,ko=mi,Mo=ao,AB=$t,ii=He,bB=ei,w_=bi,ml=Vr,O_=ph,wB=ki,N_=xr,Uo=xa,qv=Sd,OB=gd,zv=Bv,NB=Ua,Jv=od,Xv=cn,DB=Lh,Qv=cd,Zv=jr,PB=Ld,D_=lo,$v=Td,tC=uh,LB=me,kB=Lo,MB=Pe,UB=Hv,xB=fr,eC=Rs,fl=Yv.forEach,Ui=fd("hidden"),gl="Symbol",rc="prototype",VB=eC.set,iC=eC.getterFor(gl),Ln=Object[rc],Os=nc.Symbol,Tl=Os&&Os[rc],FB=nc.RangeError,BB=nc.TypeError,P_=nc.QObject,nC=Jv.f,Ns=Xv.f,rC=zv.f,jB=Qv.f,sC=yB([].push),Sr=D_("symbols"),sc=D_("op-symbols"),GB=D_("wks"),L_=!P_||!P_[rc]||!P_[rc].findChild,oC=function(t,e,i){var n=nC(Ln,e);n&&delete Ln[e],Ns(t,e,i),n&&t!==Ln&&Ns(Ln,e,n)},k_=ko&&AB(function(){return Uo(Ns({},"a",{get:function(){return Ns(this,"a",{value:7}).a}})).a!==7})?oC:Ns,M_=function(t,e){var i=Sr[t]=Uo(Tl);return VB(i,{type:gl,tag:t,description:e}),ko||(i.description=e),i},Sl=function(t,e,i){t===Ln&&Sl(sc,e,i),w_(t);var n=O_(e);return w_(i),ii(Sr,n)?(i.enumerable?(ii(t,Ui)&&t[Ui][n]&&(t[Ui][n]=!1),i=Uo(i,{enumerable:N_(0,!1)})):(ii(t,Ui)||Ns(t,Ui,N_(1,Uo(null))),t[Ui][n]=!0),k_(t,n,i)):Ns(t,n,i)},U_=function(t,e){w_(t);var i=ml(e),n=qv(i).concat(lC(i));return fl(n,function(r){ko&&!b_(aC,i,r)||Sl(t,r,i[r])}),t},aC=function(t){var e=O_(t),i=b_(jB,this,e);return!(this===Ln&&ii(Sr,e)&&!ii(sc,e))&&(!(i||!ii(this,e)||!ii(Sr,e)||ii(this,Ui)&&this[Ui][e])||i)},cC=function(t,e){var i=ml(t),n=O_(e);if(i!==Ln||!ii(Sr,n)||ii(sc,n)){var r=nC(i,n);return!r||!ii(Sr,n)||ii(i,Ui)&&i[Ui][n]||(r.enumerable=!0),r}},dC=function(t){var e=rC(ml(t)),i=[];return fl(e,function(n){ii(Sr,n)||ii($v,n)||sC(i,n)}),i},lC=function(t){var e=t===Ln,i=rC(e?sc:ml(t)),n=[];return fl(i,function(r){!ii(Sr,r)||e&&!ii(Ln,r)||sC(n,Sr[r])}),n};Mo||(Os=function(){if(bB(Tl,this))throw new BB("Symbol is not a constructor");var t=arguments.length&&arguments[0]!==void 0?wB(arguments[0]):void 0,e=tC(t),i=function(n){var r=this===void 0?nc:this;r===Ln&&b_(i,sc,n),ii(r,Ui)&&ii(r[Ui],e)&&(r[Ui][e]=!1);var s=N_(1,n);try{k_(r,e,s)}catch(o){if(!(o instanceof FB))throw o;oC(r,e,s)}};return ko&&L_&&k_(Ln,e,{configurable:!0,set:i}),M_(e,t)},Zv(Tl=Os[rc],"toString",function(){return iC(this).tag}),Zv(Os,"withoutSetter",function(t){return M_(tC(t),t)}),Qv.f=aC,Xv.f=Sl,DB.f=U_,Jv.f=cC,OB.f=zv.f=dC,NB.f=lC,kB.f=function(t){return M_(LB(t),t)},ko&&PB(Tl,"description",{configurable:!0,get:function(){return iC(this).description}})),El({global:!0,constructor:!0,wrap:!0,forced:!Mo,sham:!Mo},{Symbol:Os}),fl(qv(GB),function(t){MB(t)}),El({target:gl,stat:!0,forced:!Mo},{useSetter:function(){L_=!0},useSimple:function(){L_=!1}}),El({target:"Object",stat:!0,forced:!Mo,sham:!ko},{create:function(t,e){return e===void 0?Uo(t):U_(Uo(t),e)},defineProperty:Sl,defineProperties:U_,getOwnPropertyDescriptor:cC}),El({target:"Object",stat:!0,forced:!Mo},{getOwnPropertyNames:dC}),UB(),xB(Os,gl),$v[Ui]=!0;var uC=ao&&!!Symbol.for&&!!Symbol.keyFor,WB=bt,HB=di,KB=He,YB=ki,hC=lo,qB=uC,x_=hC("string-to-symbol-registry"),zB=hC("symbol-to-string-registry");WB({target:"Symbol",stat:!0,forced:!qB},{for:function(t){var e=YB(t);if(KB(x_,e))return x_[e];var i=HB("Symbol")(e);return x_[e]=i,zB[i]=e,i}});var JB=bt,XB=He,QB=Da,ZB=co,$B=uC,pC=lo("symbol-to-string-registry");JB({target:"Symbol",stat:!0,forced:!$B},{keyFor:function(t){if(!QB(t))throw new TypeError(ZB(t)+" is not a symbol");if(XB(pC,t))return pC[t]}});var _C=Ma,tj=xe,EC=Yn,ej=ki,mC=le([].push),ij=bt,fC=di,gC=Oa,nj=We,oc=le,TC=$t,SC=xe,RC=Da,vC=Gr,rj=function(t){if(tj(t))return t;if(_C(t)){for(var e=t.length,i=[],n=0;n<e;n++){var r=t[n];typeof r=="string"?mC(i,r):typeof r!="number"&&EC(r)!=="Number"&&EC(r)!=="String"||mC(i,ej(r))}var s=i.length,o=!0;return function(a,c){if(o)return o=!1,c;if(_C(this))return c;for(var d=0;d<s;d++)if(i[d]===a)return c}}},sj=ao,oj=String,Jr=fC("JSON","stringify"),Rl=oc(/./.exec),CC=oc("".charAt),aj=oc("".charCodeAt),cj=oc("".replace),dj=oc(1 .toString),lj=/[\uD800-\uDFFF]/g,IC=/^[\uD800-\uDBFF]$/,yC=/^[\uDC00-\uDFFF]$/,AC=!sj||TC(function(){var t=fC("Symbol")("stringify detection");return Jr([t])!=="[null]"||Jr({a:t})!=="{}"||Jr(Object(t))!=="{}"}),bC=TC(function(){return Jr("\uDF06\uD834")!=='"\\udf06\\ud834"'||Jr("\uDEAD")!=='"\\udead"'}),uj=function(t,e){var i=vC(arguments),n=rj(e);if(SC(n)||t!==void 0&&!RC(t))return i[1]=function(r,s){if(SC(n)&&(s=nj(n,this,oj(r),s)),!RC(s))return s},gC(Jr,null,i)},hj=function(t,e,i){var n=CC(i,e-1),r=CC(i,e+1);return Rl(IC,t)&&!Rl(yC,r)||Rl(yC,t)&&!Rl(IC,n)?"\\u"+dj(aj(t,0),16):t};Jr&&ij({target:"JSON",stat:!0,arity:3,forced:AC||bC},{stringify:function(t,e,i){var n=vC(arguments),r=gC(AC?uj:Jr,null,n);return bC&&typeof r=="string"?cj(r,lj,hj):r}});var wC=Ua,pj=qn;bt({target:"Object",stat:!0,forced:!ao||$t(function(){wC.f(1)})},{getOwnPropertySymbols:function(t){var e=wC.f;return e?e(pj(t)):[]}}),Pe("asyncIterator"),Pe("hasInstance"),Pe("isConcatSpreadable"),Pe("iterator"),Pe("match"),Pe("matchAll"),Pe("replace"),Pe("search"),Pe("species"),Pe("split");var _j=Hv;Pe("toPrimitive"),_j();var Ej=di,mj=fr;Pe("toStringTag"),mj(Ej("Symbol"),"Symbol"),Pe("unscopables"),fr(re.JSON,"JSON",!0);var fj=zi.Symbol,gj=me,Tj=cn.f,OC=gj("metadata"),NC=Function.prototype;NC[OC]===void 0&&Tj(NC,OC,{value:null}),Pe("asyncDispose"),Pe("dispose"),Pe("metadata");var Sj=fj,Rj=le,V_=di("Symbol"),vj=V_.keyFor,Cj=Rj(V_.prototype.valueOf),DC=V_.isRegisteredSymbol||function(t){try{return vj(Cj(t))!==void 0}catch{return!1}};bt({target:"Symbol",stat:!0},{isRegisteredSymbol:DC});for(var Ij=lo,PC=di,yj=le,Aj=Da,bj=me,vl=PC("Symbol"),LC=vl.isWellKnownSymbol,kC=PC("Object","getOwnPropertyNames"),wj=yj(vl.prototype.valueOf),MC=Ij("wks"),F_=0,UC=kC(vl),Oj=UC.length;F_<Oj;F_++)try{var xC=UC[F_];Aj(vl[xC])&&bj(xC)}catch{}var VC=function(t){if(LC&&LC(t))return!0;try{for(var e=wj(t),i=0,n=kC(MC),r=n.length;i<r;i++)if(MC[n[i]]==e)return!0}catch{}return!1};bt({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:VC}),Pe("customMatcher"),Pe("observable"),bt({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:DC}),bt({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:VC}),Pe("matcher"),Pe("metadataKey"),Pe("patternMatch"),Pe("replaceAll");var xo=Bt(Sj),FC=Bt(Lo.f("iterator"));function ac(t){return ac=typeof xo=="function"&&typeof FC=="symbol"?function(e){return typeof e}:function(e){return e&&typeof xo=="function"&&e.constructor===xo&&e!==xo.prototype?"symbol":typeof e},ac(t)}var Nj=Bt(Lo.f("toPrimitive"));function Dj(t){var e=function(i,n){if(ac(i)!=="object"||i===null)return i;var r=i[Nj];if(r!==void 0){var s=r.call(i,n||"default");if(ac(s)!=="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(n==="string"?String:Number)(i)}(t,"string");return ac(e)==="symbol"?e:String(e)}function g(t,e,i){return(e=Dj(e))in t?Pv(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var BC=Bt(ox),Pj={isBrowser:!0,classes:{URLSearchParams:BC!==void 0?BC:A_,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};const B_=typeof window<"u"&&typeof document<"u",j_=typeof navigator=="object"&&navigator||void 0,Lj=B_&&(!j_||["ReactNative","NativeScript","NS"].indexOf(j_.product)<0),kj=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",Mj=B_&&window.location.href||"http://localhost";function jC(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function GC(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?jC(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):jC(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}var gi=GC(GC({},Object.freeze({__proto__:null,hasBrowserEnv:B_,hasStandardBrowserEnv:Lj,hasStandardBrowserWebWorkerEnv:kj,navigator:j_,origin:Mj})),Pj),Uj=bi,xj=We,Vj=He,Fj=ei,Bj=function(){var t=Uj(this),e="";return t.hasIndices&&(e+="d"),t.global&&(e+="g"),t.ignoreCase&&(e+="i"),t.multiline&&(e+="m"),t.dotAll&&(e+="s"),t.unicode&&(e+="u"),t.unicodeSets&&(e+="v"),t.sticky&&(e+="y"),e},WC=RegExp.prototype,HC=function(t){var e=t.flags;return e!==void 0||"flags"in WC||Vj(t,"flags")||!Fj(WC,t)?e:xj(Bj,t)},jj=Ap.charAt,KC=We,Gj=bi,Wj=xe,Hj=Yn,Kj=/./.exec,Yj=TypeError,qj=bt,YC=We,qC=Na,zj=qh,Cl=Dd,zC=ms,JC=Yf,cc=ki,Jj=bi,Xj=oo,Qj=Yn,Zj=zf,XC=HC,$j=ud,tG=$t,eG=$h,iG=function(t,e,i){return e+(i?jj(t,e).length:1)},nG=function(t,e){var i=t.exec;if(Wj(i)){var n=KC(i,t,e);return n!==null&&Gj(n),n}if(Hj(t)==="RegExp")return KC(Kj,t,e);throw new Yj("RegExp#exec called on incompatible receiver")},QC=Rs,rG=me("matchAll"),ZC="RegExp String",$C=ZC+" Iterator",sG=QC.set,oG=QC.getterFor($C),aG=TypeError,G_=qC("".indexOf),Il=qC("".matchAll),W_=!!Il&&!tG(function(){Il("a",/./)}),cG=zj(function(t,e,i,n){sG(this,{type:$C,regexp:t,string:e,global:i,unicode:n,done:!1})},ZC,function(){var t=oG(this);if(t.done)return Cl(void 0,!0);var e=t.regexp,i=t.string,n=nG(e,i);return n===null?(t.done=!0,Cl(void 0,!0)):t.global?(cc(n[0])===""&&(e.lastIndex=iG(i,JC(e.lastIndex),t.unicode)),Cl(n,!1)):(t.done=!0,Cl(n,!1))}),tI=function(t){var e,i,n,r=Jj(this),s=cc(t),o=eG(r,RegExp),a=cc(XC(r));return e=new o(o===RegExp?r.source:r,a),i=!!~G_(a,"g"),n=!!~G_(a,"u"),e.lastIndex=JC(r.lastIndex),new cG(e,s,i,n)};qj({target:"String",proto:!0,forced:W_},{matchAll:function(t){var e,i,n,r,s=zC(this);if(Xj(t)){if(W_)return Il(s,t)}else{if(Zj(t)&&(e=cc(zC(XC(t))),!~G_(e,"g")))throw new aG("`.matchAll` does not allow non-global regexes");if(W_)return Il(s,t);if((n=$j(t,rG))===void 0&&Qj(t)==="RegExp"&&(n=tI),n)return YC(n,t,s)}return i=cc(s),r=new RegExp(t,"g"),YC(tI,r,i)}});var dG=dn("String","matchAll"),lG=ei,uG=dG,H_=String.prototype,hG=function(t){var e=t.matchAll;return typeof t=="string"||t===H_||lG(H_,t)&&e===H_.matchAll?uG:e},pG=Bt(hG);function eI(t){function e(i,n,r,s){let o=i[s++];if(o==="__proto__")return!0;const a=Number.isFinite(+o),c=s>=i.length;return o=!o&&j.isArray(r)?r.length:o,c?(j.hasOwnProp(r,o)?r[o]=[r[o],n]:r[o]=n,!a):(r[o]&&j.isObject(r[o])||(r[o]=[]),e(i,n,r[o],s)&&j.isArray(r[o])&&(r[o]=function(d){const l={},u=Object.keys(d);let h;const p=u.length;let T;for(h=0;h<p;h++)T=u[h],l[T]=d[T];return l}(r[o])),!a)}if(j.isFormData(t)&&j.isFunction(t.entries)){const i={};return j.forEachEntry(t,(n,r)=>{e(function(s){return pG(j).call(j,/\w+|\[(\w*)]/g,s).map(o=>o[0]==="[]"?"":o[1]||o[0])}(n),r,i,0)}),i}return null}const K_={transitional:wv,adapter:["xhr","http","fetch"],transformRequest:[function(t,e){const i=e.getContentType()||"",n=i.indexOf("application/json")>-1,r=j.isObject(t);if(r&&j.isHTMLForm(t)&&(t=new FormData(t)),j.isFormData(t))return n?JSON.stringify(eI(t)):t;if(j.isArrayBuffer(t)||j.isBuffer(t)||j.isStream(t)||j.isFile(t)||j.isBlob(t)||j.isReadableStream(t))return t;if(j.isArrayBufferView(t))return t.buffer;if(j.isURLSearchParams(t))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let s;if(r){if(i.indexOf("application/x-www-form-urlencoded")>-1)return function(o,a){return _l(o,new gi.classes.URLSearchParams,Object.assign({visitor:function(c,d,l,u){return gi.isNode&&j.isBuffer(c)?(this.append(d,c.toString("base64")),!1):u.defaultVisitor.apply(this,arguments)}},a))}(t,this.formSerializer).toString();if((s=j.isFileList(t))||i.indexOf("multipart/form-data")>-1){const o=this.env&&this.env.FormData;return _l(s?{"files[]":t}:t,o&&new o,this.formSerializer)}}return r||n?(e.setContentType("application/json",!1),function(o,a,c){if(j.isString(o))try{return(a||JSON.parse)(o),Xe(j).call(j,o)}catch(d){if(d.name!=="SyntaxError")throw d}return(0,JSON.stringify)(o)}(t)):t}],transformResponse:[function(t){const e=this.transitional||K_.transitional,i=e&&e.forcedJSONParsing,n=this.responseType==="json";if(j.isResponse(t)||j.isReadableStream(t))return t;if(t&&j.isString(t)&&(i&&!this.responseType||n)){const r=!(e&&e.silentJSONParsing)&&n;try{return JSON.parse(t)}catch(s){if(r)throw s.name==="SyntaxError"?Dt.from(s,Dt.ERR_BAD_RESPONSE,this,null,this.response):s}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:gi.classes.FormData,Blob:gi.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};j.forEach(["delete","get","head","post","put","patch"],t=>{K_.headers[t]={}});var Y_=K_;const _G=j.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),iI=Symbol("internals");function dc(t){var e;return t&&Xe(e=String(t)).call(e).toLowerCase()}function yl(t){return t===!1||t==null?t:j.isArray(t)?t.map(yl):String(t)}function q_(t,e,i,n,r){return j.isFunction(n)?n.call(this,e,i):(r&&(e=i),j.isString(e)?j.isString(n)?e.indexOf(n)!==-1:j.isRegExp(n)?n.test(e):void 0:void 0)}class Al{constructor(e){e&&this.set(e)}set(e,i,n){const r=this;function s(c,d,l){const u=dc(d);if(!u)throw new Error("header name must be a non-empty string");const h=j.findKey(r,u);(!h||r[h]===void 0||l===!0||l===void 0&&r[h]!==!1)&&(r[h||d]=yl(c))}const o=(c,d)=>j.forEach(c,(l,u)=>s(l,u,d));if(j.isPlainObject(e)||e instanceof this.constructor)o(e,i);else if(j.isString(e)&&(e=Xe(e).call(e))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(Xe(a=e).call(a)))o((c=>{const d={};let l,u,h;return c&&c.split(`
`).forEach(function(p){var T,m;h=p.indexOf(":"),l=Xe(T=p.substring(0,h)).call(T).toLowerCase(),u=Xe(m=p.substring(h+1)).call(m),!l||d[l]&&_G[l]||(l==="set-cookie"?d[l]?d[l].push(u):d[l]=[u]:d[l]=d[l]?d[l]+", "+u:u)}),d})(e),i);else if(j.isHeaders(e))for(const[c,d]of e.entries())s(d,c,n);else e!=null&&s(i,e,n);var a;return this}get(e,i){if(e=dc(e)){const n=j.findKey(this,e);if(n){const r=this[n];if(!i)return r;if(i===!0)return function(s){const o=Object.create(null),a=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let c;for(;c=a.exec(s);)o[c[1]]=c[2];return o}(r);if(j.isFunction(i))return i.call(this,r,n);if(j.isRegExp(i))return i.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,i){if(e=dc(e)){const n=j.findKey(this,e);return!(!n||this[n]===void 0||i&&!q_(0,this[n],n,i))}return!1}delete(e,i){const n=this;let r=!1;function s(o){if(o=dc(o)){const a=j.findKey(n,o);!a||i&&!q_(0,n[a],a,i)||(delete n[a],r=!0)}}return j.isArray(e)?e.forEach(s):s(e),r}clear(e){const i=Object.keys(this);let n=i.length,r=!1;for(;n--;){const s=i[n];e&&!q_(0,this[s],s,e,!0)||(delete this[s],r=!0)}return r}normalize(e){const i=this,n={};return j.forEach(this,(r,s)=>{var o;const a=j.findKey(n,s);if(a)return i[a]=yl(r),void delete i[s];const c=e?function(d){return Xe(d).call(d).toLowerCase().replace(/([a-z\d])(\w*)/g,(l,u,h)=>u.toUpperCase()+h)}(s):Xe(o=String(s)).call(o);c!==s&&delete i[s],i[c]=yl(r),n[c]=!0}),this}concat(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.constructor.concat(this,...i)}toJSON(e){const i=Object.create(null);return j.forEach(this,(n,r)=>{n!=null&&n!==!1&&(i[r]=e&&j.isArray(n)?n.join(", "):n)}),i}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(e=>{let[i,n]=e;return i+": "+n}).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e){const i=new this(e);for(var n=arguments.length,r=new Array(n>1?n-1:0),s=1;s<n;s++)r[s-1]=arguments[s];return r.forEach(o=>i.set(o)),i}static accessor(e){const i=(this[iI]=this[iI]={accessors:{}}).accessors,n=this.prototype;function r(s){const o=dc(s);i[o]||(function(a,c){const d=j.toCamelCase(" "+c);["get","set","has"].forEach(l=>{Object.defineProperty(a,l+d,{value:function(u,h,p){return this[l].call(this,c,u,h,p)},configurable:!0})})}(n,s),i[o]=!0)}return j.isArray(e)?e.forEach(r):r(e),this}}Al.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),j.reduceDescriptors(Al.prototype,(t,e)=>{let{value:i}=t,n=e[0].toUpperCase()+e.slice(1);return{get:()=>i,set(r){this[n]=r}}}),j.freezeMethods(Al);var kn=Al;function z_(t,e){const i=this||Y_,n=e||i,r=kn.from(n.headers);let s=n.data;return j.forEach(t,function(o){s=o.call(i,s,r.normalize(),e?e.status:void 0)}),r.normalize(),s}function nI(t){return!(!t||!t.__CANCEL__)}function Vo(t,e,i){Dt.call(this,t??"canceled",Dt.ERR_CANCELED,e,i),this.name="CanceledError"}function rI(t,e,i){const n=i.config.validateStatus;i.status&&n&&!n(i.status)?e(new Dt("Request failed with status code "+i.status,[Dt.ERR_BAD_REQUEST,Dt.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):t(i)}j.inherits(Vo,Dt,{__CANCEL__:!0});const bl=function(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:3,n=0;const r=function(s,o){s=s||10;const a=new Array(s),c=new Array(s);let d,l=0,u=0;return o=o!==void 0?o:1e3,function(h){const p=Date.now(),T=c[u];d||(d=p),a[l]=h,c[l]=p;let m=u,f=0;for(;m!==l;)f+=a[m++],m%=s;if(l=(l+1)%s,l===u&&(u=(u+1)%s),p-d<o)return;const R=T&&p-T;return R?Math.round(1e3*f/R):void 0}}(50,250);return function(s,o){let a,c,d=0,l=1e3/o;const u=function(h){d=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Date.now(),a=null,c&&(clearTimeout(c),c=null),s.apply(null,h)};return[function(){const h=Date.now(),p=h-d;for(var T=arguments.length,m=new Array(T),f=0;f<T;f++)m[f]=arguments[f];p>=l?u(m,h):(a=m,c||(c=setTimeout(()=>{c=null,u(a)},l-p)))},()=>a&&u(a)]}(s=>{const o=s.loaded,a=s.lengthComputable?s.total:void 0,c=o-n,d=r(c);n=o,t({loaded:o,total:a,progress:a?o/a:void 0,bytes:c,rate:d||void 0,estimated:d&&a&&o<=a?(a-o)/d:void 0,event:s,lengthComputable:a!=null,[e?"download":"upload"]:!0})},i)},sI=(t,e)=>{const i=t!=null;return[n=>e[0]({lengthComputable:i,total:t,loaded:n}),e[1]]},oI=t=>function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return j.asap(()=>t(...i))};var EG=gi.hasStandardBrowserEnv?((t,e)=>i=>(i=new il(i,gi.origin),t.protocol===i.protocol&&t.host===i.host&&(e||t.port===i.port)))(new il(gi.origin),gi.navigator&&/(msie|trident)/i.test(gi.navigator.userAgent)):()=>!0,mG=gi.hasStandardBrowserEnv?{write(t,e,i,n,r,s){const o=[t+"="+encodeURIComponent(e)];j.isNumber(i)&&o.push("expires="+new Date(i).toGMTString()),j.isString(n)&&o.push("path="+n),j.isString(r)&&o.push("domain="+r),s===!0&&o.push("secure"),document.cookie=o.join("; ")},read(t){const e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function aI(t,e){return t&&!function(i){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(i)}(e)?function(i,n){return n?i.replace(/\/?\/$/,"")+"/"+n.replace(/^\/+/,""):i}(t,e):e}function cI(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}const dI=t=>t instanceof kn?function(e){for(var i=1;i<arguments.length;i++){var n=arguments[i]!=null?arguments[i]:{};i%2?cI(Object(n),!0).forEach(function(r){g(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cI(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}({},t):t;function Ds(t,e){e=e||{};const i={};function n(d,l,u,h){return j.isPlainObject(d)&&j.isPlainObject(l)?j.merge.call({caseless:h},d,l):j.isPlainObject(l)?j.merge({},l):j.isArray(l)?l.slice():l}function r(d,l,u,h){return j.isUndefined(l)?j.isUndefined(d)?void 0:n(void 0,d,0,h):n(d,l,0,h)}function s(d,l){if(!j.isUndefined(l))return n(void 0,l)}function o(d,l){return j.isUndefined(l)?j.isUndefined(d)?void 0:n(void 0,d):n(void 0,l)}function a(d,l,u){return u in e?n(d,l):u in t?n(void 0,d):void 0}const c={url:s,method:s,data:s,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,withXSRFToken:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:a,headers:(d,l,u)=>r(dI(d),dI(l),0,!0)};return j.forEach(Object.keys(Object.assign({},t,e)),function(d){const l=c[d]||r,u=l(t[d],e[d],d);j.isUndefined(u)&&l!==a||(i[d]=u)}),i}var lI=t=>{const e=Ds({},t);let i,{data:n,withXSRFToken:r,xsrfHeaderName:s,xsrfCookieName:o,headers:a,auth:c}=e;if(e.headers=a=kn.from(a),e.url=Av(aI(e.baseURL,e.url),t.params,t.paramsSerializer),c&&a.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):""))),j.isFormData(n)){if(gi.hasStandardBrowserEnv||gi.hasStandardBrowserWebWorkerEnv)a.setContentType(void 0);else if((i=a.getContentType())!==!1){const[d,...l]=i?i.split(";").map(u=>Xe(u).call(u)).filter(Boolean):[];a.setContentType([d||"multipart/form-data",...l].join("; "))}}if(gi.hasStandardBrowserEnv&&(r&&j.isFunction(r)&&(r=r(e)),r||r!==!1&&EG(e.url))){const d=s&&o&&mG.read(o);d&&a.set(s,d)}return e},fG=typeof XMLHttpRequest<"u"&&function(t){return new G(function(e,i){const n=lI(t);let r=n.data;const s=kn.from(n.headers).normalize();let o,a,c,d,l,{responseType:u,onUploadProgress:h,onDownloadProgress:p}=n;function T(){d&&d(),l&&l(),n.cancelToken&&n.cancelToken.unsubscribe(o),n.signal&&n.signal.removeEventListener("abort",o)}let m=new XMLHttpRequest;function f(){if(!m)return;const v=kn.from("getAllResponseHeaders"in m&&m.getAllResponseHeaders());rI(function(A){e(A),T()},function(A){i(A),T()},{data:u&&u!=="text"&&u!=="json"?m.response:m.responseText,status:m.status,statusText:m.statusText,headers:v,config:t,request:m}),m=null}m.open(n.method.toUpperCase(),n.url,!0),m.timeout=n.timeout,"onloadend"in m?m.onloadend=f:m.onreadystatechange=function(){m&&m.readyState===4&&(m.status!==0||m.responseURL&&m.responseURL.indexOf("file:")===0)&&setTimeout(f)},m.onabort=function(){m&&(i(new Dt("Request aborted",Dt.ECONNABORTED,t,m)),m=null)},m.onerror=function(){i(new Dt("Network Error",Dt.ERR_NETWORK,t,m)),m=null},m.ontimeout=function(){let v=n.timeout?"timeout of "+n.timeout+"ms exceeded":"timeout exceeded";const A=n.transitional||wv;n.timeoutErrorMessage&&(v=n.timeoutErrorMessage),i(new Dt(v,A.clarifyTimeoutError?Dt.ETIMEDOUT:Dt.ECONNABORTED,t,m)),m=null},r===void 0&&s.setContentType(null),"setRequestHeader"in m&&j.forEach(s.toJSON(),function(v,A){m.setRequestHeader(A,v)}),j.isUndefined(n.withCredentials)||(m.withCredentials=!!n.withCredentials),u&&u!=="json"&&(m.responseType=n.responseType),p&&([c,l]=bl(p,!0),m.addEventListener("progress",c)),h&&m.upload&&([a,d]=bl(h),m.upload.addEventListener("progress",a),m.upload.addEventListener("loadend",d)),(n.cancelToken||n.signal)&&(o=v=>{m&&(i(!v||v.type?new Vo(null,t,m):v),m.abort(),m=null)},n.cancelToken&&n.cancelToken.subscribe(o),n.signal&&(n.signal.aborted?o():n.signal.addEventListener("abort",o)));const R=function(v){const A=/^([-+\w]{1,25})(:?\/\/|:)/.exec(v);return A&&A[1]||""}(n.url);R&&gi.protocols.indexOf(R)===-1?i(new Dt("Unsupported protocol "+R+":",Dt.ERR_BAD_REQUEST,t)):m.send(r||null)})},gG=(t,e)=>{const{length:i}=t=t?t.filter(Boolean):[];if(e||i){let n,r=new AbortController;const s=function(d){if(!n){n=!0,a();const l=d instanceof Error?d:this.reason;r.abort(l instanceof Dt?l:new Vo(l instanceof Error?l.message:l))}};let o=e&&setTimeout(()=>{o=null,s(new Dt("timeout ".concat(e," of ms exceeded"),Dt.ETIMEDOUT))},e);const a=()=>{t&&(o&&clearTimeout(o),o=null,t.forEach(d=>{d.unsubscribe?d.unsubscribe(s):d.removeEventListener("abort",s)}),t=null)};t.forEach(d=>d.addEventListener("abort",s));const{signal:c}=r;return c.unsubscribe=()=>j.asap(a),c}},J_=Bt(XT),uI=Lo.f("asyncIterator"),TG=Bt(uI);function X_(t,e){this.v=t,this.k=e}function lc(t){var e,i;function n(s,o){try{var a=t[s](o),c=a.value,d=c instanceof X_;J_.resolve(d?c.v:c).then(function(l){if(d){var u=s==="return"?"return":"next";if(!c.k||l.done)return n(u,l);l=t[u](l).value}r(a.done?"return":"normal",l)},function(l){n("throw",l)})}catch(l){r("throw",l)}}function r(s,o){switch(s){case"return":e.resolve({value:o,done:!0});break;case"throw":e.reject(o);break;default:e.resolve({value:o,done:!1})}(e=e.next)?n(e.key,e.arg):i=null}this._invoke=function(s,o){return new J_(function(a,c){var d={key:s,arg:o,resolve:a,reject:c,next:null};i?i=i.next=d:(e=i=d,n(s,o))})},typeof t.return!="function"&&(this.return=void 0)}function Qi(t){return function(){return new lc(t.apply(this,arguments))}}function mt(t){return new X_(t,0)}function wl(t){var e={},i=!1;function n(r,s){return i=!0,{done:!1,value:new X_(s=new J_(function(o){o(t[r](s))}),1)}}return e[xo!==void 0&&FC||"@@iterator"]=function(){return this},e.next=function(r){return i?(i=!1,r):n("next",r)},typeof t.throw=="function"&&(e.throw=function(r){if(i)throw i=!1,r;return n("throw",r)}),typeof t.return=="function"&&(e.return=function(r){return i?(i=!1,r):n("return",r)}),e}lc.prototype[typeof xo=="function"&&TG||"@@asyncIterator"]=function(){return this},lc.prototype.next=function(t){return this._invoke("next",t)},lc.prototype.throw=function(t){return this._invoke("throw",t)},lc.prototype.return=function(t){return this._invoke("return",t)};var Q_=Bt(uI);function Z_(t){var e,i,n,r=2;for(typeof Symbol<"u"&&(i=Q_,n=Symbol.iterator);r--;){if(i&&(e=t[i])!=null)return e.call(t);if(n&&(e=t[n])!=null)return new Ol(e.call(t));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function Ol(t){function e(i){if(Object(i)!==i)return G.reject(new TypeError(i+" is not an object."));var n=i.done;return G.resolve(i.value).then(function(r){return{value:r,done:n}})}return Ol=function(i){this.s=i,this.n=i.next},Ol.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(i){var n=this.s.return;return n===void 0?G.resolve({value:i,done:!0}):e(n.apply(this.s,arguments))},throw:function(i){var n=this.s.return;return n===void 0?G.reject(i):e(n.apply(this.s,arguments))}},new Ol(t)}const SG=function*(t,e){let i=t.byteLength;if(!e||i<e)return void(yield t);let n,r=0;for(;r<i;)n=r+e,yield t.slice(r,n),r=n},RG=function(){var t=Qi(function*(e,i){var n,r=!1,s=!1;try{for(var o,a=Z_(vG(e));r=!(o=yield mt(a.next())).done;r=!1){const c=o.value;yield*wl(Z_(SG(c,i)))}}catch(c){s=!0,n=c}finally{try{r&&a.return!=null&&(yield mt(a.return()))}finally{if(s)throw n}}});return function(e,i){return t.apply(this,arguments)}}(),vG=function(){var t=Qi(function*(e){if(e[Q_])return void(yield*wl(Z_(e)));const i=e.getReader();try{for(;;){const{done:n,value:r}=yield mt(i.read());if(n)break;yield r}}finally{yield mt(i.cancel())}});return function(e){return t.apply(this,arguments)}}(),hI=(t,e,i,n)=>{const r=RG(t,e);let s,o=0,a=c=>{s||(s=!0,n&&n(c))};return new ReadableStream({async pull(c){try{const{done:d,value:l}=await r.next();if(d)return a(),void c.close();let u=l.byteLength;if(i){let h=o+=u;i(h)}c.enqueue(new Uint8Array(l))}catch(d){throw a(d),d}},cancel:c=>(a(c),r.return())},{highWaterMark:2})};function pI(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function _I(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?pI(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):pI(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}const Nl=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",EI=Nl&&typeof ReadableStream=="function",CG=Nl&&(typeof TextEncoder=="function"?(mI=new TextEncoder,t=>mI.encode(t)):async t=>new Uint8Array(await new Response(t).arrayBuffer()));var mI;const fI=function(t){try{for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return!!t(...i)}catch{return!1}},IG=EI&&fI(()=>{let t=!1;const e=new Request(gi.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!e}),$_=EI&&fI(()=>j.isReadableStream(new Response("").body)),Dl={stream:$_&&(t=>t.body)};var gI;Nl&&(gI=new Response,["text","arrayBuffer","blob","formData","stream"].forEach(t=>{!Dl[t]&&(Dl[t]=j.isFunction(gI[t])?e=>e[t]():(e,i)=>{throw new Dt("Response type '".concat(t,"' is not supported"),Dt.ERR_NOT_SUPPORT,i)})}));const yG=async(t,e)=>{const i=j.toFiniteNumber(t.getContentLength());return i??(async n=>n==null?0:j.isBlob(n)?n.size:j.isSpecCompliantForm(n)?(await new Request(gi.origin,{method:"POST",body:n}).arrayBuffer()).byteLength:j.isArrayBufferView(n)||j.isArrayBuffer(n)?n.byteLength:(j.isURLSearchParams(n)&&(n+=""),j.isString(n)?(await CG(n)).byteLength:void 0))(e)};var AG=Nl&&(async t=>{let{url:e,method:i,data:n,signal:r,cancelToken:s,timeout:o,onDownloadProgress:a,onUploadProgress:c,responseType:d,headers:l,withCredentials:u="same-origin",fetchOptions:h}=lI(t);d=d?(d+"").toLowerCase():"text";let p,T=gG([r,s&&s.toAbortSignal()],o);const m=T&&T.unsubscribe&&(()=>{T.unsubscribe()});let f;try{if(c&&IG&&i!=="get"&&i!=="head"&&(f=await yG(l,n))!==0){let w,b=new Request(e,{method:"POST",body:n,duplex:"half"});if(j.isFormData(n)&&(w=b.headers.get("content-type"))&&l.setContentType(w),b.body){const[L,x]=sI(f,bl(oI(c)));n=hI(b.body,65536,L,x)}}j.isString(u)||(u=u?"include":"omit");const R="credentials"in Request.prototype;p=new Request(e,_I(_I({},h),{},{signal:T,method:i.toUpperCase(),headers:l.normalize().toJSON(),body:n,duplex:"half",credentials:R?u:void 0}));let v=await fetch(p);const A=$_&&(d==="stream"||d==="response");if($_&&(a||A&&m)){const w={};["status","statusText","headers"].forEach(W=>{w[W]=v[W]});const b=j.toFiniteNumber(v.headers.get("content-length")),[L,x]=a&&sI(b,bl(oI(a),!0))||[];v=new Response(hI(v.body,65536,L,()=>{x&&x(),m&&m()}),w)}d=d||"text";let O=await Dl[j.findKey(Dl,d)||"text"](v,t);return!A&&m&&m(),await new G((w,b)=>{rI(w,b,{data:O,headers:kn.from(v.headers),status:v.status,statusText:v.statusText,config:t,request:p})})}catch(R){throw m&&m(),R&&R.name==="TypeError"&&/fetch/i.test(R.message)?Object.assign(new Dt("Network Error",Dt.ERR_NETWORK,t,p),{cause:R.cause||R}):Dt.from(R,R&&R.code,t,p)}});const TI={http:null,xhr:fG,fetch:AG};j.forEach(TI,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch{}Object.defineProperty(t,"adapterName",{value:e})}});const SI=t=>"- ".concat(t),bG=t=>j.isFunction(t)||t===null||t===!1;var RI=t=>{t=j.isArray(t)?t:[t];const{length:e}=t;let i,n;const r={};for(let s=0;s<e;s++){let o;if(i=t[s],n=i,!bG(i)&&(n=TI[(o=String(i)).toLowerCase()],n===void 0))throw new Dt("Unknown adapter '".concat(o,"'"));if(n)break;r[o||"#"+s]=n}if(!n){const s=Object.entries(r).map(o=>{let[a,c]=o;return"adapter ".concat(a," ")+(c===!1?"is not supported by the environment":"is not available in the build")});throw new Dt("There is no suitable adapter to dispatch the request "+(e?s.length>1?`since :
`+s.map(SI).join(`
`):" "+SI(s[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return n};function tE(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new Vo(null,t)}function vI(t){return tE(t),t.headers=kn.from(t.headers),t.data=z_.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),RI(t.adapter||Y_.adapter)(t).then(function(e){return tE(t),e.data=z_.call(t,t.transformResponse,e),e.headers=kn.from(e.headers),e},function(e){return nI(e)||(tE(t),e&&e.response&&(e.response.data=z_.call(t,t.transformResponse,e.response),e.response.headers=kn.from(e.response.headers))),G.reject(e)})}const wG="1.7.9",Pl={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{Pl[t]=function(i){return typeof i===t||"a"+(e<1?"n ":" ")+t}});const CI={};Pl.transitional=function(t,e,i){function n(r,s){return"[Axios v1.7.9] Transitional option '"+r+"'"+s+(i?". "+i:"")}return(r,s,o)=>{if(t===!1)throw new Dt(n(s," has been removed"+(e?" in "+e:"")),Dt.ERR_DEPRECATED);return e&&!CI[s]&&(CI[s]=!0,console.warn(n(s," has been deprecated since v"+e+" and will be removed in the near future"))),!t||t(r,s,o)}},Pl.spelling=function(t){return(e,i)=>(console.warn("".concat(i," is likely a misspelling of ").concat(t)),!0)};var Ll={assertOptions:function(t,e,i){if(typeof t!="object")throw new Dt("options must be an object",Dt.ERR_BAD_OPTION_VALUE);const n=Object.keys(t);let r=n.length;for(;r-- >0;){const s=n[r],o=e[s];if(o){const a=t[s],c=a===void 0||o(a,s,t);if(c!==!0)throw new Dt("option "+s+" must be "+c,Dt.ERR_BAD_OPTION_VALUE)}else if(i!==!0)throw new Dt("Unknown option "+s,Dt.ERR_BAD_OPTION)}},validators:Pl};const Qn=Ll.validators;let kl=class{constructor(t){this.defaults=t,this.interceptors={request:new bv,response:new bv}}async request(t,e){try{return await this._request(t,e)}catch(i){if(i instanceof Error){let n={};Error.captureStackTrace?Error.captureStackTrace(n):n=new Error;const r=n.stack?n.stack.replace(/^.+\n/,""):"";try{i.stack?r&&!String(i.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(i.stack+=`
`+r):i.stack=r}catch{}}throw i}}_request(t,e){typeof t=="string"?(e=e||{}).url=t:e=t||{},e=Ds(this.defaults,e);const{transitional:i,paramsSerializer:n,headers:r}=e;i!==void 0&&Ll.assertOptions(i,{silentJSONParsing:Qn.transitional(Qn.boolean),forcedJSONParsing:Qn.transitional(Qn.boolean),clarifyTimeoutError:Qn.transitional(Qn.boolean)},!1),n!=null&&(j.isFunction(n)?e.paramsSerializer={serialize:n}:Ll.assertOptions(n,{encode:Qn.function,serialize:Qn.function},!0)),Ll.assertOptions(e,{baseUrl:Qn.spelling("baseURL"),withXsrfToken:Qn.spelling("withXSRFToken")},!0),e.method=(e.method||this.defaults.method||"get").toLowerCase();let s=r&&j.merge(r.common,r[e.method]);r&&j.forEach(["delete","get","head","post","put","patch","common"],p=>{delete r[p]}),e.headers=kn.concat(s,r);const o=[];let a=!0;this.interceptors.request.forEach(function(p){typeof p.runWhen=="function"&&p.runWhen(e)===!1||(a=a&&p.synchronous,o.unshift(p.fulfilled,p.rejected))});const c=[];let d;this.interceptors.response.forEach(function(p){c.push(p.fulfilled,p.rejected)});let l,u=0;if(!a){const p=[vI.bind(this),void 0];for(p.unshift.apply(p,o),p.push.apply(p,c),l=p.length,d=G.resolve(e);u<l;)d=d.then(p[u++],p[u++]);return d}l=o.length;let h=e;for(u=0;u<l;){const p=o[u++],T=o[u++];try{h=p(h)}catch(m){T.call(this,m);break}}try{d=vI.call(this,h)}catch(p){return G.reject(p)}for(u=0,l=c.length;u<l;)d=d.then(c[u++],c[u++]);return d}getUri(t){return Av(aI((t=Ds(this.defaults,t)).baseURL,t.url),t.params,t.paramsSerializer)}};j.forEach(["delete","get","head","options"],function(t){kl.prototype[t]=function(e,i){return this.request(Ds(i||{},{method:t,url:e,data:(i||{}).data}))}}),j.forEach(["post","put","patch"],function(t){function e(i){return function(n,r,s){return this.request(Ds(s||{},{method:t,headers:i?{"Content-Type":"multipart/form-data"}:{},url:n,data:r}))}}kl.prototype[t]=e(),kl.prototype[t+"Form"]=e(!0)});var Ml=kl;class eE{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let i;this.promise=new G(function(r){i=r});const n=this;this.promise.then(r=>{if(!n._listeners)return;let s=n._listeners.length;for(;s-- >0;)n._listeners[s](r);n._listeners=null}),this.promise.then=r=>{let s;const o=new G(a=>{n.subscribe(a),s=a}).then(r);return o.cancel=function(){n.unsubscribe(s)},o},e(function(r,s,o){n.reason||(n.reason=new Vo(r,s,o),i(n.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const i=this._listeners.indexOf(e);i!==-1&&this._listeners.splice(i,1)}toAbortSignal(){const e=new AbortController,i=n=>{e.abort(n)};return this.subscribe(i),e.signal.unsubscribe=()=>this.unsubscribe(i),e.signal}static source(){let e;return{token:new eE(function(n){e=n}),cancel:e}}}var OG=eE;const iE={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(iE).forEach(t=>{let[e,i]=t;iE[i]=e});var NG=iE;const ze=function t(e){const i=new Ml(e),n=cv(Ml.prototype.request,i);return j.extend(n,Ml.prototype,i,{allOwnKeys:!0}),j.extend(n,i,null,{allOwnKeys:!0}),n.create=function(r){return t(Ds(e,r))},n}(Y_);ze.Axios=Ml,ze.CanceledError=Vo,ze.CancelToken=OG,ze.isCancel=nI,ze.VERSION=wG,ze.toFormData=_l,ze.AxiosError=Dt,ze.Cancel=ze.CanceledError,ze.all=function(t){return G.all(t)},ze.spread=function(t){return function(e){return t.apply(null,e)}},ze.isAxiosError=function(t){return j.isObject(t)&&t.isAxiosError===!0},ze.mergeConfig=Ds,ze.AxiosHeaders=kn,ze.formToJSON=t=>eI(j.isHTMLForm(t)?new FormData(t):t),ze.getAdapter=RI,ze.HttpStatusCode=NG,ze.default=ze;var li=ze;const DG=()=>{};function uc(){const t={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:DG};return t.promise=new G((e,i)=>{t.resolve=n=>{t.isFinished||(t.isResolved=!0,t.isFinished=!0,e(n),t.value=n)},t.reject=n=>{t.isFinished||(t.isRejected=!0,t.isFinished=!0,i(n))}}),t}const Ul=new Map,xl=new Map,Zn=new Map;let Ie=function(t){return t.WIN_10="Windows 10",t.WIN_81="Windows 8.1",t.WIN_8="Windows 8",t.WIN_7="Windows 7",t.WIN_VISTA="Windows Vista",t.WIN_SERVER_2003="Windows Server 2003",t.WIN_XP="Windows XP",t.WIN_2000="Windows 2000",t.ANDROID="Android",t.HARMONY_OS="HarmonyOS",t.OPEN_BSD="Open BSD",t.SUN_OS="Sun OS",t.LINUX="Linux",t.IOS="iOS",t.MAC_OS="Mac OS",t.CHROMIUM_OS="Chromium OS",t.QNX="QNX",t.UNIX="UNIX",t.BEOS="BeOS",t.OS_2="OS/2",t.SEARCH_BOT="Search Bot",t}({}),Ct=function(t){return t.CHROME="Chrome",t.SAFARI="Safari",t.EDGE="Edge",t.FIREFOX="Firefox",t.OPERA="OPR",t.QQ="QQBrowser",t.WECHAT="MicroMessenger",t}({});const II=new $V;let Mn=II.getResult(),nE=null;function Tt(t){if(!nE){Mn=II.getResult();const e=function(a){if(a.engine.name==="Blink"&&a.browser.name!=="WeChat")return Ct.CHROME;switch(a.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return Ct.CHROME;case"Safari":case"Mobile Safari":return Ct.SAFARI;case"Edge":return Ct.EDGE;case"Firefox":return Ct.FIREFOX;case"QQ":case"QQBrowser":return Ct.QQ;case"Opera":return Ct.OPERA;case"WeChat":return Ct.WECHAT;default:return a.browser.name||""}}(Mn),i=yI(Mn),n=function(a){return a.os.name==="Windows"?a.os.version?a.os.name+" "+a.os.version:a.os.name:a.os.name||""}(Mn),r=Mn.os.version,s=yI(Mn,!1),o=Mn.device.type;if(!(e&&i&&n&&r))return{name:e,version:i,os:n,osVersion:r,browserVersion:s,deviceType:o};nE={name:e,version:i,os:n,osVersion:r,browserVersion:s,deviceType:o}}return nE}function yI(t){let e,i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return e=t.engine.name==="Blink"?t.engine.version||"":t.browser.version||"",i?e.split(".")[0]:e}function Vl(){return Tt().os}function AI(){const t=Tt();return"".concat(t.os," ").concat(t.osVersion)}function Fl(){const t=Tt();return!!(Mn.engine.name==="WebKit"&&t.os===Ie.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&t.name!==Ct.SAFARI||ni()&&t.name!==Ct.SAFARI)}function Rr(){return Tt().name===Ct.CHROME}function Ve(){return Tt().name===Ct.SAFARI}function bI(){return Tt().name===Ct.EDGE}function te(){return Tt().name===Ct.FIREFOX}function ni(){return Tt().os===Ie.IOS}function Fo(t){const e=Tt();return!(e.name!==Ct.CHROME||!e.osVersion)&&Number(e.version)>=t}function wI(t){const e=Tt();return!(e.name!==Ct.CHROME||!e.osVersion)&&Number(e.version)<t}function rE(t,e,i){const n=Tt();return!(n.name!==t||!n.osVersion)&&(i?Number(n.version)>=e&&Number(n.version)<=i:Number(n.version)===e)}function sE(t){const e=Tt();return!(e.name!==Ct.EDGE||!e.osVersion)&&Number(e.version)>=t}function OI(t){const e=Tt();return!(e.name!==Ct.SAFARI||!e.osVersion)&&Number(e.version)>=t}function NI(t,e,i){const n=Tt();if(n.os!==Ie.IOS||!n.osVersion)return!1;const r=n.osVersion.split(".");return e&&Number(r[0])===t&&Number(r[1])<e||Number(r[0])<t}function DI(t,e,i){const n=Tt();if(n.name!==Ct.SAFARI||!n.osVersion||!n.browserVersion)return!1;const r=n.browserVersion.split(".");return e&&Number(r[0])===t&&Number(r[1])<e||Number(r[0])<t}function oE(t){const e=Tt();return!(e.name!==Ct.OPERA||!e.osVersion)&&Number(e.version)>=t}function PI(){const t=Tt();if(t.os!==Ie.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])<14||Number(e[0])===14&&Number(e[1])<=6}function Bo(){const t=Tt();if(t.os!==Ie.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===15}function aE(){const t=Tt();if(t.os!==Ie.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===16}function LI(){const t=Tt();if(t.os!==Ie.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===15&&Number(e[1])>=1}function mn(){return Ve()&&navigator.maxTouchPoints>0}function kI(){return Tt().name===Ct.WECHAT}function MI(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function cE(){const t=Vl();return function(){const{deviceType:e}=Tt();return e==="mobile"||e==="tablet"}()||t===Ie.ANDROID||t===Ie.IOS||t===Ie.HARMONY_OS}function vr(){const t=Tt();return t.name!==Ct.EDGE&&t.name!==Ct.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Bl(){return Vl()===Ie.ANDROID}function hc(){const t=Tt();return Bl()&&(t.name===Ct.CHROME||t.name===Ct.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function rt(t,e,i){return(e=function(n){var r=function(s){if(typeof s!="object"||!s)return s;var o=s[Symbol.toPrimitive];if(o!==void 0){var a=o.call(s,"string");if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)}(n);return typeof r=="symbol"?r:r+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function UI(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Y(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?UI(Object(i),!0).forEach(function(n){rt(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):UI(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let S=function(t){return t.UNEXPECTED_ERROR="UNEXPECTED_ERROR",t.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",t.TIMEOUT="TIMEOUT",t.INVALID_PARAMS="INVALID_PARAMS",t.NOT_READABLE="NOT_READABLE",t.NOT_SUPPORTED="NOT_SUPPORTED",t.INVALID_OPERATION="INVALID_OPERATION",t.OPERATION_ABORTED="OPERATION_ABORTED",t.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",t.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",t.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",t.DATACHANNEL_FAILED="DATACHANNEL_FAILED",t.NETWORK_ERROR="NETWORK_ERROR",t.NETWORK_TIMEOUT="NETWORK_TIMEOUT",t.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",t.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",t.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",t.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",t.ELECTRON_IS_NULL="ELECTRON_IS_NULL",t.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",t.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",t.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",t.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",t.PERMISSION_DENIED="PERMISSION_DENIED",t.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",t.TRACK_IS_DISABLED="TRACK_IS_DISABLED",t.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",t.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",t.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",t.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",t.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",t.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",t.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",t.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",t.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",t.UID_CONFLICT="UID_CONFLICT",t.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",t.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",t.INVALID_TRACK="INVALID_TRACK",t.SENDER_NOT_FOUND="SENDER_NOT_FOUND",t.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",t.SET_ANSWER_FAILED="SET_ANSWER_FAILED",t.ICE_FAILED="ICE_FAILED",t.PC_CLOSED="PC_CLOSED",t.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",t.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",t.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",t.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",t.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",t.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",t.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",t.INVALID_REMOTE_USER="INVALID_REMOTE_USER",t.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",t.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",t.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",t.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",t.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",t.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",t.WS_ABORT="WS_ABORT",t.WS_DISCONNECT="WS_DISCONNECT",t.WS_ERR="WS_ERR",t.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",t.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",t.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",t.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",t.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",t.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",t.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",t.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",t.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",t.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",t.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",t.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",t.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",t.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",t.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",t.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",t.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",t.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",t.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",t.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",t.INVALID_PLUGIN="INVALID_PLUGIN",t.DISCONNECT_P2P="DISCONNECT_P2P",t.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",t.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",t.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",t.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",t.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",t.PROHIBITED_OPERATION="PROHIBITED_OPERATION",t.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",t.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",t}({});class P extends Error{constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0;super(i),rt(this,"code",void 0),rt(this,"message",void 0),rt(this,"data",void 0),rt(this,"name","AgoraRTCException"),this.code=e,this.message="AgoraRTCError ".concat(this.code,": ").concat(i),this.data=n}toString(){return this.data?"".concat(this.message,`
data: `).concat(JSON.stringify(this.data)):this.message}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",i=arguments.length>1?arguments[1]:void 0;return e==="error"&&(i||console).error(this.toString()),e==="warning"&&(i||console).warn(this.toString()),this}throw(e){throw this.print("error",e),this}}function Cr(t,e){if(typeof t!="boolean")throw new P(S.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function Ce(t,e,i){if(!B(i).call(i,t))throw new P(S.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(i)))}function Pt(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(t<i||t>n||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(r){return typeof r=="number"&&r%1==0}(t))throw new P(S.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(i,", ").concat(n,"]. integer only"))}function dE(t,e){if(typeof t!="number"){if(!(t.min||t.max||t.ideal||t.exact))throw new P(S.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));t.min!==void 0&&Pt(t.min,"".concat(e,".min"),0,1/0),t.max!==void 0&&Pt(t.max,"".concat(e,".max"),1,1/0),t.exact!==void 0&&Pt(t.exact,"".concat(e,".exact"),1,1/0),t.ideal!==void 0&&Pt(t.ideal,"".concat(e,".ideal"),1,1/0)}else Pt(t,e,1,1/0)}function Le(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(t==null)throw new P(S.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!xI(t,i,n,r))throw new P(S.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(i,",").concat(n,"].").concat(r?" ASCII characters only.":""))}function Ir(t,e){if(!Array.isArray(t))throw new P(S.INVALID_PARAMS,"".concat(e," should be an array"))}function Xt(t){return t==null}function xI(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,n=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof t=="string"&&t.length<=i&&t.length>=e&&(!n||function(r){if(typeof r!="string")return!1;for(let s=0;s<r.length;s+=1){const o=r.charCodeAt(s);if(o<0||o>255)return!1}return!0}(t))}var pc=function(t){return t.COVERED="COVERED",t.POSITION="POSITION",t.SIZE="SIZE",t.STYLE="STYLE",t}(pc||{}),lE=function(t){return t.UNMOUNTED="UNMOUNTED",t.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",t}(lE||{});const VI=new class{constructor(){rt(this,"_clientSize",null),rt(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),rt(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),rt(this,"getStyle",t=>window.getComputedStyle(t,null)),rt(this,"checkCssVisibleProperty",t=>{var e;let i=!0;const n=this.getStyle(t),{display:r,visibility:s,opacity:o,filter:a}=n;return(r==="none"||B(e=["hidden","collapse"]).call(e,s)||Number(o)<.1)&&(i=!1),!!i&&(a&&a.split(" ").filter(c=>{var d;const l=c.split("(")[0];return B(d=["brightness","blur","opacity"]).call(d,l)}).map(c=>{const[d,l]=c.split(/\(|\)/);return[d,Number(l.match(/^[0-9\.]+/))]}).forEach(c=>{const[d,l]=c;switch(d){case"brightness":(l<.1||l>3)&&(i=!1);break;case"blur":l>3&&(i=!1);break;case"opacity":l<.1&&(i=!1)}}),i)}),rt(this,"checkPropertyUpToAllParentNodes",(t,e)=>{let i=!0,n=!0;const r=o=>e(o);let s=t;for(;s&&n;)r(s)||(i=!1,n=!1),s=s.parentElement,s||(n=!1);return i}),rt(this,"checkActualCssVisibleIncludeInherit",t=>this.checkPropertyUpToAllParentNodes(t,this.checkCssVisibleProperty)),rt(this,"getSizeAboutClient",t=>{const{width:e,height:i,left:n,right:r,top:s,bottom:o}=t.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:e,height:i,left:n,right:r,top:s,bottom:o,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}}),rt(this,"checkActualSize",()=>{const{width:t,height:e,clientMin:i}=this._clientSize;return this.checkSizeIsVisible(t,e,i)}),rt(this,"elementFromPoint",(t,e)=>document.elementFromPoint?document.elementFromPoint(t,e):null),rt(this,"checkCoverForAPoint",(t,e,i)=>{const n=this.elementFromPoint(t,e);return n!==null&&n!==i}),rt(this,"getPointPositionList",()=>{const{width:t,height:e,left:i,top:n}=this._clientSize,r=t/6,s=e/6,o=[],a=10**6;for(let c=0;c<5;c++)for(let d=0;d<5;d++){const l=(i*a+(c===0?.1:c===4?(r*c*a-1e5)/a:r*c)*a)/a,u=(n*a+(d===0?.1:d===4?(s*d*a-1e5)/a:s*d)*a)/a;o.push({x:l,y:u})}return[...o]}),rt(this,"checkElementCover",t=>this.getPointPositionList().map(e=>this.checkCoverForAPoint(e.x,e.y,t)).filter(e=>!!e).length>6),rt(this,"checkSizeIsVisible",(t,e,i)=>(t>50||i/t<=10)&&(e>50||i/e<=10)),rt(this,"checkSizeOfPartInClient",()=>{const{left:t,right:e,top:i,bottom:n,clientHeight:r,clientWidth:s,clientMin:o}=this._clientSize;let a,c,d,l;if(t<0)a=0;else{if(!(t<s))return!1;a=t}if(e<0)return!1;if(c=e<s?e:s,i<0)d=0;else{if(!(i<r))return!1;d=i}if(n<0)return!1;l=n<r?n:r;const u=c-a,h=l-d;return this.checkSizeIsVisible(u,h,o)}),rt(this,"returnHiddenResult",t=>(this._clientSize=null,{visible:!1,reason:t})),rt(this,"checkOneElementVisible",t=>{if(t instanceof HTMLElement){if(this.checkElementIsMountedOnDom(t)){if(this.checkActualCssVisibleIncludeInherit(t)){if(this._clientSize=this.getSizeAboutClient(t),this.checkElementCover(t))return this.returnHiddenResult(pc.COVERED);{const e=this.checkActualSize(),i=this.checkSizeOfPartInClient();return e&&!i?this.returnHiddenResult(pc.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(pc.SIZE)}}return this.returnHiddenResult(pc.STYLE)}return this.returnHiddenResult(lE.UNMOUNTED)}return this.returnHiddenResult(lE.INVALID_HTML_ELEMENT)}),rt(this,"checkElementIsMountedOnDom",t=>this.checkPropertyUpToAllParentNodes(t,e=>e.nodeName.toUpperCase()!=="HTML"?e.parentElement!==null:!!document.documentElement))}};function uE(t){return new TextEncoder().encode(t)}const FI=function(t,e){const i=new Uint8Array(t.byteLength+e.byteLength);return i.set(new Uint8Array(t),0),i.set(new Uint8Array(e),t.byteLength),i},hE=async t=>function(e,i){let n="";return new Uint8Array(e).forEach(r=>{n+=r.toString(i).padStart(2,"0")}),n}(await crypto.subtle.digest("SHA-256",uE(t)),16);let qt=class{constructor(){rt(this,"_events",{}),rt(this,"addListener",this.on)}getListeners(t){return this._events[t]?this._events[t].map(e=>e.listener):[]}on(t,e){this._events[t]||(this._events[t]=[]);const i=this._events[t];this._indexOfListener(i,e)===-1&&i.push({listener:e,once:!1})}once(t,e){this._events[t]||(this._events[t]=[]);const i=this._events[t];this._indexOfListener(i,e)===-1&&i.push({listener:e,once:!0})}off(t,e){if(!this._events[t])return;const i=this._events[t],n=this._indexOfListener(i,e);n!==-1&&i.splice(n,1),this._events[t].length===0&&delete this._events[t]}removeAllListeners(t){t?delete this._events[t]:this._events={}}emit(t){this._events[t]||(this._events[t]=[]);const e=this._events[t].map(s=>s);for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(let s=0;s<e.length;s+=1){const o=e[s];o.once&&this.off(t,o.listener),o.listener.apply(this,n||[])}}safeEmit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];[...this._events[t]||[]].forEach(r=>{r.once&&this.off(t,r.listener);try{r.listener.apply(this,i)}catch(s){console.error("safeEmit event:".concat(t," error ").concat(s==null?void 0:s.toString()))}})}_indexOfListener(t,e){let i=t.length;for(;i--;)if(t[i].listener===e)return i;return-1}},_c=null;function BI(){if(_c)return _c;if(window.electron)return _c=window.electron;if(!window.require)return null;try{return _c=window.require("electron"),_c}catch{return null}}let fe=function(t){return t.CREATE_CLIENT="createClient",t.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",t.SET_AREA="setArea",t.PRELOAD="PRELOAD",t.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",t.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",t.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",t.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",t.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",t.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",t.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",t.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",t.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",t.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",t.START_PROXY_SERVER="Client.startProxyServer",t.STOP_PROXY_SERVER="Client.stopProxyServer",t.SET_PROXY_SERVER="Client.setProxyServer",t.SET_TURN_SERVER="Client.setTurnServer",t.SET_CLIENT_ROLE="Client.setClientRole",t.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",t.ENABLE_DUAL_STREAM="Client.enableDualStream",t.DISABLE_DUAL_STREAM="Client.disableDualStream",t.JOIN="Client.join",t.LEAVE="Client.leave",t.PUBLISH="Client.publish",t.UNPUBLISH="Client.unpublish",t.SUBSCRIBE="Client.subscribe",t.MASS_SUBSCRIBE="Client.massSubscribe",t.MASS_UNSUBSCRIBE="Client.massUnsubscribe",t.UNSUBSCRIBE="Client.unsubscribe",t.RENEW_TOKEN="Client.renewToken",t.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",t.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",t.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",t.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",t.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",t.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",t.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",t.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",t.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",t.START_LIVE_STREAMING="Client.startLiveStreaming",t.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",t.STOP_LIVE_STREAMING="Client.stopLiveStreaming",t.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",t.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",t.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",t.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",t.SET_CONFIG_DISTRIBUTE="_configDistribute",t.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",t.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",t.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",t.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",t.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",t.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",t.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",t.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",t.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",t.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",t.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",t.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",t.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",t.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",t.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",t.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",t.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",t.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",t.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",t.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",t.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",t.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",t.STREAM_TYPE_CHANGE="streamTypeChange",t.CONNECTION_STATE_CHANGE="connectionStateChange",t.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",t.IMAGE_MODERATION_UPLOAD="imageModerationUpload",t.REPUB_AFTER_PC_CONNECTED="repubAfterPCConnected",t}({}),Qt=function(t){return t.TRACER="tracer",t}({});function jI(t){return Pt(t.timeout,"config.timeout",0,1e5),Pt(t.timeoutFactor,"config.timeoutFactor",0,100,!1),Pt(t.maxRetryCount,"config.maxRetryConfig",0,1/0),Pt(t.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let PG=function(t){return t[t.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",t[t.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",t[t.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",t}({}),It=function(t){return t.LEAVE="LEAVE",t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.UID_BANNED="UID_BANNED",t.FALLBACK="FALLBACK",t.IP_BANNED="IP_BANNED",t.CHANNEL_BANNED="CHANNEL_BANNED",t.LICENSE_MISSING="LICENSE_MISSING",t.LICENSE_EXPIRED="LICENSE_EXPIRED",t.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",t.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",t.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",t.LICENSE_ILLEGAL="LICENSE_ILLEGAL",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t}({});function Ec(t){if(!Array.isArray(t)||t.length<1)return!1;try{t.forEach(e=>{if(!e.urls)throw Error()})}catch{return!1}return!0}function GI(t){return Le(t.turnServerURL,"turnServerURL"),Le(t.username,"username"),Le(t.password,"password"),t.udpport&&Pt(t.udpport,"udpport",1,99999,!0),t.forceturn&&Cr(t.forceturn,"forceturn"),t.security&&Cr(t.security,"security"),t.tcpport&&Pt(t.tcpport,"tcpport",1,99999,!0),!0}function pE(t){return t.level!==void 0&&Ce(t.level,"level",[1,2,3]),t.delay!==void 0&&Pt(t.delay,"delay",0,3e3,!0),!0}let dt=function(t){return t.PEERCONNECTION_STATE_CHANGE="peerconnection-state-change",t.AUDIO_METADATA="audio-metadata",t.CONNECTION_STATE_CHANGE="connection-state-change",t.MEDIA_RECONNECT_START="media-reconnect-start",t.MEDIA_RECONNECT_END="media-reconnect-end",t.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",t.USER_JOINED="user-joined",t.USER_LEAVED="user-left",t.USER_PUBLISHED="user-published",t.USER_UNPUBLISHED="user-unpublished",t.USER_INFO_UPDATED="user-info-updated",t.CLIENT_BANNED="client-banned",t.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",t.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",t.VOLUME_INDICATOR="volume-indicator",t.CRYPT_ERROR="crypt-error",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGED="stream-type-changed",t.STREAM_FALLBACK="stream-fallback",t.RECEIVE_METADATA="receive-metadata",t.STREAM_MESSAGE="stream-message",t.LIVE_STREAMING_ERROR="live-streaming-error",t.LIVE_STREAMING_WARNING="live-streaming-warning",t.EXCEPTION="exception",t.ERROR="error",t.P2P_LOST="p2p_lost",t.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",t.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",t.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",t.PUBLISHED_USER_LIST="published-user-list",t.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",t.CONTENT_INSPECT_ERROR="content-inspect-error",t.CONTENT_INSPECT_RESULT="content-inspect-result",t.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",t}({}),Fe=function(t){return t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK",t.REGIONAL_DISTRIBUTION="REGIONAL_DISTRIBUTION",t}({}),Ni=function(t){return t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({}),jo=function(t){return t.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({});function Be(t,e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return t.getListeners(e).length===0?G.reject(new P(S.UNEXPECTED_ERROR,"can not emit promise")):new G((s,o)=>{t.emit(e,...n,s,o)})}function Mt(t,e){if(t.getListeners(e).length===0)return G.resolve();for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return Be(t,e,...n)}function xi(t,e){if(t.getListeners(e).length===0)return null;for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return mc(t,e,...n)}function mc(t,e){let i=null,n=null;for(var r=arguments.length,s=new Array(r>2?r-2:0),o=2;o<r;o++)s[o-2]=arguments[o];if(t.emit(e,...s,a=>{i=a},a=>{n=a}),n!==null)throw n;if(i===null)throw new P(S.UNEXPECTED_ERROR,"handler is not sync");return i}const ue=new class extends qt{set networkState(t){this.emit(jo.NETWORK_STATE_CHANGE,t,this._networkState),t===Ni.ONLINE?this.emit(jo.ONLINE):t===Ni.OFFLINE&&(this.onlineWaiter=new G(e=>{this.once(jo.ONLINE,()=>{this.onlineWaiter=void 0,e(Ni.ONLINE)})}),this.emit(jo.OFFLINE)),this._networkState=t}get networkState(){return this._networkState}get isOnline(){return this._networkState===Ni.ONLINE}constructor(){super(),rt(this,"_moduleName","network-indicator"),rt(this,"_networkState",Ni.ONLINE),rt(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=Ni.ONLINE}),window.addEventListener("offline",()=>{this.networkState=Ni.OFFLINE})}};function jl(t,e){const i=t.indexOf(e);i!==-1&&t.splice(i,1)}function Go(t){const e=[];return t.forEach(i=>{e.indexOf(i)===-1&&e.push(i)}),e}function Gl(t){G!==void 0?G.resolve().then(t):setTimeout(t,0)}function ee(t){return JSON.parse(JSON.stringify(t))}function Ps(t){try{return ee(t)}catch{return t}}const WI={};function Xr(t,e){WI[e]||(WI[e]=!0,t())}function Ls(t){const e=window.atob(t),i=new Uint8Array(new ArrayBuffer(e.length));for(let n=0;n<e.length;n+=1)i[n]=e.charCodeAt(n);return i}function Qr(t){let e="";for(let i=0;i<t.length;i+=1)e+=String.fromCharCode(t[i]);return window.btoa(e)}function HI(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,i=new TextEncoder().encode(t);if(i.length>e)i=i.slice(0,e);else if(i.length<e){const n=new Uint8Array(e);n.set(i),i=n}return i}function KI(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=wn(e).call(e,(o,a)=>o+a.length,0),r=new Uint8Array(new ArrayBuffer(n));let s=0;return e.forEach(o=>{r.set(o,s),s+=o.length}),r}function $n(t){return window.TextEncoder?new TextEncoder().encode(t).length:t.length}function YI(t){let e=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&t.realFormData&&(t=t.realFormData),t.forEach(i=>{e+=typeof i=="string"?$n(i):i.size}),e+138}function LG(t){const e=new P(S.TIMEOUT,"timeout");return new G((i,n)=>{window.setTimeout(()=>n(e),t)})}function ke(t){return new G(e=>{window.setTimeout(e,t)})}function Ut(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0;const i=Math.random().toString(16).substr(2,t).toLowerCase();return i.length===t?"".concat(e).concat(i):"".concat(e).concat(i)+Ut(t-i.length,"")}function ks(){return Ut(32,"").toUpperCase()}const Wl=()=>{},qI=new class{constructor(){rt(this,"fnMap",new Map)}throttleByKey(t,e,i,n){for(var r=arguments.length,s=new Array(r>4?r-4:0),o=4;o<r;o++)s[o-4]=arguments[o];if(this.fnMap.has(e)){const a=this.fnMap.get(e);if(a.threshold!==i){a.fn(...a.args),clearTimeout(a.timer);const c=window.setTimeout(()=>{const d=this.fnMap.get(e);d&&d.fn(...d.args),this.fnMap.delete(e)},i);this.fnMap.set(e,{fn:t,threshold:i,timer:c,args:s,skipFn:n})}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(e,Y(Y({},a),{},{fn:t,args:s,skipFn:n}))}else{const a=window.setTimeout(()=>{const c=this.fnMap.get(e);c&&c.fn(...c.args),this.fnMap.delete(e)},i);this.fnMap.set(e,{fn:t,threshold:i,timer:a,args:s,skipFn:n})}}},zI=qI.throttleByKey.bind(qI);function JI(t){return typeof t=="object"&&t!==null&&!(t instanceof RegExp)}function _E(t,e){if(!JI(t)||!JI(e)||Array.isArray(t)&&!Array.isArray(e)||!Array.isArray(t)&&Array.isArray(e))return e;if(Array.isArray(e)&&Array.isArray(t)){const i=[...t];for(let n=0;n<e.length;n++)i[n]=_E(t[n],e[n]);return i}{const i=Y({},t);for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(Object.prototype.hasOwnProperty.call(t,n)?i[n]=_E(t[n],e[n]):i[n]=e[n]);return i}}function XI(t,e){let i=[0];if(i=new Array(e).fill(0),t===0)return i;let n=0;for(;t>0&&(i[n]=255&t,t>>=8,n++,n!==e););return i}function EE(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function QI(t){const e="0123456789abcdef";function i(A){let O,w="";for(O=0;O<=3;O++)w+=e.charAt(A>>8*O+4&15)+e.charAt(A>>8*O&15);return w}function n(A,O){const w=(65535&A)+(65535&O);return(A>>16)+(O>>16)+(w>>16)<<16|65535&w}function r(A,O,w,b,L,x){return n(function(W,K){return W<<K|W>>>32-K}(n(n(O,A),n(b,x)),L),w)}function s(A,O,w,b,L,x,W){return r(O&w|~O&b,A,O,L,x,W)}function o(A,O,w,b,L,x,W){return r(O&b|w&~b,A,O,L,x,W)}function a(A,O,w,b,L,x,W){return r(O^w^b,A,O,L,x,W)}function c(A,O,w,b,L,x,W){return r(w^(O|~b),A,O,L,x,W)}const d=function(A){let O;const w=1+(A.length+8>>6),b=new Array(16*w);for(O=0;O<16*w;O++)b[O]=0;for(O=0;O<A.length;O++)b[O>>2]|=A.charCodeAt(O)<<O%4*8;return b[O>>2]|=128<<O%4*8,b[16*w-2]=8*A.length,b}(t);let l,u,h,p,T,m=1732584193,f=-271733879,R=-1732584194,v=271733878;for(l=0;l<d.length;l+=16)u=m,h=f,p=R,T=v,m=s(m,f,R,v,d[l+0],7,-680876936),v=s(v,m,f,R,d[l+1],12,-389564586),R=s(R,v,m,f,d[l+2],17,606105819),f=s(f,R,v,m,d[l+3],22,-1044525330),m=s(m,f,R,v,d[l+4],7,-176418897),v=s(v,m,f,R,d[l+5],12,1200080426),R=s(R,v,m,f,d[l+6],17,-1473231341),f=s(f,R,v,m,d[l+7],22,-45705983),m=s(m,f,R,v,d[l+8],7,1770035416),v=s(v,m,f,R,d[l+9],12,-1958414417),R=s(R,v,m,f,d[l+10],17,-42063),f=s(f,R,v,m,d[l+11],22,-1990404162),m=s(m,f,R,v,d[l+12],7,1804603682),v=s(v,m,f,R,d[l+13],12,-40341101),R=s(R,v,m,f,d[l+14],17,-1502002290),f=s(f,R,v,m,d[l+15],22,1236535329),m=o(m,f,R,v,d[l+1],5,-165796510),v=o(v,m,f,R,d[l+6],9,-1069501632),R=o(R,v,m,f,d[l+11],14,643717713),f=o(f,R,v,m,d[l+0],20,-373897302),m=o(m,f,R,v,d[l+5],5,-701558691),v=o(v,m,f,R,d[l+10],9,38016083),R=o(R,v,m,f,d[l+15],14,-660478335),f=o(f,R,v,m,d[l+4],20,-405537848),m=o(m,f,R,v,d[l+9],5,568446438),v=o(v,m,f,R,d[l+14],9,-1019803690),R=o(R,v,m,f,d[l+3],14,-187363961),f=o(f,R,v,m,d[l+8],20,1163531501),m=o(m,f,R,v,d[l+13],5,-1444681467),v=o(v,m,f,R,d[l+2],9,-51403784),R=o(R,v,m,f,d[l+7],14,1735328473),f=o(f,R,v,m,d[l+12],20,-1926607734),m=a(m,f,R,v,d[l+5],4,-378558),v=a(v,m,f,R,d[l+8],11,-2022574463),R=a(R,v,m,f,d[l+11],16,1839030562),f=a(f,R,v,m,d[l+14],23,-35309556),m=a(m,f,R,v,d[l+1],4,-1530992060),v=a(v,m,f,R,d[l+4],11,1272893353),R=a(R,v,m,f,d[l+7],16,-155497632),f=a(f,R,v,m,d[l+10],23,-1094730640),m=a(m,f,R,v,d[l+13],4,681279174),v=a(v,m,f,R,d[l+0],11,-358537222),R=a(R,v,m,f,d[l+3],16,-722521979),f=a(f,R,v,m,d[l+6],23,76029189),m=a(m,f,R,v,d[l+9],4,-640364487),v=a(v,m,f,R,d[l+12],11,-421815835),R=a(R,v,m,f,d[l+15],16,530742520),f=a(f,R,v,m,d[l+2],23,-995338651),m=c(m,f,R,v,d[l+0],6,-198630844),v=c(v,m,f,R,d[l+7],10,1126891415),R=c(R,v,m,f,d[l+14],15,-1416354905),f=c(f,R,v,m,d[l+5],21,-57434055),m=c(m,f,R,v,d[l+12],6,1700485571),v=c(v,m,f,R,d[l+3],10,-1894986606),R=c(R,v,m,f,d[l+10],15,-1051523),f=c(f,R,v,m,d[l+1],21,-2054922799),m=c(m,f,R,v,d[l+8],6,1873313359),v=c(v,m,f,R,d[l+15],10,-30611744),R=c(R,v,m,f,d[l+6],15,-1560198380),f=c(f,R,v,m,d[l+13],21,1309151649),m=c(m,f,R,v,d[l+4],6,-145523070),v=c(v,m,f,R,d[l+11],10,-1120210379),R=c(R,v,m,f,d[l+2],15,718787259),f=c(f,R,v,m,d[l+9],21,-343485551),m=n(m,u),f=n(f,h),R=n(R,p),v=n(v,T);return i(m)+i(f)+i(R)+i(v)}let kG=1,ZI=console,Ke=class{static setLogger(t){ZI=t}constructor(t,e){rt(this,"id",void 0),rt(this,"lockingPromise",G.resolve()),rt(this,"locks",0),rt(this,"name",""),rt(this,"lockId",void 0),this.lockId=kG++,t&&(this.name=t),e&&(this.id=e),this.logger("created")}logger(t,e){const i=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),n=t==="created"?"is ".concat(t,"."):"is ".concat(t,", current queue ").concat(this.locks,". ").concat(e??"");ZI.debug("".concat(i," ").concat(n))}setId(t){this.id=t}get isLocked(){return this.locks>0}lock(t){let e;this.locks+=1,this.logger("locked",t);const i=new G(r=>{e=()=>{this.locks-=1,this.logger("unlocked",t),r()}}),n=this.lockingPromise.then(()=>e);return this.lockingPromise=this.lockingPromise.then(()=>i),n}};function Wo(t,e){return function(i,n,r){const s=r.value;if(typeof s!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){const o=this[e];if(!o)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(t));const a=await o.lock("From ".concat(t,".").concat(n));try{for(var c=arguments.length,d=new Array(c),l=0;l<c;l++)d[l]=arguments[l];return await s.apply(this,d)}finally{a()}},r}}const ge={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function mE(t,e){const i=Math.floor(e.timeout*Math.pow(e.timeoutFactor,t));return Math.min(e.maxRetryTimeout,i)}function Un(t,e,i,n){const r=Object.assign({},ge,n);let s=r.timeout;const o=async()=>{await function(d){return new G(l=>{window.setTimeout(l,d)})}(s),s*=r.timeoutFactor,s=Math.min(r.maxRetryTimeout,s)};let a=!1;const c=new G(async(d,l)=>{e=e||(()=>!1),i=i||(()=>!0);for(let u=0;u<r.maxRetryCount;u+=1){if(a)return l(new P(S.OPERATION_ABORTED));try{const h=await t();if(!e(h,u)||u+1===r.maxRetryCount)return d(h);await o()}catch(h){if(!i(h,u)||u+1===r.maxRetryCount)return l(h);await o()}}});return c.cancel=()=>a=!0,c}let Hl,$I=class{constructor(t){rt(this,"input",[]),rt(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}mean(){var t;return this.input.length===0?0:wn(t=this.input).call(t,(e,i)=>e+i)/this.input.length}},Kl=0,fE=0;function gE(t,e,i,n){return new G((r,s)=>{e.responseType=e.responseType||"json",e.data&&!i?(e.data=JSON.stringify(e.data),Kl+=$n(e.data)):i&&(e.data.size?Kl+=e.data.size:e.data instanceof FormData?Kl+=YI(e.data):Kl+=$n(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,li.request(e).then(o=>{typeof o.data=="string"?fE+=$n(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?fE+=o.data.byteLength:fE+=$n(JSON.stringify(o.data)),r(o.data)}).catch(o=>{li.isCancel(o)?s(new P(S.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?s(new P(S.NETWORK_TIMEOUT,o.message)):o.response?s(new P(S.NETWORK_RESPONSE_ERROR,o.response.status)):s(new P(S.NETWORK_ERROR,o.message))})})}async function MG(t,e){const i=new Blob([e.data],{type:"buffer"});return await gE(t,Y(Y({},e),{},{data:i,headers:{"Content-Type":"application/octet-stream"}}),!0)}const ty=()=>window.isSecureContext!==void 0;function fn(t){if(Array.isArray(t))return t.map(i=>i);if(!ey(t))return t;const e={};for(const i in t){const n=t[i];ey(n)||Array.isArray(n)?e[i]=fn(n):e[i]=n}return e}function ey(t){return!(typeof t!="object"||Array.isArray(t)||!t)}let TE=class{constructor(t){rt(this,"input",[]),rt(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}};const tr={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},fc={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:tr,remoteCandidate:tr},updateInterval:0},iy={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},ny={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},ry={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},sy={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};let SE=class{constructor(t,e){rt(this,"onFirstVideoReceived",void 0),rt(this,"onFirstVideoDecoded",void 0),rt(this,"onFirstAudioReceived",void 0),rt(this,"onFirstVideoDecodedTimeout",void 0),rt(this,"onFirstAudioDecoded",void 0),rt(this,"onSelectedLocalCandidateChanged",void 0),rt(this,"onSelectedRemoteCandidateChanged",void 0),rt(this,"videoIsReady",!1),rt(this,"videoIsReady2",{}),rt(this,"pc",void 0),rt(this,"options",void 0),rt(this,"intervalTimer",void 0),rt(this,"stats",fn(fc)),rt(this,"isFirstVideoReceived",{}),rt(this,"isFirstVideoDecoded",{}),rt(this,"isFirstAudioReceived",{}),rt(this,"isFirstAudioDecoded",{}),rt(this,"isFirstVideoDecodedTimeout",{}),rt(this,"lossRateWindowStats",[]),this.pc=t,this.options=e,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new G(t=>{t({local:Y({},tr),remote:Y({},tr)})})}setVideoIsReady(t){this.videoIsReady=t}setVideoIsReady2(t,e){this.videoIsReady2[t]=e}getVideoIsReady(t){return this.videoIsReady2[t]||!1}setIsFirstAudioDecoded(t){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(t){this.lossRateWindowStats.push(t),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const e=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let n=0,r=0,s=0,o=0;for(const a of i)t[a].forEach((c,d)=>{if(!this.lossRateWindowStats[e-1][a][d]||!this.lossRateWindowStats[0][a][d])return;const l=this.lossRateWindowStats[e-1][a][d].packets-this.lossRateWindowStats[0][a][d].packets,u=this.lossRateWindowStats[e-1][a][d].packetsLost-this.lossRateWindowStats[0][a][d].packetsLost;a==="videoSend"||a==="audioSend"?(n+=l,s+=u):(r+=l,o+=u),Number.isNaN(l)||Number.isNaN(l)?c.packetLostRate=0:c.packetLostRate=l<=0||u<=0?0:u/(l+u)});t.sendPacketLossRate=n<=0||s<=0?0:s/(n+s),t.recvPacketLossRate=r<=0||o<=0?0:o/(r+o)}},UG=class extends SE{constructor(){super(...arguments),rt(this,"_stats",fc),rt(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const t=await this._getStats(),e=this.statsResponsesToObjects(t);this._stats=fn(fc);const i=e.filter(r=>r.type==="ssrc");this.processSSRCStats(i);const n=e.find(r=>r.type==="VideoBwe");n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(t){this._stats.bitrate={actualEncoded:Number(t.googActualEncBitrate),targetEncoded:Number(t.googTargetEncBitrate),retransmit:Number(t.googRetransmitBitrate),transmit:Number(t.googTransmitBitrate)},this._stats.sendBandwidth=Number(t.googAvailableSendBandwidth)}processSSRCStats(t){t.forEach(e=>{var i;const n=B(i=e.id).call(i,"send");switch("".concat(e.mediaType,"_").concat(n?"send":"recv")){case"video_send":{const r=fn(ny);r.codec=e.googCodecName,r.adaptionChangeReason="none",e.googCpuLimitedResolution&&(r.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(r.adaptionChangeReason="bandwidth"),r.avgEncodeMs=Number(e.googAvgEncodeMs),r.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},r.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},r.firsCount=Number(e.googFirReceived),r.nacksCount=Number(e.googNacksReceived),r.plisCount=Number(e.googPlisReceived),r.frameCount=Number(e.framesEncoded),r.bytes=Number(e.bytesSent),r.packets=Number(e.packetsSent),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(r),this._stats.rtt=r.rttMs;break}case"video_recv":{const r=fn(iy),s=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(r.codec=e.googCodecName,r.targetDelayMs=Number(e.googTargetDelayMs),r.renderDelayMs=Number(e.googRenderDelayMs),r.currentDelayMs=Number(e.googCurrentDelayMs),r.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),r.decodeMs=Number(e.googDecodeMs),r.maxDecodeMs=Number(e.googMaxDecodeMs),r.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},r.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},r.decodeFrameRate=Number(e.googFrameRateDecoded),r.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},r.jitterBufferMs=Number(e.googJitterBufferMs),r.firsCount=Number(e.googFirsSent),r.nacksCount=Number(e.googNacksSent),r.plisCount=Number(e.googPlisSent),r.framesDecodeCount=Number(e.framesDecoded),r.bytes=Number(e.bytesReceived),r.packets=Number(e.packetsReceived),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.packets>0&&!this.isFirstVideoReceived[r.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(r.ssrc),this.isFirstVideoReceived[r.ssrc]=!0),r.framesDecodeCount>0&&!this.isFirstVideoDecoded[r.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(r.ssrc,r.decodedFrame.width,r.decodedFrame.height),this.isFirstVideoDecoded[r.ssrc]=!0),s){const o=s.stats,a=Date.now()-s.lts;r.framesDecodeFreezeTime=o.framesDecodeFreezeTime,r.framesDecodeInterval=o.framesDecodeInterval,r.framesDecodeCount>o.framesDecodeCount&&this.isFirstVideoDecoded[r.ssrc]?(s.lts=Date.now(),r.framesDecodeInterval=a,r.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?r.framesDecodeFreezeTime+=r.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):r.framesDecodeCount<s.stats.framesDecodeCount&&(r.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(r.ssrc,{stats:Y({},r),lts:Date.now()}),this._stats.videoRecv.push(r);break}case"audio_recv":{const r=fn(sy);r.codec=e.googCodecName,r.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,r.decodingCNG=Number(e.googDecodingCNG),r.decodingCTN=Number(e.googDecodingCTN),r.decodingCTSG=Number(e.googDecodingCTSG),r.decodingNormal=Number(e.googDecodingNormal),r.decodingPLC=Number(e.googDecodingPLC),r.decodingPLCCNG=Number(e.googDecodingPLCCNG),r.expandRate=Number(e.googExpandRate),r.accelerateRate=Number(e.googAccelerateRate),r.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),r.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),r.speechExpandRate=Number(e.googSpeechExpandRate),r.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),r.jitterBufferMs=Number(e.googJitterBufferMs),r.jitterMs=Number(e.googJitterReceived),r.bytes=Number(e.bytesReceived),r.packets=Number(e.packetsReceived),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),r.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),r.receivedFrames>0&&!this.isFirstAudioReceived[r.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(r.ssrc),this.isFirstAudioReceived[r.ssrc]=!0),r.decodingNormal>0&&!this.isFirstAudioDecoded[r.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(r.ssrc),this.isFirstAudioDecoded[r.ssrc]=!0),this._stats.audioRecv.push(r);break}case"audio_send":{const r=fn(ry);r.codec=e.googCodecName,r.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,r.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),r.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),r.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),r.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),r.bytes=Number(e.bytesSent),r.packets=Number(e.packetsSent),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.rttMs=Number(e.googRtt||0),this._stats.rtt=r.rttMs,this._stats.audioSend.push(r);break}}})}_getStats(){return new G((t,e)=>{this.pc.getStats(t,e)})}statsResponsesToObjects(t){const e=[];return t.result().forEach(i=>{const n={id:i.id,timestamp:i.timestamp.valueOf().toString(),type:i.type};i.names().forEach(r=>{n[r]=i.stat(r)}),e.push(n)}),e}},gc=function(t){return t.BANDWIDTH="bandwidth",t.CPU="cpu",t.NONE="none",t.OTHER="other",t}({}),Yl=function(t){return t.L1T1="L1T1",t.L1T2="L1T2",t.L1T3="L1T3",t.L1T3_KEY="L1T3_KEY",t.L2T1_KEY="L2T1_KEY",t.L2T2_KEY="L2T2_KEY",t.L2T3_KEY="L2T3_KEY",t.L3T1_KEY="L3T1_KEY",t.L3T2_KEY="L3T2_KEY",t.L3T3_KEY="L3T3_KEY",t}({}),RE=function(t){return t[t.new=0]="new",t[t.connecting=1]="connecting",t[t.connected=2]="connected",t[t.disconnected=3]="disconnected",t[t.failed=4]="failed",t[t.closed=5]="closed",t}({}),Vi=function(t){return t.CERTIFICATE="certificate",t.CODEC="codec",t.CANDIDATE_PAIR="candidate-pair",t.LOCAL_CANDIDATE="local-candidate",t.REMOTE_CANDIDATE="remote-candidate",t.INBOUND="inbound-rtp",t.TRACK="track",t.OUTBOUND="outbound-rtp",t.PC="peer-connection",t.REMOTE_INBOUND="remote-inbound-rtp",t.REMOTE_OUTBOUND="remote-outbound-rtp",t.TRANSPORT="transport",t.CSRC="csrc",t.DATA_CHANNEL="data-channel",t.STREAM="stream",t.SENDER="sender",t.RECEIVER="receiver",t}({});var Ho=function(t){return t[t.kNone=1]="kNone",t[t.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",t[t.kBytesToBits=8]="kBytesToBits",t}(Ho||{});function Tc(t,e,i,n){let r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:Ho.kNone;if(!e)return;const s=Number(e[i]);if(typeof s!="number")return;const o=Number(e[n]);if(typeof o!="number")return;if(!t)return o?s/o*r:void 0;const a=Number(t[i]);if(typeof a!="number")return;const c=Number(t[n]);if(typeof c!="number")return;const d=o-c;return d?(s-a)/d*r:void 0}let oy=class extends SE{constructor(){super(...arguments),rt(this,"_stats",fc),rt(this,"report",void 0),rt(this,"lastDecodeVideoReceiverStats",new Map),rt(this,"lastVideoFramesRecv",new Map),rt(this,"lastVideoFramesSent",new Map),rt(this,"lastVideoFramesDecode",new Map),rt(this,"lastVideoFramesOutput",new Map),rt(this,"lastVideoJBDelay",new Map),rt(this,"lastAudioJBDelay",new Map),rt(this,"mediaBytesSent",new Map),rt(this,"mediaBytesRetransmit",new Map),rt(this,"mediaBytesTargetEncode",new Map),rt(this,"lastDecodeAudioReceiverStats",new Map),rt(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=fn(fc),this.report.forEach(t=>{switch(t.type){case Vi.OUTBOUND:case Vi.INBOUND:{const e=t.mediaType||t.kind,i=!e&&"frameWidth"in t,n=!e&&!("frameWidth"in t);t.type===Vi.OUTBOUND?e==="audio"||n?this.processAudioOutboundStats(t):(e==="video"||i)&&this.processVideoOutboundStats(t):t.type===Vi.INBOUND&&(e==="audio"||n?this.processAudioInboundStats(t):(e==="video"||i)&&this.processVideoInboundStats(t));break}case Vi.TRANSPORT:{const e=this.report.get(t.selectedCandidatePairId);e&&this.processCandidatePairStats(e);break}case Vi.CANDIDATE_PAIR:t.selected&&this.processCandidatePairStats(t)}}),this.updateSendBitrate(),this._stats.updateInterval=Date.now()-this.stats.timestamp,this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const t=await this.pc.getStats(),e={local:Y({},tr),remote:Y({},tr)};return t.forEach(i=>{let n;if(i.type===Vi.TRANSPORT&&(n=t.get(i.selectedCandidatePairId)),i.type===Vi.CANDIDATE_PAIR&&i.selected&&(n=i),n){const r=(s,o)=>{s.type=o.type,s.id=o.id,o.address&&(s.address=o.address),o.candidateType&&(s.candidateType=o.candidateType),o.port&&(s.port=o.port),o.priority&&(s.priority=o.priority),o.protocol&&(s.protocol=o.protocol),o.relayProtocol&&(s.relayProtocol=o.relayProtocol)};if(n.localCandidateId){const s=t.get(n.localCandidateId);s&&r(e.local,s)}if(n.remoteCandidateId){const s=t.get(n.remoteCandidateId);s&&r(e.remote,s)}}}),e}processCandidatePairStats(t){if(this._stats.sendBandwidth=t.availableOutgoingBitrate||0,t.currentRoundTripTime&&(this._stats.rtt=1e3*t.currentRoundTripTime),this._stats.videoSend.forEach(e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)}),this._stats.audioSend.forEach(e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=t.id,t.localCandidateId){const e=this.report.get(t.localCandidateId);e&&this.processCandidateStats(e)}if(t.remoteCandidateId){const e=this.report.get(t.remoteCandidateId);e&&this.processCandidateStats(e)}}processCandidateStats(t){let e;t.type===Vi.LOCAL_CANDIDATE&&(e=this._stats.selectedCandidatePair.localCandidate),t.type===Vi.REMOTE_CANDIDATE&&(e=this._stats.selectedCandidatePair.remoteCandidate),e&&(e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol),t.type===Vi.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==e.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(Y({},e),Y({},this.stats.selectedCandidatePair.localCandidate)),t.type===Vi.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==e.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(Y({},e),Y({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(t){let e=this._stats.audioRecv.find(n=>n.ssrc===t.ssrc);e||(e=fn(sy),this._stats.audioRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.packetsDiscarded=t.packetsDiscarded,e.bytes=t.bytesReceived,e.jitterMs=1e3*t.jitter,e.retransmittedBytesReceived=t.retransmittedBytesReceived,e.retransmittedPacketsReceived=t.retransmittedPacketsReceived,e.totalProcessingDelay=t.totalProcessingDelay,e.jitterBufferEmittedCount=t.jitterBufferEmittedCount;const i=this.lastDecodeAudioReceiverStats.get(e.ssrc);e.avgProcessingDelayMs=Tc(i,e,"totalProcessingDelay","jitterBufferEmittedCount",Ho.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),e.receivedFrames||(e.receivedFrames=t.packetsReceived),e.droppedFrames||(e.droppedFrames=t.packetsLost),e.receivedFrames>0&&!this.isFirstAudioReceived[e.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(e.ssrc),this.isFirstAudioReceived[e.ssrc]=!0),e.outputLevel&&e.outputLevel>0&&!this.isFirstAudioDecoded[e.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(e.ssrc),this.isFirstAudioDecoded[e.ssrc]=!0),typeof t.concealedSamples=="number"&&(e.concealedSamples=t.concealedSamples),this.lastDecodeAudioReceiverStats.set(e.ssrc,Y({},e))}processVideoInboundStats(t){let e=this._stats.videoRecv.find(o=>o.ssrc===t.ssrc);e||(e=fn(iy),this._stats.videoRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.bytes=t.bytesReceived,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.framesDecodeCount=t.framesDecoded,e.framesDroppedCount=t.framesDropped,e.totalInterFrameDelay=t.totalInterFrameDelay,e.totalSquaredInterFrameDelay=t.totalSquaredInterFrameDelay,e.totalFreezesDuration=t.totalFreezesDuration,e.totalProcessingDelay=t.totalProcessingDelay,e.packetsDiscarded=t.packetsDiscarded,e.framesAssembledFromMultiplePackets=t.framesAssembledFromMultiplePackets,e.totalAssemblyTime=t.totalAssemblyTime,e.keyFramesDecoded=t.keyFramesDecoded,e.retransmittedBytesReceived=t.retransmittedBytesReceived,e.retransmittedPacketsReceived=t.retransmittedPacketsReceived;const i=this.lastDecodeVideoReceiverStats.get(e.ssrc),n=this.lastVideoFramesDecode.get(e.ssrc),r=this.lastVideoFramesOutput.get(e.ssrc),s=Date.now();if(e.framesDecodeCount>0&&!this.isFirstVideoDecoded[e.ssrc]){const o=e.decodedFrame?e.decodedFrame.width:0,a=e.decodedFrame?e.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(e.ssrc,o,a),this.isFirstVideoDecoded[e.ssrc]=!0}if(i){const o=i.stats,a=s-i.lts;e.framesDecodeFreezeTime=o.framesDecodeFreezeTime,e.framesDecodeInterval=o.framesDecodeInterval,!this.isFirstVideoDecoded[e.ssrc]&&a>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[e.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(e.ssrc),this.isFirstVideoDecodedTimeout[e.ssrc]=!0),e.framesDecodeCount>o.framesDecodeCount&&this.isFirstVideoDecoded[e.ssrc]?(i.lts=Date.now(),e.framesDecodeInterval=a,e.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc))?e.framesDecodeFreezeTime+=e.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):e.framesDecodeCount<o.framesDecodeCount&&(e.framesDecodeInterval=0),t.framesDecoded&&t.qpSum&&(i.stats.framesDecodeCount>t.framesDecoded?e.qpSumPerFrame=t.qpSum/t.framesDecoded:e.qpSumPerFrame=(t.qpSum-i.qpSum)/(t.framesDecoded-i.stats.framesDecodeCount))}t.totalDecodeTime&&(e.decodeMs=1e3*t.totalDecodeTime,e.avgDecodeMs=Tc(i==null?void 0:i.stats,e,"decodeMs","framesDecodeCount")),e.avgProcessingDelayMs=Tc(i==null?void 0:i.stats,e,"totalProcessingDelay","framesDecodeCount",Ho.kMillisecondsFromSeconds),e.avgFramesAssembledFromMultiplePacketsMs=Tc(i==null?void 0:i.stats,e,"totalAssemblyTime","framesAssembledFromMultiplePackets",Ho.kMillisecondsFromSeconds),e.avgInterFrameDelayMs=Tc(i==null?void 0:i.stats,e,"totalInterFrameDelay","framesDecodeCount",Ho.kMillisecondsFromSeconds),n&&s-n.lts>=800?(e.decodeFrameRate=Math.round((e.framesDecodeCount-n.count)/((s-n.lts)/1e3)),this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:s,rate:e.decodeFrameRate})):n?e.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:s,rate:0}),e.framesDroppedCount&&t.framesReceived&&(r&&s-r.lts>=800?(e.outputFrameRate=Math.round((t.framesReceived-e.framesDroppedCount-r.count)/((s-r.lts)/1e3)),this.lastVideoFramesOutput.set(e.ssrc,{count:t.framesReceived-e.framesDroppedCount,lts:s,rate:Math.max(e.outputFrameRate,0)})):r?e.outputFrameRate=r.rate:this.lastVideoFramesOutput.set(e.ssrc,{count:t.framesReceived-e.framesDroppedCount,lts:s,rate:0})),this.processVideoTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.framerateMean&&(e.framesRateFirefox=t.framerateMean),e.packets>0&&!this.isFirstVideoReceived[e.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(e.ssrc),this.isFirstVideoReceived[e.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(e.ssrc,{stats:Y({},e),lts:i?i.lts:Date.now(),qpSum:t.qpSum})}processVideoOutboundStats(t){let e=this._stats.videoSend.find(n=>n.ssrc===t.ssrc);e||(e=fn(ny),this._stats.videoSend.push(e));const i=this.mediaBytesSent.get(t.ssrc);if(i)i.add(t.bytesSent);else{const n=new TE(10);n.add(t.bytesSent),this.mediaBytesSent.set(t.ssrc,n)}if(t.retransmittedBytesSent!==void 0){const n=this.mediaBytesRetransmit.get(t.ssrc);if(n)n.add(t.retransmittedBytesSent);else{const r=new TE(10);r.add(t.retransmittedBytesSent),this.mediaBytesRetransmit.set(t.ssrc,r)}}if(t.totalEncodedBytesTarget){const n=this.mediaBytesTargetEncode.get(t.ssrc);if(n)n.add(t.totalEncodedBytesTarget);else{const r=new TE(10);r.add(t.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(t.ssrc,r)}}if(e.ssrc=t.ssrc,e.bytes=t.bytesSent,e.packets=t.packetsSent,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.frameCount=t.framesEncoded,e.adaptionChangeReason=t.qualityLimitationReason,e.scalabilityMode=t.scalabilityMode,e.retransmittedBytesSent=t.retransmittedBytesSent,e.retransmittedPacketsSent=t.retransmittedPacketsSent,e.hugeFramesSent=t.hugeFramesSent,e.keyFramesEncoded=t.keyFramesEncoded,t.totalEncodeTime&&t.framesEncoded){const n=this.lastEncoderMs.get(t.ssrc);if(!n||n.lastFrameCount>t.framesEncoded)e.avgEncodeMs=1e3*t.totalEncodeTime/t.framesEncoded;else{const r=t.framesEncoded-n.lastFrameCount,s=t.totalEncodeTime-n.lastEncoderTime;e.avgEncodeMs=1e3*s/r}}if(t.framesEncoded&&t.qpSum){const n=this.lastEncoderMs.get(t.ssrc);!n||n.lastFrameCount>t.framesEncoded?e.qpSumPerFrame=t.qpSum/t.framesEncoded:e.qpSumPerFrame=(t.qpSum-n.lastQpSum)/(t.framesEncoded-n.lastFrameCount)}if(this.lastEncoderMs.set(t.ssrc,{lastFrameCount:t.framesEncoded,lastEncoderTime:t.totalEncodeTime,lastQpSum:t.qpSum,lts:Date.now()}),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.mediaSourceId&&this.processVideoMediaSource(t.mediaSourceId,e),this.processVideoTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const n=this.findRemoteStatsId(t.ssrc,Vi.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,e)}}processAudioOutboundStats(t){let e=this._stats.audioSend.find(i=>i.ssrc===t.ssrc);if(e||(e=fn(ry),this._stats.audioSend.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsSent,e.bytes=t.bytesSent,e.retransmittedBytesSent=t.retransmittedBytesSent,e.retransmittedPacketsSent=t.retransmittedPacketsSent,t.mediaSourceId&&this.processAudioMediaSource(t.mediaSourceId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),this.processAudioTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const i=this.findRemoteStatsId(t.ssrc,Vi.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,e)}}findRemoteStatsId(t,e){var i;const n=Array.from(Mi(i=this.report).call(i)).find(r=>r.type===e&&r.ssrc===t);return n?n.id:null}processVideoMediaSource(t,e){const i=this.report.get(t);i&&i.width&&i.height&&i.framesPerSecond&&(e.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(t,e){const i=this.report.get(t);i&&(e.inputLevel=i.audioLevel)}processVideoTrackSenderStats(t,e,i){var n,r,s,o;const a=e?this.report.get(e):void 0,c=(n=a==null?void 0:a.framesSent)!==null&&n!==void 0?n:t.framesSent;if(typeof c!="number")return;let d=(r=a==null?void 0:a.frameWidth)!==null&&r!==void 0?r:t.frameWidth,l=(s=a==null?void 0:a.frameHeight)!==null&&s!==void 0?s:t.frameHeight,u=(o=a==null?void 0:a.framesPerSecond)!==null&&o!==void 0?o:t.framesPerSecond;if(typeof d=="number"&&typeof l=="number"||(d=0,l=0),u==null){const h=Date.now(),p=this.lastVideoFramesSent.get(i.ssrc);p&&h-p.lts>=800?(u=Math.round((c-p.count)/((h-p.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:h,rate:u})):p?u=p.rate:this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:h,rate:0})}i.sentFrame={width:d,height:l,frameRate:Math.max(0,u)}}processVideoTrackReceiverStats(t,e,i){var n,r,s,o,a;const c=e?this.report.get(e):void 0,d=(n=c==null?void 0:c.framesReceived)!==null&&n!==void 0?n:t.framesReceived,l=(r=c==null?void 0:c.frameWidth)!==null&&r!==void 0?r:t.frameWidth,u=(s=c==null?void 0:c.frameHeight)!==null&&s!==void 0?s:t.frameHeight,h=(o=c==null?void 0:c.jitterBufferDelay)!==null&&o!==void 0?o:t.jitterBufferDelay,p=(a=c==null?void 0:c.jitterBufferEmittedCount)!==null&&a!==void 0?a:t.jitterBufferEmittedCount;if(typeof d=="number"){const T=this.lastVideoFramesRecv.get(i.ssrc),m=Date.now();i.framesReceivedCount=d;let f=0;T&&m-T.lts>=800?(f=Math.round((d-T.count)/((m-T.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:m,rate:f})):T?f=T.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:m,rate:0}),i.receivedFrame={width:l||0,height:u||0,frameRate:f||0},i.decodedFrame={width:l||0,height:u||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:l||0,height:u||0,frameRate:i.outputFrameRate||i.decodeFrameRate||0}}if(h&&p){const T=this.lastVideoJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let m=T.jitterBufferMs;const f=p-T.jitterBufferEmittedCount;f>0&&(m=1e3*(h-T.jitterBufferDelay)/f),i.jitterBufferMs=m,i.currentDelayMs=Math.round(m),this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:h,jitterBufferEmittedCount:p,jitterBufferMs:i.currentDelayMs})}}processAudioTrackSenderStats(t,e,i){var n,r,s,o;const a=e?this.report.get(e):void 0,c=(n=(r=a==null?void 0:a.echoReturnLoss)!==null&&r!==void 0?r:t.echoReturnLoss)!==null&&n!==void 0?n:0,d=(s=(o=a==null?void 0:a.echoReturnLossEnhancement)!==null&&o!==void 0?o:t.echoReturnLossEnhancement)!==null&&s!==void 0?s:0;i.aecReturnLoss=c,i.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(t,e,i){var n,r,s,o,a,c,d;const l=e?this.report.get(e):void 0,u=(n=l==null?void 0:l.removedSamplesForAcceleration)!==null&&n!==void 0?n:t.removedSamplesForAcceleration,h=(r=l==null?void 0:l.totalSamplesReceived)!==null&&r!==void 0?r:t.totalSamplesReceived,p=(s=l==null?void 0:l.jitterBufferDelay)!==null&&s!==void 0?s:t.jitterBufferDelay,T=(o=l==null?void 0:l.jitterBufferEmittedCount)!==null&&o!==void 0?o:t.jitterBufferEmittedCount,m=(a=l==null?void 0:l.audioLevel)!==null&&a!==void 0?a:t==null?void 0:t.audioLevel,f=(c=l==null?void 0:l.totalSamplesDuration)!==null&&c!==void 0?c:t==null?void 0:t.totalSamplesDuration,R=(d=l==null?void 0:l.concealedSamples)!==null&&d!==void 0?d:t.concealedSamples;if(u&&h&&(i.accelerateRate=u/h),p&&T){const A=this.lastAudioJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let O=A.jitterBufferMs;const w=T-A.jitterBufferEmittedCount;w>0&&(O=1e3*(p-A.jitterBufferDelay)/w),i.jitterBufferMs=Math.round(O),this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:T,jitterBufferMs:i.jitterBufferMs})}i.outputLevel=m;let v=1920;f&&h&&(v=h/f/50,i.receivedFrames=Math.round(h/v)),R&&(i.droppedFrames=Math.round(R/v))}processRemoteInboundStats(t,e){const i=this.report.get(t);i&&(e.packetsLost=i.packetsLost,i.roundTripTime&&(e.rttMs=1e3*i.roundTripTime),i.jitter&&(e.jitterMs=1e3*i.jitter),i.timestamp&&(e.timestamp=i.timestamp))}getCodecFromCodecStats(t){const e=this.report.get(t);if(!e)return"";const i=e.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let t=0,e=null,i=null;this.mediaBytesSent.forEach(r=>{t+=r.diffMean()}),this.mediaBytesRetransmit.forEach(r=>{e=e===null?r.diffMean():e+r.diffMean()}),this.mediaBytesTargetEncode.forEach(r=>{i=i===null?r.diffMean():i+r.diffMean()});const n=e!==null?t-e:t;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*t/(this.options.updateInterval/1e3)},e!==null&&(this._stats.bitrate.retransmit=8*e/(this.options.updateInterval/1e3)),i!==null&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}},xG=class extends SE{updateStats(){return G.resolve()}};function vE(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const s=function(){const o=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return o&&o[0]?Number(o[0].split("/")[1]):null}();return s?s<76?new UG(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r}):new oy(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r}):function(o){if(!window.RTCStatsReport)return!1;const a=o.getStats();return!!(a instanceof G||function(c){return!!c&&(typeof c=="object"||typeof c=="function")&&typeof c.then=="function"}(a))}(t)?new oy(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r}):new xG(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r})}const ay="websdk_ng_install_id";function CE(){try{if(C("INSTALL_ID"))return C("INSTALL_ID");let t=window.localStorage.getItem(ay);return t||(t=ks(),window.localStorage.setItem(ay,t)),Ot("INSTALL_ID",t),t}catch{return}}const Zi=function(t){if(t.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return t;const e=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(e&&e[1]&&e[2]){const i=e[1],n=e[2];return"".concat(i,".").concat(n)}return"4.0.0.999"}("4.23.1"),IE=function(){try{return JSON.parse("true")===!0}catch{return!0}}();let Ms=function(t){return t.Default="default",t.Auto="auto",t.Relay="relay",t.SdRtn="sd-rtn",t}({});const je=function(){const t="us".concat("erna","me"),e="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");const n=i.join(""),r=[];for(let a=0;a<6;a++)r.push("1");const s=r.join(""),o={};return o[t]=n,o[e]=s,Object.assign(o,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=je;const ql={ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:2,ENABLE_AUT_FEEDBACK:!1,SVC_EXTENDED:["VP9"]},yE={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},AE="v4.23.1-0-gea45199f-dirty(1/16/2025, 3:18:04 PM)",bE={ENABLE_EVENT_REPORT:!0,UPLOAD_LOG:!1,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,ENABLE_PRELOAD:!0,NEW_ICE_RESTART:!1,ICE_RESTART_INTERVAL:1e4,RESTART_SEQUENCE:["udp_tcp_relay","relay"]},zt=Y(Y(Y({},bE),{},{PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,FINGERPRINT:null,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ENABLE_AUDIO_TOPN:!1,ENABLE_AUDIO_METADATA:!1,TOPN_SMOOTH_LEVEL:void 0,TOPN_NEW_SPEAKER_DELAY:void 0,TOPN_SWITCH_HOLD_MS:void 0,TOPN_AUDIO_GAIN:void 0,TOPN_SILENCE_THRESHOLD:250,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:yE,CUSTOM_ADAPTATION_DEFAULT_MODE:"",HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,DISABLE_SCREEN_SHARE_REMB:!1},ql),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,ENABLE_ROLE_SELECT_EDGE:!1,CLIENT_ROLE_OPTIONS:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"],LIMIT_BITRATE:void 0,EXPERIMENTS:{},USE_PUB_RTX:!0,USE_SUB_RTX:!0,ENABLE_DATASTREAM_2:!1,USE_XR:!0,ENABLE_PREALLOC_PC:!1,ENABLE_PRE_SUB:!1,ENABLE_SVC:!1},{INSTALL_ID:""});function Ot(t,e,i){var n,r,s;B(n=Object.keys(zt)).call(n,t)&&(!i&&B(r=Object.keys(xn)).call(r,t)||(zt[t]=e,t!=="ENABLE_VIDEO_SEI"&&t!=="ENABLE_AUDIO_TOPN"&&t!=="ENABLE_AUDIO_METADATA"||e!==!0||(zt.ENABLE_ENCODED_TRANSFORM=!0),t==="USE_NEW_NETWORK_CONFIG"&&e&&(s=!!e,zt.USE_NEW_NETWORK_CONFIG=s,s&&(zt.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],zt.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],zt.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],zt.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],zt.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",zt.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",zt.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),t==="ENABLE_PRE_SUB"&&e&&(zt.ENABLE_INSTANT_VIDEO=!0,zt.ENABLE_PREALLOC_PC=!0),t==="ENABLE_SVC"&&e&&(zt.ENABLE_AUT_CC=!0)))}function C(t){return zt[t]}IE||(zt.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],zt.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],zt.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],zt.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],zt.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],zt.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],zt.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",zt.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",zt.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",zt.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",zt.AREAS=["NORTH_AMERICA","OVERSEA"]);let cy=function(t){return t[t.REALTIME=1]="REALTIME",t}({});const xn={};var lt=function(t){return t.SET_SESSION_ID="SET_SESSION_ID",t.SET_P2P_ID="SET_P2P_id",t.SET_DC_ID="SET_DC_id",t.SET_UID="SET_UID",t.SET_INT_UID="SET_INT_UID",t.SET_PUB_ID="SET_PUB_ID",t.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",t.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",t.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",t.AVOID_JOIN_START="AVOID_JOIN_START",t.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",t.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",t.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",t.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",t.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",t.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",t.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",t.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",t.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",t.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",t.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",t.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",t.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",t.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",t.RESET_KEY_METRICS="RESET_KEY_METRICS",t.SET_USE_P2P="SET_USE_P2P",t.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",t}(lt||{});let VG=class{constructor(t,e,i,n){rt(this,"state",void 0),this.state={codec:t,audioCodec:e,mode:i,clientId:n,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:Ms.Default,hasStartJoinChannel:!1,isABTestSuccess:!1}}dispatch(t){this.state=function(e,i){switch(i.type){case lt.SET_SESSION_ID:return Y(Y({},e),{},{sessionId:i.sessionId});case lt.SET_P2P_ID:return Y(Y({},e),{},{p2pId:i.p2pId});case lt.SET_UID:return Y(Y({},e),{},{uid:i.uid});case lt.SET_INT_UID:return Y(Y({},e),{},{intUid:i.intUid});case lt.SET_PUB_ID:return Y(Y({},e),{},{pubId:i.pubId});case lt.KEY_METRIC_CLIENT_CREATED:return Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{clientCreated:i.metric})});case lt.KEY_METRIC_JOIN_START:return Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{joinStart:i.metric})});case lt.AVOID_JOIN_START:return Y(Y({},e),{},{avoidJoinStart:i.avoidJoinStart});case lt.KEY_METRIC_JOIN_END:return Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{joinEnd:i.metric})});case lt.KEY_METRIC_REQUEST_AP_START:return Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{requestAPStart:i.metric})});case lt.KEY_METRIC_REQUEST_AP_END:return Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{requestAPEnd:i.metric})});case lt.KEY_METRIC_JOIN_GATEWAY_START:return Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{joinGatewayStart:i.metric})});case lt.KEY_METRIC_JOIN_GATEWAY_END:return Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{joinGatewayEnd:i.metric})});case lt.KEY_METRIC_PEER_CONNECTION_START:return Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{peerConnectionStart:i.metric})});case lt.KEY_METRIC_PEER_CONNECTION_END:return Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{peerConnectionEnd:i.metric})});case lt.KEY_METRIC_DESCRIPTION_START:return Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{descriptionStart:i.metric})});case lt.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{signalChannelOpen:i.metric})});case lt.KEY_METRIC_ICE_CONNECTION_END:return Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{iceConnectionEnd:i.metric})});case lt.KEY_METRIC_PUBLISH:{const n=e.keyMetrics.publish,r=n.findIndex(s=>s.trackId===i.metric.trackId);return r!==-1?(n[r]=Y(Y({},n[r]),i.metric),Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{publish:[...n]})})):Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{publish:[...e.keyMetrics.publish,i.metric]})})}case lt.KEY_METRIC_SUBSCRIBE:{const n=e.keyMetrics.subscribe,r=n.findIndex(s=>s.userId===i.metric.userId&&s.type===i.metric.type);return r!==-1?(n[r]=Y(Y({},n[r]),i.metric),Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{subscribe:[...n]})})):Y(Y({},e),{},{keyMetrics:Y(Y({},e.keyMetrics),{},{subscribe:[...e.keyMetrics.subscribe,i.metric]})})}case lt.SET_CLOUD_PROXY_SERVER_MODE:return e.cloudProxyServerMode=i.mode,e;case lt.RECORD_JOIN_CHANNEL_SERVICE:return typeof i.index!="number"?e.joinChannelServiceRecords=[...e.joinChannelServiceRecords,i.record]:(e.joinChannelServiceRecords[i.index]=Y(Y({},e.joinChannelServiceRecords[i.index]),i.record),e.joinChannelServiceRecords=[...e.joinChannelServiceRecords]),e;case lt.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return e.joinChannelServiceRecords=[],e;case lt.RESET_KEY_METRICS:return e.keyMetrics={publish:[],subscribe:[]},e;case lt.SET_USE_P2P:return Y(Y({},e),{},{useP2P:i.val});case lt.SET_TRANSPORT_TYPE:return Y(Y({},e),{},{p2pTransport:i.val});default:return e}}(this.state,t)}set sessionId(t){this.dispatch({type:lt.SET_SESSION_ID,sessionId:t})}get sessionId(){return this.state.sessionId}set cid(t){this.state.cid=t}get cid(){return this.state.cid}set codec(t){this.state.codec=t}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(t){this.dispatch({type:lt.SET_P2P_ID,p2pId:t})}get p2pId(){return this.state.p2pId}set dcId(t){this.dispatch({type:lt.SET_DC_ID,dcId:t})}get dcId(){return this.state.dcId}set uid(t){this.dispatch({type:lt.SET_UID,uid:t})}get uid(){return this.state.uid}set intUid(t){this.dispatch({type:lt.SET_INT_UID,intUid:t})}get intUid(){return this.state.intUid}set pubId(t){this.dispatch({type:lt.SET_PUB_ID,pubId:t})}get pubId(){return this.state.pubId}set cloudProxyServerMode(t){this.dispatch({type:lt.SET_CLOUD_PROXY_SERVER_MODE,mode:t})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(t){this.dispatch({type:lt.SET_USE_P2P,val:t})}get useP2P(){return this.state.useP2P}set p2pTransport(t){this.dispatch({type:lt.SET_TRANSPORT_TYPE,val:t})}get p2pTransport(){return this.state.p2pTransport}set hasStartJoinChannel(t){this.state.hasStartJoinChannel=t}get hasStartJoinChannel(){return this.state.hasStartJoinChannel}set isABTestSuccess(t){this.state.isABTestSuccess=t}get isABTestSuccess(){return this.state.isABTestSuccess}clientCreated(){this.dispatch({type:lt.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:lt.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:lt.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:lt.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:lt.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:lt.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:lt.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:lt.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:lt.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:lt.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:lt.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:lt.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(t,e,i,n){this.dispatch({type:lt.KEY_METRIC_PUBLISH,metric:Y(Y({trackId:t,type:e},i&&{publishStart:i}),n&&{publishEnd:n})})}subscribe(t,e,i,n,r,s,o){this.dispatch({type:lt.KEY_METRIC_SUBSCRIBE,metric:Y(Y(Y(Y(Y({userId:t,type:e},i&&{subscribeStart:i}),n&&{subscribeEnd:n}),r&&{firstFrame:r}),s&&{streamAdded:s}),o&&{firstDecoded:o})})}massSubscribe(t,e,i,n){t.forEach(r=>{this.dispatch({type:lt.KEY_METRIC_SUBSCRIBE,metric:Y(Y(Y({userId:r.userId,type:r.type},e&&{subscribeStart:e}),i&&{subscribeEnd:i}),n&&{firstFrame:n})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(t,e){t.service==="gateway"&&Array.isArray(t.urls)&&(t.urls=t.urls.map(i=>i.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof e!="number"?(this.dispatch({type:lt.RECORD_JOIN_CHANNEL_SERVICE,record:Y(Y({},t),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(e<0||e>=this.state.joinChannelServiceRecords.length||this.dispatch({type:lt.RECORD_JOIN_CHANNEL_SERVICE,record:t,index:e}),e)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:lt.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:lt.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(t){this.dispatch({type:lt.AVOID_JOIN_START,avoidJoinStart:t})}},zl=function(t){return t.h264="h264",t.h265="h265",t.vp8="vp8",t.vp9="vp9",t.av1="av1",t}({});(function(t){t.opus="opus",t.pcma="pcma",t.pcmu="pcmu",t.g722="g722"})({});let FG=0;var dy=(()=>{var t={8:(n,r,s)=>{s.r(r),s.d(r,{Parser:()=>W,Printer:()=>ce,parse:()=>F,print:()=>X});const o=`
`,a="".concat("\r").concat(o),c=" ";let d;function l(M){return M>="0"&&M<="9"}function u(M){return M>="!"&&M<="~"}function h(M){return u(M)||M>=""&&M<="ÿ"}function p(M){return M==="!"||M>="#"&&M<="'"||M>="*"&&M<="+"||M>="-"&&M<="."||M>="0"&&M<="9"||M>="A"&&M<="Z"||M>="^"&&M<="~"}function T(M){return M>="1"&&M<="9"}function m(M){return M>="A"&&M<="Z"||M>="a"&&M<="z"}function f(M){return M==="d"||M==="h"||M==="m"||M==="s"}function R(M){return M>""&&M<"	"||M>"\v"&&M<"\f"||M>""&&M<"ÿ"}function v(M){return m(M)||l(M)||M==="+"||M==="/"}function A(M){return l(M)||m(M)||M==="+"||M==="/"||M==="-"||M==="_"}function O(M){return m(M)||l(M)||M==="+"||M==="/"}function w(M,E){var I=Object.keys(M);if(Object.getOwnPropertySymbols){var y=Object.getOwnPropertySymbols(M);E&&(y=y.filter(function(V){return Object.getOwnPropertyDescriptor(M,V).enumerable})),I.push.apply(I,y)}return I}function b(M){for(var E=1;E<arguments.length;E++){var I=arguments[E]!=null?arguments[E]:{};E%2?w(Object(I),!0).forEach(function(y){L(M,y,I[y])}):Object.getOwnPropertyDescriptors?Object.defineProperties(M,Object.getOwnPropertyDescriptors(I)):w(Object(I)).forEach(function(y){Object.defineProperty(M,y,Object.getOwnPropertyDescriptor(I,y))})}return M}function L(M,E,I){return E in M?Object.defineProperty(M,E,{value:I,enumerable:!0,configurable:!0,writable:!0}):M[E]=I,M}(function(M){M.VERSION="v",M.ORIGIN="o",M.SESSION_NAME="s",M.INFORMATION="i",M.URI="u",M.EMAIL="e",M.PHONE="p",M.CONNECTION="c",M.BANDWIDTH="b",M.TIME="t",M.REPEAT="r",M.ZONE_ADJUSTMENTS="z",M.KEY="k",M.ATTRIBUTE="a",M.MEDIA="m"})(d||(d={}));class x{consumeText(E,I){let y=I;for(;y<E.length;){const V=E[y];if(V==="\0"||V==="\r"||V===o)break;y+=1}if(y-I==0)throw new Error("Invalid text, at ".concat(E));return y}consumeUnicastAddress(E,I,y){return this.consumeTill(E,I,c)}consumeOneOrMore(E,I,y){let V=I;for(;y(E[V]);)V++;if(V-I==0)throw new Error("Invalid rule at ".concat(I,"."));return V}consumeSpace(E,I){if(E[I]===c)return I+1;throw new Error("Invalid space at ".concat(I,"."))}consumeIP4Address(E,I){let y=I;for(let V=0;V<4;V++)if(y=this.consumeDecimalUChar(E,y),V!==3){if(E[y]!==".")throw new Error("Invalid IP4 address.");y++}return y}consumeDecimalUChar(E,I){let y=I;for(let st=0;st<3&&l(E[y]);st++,y++);if(y-I==0)throw new Error("Invalid decimal uchar.");const V=parseInt(E.slice(I,y));if(V>=0&&V<=255)return y;throw new Error("Invalid decimal uchar")}consumeIP6Address(E,I){let y=this.consumeHexpart(E,I);return E[y]===":"&&(y+=1,y=this.consumeIP4Address(E,y)),y}consumeHexpart(E,I){let y=I;if(E[y]===":"&&E[y+1]===":"){y+=2;try{y=this.consumeHexseq(E,y)}catch{}return y}if(y=this.consumeHexseq(E,y),E[y]===":"&&E[y+1]===":"){y+=2;try{y=this.consumeHexseq(E,y)}catch{}return y}return y}consumeHexseq(E,I){let y=I;for(;y=this.consumeHex4(E,y),E[y]===":"&&E[y+1]!==":";)y+=1;return y}consumeHex4(E,I){let y=0;for(;y<4;y++)if(!((V=E[I+y])>="0"&&V<="9"||V>="a"&&V<="f"||V>="A"&&V<="F")){if(y===0)throw new Error("Invalid hex 4");break}var V;return I+y}consumeFQDN(E,I){let y=I;for(;l(E[y])||m(E[y])||E[y]==="-"||E[y]===".";)y+=1;if(y-I<4)throw new Error("Invalid FQDN");return y}consumeExtnAddr(E,I){return this.consumeOneOrMore(E,I,h)}consumeMulticastAddress(E,I,y){switch(y){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(E,I);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(E,I);default:try{return this.consumeFQDN(E,I)}catch{return this.consumeExtnAddr(E,I)}}}consumeIP6MulticastAddress(E,I){const y=this.consumeHexpart(E,I);return E[y]==="/"?this.consumeInteger(E,y+1):y}consumeIP4MulticastAddress(E,I){let y=I+3;const V=E.slice(I,y),st=parseInt(V);if(st<224||st>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let Lt=0;Lt<3;Lt++){if(E[y]!==".")throw new Error("Invalid IP4 multicast address.");y+=1,y=this.consumeDecimalUChar(E,y)}return E[y]==="/"&&(y+=1),y=this.consumeTTL(E,y),E[y]==="/"&&(y=this.consumeInteger(E,y)),y}consumeInteger(E,I){if(!T(E[I]))throw new Error("Invalid integer.");for(I+=1;l(E[I]);)I+=1;return I}consumeTTL(E,I){if(E[I]==="0")return I+1;if(!T(E[I]))throw new Error("Invalid TTL.");I+=1;for(let y=0;y<2&&l(E[I]);y++)I+=1;return I}consumeToken(E,I){return this.consumeOneOrMore(E,I,p)}consumeTime(E,I){let y=I;if(E[y]==="0")return y+1;for(T(E[y])&&(y+=1);l(E[y]);)y++;if(y-I<10)throw new Error("Invalid time");return y}consumeAddress(E,I){return this.consumeTill(E,I,c)}consumeTypedTime(E,I){let y=I;return y=this.consumeOneOrMore(E,y,l),f(E[y])?y+1:y}consumeRepeatInterval(E,I){if(!T(E[I]))throw new Error("Invalid repeat interval");for(I+=1;l(E[I]);)I+=1;return f(E[I])&&(I+=1),I}consumePort(E,I){return this.consumeOneOrMore(E,I,l)}consume(E,I,y){for(let V=0;V<y.length;V++){if(I+V>=E.length)throw new Error("consume exceeding value length");if(E[I+V]!==y[V])throw new Error("consume ".concat(y," failed at ").concat(V))}return I+y.length}consumeTill(E,I,y){let V=I;for(;V<E.length&&(typeof y!="string"||E[V]!==y)&&(typeof y!="function"||!y(E[V]));)V++;return V}}class W extends x{constructor(){super(),L(this,"records",[]),L(this,"currentLine",0)}parse(E){const I=this.probeEOL(E);this.records=E.split(I).filter(ro=>!!Xe(ro).call(ro)).map(this.parseLine),this.currentLine=0;const y=this.parseVersion(),V=this.parseOrigin(),st=this.parseSessionName(),Lt=this.parseInformation(),be=this.parseUri(),Ii=this.parseEmail(),Mr=this.parsePhone(),no=this.parseConnection(),id=this.parseBandWidth(),th=this.parseTimeFields(),eh=this.parseKey(),an=this.parseSessionAttribute(),_s=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:y,origin:V,sessionName:st,information:Lt,uri:be,emails:Ii,phones:Mr,connection:no,bandwidths:id,timeFields:th,key:eh,attributes:an,mediaDescriptions:_s}}getCurrentRecord(){const E=this.records[this.currentLine];if(!E)throw new Error("Record doesn't exit.");return E}probeEOL(E){for(let I=0;I<E.length;I++)if(E[I]===o)return E[I-1]==="\r"?a:o;throw new Error("Invalid newline character.")}parseLine(E,I){if(E.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const y=E[0];if(E[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:y,value:E.slice(2),line:I,cur:0}}parseSessionAttribute(){const E=new ht;for(;this.currentLine<this.records.length;){const I=this.getCurrentRecord();if(I.type!==d.ATTRIBUTE)break;const y={attField:this.extractOneOrMore(I,V=>p(V)&&V!==":"),_cur:0};I.value[I.cur]===":"&&(I.cur+=1,y.attValue=this.extractOneOrMore(I,R)),E.parse(y),this.currentLine++}return E.digest()}parseMediaAttributes(E){const I=new pt(E);for(;this.currentLine<this.records.length;){const y=this.getCurrentRecord();if(y.type!==d.ATTRIBUTE)break;const V={attField:this.extractOneOrMore(y,st=>p(st)&&st!==":"),_cur:0};y.value[y.cur]===":"&&(y.cur+=1,V.attValue=this.extractOneOrMore(y,R)),I.parse(V),this.currentLine++}return I.digest()}parseKey(){const E=this.getCurrentRecord();if(E.type===d.KEY){if(E.value==="prompt"||E.value==="clear:"||E.value==="base64:"||E.value==="uri:")return E.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const E=this.getCurrentRecord();if(E.type===d.ZONE_ADJUSTMENTS){const I=[];for(;;)try{const y=this.extract(E,this.consumeTime);this.consumeSpaceForRecord(E);let V=!1;E.value[E.cur]==="-"&&(V=!0,E.cur+=1);const st=this.extract(E,this.consumeTypedTime);I.push({time:y,typedTime:st,back:V})}catch{break}if(I.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,I}return[]}parseRepeat(){const E=[];for(;;){const I=this.getCurrentRecord();if(I.type!==d.REPEAT)break;{const y=this.extract(I,this.consumeRepeatInterval),V=this.parseTypedTime(I);E.push({repeatInterval:y,typedTimes:V}),this.currentLine++}}return E}parseTypedTime(E){const I=[];for(;;)try{this.consumeSpaceForRecord(E),I.push(this.extract(E,this.consumeTypedTime))}catch{break}if(I.length===0)throw new Error("Invalid typed time.");return I}parseTime(){const E=this.getCurrentRecord(),I=this.extract(E,this.consumeTime);this.consumeSpaceForRecord(E);const y=this.extract(E,this.consumeTime);return this.currentLine++,{startTime:I,stopTime:y}}parseBandWidth(){const E=[];for(;this.currentLine<this.records.length;){const I=this.getCurrentRecord();if(I.type!==d.BANDWIDTH)break;{const y=this.extractOneOrMore(I,p);if(I.value[I.cur]!==":")throw new Error("Invalid bandwidth field.");I.cur++;const V=this.extractOneOrMore(I,l);E.push({bwtype:y,bandwidth:V}),this.currentLine++}}return E}parseVersion(){const E=this.getCurrentRecord();if(E.type!==d.VERSION)throw new Error("first sdp record must be version");const I=E.value.slice(0,this.consumeOneOrMore(E.value,0,l));if(I.length!==E.value.length)throw new Error('invalid proto version, "v='.concat(E.value,'"'));return this.currentLine++,I}parseOrigin(){const E=this.getCurrentRecord();if(E.type!==d.ORIGIN)throw new Error("second line of sdp must be origin");const I=this.extractOneOrMore(E,h);this.consumeSpaceForRecord(E);const y=this.extractOneOrMore(E,l);this.consumeSpaceForRecord(E);const V=this.extractOneOrMore(E,l);this.consumeSpaceForRecord(E);const st=this.extractOneOrMore(E,p);this.consumeSpaceForRecord(E);const Lt=this.extractOneOrMore(E,p);this.consumeSpaceForRecord(E);const be=this.extract(E,this.consumeUnicastAddress);return this.currentLine++,{username:I,sessId:y,sessVersion:V,nettype:st,addrtype:Lt,unicastAddress:be}}parseSessionName(){const E=this.getCurrentRecord();if(E.type===d.SESSION_NAME){const I=this.extract(E,this.consumeText);return this.currentLine++,I}}parseInformation(){const E=this.getCurrentRecord();if(E.type!==d.INFORMATION)return;const I=this.extract(E,this.consumeText);return this.currentLine++,I}parseUri(){const E=this.getCurrentRecord();if(E.type===d.URI)return this.currentLine++,E.value}parseEmail(){const E=[];for(;;){const I=this.getCurrentRecord();if(I.type!==d.EMAIL)break;E.push(I.value),this.currentLine++}return E}parsePhone(){const E=[];for(;;){const I=this.getCurrentRecord();if(I.type!==d.PHONE)break;E.push(I.value),this.currentLine++}return E}parseConnection(){const E=this.getCurrentRecord();if(E.type===d.CONNECTION){const I=this.extractOneOrMore(E,p);this.consumeSpaceForRecord(E);const y=this.extractOneOrMore(E,p);this.consumeSpaceForRecord(E);const V=this.extract(E,this.consumeAddress);return this.currentLine++,{nettype:I,addrtype:y,address:V}}}parseMedia(){const E=this.getCurrentRecord(),I=this.extract(E,this.consumeToken);this.consumeSpaceForRecord(E);let y=this.extract(E,this.consumePort);E.value[E.cur]==="/"&&(E.cur+=1,y+=this.extract(E,this.consumeInteger)),this.consumeSpaceForRecord(E);const V=[];for(V.push(this.extract(E,this.consumeToken));E.value[E.cur]==="/";)E.cur+=1,V.push(this.extract(E,this.consumeToken));if(V.length===0)throw new Error("Invalid proto");const st=this.parseFmt(E);return this.currentLine++,{mediaType:I,port:y,protos:V,fmts:st}}parseTimeFields(){const E=[];for(;this.getCurrentRecord().type===d.TIME;){const I=this.parseTime(),y=this.parseRepeat(),V=this.parseZone();E.push({time:I,repeats:y,zones:V})}return E}parseMediaDescription(){const E=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.MEDIA;){const I=this.parseMedia(),y=this.parseInformation(),V=this.parseConnections(),st=this.parseBandWidth(),Lt=this.parseKey(),be=this.parseMediaAttributes(I);E.push({media:I,information:y,connections:V,bandwidths:st,key:Lt,attributes:be})}return E}parseConnections(){const E=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.CONNECTION;)E.push(this.parseConnection());return E}parseFmt(E){const I=[];for(;;)try{this.consumeSpaceForRecord(E),I.push(this.extract(E,this.consumeToken))}catch{break}if(I.length===0)throw new Error("Invalid fmts");return I}extract(E,I){for(var y=arguments.length,V=new Array(y>2?y-2:0),st=2;st<y;st++)V[st-2]=arguments[st];const Lt=I.call(this,E.value,E.cur,...V),be=E.value.slice(E.cur,Lt);return E.cur=Lt,be}extractOneOrMore(E,I){const y=this.consumeOneOrMore(E.value,E.cur,I),V=E.value.slice(E.cur,y);return E.cur=y,V}consumeSpaceForRecord(E){if(E.value[E.cur]!==c)throw new Error("Invalid space at ".concat(E.cur,"."));E.cur+=1}}class K extends x{constructor(){super(...arguments),L(this,"attributes",void 0),L(this,"digested",!1)}extractOneOrMore(E,I,y){const V=this.consumeOneOrMore(E.attValue,E._cur,I),st=E.attValue.slice(E._cur,V),[Lt,be]=y||[];if(typeof Lt=="number"&&st.length<Lt)throw new Error("error in length, should be more or equal than ".concat(Lt," characters."));if(typeof be=="number"&&st.length>be)throw new Error("error in length, should be less or equal than ".concat(be," characters."));return E._cur=V,st}consumeAttributeSpace(E){if(E.attValue[E._cur]!==c)throw new Error("Invalid space at ".concat(E._cur,"."));E._cur+=1}extract(E,I){if(!E.attValue)throw new Error("Nothing to extract from attValue.");for(var y=arguments.length,V=new Array(y>2?y-2:0),st=2;st<y;st++)V[st-2]=arguments[st];const Lt=I.call(this,E.attValue,E._cur,...V),be=E.attValue.slice(E._cur,Lt);return E._cur=Lt,be}atEnd(E){if(!E.attValue)throw new Error;return E._cur>=E.attValue.length}peekChar(E){if(!E.attValue)throw new Error;return E.attValue[E._cur]}peek(E,I){if(!E.attValue)throw new Error;for(let y=0;y<I.length;y++)if(I[y]!==E.attValue[E._cur+y])return!1;return!0}parseIceUfrag(E){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(E,v,[4,256])}parseIcePwd(E){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(E,v,[22,256])}parseIceOptions(E){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const I=[];for(;!this.atEnd(E);){I.push(this.extractOneOrMore(E,v));try{this.consumeAttributeSpace(E)}catch(y){if(this.atEnd(E))break;throw y}}this.attributes.iceOptions=I}parseFingerprint(E){const I=this.extract(E,this.consumeToken);this.consumeAttributeSpace(E);const y=this.extract(E,this.consumeTill);this.attributes.fingerprints.push({hashFunction:I,fingerprint:y})}parseExtmap(E){const I=this.extractOneOrMore(E,l);let y;this.peekChar(E)==="/"&&(this.extract(E,this.consume,"/"),y=this.extract(E,this.consumeToken)),this.consumeAttributeSpace(E);const V=this.extract(E,this.consumeTill,c),st=b(b({entry:parseInt(I,10)},y&&{direction:y}),{},{extensionName:V});this.peekChar(E)===c&&(this.consumeAttributeSpace(E),st.extensionAttributes=this.extract(E,this.consumeTill)),this.attributes.extmaps.push(st)}parseSetup(E){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const I=this.extract(E,this.consumeTill);if(I!=="active"&&I!=="passive"&&I!=="actpass"&&I!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=I}}class ht extends K{constructor(){super(...arguments),L(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(E){if(this.digested)throw new Error("already digested");try{switch(E.attField){case"group":this.parseGroup(E);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(E);break;case"ice-pwd":this.parseIcePwd(E);break;case"ice-options":this.parseIceOptions(E);break;case"fingerprint":this.parseFingerprint(E);break;case"setup":this.parseSetup(E);break;case"tls-id":this.parseTlsId(E);break;case"identity":this.parseIdentity(E);break;case"extmap":this.parseExtmap(E);break;case"msid-semantic":this.parseMsidSemantic(E);break;default:E.ignored=!0,this.attributes.unrecognized.push(E)}}catch(I){throw console.error("parsing session attribute ".concat(E.attField,' error, "a=').concat(E.attField,":").concat(E.attValue,'"')),I}if(!E.ignored&&E.attValue&&!this.atEnd(E))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(E){const I=this.extract(E,this.consumeToken),y=[];for(;!this.atEnd(E)&&this.peekChar(E)===c;)this.consumeAttributeSpace(E),y.push(this.extract(E,this.consumeToken));this.attributes.groups.push({semantic:I,identificationTag:y})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(E){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(E,A)}parseIdentity(E){const I=this.extractOneOrMore(E,O),y=[];for(;!this.atEnd(E)&&this.peekChar(E)===c;){this.consumeAttributeSpace(E);const V=this.extract(E,this.consumeToken);this.extract(E,this.consume,"=");const st=this.extractOneOrMore(E,Lt=>Lt!==c&&R(Lt));y.push({name:V,value:st})}this.attributes.identities.push({assertionValue:I,extensions:y})}parseMsidSemantic(E){this.peekChar(E)===c&&this.consumeAttributeSpace(E);const I={semantic:this.extract(E,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(E)}catch{break}if(this.peekChar(E)==="*"){this.extract(E,this.consume,"*"),I.applyForAll=!0;break}{const y=this.extract(E,this.consumeTill,c);I.identifierList.push(y)}}this.attributes.msidSemantic=I}}class pt extends K{constructor(E){super(),L(this,"attributes",void 0),E.protos.indexOf("RTP")!==-1||E.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(E){if(this.digested)throw new Error("already digested");try{switch(E.attField){case"extmap":this.parseExtmap(E);break;case"setup":this.parseSetup(E);break;case"ice-ufrag":this.parseIceUfrag(E);break;case"ice-pwd":this.parseIcePwd(E);break;case"ice-options":this.parseIceOptions(E);break;case"candidate":this.parseCandidate(E);break;case"remote-candidate":this.parseRemoteCandidate(E);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(E);break;case"rtpmap":this.parseRtpmap(E);break;case"ptime":this.parsePtime(E);break;case"maxptime":this.parseMaxPtime(E);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(E);break;case"ssrc":this.parseSSRC(E);break;case"fmtp":this.parseFmtp(E);break;case"rtcp-fb":this.parseRtcpFb(E);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(E);break;case"mid":this.parseMid(E);break;case"msid":this.parseMsid(E);break;case"imageattr":this.parseImageAttr(E);break;case"rid":this.parseRid(E);break;case"simulcast":this.parseSimulcast(E);break;case"sctp-port":this.parseSctpPort(E);break;case"max-message-size":this.parseMaxMessageSize(E);break;case"ssrc-group":this.parseSSRCGroup(E);break;default:E.ignored=!0,this.attributes.unrecognized.push(E)}}catch(I){throw console.error("parsing media attribute ".concat(E.attField,' error, "a=').concat(E.attField,":").concat(E.attValue,'"')),I}if(!E.ignored&&E.attValue&&!this.atEnd(E))throw new Error("attribute parsing error")}parseCandidate(E){const I=this.extractOneOrMore(E,v,[1,32]);this.consumeAttributeSpace(E);const y=this.extractOneOrMore(E,l,[1,5]);this.consumeAttributeSpace(E);const V=this.extract(E,this.consumeToken);this.consumeAttributeSpace(E);const st=this.extractOneOrMore(E,l,[1,10]);this.consumeAttributeSpace(E);const Lt=this.extract(E,this.consumeAddress);this.consumeAttributeSpace(E);const be=this.extract(E,this.consumePort);this.consumeAttributeSpace(E),this.extract(E,this.consume,"typ"),this.consumeAttributeSpace(E);const Ii={foundation:I,componentId:y,transport:V,priority:st,connectionAddress:Lt,port:be,type:this.extract(E,this.consumeToken),extension:{}};for(this.peek(E," raddr")&&(this.extract(E,this.consume," raddr"),this.consumeAttributeSpace(E),Ii.relAddr=this.extract(E,this.consumeAddress)),this.peek(E," rport")&&(this.extract(E,this.consume," rport"),this.consumeAttributeSpace(E),Ii.relPort=this.extract(E,this.consumePort));this.peekChar(E)===c;){this.consumeAttributeSpace(E);const Mr=this.extract(E,this.consumeToken);this.consumeAttributeSpace(E),Ii.extension[Mr]=this.extractOneOrMore(E,u)}this.attributes.candidates.push(Ii)}parseRemoteCandidate(E){const I=[];for(;;){const y=this.extractOneOrMore(E,l,[1,5]);this.consumeAttributeSpace(E);const V=this.extract(E,this.consumeAddress);this.consumeAttributeSpace(E);const st=this.extract(E,this.consumePort);I.push({componentId:y,connectionAddress:V,port:st});try{this.consumeAttributeSpace(E)}catch{break}}this.attributes.remoteCandidatesList.push(I)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(E){const I=this.extract(E,this.consumeToken);this.consumeAttributeSpace(E);const y=this.extract(E,this.consumeTill,"/");this.extract(E,this.consume,"/");const V={encodingName:y,clockRate:this.extractOneOrMore(E,l)};this.atEnd(E)||this.peekChar(E)!=="/"||(this.extract(E,this.consume,"/"),V.encodingParameters=parseInt(this.extract(E,this.consumeTill),10));const st=this.attributes.payloads.find(Lt=>Lt.payloadType===parseInt(I,10));st?st.rtpMap=V:this.attributes.payloads.push({payloadType:parseInt(I,10),rtpMap:V,rtcpFeedbacks:[]})}parsePtime(E){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(E,this.consumeTill)}parseMaxPtime(E){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(E,this.consumeTill)}parseDirection(E){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=E.attField}parseSSRC(E){const I=this.extractOneOrMore(E,l);this.consumeAttributeSpace(E);const y=this.extract(E,this.consumeTill,":");let V;this.peekChar(E)===":"&&(this.extract(E,this.consume,":"),V=this.extract(E,this.consumeTill));const st=this.attributes.ssrcs.find(Lt=>Lt.ssrcId===parseInt(I,10));st?st.attributes[y]=V:this.attributes.ssrcs.push({ssrcId:parseInt(I,10),attributes:{[y]:V}})}parseFmtp(E){const I=this.extract(E,this.consumeTill,c);this.consumeAttributeSpace(E);const y=this.extract(E,this.consumeTill),V={};y.split(";").forEach(Lt=>{let[be,Ii]=Lt.split("=");be=Xe(be).call(be);const Mr=typeof Ii=="string"?Xe(Ii).call(Ii):null;typeof be=="string"&&be.length>0&&(V[be]=Mr)});const st=this.attributes.payloads.find(Lt=>Lt.payloadType===parseInt(I,10));st?st.fmtp={parameters:V}:this.attributes.payloads.push({payloadType:parseInt(I,10),rtcpFeedbacks:[],fmtp:{parameters:V}})}parseFmtParameters(E){const I={},y=this.extract(E,this.consumeTill,"=");E._cur++;const V=this.extract(E,this.consumeTill,";");for(I[y]=V;E.attValue[E._cur]===";";){const st=this.extract(E,this.consumeTill,"=");E._cur++;const Lt=this.extract(E,this.consumeTill,";");I[st]=Lt}return I}parseRtcpFb(E){let I="";I=this.peekChar(E)==="*"?this.extract(E,this.consume,"*"):this.extract(E,this.consumeTill,c),this.consumeAttributeSpace(E);const y=this.extract(E,this.consumeTill,c);let V;if(y==="trr-int")V={type:y,interval:this.extract(E,this.consumeTill)};else{const st={type:y};this.peekChar(E)===c&&(this.consumeAttributeSpace(E),st.parameter=this.extract(E,this.consumeToken),this.peekChar(E)===c&&(st.additional=this.extract(E,this.consumeTill))),V=st}if(I==="*")this.attributes.rtcpFeedbackWildcards.push(V);else{const st=this.attributes.payloads.find(Lt=>Lt.payloadType===parseInt(I,10));st?st.rtcpFeedbacks.push(V):this.attributes.payloads.push({payloadType:parseInt(I,10),rtcpFeedbacks:[V]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(E){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const I={port:this.extract(E,this.consumePort)};this.peekChar(E)===c&&(this.consumeAttributeSpace(E),I.netType=this.extractOneOrMore(E,p),this.consumeAttributeSpace(E),I.addressType=this.extractOneOrMore(E,p),this.consumeAttributeSpace(E),I.address=this.extract(E,this.consumeAddress)),this.attributes.rtcp=I}parseMsid(E){const I={id:this.extractOneOrMore(E,p,[1,64])};this.peekChar(E)===c&&(this.consumeAttributeSpace(E),I.appdata=this.extractOneOrMore(E,p,[1,64])),this.attributes.msids.push(I)}parseImageAttr(E){this.attributes.imageattr.push(E.attValue)}parseRid(E){const I=this.extractOneOrMore(E,V=>m(V)||l(V)||V==="_"||V==="-");this.consumeAttributeSpace(E);const y={id:I,direction:this.extract(E,this.consumeToken),params:[]};if(this.peekChar(E)===c){if(this.consumeAttributeSpace(E),this.peek(E,"pt=")){this.extract(E,this.consume,"pt=");const V=[];for(;;){const st=this.extract(E,this.consumeToken);V.push(st);try{this.extract(E,this.consume,",")}catch{break}}y.payloads=V,this.peekChar(E)===c&&this.extract(E,this.consume,c)}for(;;){const V=this.extract(E,this.consumeToken);switch(V){case"depend":{const st={type:V,rids:this.extract(E,this.consume,"=").split(",")};y.params.push(st);break}default:{const st={type:V};this.peekChar(E)==="="&&(this.extract(E,this.consume,"="),st.val=this.extract(E,this.consumeTill,";")),y.params.push(st)}}try{this.extract(E,this.consume,";")}catch{break}}}this.attributes.rids.push(y)}parseSimulcast(E){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=E.attValue,this.extract(E,this.consumeTill)}parseSctpPort(E){this.attributes.sctpPort=this.extractOneOrMore(E,l,[1,5])}parseMaxMessageSize(E){this.attributes.maxMessageSize=this.extractOneOrMore(E,l,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(E){this.attributes.mid=this.extract(E,this.consumeToken)}parseSSRCGroup(E){const I=this.extract(E,this.consumeToken),y=[];for(;;)try{this.consumeAttributeSpace(E);const V=this.extract(E,this.consumeInteger);y.push(parseInt(V,10))}catch{break}this.attributes.ssrcGroups.push({semantic:I,ssrcIds:y})}}function Vt(M,E,I){return E in M?Object.defineProperty(M,E,{value:I,enumerable:!0,configurable:!0,writable:!0}):M[E]=I,M}class ce{constructor(){Vt(this,"eol",a)}print(E,I){let y="";return I&&(this.eol=I),y+=this.printVersion(E.version),y+=this.printOrigin(E.origin),y+=this.printSessionName(E.sessionName),y+=this.printInformation(E.information),y+=this.printUri(E.uri),y+=this.printEmail(E.emails),y+=this.printPhone(E.phones),y+=this.printConnection(E.connection),y+=this.printBandwidth(E.bandwidths),y+=this.printTimeFields(E.timeFields),y+=this.printKey(E.key),y+=this.printSessionAttributes(E.attributes),y+=this.printMediaDescription(E.mediaDescriptions),y}printVersion(E){return"v=".concat(E).concat(this.eol)}printOrigin(E){return"o=".concat(E.username," ").concat(E.sessId," ").concat(E.sessVersion," ").concat(E.nettype," ").concat(E.addrtype," ").concat(E.unicastAddress).concat(this.eol)}printSessionName(E){return E?"s=".concat(E).concat(this.eol):""}printInformation(E){return E?"i=".concat(E).concat(this.eol):""}printUri(E){return E?"u=".concat(E).concat(this.eol):""}printEmail(E){let I="";for(const y of E)I+="e=".concat(y).concat(this.eol);return I}printPhone(E){let I="";for(const y of E)I+="e=".concat(y).concat(this.eol);return I}printConnection(E){return E?"c=".concat(E.nettype," ").concat(E.addrtype," ").concat(E.address).concat(this.eol):""}printBandwidth(E){let I="";for(const y of E)I+="b=".concat(y.bwtype,":").concat(y.bandwidth).concat(this.eol);return I}printTimeFields(E){let I="";for(const y of E){I+="t=".concat(y.time.startTime," ").concat(y.time.startTime).concat(this.eol);for(const V of y.repeats)I+="r=".concat(V.repeatInterval," ").concat(V.typedTimes.join(" ")).concat(this.eol);y.zoneAdjustments&&(I+="z=",I+="z=".concat(y.zoneAdjustments.map(V=>"".concat(V.time," ").concat(V.back?"-":""," ").concat(V.typedTime)).join(" ")).concat(this.eol),I+=this.eol)}return I}printKey(E){return E?"k=".concat(E).concat(this.eol):""}printAttributes(E){let I="";for(const y of E)I+="a=".concat(y.attField).concat(y.attValue?":".concat(y.attValue):"").concat(this.eol);return I}printMediaDescription(E){let I="";for(const y of E)I+=this.printMedia(y.media),I+=this.printInformation(y.information),I+=this.printConnections(y.connections),I+=this.printBandwidth(y.bandwidths),I+=this.printKey(y.key),I+=this.printMediaAttributes(y);return I}printConnections(E){let I="";for(const y of E)I+=this.printConnection(y);return I}printMedia(E){return"m=".concat(E.mediaType," ").concat(E.port," ").concat(E.protos.join("/")," ").concat(E.fmts.join(" ")).concat(this.eol)}printSessionAttributes(E){return new Ei(this.eol).print(E)}printMediaAttributes(E){return new k(this.eol).print(E)}}class ne{constructor(E){Vt(this,"eol",void 0),this.eol=E}printIceUfrag(E){return E===void 0?"":"a=ice-ufrag:".concat(E).concat(this.eol)}printIcePwd(E){return E===void 0?"":"a=ice-pwd:".concat(E).concat(this.eol)}printIceOptions(E){return E===void 0?"":"a=ice-options:".concat(E.join(c)).concat(this.eol)}printFingerprints(E){return E.length>0?E.map(I=>"a=fingerprint:".concat(I.hashFunction).concat(c).concat(I.fingerprint)).join(this.eol)+this.eol:""}printExtmap(E){return E.map(I=>"a=extmap:".concat(I.entry).concat(I.direction?"/".concat(I.direction):"").concat(c).concat(I.extensionName).concat(I.extensionAttributes?"".concat(c).concat(I.extensionAttributes):"").concat(this.eol)).join("")}printSetup(E){return E===void 0?"":"a=setup:".concat(E).concat(this.eol)}printUnrecognized(E){return E.map(I=>"a=".concat(I.attField).concat(I.attValue?":".concat(I.attValue):"").concat(this.eol)).join("")}}class Ei extends ne{print(E){let I="";return I+=this.printGroups(E.groups),I+=this.printMsidSemantic(E.msidSemantic),I+=this.printIceLite(E.iceLite),I+=this.printIceUfrag(E.iceUfrag),I+=this.printIcePwd(E.icePwd),I+=this.printIceOptions(E.iceOptions),I+=this.printFingerprints(E.fingerprints),I+=this.printSetup(E.setup),I+=this.printTlsId(E.tlsId),I+=this.printIdentity(E.identities),I+=this.printExtmap(E.extmaps),I+=this.printUnrecognized(E.unrecognized),I}printGroups(E){let I="";return E.length>0&&(I+=E.map(y=>"a=group:".concat(y.semantic).concat(y.identificationTag.map(V=>"".concat(c).concat(V)).join("")).concat(this.eol)).join("")),I}printIceLite(E){return E===void 0?"":"a=ice-lite"+this.eol}printTlsId(E){return E?"a=tls-id:".concat(E).concat(this.eol):""}printIdentity(E){return E.length===0?"":E.map(I=>"a=identity:".concat(I.assertionValue).concat(I.extensions.map(y=>"".concat(c).concat(y.name).concat(y.value?"=".concat(y.value):"")))).join(this.eol)+this.eol}printMsidSemantic(E){if(!E)return"";let I="a=msid-semantic:".concat(E.semantic);return E.applyForAll?I+="".concat(c,"*"):E.identifierList.length>0&&(I+=E.identifierList.map(y=>"".concat(c).concat(y))),I+this.eol}}class k extends ne{print(E){const I=E.attributes;let y="";return y+=this.printRTCP(I.rtcp),y+=this.printIceUfrag(I.iceUfrag),y+=this.printIcePwd(I.icePwd),y+=this.printIceOptions(I.iceOptions),y+=this.printCandidates(I.candidates),y+=this.printRemoteCandidatesList(I.remoteCandidatesList),y+=this.printEndOfCandidates(I.endOfCandidates),y+=this.printFingerprints(I.fingerprints),y+=this.printSetup(I.setup),y+=this.printMid(I.mid),y+=this.printExtmap(I.extmaps),y+=this.printRTPRelated(I),y+=this.printPtime(I.ptime),y+=this.printMaxPtime(I.maxPtime),y+=this.printDirection(I.direction),y+=this.printSSRCGroups(I.ssrcGroups),y+=this.printSSRC(I.ssrcs),y+=this.printRTCPMux(I.rtcpMux),y+=this.printRTCPMuxOnly(I.rtcpMuxOnly),y+=this.printRTCPRsize(I.rtcpRsize),y+=this.printMSId(I.msids),y+=this.printImageattr(I.imageattr),y+=this.printRid(I.rids),y+=this.printSimulcast(I.simulcast),y+=this.printSCTPPort(I.sctpPort),y+=this.printMaxMessageSize(I.maxMessageSize),y+=this.printUnrecognized(I.unrecognized),y}printCandidates(E){return E.map(I=>"a=candidate:".concat(I.foundation).concat(c).concat(I.componentId).concat(c).concat(I.transport).concat(c).concat(I.priority).concat(c).concat(I.connectionAddress).concat(c).concat(I.port).concat(c,"typ").concat(c).concat(I.type).concat(I.relAddr?"".concat(c,"raddr").concat(c).concat(I.relAddr):"").concat(I.relPort?"".concat(c,"rport").concat(c).concat(I.relPort):"").concat(Object.keys(I.extension).map(y=>"".concat(c).concat(y).concat(c).concat(I.extension[y])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(E){return E.map(I=>"a=remote-candidates:".concat(I.join(c)).concat(this.eol)).join("")}printEndOfCandidates(E){return E===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(E){if(!E.payloads)return"";const I=E.payloads;let y="";y+=E.rtcpFeedbackWildcards.map(V=>this.printRTCPFeedback("*",V)).join("");for(const V of I)y+=this.printRtpMap(V.payloadType,V.rtpMap),y+=this.printFmtp(V.payloadType,V.fmtp),y+=V.rtcpFeedbacks.map(st=>this.printRTCPFeedback(V.payloadType,st)).join("");return y}printFmtp(E,I){if(!I)return"";const y=Object.keys(I.parameters);return y.length===1&&I.parameters[y[0]]===null?"a=fmtp:".concat(E).concat(c).concat(y[0]).concat(this.eol):"a=fmtp:".concat(E).concat(c).concat(Object.keys(I.parameters).map(V=>"".concat(V,"=").concat(I.parameters[V])).join(";")).concat(this.eol)}printRtpMap(E,I){return I?"a=rtpmap:".concat(E).concat(c).concat(I.encodingName,"/").concat(I.clockRate).concat(I.encodingParameters?"/".concat(I.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(E,I){let y="a=rtcp-fb:".concat(E).concat(c),V=I;return V.type==="trr-int"?y+="ttr-int".concat(c).concat(V.interval):(y+="".concat(V.type),V.parameter&&(y+="".concat(c).concat(V.parameter),V.additional&&(y+="".concat(c).concat(V.additional)))),y+this.eol}printPtime(E){return E===void 0?"":"a=ptime:".concat(E).concat(this.eol)}printMaxPtime(E){return E===void 0?"":"a=maxptime:".concat(E).concat(this.eol)}printDirection(E){return E===void 0?"":"a=".concat(E).concat(this.eol)}printSSRC(E){return E.map(I=>Object.keys(I.attributes).map(y=>"a=ssrc:".concat(I.ssrcId.toString(10)).concat(c).concat(y).concat(I.attributes[y]?":".concat(I.attributes[y]):"").concat(this.eol)).join("")).join("")}printRTCPMux(E){return E===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(E){return E===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(E){return E===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(E){if(E===void 0)return"";let I="a=rtcp:".concat(E.port);return E.netType&&(I+="".concat(c).concat(E.netType)),E.addressType&&(I+="".concat(c).concat(E.addressType)),E.address&&(I+="".concat(c).concat(E.address)),I+this.eol}printMSId(E){return E.map(I=>"a=msid:".concat(I.id).concat(I.appdata?"".concat(c).concat(I.appdata):"").concat(this.eol)).join("")}printImageattr(E){return E.map(I=>"a=imageattr:".concat(I).concat(this.eol)).join("")}printRid(E){return E.map(I=>{let y="a=rid:".concat(I.id).concat(c).concat(I.direction);return I.payloads&&(y+="".concat(c,"pt=").concat(I.payloads.join(","))),I.params.length>0&&(y+="".concat(c).concat(I.params.map(V=>V.type==="depend"?"depend=".concat(V.rids.join(",")):"".concat(V.type,"=").concat(V.val)).join(";"))),y+this.eol}).join("")}printSimulcast(E){return E===void 0?"":"a=simulcast:".concat(E).concat(this.eol)}printSCTPPort(E){return E===void 0?"":"a=sctp-port:".concat(E).concat(this.eol)}printMaxMessageSize(E){return E===void 0?"":"a=max-message-size:".concat(E).concat(this.eol)}printMid(E){return E===void 0?"":"a=mid:".concat(E).concat(this.eol)}printSSRCGroups(E){return E.map(I=>"a=ssrc-group:".concat(I.semantic).concat(I.ssrcIds.map(y=>"".concat(c).concat(y.toString(10))).join("")).concat(this.eol)).join("")}}function F(M){return new W().parse(M)}function X(M,E){return new ce().print(M,E)}}},e={};function i(n){if(e[n])return e[n].exports;var r=e[n]={exports:{}};return t[n](r,r.exports,i),r.exports}return i.d=(n,r)=>{for(var s in r)i.o(r,s)&&!i.o(n,s)&&Object.defineProperty(n,s,{enumerable:!0,get:r[s]})},i.o=(n,r)=>Object.prototype.hasOwnProperty.call(n,r),i.r=n=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},i(8)})();function Ti(t){return dy.parse(t)}function Zr(t,e){return dy.print(t,e)}var BG=dn("Array","keys"),jG=mr,GG=He,WG=ei,HG=BG,wE=Array.prototype,KG={DOMTokenList:!0,NodeList:!0},YG=function(t){var e=t.keys;return t===wE||WG(wE,t)&&e===wE.keys||GG(KG,jG(t))?HG:e},Fi=Bt(YG);function Zt(t,e,i){return(e=function(n){var r=function(s){if(typeof s!="object"||!s)return s;var o=s[Symbol.toPrimitive];if(o!==void 0){var a=o.call(s,"string");if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)}(n);return typeof r=="symbol"?r:r+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function ly(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function at(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?ly(Object(i),!0).forEach(function(n){Zt(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):ly(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}const uy=new class extends qt{constructor(){super(...arguments),Zt(this,"currentUploadLogID",0)}reportLogUploadError(t){const{errorRange:e}=t;e[e.length-1]&&e[e.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=e[e.length-1],this.emit("REPORT_LOG_UPLOAD",t))}};class qG{constructor(e){Zt(this,"logger",void 0),Zt(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.logger.debug(...this.prefixLists,...i)}info(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.logger.info(...this.prefixLists,...i)}warning(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.logger.warning(...this.prefixLists,...i)}error(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.logger.error(...this.prefixLists,...i)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function OE(){const t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function hy(){const t=new Date,e=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return e?(e==null?void 0:e[0])+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}const $i={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Jl=Date.now(),Sc=t=>{for(const e in $i)if(Object.prototype.hasOwnProperty.call($i,e)&&$i[e]===t)return e;return"DEFAULT"},_=new class{constructor(){Zt(this,"proxyServerURL",void 0),Zt(this,"logLevel",$i.DEBUG),Zt(this,"uploadState","collecting"),Zt(this,"uploadLogWaitingList",[]),Zt(this,"uploadLogUploadingList",[]),Zt(this,"uploadErrorCount",0),Zt(this,"currentLogID",0),Zt(this,"url",void 0),Zt(this,"extLog",(t,e)=>{this.appendLogToWaitingList(t,...e)})}debug(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[$i.DEBUG].concat(e);this.log.apply(this,n)}info(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[$i.INFO].concat(e);this.log.apply(this,n)}warning(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[$i.WARNING].concat(e);this.log.apply(this,n)}warn(){this.warning(...arguments)}error(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[$i.ERROR].concat(e);this.log.apply(this,n)}upload(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=[$i.DEBUG].concat(e);this.uploadLog.apply(this,n)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){Ot("UPLOAD_LOG",!0)}disableLogUpload(){Ot("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new qG(this).prefix(t)}log(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(Date.now()-Jl<100)return void setTimeout(()=>{this.log(...e)},Date.now()-Jl);const n=Math.max(0,Math.min(4,e[0]));if(e[0]=OE()+" Agora-SDK [".concat(Sc(n),"]:"),this.appendLogToWaitingList(n,...e),n<this.logLevel)return;const r=OE()+" %cAgora-SDK [".concat(Sc(n),"]:");let s=[];if(!C("USE_NEW_LOG"))switch(n){case $i.DEBUG:s=[r,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,s);break;case $i.INFO:s=[r,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,s);break;case $i.WARNING:s=[r,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,s);break;case $i.ERROR:s=[r,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,s)}}uploadLog(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(Date.now()-Jl<100)return void setTimeout(()=>{this.uploadLog(...e)},Date.now()-Jl);const n=Math.max(0,Math.min(4,e[0]));e[0]=OE()+" Agora-SDK [".concat(Sc(n),"]:"),this.appendLogToWaitingList(n,...e)}appendLogToWaitingList(t){if(!C("UPLOAD_LOG"))return;for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];Array.isArray(i[0])?i[0][0]=hy()+" Agora-SDK [".concat(Sc(t),"]:"):i[0]=hy()+" Agora-SDK [".concat(Sc(t),"]:");let r="";i.forEach(s=>{typeof s=="object"&&(s=JSON.stringify(s)),r+="".concat(s," ")}),this.uploadLogWaitingList.push({payload_str:r,log_level:t,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const t=this.uploadLogUploadingList,e={sdk_version:Zi,process_id:C("PROCESS_ID"),payload:JSON.stringify(t)};return Un(async()=>{const i=await li.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(C("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(C("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if(i.data!=="OK"){const n=new Error("unexpected upload log response");throw n.response=i,n}},()=>(this.uploadLogUploadingList=[],!1),i=>{const n={status:-1,message:i.message,errorRange:t.map(r=>r.log_item_id)};return i.response?(n.status=i.response.status,n.data=i.response.data,n.headers=i.response.headers):i.request&&(n.status=i.request.status),uy.reportLogUploadError(n),!0},{timeout:C("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:C("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,C("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),C("UPLOAD_LOG_INTERVAL"))}).catch(t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),C("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),C("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var py;function zG(t){return Le(t.reportId,"params.reportId",0,100,!1),Le(t.category,"params.category",0,100,!1),Le(t.event,"params.event",0,100,!1),Le(t.label,"params.label",0,100,!1),Pt(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(py={}).FREE="free",py.UPLOADING="uploading",function(t){t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API"}({});const JG={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let ye=function(t){return t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics",t.PC_STATS="pc_stats",t.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",t.AB_TEST="ab_test",t}({}),Ht=function(t){return t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",t.PC_STATS="io.agora.pb.Wrtc.PCStats",t.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",t.AB_TEST="io.agora.pb.Wrtc.ABTest",t}({});(function(t){t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({});let XG=function(t){return t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",t}({});function tt(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(e,i,n){const r=n.value;if(typeof r=="function"){const s=t.className||e.__className__||(e.constructor.name==="AgoraRTCClient"?"Client":e.constructor.name);n.value=function(){for(var o,a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];let l=c;if(t.argsMap)try{l=t.argsMap(this,...c)}catch(h){_.warning(h),l=[]}try{JSON.stringify(l)}catch{_.warning("arguments for method ".concat(s,".").concat(String(i)," not serializable for apiInvoke.")),l=[]}const u=(t.report||Q).reportApiInvoke(this._sessionId||null,{id:this._clientId||((o=this.store)===null||o===void 0?void 0:o.clientId)||this._ID,name:"".concat(s,".").concat(String(i)),options:l,tag:Qt.TRACER,reportResult:t.reportResult},t.throttleTime);try{const h=r.apply(this,c);return h instanceof G?h.then(p=>(u.onSuccess(t.reportResult&&p),p)).catch(p=>{throw u.onError(p),p}):(u.onSuccess(t.reportResult&&h),h)}catch(h){throw u.onError(h),h}}}return n}}const Q=new class{constructor(){Zt(this,"baseInfoMap",new Map),Zt(this,"proxyServer",void 0),Zt(this,"eventUploadTimer",void 0),Zt(this,"setSessionIdTimer",void 0),Zt(this,"url",void 0),Zt(this,"sids",new Set),Zt(this,"backupUrl",void 0),Zt(this,"_appId",void 0),Zt(this,"_aid",0),Zt(this,"keyEventUploadPendingItems",[]),Zt(this,"normalEventUploadPendingItems",[]),Zt(this,"apiInvokeUploadPendingItems",[]),Zt(this,"apiInvokeCount",0),Zt(this,"apiInvokeLoggedCount",0),Zt(this,"ltsList",[]),Zt(this,"lastSendNormalEventTime",Date.now()),Zt(this,"customReportCounterTimer",void 0),Zt(this,"customReportCount",0),Zt(this,"extApiInvoke",async t=>{for(const e of t){const i=at(at({},e),{},{sid:null,invokeId:++this.apiInvokeCount,tag:Qt.TRACER});this.sendApiInvoke(i)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),C("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),C("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}setAppId(t){this._appId=t,this._aid=parseInt(t.replace(/[a-fA-F0-9]{8}/g,e=>{let[i,n]=e;return i+n}),16)||0}reportApiInvoke(t,e,i){e.timeout=e.timeout||6e4,e.reportResult=e.reportResult===void 0||e.reportResult;const n=Date.now();this.apiInvokeCount+=1;const r=this.apiInvokeCount,s=!!C("SHOW_REPORT_INVOKER_LOG"),o=!!C("SHOW_REPORT_USER_INVOKER_LOG"),a=s||o&&e.id;a&&(this.apiInvokeLoggedCount+=1);const c=this.apiInvokeLoggedCount;function d(p,T){if(a){let m="[apiInvoke-".concat(c,"]");e.id&&(m+="[".concat(e.id,"]")),e.name&&(m+="[".concat(e.name,"]")),_.info("".concat(m," ").concat(p),p==="start"?e.options:T||"")}}const l=()=>({tag:e.tag,invokeId:r,sid:t,name:e.name,apiInvokeTime:n,options:e.options,states:e.states||null});d("start");let u=!1;ke(e.timeout).then(()=>{u||(this.sendApiInvoke(at(at({},l()),{},{error:S.API_INVOKE_TIMEOUT,success:!1})),d("timeout"))});const h=new P(S.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:p=>{const T=()=>{if(u)throw h;return u=!0,this.sendApiInvoke(at(at({},l()),{},{success:!0},e.reportResult&&{result:p})),d("onSuccess"),p};return i?zI(T,e.name+"Success",i,()=>u=!0):T()},onError:p=>{const T=()=>{if(u)throw p;u=!0,this.sendApiInvoke(at(at({},l()),{},{success:!1,error:p})),d("onFailure",p.toString())};return i?zI(T,e.name+"Error",i,()=>u=!0):T()}}}sessionInit(t,e){if(this.baseInfoMap.has(t))return;const i=Date.now(),n=this.createBaseInfo(t,i);n.cname=e.cname;const r=Object.assign({},{willUploadConsoleLog:C("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:IE?"global":"oversea",areas:C("AREAS")&&C("AREAS").join(",")},e.extend),{stringUid:s,channelProfile:o,channelMode:a,isABTestSuccess:c,lsid:d,clientRole:l}=e,u=Date.now(),h=at(at({},n),{},{eventType:ye.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,buildFormat:e.buildFormat,build:AE,lts:u,elapse:u-i,extend:JSON.stringify(r),mode:e.mode,process:C("PROCESS_ID"),appType:C("APP_TYPE"),success:!0,version:Zi,stringUid:s,channelProfile:o,channelMode:a,isABTestSuccess:c,lsid:d,clientType:B(p=window.navigator.userAgent).call(p,"AgoraWebView")?42:20,clientRole:l,serviceId:C("PROCESS_ID"),extensionID:C("PLUGIN_INFO").join(",")||""});var p;this.send({type:Ht.SESSION,data:h},!0)}joinChooseServer(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),s=at(at({},n),{},{role:e.role,eventType:ye.JOIN_CHOOSE_SERVER,lts:r,eventElapse:e.elapse||r-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:r-i.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3,corssRegionTagReq:e.corssRegionTagReq||void 0,corssRegionTagRes:e.corssRegionTagRes||void 0});this.send({type:Ht.JOIN_CHOOSE_SERVER,data:s},!0)}reqUserAccount(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),s=at(at({},n),{},{eventType:ye.REQ_USER_ACCOUNT,lts:r,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:e.elapse||r-i.startTime,eventElapse:r-e.lts,extend:JSON.stringify(e.extend)});this.send({type:Ht.REQ_USER_ACCOUNT,data:s},!0)}joinGateway(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info;e.vid&&(n.vid=e.vid),n.uid=e.uid,n.cid=e.cid;const r=Date.now(),{firstSuccess:s,avoidJoinStartTime:o,addr:a,isProxy:c}=e,d=r-(s&&o?o:i.startTime),l=at(at({},n),{},{eventType:ye.JOIN_GATEWAY,lts:r,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,errorMsg:e.errorMsg||"",elapse:d,eventElapse:r-e.lts,firstSuccess:s,signalChannel:e.signalChannel,preload:e.preload?1:0,installId:CE(),isABTestSuccess:e.isABTestSuccess?1:0}),u=l.success?1:0;if(e.succ&&(i.lastJoinSuccessTime=r),s)this.send({type:Ht.JOIN_GATEWAY,data:l},!0);else{let h;if(a)if(c){const T=a.match(/h=(\d{1,3}-){3}\d{1,3}/g),m=a.match(/p=[0-9]{1,6}/g);h={isSuccess:u,gatewayIp:T&&T.length?T[0].split("=")[1].replace(/-/g,"."):"",port:m&&m.length?m[0].split("=")[1]:"",isProxy:c?1:0}}else{const T=a.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),m=a.match(/(:|p=)[0-9]{1,6}/g);h={isSuccess:u,gatewayIp:T&&T.length?T[0].split("//")[1].replace(/-/g,"."):"",port:m&&m.length?m[0].split(/:|p=/g)[1]:"",isProxy:c?1:0}}else h={isSuccess:u,gatewayIp:"",port:"",isProxy:c?1:0};delete l.success,delete l.eventType,delete l.firstSuccess,l.vid=Number(l.vid);const p=Object.assign({},l,h,{eventType:ye.REJOIN_GATEWAY});this.send({type:Ht.RE_JOIN_GATEWAY,data:p},!0)}}joinChannelTimeout(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=Date.now(),r=at(at({},i.info),{},{lts:n,timeout:e,elapse:n-i.startTime});this.send({type:Ht.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),s=at(at({},n),{},{eventType:ye.PUBLISH,lts:r,eventElapse:e.eventElapse,elapse:r-i.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:Ht.PUBLISH,data:s},!0)}subscribe(t,e,i){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,s=Date.now(),o=at(at({},r),{},{eventType:ye.SUBSCRIBE,lts:s,eventElapse:e.eventElapse,elapse:s-n.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid,preSsrc:e.preSsrc?1:0},i&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof e.peerid=="string"?o.peerSuid=e.peerid:o.peer=e.peerid,this.send({type:Ht.SUBSCRIBE,data:o},!0)}wsCompressorInit(t){var e;const i=[...Fi(e=this.baseInfoMap).call(e)],n=i.length?i[0]:"UnableToGetSid",r=this.baseInfoMap.get(n);if(!r)return;const s=r.info,o=Date.now(),a=at(at({},s),{},{eventType:ye.WS_COMPRESSOR_INIT,lts:o,eventElapse:t.eventElapse,elapse:o-r.startTime,status:t.status?1:2});this.send({type:Ht.WS_COMPRESSOR_INIT,data:a},!0)}firstRemoteVideoDecode(t,e,i,n){const r=this.baseInfoMap.get(t);if(!r)return;const s=r.info,o=Date.now(),a=at(at(at({},s),n),{},{elapse:o-r.startTime,eventType:e,lts:o,firstDecodeFrame:Math.max((n.firstFrame||o)-r.startTime,0),apEnd:Math.max(n.apEnd-r.startTime,0),apStart:Math.max(n.apStart-r.startTime,0),joinGwEnd:Math.max(n.joinGwEnd-r.startTime,0),joinGwStart:Math.max(n.joinGwStart-r.startTime,0),pcEnd:Math.max(n.pcEnd-r.startTime,0),pcStart:Math.max(n.pcStart-r.startTime,0),subscriberEnd:Math.max(n.subscriberEnd-r.startTime,0),subscriberStart:Math.max(n.subscriberStart-r.startTime,0),videoAddNotify:Math.max(n.videoAddNotify-r.startTime,0)});this.send({type:i,data:a},!0)}firstRemoteFrame(t,e,i,n){const r=this.baseInfoMap.get(t);if(!r)return;const s=r.info,o=Date.now(),a=at(at(at({},s),n),{},{elapse:o-r.startTime,eventType:e,lts:o});this.send({type:i,data:a},!0)}abTest(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),s=at(at(at({},n),e),{},{vid:n.vid===void 0?0:Number(n.vid),elapse:r-i.startTime,eventType:ye.AB_TEST,lts:r});this.send({type:Ht.AB_TEST,data:s},!0)}pcStats(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),s=at(at(at({},n),e),{},{vid:n.vid===void 0?0:Number(n.vid),elapse:r-i.startTime,eventType:ye.PC_STATS,lts:r,preallocation:e.preallocation?1:0});this.send({type:Ht.PC_STATS,data:s},!0)}updateRemoteRTPCapabilities(t,e){if(t){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),s=at(at(at({},n),e),{},{vid:n.vid===void 0?0:Number(n.vid),eventType:ye.UPDATE_REMOTE_RTPCAPABILITIES,lts:r});this.send({type:Ht.UPDATE_REMOTE_RTPCAPABILITIES,data:s},!0)}}onGatewayStream(t,e,i,n){const r=this.baseInfoMap.get(t);if(!r)return;const s=r.info,o=Date.now(),a=at(at(at({},s),n),{},{eventType:e,lts:o});this.send({type:i,data:a},!0)}streamSwitch(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),s=at(at({},n),{},{eventType:ye.STREAM_SWITCH,lts:r,isDual:e.isdual,elapse:r-i.startTime,success:e.succ});this.send({type:Ht.STREAM_SWITCH,data:s},!0)}requestProxyAppCenter(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),s=at(at({},n),{},{eventType:ye.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-e.lts,elapse:r-i.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:Ht.REQUEST_PROXY_APPCENTER,data:s},!0)}requestProxyWorkerManager(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),s=at(at({},n),{},{eventType:ye.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-e.lts,elapse:r-i.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:Ht.REQUEST_PROXY_WORKER_MANAGER,data:s},!0)}setProxyServer(t){this.proxyServer=t,t?_.debug("reportProxyServerurl: ".concat(t)):_.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),s=at(at({},n),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:r,elapse:r-i.startTime,joinChannelSuccessElapse:r-(i.lastJoinSuccessTime||r),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:Ht.PEER_PUBLISH_STATUS,data:s},!0)}workerEvent(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now();(function(s,o,a){const c=s[o];if(!c||typeof c!="string")return[s];s[o]="";const d=$n(JSON.stringify(s));let l=0;const u=[];let h=0;for(let p=0;p<c.length;p++)h+=c.charCodeAt(p)<=127?1:3,h<=a-d||(u[u.length]=Y(Y({},s),{},{[o]:c.substring(l,p)}),l=p,h=c.charCodeAt(p)<=127?1:3);return l!==c.length-1&&(u[u.length]=Y(Y({},s),{},{[o]:c.substring(l)})),u})(at(at(at({},n),e),{},{elapse:r-i.startTime,lts:r,productType:"WebRTC"}),"payload",1300).forEach(s=>this.send({type:Ht.WORKER_EVENT,data:s},!0))}apworkerEvent(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),s=at(at(at({},n),e),{},{elapse:r-i.startTime,lts:r});this.send({type:Ht.AP_WORKER_EVENT,data:s},!0)}joinWebProxyAP(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),s=at(at(at({},n),e),{},{elapse:r-i.startTime,lts:r,extend:e.extend||void 0});this.send({type:Ht.JOIN_WEB_PROXY_AP,data:s},!0)}WebSocketQuit(t,e){const i=this.baseInfoMap.get(t);if(!i)return;const n=i.info,r=Date.now(),s=at(at(at({},n),e),{},{elapse:r-i.startTime,lts:r});this.send({type:Ht.WEBSOCKET_QUIT,data:s},!0)}async sendCustomReportMessage(t,e){if(this.customReportCount+=e.length,this.customReportCount>C("CUSTOM_REPORT_LIMIT"))throw new P(S.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));const i=Date.now(),n=e.map(r=>({type:Ht.USER_ANALYTICS,data:at(at({sid:t},r),{},{lts:i})}));try{C("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(n):await this.postDataToStatsCollector(n)}catch(r){throw _.error("send custom report message failed",r.toString()),new P(S.CUSTOM_REPORT_SEND_FAILED,r.message)}}sendApiInvoke(t){const e=C("NOT_REPORT_EVENT");if(t.tag&&B(e)&&B(e).call(e,t.tag))return!1;if(t.sid===null)return this.apiInvokeUploadPendingItems.push(t),!1;const i=this.baseInfoMap.get(t.sid);if(!i)return this.apiInvokeUploadPendingItems.push(t),!1;const{cname:n,uid:r,cid:s}=i.info;let o;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof P){const{code:c,message:d}=t.error;o=c||d||t.error.toString()}else o=t.error.toString();const a={invokeId:t.invokeId,sid:t.sid,cname:n,cid:s,uid:r,lts:t.lts,success:t.success,elapse:t.lts-i.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?o:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:Ht.API_INVOKE,data:a},!1),!0}addSid(t){this.sids.add(t)}removeSid(t){this.sids.delete(t)}appendSessionId(){const t=this.apiInvokeUploadPendingItems;if(t.length===0)return;const e=Array.from(this.sids).find(i=>i!==null);e&&t.forEach(i=>{i&&(i.sid=e,this.sendApiInvoke(Object.assign({},i)))}),t.length=0}send(t,e){if(e)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>C("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,e){const i=[],n=[];for(;t.length;){const s=t.shift();i.length<20?i.push(s):n.push(s)}t.push(...n);for(const s of[...i]){var r;this.ltsList.indexOf(s.data.lts)!==-1?(s.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(s.data.lts)):(this.ltsList.push(s.data.lts),tc(r=this.ltsList).call(r,(o,a)=>o-a))}return e||(this.lastSendNormalEventTime=Date.now()),C("ENABLE_EVENT_REPORT")&&i.length&&(C("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(i):this.postDataToStatsCollector(i)).catch((s=>o=>{C("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(s):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(s),this.normalEventUploadPendingItems.length>C("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-C("NORMAL_EVENT_QUEUE_CAPACITY")),_.warning("report: drop normal events"))))})(i)),t}async postDataToStatsCollector2(t){ue.networkState===Ni.OFFLINE&&await G.race([ue.onlineWaiter,ke(2*ge.maxRetryTimeout)]);const e=r=>{let s=new Uint8Array;return r.forEach(o=>{const a=uE(JSON.stringify(o.data)),c=new ArrayBuffer(5),d=(u=>{let h=0;return Object.entries(Ht).forEach(p=>{let[T,m]=p;m===u.type&&(h=XG[T])}),h})(o),l=new DataView(c);l.setUint16(0,a.byteLength,!0),l.setUint8(2,255&d),l.setUint8(3,d>>>8&255),l.setUint8(4,d>>>16&255),s=FI(s,new Uint8Array(c)),s=FI(s,a)}),s},i="event";let n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(C("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(i):"https://".concat(C("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(i);for(let r=0;r<2;r+=1){r===1&&(n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(C("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(i):"https://".concat(C("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(i));try{await gE(n,{timeout:1e4,data:e(t),headers:at(at({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(s){if(r===1)throw s;continue}return}}async postDataToStatsCollector(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i=(a=>{const c=a&&a.data.sid&&this.baseInfoMap.get(a.data.sid);return c&&c.info.vid&&+c.info.vid||0})(t[0]),n=i?void 0:this._aid,r={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map(a=>JSON.stringify(a)),vid:i,aid:n};ue.networkState===Ni.OFFLINE&&await G.race([ue.onlineWaiter,ke(2*ge.maxRetryTimeout)]);const s=e?"/events/proto-raws":"/events/messages";let o=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(C("EVENT_REPORT_DOMAIN"),"&p=").concat(C("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(C("EVENT_REPORT_DOMAIN"),":").concat(C("STATS_COLLECTOR_PORT")).concat(s));for(let a=0;a<2;a+=1){a===1&&(o=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(C("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(C("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(C("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(C("STATS_COLLECTOR_PORT")).concat(s)));try{e?await MG(o,{timeout:1e4,data:r}):await gE(o,{timeout:1e4,data:r})}catch(c){if(a===1)throw c;continue}return}}createBaseInfo(t,e){const i=Object.assign({},JG);return i.sid=t,this.baseInfoMap.set(t,{info:i,startTime:e}),i}reportResourceTiming(t,e){const i=performance.getEntriesByName(t),n=i[i.length-1];n&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:n,tag:Qt.TRACER}).onSuccess()}};uy.on("REPORT_LOG_UPLOAD",t=>{t.networkState=ue.networkState,Q.reportApiInvoke(null,{name:"logUploadError",options:t,tag:Qt.TRACER}).onSuccess("logUploadError")});class D extends P{constructor(e){super(e,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),Zt(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(e,_)}throw(){super.throw(_)}}const Me={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1};function St(){return Me}function _y(){return"setSinkId"in HTMLAudioElement.prototype&&(!C("RESTRICTION_SET_PLAYBACK_DEVICE")||(Rr()||bI())&&!cE())}function Ey(){return!Me.supportUnifiedPlan||C("CHROME_FORCE_PLAN_B")&&vr()}let Ue=function(t){return t.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",t.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",t.IOS_INTERRUPTION_START="ios-interruption-start",t.IOS_INTERRUPTION_END="ios-interruption-end",t.STATE_CHANGE="state-change",t}({});function Ko(t,e,i){return{sampleRate:t,stereo:e,bitrate:i}}function ft(t,e,i,n,r){return{width:t,height:e,frameRate:i,bitrateMin:n,bitrateMax:r}}function gn(t,e,i,n,r){return{width:{max:t},height:{max:e},frameRate:i,bitrateMin:n,bitrateMax:r}}function NE(t,e){return{numSpatialLayers:t,numTemporalLayers:e}}const QG={"90p":ft(160,90),"90p_1":ft(160,90),"120p":ft(160,120,15,30,65),"120p_1":ft(160,120,15,30,65),"120p_3":ft(120,120,15,30,50),"120p_4":ft(212,120),"180p":ft(320,180,15,30,140),"180p_1":ft(320,180,15,30,140),"180p_3":ft(180,180,15,30,100),"180p_4":ft(240,180,15,30,120),"240p":ft(320,240,15,40,200),"240p_1":ft(320,240,15,40,200),"240p_3":ft(240,240,15,40,140),"240p_4":ft(424,240,15,40,220),"360p":ft(640,360,15,80,400),"360p_1":ft(640,360,15,80,400),"360p_3":ft(360,360,15,80,260),"360p_4":ft(640,360,30,80,600),"360p_6":ft(360,360,30,80,400),"360p_7":ft(480,360,15,80,320),"360p_8":ft(480,360,30,80,490),"360p_9":ft(640,360,15,80,800),"360p_10":ft(640,360,24,80,800),"360p_11":ft(640,360,24,80,1e3),"480p":ft(640,480,15,100,500),"480p_1":ft(640,480,15,100,500),"480p_2":ft(640,480,30,100,1e3),"480p_3":ft(480,480,15,100,400),"480p_4":ft(640,480,30,100,750),"480p_6":ft(480,480,30,100,600),"480p_8":ft(848,480,15,100,610),"480p_9":ft(848,480,30,100,930),"480p_10":ft(640,480,10,100,400),"720p":ft(1280,720,15,120,1130),"720p_auto":ft(1280,720,30,900,3e3),"720p_1":ft(1280,720,15,120,1130),"720p_2":ft(1280,720,30,120,2e3),"720p_3":ft(1280,720,30,120,1710),"720p_5":ft(960,720,15,120,910),"720p_6":ft(960,720,30,120,1380),"1080p":ft(1920,1080,15,120,2080),"1080p_1":ft(1920,1080,15,120,2080),"1080p_2":ft(1920,1080,30,120,3e3),"1080p_3":ft(1920,1080,30,120,3150),"1080p_5":ft(1920,1080,60,120,4780),"1440p":ft(2560,1440,30,120,4850),"1440p_1":ft(2560,1440,30,120,4850),"1440p_2":ft(2560,1440,60,120,7350),"4k":ft(3840,2160,30,120,8910),"4k_1":ft(3840,2160,30,120,8910),"4k_3":ft(3840,2160,60,120,13500)},ZG={"480p":gn(640,480,5),"480p_1":gn(640,480,5),"480p_2":gn(640,480,30),"480p_3":gn(640,480,15),"720p":gn(1280,720,5),"720p_auto":ft(1280,720,30,900,3e3),"720p_1":gn(1280,720,5),"720p_2":gn(1280,720,30),"720p_3":gn(1280,720,15),"1080p":gn(1920,1080,5),"1080p_1":gn(1920,1080,5),"1080p_2":gn(1920,1080,30),"1080p_3":gn(1920,1080,15)},$G={"1SL1TL":NE(1,1),"3SL3TL":NE(3,3),"2SL3TL":NE(2,3)};function er(t){return t||(t="480p_1"),typeof t=="string"?Object.assign({},QG[t]):t}function DE(t){return typeof t=="string"?Object.assign({},ZG[t]):t}function Xl(t){return typeof t=="string"?Object.assign({},$G[t]):t}const t3={speech_low_quality:Ko(16e3,!1),speech_standard:Ko(32e3,!1,18),music_standard:Ko(48e3,!1),standard_stereo:Ko(48e3,!0,56),high_quality:Ko(48e3,!1,128),high_quality_stereo:Ko(48e3,!0,192)};function Ql(t){return typeof t=="string"?Object.assign({},t3[t]):t}const Yo=[];function my(t){return Ce(t,"mediaSource",["screen","window","application"]),!0}let z=function(t){return t.NEED_RENEGOTIATE="@need_renegotiate",t.NEED_REPLACE_TRACK="@need_replace_track",t.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",t.NEED_CLOSE="@need_close",t.NEED_ENABLE_TRACK="@need_enable_track",t.NEED_DISABLE_TRACK="@need_disable_track",t.NEED_SESSION_ID="@need_sid",t.SET_OPTIMIZATION_MODE="@set_optimization_mode",t.GET_STATS="@get_stats",t.GET_RTC_STATS="@get_rtc_stats",t.GET_LOW_VIDEO_TRACK="@get_low_video_track",t.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",t.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",t.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",t.NEED_MUTE_TRACK="@need_mute_track",t.NEED_UNMUTE_TRACK="@need_unmute_track",t}({}),xt=function(t){return t.SCREEN_TRACK="screen_track",t.CUSTOM_TRACK="custome_track",t.LOW_STREAM="low_stream",t.SCREEN_LOW_TRACK="screen_low_track",t}({}),qo=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t}({}),e3=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",t}({}),i3=function(t){return t[t.DISABLE=0]="DISABLE",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.AUDIO_ONLY=2]="AUDIO_ONLY",t[t.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",t}({}),Us=function(t){return t.TRANSCEIVER_UPDATED="transceiver-updated",t.SEI_TO_SEND="sei-to-send",t.SEI_RECEIVED="sei-received",t.TRACK_UPDATED="track-updated",t}({}),zo=function(t){return t.SOURCE_STATE_CHANGE="source-state-change",t.TRACK_ENDED="track-ended",t.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.CLOSED="closed",t}({}),Jo=function(t){return t.FIRST_FRAME_DECODED="first-frame-decoded",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.VIDEO_STATE_CHANGED="video-state-changed",t}({}),Xo=function(t){return t.AUDIO="audio",t.VIDEO="video",t.DATA="data",t}({}),Bi=function(t){return t.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",t.RECEIVE_TRACK_BUFFER="receive_track_buffer",t.ON_AUDIO_BUFFER="on_audio_buffer",t.UPDATE_SOURCE="update_source",t}({});(function(t){t.UPDATE_TRACK_SOURCE="update-track-source"})({});const PE={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},LE={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},fy={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},n3={uplinkNetworkQuality:0,downlinkNetworkQuality:0},gy={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let ri=function(t){return t.ON_TRACK="on_track",t.ON_NODE="on_node",t}({}),ji=function(t){return t.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",t.REQUEST_CONSTRAINTS="request_constraints",t}({}),Rc=function(t){return t.IDLE="IDLE",t.INITING="INITING",t.INITEND="INITEND",t}({}),xs=function(t){return t.STATE_CHANGE="state_change",t.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",t.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",t.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",t}({}),Qe=function(t){return t.NONE="none",t.INIT="init",t.CANPLAY="canplay",t.PLAYING="playing",t.PAUSED="paused",t.SUSPEND="suspend",t.STALLED="stalled",t.WAITING="waiting",t.ERROR="error",t.DESTROYED="destroyed",t.ABORT="abort",t.ENDED="ended",t.EMPTIED="emptied",t.LOADEDDATA="loadeddata",t}({}),ir=function(t){return t[t.VideoStateStopped=0]="VideoStateStopped",t[t.VideoStateStarting=1]="VideoStateStarting",t[t.VideoStateDecoding=2]="VideoStateDecoding",t[t.VideoStateFrozen=3]="VideoStateFrozen",t}({});const kE={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let Zl=function(t){return t.OPEN="open",t.MESSAGE="message",t.CLOSE="close",t.CLOSING="closing",t.ERROR="error",t}({});function gt(t,e,i,n,r){var s,o,a={};return Object.keys(n).forEach(function(c){a[c]=n[c]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=wn(s=rg(o=i.slice()).call(o)).call(s,function(c,d){return d(t,e,c)||c},a),r&&a.initializer!==void 0&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),a.initializer===void 0?(Object.defineProperty(t,e,a),null):a}function N(t,e,i){return(e=function(n){var r=function(s){if(typeof s!="object"||!s)return s;var o=s[Symbol.toPrimitive];if(o!==void 0){var a=o.call(s,"string");if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)}(n);return typeof r=="symbol"?r:r+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Ty(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Kt(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Ty(Object(i),!0).forEach(function(n){N(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Ty(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class Sy extends qt{set _mediaStreamTrack(e){e!==this.mediaStreamTrack&&(this.safeEmit(Us.TRACK_UPDATED,e),this.mediaStreamTrack=e)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(e,i){super(),N(this,"trackMediaType",void 0),N(this,"_ID",void 0),N(this,"_rtpTransceiver",void 0),N(this,"_lowRtpTransceiver",void 0),N(this,"_hints",[]),N(this,"_isClosed",!1),N(this,"_originMediaStreamTrack",void 0),N(this,"mediaStreamTrack",void 0),N(this,"_external",{}),this._ID=i||Ut(8,"track-"),this._originMediaStreamTrack=e,this.mediaStreamTrack=e,function(n){B(Yo).call(Yo,n)||Yo.push(n)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){return e||Xr(()=>{var i;Q.reportApiInvoke(null,{name:fe.GET_MEDIA_STREAM_TRACK,options:[],tag:Qt.TRACER}).onSuccess(((i=this._mediaStreamTrack)===null||i===void 0?void 0:i.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===qo.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){const i=Yo.indexOf(e);i!==-1&&Yo.splice(i,1)}(this),this.emit(zo.CLOSED),this.removeAllListeners(Us.SEI_RECEIVED)}_updateRtpTransceiver(e,i){if(i===qo.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit(Us.TRANSCEIVER_UPDATED,e,i)}}class Qo extends Sy{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(e,i){super(e,i),N(this,"_enabled",!0),N(this,"_muted",!1),N(this,"_isExternalTrack",!1),N(this,"_isClosed",!1),N(this,"_enabledMutex",void 0),N(this,"processor",void 0),N(this,"_processorContext",void 0),N(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new Ke("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,i;return(e=(i=this._originMediaStreamTrack)===null||i===void 0?void 0:i.label)!==null&&e!==void 0?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,_.debug("[".concat(this.getTrackId(),"] close")),this.emit(z.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,i){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=n,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),i&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Mt(this,z.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){_.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(zo.TRACK_ENDED)}stateCheck(e,i){if(_.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(i,"]")),Cr(i,e),this._enabled&&this._muted&&e==="enabled"&&i===!1)throw new P(S.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",_);if(!this._enabled&&!this._muted&&e==="muted"&&i===!0)throw new P(S.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",_)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():G.resolve([])}}const Ry=window.AudioContext||window.webkitAudioContext;let Gi=null;const Nt=new class extends qt{constructor(){super(...arguments),N(this,"prevState",void 0),N(this,"curState",void 0),N(this,"currentTime",void 0),N(this,"currentTimeStuckAt",void 0),N(this,"interruptDetectorTrack",void 0),N(this,"onLocalAudioTrackMute",()=>{_.info("ios15-interruption-start"),this.emit(Ue.IOS_15_16_INTERRUPTION_START)}),N(this,"onLocalAudioTrackUnmute",async()=>{_.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?_.info("ios15-interruption-end-canceled"):(Gi&&await Gi.suspend(),this.emit(Ue.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(t){_.debug("webaudio bindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=t,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(t){_.debug("webaudio unbindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===t&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function Zo(){if(!Gi){if(function(){if(!Ry)return void _.error("your browser is not support web audio");_.info("create audio context");const t=Kt({},C("WEBAUDIO_INIT_OPTIONS"));_.debug("audio context init option:",JSON.stringify(t)),Gi=new Ry(t),Nt.curState=Gi.state,Gi.onstatechange=()=>{Nt.prevState=Nt.curState,Nt.curState=Gi?Gi.state:void 0;const{prevState:e,curState:i}=Nt,n=i==="running",r=i==="interrupted",s=e==="running",o=e==="suspended",a=e==="interrupted",c=Tt().osVersion;(ni()||mn())&&s&&r&&(_.info("ios".concat(c,"-interruption-start")),Nt.emit(Ue.IOS_INTERRUPTION_START)),(ni()||mn())&&(o||a)&&n&&(_.info("ios".concat(c,"-interruption-end")),Nt.emit(Ue.IOS_INTERRUPTION_END)),e!==i&&Nt.emit(Ue.STATE_CHANGE,i,e)},setInterval(()=>{var e;const i=(e=Gi)===null||e===void 0?void 0:e.currentTime;Nt.currentTime!==i?(Nt.currentTimeStuckAt&&(_.debug("AudioContext current time resume at ".concat(i)),Nt.currentTimeStuckAt=void 0),Nt.currentTime=i):(i!==Nt.currentTimeStuckAt&&(Q.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:i},tag:Qt.TRACER}).onSuccess(),_.warning("AudioContext current time stuck at ".concat(i))),Nt.currentTimeStuckAt=i)},5e3),async function(e){const i=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let n,r=!1,s=!1,o=!1;function a(m){e.state==="running"?c(!1):ni()||mn()?e.state==="suspended"&&(c(!0),m&&e.resume().then(d,d)):e.state!=="closed"&&(c(!0),m&&e.resume().then(d,d))}function c(m){if(r!==m){r=m;for(let f=0,R=i;f<R.length;f+=1){const v=R[f];m?window.addEventListener(v,l,{capture:!0,passive:!0}):window.removeEventListener(v,l,{capture:!0,passive:!0})}}}function d(){a(!1)}function l(){a(!0)}function u(m){if(!o)if(n.paused)if(m){let f;h(!1),o=!0;try{f=n.play(),f?f.then(p,p):(n.addEventListener("playing",p),n.addEventListener("abort",p),n.addEventListener("error",p))}catch{p()}}else h(!0);else h(!1)}function h(m){if(s!==m){s=m;for(let f=0,R=i;f<R.length;f++){const v=R[f];m?window.addEventListener(v,T,{capture:!0,passive:!0}):window.removeEventListener(v,T,{capture:!0,passive:!0})}}}function p(){n.removeEventListener("playing",p),n.removeEventListener("abort",p),n.removeEventListener("error",p),o=!1,u(!1)}function T(){u(!0)}if(ni()){const m=e.createMediaStreamDestination(),f=document.createElement("div");f.innerHTML="<audio x-webkit-airplay='deny'></audio>",n=f.children.item(0),n.controls=!1,n.disableRemotePlayback=!0,n.preload="auto",n.srcObject=m.stream,u(!0)}Nt.on(Ue.STATE_CHANGE,function(){a(!0)}),a(!1)}(Gi)}(),!Gi)throw new P(S.NOT_SUPPORTED,"can not create audio context");return Gi}return Gi}function Vs(t){if(function(){if(ME!==null)return ME;const n=Zo(),r=n.createBufferSource(),s=n.createGain(),o=n.createGain();r.connect(s),r.connect(o),r.disconnect(s);let a=!1;try{r.disconnect(s)}catch{a=!0}return r.disconnect(),ME=a,a}())return;const e=t.connect,i=t.disconnect;t.connect=(n,r,s)=>{var o;return t._inputNodes||(t._inputNodes=[]),B(o=t._inputNodes).call(o,n)||(n instanceof AudioNode?(t._inputNodes.push(n),e.call(t,n,r,s)):e.call(t,n,r)),t},t.disconnect=(n,r,s)=>{i.call(t),n?jl(t._inputNodes,n):t._inputNodes=[];for(const o of t._inputNodes)e.call(t,o)}}let ME=null;function UE(t,e){let i=!1;const n=1/e;if(C("DISABLE_WEBAUDIO")){const r=window.setInterval(()=>{i?window.clearInterval(r):t(performance.now()/1e3)},1e3*n)}else{const r=Zo();let s=r.createGain();s.gain.value=0,s.connect(r.destination);const o=()=>{if(i)return void(s=null);const a=r.createOscillator();a.onended=o,a.connect(s),a.start(0),a.stop(r.currentTime+n),t(r.currentTime)};o()}return()=>{i=!0}}class vy{constructor(){N(this,"context",void 0),N(this,"analyserNode",void 0),N(this,"sourceNode",void 0),this.context=Zo(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=e,e==null||e.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||ni()||mn()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{const n=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(n);for(let r=0;r<e.length;++r)e[r]=n[r]/128-1}const i=wn(e).call(e,(n,r)=>n+r*r,0)/e.length;return Math.max(10*Math.log10(i)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,i;(e=this.sourceNode)===null||e===void 0||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(i=this.sourceNode)===null||i===void 0||i.connect(this.analyserNode)}catch{_.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class Cy extends qt{get processSourceNode(){return this.sourceNode}set processedNode(e){var i;if(!this.isDestroyed&&this._processedNode!==e){try{var n;(n=this.sourceNode)===null||n===void 0||n.disconnect(this.outputNode)}catch{}(i=this._processedNode)===null||i===void 0||i.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),N(this,"outputNode",void 0),N(this,"outputTrack",void 0),N(this,"isPlayed",!1),N(this,"sourceNode",void 0),N(this,"context",void 0),N(this,"audioBufferNode",void 0),N(this,"destNode",void 0),N(this,"audioOutputLevel",0),N(this,"volumeLevelAnalyser",void 0),N(this,"_processedNode",void 0),N(this,"playNode",void 0),N(this,"isDestroyed",!1),N(this,"onNoAudioInput",void 0),N(this,"isNoAudioInput",!1),N(this,"_noAudioInputCount",0),this.context=Zo(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Vs(this.outputNode),this.volumeLevelAnalyser=new vy}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=i=>{this.emit(Bi.ON_AUDIO_BUFFER,function(n){for(let r=0;r<n.outputBuffer.numberOfChannels;r+=1){const s=n.outputBuffer.getChannelData(r);for(let o=0;o<s.length;o+=1)s[o]=0}return n.inputBuffer}(i))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!St().webAudioMediaStreamDest)throw new P(S.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){this.context.state!=="running"&&Gl(()=>{Nt.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;ni()||mn()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const i=this.volumeLevelAnalyser.getAnalyserNode();let n;i.getFloatTimeDomainData?(n=new Float32Array(i.fftSize),i.getFloatTimeDomainData(n)):(n=new Uint8Array(i.fftSize),i.getByteTimeDomainData(n));let r=!1;for(let s=0;s<n.length;s++)n[s]!==0&&(r=!0);return r?(this.isNoAudioInput=!1,!0):(await ke(200),await this.checkHasAudioInput(e?e+1:1)&&r)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,i;(e=this.processedNode)===null||e===void 0||e.disconnect(),(i=this.sourceNode)===null||i===void 0||i.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?(e=this.processedNode)===null||e===void 0||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class Iy extends Cy{get isFreeze(){return!1}constructor(e,i,n){var r;if(super(),N(this,"sourceNode",void 0),N(this,"track",void 0),N(this,"clonedTrack",void 0),N(this,"audioElement",void 0),N(this,"isCurrentTrackCloned",!1),N(this,"isRemoteTrack",!1),N(this,"originVolumeLevelAnalyser",void 0),N(this,"rebuildWebAudio",async()=>{if(_.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void _.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>_.info("resume success")),_.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const a=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?a.stop():this.isCurrentTrackCloned=!0;const c=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(c),Vs(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const d=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(d,this.context.currentTime),Vs(this.outputNode),this.emit(Bi.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=c,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),e.kind!=="audio")throw new P(S.UNEXPECTED_ERROR);this.track=e;const s=new MediaStream([this.track]);if(this.isRemoteTrack=!!i,this.sourceNode=this.context.createMediaStreamSource(s),Vs(this.sourceNode),n){const a=n.clone();a.enabled=!0,this.clonedTrack=a,_.debug("create an unmuted track ".concat(a.id," from the original track ").concat(n.id," to get the volume"));const c=this.context.createMediaStreamSource(new MediaStream([a]));Vs(c),this.originVolumeLevelAnalyser=new vy,this.originVolumeLevelAnalyser.updateSource(c)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=s;const o=Tt();i&&o.os===Ie.IOS&&Number((r=o.osVersion)===null||r===void 0?void 0:r.split(".")[0])<15&&(Nt.on(Ue.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(a=>{a||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;const i=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(i),Vs(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(Bi.UPDATE_SOURCE),this.audioElement.srcObject=i}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),Nt.off("state-change",this.rebuildWebAudio),(e=this.originVolumeLevelAnalyser)===null||e===void 0||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){const i=e.clone();i.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=i),_.debug("create an unmuted track ".concat(i.id," from the original track ").concat(e.id," to get the volume"));const n=this.context.createMediaStreamSource(new MediaStream([i]));Vs(n),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(n)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function yy(t,e,i){const n=(s,o)=>s?typeof s!="number"?s.max||s.exact||s.ideal||s.min||o:s:o,r={audio:!!i&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxHeight:n(e.height,1080),maxWidth:n(e.width,1920)}}};return e.frameRate&&typeof e.frameRate!="number"?(r.video.mandatory.maxFrameRate=e.frameRate.max,r.video.mandatory.minFrameRate=e.frameRate.min):typeof e.frameRate=="number"&&(r.video.mandatory.maxFrameRate=e.frameRate),await navigator.mediaDevices.getUserMedia(r)}async function r3(t,e){const i=await Ay(t.mediaSource),{sourceId:n,audio:r}=await function(s){let o=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new G((a,c)=>{const d=document.createElement("div");d.innerText="share screen",d.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const l=document.createElement("div");l.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const u=document.createElement("div");u.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",u.setAttribute("style","height: 12%;");const h=document.createElement("div");h.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const p=document.createElement("div");p.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const T=document.createElement("button");T.innerHTML="cancel",T.setAttribute("style","width: 85px;"),T.onclick=()=>{document.body.removeChild(R);const v=new Error("NotAllowedError");v.name="NotAllowedError",c(v)};let m=o;const f=document.createElement("div");if(o){const v=document.createElement("input");v.setAttribute("type","checkbox");const A=document.createElement("span");v.setAttribute("style","margin-right: 6px;"),A.innerText="Share audio",v.checked=m,v.onchange=()=>{m=v.checked},f.appendChild(v),f.appendChild(A)}p.appendChild(f),p.appendChild(T),l.appendChild(u),l.appendChild(h),l.appendChild(p);const R=document.createElement("div");R.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),R.appendChild(d),R.appendChild(l),document.body.appendChild(R),s.map(v=>{if(v.id){const A=document.createElement("div");A.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let O=v.thumbnail;try{const{width:w}=O.getSize();w>1920&&(O=O.resize({width:1920}))}catch(w){throw w&&w.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),w}A.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+O.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+v.name.replace(/[\u00A0-\u9999<>\&]/g,function(w){return"&#"+w.charCodeAt(0)+";"})+"</span>",A.onclick=()=>{document.body.removeChild(R),a({sourceId:v.id,audio:m})},h.appendChild(A)}})})}(i,e);return await yy(n,t,r)}async function Ay(t){let e=["window","screen"];t!=="application"&&t!=="window"||(e=["window"]),t==="screen"&&(e=["screen"]);const i=BI();if(!i)throw console.error("failed to fetch electron, please mount it to window"),new P(S.ELECTRON_IS_NULL);let n=null;try{var r;n=((r=i.desktopCapturer)===null||r===void 0?void 0:r.getSources({types:e}))||i.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch{n=null}n&&n.then||(n=new G((s,o)=>{i.desktopCapturer.getSources({types:e},(a,c)=>{a?o(a):s(c)})}));try{return await n}catch(s){throw new P(S.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,s.toString())}}const xE=new Ke("safari");let by=!1,wy=!1;async function Wi(t,e){let i=0,n=null;for(;i<2;)try{n=await s3(t,e,i>0);break}catch(r){if(r instanceof P)throw _.error("[".concat(e,"] ").concat(r.toString())),r;const s=$l(r.name||r.code||r,r.message);if(s.code===S.MEDIA_OPTION_INVALID){_.debug("[".concat(e,"] detect media option invalid, retry")),i+=1,await ke(500);continue}throw _.error("[".concat(e,"] ").concat(s.toString())),s}if(!n)throw new P(S.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return n}async function s3(t,e,i){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new P(S.NOT_SUPPORTED,"can not find getUserMedia");i&&(t.video&&(delete t.video.width,delete t.video.height),t.screen&&(delete t.screen.width,delete t.screen.height));const n=St(),r=new MediaStream;if(t.audioSource&&r.addTrack(t.audioSource),t.videoSource&&r.addTrack(t.videoSource),!t.audio&&!t.video&&!t.screen)return _.debug("Using Video Source/ Audio Source"),r;if(t.screen)if(BI())t.screen.sourceId?$o(r,await yy(t.screen.sourceId,t.screen,!!t.screenAudio)):$o(r,await r3(t.screen,!!t.screenAudio));else if(Rr()&&t.screen.extensionId&&t.screen.mandatory){if(!n.getStreamFromExtension)throw new P(S.NOT_SUPPORTED,"This browser does not support screen sharing");_.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));const h=await(o=t.screen.extensionId,a=e,new G((p,T)=>{try{chrome.runtime.sendMessage(o,{getStream:!0},m=>{if(!m||!m.streamId)return _.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),m),void T(new P(S.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));p(m.streamId)})}catch(m){_.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(o,")"),m.toString()),T(new P(S.CHROME_PLUGIN_NOT_INSTALL))}}));t.screen.mandatory.chromeMediaSourceId=h,$o(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:t.screen.mandatory}}))}else if(n.getDisplayMedia){var s;t.screen.mediaSource&&my(t.screen.mediaSource);const h={width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate,displaySurface:(s=t.screen.displaySurface)!==null&&s!==void 0?s:t.screen.mediaSource==="screen"?"monitor":t.screen.mediaSource},{selfBrowserSurface:p,surfaceSwitching:T,systemAudio:m,preferCurrentTab:f}=t.screen,R={selfBrowserSurface:p,surfaceSwitching:T,systemAudio:m,preferCurrentTab:f};!p&&delete R.selfBrowserSurface,!T&&delete R.surfaceSwitching,!m&&delete R.systemAudio,!f&&delete R.preferCurrentTab,_.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:h,audio:t.screenAudio,controls:R})),$o(r,await navigator.mediaDevices.getDisplayMedia(Kt({video:h,audio:t.screenAudio},R)))}else{if(!te())throw _.error("[".concat(e,"] This browser does not support screenSharing")),new P(S.NOT_SUPPORTED,"This browser does not support screen sharing");{t.screen.mediaSource&&my(t.screen.mediaSource);const h={video:{mediaSource:t.screen.mediaSource,width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate}};_.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(h))),$o(r,await navigator.mediaDevices.getUserMedia(h))}}var o,a;if(!t.video&&!t.audio)return r;let c={video:t.video,audio:t.audio},d=C("MEDIA_DEVICE_CONSTRAINTS");if(d)try{typeof d=="string"&&(d=JSON.parse(d)),c=_E(c,d)}catch{}_.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(c)),Tt();let l,u=null;(Ve()||ni()||Fl())&&(u=await xE.lock());try{l=await navigator.mediaDevices.getUserMedia(c)}catch(h){throw u&&u(),h}return c.audio&&(by=!0),c.video&&(wy=!0),$o(r,l),u&&u(),r}function $l(t,e){switch(t){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new P(S.MEDIA_OPTION_INVALID,"".concat(t,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new P(S.DEVICE_NOT_FOUND,"".concat(t,": ").concat(e));case"NotSupportedError":return new P(S.NOT_SUPPORTED,"".concat(t,": ").concat(e));case"NotReadableError":return new P(S.NOT_READABLE,"".concat(t,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new P(S.PERMISSION_DENIED,"".concat(t,": ").concat(e));case"ConstraintNotSatisfiedError":return new P(S.CONSTRAINT_NOT_SATISFIED,"".concat(t,": ").concat(e));default:return _.error("getUserMedia unexpected error",t),new P(S.UNEXPECTED_ERROR,"".concat(t,": ").concat(e))}}function $o(t,e){const i=t.getVideoTracks()[0],n=t.getAudioTracks()[0],r=e.getVideoTracks()[0],s=e.getAudioTracks()[0];s&&(n&&t.removeTrack(n),t.addTrack(s)),r&&(i&&t.removeTrack(i),t.addTrack(r))}const Hi=new class extends qt{get state(){return this._state}set state(t){t!==this._state&&(this.emit(xs.STATE_CHANGE,t),this._state=t)}constructor(){super(),N(this,"_state",Rc.IDLE),N(this,"isAccessMicrophonePermission",!1),N(this,"isAccessCameraPermission",!1),N(this,"lastAccessMicrophonePermission",!1),N(this,"lastAccessCameraPermission",!1),N(this,"checkdeviceMatched",!1),N(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(C("ENUMERATE_DEVICES_INTERVAL")||(Bl()||Vl()===Ie.HARMONY_OS)&&vr())&&this.updateDevicesInfo()},C("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(t=>_.error(t.toString()))}async enumerateDevices(t,e){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new P(S.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const n=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(n);let s=!this.isAccessMicrophonePermission&&t,o=!this.isAccessCameraPermission&&e;r.audio&&(s=!1),r.video&&(o=!1);let a=null,c=null,d=null;if(!i&&(s||o)){if(xE.isLocked&&(_.debug("[device manager] wait GUM lock"),(await xE.lock())(),_.debug("[device manager] GUM unlock")),by&&(s=!1,this.isAccessMicrophonePermission=!0),wy&&(o=!1,this.isAccessCameraPermission=!0),_.debug("[device manager] check media device permissions",t,e,s,o),s&&o){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(l){const u=$l(l.name||l.code||l,l.message);if(u.code===S.PERMISSION_DENIED)throw u;_.warning("getUserMedia failed in getDevices",u)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(s){try{a=await navigator.mediaDevices.getUserMedia({audio:t})}catch(l){const u=$l(l.name||l.code||l,l.message);if(u.code===S.PERMISSION_DENIED)throw u;_.warning("getUserMedia failed in getDevices",u)}this.isAccessMicrophonePermission=!0}else if(o){try{c=await navigator.mediaDevices.getUserMedia({video:e})}catch(l){const u=$l(l.name||l.code||l,l.message);if(u.code===S.PERMISSION_DENIED)throw u;_.warning("getUserMedia failed in getDevices",u)}this.isAccessCameraPermission=!0}_.debug("[device manager] mic permission",t,"cam permission",e)}try{const l=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach(u=>u.stop()),c&&c.getTracks().forEach(u=>u.stop()),d&&d.getTracks().forEach(u=>u.stop()),a=null,c=null,d=null,l}catch(l){return a&&a.getTracks().forEach(u=>u.stop()),c&&c.getTracks().forEach(u=>u.stop()),d&&d.getTracks().forEach(u=>u.stop()),a=null,c=null,d=null,new P(S.ENUMERATE_DEVICES_FAILED,l.toString()).throw()}}async getRecordingDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audioinput")}async getCamerasDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,t)).filter(e=>e.kind==="videoinput")}async getSpeakers(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audiooutput")}searchDeviceIdByName(t){let e=null;return this.deviceInfoMap.forEach(i=>{i.device.label===t&&(e=i.device.deviceId)}),e}async getDeviceById(t){const e=(await this.enumerateDevices(!0,!0,!0)).find(i=>i.deviceId===t);if(!e)throw new P(S.DEVICE_NOT_FOUND,"deviceId: ".concat(t));return e}async init(){this.state=Rc.INITING;try{await this.updateDevicesInfo(),this.state=Rc.INITEND}catch(t){throw _.warning("Device Detection functionality cannot start properly.",t.toString()),this.state=Rc.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")||new P(S.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),t}}async updateDevicesInfo(){const t=await this.enumerateDevices(!0,!0,!0),e=Date.now(),i=[];if(t[0]&&t[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const r=t.find(o=>o.kind==="audioinput"&&o.deviceId==="default"),s=t.find(o=>o.kind==="audiooutput"&&o.deviceId==="default");r&&s?s.groupId===r.groupId?_.debug("[device-check] default input ".concat(r.label," and output ").concat(s.label," is the same group")):_.debug("[device-check] default input ".concat(r.label," and output ").concat(s.label," is not the same group")):_.debug("[device-check] default input or output not found")}const n=this.checkMediaDeviceInfoIsOk(t);if(t.forEach(r=>{if(!r.deviceId)return;const s=this.deviceInfoMap.get("".concat(r.kind,"_").concat(r.deviceId));if((s?s.state:"INACTIVE")!=="ACTIVE"){const o={initAt:e,updateAt:e,device:r,state:"ACTIVE"};this.deviceInfoMap.set("".concat(r.kind,"_").concat(r.deviceId),o),i.push(o)}s&&(s.updateAt=e)}),this.deviceInfoMap.forEach((r,s)=>{r.state==="ACTIVE"&&r.updateAt!==e&&(r.state="INACTIVE",i.push(r))}),this.state!==Rc.INITEND)return n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));i.forEach(r=>{switch(r.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(xs.RECORDING_DEVICE_CHANGED,r);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(xs.CAMERA_DEVICE_CHANGED,r);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(xs.PLAYOUT_DEVICE_CHANGED,r)}}),n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(t){const e=t.filter(r=>r.kind==="audioinput"),i=t.filter(r=>r.kind==="videoinput"),n={audio:!1,video:!1};for(const r of e)if(r.label&&r.deviceId){n.audio=!0;break}for(const r of i)if(r.label&&r.deviceId){n.video=!0;break}return n}};let VE=!1;const Ki=new class extends qt{constructor(){super(...arguments),N(this,"onAutoplayFailed",void 0),N(this,"onAudioAutoplayFailed",void 0)}};function Oy(){if(Tt(),!VE){const t=e=>{e.preventDefault(),VE=!1,hc()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};VE=!0,hc()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),_.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Ki.onAutoplayFailed?Ki.onAutoplayFailed():Ki.onAudioAutoplayFailed?_.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):_.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),Ki.emit("autoplay-failed")}}function Ny(t,e,i,n){if(!t)return;const r=Q.getBaseInfoBySessionId(t);if(!r)return;const s=r.info,o=Date.now(),a=Kt(Kt({},s),{},{vid:s.vid===void 0?0:Number(s.vid),lts:o,elapse:o-r.startTime,cbRegistered:Ki.onAutoplayFailed||Ki.onAudioAutoplayFailed?1:-1,errorMsg:i,mediaType:e,trackId:n,extend:void 0});Q.send({type:Ht.AUTOPLAY_FAILED,data:a},!0)}const o3=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],ui=new class{constructor(){N(this,"onAutoplayFailed",void 0),N(this,"elementMap",new Map),N(this,"elementStateMap",new Map),N(this,"elementsNeedToResume",[]),N(this,"sinkIdMap",new Map),N(this,"autoResumeAfterInterruption",t=>{Array.from(this.elementMap.entries()).forEach(e=>{let[i,n]=e;const r=this.elementStateMap.get(i),s=n.srcObject.getAudioTracks()[0],o=s&&s.readyState;if(_.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(o," ").concat(t)),o==="live"){if(t)return n.pause(),void n.play();if(Nt.curState==="running")return Bo()?(n.pause(),void n.play()):void(r&&r==="paused"&&n.play())}})}),N(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(t=>{let[e,i]=t;const n=i.srcObject.getAudioTracks()[0];n&&n.readyState==="live"&&(_.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),i.pause(),i.play())})}),this.autoResumeAudioElement(),Nt.on(Ue.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Nt.on(Ue.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Nt.on(Ue.STATE_CHANGE,()=>{ni()&&Nt.prevState==="suspended"&&Nt.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(t,e){const i=this.elementMap.get(t);if(this.sinkIdMap.set(t,e),i)try{await i.setSinkId(e)}catch(n){throw new P(S.PERMISSION_DENIED,"can not set sink id: "+n.toString())}}play(t,e,i,n){if(this.elementMap.has(e))return;const r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([t]),this.bindAudioElementEvents(e,r),this.elementMap.set(e,r),this.elementStateMap.set(e,Qe.INIT),this.setVolume(e,i);const s=this.sinkIdMap.get(e);if(s)try{r.setSinkId(s).catch(a=>{_.warning("[".concat(e,"] set sink id failed"),a.toString())})}catch(a){_.warning("[".concat(e,"] set sink id failed"),a.toString())}const o=r.play();o&&o.then&&o.catch(a=>{n&&Ny(n,"audio",a.message,e),_.warning("audio element play warning",a.toString()),this.elementMap.has(e)&&a.name==="NotAllowedError"&&(_.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),Gl(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),Oy()}))})}updateTrack(t,e){const i=this.elementMap.get(t);i&&(i.srcObject=new MediaStream([e]))}isPlaying(t){return this.elementMap.has(t)&&this.elementStateMap.get(t)==="playing"}setVolume(t,e){const i=this.elementMap.get(t);i&&(e=Math.max(0,Math.min(100,e)),i.volume=e/100)}stop(t){const e=this.elementMap.get(t);if(this.sinkIdMap.delete(t),!e)return;const i=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(i,1),e.srcObject=null,e.remove(),this.elementMap.delete(t),this.elementStateMap.delete(t)}bindAudioElementEvents(t,e){o3.forEach(i=>{e.addEventListener(i,n=>{const r=this.elementStateMap.get(t),s=n.type==="pause"?"paused":n.type;if(_.debug("[".concat(t,"] audio-element-status change ").concat(r," => ").concat(s)),n.type==="error"){const o=e==null?void 0:e.error;o&&_.error("[".concat(t,"] media error, code: ").concat(o.code,", message: ").concat(o.message))}this.elementStateMap.set(t,s)})})}getPlayerState(t){return this.elementStateMap.get(t)||"uninit"}autoResumeAudioElement(){const t=()=>{this.elementsNeedToResume.forEach(e=>{e.play().then(i=>{_.debug("Auto resume audio element success")}).catch(i=>{_.warning("Auto resume audio element failed!",i)})}),this.elementsNeedToResume=[]};new G(e=>{document.body?e():window.addEventListener("load",()=>e())}).then(()=>{hc()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0))})}};function oe(){return function(t,e,i){const n=i.value;return typeof n=="function"&&(i.value=function(){this._isClosed&&new P(S.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",_);for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];const a=n.apply(this,s);return a instanceof G?new G((c,d)=>{a.then(c).catch(d)}):a}),i}}class Dy extends qt{constructor(e){super(),N(this,"name","VideoProcessorDestination"),N(this,"ID","0"),N(this,"_source",void 0),N(this,"videoContext",void 0),N(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new P(S.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new P(S.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(ri.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(ri.ON_TRACK,void 0)}}class Py extends qt{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,i){super(),N(this,"constraintsMap",new Map),N(this,"statsRegistry",[]),N(this,"usageRegistry",[]),N(this,"trackId",void 0),N(this,"direction",void 0),N(this,"_chained",!1),this.trackId=e,this.direction=i}async getConstraints(){return await Be(this,ji.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,i){var n;return _.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(i,e),Mt(this,ji.REQUEST_UPDATE_CONSTRAINTS,Array.from(Mi(n=this.constraintsMap).call(n)))}async requestRevertConstraints(e){var i;if(this.constraintsMap.has(e))return _.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),Mt(this,ji.REQUEST_UPDATE_CONSTRAINTS,Array.from(Mi(i=this.constraintsMap).call(i)))}registerStats(e,i,n){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===i)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:i,cb:n})}unregisterStats(e,i){const n=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===i);n!==-1&&this.statsRegistry.splice(n,1)}gatherStats(){const e=[];for(const{processorID:i,processorName:n,type:r,cb:s}of this.statsRegistry)try{const o=s();e.push({processorID:i,processorName:n,type:r,stats:o})}catch(o){_.error(new P(S.UNEXPECTED_ERROR,o.message))}return e}registerUsage(e,i){this.usageRegistry.find(n=>n.processorID===e.ID&&n.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:i})}unregisterUsage(e){const i=this.usageRegistry.findIndex(n=>n.processorID===e.ID&&n.processorName===e.name);i!==-1&&this.usageRegistry.splice(i,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:i}of this.usageRegistry)try{let n=i();n instanceof G&&(n=await n),e.push(Kt(Kt({},n),{},{direction:this.direction}))}catch(n){_.error("gather extension usage error",n)}return e}getDirection(){return this.direction}}class Ly extends qt{constructor(e){super(),N(this,"name","AudioProcessorDestination"),N(this,"ID","0"),N(this,"inputTrack",void 0),N(this,"inputNode",void 0),N(this,"audioProcessorContext",void 0),N(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new P(S.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new P(S.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(ri.ON_TRACK,void 0),this.emit(ri.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(ri.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(ri.ON_NODE,this.inputNode))}}class ky extends qt{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,i,n){super(),N(this,"constraintsMap",new Map),N(this,"statsRegistry",[]),N(this,"audioContext",void 0),N(this,"trackId",void 0),N(this,"direction",void 0),N(this,"usageRegistry",[]),N(this,"_chained",!1),this.audioContext=e,this.trackId=i,this.direction=n}async getConstraints(){return Be(this,ji.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,i){var n;return _.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(i,e),Mt(this,ji.REQUEST_UPDATE_CONSTRAINTS,Array.from(Mi(n=this.constraintsMap).call(n)))}async requestRevertConstraints(e){var i;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),Mt(this,ji.REQUEST_UPDATE_CONSTRAINTS,Array.from(Mi(i=this.constraintsMap).call(i)))}registerStats(e,i,n){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===i)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:i,cb:n})}unregisterStats(e,i){const n=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===i);n!==-1&&this.statsRegistry.splice(n,1)}gatherStats(){const e=[];for(const{processorID:i,processorName:n,type:r,cb:s}of this.statsRegistry)try{const o=s();e.push({processorID:i,processorName:n,type:r,stats:o})}catch(o){_.error(new P(S.UNEXPECTED_ERROR,o.message))}return e}registerUsage(e,i){this.usageRegistry.find(n=>n.processorID===e.ID&&n.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:i})}unregisterUsage(e){const i=this.usageRegistry.findIndex(n=>n.processorID===e.ID&&n.processorName===e.name);i!==-1&&this.usageRegistry.splice(i,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:i}of this.usageRegistry)try{let n=i();n instanceof G&&(n=await n),e.push(Kt(Kt({},n),{},{direction:this.direction}))}catch(n){_.error("gather extension usage error",n)}return e}getDirection(){return this.direction}}class FE extends qt{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),N(this,"context",void 0),N(this,"processSourceNode",void 0),N(this,"outputTrack",void 0),N(this,"processedNode",void 0),N(this,"clonedTrack",void 0),N(this,"outputNode",void 0),this.outputNode=new a3}setVolume(){}createOutputTrack(){throw new P(S.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class a3{disconnect(){}connect(){}}function My(t){return new G((e,i)=>{let n=!1;const r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);const s=ni()?"canplay":"playing";r.addEventListener(s,()=>{const o=r.videoWidth,a=r.videoHeight;!o&&te()||(n=!0,r.srcObject=null,r.remove(),e([o,a]))}),r.srcObject=new MediaStream([t]),r.play().catch(Wl),setTimeout(()=>{n||(r.srcObject=null,r.remove(),e([r.videoWidth,r.videoHeight]))},4e3)})}function tu(t){const e={};t.facingMode&&(e.facingMode=t.facingMode),t.cameraId&&(e.deviceId={exact:t.cameraId});const i=er(t.encoderConfig);return i.width!=null&&(e.width=i.width),i.height!=null&&(e.height=i.height),!MI()&&i.frameRate&&(e.frameRate=i.frameRate),bI()&&typeof e.frameRate=="object"&&(e.frameRate.max=60),te()&&(e.frameRate={ideal:30,max:30}),e}function Uy(t){const e={};return MI()||(t.AGC!==void 0&&(e.autoGainControl=t.AGC),t.AEC!==void 0&&(e.echoCancellation=t.AEC),t.ANS!==void 0&&(e.noiseSuppression=t.ANS,Rr()&&t.ANS&&(e.googHighpassFilter=t.ANS))),e}function xy(t){const e=Uy(t);if(t.encoderConfig){const i=Ql(t.encoderConfig);e.channelCount=i.stereo?2:1,e.sampleRate=i.sampleRate,e.sampleSize=i.sampleSize}return t.microphoneId&&(e.deviceId={exact:t.microphoneId}),Bl()&&(e.sampleRate=void 0),e}const c3=t=>{const e=t._encoderConfig;if(!e)return;const{frameRate:i,width:n,height:r}=t.getMediaStreamTrackSettings();let{frameRate:s=i,width:o=n,height:a=r}=e;if(!s||!o||!a)return;o=EE(o),a=EE(a),s=EE(s);const{max:c,min:d}=function(p,T,m){const f=200*Math.pow(m/15,.6)*Math.pow(p*T/640/360,.75);return{min:Math.floor(f),max:Math.floor(4*f)}}(o,a,s),{bitrateMax:l,bitrateMin:u}=e||{};l||_.debug("calculate bitrate: [w: ".concat(o,", h: ").concat(a,", fps: ").concat(s,"] => [brMax: ").concat(l,", brMin: ").concat(u,"]"));const{maxFramerate:h}=C("ENCODER_CONFIG_LIMIT");return h&&typeof h=="number"&&(s=Math.min(s,h)),{frameRate:s,bitrateMax:l||c,bitrateMin:u||d,scaleResolutionDownBy:1,scale:0}},Vy=async(t,e,i)=>await(async(n,r,s)=>{const o=function(d){const l=[];for(let u=0;u<d.length;u+=2)l.push(parseInt(d.slice(u,u+2),16));return Uint8Array.from(l)}(QI(""+r+s)).slice(0,16),a=o.slice(0,12),c=await window.crypto.subtle.importKey("raw",o,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},c,n))})(t.buffer,e,i),BE=t=>{const e=document.createElement("canvas");return e.width=2,e.height=2,new G((i,n)=>{e.toBlob(async r=>{if(e.remove(),r){const s=await Fy(r);i({buffer:s,width:e.width,height:e.height})}else n(new P(S.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,1)})},Fy=async t=>{const e=await t.arrayBuffer();return new Uint8Array(e)};var By,jy,Gy,Wy,Hy,Ky,Yy,qy,zy,Jy,Xy,Qy,Zy,$y,tA,eA,iA,nA,Jt,rA,sA,oA,aA,cA,dA,nr,lA,uA,hA,pA,_A,EA,mA,fA,gA,TA,SA,RA,vA,Ge;let ie=(By=tt({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),jy=tt({argsMap:(t,e)=>[t.getTrackId(),e]}),Gy=oe(),Wy=Wo("LocalAudioTrack","_enabledMutex"),Hy=tt({argsMap:(t,e)=>[t.getTrackId(),e]}),Ky=oe(),Yy=Wo("LocalAudioTrack","_enabledMutex"),qy=tt({argsMap:(t,e)=>[t.getTrackId(),e]}),zy=oe(),Jy=oe(),Xy=oe(),Qy=tt({argsMap:t=>[t.getTrackId()]}),Zy=oe(),$y=tt({argsMap:t=>[t.getTrackId()]}),tA=oe(),eA=tt({argsMap:t=>[t.getTrackId()]}),iA=tt({argsMap:(t,e)=>[t.getTrackId(),e.name]}),nA=tt({argsMap:t=>[t.getTrackId()]}),gt((Jt=class extends Qo{get _source(){return this.initWebAudio()}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?ui.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,e,i,n){super(t,i),N(this,"trackMediaType",Xo.AUDIO),N(this,"_encoderConfig",void 0),N(this,"_trackSource",void 0),N(this,"metadata",[]),N(this,"_enabled",!0),N(this,"_volume",100),N(this,"_useAudioElement",!0),N(this,"_bypassWebAudio",!1),N(this,"processor",void 0),N(this,"_processorContext",void 0),N(this,"_processorDestination",void 0),N(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!n,this._trackSource=new FE,C("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),C("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),Ve()&&!Gi?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(t){Pt(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&ui.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void _.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,Mt(this,z.NEED_REPLACE_TRACK,this).then(()=>{_.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(i=>{_.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),i)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(t){if(!this._useAudioElement||!_y())throw new P(S.NOT_SUPPORTED,"your browser does not support setting the audio output device");await ui.setSinkID(this.getTrackId(),t)}async setEnabled(t,e,i){return this._setEnabled(t,e,i)}async _setEnabled(t,e,i){if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{i||(this._enabled=!0),await Mt(this,z.NEED_ENABLE_TRACK,this),_.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(n){throw i||(this._enabled=!1),_.error("[".concat(this.getTrackId(),"] setEnabled to true error"),n.toString()),n}}else{this._originMediaStreamTrack.enabled=!1,i||(this._enabled=!1);try{await Mt(this,z.NEED_DISABLE_TRACK,this)}catch(n){throw i||(this._enabled=!0),_.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}}}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,_.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await Mt(this,z.NEED_MUTE_TRACK,this):await Mt(this,z.NEED_UNMUTE_TRACK,this))}getStats(){return Xr(()=>{_.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),xi(this,z.GET_STATS)||Kt({},PE)}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Bi.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(Bi.ON_AUDIO_BUFFER),this._source.on(Bi.ON_AUDIO_BUFFER,i=>t(i))}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] start audio playback in element")),ui.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?ui.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&ui.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(t,e){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:t,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Mt(this,z.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t))}renewMediaStreamTrack(t){return G.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new P(S.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new P(S.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(t){t.on(ri.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e),await Mt(this,z.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Mt(this,z.NEED_REPLACE_TRACK,this))}),t.on(ri.ON_NODE,e=>{this._source.processedNode=e})}unbindProcessorDestinationEvents(t){t.removeAllListeners(ri.ON_TRACK),t.removeAllListeners(ri.ON_NODE)}bindProcessorContextEvents(t){t.on(ji.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(t){t.removeAllListeners(ji.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof FE&&(this._trackSource=new Iy(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const t=new ky(this._source.context,this.getTrackId(),"local"),e=new Ly(t);return this._processorContext=t,this._processorDestination=e,this.bindProcessorContextEvents(t),this.bindProcessorDestinationEvents(e),this._source.on(Bi.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:t})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(ui.stop(this.getTrackId()),this._source.play()),Mt(this,z.NEED_REPLACE_MIXING_TRACK,this).then(()=>{_.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(i=>{_.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),i)})),{processorContext:t,processorDestination:e}}}).prototype,"setVolume",[By],Object.getOwnPropertyDescriptor(Jt.prototype,"setVolume"),Jt.prototype),gt(Jt.prototype,"setPlaybackDevice",[jy,Gy],Object.getOwnPropertyDescriptor(Jt.prototype,"setPlaybackDevice"),Jt.prototype),gt(Jt.prototype,"setEnabled",[Wy,Hy,Ky],Object.getOwnPropertyDescriptor(Jt.prototype,"setEnabled"),Jt.prototype),gt(Jt.prototype,"setMuted",[Yy,qy,zy],Object.getOwnPropertyDescriptor(Jt.prototype,"setMuted"),Jt.prototype),gt(Jt.prototype,"getStats",[Jy],Object.getOwnPropertyDescriptor(Jt.prototype,"getStats"),Jt.prototype),gt(Jt.prototype,"setAudioFrameCallback",[Xy],Object.getOwnPropertyDescriptor(Jt.prototype,"setAudioFrameCallback"),Jt.prototype),gt(Jt.prototype,"play",[Qy,Zy],Object.getOwnPropertyDescriptor(Jt.prototype,"play"),Jt.prototype),gt(Jt.prototype,"stop",[$y,tA],Object.getOwnPropertyDescriptor(Jt.prototype,"stop"),Jt.prototype),gt(Jt.prototype,"close",[eA],Object.getOwnPropertyDescriptor(Jt.prototype,"close"),Jt.prototype),gt(Jt.prototype,"pipe",[iA],Object.getOwnPropertyDescriptor(Jt.prototype,"pipe"),Jt.prototype),gt(Jt.prototype,"unpipe",[nA],Object.getOwnPropertyDescriptor(Jt.prototype,"unpipe"),Jt.prototype),Jt),eu=(rA=tt({argsMap:(t,e)=>[t.getTrackId(),e]}),sA=oe(),oA=Wo("MicrophoneAudioTrack","_enabledMutex"),aA=tt({argsMap:(t,e,i)=>[t.getTrackId(),e,i]}),cA=oe(),dA=tt({argsMap:t=>[t.getTrackId()]}),gt((nr=class extends ie{get __className__(){return"MicrophoneAudioTrack"}constructor(t,e,i,n){super(t,e.encoderConfig?Ql(e.encoderConfig):{},n,C("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),N(this,"_config",void 0),N(this,"_deviceName","default"),N(this,"_constraints",void 0),N(this,"_originalConstraints",void 0),N(this,"_enabled",!0),this._config=e,this._constraints=i,this._originalConstraints=i,this._deviceName=t.label,typeof e.bypassWebAudio=="boolean"&&(this._bypassWebAudio=e.bypassWebAudio),(Bo()||aE())&&Nt.bindInterruptDetectorTrack(this)}async setDevice(t){if(_.info("[".concat(this.getTrackId(),"] start set device to ").concat(t)),this._enabled)try{const e=await Hi.getDeviceById(t),i={};i.audio=Kt({},this._constraints),i.audio.deviceId={exact:t},this._originMediaStreamTrack.stop();let n=null;try{n=await Wi(i,this.getTrackId())}catch(r){throw _.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),n=await Wi({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const e=await Hi.getDeviceById(t);this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}_.info("[".concat(this.getTrackId(),"] set device to ").concat(t," success"))}async setEnabled(t,e,i){if(e)return _.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(t);if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),t),C("AUTO_RESET_AUDIO_ROUTE")&&(ni()||mn())){const o=navigator.audioSession;o&&(t||(o.type="playback"),o.type="auto")}if(!t){var n;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(n=this._source.clonedTrack)===null||n===void 0||n.stop(),i||(this._enabled=!1);try{await Mt(this,z.NEED_DISABLE_TRACK,this)}catch(o){throw _.error("[".concat(this.getTrackId(),"] setEnabled false failed"),o.toString()),o}return}const r=Kt({},this._constraints),s=Hi.searchDeviceIdByName(this._deviceName);s&&!r.deviceId&&(r.deviceId=s);try{i||(this._enabled=!0);const o=await Wi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(o.getAudioTracks()[0],!1),await Mt(this,z.NEED_ENABLE_TRACK,this)}catch(o){throw i||(this._enabled=!1),_.error("[".concat(this.getTrackId(),"] setEnabled true failed"),o.toString()),o}_.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(Bo()||aE())&&Nt.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((ni()||mn())&&this._enabled&&!this._isClosed&&Nt.duringInterruption){const t=async()=>{Nt.off(Ue.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Nt.on(Ue.IOS_INTERRUPTION_END,t)}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(zo.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,i=Hi.searchDeviceIdByName(this._deviceName);if(i&&!e.deviceId&&(e.deviceId=i),this._constraints=e,this._enabled){this._originMediaStreamTrack.stop();const n=await Wi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!0)}}bindProcessorContextEvents(t){super.bindProcessorContextEvents(t),t.on(ji.REQUEST_UPDATE_CONSTRAINTS,async(e,i,n)=>{try{const r=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(r),i()}catch(r){n(r)}})}unbindProcessorContextEvents(t){super.unbindProcessorContextEvents(t),t.removeAllListeners(ji.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[rA,sA],Object.getOwnPropertyDescriptor(nr.prototype,"setDevice"),nr.prototype),gt(nr.prototype,"setEnabled",[oA,aA,cA],Object.getOwnPropertyDescriptor(nr.prototype,"setEnabled"),nr.prototype),gt(nr.prototype,"close",[dA],Object.getOwnPropertyDescriptor(nr.prototype,"close"),nr.prototype),nr),d3=(lA=tt({argsMap:(t,e)=>[t.getTrackId(),e,t.duration]}),uA=oe(),hA=tt({argsMap:t=>[t.getTrackId()]}),pA=oe(),_A=tt({argsMap:t=>[t.getTrackId()]}),EA=oe(),mA=tt({argsMap:t=>[t.getTrackId()]}),fA=oe(),gA=tt({argsMap:t=>[t.getTrackId()]}),TA=oe(),SA=tt({argsMap:t=>[t.getTrackId()]}),RA=tt({argsMap:t=>[t.getTrackId()]}),vA=oe(),gt((Ge=class extends ie{get __className__(){return"BufferSourceAudioTrack"}constructor(t,e,i,n){super(e.createOutputTrack(),i,n),N(this,"source",void 0),N(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=t,this._bufferSource=e,this._bufferSource.on(Bi.AUDIO_SOURCE_STATE_CHANGE,r=>{this.safeEmit(zo.SOURCE_STATE_CHANGE,r)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(t){Pt(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t)}}).prototype,"startProcessAudioBuffer",[lA,uA],Object.getOwnPropertyDescriptor(Ge.prototype,"startProcessAudioBuffer"),Ge.prototype),gt(Ge.prototype,"pauseProcessAudioBuffer",[hA,pA],Object.getOwnPropertyDescriptor(Ge.prototype,"pauseProcessAudioBuffer"),Ge.prototype),gt(Ge.prototype,"seekAudioBuffer",[_A,EA],Object.getOwnPropertyDescriptor(Ge.prototype,"seekAudioBuffer"),Ge.prototype),gt(Ge.prototype,"resumeProcessAudioBuffer",[mA,fA],Object.getOwnPropertyDescriptor(Ge.prototype,"resumeProcessAudioBuffer"),Ge.prototype),gt(Ge.prototype,"stopProcessAudioBuffer",[gA,TA],Object.getOwnPropertyDescriptor(Ge.prototype,"stopProcessAudioBuffer"),Ge.prototype),gt(Ge.prototype,"close",[SA],Object.getOwnPropertyDescriptor(Ge.prototype,"close"),Ge.prototype),gt(Ge.prototype,"setAudioBufferPlaybackSpeed",[RA,vA],Object.getOwnPropertyDescriptor(Ge.prototype,"setAudioBufferPlaybackSpeed"),Ge.prototype),Ge);class Re extends ie{get __className__(){return"MixingAudioTrack"}get isActive(){for(const e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){const e=Zo().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,Ut(8,"track-mix-")),N(this,"trackList",void 0),N(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return this.trackList.indexOf(e)!==-1}addAudioTrack(e){this.trackList.indexOf(e)===-1?(_.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):_.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(this.trackList.indexOf(e)!==-1){_.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch{}jl(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){const e={};this.trackList.forEach(i=>{i._encoderConfig&&((i._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=i._encoderConfig.bitrate),(i._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=i._encoderConfig.sampleRate),(i._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=i._encoderConfig.sampleSize),i._encoderConfig.stereo&&(e.stereo=!0))}),this._encoderConfig=e}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach(i=>{i instanceof Re?i.emit(Us.TRANSCEIVER_UPDATED,e):i._updateRtpTransceiver(e)}))}}class l3 extends Cy{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit(Bi.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),N(this,"audioBuffer",void 0),N(this,"sourceNode",void 0),N(this,"startPlayTime",0),N(this,"startPlayOffset",0),N(this,"pausePlayTime",0),N(this,"options",void 0),N(this,"currentLoopCount",0),N(this,"currentPlaybackSpeed",100),N(this,"_currentState","stopped"),this.audioBuffer=e,this.options=i,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){this.currentState==="stopped"?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):_.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=e,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(e){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const CA=new Map;class jE{get rendFrameRate(){if(this.renderStats&&this.renderStats.curTs!==this.renderStats.lastTs){const e=this.renderStats.curTs-this.renderStats.lastTs,i=(this.renderStats.renderNum-this.renderStats.lastRenderNum)/e;return this.renderStats.lastRenderNum=this.renderStats.renderNum,this.renderStats.lastTs=this.renderStats.curTs,i}return 0}get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(_.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}get videoState(){return this._videoState}set videoState(e){var i;e!==this._videoState&&(this._videoState=e,(i=this.onVideoStateChanged)===null||i===void 0||i.call(this,this.videoState))}constructor(e){N(this,"trackId",void 0),N(this,"config",void 0),N(this,"onFirstVideoFrameDecoded",void 0),N(this,"onVideoStateChanged",void 0),N(this,"freezeTimeCounterList",[]),N(this,"renderFreezeAccTime",0),N(this,"isKeepLastFrame",!1),N(this,"timeUpdatedCount",0),N(this,"freezeTime",0),N(this,"playbackTime",0),N(this,"lastTimeUpdatedTime",0),N(this,"autoplayFailed",!1),N(this,"videoTrack",void 0),N(this,"videoElement",void 0),N(this,"cacheVideoElement",void 0),N(this,"renderStats",void 0),N(this,"_videoState",ir.VideoStateStopped),N(this,"videoElementCheckInterval",void 0),N(this,"videoElementFreezeTimeout",void 0),N(this,"_videoElementStatus",Qe.NONE),N(this,"isGettingVideoDimensions",!1),N(this,"startGetVideoDimensions",()=>{const i=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return _.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(i,500)};!this.isGettingVideoDimensions&&i()}),N(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&Nt.curState==="running"&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(AI())),LI()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),N(this,"handleVideoEvents",i=>{switch(i.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=Qe.PLAYING;break;case"loadeddata":if(this.videoState=ir.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=Qe.CANPLAY;break;case"stalled":this.videoElementStatus=Qe.STALLED;break;case"suspend":this.videoElementStatus=Qe.SUSPEND;break;case"pause":this.videoElementStatus=Qe.PAUSED,ni()||mn()||Ve()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=Qe.WAITING;break;case"abort":this.videoElementStatus=Qe.ABORT;break;case"ended":this.videoElementStatus=Qe.ENDED;break;case"emptied":this.videoElementStatus=Qe.EMPTIED;break;case"error":{const n=this.videoElement.error;n&&(this.videoElementStatus=Qe.ERROR,_.error("[".concat(this.trackId,"] media error: ").concat(n.message," (").concat(n.code,")")));break}case"timeupdate":{const n=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=n);const r=n-this.lastTimeUpdatedTime,s=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=n,yr.lastVisibleTime<yr.lastHiddenTime||s<yr.lastHiddenTime||s<yr.lastVisibleTime)return;for(r>C("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=r),this.playbackTime+=r;this.playbackTime>=6e3;){this.playbackTime-=6e3;const o=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(o),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),N(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(AI())),LI()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),Nt.on(Ue.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Nt.on(Ue.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return(e=this.videoElement.parentElement)!==null&&e!==void 0?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){const i=this.videoElement.play();i&&i.catch&&i.catch(r=>{e&&Ny(e,"video",r.message,this.trackId),r.name==="NotAllowedError"?(_.warning("detected video element autoplay failed",r),this.autoplayFailed=!0,this.handleAutoPlayFailed()):_.warning("[".concat(this.trackId,"] play warning: "),r)});const n=Tt();if((n.name==="Safari"&&Number(n.version)===15||Bo())&&i&&i.then){const r=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};i.then(r).catch(r)}}getCurrentFrame(){const e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;const i=e.getContext("2d");if(!i)return _.error("create canvas context failed!"),new ImageData(2,2);i.drawImage(this.videoElement,0,0,e.width,e.height);const n=i.getImageData(0,0,e.width,e.height);return e.remove(),n}async getCurrentFrameToUint8Array(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const n=document.createElement("canvas");n.width=this.videoElement.videoWidth,n.height=this.videoElement.videoHeight;const r=n.getContext("2d");return r?(r.drawImage(this.videoElement,0,0,n.width,n.height),new G((s,o)=>{n.toBlob(async a=>{if(n.remove(),a){const c=await Fy(a);s({buffer:c,width:n.width,height:n.height})}else o(new P(S.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,i<0?.1:i>1?1:i)})):await BE(e)}destroy(){this.renderStats=void 0,Nt.off(Ue.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Nt.off(Ue.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=ir.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=Qe.INIT,!this.videoElementCheckInterval&&(IA.forEach(s=>{this.videoElement.addEventListener(s,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{(function(s){return s!==document.body&&document.body.contains(s)})(this.videoElement)||(this.videoElementStatus=Qe.DESTROYED)},1e3),C("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,i;let s;const o=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",o),this.videoElementFreezeTimeout=window.setTimeout(a,C("VIDEO_FREEZE_DURATION")))},a=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===ir.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=ir.VideoStateFrozen:document.addEventListener("visibilitychange",o))},c=(d,l)=>{if(this.videoElementStatus===Qe.PLAYING){if(this.renderStats?(this.renderStats.renderNum++,this.renderStats.curTs=l.mediaTime):this.renderStats={lastTs:l.mediaTime,curTs:l.mediaTime,lastRenderNum:0,renderNum:0},s){const p=l.presentationTime-s.presentationTime;this.videoState===ir.VideoStateStarting&&(this.videoState=ir.VideoStateDecoding),this.videoState===ir.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(a,C("VIDEO_FREEZE_DURATION"))),p<C("VIDEO_FREEZE_DURATION")&&this.videoState===ir.VideoStateFrozen&&(this.videoState=ir.VideoStateDecoding),p>C("VIDEO_FREEZE_DURATION")&&yr.lastVisibleTime>=yr.lastHiddenTime&&s.timestamp>yr.lastVisibleTime&&s.timestamp>yr.lastHiddenTime&&(this.renderFreezeAccTime+=p)}s=Kt(Kt({},l),{},{timestamp:d})}var u,h;C("ENABLE_VIDEO_FRAME_CALLBACK")&&((u=(h=this.videoElement).requestVideoFrameCallback)===null||u===void 0||u.call(h,c))};(e=(i=this.videoElement).requestVideoFrameCallback)===null||e===void 0||e.call(i,c)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Bl()&&!C("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const n=Tt();n.name==="Safari"&&Number(n.version)===15||Bo()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,te()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,te()&&this.videoElement.load());const r=this.videoElement.play();r!==void 0&&r.catch(s=>{_.debug("[".concat(this.trackId,"] playback interrupted"),s.toString())})}resetVideoElement(){IA.forEach(e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=Qe.NONE}handleAutoPlayFailed(){const e=i=>{i.preventDefault(),this.videoElement.play().then(()=>{_.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(n=>{_.error(n)}),this.autoplayFailed=!1,hc()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};hc()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),Oy()}}const IA=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class yA extends jE{constructor(e){super(e),N(this,"container",void 0),N(this,"slot",void 0),this.slot=e.element,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;const i=e.element;i!==this.slot&&(this.destroy(),this.slot=i),this.createElements()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var i;(i=this.container)!==null&&i!==void 0&&i.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var i;let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(i=this.container)!==null&&i!==void 0&&i.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,n):await BE(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",C("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var e;!this.container||(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if((e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var AA,bA,wA,OA,NA,DA,PA,LA,kA,MA,UA,xA,VA,FA,BA,jA,GA,WA,HA,KA,YA,qA,zA,JA,_t,XA,QA,ZA,$A,tb,eb,ib,nb,Yi;let Gt=(AA=tt({argsMap:(t,e,i)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),bA=oe(),wA=tt({argsMap:t=>[t.getTrackId()]}),OA=Wo("LocalVideoTrack","_enabledMutex"),NA=tt({argsMap:(t,e)=>[t.getTrackId(),e]}),DA=oe(),PA=Wo("LocalVideoTrack","_enabledMutex"),LA=tt({argsMap:(t,e)=>[t.getTrackId(),e]}),kA=oe(),MA=tt({argsMap:(t,e)=>[t.getTrackId(),e]}),UA=oe(),xA=oe(),VA=tt({argsMap:(t,e,i)=>[t.getTrackId(),e,i]}),FA=oe(),BA=oe(),jA=oe(),GA=oe(),WA=oe(),HA=oe(),KA=oe(),YA=tt({argsMap:(t,e)=>[t.getTrackId(),e.name]}),qA=tt({argsMap:t=>[t.getTrackId()]}),zA=tt({argsMap:t=>[t.getTrackId()]}),JA=tt({argsMap:(t,e,i)=>[t.getTrackId(),e.label,i]}),_t=class ON extends Qo{get videoHeight(){if(Ve()){const{height:e}=this._mediaStreamTrack.getSettings();return this._videoHeight=e,this._videoHeight}return this._videoHeight}get videoWidth(){if(Ve()){const{width:e}=this._mediaStreamTrack.getSettings();return this._videoWidth=e,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Qe.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,i,n,r,s,o){if(super(e,s),N(this,"trackMediaType",Xo.VIDEO),N(this,"_player",void 0),N(this,"isUseScaleResolutionDownBy",!1),N(this,"_videoVisibleTimer",null),N(this,"_previousVideoVisibleStatus",void 0),N(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),N(this,"_encoderConfig",void 0),N(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),N(this,"_optimizationMode",void 0),N(this,"_videoHeight",void 0),N(this,"_videoWidth",void 0),N(this,"_forceBitrateLimit",void 0),N(this,"_enabled",!0),N(this,"_processorDestination",void 0),N(this,"_processorContext",void 0),Ve()){const{width:a,height:c}=e.getSettings();this._videoWidth=a,this._videoHeight=c}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=i,this._scalabilityMode=n,this._optimizationMode=r,this._hints=o||[],this._hints.indexOf(xt.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(rE(Ct.CHROME,115)&&Vl().indexOf("Windows")!==-1){const a=function(c,d){if("VideoFrame"in window&&"TransformStream"in window&&St().supportWebRTCInsertableStream){const l=new MediaStreamTrackProcessor(c),u=new MediaStreamTrackGenerator({kind:"video"});let h,p,T=Date.now();const m=()=>{f&&(clearInterval(f),f=void 0),h&&(h.close(),h=void 0),c.stop(),p=void 0,u.removeEventListener("ended",m)};let f=window.setInterval(()=>{if(p&&h&&Date.now()-T>1e3)try{u.readyState==="live"?p.enqueue(h.clone()):m()}catch{m()}},1e3);const R=new TransformStream({transform:(v,A)=>{u.readyState==="live"?(p=A,T=Date.now(),h===void 0?(h=v,A.enqueue(v.clone())):(A.enqueue(h),h=v)):v.close()}});return u.addEventListener("ended",m),l.readable.pipeThrough(R).pipeTo(u.writable),u}}(e);a&&(_.info("local screen video track begin to inject frame"),this._mediaStreamTrack=a)}i&&this._hints.indexOf(xt.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(i),this._processorContext=new Py(this.getTrackId(),"local"),this._processorDestination=new Dy(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){const r=document.getElementById(e);r?e=r:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(i));const n=Kt(Kt(Kt({},this._getDefaultPlayerConfig()),i),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(n):(e instanceof HTMLVideoElement?this._player=new jE(n):this._player=new yA(n),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const r=this.getVideoElementVisibleStatus();this.safeEmit(zo.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},C("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,i){if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await Mt(this,z.NEED_DISABLE_TRACK,this)}catch(n){throw _.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}return i||(this._enabled=!1),void _.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Mt(this,z.NEED_ENABLE_TRACK,this)}catch(n){throw _.error("[".concat(this.getTrackId(),"] setEnabled to true error"),n.toString()),n}_.info("[".concat(this.getTrackId(),"] setEnabled to true success")),i||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,_.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await Mt(this,z.NEED_MUTE_TRACK,this):await Mt(this,z.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(e,i){if(!this._enabled)throw new P(S.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e=er(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){const n=tu({encoderConfig:e});(Ve()||ni()||mn())&&(n.deviceId=void 0),_.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(n));try{await this._originMediaStreamTrack.applyConstraints(n),this.updateMediaStreamTrackResolution()}catch(r){const s=new P(S.UNEXPECTED_ERROR,r.toString());throw _.error("[".concat(this.getTrackId(),"] applyConstraints error"),s.toString()),s}}this._encoderConfig=e,this._hints.indexOf(xt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Mt(this,z.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(_)}}getStats(){return Xr(()=>{_.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),xi(this,z.GET_STATS)||Kt({},LE)}async setBeautyEffect(e){_.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,i):await BE(e)}async setBitrateLimit(e){_.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e&&(this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate))}async setOptimizationMode(e){if(e!=="motion"&&e!=="detail"&&e!=="balanced")return void _.error(S.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const i=this._optimizationMode;try{this._optimizationMode=e,await Mt(this,z.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(n){throw this._optimizationMode=i,_.error("[".concat(this.getTrackId(),"] set optimization mode failed"),n.toString()),n}_.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(e.numSpatialLayers===1&&e.numTemporalLayers!==1)return _.error(S.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,_.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){My(this._originMediaStreamTrack).then(e=>{let[i,n]=e;this._videoHeight=n,this._videoWidth=i}).catch(Wl)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(e){if(!this._enabled)throw new P(S.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");_.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=er(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,this._hints.indexOf(xt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Mt(this,z.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(_)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:e,height:i,frameRate:n}=this.getMediaStreamTrackSettings();if(!e||!i||!n)return;const{bitrateMax:r,bitrateMin:s}=this._encoderConfig;if(s==null||r==null){const{max:o,min:a}=function(c,d,l,u,h){const p=C("BITRATE_ADAPTER_TYPE");if(p==="DEFAULT_BITRATE")return{min:u,max:h};if(h===void 0){var T;const f=Math.floor(200*Math.pow(l/15,.6)*Math.pow(c*d/640/360,.75));h=p==="STANDARD_BITRATE"?4*f:2*f,u=(T=u)!==null&&T!==void 0?T:f}else{var m;u=(m=u)!==null&&m!==void 0?m:Math.floor(h/10)}return{min:u,max:h}}(e,i,n,s,r);this._encoderConfig.bitrateMin=a,this._encoderConfig.bitrateMax=o,_.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(i,", fps: ").concat(n,"] => [brMax: ").concat(o,", brMin: ").concat(a,"]"))}}getVideoElementVisibleStatus(){try{var e,i;const n=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),r={track:this,element:this==null||(i=this._player)===null||i===void 0?void 0:i.getVideoElement(),slot:n==null?void 0:n.parentElement},{element:s,slot:o}=r;if(this.isPlaying&&s instanceof HTMLVideoElement&&o instanceof HTMLElement){const a=VI.checkOneElementVisible(s),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const d=Q.reportApiInvoke(null,{tag:Qt.TRACER,name:fe.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(n){throw new P(S.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new P(S.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(e){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],n=this._encoderConfig;e&&(n=Kt(Kt({},n),er(e))),n=Ps(n);const r=Ut(8,"track-video-cloned-"),s=new ON(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,n,Ps(this._scalabilityMode),this._optimizationMode,r,Ps(this._hints));return e&&n&&s.setEncoderConfiguration(n),_.debug("clone video track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(i)),s}async replaceTrack(e,i){if(!(e instanceof MediaStreamTrack))throw new P(S.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(e.kind!=="video")throw new P(S.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,i,!0),this.updateMediaStreamTrackResolution()}sendSeiData(e){if(Xr(()=>{Q.reportApiInvoke(null,{name:fe.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:Qt.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!C("ENABLE_VIDEO_SEI")||!C("ENABLE_ENCODED_TRANSFORM"))return void _.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(e instanceof Uint8Array==0)return new P(S.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const i=this.getRTCRtpTransceiver();if(!i)return void _.warning("Video track is not published, SEI can not be send");const n=i.sender.getParameters();if(n.codecs.length===0)return;const r=n.codecs[0].mimeType.toLocaleLowerCase();r==="video/h264"?this.safeEmit("sei-to-send",e):_.warning("SEI is not supported by ".concat(r))}bindProcessorDestinationEvents(){this.processorDestination.on(ri.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await Mt(this,z.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Mt(this,z.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ri.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(ji.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(ji.REQUEST_CONSTRAINTS)}},gt(_t.prototype,"play",[AA,bA],Object.getOwnPropertyDescriptor(_t.prototype,"play"),_t.prototype),gt(_t.prototype,"stop",[wA],Object.getOwnPropertyDescriptor(_t.prototype,"stop"),_t.prototype),gt(_t.prototype,"setEnabled",[OA,NA,DA],Object.getOwnPropertyDescriptor(_t.prototype,"setEnabled"),_t.prototype),gt(_t.prototype,"setMuted",[PA,LA,kA],Object.getOwnPropertyDescriptor(_t.prototype,"setMuted"),_t.prototype),gt(_t.prototype,"setEncoderConfiguration",[MA,UA],Object.getOwnPropertyDescriptor(_t.prototype,"setEncoderConfiguration"),_t.prototype),gt(_t.prototype,"getStats",[xA],Object.getOwnPropertyDescriptor(_t.prototype,"getStats"),_t.prototype),gt(_t.prototype,"setBeautyEffect",[VA,FA],Object.getOwnPropertyDescriptor(_t.prototype,"setBeautyEffect"),_t.prototype),gt(_t.prototype,"getCurrentFrameData",[BA],Object.getOwnPropertyDescriptor(_t.prototype,"getCurrentFrameData"),_t.prototype),gt(_t.prototype,"getCurrentFrameImage",[jA],Object.getOwnPropertyDescriptor(_t.prototype,"getCurrentFrameImage"),_t.prototype),gt(_t.prototype,"setBitrateLimit",[GA],Object.getOwnPropertyDescriptor(_t.prototype,"setBitrateLimit"),_t.prototype),gt(_t.prototype,"setOptimizationMode",[WA],Object.getOwnPropertyDescriptor(_t.prototype,"setOptimizationMode"),_t.prototype),gt(_t.prototype,"setScalabiltyMode",[HA],Object.getOwnPropertyDescriptor(_t.prototype,"setScalabiltyMode"),_t.prototype),gt(_t.prototype,"updateMediaStreamTrackResolution",[KA],Object.getOwnPropertyDescriptor(_t.prototype,"updateMediaStreamTrackResolution"),_t.prototype),gt(_t.prototype,"pipe",[YA],Object.getOwnPropertyDescriptor(_t.prototype,"pipe"),_t.prototype),gt(_t.prototype,"unpipe",[qA],Object.getOwnPropertyDescriptor(_t.prototype,"unpipe"),_t.prototype),gt(_t.prototype,"close",[zA],Object.getOwnPropertyDescriptor(_t.prototype,"close"),_t.prototype),gt(_t.prototype,"replaceTrack",[JA],Object.getOwnPropertyDescriptor(_t.prototype,"replaceTrack"),_t.prototype),_t),GE=(XA=tt({argsMap:(t,e)=>[t.getTrackId(),e]}),QA=oe(),ZA=Wo("CameraVideoTrack","_enabledMutex"),$A=tt({argsMap:(t,e)=>[t.getTrackId(),e]}),tb=oe(),eb=tt({argsMap:(t,e)=>[t.getTrackId(),e]}),ib=oe(),nb=tt({argsMap:t=>[t.getTrackId()]}),Yi=class NN extends Gt{get __className__(){return"CameraVideoTrack"}constructor(e,i,n,r,s,o){super(e,er(i.encoderConfig),r,s,o),N(this,"_config",void 0),N(this,"_originalConstraints",void 0),N(this,"_constraints",void 0),N(this,"_enabled",!0),N(this,"_deviceName","default"),N(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(Bo()||aE())&&!function(){const a=Tt();if(a.os!==Ie.IOS||!a.osVersion)return!1;const c=a.osVersion.split(".");return Number(c[0])===15&&Number(c[1])>=2}()&&kI()&&this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=i,this._originalConstraints=n,this._constraints=n,this._deviceName=e.label,this._encoderConfig=er(this._config.encoderConfig),Nt.on(Ue.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Nt.on(Ue.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(e){return typeof e=="string"?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0}async _setDeviceById(e){if(_.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{const i=await Hi.getDeviceById(e),n={};n.video=Kt({},this._constraints),n.video.deviceId={exact:e},n.video.facingMode=void 0,this._originMediaStreamTrack.stop();let r=null;try{r=await Wi(n,this.getTrackId())}catch(s){throw _.error("[".concat(this.getTrackId(),"] setDevice failed"),s.toString()),r=await Wi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),s}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=i.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(i){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}else try{const i=await Hi.getDeviceById(e);this._deviceName=i.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(i){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}_.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(e){_.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));const i={video:Kt(Kt({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let n=null;try{n=await Wi(i,this.getTrackId())}catch(r){throw _.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),r.toString()),n=await Wi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=Kt({},i.video),_.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(e,i){if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const n=await Wi({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1)}await Mt(this,z.NEED_ENABLE_TRACK,this)}catch(n){throw _.error("[".concat(this.getTrackId(),"] setEnabled true error"),n.toString()),n}this.updateMediaStreamTrackResolution(),_.info("[".concat(this.getTrackId(),"] setEnabled to true success")),i||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),i||(this._enabled=!1);try{await Mt(this,z.NEED_DISABLE_TRACK,this)}catch(n){throw _.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}_.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(e,i){if(!this._enabled)throw new P(S.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");e=er(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate||e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate||e.bitrateMin);const n=ee(this._config);n.encoderConfig=e;const r=tu(n);(Ve()||ni()||mn())&&(r.deviceId=void 0),_.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(s){const o=new P(S.UNEXPECTED_ERROR,s.toString());throw _.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}this._config=n,this._constraints=r,this._originalConstraints=r,this._encoderConfig=e,this._hints.indexOf(xt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Mt(this,z.NEED_UPDATE_VIDEO_ENCODER,this)}catch(s){return s.throw(_)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((ni()||mn())&&this._enabled&&!this._isClosed&&Nt.duringInterruption){const e=async()=>{Nt.off(Ue.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Nt.on(Ue.IOS_INTERRUPTION_END,e)}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(zo.TRACK_ENDED)}async renewMediaStreamTrack(e){const i=e||this._constraints,n=Hi.searchDeviceIdByName(this._deviceName);if(n&&!i.deviceId&&(i.deviceId={exact:n}),this._enabled){const r=await Wi({video:i},this.getTrackId());this._constraints=i,await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),Nt.off(Ue.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Nt.off(Ue.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(e){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],n=this._encoderConfig;e&&(n=Kt(Kt({},n),er(e))),n=Ps(n);const r=Ut(8,"track-cam-cloned-"),s=new NN(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,Ps(Kt(Kt({},this._config),{},{encoderConfig:n})),Ps(this._constraints),Ps(this._scalabilityMode),this._optimizationMode,r);return e&&n&&s.setEncoderConfiguration(n),_.debug("clone track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(i)),s}bindProcessorContextEvents(){this.processorContext.on(ji.REQUEST_UPDATE_CONSTRAINTS,async(e,i,n)=>{try{const r=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(r),i()}catch(r){n(r)}}),this.processorContext.on(ji.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}},gt(Yi.prototype,"setDevice",[XA,QA],Object.getOwnPropertyDescriptor(Yi.prototype,"setDevice"),Yi.prototype),gt(Yi.prototype,"setEnabled",[ZA,$A,tb],Object.getOwnPropertyDescriptor(Yi.prototype,"setEnabled"),Yi.prototype),gt(Yi.prototype,"setEncoderConfiguration",[eb,ib],Object.getOwnPropertyDescriptor(Yi.prototype,"setEncoderConfiguration"),Yi.prototype),gt(Yi.prototype,"close",[nb],Object.getOwnPropertyDescriptor(Yi.prototype,"close"),Yi.prototype),Yi);function WE(t,e,i,n){i.optimizationMode&&(n&&n.width&&n.height?(i.encoderConfig=Kt(Kt({},n),{},{bitrateMin:n.bitrateMin,bitrateMax:n.bitrateMax}),i.optimizationMode!=="motion"&&i.optimizationMode!=="detail"||(e.contentHint=i.optimizationMode,e.contentHint===i.optimizationMode?_.debug("[".concat(t,"] set content hint to"),i.optimizationMode):_.debug("[".concat(t,"] set content hint failed")))):_.warning("[".concat(t,"] can not apply optimization mode bitrate config, no encoderConfig")))}var rb,sb,ob,ab,tn,cb,db,lb,ub,hb,pb,Ze;class _b extends Sy{getUserId(){return this._userId}constructor(e,i,n,r){super(e,"track-".concat(e.kind,"-").concat(i,"-").concat(r.clientId,"_").concat(Ut(5,""))),N(this,"_userId",void 0),N(this,"_uintId",void 0),N(this,"_isDestroyed",!1),N(this,"store",void 0),N(this,"processor",void 0),N(this,"processorContext",void 0),this._userId=i,this._uintId=n,this.store=r}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,_.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let ta=(rb=tt({argsMap:(t,e,i)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),sb=tt({argsMap:t=>[t.getTrackId()]}),ob=tt({argsMap:(t,e)=>[t.getTrackId(),e.name]}),ab=tt({argsMap:t=>[t.getTrackId()]}),gt((tn=class extends _b{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Qe.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,e,i,n){super(t,e,i,n),N(this,"_videoVisibleTimer",null),N(this,"_previousVideoVisibleStatus",void 0),N(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),N(this,"trackMediaType",Xo.VIDEO),N(this,"_videoWidth",void 0),N(this,"_videoHeight",void 0),N(this,"_player",void 0),N(this,"processorDestination",void 0),N(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new Py(this.getTrackId(),"remote"),this.processorDestination=new Dy(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return Xr(()=>{_.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),xi(this,z.GET_STATS)||Kt({},gy)}play(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const n=document.getElementById(t);n?t=n:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const i=Kt(Kt({fit:"cover"},e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(i):(t instanceof HTMLVideoElement?this._player=new jE(i):this._player=new yA(i),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Jo.FIRST_FRAME_DECODED)},this._player.onVideoStateChanged=n=>{this.safeEmit(Jo.VIDEO_STATE_CHANGED,n)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const n=this.getVideoElementVisibleStatus();this.safeEmit(Jo.VIDEO_ELEMENT_VISIBLE_STATUS,n)}catch{}},C("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){My(this._originMediaStreamTrack).then(t=>{let[e,i]=t;this._videoHeight=i,this._videoWidth=e}).catch(Wl)}_updatePlayerSource(){_.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,e;const i=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),n={track:this,element:this==null||(e=this._player)===null||e===void 0?void 0:e.getVideoElement(),slot:i==null?void 0:i.parentElement},{element:r,slot:s}=n;if(this.isPlaying&&r instanceof HTMLVideoElement&&s instanceof HTMLElement){const o=VI.checkOneElementVisible(r),a=Object.assign({},o);if(a.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=a.visible;const c=Q.reportApiInvoke(null,{tag:Qt.TRACER,name:fe.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});a.visible?c.onSuccess("Video is visible"):c.onSuccess("Invisible because of ".concat(a.reason))}return a}return}catch(i){throw new P(S.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new P(S.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(ri.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ri.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(t){this.emit(Us.SEI_RECEIVED,t)}}).prototype,"play",[rb],Object.getOwnPropertyDescriptor(tn.prototype,"play"),tn.prototype),gt(tn.prototype,"stop",[sb],Object.getOwnPropertyDescriptor(tn.prototype,"stop"),tn.prototype),gt(tn.prototype,"pipe",[ob],Object.getOwnPropertyDescriptor(tn.prototype,"pipe"),tn.prototype),gt(tn.prototype,"unpipe",[ab],Object.getOwnPropertyDescriptor(tn.prototype,"unpipe"),tn.prototype),tn),ea=(cb=tt({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),db=tt({argsMap:(t,e)=>[t.getTrackId(),e]}),lb=tt({argsMap:t=>[t.getTrackId()]}),ub=tt({argsMap:t=>[t.getTrackId()]}),hb=tt({argsMap:(t,e)=>[t.getTrackId(),e.name]}),pb=tt({argsMap:t=>[t.getTrackId()]}),gt((Ze=class extends _b{get isPlaying(){return this._useAudioElement?ui.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,e,i,n){super(t,e,i,n),N(this,"trackMediaType",Xo.AUDIO),N(this,"_source",void 0),N(this,"_useAudioElement",!0),N(this,"_volume",100),N(this,"processorContext",void 0),N(this,"processorDestination",void 0),N(this,"_played",!1),N(this,"_bypassWebAudio",!1),C("DISABLE_WEBAUDIO")?(this._source=new FE,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new Iy(t,!0),C("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(Bi.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(Jo.FIRST_FRAME_DECODED)}),this.processorContext=new ky(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new Ly(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Bi.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Bi.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(Bi.ON_AUDIO_BUFFER),this._source.on(Bi.ON_AUDIO_BUFFER,i=>t(i))}setVolume(t){this._volume=t,this._useAudioElement?ui.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}async setPlaybackDevice(t){if(!this._useAudioElement||!_y())throw new P(S.NOT_SUPPORTED,"your browser does not support setting the audio output device");await ui.setSinkID(this.getTrackId(),t)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return Xr(()=>{_.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),xi(this,z.GET_STATS)||Kt({},fy)}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] use audio element to play")),ui.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?ui.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&ui.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new P(S.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new P(S.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new P(S.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(ri.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(ri.ON_NODE,t=>{this._source.processedNode=t;const e=!t;this._useAudioElement!==e&&(this._played?(this.stop(),this._useAudioElement=e,this.play()):this._useAudioElement=e)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ri.ON_TRACK),this.processorDestination.removeAllListeners(ri.ON_NODE)}}).prototype,"setVolume",[cb],Object.getOwnPropertyDescriptor(Ze.prototype,"setVolume"),Ze.prototype),gt(Ze.prototype,"setPlaybackDevice",[db],Object.getOwnPropertyDescriptor(Ze.prototype,"setPlaybackDevice"),Ze.prototype),gt(Ze.prototype,"play",[lb],Object.getOwnPropertyDescriptor(Ze.prototype,"play"),Ze.prototype),gt(Ze.prototype,"stop",[ub],Object.getOwnPropertyDescriptor(Ze.prototype,"stop"),Ze.prototype),gt(Ze.prototype,"pipe",[hb],Object.getOwnPropertyDescriptor(Ze.prototype,"pipe"),Ze.prototype),gt(Ze.prototype,"unpipe",[pb],Object.getOwnPropertyDescriptor(Ze.prototype,"unpipe"),Ze.prototype),Ze);const yr=new class extends qt{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),N(this,"_lastHiddenTime",0),N(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),_.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};class Eb extends qt{constructor(e,i){super(),N(this,"trackMediaType",Xo.DATA),N(this,"_version",1),N(this,"_type",3),N(this,"_config",void 0),N(this,"_originDataChannel",void 0),N(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),N(this,"_dataStreamPacketHandler",{serialize:n=>n,deserialize:n=>n}),N(this,"_datachannelEventMap",new Map),this._config=e,i&&(this._originDataChannel=i,this._bandDataChannelEvents(i)),this._initPacketHeader()}useDataStream(e){this._dataStreamPacketHandler=e}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return C("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,i;return(e=(i=this._originDataChannel)===null||i===void 0?void 0:i.readyState)!==null&&e!==void 0?e:"connecting"}get _originDataChannelId(){var e,i;return(e=(i=this._originDataChannel)===null||i===void 0?void 0:i.id)!==null&&e!==void 0?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new G((e,i)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&e();const n=setTimeout(()=>{var r;i(new P(S.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((r=this._originDataChannel)===null||r===void 0?void 0:r.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(n),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e()},this._originDataChannel.onerror=()=>{throw clearTimeout(n),new P(S.DATACHANNEL_CONNECTION_TIMEOUT)}}else i(new P(S.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){const e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[Zl.OPEN,Zl.CLOSE,Zl.ERROR].forEach(i=>{const n=()=>{this.emit(i)};this._datachannelEventMap.set(i,n),e.addEventListener(i,n)})}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach(i=>{let[n,r]=i;e.removeEventListener(n,r)}),this._datachannelEventMap.clear()}}class u3 extends Eb{constructor(e){super(e),N(this,"_messageListener",void 0),this._messageListener=i=>{if(i.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const n=i.data.slice(0,this._dataStreamPacketHeader.byteLength),r=new DataView(n).getUint8(3);if(r!==this.id)return void(C("SHOW_DATASTREAM2_LOG")&&_.debug("invalid datachannel id: ".concat(r," !== ").concat(this.id)));let s=i.data.slice(this._dataStreamPacketHeader.byteLength);s=this._dataStreamPacketHandler.deserialize(s),this.emit(Zl.MESSAGE,s)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class h3 extends Eb{send(e){if(this._originDataChannel){let i=e;i=this._dataStreamPacketHandler.serialize(e);const n=new Uint8Array(this._dataStreamPacketHeader.byteLength+i.byteLength);n.set(new Uint8Array(this._dataStreamPacketHeader),0),n.set(new Uint8Array(i),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(n.buffer)}}}function iu(){const t=new Blob([atob("ZnVuY3Rpb24gZShlLHQsbil7bGV0IHI9bmV3IFVpbnQ4QXJyYXkoZSx0LG4pLGE9W10sbz0wO2Zvcig7YS5sZW5ndGg8bjspbyszPG4mJjA9PT1yW29dJiYwPT09cltvKzFdJiYzPT09cltvKzJdJiYoMD09PXJbbyszXXx8MT09PXJbbyszXXx8Mj09PXJbbyszXXx8Mz09PXJbbyszXSk/KGEucHVzaChyW29dLHJbbysxXSxyW28rM10pLG8rPTQpOihhLnB1c2gocltvXSksbysrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkoYSl9ZnVuY3Rpb24gdChlLHQpe2NvbnN0IG49ZnVuY3Rpb24oZSl7Y29uc3QgdD1lLmxlbmd0aDtsZXQgbj1bXSxyPTA7Zm9yKDtyPHQ7KXIrMjx0JiYwPT09ZVtyXSYmMD09PWVbcisxXSYmKDA9PT1lW3IrMl18fDE9PT1lW3IrMl18fDI9PT1lW3IrMl18fDM9PT1lW3IrMl0pPyhuLnB1c2goZVtyXSxlW3IrMV0sMyxlW3IrMl0pLHIrPTMpOihuLnB1c2goZVtyXSkscisrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkobil9KHQpLHI9bi5sZW5ndGgsYT1NYXRoLmZsb29yKHIvMjU1KSxvPXIlMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNithKzErcitlLmJ5dGVMZW5ndGgpO3NbMF09MCxzWzFdPTAsc1syXT0wLHNbM109MSxzWzRdPTYsc1s1XT0xMDE7bGV0IGk9MDtmb3IoO2k8YTspc1s2K2ldPTI1NSxpKys7cmV0dXJuIHNbNitpXT1vLGkrKyxzLnNldChuLDYraSkscy5zZXQobmV3IFVpbnQ4QXJyYXkoZSksNitpK3IpLHMuYnVmZmVyfW5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiU2FmYXJpIik+LTEmJi0xPT09bmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJDaHJvbWUiKSYmKHNlbGYub25ydGN0cmFuc2Zvcm09bj0+e2NvbnN0IHI9bi50cmFuc2Zvcm1lcjtsZXQgYT1bXTtyLm9wdGlvbnMucG9ydC5vbm1lc3NhZ2U9ZT0+e2UuZGF0YS5zZWkmJmEucHVzaChlLmRhdGEuc2VpKX0sc2VsZi5wb3N0TWVzc2FnZSgic3RhcnRlZCIpO2NvbnN0IG89ci5yZWFkYWJsZS5nZXRSZWFkZXIoKSxzPXIud3JpdGFibGUuZ2V0V3JpdGVyKCk7InJ4Ij09PXIub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQobil7by5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1mdW5jdGlvbih0KXtjb25zdCBuPW5ldyBEYXRhVmlldyh0LmRhdGEpO2xldCByPTA7Zm9yKDtyKzQ8dC5kYXRhLmJ5dGVMZW5ndGg7KXtpZigwPT09bi5nZXRVaW50OChyKzApJiYwPT09bi5nZXRVaW50OChyKzEpJiYwPT09bi5nZXRVaW50OChyKzIpJiYxPT09bi5nZXRVaW50OChyKzMpJiY2PT09bi5nZXRVaW50OChyKzQpKXtsZXQgYT1yKzYsbz0wLHM9MDtmb3IoOzI1NT09PShzPW4uZ2V0VWludDgoYSsrKSk7KW8rPTI1NTtvKz1zO2NvbnN0IGk9ZSh0LmRhdGEsYSxvKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkoaSl9cisrfXJldHVybiBudWxsfShyLnZhbHVlKTt0JiZuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7c2VpOnR9KX1zLndyaXRlKHIudmFsdWUpLG4ub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQobil9fSkpfShyKToidHgiPT09ci5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIGUobil7by5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgZT1hLnNoaWZ0KCk7ZSYmKHIudmFsdWUuZGF0YT10KHIudmFsdWUuZGF0YSxlKSl9cy53cml0ZShyLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0ocil9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKSk7Cg==")],{type:"text/javascript"});return setTimeout(()=>il.revokeObjectURL(t),0),new Worker(il.createObjectURL(t))}var ia=function(t){return t[t.AUDIO_LEVEL=1]="AUDIO_LEVEL",t[t.METADATA=2]="METADATA",t}(ia||{});function mb(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i=t.getUint8(0);if(i!==71)return;const n=t.getUint16(1),r=3+n,s=new Uint8Array(t.byteLength-r);s.set(new Uint8Array(t.buffer,r,t.byteLength-r));const o={m:i,tlvLen:n,tlv:[],frame:s};let a=3;for(;a<r;){const c=t.getUint8(a),d=t.getUint16(a+1),l=3;if(c===ia.AUDIO_LEVEL){let u=t.getUint8(a+l);for(let h=1;h<d;h++)u=u<<8|t.getUint8(a+l+h);o.tlv.push({tag:c,length:d,value:e?127^u>>1:127&u})}else if(c===ia.METADATA){const u=new Uint8Array(d);for(let h=0;h<d;h++)u[h]=t.getUint8(a+l+h);o.tlv.push({tag:c,length:d,value:u})}a+=l+d}return o}const nu=new Map;async function p3(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!St().supportWebRTCEncodedTransform)return void _.warning("browser not support audio encoded transform");if(nu.has(t)||!t.track)return;const i={track:t.track};if(Rr()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams()}catch(o){return void _.error("create audio-encoded-streams error",o&&o.message)}const s=new TransformStream({transform(o,a){i.controller||(i.controller=a),t.track&&t.track.id!==i.track.id&&(_.debug("audio track changed: ".concat(i.track.id," => ").concat(t.track.id)),i.track.removeEventListener("ended",n),i.track=t.track,i.track.addEventListener("ended",n));const c=e.metadata&&e.metadata();c?function(d,l){const{chunk:u,controller:h}=l;u.data=function(p,T,m){const f=m.byteLength,R=f+1+2,v=3+R,A=new ArrayBuffer(p.byteLength+v),O=new DataView(A);O.setUint8(0,71),O.setUint16(1,R),O.setUint8(3,T),O.setUint16(4,f);for(let b=0;b<f;b++)O.setUint8(6+b,m[b]);const w=new Uint8Array(O.buffer);return w.set(new Uint8Array(p),v),w.buffer}(u.data,ia.METADATA,d),h.enqueue(u)}(c,{sender:t,chunk:o,controller:a}):a.enqueue(o)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else if(Ve()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");const r=iu(),s=new MessageChannel;await new G(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});const o=new RTCRtpScriptTransform(r,{name:"tx",port:s.port2},[s.port2]);t.transform=o,await new G(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),s.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==i.track.id&&(_.debug("audio track changed: ".concat(i.track.id," => ").concat(t.track.id)),i.track.removeEventListener("ended",n),i.track=t.track,i.track.addEventListener("ended",n))},i.worker=r}function n(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",n)}const r=nu.get(t);if(r){nu.delete(t);try{var s,o;(s=r.controller)===null||s===void 0||s.terminate(),(o=r.worker)===null||o===void 0||o.terminate()}catch(a){_.warning(a&&a.message)}}}nu.set(t,i),t.track.addEventListener("ended",n)}const ru=127,Fs=1e-10,HE=139/13,su=new Map;function KE(t,e,i){const n="".concat(t,"-").concat(e,"-").concat(i);let r=0;return su.has(n)?r=su.get(n):(r=Math.log(function(o,a){const c=o-a;a<c&&(a=c);let d=1;for(let l=o,u=1;l>a;l--,u++)d=d*l/u;return d}(e,t))+t*Math.log(.5)+(e-t)*Math.log(1-.5)-Math.log(i)+i*t,su.set(n,r)),r<Fs&&(r=Fs),r}function fb(t,e,i){const n=e.length,r=t.length/n;let s=!1;for(let o=0,a=0;o<n;o++){let c=0;for(let d=a+r;a<d;a++)t[a]>i&&c++;e[o]!==c&&(e[o]=c,s=!0)}return s}window.cache=su;let _3=0;class gb{constructor(e){N(this,"id",void 0),N(this,"immediates",[]),N(this,"lastNonSilence",-1),N(this,"immediateSpeechActivityScore",Fs),N(this,"lastLevelChangedTime",Date.now()),N(this,"levels",[]),N(this,"longs",[]),N(this,"longSpeechActivityScore",Fs),N(this,"mediums",[]),N(this,"mediumSpeechActivityScore",Fs),N(this,"minLevel",0),N(this,"nextMinLevel",0),N(this,"nextMinLevelWindowLength",0),N(this,"energyScore",0),this.id=e||"".concat(_3++),this.immediates.length=50,this.mediums.length=10,this.longs.length=1,this.levels.length=this.immediates.length}computeImmediates(){const e=this.immediates,i=this.levels,n=this.minLevel+HE;let r=!1;for(let s=0;s<e.length;++s){let o=i[s];o<n&&(o=0);const a=Math.floor(o/HE);e[s]!==a&&(e[s]=a,r=!0)}return r}computeLongs(){return fb(this.mediums,this.longs,4)}computeMediums(){return fb(this.immediates,this.mediums,7)}evaluateImmediateSpeechActivityScore(){this.immediateSpeechActivityScore=KE(this.immediates[0],13,.78)}evaluateLongSpeechActivityScore(e){this.longSpeechActivityScore=KE(this.longs[0],10,47),this.longSpeechActivityScore>Fs&&(this.lastNonSilence=e)}evaluateMediumSpeechActivityScore(){this.mediumSpeechActivityScore=KE(this.mediums[0],5,24)}evaluateSpeechActivityScores(e){this.computeImmediates()&&(this.evaluateImmediateSpeechActivityScore(),this.computeMediums()&&(this.evaluateMediumSpeechActivityScore(),this.computeLongs()&&this.evaluateLongSpeechActivityScore(e)))}getLastLevelChangedTime(){return this.lastLevelChangedTime}getLevels(){var e;return"[".concat(rg(e=[...this.levels]).call(e).join(),"]")}getSpeechActivityScore(e){switch(e){case 0:return this.immediateSpeechActivityScore;case 1:return this.mediumSpeechActivityScore;case 2:return this.longSpeechActivityScore;default:throw new Error("interval "+e)}}levelChanged(e,i){if(this.lastLevelChangedTime<=i){this.lastLevelChangedTime=i;let n=e;return e<0&&(n=0),e>ru&&(n=ru),this.levels.unshift(n),this.levels.length>this.immediates.length&&this.levels.pop(),this.updateMinLevel(n),n>=this.minLevel+HE?n:n/2}return-1}levelTimedOut(){this.levelChanged(0,this.lastLevelChangedTime)}updateMinLevel(e){if(e!==0){if(this.minLevel===0||this.minLevel>e)return this.minLevel=e,this.nextMinLevel=0,void(this.nextMinLevelWindowLength=0);if(this.nextMinLevel===0)return this.nextMinLevel=e,void(this.nextMinLevelWindowLength=1);if(this.nextMinLevel>e&&(this.nextMinLevel=e),this.nextMinLevelWindowLength++,this.nextMinLevelWindowLength>=750){let i=Math.sqrt(this.minLevel*this.nextMinLevel);i<0?i=0:i>ru&&(i=ru),this.minLevel=i,this.nextMinLevel=0,this.nextMinLevelWindowLength=0}}}}class E3{constructor(e){N(this,"algorithm",void 0),this.algorithm=e}execute(){let e=!this.algorithm;if(!e)try{const i=this.algorithm.runInDecisionMaker(this);i<=0?e=!0:setTimeout(this.execute.bind(this),i)}catch{e=!0}e&&this.algorithm&&this.algorithm.decisionMakerExited(this)}}class YE{constructor(e,i,n){N(this,"isDominant",void 0),N(this,"energyRanking",void 0),N(this,"energyScore",void 0),this.isDominant=e,this.energyRanking=i,this.energyScore=n}}class m3 extends qt{constructor(e){super(),N(this,"dominantId",null),N(this,"lastDecisionTime",0),N(this,"lastLevelChangedTime",0),N(this,"lastLevelIdleTime",0),N(this,"relativeSpeechActivities",[]),N(this,"speakers",new Map),N(this,"enableSilence",!1),N(this,"timeoutToSilenceInterval",0),N(this,"decisionMaker",null),N(this,"loudest",[]),N(this,"numLoudestToTrack",3),N(this,"energyExpireTimeMs",250),N(this,"energyAlphaPct",50),this.timeoutToSilenceInterval=e,this.enableSilence=e>0,this.relativeSpeechActivities.length=3}setLoudestConfig(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3,i=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;this.numLoudestToTrack=e,i!=null&&(this.energyExpireTimeMs=i),n!=null&&(this.energyAlphaPct=n),this.loudest.length>e&&this.loudest.splice(e)}getDominantSpeaker(){return this.dominantId}isAmongLoudest(e){return this.loudest.some(i=>i.id===e)}levelChanged(e,i){const n=Date.now(),r=this.getOrCreateSpeaker(e);this.lastLevelChangedTime<n&&(this.lastLevelChangedTime=n,this.maybeStartDecisionMaker());const s=r.levelChanged(i,n);return this.updateLoudestList(r,s,n)}runInDecisionMaker(e){return this.decisionMaker!==e||this.lastDecisionTime>0&&this.lastDecisionTime-this.lastLevelChangedTime>=15e3?-1:this._runInDecisionMaker()}decisionMakerExited(e){this.decisionMaker===e&&(this.decisionMaker=null)}destroy(){this.decisionMaker=null,this.loudest.length=0,this.speakers.clear(),this.removeAllListeners()}addSpeakers(e){e.forEach(i=>{this.speakers.has(i.id)||this.speakers.set(i.id,i)})}removeSpeakers(e){e.forEach(i=>{this.speakers.delete(i.id)})}getOrCreateSpeaker(e){let i=this.speakers.get(e);return i||(i=new gb(e),this.speakers.set(e,i),this.maybeStartDecisionMaker()),i}updateLoudestList(e,i,n){const r=e.id===this.dominantId;if(i<0){let c=0;for(;c<this.loudest.length&&this.loudest[c]!==e;)++c;return new YE(r,c,e.energyScore)}if(e.energyScore=Math.floor((this.energyAlphaPct*i+(100-this.energyAlphaPct)*e.energyScore+50)/100),this.numLoudestToTrack===0)return new YE(r,0,e.energyScore);const s=n-this.energyExpireTimeMs;let o=0;for(;o<this.loudest.length;){const c=this.loudest[o];if(c.getLastLevelChangedTime()<s&&this.loudest.length>=this.numLoudestToTrack)this.loudest.splice(o,1);else if(c.id!==e.id)++o;else if(this.loudest.splice(o,1),this.loudest.length<this.numLoudestToTrack)break}let a=0;for(;a<this.loudest.length&&!(this.loudest[a].energyScore<e.energyScore);)++a;return a<this.numLoudestToTrack&&(this.loudest.splice(a,0,e),this.loudest.length>this.numLoudestToTrack&&this.loudest.splice(this.numLoudestToTrack,1)),new YE(r,a,e.energyScore)}maybeStartDecisionMaker(){!this.decisionMaker&&this.speakers.size>0&&(this.decisionMaker=new E3(this),this.decisionMaker.execute())}makeDecision(e){let i=null,n=null;const r=this.speakers.size;let s=null;if(r===0)s=null;else if(r===1){var o;const a=Mi(o=this.speakers).call(o).next().value;this.enableSilence&&a&&(s=a.id,a.evaluateSpeechActivityScores(e),e-a.lastNonSilence>this.timeoutToSilenceInterval&&(s=null))}else{let a=this.dominantId==null?null:this.speakers.get(this.dominantId);if(a==null){const l=this.speakers.entries().next();l.value&&(s=l.value[0],a=l.value[1])}else s=a.id;a!=null&&a.evaluateSpeechActivityScores(e);const c=this.relativeSpeechActivities;let d=2;for(const l of this.speakers.entries()){const[u,h]=l;if(h===a)continue;h.evaluateSpeechActivityScores(e);for(let f=0;f<c.length;++f){const R=a==null?Fs:a.getSpeechActivityScore(f);c[f]=Math.log(h.getSpeechActivityScore(f)/R)}const p=c[0],T=c[1],m=c[2];p>3&&T>2&&m>0&&T>d&&(d=T,s=u)}this.enableSilence&&a!=null&&s===a.id&&e-a.lastNonSilence>this.timeoutToSilenceInterval&&(s=null)}s==null&&!this.enableSilence||s===this.dominantId||(i=this.dominantId,this.dominantId=s,n=this.dominantId),n==null&&!this.enableSilence||n===i||this.emit("ActiveSpeakerChanged",n)}_runInDecisionMaker(){const e=Date.now(),i=300-(e-this.lastLevelIdleTime);let n=0;i<=0?(this.lastLevelIdleTime!==0&&this.timeoutIdleLevels(e),this.lastLevelIdleTime=e):n=i;let r=300-(e-this.lastDecisionTime);return r<=0&&(this.lastDecisionTime=e,this.makeDecision(e),r=300-(Date.now()-e)),r>0&&n>r&&(n=r),n}timeoutIdleLevels(e){const i=[];for(const r of Mi(n=this.speakers).call(n)){var n;const s=e-r.getLastLevelChangedTime();36e5<s&&(this.dominantId==null||r.id!==this.dominantId)?i.push(r.id):300<s&&r.levelTimedOut()}i.forEach(r=>this.speakers.delete(r))}}const na=new Map;let Vn=null,ou=null,Bs=[];const f3=1e3/15,Fn=new Map,au=new Map;class g3{get samples(){return this.actives+this.inactives}get activeRate(){return this.actives/this.samples}constructor(e,i){N(this,"id",void 0),N(this,"track",void 0),N(this,"score",0),N(this,"active",!0),N(this,"muted",!1),N(this,"timer",0),N(this,"actives",0),N(this,"inactives",0),this.id=e,this.track=i,this.setActive(Fn.size<3)}autoCheckActive(){this.autoSetActive(),this.autoAdjustActive(),this.resetTimer(),this.actives=0,this.inactives=0}autoSetActive(){const e=this.active;this.active=this.activeRate>=.8;const{actives:i,inactives:n}=function(){const r=[],s=[];return Array.from(Mi(Fn).call(Fn)).forEach(o=>{o.active?r.push(o):s.push(o)}),{actives:r,inactives:s}}();if(i.length>3){let r;i.forEach(s=>{(!r||r.score>s.score)&&(r=s)}),r&&r.setActive(!1)}if(i.length<3&&n.length>0){let r;n.forEach(s=>{(!r||r.score<s.score)&&s.id!==this.id&&(r=s)}),r&&e&&!this.active&&(r.samples>40&&r.activeRate-this.activeRate>.4?r.setActive(!0):this.active=!0)}this.setMuted(!this.active)}setActive(e){this.active=e,this.resetTimer(),this.setMuted(!e)}autoAdjustActive(){this.active?this.autoSwitchToInactive():this.autoSwitchToActive()}autoSwitchToActive(){const e=function(i){let n;return Array.from(Mi(Fn).call(Fn)).forEach(r=>{!r.active||r.id===i||r.samples<40||(!n||r.score<n.score)&&(n=r)}),n}(this.id);e&&this.activeRate-e.activeRate>.4&&(e.setActive(!1),this.setActive(!0))}autoSwitchToInactive(){const e=function(i){let n;return Array.from(Mi(Fn).call(Fn)).forEach(r=>{r.active||r.id===i||r.samples<40||(!n||r.score>n.score)&&(n=r)}),n}(this.id);e&&e.activeRate-this.activeRate>.4&&(e.setActive(!0),this.setActive(!1))}addSample(e){e?this.actives+=1:this.inactives+=1,this.samples>f3&&this.autoCheckActive()}setMuted(e){this.track&&(this.track.enabled=!e,this.muted=e)}resetTimer(){this.clearTimer(),this.timer=window.setTimeout(()=>{if(this.samples!==0)return this.samples<50?this.resetTimer():void this.autoCheckActive()},1e3)}clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=0)}}let cu;function Tb(t){const e=Fn.get(t);e&&(Fn.delete(t),e.clearTimer())}const du=new Map,T3=new Map;async function qE(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!St().supportWebRTCEncodedTransform)return void _.warning("browser not support audio encoded transform");if(du.has(t))return;const i={track:t.track};if(Rr()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");rE(Ct.CHROME,87,116)||(e.enableTopn=!1);let r=null;try{r=t.createEncodedStreams()}catch(o){return void _.error("create audio-encoded-streams error",o&&o.message)}const s=new TransformStream({transform(o,a){i.controller||(i.controller=a),t.track&&t.track.id!==i.track.id&&(_.debug("audio track changed: ".concat(i.track.id," => ").concat(t.track.id)),i.track.removeEventListener("ended",n),i.track=t.track,i.track.addEventListener("ended",n)),e.enableTopn?function(c,d,l){var u;const h=mb(new DataView(d.data));if(!h)return l.enqueue(d);const p=c.track.id;T3.set(p,c.track);const T=(u=h.tlv.find(O=>O.tag===ia.AUDIO_LEVEL))===null||u===void 0?void 0:u.value;let m=0;typeof T=="number"&&(m=127-T);const f=Math.round(Math.pow(10,m/60)-1),{selected:R,speaker:v}=function(O,w){let b=na.get(O);if(b||(b=function(L){const x=new gb;return na.set(L,x),Vn||(Vn=new m3(C("TOPN_SILENCE_THRESHOLD")||500),Vn.on("ActiveSpeakerChanged",W=>{W!=null&&(ou=W)})),Vn.addSpeakers([x]),x}(O)),na.size<=3)return{selected:!0,speaker:b};if(!Vn)throw new Error("no active speaker detector");return Vn.levelChanged(b.id,w),Bs=Vn.loudest.map(L=>L.id),ou&&!B(Bs).call(Bs,ou)&&Bs.length>=3&&Bs.pop(),{selected:B(Bs).call(Bs,b.id)||b.id===ou,speaker:b}}(c,f),A=function(O,w,b){const L=Fn.get(O)||new g3(O,w);return L.score=b,Fn.set(O,L),function(x){if(au.set(x,!0),!cu)return void(cu=Date.now());const W=Date.now();W-cu>1e3&&(au.get(x)?au.set(x,!1):(Tb(x),au.delete(x)),cu=W)}(O),L}(p,c.track,v.energyScore);A.addSample(R),A.active&&(d.data=h.frame.buffer,l.enqueue(d))}(t,o,a):e.enableMetadata?function(c,d,l){const u=mb(new DataView(c.data));if(!u)return d.enqueue(c);const h=u.tlv.find(p=>p.tag===ia.METADATA);h&&l&&h.value instanceof Uint8Array&&l(h.value),c.data=u.frame.buffer,d.enqueue(c)}(o,a,e.onMetadata):a.enqueue(o)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else if(Ve()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");const r=iu(),s=new MessageChannel;await new G(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});const o=new RTCRtpScriptTransform(r,{name:"rx",port:s.port2},[s.port2]);t.transform=o,await new G(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),s.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==i.track.id&&(_.debug("audio track changed: ".concat(i.track.id," => ").concat(t.track.id)),i.track.removeEventListener("ended",n),i.track=t.track,i.track.addEventListener("ended",n))},i.worker=r}function n(){t.track.removeEventListener("ended",n),function(r){const s=du.get(r);if(s){(function(c){const d=na.get(c);d&&(na.delete(c),Vn&&(Vn.removeSpeakers([d]),na.size===0&&(Vn.destroy(),Vn=null)))})(r),Tb(r.track.id),du.delete(r);try{var o,a;(o=s.controller)===null||o===void 0||o.terminate(),(a=s.worker)===null||a===void 0||a.terminate()}catch(c){_.warning(c&&c.message)}}}(t)}du.set(t,i),t.track.addEventListener("ended",n)}function S3(t,e,i){let n=new Uint8Array(t,e,i),r=[],s=0;for(;r.length<i;)s+3<i&&n[s]===0&&n[s+1]===0&&n[s+2]===3&&(n[s+3]===0||n[s+3]===1||n[s+3]===2||n[s+3]===3)?(r.push(n[s],n[s+1],n[s+3]),s+=4):(r.push(n[s]),s++);return new Uint8Array(r)}const lu=new Map;async function R3(t,e){if(!St().supportWebRTCEncodedTransform)return void _.warning("browser not support video encoded transform");if(lu.has(t)||!t.track)return;const i={track:t.track};if(Rr()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams()}catch(a){return void _.error("create video-encoded-streams error",a&&a.message)}const s=[];e.on("sei-to-send",a=>{s.push(a)});const o=new TransformStream({transform(a,c){i.controller||(i.controller=c),t.track&&t.track.id!==i.track.id&&(_.debug("video track changed: ".concat(i.track.id," => ").concat(t.track.id)),i.track.removeEventListener("ended",n),i.track=t.track,i.track.addEventListener("ended",n));const d=s.shift();d&&(a.data=function(l,u){const h=function(v){const A=v.length;let O=[],w=0;for(;w<A;)w+2<A&&v[w]===0&&v[w+1]===0&&(v[w+2]===0||v[w+2]===1||v[w+2]===2||v[w+2]===3)?(O.push(v[w],v[w+1],3,v[w+2]),w+=3):(O.push(v[w]),w++);return new Uint8Array(O)}(u),p=h.length,T=Math.floor(p/255),m=p%255,f=new Uint8Array(6+T+1+p+l.byteLength);f[0]=0,f[1]=0,f[2]=0,f[3]=1,f[4]=6,f[5]=101;let R=0;for(;R<T;)f[6+R]=255,R++;return f[6+R]=m,R++,f.set(h,6+R),f.set(new Uint8Array(l),6+R+p),f.buffer}(a.data,d)),c.enqueue(a)}});r.readable.pipeThrough(o).pipeTo(r.writable)}else{if(!Ve())return;{if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");const r=iu(),s=new MessageChannel;await new G(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});const o=new RTCRtpScriptTransform(r,{name:"tx",port:s.port2},[s.port2]);t.transform=o,await new G(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),e.on("sei-to-send",a=>{s.port1.postMessage({sei:a})}),s.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==i.track.id&&(_.debug("video track changed: ".concat(i.track.id," => ").concat(t.track.id)),i.track.removeEventListener("ended",n),i.track=t.track,i.track.addEventListener("ended",n))},i.worker=r}}function n(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",n)}const r=lu.get(t);if(r){lu.delete(t);try{var s,o;(s=r.controller)===null||s===void 0||s.terminate(),(o=r.worker)===null||o===void 0||o.terminate()}catch(a){_.warning(a&&a.message)}}}lu.set(t,i),t.track.addEventListener("ended",n)}const vc=new Map;async function zE(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!St().supportWebRTCEncodedTransform)return void _.warning("browser not support video encoded transform");if(!t.track)return;if(vc.has(t)){const r=vc.get(t);return void(r&&(r.onSei=e.onSei))}const i={track:t.track,onSei:e.onSei};if(Rr()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams()}catch(o){return void _.error("create video-encoded-streams error",o&&o.message)}const s=new TransformStream({transform(o,a){i.controller||(i.controller=a),t.track&&t.track.id!==i.track.id&&(_.debug("video track changed: ".concat(i.track.id," => ").concat(t.track.id)),i.track.removeEventListener("ended",n),i.track=t.track,i.track.addEventListener("ended",n));const c=function(d){const l=new DataView(d.data);let u=0;for(;u+4<d.data.byteLength;){if(l.getUint8(u+0)===0&&l.getUint8(u+1)===0&&l.getUint8(u+2)===0&&l.getUint8(u+3)===1&&l.getUint8(u+4)===6){let h=u+6,p=0,T=0;for(;(T=l.getUint8(h++))===255;)p+=255;p+=T;const m=S3(d.data,h,p);return new Uint8Array(m)}u++}return null}(o);c&&i.onSei&&i.onSei(c),a.enqueue(o)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else if(Ve()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");const r=iu(),s=new MessageChannel;await new G(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});const o=new RTCRtpScriptTransform(r,{name:"rx",port:s.port2},[s.port2]);t.transform=o,await new G(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),s.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==i.track.id?(_.debug("video track changed: ".concat(i.track.id," => ").concat(t.track.id)),i.track.removeEventListener("ended",n),i.track=t.track,i.track.addEventListener("ended",n)):a.data.sei&&i.onSei&&i.onSei(a.data.sei)},i.worker=r}function n(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",n)}(function(r){const s=vc.get(r);if(s){vc.delete(r);try{var o,a;(o=s.controller)===null||o===void 0||o.terminate(),(a=s.worker)===null||a===void 0||a.terminate()}catch(c){_.warning(c&&c.message)}}})(t)}vc.set(t,i),t.track.addEventListener("ended",n)}(function(){const t=Tt();Me.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),Me.getStreamFromExtension=t.name===Ct.CHROME&&Number(t.version)>34,Me.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const e=new RTCPeerConnection;let i=!1;try{e.addTransceiver("audio"),i=!0}catch{}return e.close(),i}(),Me.supportMinBitrate=t.name===Ct.CHROME||t.name===Ct.EDGE,Me.supportSetRtpSenderParameters=function(){const e=Tt();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!vr()||!(!Ve()&&!Fl())||e.name===Ct.FIREFOX&&Number(e.version)>=64)}(),t.name===Ct.SAFARI&&(Number(t.version)>=14?Me.supportDualStream=!0:Me.supportDualStream=!1),Me.webAudioMediaStreamDest=function(){const e=Tt();return!(e.name===Ct.SAFARI&&Number(e.version)<12)}(),Me.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",Me.supportWebGL=typeof WebGLRenderingContext<"u",Me.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,vr()||(Me.webAudioWithAEC=!0),Me.supportShareAudio=function(){const e=Tt();return(e.os===Ie.WIN_10||e.os===Ie.WIN_81||e.os===Ie.WIN_7||e.os===Ie.LINUX||e.os===Ie.MAC_OS||e.os===Ie.CHROMIUM_OS)&&e.name===Ct.CHROME&&Number(e.version)>=74}(),Me.supportDataChannel=!!(Fo(76)||function(e){const i=Tt();return!(i.name!==Ct.FIREFOX||!i.osVersion)&&Number(i.version)>=e}(68)||OI(14)),Me.supportPCSetConfiguration=function(){const e=window.RTCPeerConnection;return!te()&&!!e&&e.prototype.setConfiguration instanceof Function}(),Me.supportWebRTCEncodedTransform=function(){const e=Tt();return e.name==="Chrome"&&Number(e.version)>=87||e.name==="Safari"&&Number(e.version)>=15}(),Me.supportWebRTCInsertableStream=function(){const e=Tt();return(e.name===Ct.CHROME||e.name===Ct.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),Me.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,Me.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,Gl(()=>{Me.supportDualStreamEncoding=function(){const e=Tt();return!!C("DISABLE_WEBAUDIO")||e.name==="Safari"&&Number(e.version)>=14||!!(e.name==="Chrome"&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&C("CHROME_DUAL_STREAM_USE_ENCODING"))}(),_.debug("browser ua: ",navigator.userAgent),_.info("browser info: ",t),_.info("browser compatibility: ",Me)})})();const v3=["CHINA","GLOBAL"],Sb=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],js=[],ra=[];function Gs(t,e){return!!e&&js.some(i=>i.uid===t&&i.channelName===e)}function JE(){return ra.length>0}var C3=Yv.forEach,Rb=_d("forEach")?[].forEach:function(t){return C3(this,t,arguments.length>1?arguments[1]:void 0)};bt({target:"Array",proto:!0,forced:[].forEach!==Rb},{forEach:Rb});var I3=dn("Array","forEach"),y3=mr,A3=He,b3=ei,w3=I3,XE=Array.prototype,O3={DOMTokenList:!0,NodeList:!0},N3=function(t){var e=t.forEach;return t===XE||b3(XE,t)&&e===XE.forEach||A3(O3,y3(t))?w3:e},D3=Bt(N3),P3=qn,vb=Sd;bt({target:"Object",stat:!0,forced:$t(function(){vb(1)})},{keys:function(t){return vb(P3(t))}});var Cb=Bt(zi.Object.keys),L3=Bt(eg),k3=Bt(ng),M3=bt,Ib=Ma,U3=kd,x3=fi,yb=Rh,V3=Br,F3=Vr,B3=Vp,j3=me,G3=Gr,W3=Uv("slice"),H3=j3("species"),QE=Array,K3=Math.max;M3({target:"Array",proto:!0,forced:!W3},{slice:function(t,e){var i,n,r,s=F3(this),o=V3(s),a=yb(t,o),c=yb(e===void 0?o:e,o);if(Ib(s)&&(i=s.constructor,(U3(i)&&(i===QE||Ib(i.prototype))||x3(i)&&(i=i[H3])===null)&&(i=void 0),i===QE||i===void 0))return G3(s,a,c);for(n=new(i===void 0?QE:i)(K3(c-a,0)),r=0;a<c;a++,r++)a in s&&B3(n,r,s[a]);return n.length=r,n}});var Y3=dn("Array","slice"),q3=ei,z3=Y3,ZE=Array.prototype,J3=function(t){var e=t.slice;return t===ZE||q3(ZE,t)&&e===ZE.slice?z3:e},X3=Bt(J3);function J(t,e,i,n,r){var s,o,a,c={};return D3(s=Cb(n)).call(s,function(d){c[d]=n[d]}),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=L3(o=k3(a=X3(i).call(i)).call(a)).call(o,function(d,l){return l(t,e,d)||d},c),r&&c.initializer!==void 0&&(c.value=c.initializer?c.initializer.call(r):void 0,c.initializer=void 0),c.initializer===void 0&&(Pv(t,e,c),c=null),c}let uu=function(t){return t[t.ACCESS_POINT=101]="ACCESS_POINT",t[t.UNILBS=201]="UNILBS",t[t.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",t}({}),$E=function(t){return t[t.IIIEGAL_APPID=1]="IIIEGAL_APPID",t[t.IIIEGAL_UID=2]="IIIEGAL_UID",t[t.INTERNAL_ERROR=3]="INTERNAL_ERROR",t}({}),Tn=function(t){return t[t.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",t[t.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",t[t.INTERNAL_ERROR=8]="INTERNAL_ERROR",t[t.NO_AUTHORIZED=9]="NO_AUTHORIZED",t[t.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",t[t.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",t[t.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",t[t.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",t[t.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",t[t.USER_OVERLOAD=16]="USER_OVERLOAD",t[t.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",t[t.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",t}({}),si=function(t){return t[t.NO_FLAG_SET=100]="NO_FLAG_SET",t[t.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",t[t.INVALID_FALG_SET=102]="INVALID_FALG_SET",t[t.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",t[t.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",t[t.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",t[t.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",t[t.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",t[t.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",t[t.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",t[t.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",t[t.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",t[t.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",t[t.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",t[t.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",t[t.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",t[t.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",t[t.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",t[t.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",t}({}),$=function(t){return t[t.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",t[t.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",t[t.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",t[t.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",t[t.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",t[t.K_TICKET_INVALID=7]="K_TICKET_INVALID",t[t.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",t[t.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",t[t.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",t[t.K_UID_BANNED=14]="K_UID_BANNED",t[t.K_IP_BANNED=15]="K_IP_BANNED",t[t.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",t[t.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",t[t.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",t[t.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",t[t.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",t[t.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",t[t.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",t[t.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",t[t.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",t[t.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",t[t.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",t[t.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",t[t.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",t[t.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",t[t.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",t[t.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",t[t.ERR_INVALID_UID=117]="ERR_INVALID_UID",t[t.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",t[t.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",t[t.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",t[t.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",t[t.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",t[t.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",t[t.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",t[t.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",t[t.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",t[t.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",t[t.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",t[t.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",t[t.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",t[t.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",t[t.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",t[t.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",t[t.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",t[t.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",t[t.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",t[t.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",t[t.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",t[t.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",t[t.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",t[t.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",t[t.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",t[t.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",t[t.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",t[t.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",t[t.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",t[t.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",t[t.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",t[t.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",t[t.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",t[t.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",t[t.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",t[t.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",t[t.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",t}({}),Ft=function(t){return t.CONNECTING="connecting",t.CONNECTED="connected",t.RECONNECTING="reconnecting",t.CLOSED="closed",t}({}),nt=function(t){return t.WS_CONNECTED="ws_connected",t.WS_RECONNECTING="ws_reconnecting",t.WS_CLOSED="ws_closed",t.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",t.ON_BINARY_DATA="on_binary_data",t.REQUEST_RECOVER="request_recover",t.REQUEST_JOIN_INFO="request_join_info",t.REQUEST_REJOIN_INFO="req_rejoin_info",t.IS_P2P_DISCONNECTED="is_p2p_dis",t.DISCONNECT_P2P="dis_p2p",t.ABORT_P2P_EXECUTION="abort_p2p_execution",t.NEED_RENEW_SESSION="need-sid",t.REPORT_JOIN_GATEWAY="report_join_gateway",t.REQUEST_TIMEOUT="request_timeout",t.REQUEST_SUCCESS="request_success",t.JOIN_RESPONSE="join_response",t.PRE_CONNECT_PC="pre_connect_pc",t.P2P_CONNECTION="p2p_connection",t.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",t.P2P_SUBSCRIBE="p2p_subscribe",t.P2P_UNSUBSCRIBE="p2p_unsubscribe",t.P2P_EXCHANGE_SDP="p2p_exchange_sdp",t.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",t.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",t.RECOVER_NOTIFICATION="recover_notification",t}({}),it=function(t){return t.PING="ping",t.PING_BACK="ping_back",t.JOIN="join_v3",t.REJOIN="rejoin_v3",t.LEAVE="leave",t.SET_CLIENT_ROLE="set_client_role",t.PUBLISH="publish",t.PUBLISH_DATASTREAM="publish_datastream",t.UNPUBLISH="unpublish",t.UNPUBLISH_DATASTREAM="unpublish_datastream",t.SUBSCRIBE="subscribe",t.PRE_SUBSCRIBE="pre_subscribe",t.SUBSCRIBE_DATASTREAM="subscribe_datastream",t.SUBSCRIBE_STREAMS="subscribe_streams",t.UNSUBSCRIBE="unsubscribe",t.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",t.UNSUBSCRIBE_STREAMS="unsubscribe_streams",t.SUBSCRIBE_CHANGE="subscribe_change",t.TRAFFIC_STATS="traffic_stats",t.RENEW_TOKEN="renew_token",t.SWITCH_VIDEO_STREAM="switch_video_stream",t.DEFAULT_VIDEO_STREAM="default_video_stream",t.SET_FALLBACK_OPTION="set_fallback_option",t.GATEWAY_INFO="gateway_info",t.CONTROL="control",t.SEND_METADATA="send_metadata",t.DATA_STREAM="data_stream",t.PICK_SVC_LAYER="pick_svc_layer",t.RESTART_ICE="restart_ice",t.CONNECT_PC="connect_pc",t.SET_VIDEO_PROFILE="set_video_profile",t.SET_PARAMETER="set_parameter",t.SET_RTM2_FLAG="set_rtm2_flag",t}({}),Cc=function(t){return t.WRTC_STATS="wrtc_stats",t.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",t.DENOISER_STATS="denoiser_stats",t.EXTENSION_USAGE_STATS="extension_usage_stats",t}({}),ut=function(t){return t.ON_USER_ONLINE="on_user_online",t.ON_USER_OFFLINE="on_user_offline",t.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",t.ON_PUBLISH_STREAM="on_publish_stream",t.ON_UPLINK_STATS="on_uplink_stats",t.ON_P2P_LOST="on_p2p_lost",t.ON_REMOVE_STREAM="on_remove_stream",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",t.ON_USER_BANNED="on_user_banned",t.ON_USER_LICENSE_BANNED="on_user_license_banned",t.ON_NOTIFICATION="on_notification",t.ON_CRYPT_ERROR="on_crypt_error",t.MUTE_AUDIO="mute_audio",t.MUTE_VIDEO="mute_video",t.UNMUTE_AUDIO="unmute_audio",t.UNMUTE_VIDEO="unmute_video",t.ON_P2P_OK="on_p2p_ok",t.RECEIVE_METADATA="receive_metadata",t.ON_DATA_STREAM="on_data_stream",t.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",t.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",t.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",t.ENABLE_LOCAL_VIDEO="enable_local_video",t.DISABLE_LOCAL_VIDEO="disable_local_video",t.ENABLE_LOCAL_AUDIO="enable_local_audio",t.DISABLE_LOCAL_AUDIO="disable_local_audio",t.ON_PUBLISHED_USER_LIST="on_published_user_list",t}({}),oi=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({}),ot=function(t){return t.CONNECTED="websocket:connected",t.RECONNECTING="websocket:reconnecting",t.WILL_RECONNECT="websocket:will_reconnect",t.CLOSED="websocket:closed",t.FAILED="websocket:failed",t.ON_MESSAGE="websocket:on_message",t.REQUEST_NEW_URLS="websocket:request_new_urls",t.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",t}({});function hu(t){if(typeof t!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(t))throw _.error("Invalid Channel Name ".concat(t)),new D(S.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function pu(t){if(e=t,!(typeof e=="number"&&Math.floor(e)===e&&0<=e&&e<=4294967295||xI(t,1,255)))throw new D(S.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var e;typeof t=="string"&&_.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Ar=function(t){return t.TRANSCODE="mix_streaming",t.RAW="raw_streaming",t}({});const Q3={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},tm={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function em(t,e){Le(t.url,"".concat(e,".url"),1,1e3,!1),Xt(t.x)||Pt(t.x,"".concat(e,".x"),0,1e4),Xt(t.y)||Pt(t.y,"".concat(e,".y"),0,1e4),Xt(t.width)||Pt(t.width,"".concat(e,".width"),0,1e4),Xt(t.height)||Pt(t.height,"".concat(e,".height"),0,1e4),Xt(t.zOrder)||Pt(t.zOrder,"".concat(e,".zOrder"),0,255),Xt(t.alpha)||Pt(t.alpha,"".concat(e,".alpha"),0,1,!1)}const Z3={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""};let $r=function(t){return t.WARNING="@live_uap-warning",t.ERROR="@line_uap-error",t.PUBLISH_STREAM_STATUS="@live_uap-publish-status",t.WORKER_STATUS="@live_uap-worker-status",t.REQUEST_NEW_ADDRESS="@live_uap-request-address",t}({}),im=function(t){return t.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",t}({}),ve=function(t){return t[t.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",t[t.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",t[t.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",t[t.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",t[t.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",t[t.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",t[t.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",t[t.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",t[t.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",t[t.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",t[t.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",t[t.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",t[t.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",t[t.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",t[t.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",t[t.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",t}({});function Ab(t){if(!t.channelName)throw new D(S.INVALID_PARAMS,"invalid channelName in info");if(typeof t.uid!="number")throw new D(S.INVALID_PARAMS,"invalid uid in info, uid must be a number");return t.token&&Le(t.token,"info.token",1,2047),pu(t.uid),hu(t.channelName),!0}let ai=function(t){return t[t.SetSdkProfile=0]="SetSdkProfile",t[t.SetSourceChannel=1]="SetSourceChannel",t[t.SetSourceUserId=2]="SetSourceUserId",t[t.SetDestChannel=3]="SetDestChannel",t[t.StartPacketTransfer=4]="StartPacketTransfer",t[t.StopPacketTransfer=5]="StopPacketTransfer",t[t.UpdateDestChannel=6]="UpdateDestChannel",t[t.Reconnect=7]="Reconnect",t[t.SetVideoProfile=8]="SetVideoProfile",t}({}),br=function(t){return t.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",t.NETWORK_CONNECTED="NETWORK_CONNECTED",t.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",t.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",t.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",t.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",t.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",t.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",t.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",t.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",t}({}),Si=function(t){return t.RELAY_STATE_IDLE="RELAY_STATE_IDLE",t.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",t.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",t.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",t}({}),sa=function(t){return t.RELAY_OK="RELAY_OK",t.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",t.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",t.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",t}({}),At=function(t){return t.High="high",t.Low="low",t.Audio="audio",t.Screen="screen",t.ScreenLow="screen_low",t}({}),Oe=function(t){return t.DISCONNECT="disconnect",t.CONNECTION_STATE_CHANGE="connection-state-change",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGE="stream-type-change",t.IS_P2P_DISCONNECTED="is-p2p-dis",t.DISCONNECT_P2P="dis-p2p",t.REQUEST_NEW_GATEWAY_LIST="req-gate-url",t.NEED_RENEW_SESSION="need-sid",t.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",t.JOIN_RESPONSE="join-response",t.RESET_CONNECTION_EVENTS="reset-connection-events",t.PRE_CONNECT_PC="pre-connect_pc",t.UPDATE_GATEWAY_CONFIG="update-gateway-config",t}({}),_u=function(t){return t.P2P_DISCONNECTED="P2P_DISCONNECTED",t.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",t.TIMEOUT="TIMEOUT",t.UNKNOWN_REASON="UNKNOWN_REASON",t}({}),Ae=function(t){return t[t.Nothing=0]="Nothing",t[t.Audio=1]="Audio",t[t.LwoVideo=2]="LwoVideo",t[t.Video=4]="Video",t[t.Data=8]="Data",t[t.DataStream0=256]="DataStream0",t[t.DataStream1=512]="DataStream1",t[t.DataStream2=1024]="DataStream2",t[t.DataStream3=2048]="DataStream3",t[t.DataStream4=4096]="DataStream4",t[t.DataStream5=8192]="DataStream5",t[t.DataStream6=16384]="DataStream6",t[t.DataStream7=32768]="DataStream7",t}({}),Rt=function(t){return t.CHINA="CHINA",t.ASIA="ASIA",t.NORTH_AMERICA="NORTH_AMERICA",t.EUROPE="EUROPE",t.JAPAN="JAPAN",t.INDIA="INDIA",t.KOREA="KOREA",t.HKMC="HKMC",t.US="US",t.OCEANIA="OCEANIA",t.SOUTH_AMERICA="SOUTH_AMERICA",t.AFRICA="AFRICA",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="EXTENSIONS",t}({});const bb=[Rt.AFRICA,Rt.ASIA,Rt.CHINA,Rt.EUROPE,Rt.GLOBAL,Rt.INDIA,Rt.JAPAN,Rt.NORTH_AMERICA,Rt.OCEANIA,Rt.OVERSEA,Rt.SOUTH_AMERICA];let Ye=function(t){return t.CHINA="CN",t.ASIA="AS",t.NORTH_AMERICA="NA",t.EUROPE="EU",t.JAPAN="JP",t.INDIA="IN",t.KOREA="KR",t.HKMC="HK",t.US="US",t.OCEANIA="OC",t.SOUTH_AMERICA="SA",t.AFRICA="AF",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="GLOBAL",t}({});const Eu={CHINA:{},ASIA:{CODE:Ye.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Ye.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Ye.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Ye.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Ye.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Ye.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Ye.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Ye.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Ye.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Ye.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Ye.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Ye.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Ye.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};IE&&(Eu.CHINA={CODE:Ye.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let Ic=function(t){return t.UPDATE_BITRATE_LIMIT="update_bitrate_limit",t.UPDATE_CLIENT_ROLE_OPTIONS="update_client_role_options",t}({});function wb(t){return!!t&&!(!t.uplink||!t.id)&&t.uplink.max_bitrate!==void 0&&t.uplink.min_bitrate!==void 0}class Ob extends qt{constructor(e,i){super(),g(this,"onICEConnectionStateChange",void 0),g(this,"onConnectionStateChange",void 0),g(this,"onDTLSTransportStateChange",void 0),g(this,"onDTLSTransportError",void 0),g(this,"onICETransportStateChange",void 0),g(this,"onFirstAudioReceived",void 0),g(this,"onFirstVideoReceived",void 0),g(this,"onFirstAudioDecoded",void 0),g(this,"onFirstVideoDecoded",void 0),g(this,"onFirstVideoDecodedTimeout",void 0),g(this,"onSelectedLocalCandidateChanged",void 0),g(this,"onSelectedRemoteCandidateChanged",void 0),g(this,"onICECandidateError",void 0),g(this,"getLocalVideoStats",void 0)}}class Nb extends Ob{constructor(e,i){super(e,i),g(this,"establishPromise",void 0)}}let q=function(t){return t.VIDEO="video",t.AUDIO="audio",t}({}),Je=function(t){return t.UDP_RELAY="udp_relay",t.UDP_TCP_RELAY="udp_tcp_relay",t.TCP_RELAY="tcp_relay",t.RELAY="relay",t}({}),wr=function(t){return t[t.FIRST_CONNECTION=0]="FIRST_CONNECTION",t[t.UDP_TCP_RESTART=1]="UDP_TCP_RESTART",t[t.RELAY_RESTART=2]="RELAY_RESTART",t[t.TCP_RESTART=3]="TCP_RESTART",t[t.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",t[t.OLD_RESTART=11]="OLD_RESTART",t[t.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",t}({});const Db=["disconnected","failed"];let U=function(t){return t.LocalVideoTrack="videoTrack",t.LocalAudioTrack="audioTrack",t.LocalVideoLowTrack="videoLowTrack",t}({}),yt=function(t){return t.New="new",t.Connected="connected",t.Reconnecting="reconnecting",t.Disconnected="disconnected",t}({}),Z=function(t){return t.AudioMetadata="audioMetadata",t.StateChange="stateChange",t.IceConnectionStateChange="iceConnectionStateChange",t.RequestMuteLocal="requestMuteLocal",t.RequestUnmuteLocal="requestUnmuteLocal",t.RequestRePublish="requestRePublish",t.RequestRePublishDataChannel="requestRePublishDataChannel",t.RequestReSubscribe="requestReSubscribe",t.RequestUploadStats="requestUploadStats",t.RequestUpload="requestUpload",t.MediaReconnectStart="MediaReconnectStart",t.MediaReconnectEnd="MediaReconnectEnd",t.NeedSignalRTT="NeedSignalRTT",t.RequestRestartICE="RequestRestartIce",t.PeerConnectionStateChange="PeerConnectionStateChange",t.RequestReconnect="RequestReconnect",t.RequestReconnectPC="RequestReconnectPC",t.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",t.P2PLost="P2PLost",t.UpdateVideoEncoder="UpdateVideoEncoder",t.ConnectionTypeChange="ConnectionTypeChange",t.RequestLowStreamParameter="RequestLowStreamParameter",t.QueryClientConnectionState="QueryClientConnectionState",t.LocalCandidate="LocalCandidate",t.RequestP2PMuteLocal="requestP2PMuteLocal",t.RequestP2PUnPublish="RequestP2PUnPublish",t.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",t.RequestP2PMuteRemote="RequestP2PMuteRemote",t.RequestP2PRestartICE="RequestP2PRestartICE",t}({}),Sn=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),Rn=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),Ne=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),Pb=function(t){return t.CONNECTED="transmitter:connected",t.RECONNECTING="transmitter:reconnecting",t.WILL_RECONNECT="transmitter:will_reconnect",t.CLOSED="transmitter:closed",t.FAILED="transmitter:failed",t.ON_MESSAGE="transmitter:on_message",t.REQUEST_NEW_URLS="transmitter:request_new_urls",t.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",t.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",t.FAILBACK="transmitter:failback",t.PRE_CONNECT_PC="transmitter:pre_connect_pc",t}({}),rr=function(t){return t.CAMERA_CHANGED="camera-changed",t.MICROPHONE_CHANGED="microphone-changed",t.PLAYBACK_DEVICE_CHANGED="playback-device-changed",t.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",t.AUTOPLAY_FAILED="autoplay-failed",t.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",t.SECURITY_POLICY_VIOLATION="security-policy-violation",t}({}),en=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),Bn=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),oa=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),ae=function(t){return t.CALL="call",t.CANDIDATE="candidate",t.PUBLISH="publish",t.UNPUBLISH="unpublish",t.CONTROL="control",t.RESTART_ICE="restart_ice",t.ACK="ack",t.RESPONSE="response",t.JOIN="join",t.CHECK="check",t}({}),aa=function(t){return t.ABORT="abort",t}({}),ts=function(t){return t.MUTE_LOCAL_AUDIO="mute_local_audio",t.MUTE_LOCAL_VIDEO="mute_local_video",t.UNMUTE_LOCAL_AUDIO="unmute_local_audio",t.UNMUTE_LOCAL_VIDEO="unmute_local_video",t}({}),$3=function(t){return t.P2P_TOKEN_TIMEOUT="p2p_token_timeout",t.P2P_TOKEN_CHANGED="p2p_token_changed",t}({});const tW={[uu.ACCESS_POINT]:{[si.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[si.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[si.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[si.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[si.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[si.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[si.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[si.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[si.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[si.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[si.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[si.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[si.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[si.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[si.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[si.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[si.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[si.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[uu.UNILBS]:{[Tn.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[Tn.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[Tn.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[Tn.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[Tn.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[Tn.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[Tn.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[Tn.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[Tn.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[Tn.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[Tn.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[Tn.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[uu.STRING_UID_ALLOCATOR]:{[$E.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[$E.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[$E.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function ca(t){const e=tW[Math.floor(t/1e4)];if(!e)return{desc:"unknown error",retry:!1};const i=e[t%1e4];if(!i){if(Math.floor(t/1e4)===uu.ACCESS_POINT){const n=t%1e4;if(n.toString()[0]==="1")return{desc:t.toString(),retry:!1};if(n.toString()[0]==="2")return{desc:t.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return i}const eW={[$.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[$.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[$.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[$.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[$.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[$.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[$.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[$.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[$.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[$.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[$.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[$.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[$.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[$.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[$.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[$.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[$.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[$.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[$.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[$.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[$.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[$.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[$.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[$.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[$.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[$.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[$.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[$.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[$.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[$.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[$.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[$.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[$.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[$.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[$.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[$.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[$.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[$.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[$.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[$.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[$.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[$.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[$.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[$.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[$.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[$.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[$.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[$.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[$.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[$.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[$.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[$.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[$.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[$.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[$.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[$.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[$.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[$.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[$.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[$.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[$.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[$.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[$.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[$.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function yc(t){return eW[t]||{desc:"UNKNOWN_ERROR_".concat(t),action:"failed"}}function Lb(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function nm(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Lb(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Lb(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function kb(t,e){if(typeof t=="string")return t;const{proxy:i,host:n,port:r}=t;if(e){const s=C("JOIN_GATEWAY_FALLBACK_PORT")||443;return s===443?"wss://".concat(n,"/ws/?p=").concat(Number(r)+150):"wss://".concat(n,":").concat(s,"/ws/?p=").concat(Number(r)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(n,"&p=").concat(r):"wss://".concat(n,":").concat(r)}const iW=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,nW=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,rW=/wss:\/\/(.+):([0-9]+)\/?/,sW=/wss:\/\/(.[^\/]+)\/?/;let oW=0;class aW{constructor(e,i){g(this,"id",0),g(this,"store",void 0),g(this,"recordIndex",void 0),g(this,"websockets",[]),g(this,"try443PortDuration",2e3),g(this,"forceCloseWSDuration",5e3),g(this,"try443PortTimeout",null),g(this,"forceCloseTimeout",null),g(this,"isTry443PortFailed",!1),g(this,"isNormalPortFailed",!1),g(this,"useDoubleDomain",!1),g(this,"useProxy",!1),g(this,"startTime",Date.now()),this.id=++oW,this.try443PortDuration=C("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=i}closeAllWebsockets(){this.websockets.forEach(e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout),this.forceCloseTimeout=null,this.try443PortTimeout=null}logger(){var e;const i=Date.now()-this.startTime;for(var n=arguments.length,r=new Array(n),s=0;s<n;s++)r[s]=arguments[s];_.debug("[choose-best-ws ".concat((e=this.store)===null||e===void 0?void 0:e.clientId," ").concat(this.id,"] ").concat(i,"ms:"),...r)}createWebSocket(e,i,n){this.logger("createWebSocket:",e,{isTry443Port:i,hasTimeoutDetection:n});const r=C("GATEWAY_DOMAINS"),s=Date.now(),o=[],a=r.find(h=>{var p;return B(p=e.host).call(p,h)});a||(this.useDoubleDomain=!1);const c=[];if(this.useDoubleDomain)r.forEach(h=>{c.push(kb(nm(nm({},e),{},{host:e.host.replace(a,h)}),i))});else{const h=nm({},e);if(i&&a){const p=r.find(T=>T!==a);p&&(h.host=h.host.replace(a,p))}c.push(kb(h,i))}try{c.forEach(h=>{const p=new WebSocket(h);p.binaryType="arraybuffer",o.push(p),this.logger("ws is connecting:",p.url)})}catch(h){if(this.logger("ws create failed"),o.forEach(p=>p.close()),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,i,n);if(!i&&Number(e.port)!==443)return this.createWebSocket(e,!0,n);throw new D(S.WS_ERR,"init websocket failed! Error: ".concat(h.toString()))}const d=uc();this.store&&this.store.recordJoinChannelService({urls:o.map(h=>h.url),service:"gateway"},this.recordIndex),o.forEach(h=>{h.onopen=()=>{this.logger("onopen: ws ".concat(h.url," open cost ").concat(Date.now()-s,"ms")),this.websockets.forEach(p=>{p!==h&&(p.onopen=null,p.onclose=null,p.onmessage=null,p.close(),this.logger("close backup websocket: ".concat(p.url)))}),this.websockets.length=0,d.resolve(h)},h.onclose=p=>{this.logger("onclose: ws ".concat(h.url," closed cost ").concat(Date.now()-s,"ms state: ").concat(h.readyState));const T=o.every(m=>m.readyState===WebSocket.CLOSED||m.readyState===WebSocket.CLOSING);this.logger("".concat(i?"443":"47xx"," websocket closed, all failed: ").concat(T)),T&&(i||this.isTry443PortFailed||this.useProxy)?(this.logger("onclose: all websocket is closed, ".concat(p.reason)),d.reject({code:p.code,reason:_u.A_ROUND_WS_FAILED})):!i&&T&&!this.isNormalPortFailed&&this.try443PortTimeout&&(this.logger("all 47xx websocket is closed, try 443 port"),this.clearTimeout(),u()),i?this.isTry443PortFailed=T:this.isNormalPortFailed=T},h.onmessage=p=>this.logger("".concat(h.url," onmessage: ").concat(p.data))}),this.websockets.push(...o);const l=()=>{this.websockets.forEach(h=>h.readyState!==WebSocket.OPEN&&h.close())},u=()=>{if(d.isResolved)return l();Tt().os===Ie.MAC_OS&&te()&&l(),this.createWebSocket(e,!0,!0).then(h=>{d.resolve(h)}).catch(h=>{this.isNormalPortFailed&&d.reject(h),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",d.isResolved),this.forceCloseTimeout=null,l()},this.forceCloseWSDuration)};return n||(()=>{if(i||this.useProxy)return this.logger("add 5s timeout at ".concat(i?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(()=>{this.forceCloseTimeout=null,l()},this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{this.logger("2s timeout, isWebsocket created: ",d.isResolved),this.try443PortTimeout=null,u()},this.try443PortDuration)})(),d.promise}chooseBestWebsocket(e,i,n,r){return this.useDoubleDomain=!!i,typeof e=="string"&&(e=function(s){let o,a,c;return[,o,a,c]=s.match(iW)||[],o||([,a,c]=s.match(nW)||[]),a&&c||([,a,c]=s.match(rW)||[]),a&&c||([,a]=s.match(sW)||[]),a||_.warning("un-destructible url: ",s),{proxy:o,host:a,port:c||"443"}}(e)),this.recordIndex=r,this.useProxy=!!e.proxy,n&&this.useProxy&&(_.warn("cannot use 443 only when use proxy"),n=!1),this.createWebSocket(e,!!n,!1).finally(()=>this.clearTimeout())}}function Mb(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}class Ub extends qt{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var i;B(i=["tryNext","recover"]).call(i,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(ot.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(ot.CONNECTED):this._state==="closed"?this.emit(ot.CLOSED):this._state==="failed"&&this.emit(ot.FAILED))}resetReconnectCount(e){_.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,i){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3],s=arguments.length>4&&arguments[4]!==void 0&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),g(this,"connectionID",0),g(this,"currentURLIndex",0),g(this,"urls",[]),g(this,"_reconnectMode","tryNext"),g(this,"reconnectReason",void 0),g(this,"_initMutex",void 0),g(this,"name",void 0),g(this,"_state","closed"),g(this,"reconnectInterrupter",void 0),g(this,"websocket",void 0),g(this,"retryConfig",void 0),g(this,"reconnectCount",0),g(this,"forceCloseTimeout",5e3),g(this,"onlineReconnectListener",void 0),g(this,"useCompress",void 0),g(this,"tryDoubleDomain",!1),g(this,"use443PortOnly",!1),g(this,"wsInflateLength",0),g(this,"wsDeflateLength",0),g(this,"closeEstablishingWs",()=>{}),g(this,"store",void 0),g(this,"joinGatewayRecordIndex",void 0),this.store=o,this.name=e,this.retryConfig=function(u){for(var h=1;h<arguments.length;h++){var p=arguments[h]!=null?arguments[h]:{};h%2?Mb(Object(p),!0).forEach(function(T){g(u,T,p[T])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(p)):Mb(Object(p)).forEach(function(T){Object.defineProperty(u,T,Object.getOwnPropertyDescriptor(p,T))})}return u}({},i),this.useCompress=n,this.tryDoubleDomain=r,this.use443PortOnly=s,this._initMutex=new Ke("websocket",o?o.clientId:void 0);const{timeout:a,timeoutFactor:c}=i,d=Math.max(300,Math.floor(3*a/5)),l=Math.max(1.2,Math.floor(8*c)/10);Ni.ONLINE&&(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l),ue.on(jo.NETWORK_STATE_CHANGE,(u,h)=>{u!==h&&(this.resetReconnectCount("network state change: ".concat(h," -> ").concat(u)),u===Ni.ONLINE?(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c))})}getConnection(){return this.websocket||void 0}async init(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=await this._initMutex.lock();this._reconnectMode="tryNext",this.forceCloseTimeout=i,this.urls=e,this.state="connecting";try{const r=uc(),s=this.urls[this.currentURLIndex];C("ENABLE_PREALLOC_PC")&&this.emit(Pb.PRE_CONNECT_PC),this.createWebSocketConnection(s).then(r.resolve).catch(r.reject),this.once(ot.CLOSED,()=>{r.reject(new P(S.WS_DISCONNECT))}),this.once(ot.CONNECTED,r.resolve),await r.promise}catch{}finally{n()}}close(e,i){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const n=this.websocket;i?setTimeout(()=>n.close(),500):n.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,i){if(!this.websocket)return void _.warning("[".concat(this.name,"] can not reconnect, no websocket"));e!==void 0&&(this.reconnectMode=e),_.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(i)]},this.joinGatewayRecordIndex);const n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:i})}sendMessage(e){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new P(S.WS_ABORT,"websocket is not ready");try{i||(e=JSON.stringify(e)),this.websocket.send(e)}catch(n){throw new P(S.WS_ERR,"send websocket message error"+n.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,i=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:i}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var i;const n=uc();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const r=l=>{var u;(u=this.store)===null||u===void 0||u.signalChannelOpen(),_.debug("[".concat(this.name,"] websocket opened:"),l),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n.resolve()},s=async l=>{var u;if(_.debug("[".concat(this.name,"] websocket close ").concat((u=this.websocket)===null||u===void 0?void 0:u.url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)n.reject(new P(S.WS_DISCONNECT,"websocket close: ".concat(l.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");const h=xi(this,ot.WILL_RECONNECT,this.reconnectMode,l.reason)||this.reconnectMode,p=await this.reconnectWithAction(h);if(this.state==="closed")return void _.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!p)return n.reject(new P(S.WS_DISCONNECT,"websocket reconnect failed: ".concat(l.code))),this.close(!0);n.resolve()}},o=l=>{this.emit(ot.ON_MESSAGE,l)},a=l=>{_.warn("[".concat(this.connectionID,"] ws open error ").concat(l))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),C("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=C("GATEWAY_WSS_ADDRESS")),_.debug("[".concat(this.name,"] start connect, url:"),e);const c=(i=this.store)===null||i===void 0?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;const l=await this.chooseBestWebsocketConnection(e);this.websocket=l,r&&r(this.websocket.url),this.websocket.onclose=s,this.websocket.onmessage=o,this.websocket.onerror=a,(d=this.store)===null||d===void 0||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(l){const u=this.state==="closed",h=l instanceof P,p=h&&l.code===S.WS_ABORT,T=h&&l.code===S.WS_ERR,m=h?l.message:l&&(l.reason||l.toString());_.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(m)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:p?"aborted":"error",errors:[l]},c),u||T?(n.reject(u?new P(S.WS_DISCONNECT,"websocket is closed: ".concat(m)):new P(S.WS_ERR,"init websocket failed: ".concat(m))),T&&_.error("[".concat(this.name,"] init websocket failed: ").concat(m))):s&&s(l)}return n.promise}async reconnectWithAction(e){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;_.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||ue.isOnline||!ue.onlineWaiter||(this.onlineReconnectListener=ue.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let n=!0;if(this.reconnectInterrupter=()=>n=!1,i){const o=mE(this.reconnectCount,this.retryConfig);_.debug("[".concat(this.name,"] wait ").concat(o,"ms to reconnect websocket, mode: ").concat(e)),await G.race([ke(o),this.onlineReconnectListener||new G(()=>{})])}if(this._state==="closed"||!n)return!1;this.reconnectCount+=1;const r=async(o,a)=>{this.emit(ot.RECONNECT_CREATE_CONNECTION,a),await this.createWebSocketConnection(o)};try{if(e==="retry")await r(this.urls[this.currentURLIndex],e);else if(e==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);_.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),await r(this.urls[this.currentURLIndex],e)}else e==="recover"&&(_.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=await Be(this,ot.REQUEST_NEW_URLS),this.currentURLIndex=0,await r(this.urls[this.currentURLIndex],e))}catch(o){var s;_.error("[".concat(this.name,"] reconnect failed ").concat(o&&o.toString()));const a=o==null||(s=o.data)===null||s===void 0?void 0:s.desc;return Array.isArray(a)&&B(a).call(a,"dynamic key expired")?(this.emit(ot.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,i)}return!0}}class rm extends Ub{constructor(e,i){super(e,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,i){const n=uc(),r=function(o,a){return new aW(o,a)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{_.debug("[choose-best-ws] close establishing websockets"),r.closeAllWebsockets(),n.reject(new P(S.WS_ABORT,"choose best websocket aborted"))};const s=C("GATEWAY_DOMAINS");return _.debug("[choose-best-ws] currentDomain: ",e,", domains: ",s,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),r.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,i).then(n.resolve).catch(n.reject),n.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class Ac extends Ub{constructor(e,i){super(e,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,i){return new G((n,r)=>{let s=!1;const o=[];this.closeEstablishingWs=()=>{_.debug("[choose-best-ws] close establishing websockets"),o.forEach(T=>{T.onclose=null,T.onopen=null,T.onmessage=null,T.close()}),r(new P(S.WS_ABORT,"choose best websocket aborted"))};const a=C("GATEWAY_DOMAINS");let c;const d=e.indexOf("?h="),l=a.find(T=>d!==-1?B(e).call(e,T,d):B(e).call(e,T));_.debug("[choose-best-ws] currentDomain: ",l,", domains: ",a);let u=!this.tryDoubleDomain||!l;if(!u&&l){var h;const T=Date.now();try{a.forEach(m=>{const f=d===-1?e.replace(l,m):e.substr(0,d)+e.substr(d).replace(l,m),R=new WebSocket(f);R.binaryType="arraybuffer",o.push(R),_.debug("[choose-best-ws] ws is connecting:",R.url)})}catch{for(_.debug("[choose-best-ws] ws create failed, fallback to single url"),o.forEach(f=>f.close());o.length;)o.pop();u=!0}(h=this.store)===null||h===void 0||h.recordJoinChannelService({urls:o.map(m=>m.url),service:"gateway"},i),o.forEach(m=>{m.onopen=()=>{if(s)return;const f=Date.now()-T;_.debug("[choose-best-ws] ws open cost ".concat(f,"ms")),o.filter(R=>R!==m).forEach(R=>{_.debug("[choose-best-ws]close backup websocket: ".concat(R.url)),R.close()}),s=!0,n(m)},m.onclose=f=>{c=f,!s&&(o.find(R=>!(R.readyState===WebSocket.CLOSED||R.readyState===WebSocket.CLOSING))||(_.debug("[choose-best-ws] all websocket is closed"),s=!0,r(c)))},m.onmessage=f=>{_.debug("[choose-best-ws]".concat(m.url," onmessage: ").concat(f.data))}}),ke(this.forceCloseTimeout).then(()=>{o.forEach(m=>{m.readyState!==WebSocket.OPEN&&m.close()})})}if(u){var p;let T;_.debug("[choose-best-ws] use single url: ",e),(p=this.store)===null||p===void 0||p.recordJoinChannelService({urls:[e],service:"gateway"},i);try{T=new WebSocket(e),o.push(T),T.binaryType="arraybuffer"}catch(m){const f=new P(S.WS_ERR,"init websocket failed! Error: ".concat(m.toString()));return _.error("[".concat(this.name,"]").concat(f)),void r(f)}T.onopen=()=>{n(T)},T.onclose=m=>{r(m)},T.onmessage=m=>{_.debug("[choose-best-ws]".concat(T.url," onmessage: ").concat(m.data))},ke(this.forceCloseTimeout).then(()=>{T&&T.readyState!==WebSocket.OPEN&&T.close()})}}).then(n=>(this.closeEstablishingWs=void 0,n)).catch(n=>{throw this.closeEstablishingWs=void 0,n})}}class cW extends qt{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Ft.CONNECTED?this.emit(nt.WS_CONNECTED):e===Ft.RECONNECTING?this.emit(nt.WS_RECONNECTING,this._websocketReconnectReason):e===Ft.CLOSED&&this.emit(nt.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,i){super(),g(this,"_disconnectedReason",void 0),g(this,"_websocketReconnectReason",void 0),g(this,"_connectionState",Ft.CLOSED),g(this,"reconnectToken",void 0),g(this,"websocket",void 0),g(this,"openConnectionTime",void 0),g(this,"clientId",void 0),g(this,"lastMsgTime",Date.now()),g(this,"uploadCache",[]),g(this,"uploadCacheInterval",void 0),g(this,"rttRolling",new $I(5)),g(this,"pingpongTimer",void 0),g(this,"wsInflateDataTimer",void 0),g(this,"pingpongTimeoutCount",0),g(this,"joinResponse",void 0),g(this,"multiIpOption",void 0),g(this,"initError",void 0),g(this,"spec",void 0),g(this,"store",void 0),g(this,"onWebsocketMessage",n=>{if(n.data instanceof ArrayBuffer)return void this.emit(nt.ON_BINARY_DATA,n.data);const r=JSON.parse(n.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){if(this.emit(r._type,r._message),r._type===ut.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===ut.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(It.UID_BANNED);break;case 15:this.close(It.IP_BANNED);break;case 16:this.close(It.CHANNEL_BANNED)}if(r._type===ut.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case $.ERR_LICENSE_MISSING:this.close(It.LICENSE_MISSING);break;case $.ERR_LICENSE_EXPIRED:this.close(It.LICENSE_EXPIRED);break;case $.ERR_LICENSE_MINUTES_EXCEEDED:this.close(It.LICENSE_MINUTES_EXCEEDED);break;case $.ERR_LICENSE_PERIOD_INVALID:this.close(It.LICENSE_PERIOD_INVALID);break;case $.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(It.LICENSE_MULTIPLE_SDK_SERVICE);break;case $.ERR_LICENSE_ILLEGAL:this.close(It.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=i,this.websocket=new rm("gateway-".concat(this.clientId),this.spec.retryConfig,!0,C("JOIN_GATEWAY_USE_DUAL_DOMAIN"),C("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Ft.CONNECTED&&this.reconnect("retry",Fe.OFFLINE)})}async request(e,i,n,r){const s=Ut(6,""),o={_id:s,_type:e,_message:i},a=this.websocket.connectionID,c=()=>new G((T,m)=>{if(this.connectionState===Ft.CONNECTED)return T();const f=()=>{this.off(nt.WS_CLOSED,R),T()},R=()=>{this.off(nt.WS_CONNECTED,f),m(new D(S.WS_ABORT))};this.once(nt.WS_CONNECTED,f),this.once(nt.WS_CLOSED,R),e!==it.PUBLISH&&e!==it.PUBLISH_DATASTREAM&&e!==it.SUBSCRIBE&&e!==it.SUBSCRIBE_DATASTREAM&&e!==it.UNSUBSCRIBE&&e!==it.UNSUBSCRIBE_DATASTREAM&&e!==it.UNPUBLISH&&e!==it.UNPUBLISH_DATASTREAM&&e!==it.CONTROL&&e!==it.RESTART_ICE||this.once(nt.DISCONNECT_P2P,()=>{m(new D(S.DISCONNECT_P2P))}),e!==it.PUBLISH&&e!==it.RESTART_ICE||this.once(nt.ABORT_P2P_EXECUTION,()=>{m(new D(S.DISCONNECT_P2P))})});if(this.connectionState!==Ft.CONNECTING&&this.connectionState!==Ft.RECONNECTING||e===it.JOIN||e===it.REJOIN||await c(),this.websocket.sendMessage(o,!0),r)return;const d=new G((T,m)=>{let f=!1;const R=(A,O)=>{f=!0,T({isSuccess:A==="success",message:O||{}}),this.off(nt.WS_CLOSED,v),this.off(nt.WS_RECONNECTING,v),this.emit(nt.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(s),R);const v=()=>{m(new D(S.WS_ABORT,"type: ".concat(e))),this.off(nt.WS_CLOSED,v),this.off(nt.WS_RECONNECTING,v),this.off("res-@".concat(s),R)};this.once(nt.WS_CLOSED,v),this.once(nt.WS_RECONNECTING,v),ke(C("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||f||(_.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(nt.REQUEST_TIMEOUT,e,i))})});let l=null;try{l=await d}catch(T){if(this.connectionState===Ft.CLOSED||e===it.LEAVE)throw new D(S.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?T.throw():e===it.JOIN||e===it.REJOIN?null:(await c(),await this.request(e,i))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),h=yc(u),p=new D(S.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message,desc:h.desc});return h.action==="success"?l.message:(_.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===$.ERR_TOO_MANY_BROADCASTERS?((e===it.JOIN||e===it.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===$.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Fe.MULTI_IP)):this.reconnect(h.action,Fe.SERVER_ERROR),e===it.JOIN||e===it.REJOIN?null:await this.request(e,i)))}waitMessage(e,i){return new G(n=>{const r=s=>{(!i||i(s))&&(this.off(e,r),n(s))};this.on(e,r)})}uploadWRTCStats(e){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Cc.WRTC_STATS,i)}upload(e,i){const n={_type:e,_message:i};try{this.websocket.sendMessage(n)}catch{const s=C("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Ft.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},C("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,i){const n={_type:e,_message:i};this.websocket.sendMessage(n)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new G((i,n)=>{this.once(nt.WS_CONNECTED,()=>i(this.joinResponse)),this.once(nt.WS_CLOSED,r=>n(this.initError||new D(S.WS_ABORT,r))),this.connectionState=Ft.CONNECTING,this.websocket.init(e).catch(n),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||It.LEAVE,this.connectionState=Ft.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(nt.ABORT_P2P_EXECUTION);const e=await Be(this,nt.REQUEST_JOIN_INFO),i=await this.request(it.JOIN,e);if(!i)return this.emit(nt.REPORT_JOIN_GATEWAY,_u.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(nt.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Ft.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new D(S.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=mc(this,nt.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const i=await this.request(it.REJOIN,e);return!!i&&(this.connectionState=Ft.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),i.peers&&i.peers.forEach(n=>{this.emit(ut.ON_USER_ONLINE,{uid:n.uid}),n.audio&&this.emit(ut.ON_ADD_AUDIO_STREAM,{uid:n.uid,uint_id:n.uint_id,audio:!0,ssrcId:n.audio_ssrc}),n.video&&this.emit(ut.ON_ADD_VIDEO_STREAM,{uid:n.uid,uint_id:n.uint_id,video:!0,ssrcId:n.video_ssrc}),n.audio_mute?this.emit(ut.MUTE_AUDIO,{uid:n.uid}):this.emit(ut.UNMUTE_AUDIO,{uid:n.uid}),n.video_mute?this.emit(ut.MUTE_VIDEO,{uid:n.uid}):this.emit(ut.UNMUTE_VIDEO,{uid:n.uid}),n.audio_enable_local?this.emit(ut.ENABLE_LOCAL_AUDIO,{uid:n.uid}):this.emit(ut.DISABLE_LOCAL_AUDIO,{uid:n.uid}),n.video_enable_local?this.emit(ut.ENABLE_LOCAL_VIDEO,{uid:n.uid}):this.emit(ut.DISABLE_LOCAL_VIDEO,{uid:n.uid}),n.audio||n.video||this.emit(ut.ON_REMOVE_STREAM,{uid:n.uid,uint_id:n.uint_id})}),!0)}reconnect(e,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,i)}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);const i=yc(e.code);if(e.code===28&&"detail"in e&&(_.info("[".concat(this.clientId,"] receive recover notification: "),e.detail),this.emit(nt.RECOVER_NOTIFICATION,e.detail)),i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(It.UID_BANNED),void this.close()):void this.reconnect(i.action,Fe.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=C("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>C("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Fe.TIMEOUT):this.request(it.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const n=Date.now()-i;this.rttRolling.add(n),C("REPORT_STATS")&&this.send(it.PING_BACK,{pingpongElapse:n})}).catch(n=>{})}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:i}=this.websocket.getWsInflateData();e!==0&&i!==0&&this.upload(Cc.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:i,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(ot.RECONNECT_CREATE_CONNECTION,e=>{this.emit(nt.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(ot.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(ot.CLOSED,()=>{this.connectionState=Ft.CLOSED}),this.websocket.on(ot.FAILED,()=>{this._disconnectedReason=It.NETWORK_ERROR,this.connectionState=Ft.CLOSED}),this.websocket.on(ot.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Ft.CONNECTED?this.connectionState=Ft.RECONNECTING:this.connectionState=Ft.CONNECTING}),this.websocket.on(ot.WILL_RECONNECT,(e,i,n)=>{const r=mc(this,nt.IS_P2P_DISCONNECTED),s=r||e!=="retry";r&&e==="retry"&&(_.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",i=_u.P2P_DISCONNECTED),s&&(_.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(nt.REPORT_JOIN_GATEWAY,i||_u.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(nt.DISCONNECT_P2P)),n(e)}),this.websocket.on(ot.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{_.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",Fe.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(nt.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof D){if(e.code===S.UNEXPECTED_RESPONSE&&e.data.code===$.ERR_NO_AUTHORIZED)return this.initError=new D(S.TOKEN_EXPIRE,"dynamic key expired"),void this.close(It.TOKEN_EXPIRE);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Fe.SERVER_ERROR):(this.initError=e,this.close())}})}),this.websocket.on(ot.REQUEST_NEW_URLS,(e,i)=>{Be(this,nt.REQUEST_RECOVER,this.multiIpOption).then(e).catch(i)}),this.websocket.on(ot.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(ut.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(Pb.PRE_CONNECT_PC,()=>{this.emit(nt.PRE_CONNECT_PC)})}}let dW=function(t){return t.NATIVE_RTC="native_rtc",t.NATIVE_RTM="native_rtm",t.WEB_RTC="web_rtc",t.WEB_RTM="web_rtm",t}({}),he=function(t){return t[t.CHOOSE_SERVER=11]="CHOOSE_SERVER",t[t.CLOUD_PROXY=18]="CLOUD_PROXY",t[t.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",t[t.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",t}({});function xb(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function mu(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?xb(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):xb(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function da(t){return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(C("TURN_DOMAIN")):(_.debug("Cannot recognized as ip address: ".concat(t,", use as host")),t)}function sm(t,e){t.addresses||(t.addresses=[]);const i=function(a,c){if(C("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return a.map(u=>{let{ip:h,port:p}=u;return{address:"".concat(h,":").concat(p)}});const d=C("GATEWAY_DOMAINS");let l=d[1]&&B(c).call(c,d[1])?1:0;return a.map(u=>{let{domain_prefix:h,port:p,ip:T}=u;if(h)return{address:"".concat(h,".").concat(d[l++%d.length],":").concat(p)};const m=/^[\.\:\d]+$/.test(T),f=m?"".concat(T.replace(/[^\d]/g,"-"),".").concat(d[l++%d.length],":").concat(p):"".concat(T,":").concat(p);return m||_.debug("Cannot recognized as ip address: ".concat(T,", use as host")),{ip:T,port:p,address:f}})}(t.addresses,e),n=Array.isArray(t.detail)&&t.detail[18];if(n&&typeof n=="string"){const a=n.split(";");for(let c=0;c<a.length;c++){var r;const d=Xe(r=a[c]).call(r);i[c]&&d&&(i[c].ip6=d)}}const s=t.detail&&t.detail.candidate;let o;if(s){const[a,c]=s.split(":");a&&c&&(o={port:Number(c),ip:a,address:"".concat(a,":").concat(c)})}return{gatewayAddrs:i,apGatewayAddress:o,uid:t.uid,cid:t.cid,cert:t.cert,vid:t.detail&&t.detail[8],uni_lbs_ip:t.detail&&t.detail[1],res:t,csIp:t.detail&&t.detail[502]}}function Di(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function Vb(t){const e=t._encoderConfig;if(!e)return{};const i={resolution:e.width&&e.height?"".concat(Di(e.width),"x").concat(Di(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return typeof e.frameRate=="number"?(i.maxFrameRate=e.frameRate,i.minFrameRate=e.frameRate):e.frameRate&&(i.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,i.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),i}function Fb(t){return t>=0&&t<.17?1:t>=.17&&t<.36?2:t>=.36&&t<.59?3:t>=.59&&t<=1?4:t>1?5:0}function bc(t,e){let i,n,r;switch(e){case he.CHOOSE_SERVER:n=4096,r="choose server";break;case he.CLOUD_PROXY:n=1048576,r="proxy";break;case he.CLOUD_PROXY_5:n=4194304,r="proxy5";break;case he.CLOUD_PROXY_FALLBACK:n=4194310,r="proxy fallback";break;default:throw new D(S.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:t.detail&&t.detail[502],retry:!1})}if(t.response_body.forEach(s=>{s.buffer&&s.buffer.flag===n&&(i={code:s.buffer.code,addresses:(s.buffer.edges_services||[]).map(o=>mu(mu({},o),{},{ticket:s.buffer.cert})),server_ts:t.enter_ts,uid:s.buffer.uid,cid:s.buffer.cid,cname:s.buffer.cname,detail:mu(mu({},s.buffer.detail),t.detail),flag:s.buffer.flag,opid:t.opid,cert:s.buffer.cert})}),!i)throw new D(S.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:t.detail&&t.detail[502]});return i}async function Bb(t,e){return await G.all(t.addresses.map(async i=>({address:da(i.ip),tcpport:i.port,udpport:i.port,username:e&&C("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():je.username,password:e&&C("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await hE(e.toString()):je.password})))}function om(t,e){const i=e.getMediaStreamTrack(!0).getSettings(),n=e.videoHeight||i.height,r=e.videoWidth||i.width;return n&&r?Math.max(Math.min(n,r)/Math.min(Di(t.height),Di(t.width)),1):(_.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function es(t){let{candidateType:e,relayProtocol:i,type:n,address:r,port:s,protocol:o}=t;const a={candidateType:e,relayProtocol:i,protocol:o};if(n!=="local-candidate"){const c=r.split(".");c.length>=4&&(c[1]="*",c[2]="*"),a.address=c.join("."),a.port=s}return a}function fu(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:C("SVC_MODE");if(C("ENABLE_SVC"))return function(e){return e in Yl}(t)?t:Yl.L1T3}const jb={[q.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[q.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function gu(t,e,i){e.forEach(n=>{var r;const s=jb[t].find(a=>{var c;let{key:d}=a;return B(c=n.extensionName).call(c,d)});if(!s)return;const o=i.find(a=>{let{extensionName:c}=a;return B(c).call(c,s.key)});o&&B(r=o.extensionName).call(r,"gdpr_forbidden")&&(n.extensionName=o.extensionName)})}function la(t,e){e.forEach(i=>{var n;const r=jb[t].find(s=>{var o;let{key:a}=s;return B(o=i.extensionName).call(o,a)});B(n=i.extensionName).call(n,"gdpr_forbidden")&&r&&(i.extensionName=r.extensionName)})}function Gb(t){return t==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"||B(t).call(t,"abs-send-time")}function Tu(t){return t==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"||B(t).call(t,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function Wb(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Hb(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Wb(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Wb(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function wc(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0;const{filterRTX:r,filterVideoFec:s,filterAudioFec:o,filterAudioCodec:a,filterVideoCodec:c}=e,{useXR:d}=i;let l=[],u=[],h=[],p=[],T=!1,m=!1;if(Ti(t).mediaDescriptions.forEach(R=>{n&&n!==R.attributes.direction||(R.media.mediaType!=="video"||T||(u=R.attributes.payloads,p=R.attributes.extmaps,T=!0),R.media.mediaType!=="audio"||m||(l=R.attributes.payloads,h=R.attributes.extmaps,m=!0))}),!p||u.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!h||l.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(u.forEach(R=>{var v;(v=R.rtpMap)!==null&&v!==void 0&&v.clockRate&&(R.rtpMap.clockRate=parseInt(R.rtpMap.clockRate)),d&&R.rtcpFeedbacks.push({type:"rrtr"})}),l.forEach(R=>{var v;(v=R.rtpMap)!==null&&v!==void 0&&v.clockRate&&(R.rtpMap.clockRate=parseInt(R.rtpMap.clockRate)),d&&R.rtcpFeedbacks.push({type:"rrtr"})}),r&&(l=l.filter(R=>{var v;return((v=R.rtpMap)===null||v===void 0?void 0:v.encodingName.toLowerCase())!=="rtx"}),u=u.filter(R=>{var v;return((v=R.rtpMap)===null||v===void 0?void 0:v.encodingName.toLowerCase())!=="rtx"})),s&&(u=u.filter(R=>{var v;return!/(red)|(ulpfec)|(flexfec)/i.test(((v=R.rtpMap)===null||v===void 0?void 0:v.encodingName)||"")})),o&&(l=l.filter(R=>{var v;return!/(red)|(ulpfec)|(flexfec)/i.test(((v=R.rtpMap)===null||v===void 0?void 0:v.encodingName)||"")})),a&&(a==null?void 0:a.length)>0&&(l=l.filter(R=>{var v;return B(a).call(a,((v=R.rtpMap)===null||v===void 0?void 0:v.encodingName.toLowerCase())||"")})),c&&(c==null?void 0:c.length)>0){const R=u.filter(v=>{var A;return B(c).call(c,((A=v.rtpMap)===null||A===void 0?void 0:A.encodingName.toLowerCase())||"")});u=R.concat(r?[]:dm(R,u))}const f=C("UNSUPPORTED_VIDEO_CODEC");return f&&f.length>0&&(u=u.filter(R=>!(R.rtpMap&&B(f).call(f,R.rtpMap.encodingName.toLowerCase())))),{audioCodecs:l,videoCodecs:u,audioExtensions:h,videoExtensions:p}}function is(t){const e=Ti(t);let i,n;for(const r of e.mediaDescriptions){if(!i){const s=r.attributes.iceUfrag,o=r.attributes.icePwd;if(!s||!o)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:s,icePwd:o}}if(!n){const s=r.attributes.fingerprints;s.length>0&&(n={fingerprints:s})}}if(!n&&e.attributes.fingerprints.length>0&&(n={fingerprints:e.attributes.fingerprints}),!n||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:n}}function Kb(t,e){const i=[],n=t.attributes.ssrcGroups.filter(o=>o.semantic==="FID"),r=t.attributes.ssrcGroups.find(o=>o.semantic==="SIM"),s=t.attributes.ssrcs;if(r)r.ssrcIds.forEach(o=>{var a;const c=(a=n.find(d=>d.ssrcIds[0]===o))===null||a===void 0?void 0:a.ssrcIds[1];i.push({ssrcId:o,rtx:e?c:void 0})});else if(n.length>0){const o=n[0].ssrcIds[0],a=n[0].ssrcIds[1];i.push({ssrcId:o,rtx:e?a:void 0})}else{if(s.length===0)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:s[0].ssrcId})}return i}function Yb(t,e,i){const{cname:n}=t;let r=[];e&&(r=qb(e)),r.length===0&&(r=t.iceParameters.candidates.map(l=>({foundation:l.foundation,componentId:"1",transport:l.protocol,priority:l.priority.toString(),connectionAddress:l.ip,port:l.port.toString(),type:l.type,extension:{}})),_.debug("Using candidates from gateway."));const s={fingerprints:t.dtlsParameters.fingerprints.map(l=>({hashFunction:l.algorithm,fingerprint:l.fingerprint}))},o={iceUfrag:t.iceParameters.iceUfrag,icePwd:t.iceParameters.icePwd};let a;switch(t.dtlsParameters.role){case"server":a="passive";break;case"client":a="active";break;case"auto":a="actpass"}const c=Ru(t.rtpCapabilities),d=[];return Array.isArray(i)&&i.length>0&&i.forEach(l=>{d.push({kind:q.VIDEO,ssrcId:l.v,rtx:l.v_rtx,mslabel:"".concat(l.v,"_").concat(l.a)},{kind:q.AUDIO,ssrcId:l.a,mslabel:"".concat(l.v,"_").concat(l.a)})}),{dtlsParameters:s,iceParameters:o,candidates:r,rtpCapabilities:c,setup:a,cname:n,preSSRCs:d}}function qb(t){let e=[];return t.ip&&typeof t.port=="number"&&(e=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],_.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(e.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),_.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))),e}function Ws(t,e,i){const n=[],r=[];return t.forEach(s=>{let{ssrcId:o,rtx:a}=s;const c=Ut(8,"track-"),d={ssrcId:o,attributes:Hb({label:c,mslabel:i=i||Ut(10,""),msid:"".concat(i," ").concat(c)},e&&{cname:e})};if(n.push(d),a!==void 0){const l={ssrcId:a,attributes:Hb({label:c,mslabel:i,msid:"".concat(i," ").concat(c)},e&&{cname:e})};n.push(l),r.push({semantic:"FID",ssrcIds:[o,a]})}}),t.length>1&&r.push({semantic:"SIM",ssrcIds:t.map(s=>{let{ssrcId:o}=s;return o})}),{ssrcs:n,ssrcGroups:r}}function ua(t,e){e instanceof ie&&t.attributes.payloads.forEach(i=>{var n;const r=(n=i.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase();if(!r||["opus","pcmu","pcma","g722"].indexOf(r)===-1)return;i.fmtp||(i.fmtp={parameters:{}}),i.fmtp.parameters.minptime="10",i.fmtp.parameters.useinbandfec="1";const s=e._encoderConfig;s&&r!=="pcmu"&&r!=="pcma"&&r!=="g722"&&(s.bitrate&&!te()&&(i.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(i.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),i.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(i.fmtp.parameters.stereo="1",i.fmtp.parameters["sprop-stereo"]="1"))})}function am(t){const e=t.attributes.unrecognized.findIndex(i=>i.attField==="x-google-flag"&&i.attValue==="conference");e!==-1&&t.attributes.unrecognized.splice(e,1)}function cm(t,e){var i;if(!(e instanceof Gt&&e._encoderConfig&&e._hints.indexOf(xt.SCREEN_TRACK)===-1))return;const n=e._encoderConfig;St().supportMinBitrate&&n.bitrateMin&&t.attributes.payloads.forEach(r=>{var s,o;B(s=["h264","h265","vp8","vp9","av1"]).call(s,((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-min-bitrate"]="".concat(n.bitrateMin))}),St().supportMinBitrate&&!B(i=e._hints).call(i,xt.LOW_STREAM)&&n.bitrateMax&&t.attributes.payloads.forEach(r=>{var s,o;B(s=["h264","h265","vp8","vp9","av1"]).call(s,((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-start-bitrate"]="".concat(C("X_GOOGLE_START_BITRATE")||Math.floor(n.bitrateMax)))})}function zb(t){if(t.media.mediaType!=="video")return;const e=Tt();if(e.name!==Ct.SAFARI&&e.os!==Ie.IOS)return;const i=t.attributes.extmaps.findIndex(n=>/video-orientation/g.test(n.extensionName));i!==-1&&t.attributes.extmaps.splice(i,1)}function Su(t,e,i){if(!e)return;let n,r;if(t.media.mediaType==="video"?(n=i.videoExtensions,r=i.videoCodecs):(n=i.audioExtensions,r=i.audioCodecs),e.twcc===!0){const s=n.find(o=>Tu(o.extensionName));if(s){const o=s.extensionName;t.attributes.extmaps.find(c=>Tu(c.extensionName))||t.attributes.extmaps.push({entry:s.entry,extensionName:o}),function(c,d){return d.filter(l=>!!c.find(u=>u.payloadType===l.payloadType&&!!u.rtcpFeedbacks.find(h=>h.type==="transport-cc")))}(r,t.attributes.payloads).forEach(c=>{c.rtcpFeedbacks.find(d=>d.type==="transport-cc")||c.rtcpFeedbacks.push({type:"transport-cc"})})}}else if(e.twcc===!1){const s=t.attributes.extmaps.findIndex(o=>Tu(o.extensionName));s!==-1&&t.attributes.extmaps.splice(s,1),t.attributes.payloads.forEach(o=>{const a=o.rtcpFeedbacks.findIndex(c=>c.type==="transport-cc");a!==-1&&o.rtcpFeedbacks.splice(a,1)})}if(e.remb===!0){const s=n.find(o=>Gb(o.extensionName));if(s){const o=s.extensionName;t.attributes.extmaps.find(c=>c.extensionName===o)||t.attributes.extmaps.push({entry:s.entry,extensionName:o}),function(c,d){return d.filter(l=>!!c.find(u=>u.payloadType===l.payloadType&&!!u.rtcpFeedbacks.find(h=>h.type==="goog-remb")))}(r,t.attributes.payloads).forEach(c=>{c.rtcpFeedbacks.find(d=>d.type==="goog-remb")||c.rtcpFeedbacks.push({type:"goog-remb"})})}}else if(e.remb===!1){const s=t.attributes.extmaps.findIndex(o=>Gb(o.extensionName));s!==-1&&t.attributes.extmaps.splice(s,1),t.attributes.payloads.forEach(o=>{const a=o.rtcpFeedbacks.findIndex(c=>c.type==="goog-remb");a!==-1&&o.rtcpFeedbacks.splice(a,1)})}}function Jb(t,e,i){if(te()||t.media.mediaType!=="video"||!(e instanceof Gt)||i!=="vp9"&&i!=="vp8"||i==="vp8"&&!C("SIMULCAST")||i==="vp9"&&C("ENABLE_SVC")||e._scalabilityMode===void 0||e._scalabilityMode.numSpatialLayers<=1)return;const n=i==="vp8"?2:e._scalabilityMode.numSpatialLayers,r=t.attributes.ssrcs[0],s=t.attributes.ssrcGroups.find(a=>a.semantic==="FID"&&a.ssrcIds[0]===r.ssrcId),o={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<n;a++)t.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:ee(r.attributes)}),o.ssrcIds.push(r.ssrcId+a),s&&(t.attributes.ssrcs.push({ssrcId:s.ssrcIds[1]+a,attributes:ee(r.attributes)}),t.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,s.ssrcIds[1]+a]}));t.attributes.ssrcGroups.unshift(o)}async function Xb(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const i=new RTCPeerConnection;i.addTransceiver("video",{direction:"sendonly"}),i.addTransceiver("audio",{direction:"sendonly"}),i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"});const n=(await i.createOffer()).sdp,{send:r,recv:s,sendrecv:o}=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=arguments.length>2?arguments[2]:void 0;const l=wc(d,a,c,"sendonly"),u=wc(d,a,c,"recvonly"),h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},T={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(vn(l,u,"videoExtensions",h,p,T),vn(l,u,"videoCodecs",h,p,T),vn(l,u,"audioExtensions",h,p,T),vn(l,u,"audioCodecs",h,p,T),C("RAISE_H264_BASELINE_PRIORITY")){const m=[],f=[];T.videoCodecs.forEach((R,v)=>{var A;if(((A=R.rtpMap)===null||A===void 0?void 0:A.encodingName.toLocaleLowerCase())==="h264"){var O,w;const b=T.videoCodecs[v+1],L=b&&ew(R,b),x=(O=R.fmtp)===null||O===void 0?void 0:O.parameters["profile-level-id"],W=(w=R.fmtp)===null||w===void 0?void 0:w.parameters["packetization-mode"];!x||x!==C("FIRST_H264_PROFILE_LEVEL_ID")||C("FIRST_PACKETIZATION_MODE")&&W!==C("FIRST_PACKETIZATION_MODE")?L?f.push([R,b]):f.push([R]):L?m.push([R,b]):m.push([R])}}),m.length>0&&f.length>0&&(_.debug("raising H264 baseline profile priority"),T.videoCodecs.forEach((R,v)=>{var A;if(((A=R.rtpMap)===null||A===void 0?void 0:A.encodingName.toLocaleLowerCase())==="h264"){const O=ew(R,T.videoCodecs[v+1]),w=m.shift()||f.shift()||[];w.length>0&&(O?T.videoCodecs.splice(v,2,...w):T.videoCodecs.splice(v,1,...w))}}),p.videoCodecs=p.videoCodecs.filter(R=>{var v,A;return!(((v=R.rtpMap)===null||v===void 0?void 0:v.encodingName.toLocaleLowerCase())==="h264"&&((A=R.fmtp)===null||A===void 0?void 0:A.parameters["profile-level-id"])!==C("FIRST_H264_PROFILE_LEVEL_ID"))}),C("FILTER_SEND_H264_BASELINE")&&(h.videoCodecs=h.videoCodecs.filter(R=>{var v,A;return!(((v=R.rtpMap)===null||v===void 0?void 0:v.encodingName.toLocaleLowerCase())==="h264"&&((A=R.fmtp)===null||A===void 0?void 0:A.parameters["profile-level-id"])!==C("FIRST_H264_PROFILE_LEVEL_ID"))})))}return{send:h,recv:p,sendrecv:T}}(t,e,n);try{i.close()}catch{}return{send:r,recv:s,sendrecv:o}}function Qb(){const t={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},e=wc(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(vn(t,e,"videoExtensions",i,n,r),vn(t,e,"videoCodecs",i,n,r),vn(t,e,"audioExtensions",i,n,r),vn(t,e,"audioCodecs",i,n,r),C("RAISE_H264_BASELINE_PRIORITY")){const s=r.videoCodecs.findIndex(o=>o.rtpMap&&o.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&o.fmtp&&o.fmtp.parameters["profile-level-id"]==="42001f");if(s!==-1){const o=r.videoCodecs.findIndex(a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(o<s){_.debug("raising H264 baseline profile priority");const a=r.videoCodecs[s];r.videoCodecs.splice(s,1),r.videoCodecs.splice(o,0,a)}o!==-1&&(n.videoCodecs=n.videoCodecs.filter(a=>!(a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:i,recv:n,sendrecv:r}}function vn(t,e,i,n,r,s){if(i==="videoExtensions"||i==="audioExtensions"){const o=[];return t[i].forEach(a=>{e[i].some((c,d)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return o.push(d),!0})?s[i].push(a):n[i].push(a)}),void e[i].forEach((a,c)=>{o.indexOf(c)===-1&&r[i].push(a)})}if(i==="videoCodecs"||i==="audioCodecs"){const o=[];return t[i].forEach(a=>{e[i].some((c,d)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return o.push(d),!0})?s[i].push(a):n[i].push(a)}),void e[i].forEach((a,c)=>{o.indexOf(c)===-1&&r[i].push(a)})}}function Ru(t){const{send:e,recv:i,sendrecv:n}=t;if(!n){if(!e||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:i}}let r,s;return e?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...e.audioCodecs,...n.audioCodecs],r.videoCodecs=[...e.videoCodecs,...n.videoCodecs],r.audioExtensions=[...e.audioExtensions,...n.audioExtensions],r.videoExtensions=[...e.videoExtensions,...n.videoExtensions]):r=n,i?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...i.audioCodecs,...n.audioCodecs],s.videoCodecs=[...i.videoCodecs,...n.videoCodecs],s.audioExtensions=[...i.audioExtensions,...n.audioExtensions],s.videoExtensions=[...i.videoExtensions,...n.videoExtensions]):s=n,{send:r,recv:s}}function ha(t){t.media.mediaType==="audio"&&t.attributes.payloads.filter(e=>{var i;return((i=e.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase())==="opus"}).forEach(e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"})}function Oc(t,e,i,n){let r=[];if(t===q.VIDEO){if(C("H264_PROFILE_LEVEL_ID")&&n==="h264"&&(r=e.videoCodecs.filter(s=>{var o;return B(o=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(o,n)&&s&&s.fmtp&&s.fmtp.parameters["profile-level-id"]===C("H264_PROFILE_LEVEL_ID")})),!Array.isArray(r)||r.length===0){let s=[];const o=[],a=[],c=[];if(i.videoCodecs.forEach(d=>{const l=d.rtpMap&&d.rtpMap.encodingName.toLowerCase()||"";B(l).call(l,n)?s.push(d):B(l).call(l,"vp9")?o.push(d):B(l).call(l,"vp8")?a.push(d):B(l).call(l,"h264")&&c.push(d)}),s.length===0){let d="";o.length!==0?(s=o,d="vp9"):a.length!==0?(s=a,d="vp8"):c.length!==0&&(s=c,d="h264"),_.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: ").concat(d))}s.length!==0&&(r=e.videoCodecs.filter(d=>s.some(l=>l.payloadType===d.payloadType)))}if(r.length===0&&(_.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: ").concat(e.videoCodecs[0].rtpMap&&e.videoCodecs[0].rtpMap.encodingName)),r=e.videoCodecs),C("USE_PUB_RTX")||C("USE_SUB_RTX")){const s=dm(r,e.videoCodecs);r=[...r,...s]}}else r=e.audioCodecs.filter(s=>{var o;return B(o=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(o,n)}),r.length===0&&(_.warning("codec ".concat(n," not included in rtpCapabilities, fallback to opus")),r=e.audioCodecs.filter(s=>{var o;return B(o=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(o,"opus")}));return r}function dm(t,e){const i=t.map(n=>n.payloadType.toString());return e.filter(n=>n.rtpMap&&n.rtpMap.encodingName==="rtx"&&n.fmtp&&n.fmtp.parameters.apt&&B(i).call(i,n.fmtp&&n.fmtp.parameters.apt))}async function vu(t,e,i){const n=e.toString(),r=$b(n,"offer","remote","exchangeSDP");await t.setRemoteDescription({type:"offer",sdp:n});const s=await t.createAnswer();if(!s.sdp)throw new Error("cannot get answer sdp");let o=s.sdp;o=Zb(o,i||{}),r==null||r(o||""),await t.setLocalDescription({type:"answer",sdp:o})}function Zb(t,e,i){const n=Ti(t),{useXR:r}=e;return n.mediaDescriptions.forEach(s=>{var o;s.attributes.mid&&(Array.isArray(i)&&!B(i).call(i,s.attributes.mid)||(s.media.mediaType==="audio"&&ha(s),r&&B(o=["audio","video"]).call(o,s.media.mediaType)&&s.attributes.payloads.forEach(a=>{a.rtcpFeedbacks.findIndex(c=>c.type==="rrtr")===-1&&a.rtcpFeedbacks.push({type:"rrtr"})})))}),Zr(n)}function $b(t,e,i,n){if(C("SDP_LOGGING"))return _.upload("exchanging ".concat(i," ").concat(e," SDP during P2PConnection.").concat(n,`
`),t),e==="offer"?r=>{$b(r,"answer",i==="local"?"remote":"local",n)}:void 0}function tw(t){const e=C("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(e)&&e.length>0)&&e.some(i=>B(t).call(t,i))}function ew(t,e){try{var i;return((i=t.fmtp)===null||i===void 0?void 0:i.parameters.apt)===e.payloadType.toString()}catch{return!1}}function iw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function nn(t,e){return typeof C(t)===e?C(t):void 0}function lW(){try{const t=C("EXPERIMENTS")||{};return typeof t=="string"||Array.isArray(t)?{}:function(e){for(var i=1;i<arguments.length;i++){var n=arguments[i]!=null?arguments[i]:{};i%2?iw(Object(n),!0).forEach(function(r){g(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):iw(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}({},t)}catch(t){return _.debug("handle gateway attributes failed: ",t),{}}}const nw={};function Hs(t){(!(arguments.length>1&&arguments[1]!==void 0)||arguments[1])&&_.debug("install service ".concat(t.name)),nw[t.name]=t}function ns(t){const e=nw[t];if(!e)throw new P(S.INVALID_OPERATION,"".concat(t," not found, please use AgoraRTC.use(").concat(t,"Service) to load it first"));return e}function rw(t,e){return ns("DataStream").create(t,e)}function sw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Or(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?sw(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):sw(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}const lm=new Map;class uW extends qt{get state(){return this._state}set state(e){if(e===this._state)return;const i=this._state;this._state=e,e==="DISCONNECTED"&&this._disconnectedReason?this.emit(Oe.CONNECTION_STATE_CHANGE,e,i,this._disconnectedReason):this.emit(Oe.CONNECTION_STATE_CHANGE,e,i)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){_.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,i){var n,r,s;super(),g(this,"store",void 0),g(this,"joinInfo",void 0),g(this,"key",void 0),g(this,"ntpOffset",0),g(this,"signal",void 0),g(this,"role",void 0),g(this,"inChannelInfo",{joinAt:null,duration:0}),g(this,"spec",void 0),g(this,"_state","DISCONNECTED"),g(this,"_statsCollector",void 0),g(this,"_disconnectedReason",void 0),g(this,"isSignalRecover",!1),g(this,"hasChangeBGPAddress",!1),g(this,"trafficStatsInterval",void 0),g(this,"networkQualityInterval",void 0),g(this,"_joinGatewayStartTime",0),g(this,"_signalTimeout",!1),g(this,"_clientRoleOptions",void 0),g(this,"_isProactiveJoin",!1),this.store=e,this.spec=i,this.signal=this.store.useP2P?(n={spec:Or(Or({},i),{},{retryConfig:i.websocketRetryConfig}),store:e},(r=(s=ns("P2PChannel")).createSubmodule)===null||r===void 0?void 0:r.call(s,n)):new cW(Or(Or({},i),{},{retryConfig:i.websocketRetryConfig}),e),this._statsCollector=i.statsCollector,this.role=i.role||"audience",this._clientRoleOptions=i.clientRoleOptions,this.handleSignalEvents()}async join(e,i,n){this.store.joinGatewayStart(),e.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const r=Date.now();let s=lm.get(e.cname);if(s||(s=new Map,lm.set(e.cname,s)),this._isProactiveJoin=!0,s.has(e.uid)){const d=new D(S.UID_CONFLICT);throw Q.joinGateway(e.sid,{lts:r,succ:!1,ec:d.code,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:"0",preload:e.preload}),d}s.set(e.uid,!0),this.joinInfo=e,this.key=i;let o=0;this.joinGatewayStartTime=r;const a=e.proxyServer;try{_.debug("[".concat(this.store.clientId,"] use websocket join uid ").concat(o));const d=e.gatewayAddrs.map(l=>{let{address:u}=l;const[h,p]=u.split(":"),T={host:h,port:p};return e.proxyServer&&(T.proxy=e.proxyServer),T});o=(await this.signal.init(d)).uid,_.debug("[".concat(this.store.clientId,"] websocket join uid ").concat(o," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(d){var c;throw _.error("[".concat(this.store.clientId,"] User join failed"),d.toString()),Q.joinGateway(e.sid,{lts:r,succ:!1,ec:((c=d.data)===null||c===void 0?void 0:c.desc)||d.code,errorMsg:d.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!a,signalChannel:"0",preload:e.preload}),s.delete(e.uid),this.signal.close(),d}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),_.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(d=>{_.warning("[".concat(this.store.clientId,"] get traffic stats error"),d.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(Oe.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Oe.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(Oe.NETWORK_QUALITY,{uplinkNetworkQuality:Fb(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:Fb(this._statsCollector.trafficStats.B_dnq)}):this.emit(Oe.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),o}async leave(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0],i=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){i!==It.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==Ft.CONNECTED||await function(n,r){return r===1/0?n:G.race([n,LG(r)])}(this.signal.request(it.LEAVE,void 0,!0),3e3)}catch(n){_.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),n)}this.signal.close(i),i!==It.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,i,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const r={state:"offer",p2p_id:this.store.p2pId,ortc:i,mode:this.spec.mode,extend:C("PUB_EXTEND"),twcc:!!C("PUBLISH_TWCC"),rtx:!!C("USE_PUB_RTX")};try{return(await this.signal.request(it.PUBLISH,r,!0))._message}catch(s){if(n&&s.data&&s.data.code===$.ERR_PUBLISH_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),s.toString()),await this.tryUnpubBeforeRepub(e,i),this.publish(e,i,!1);throw s}}async publishDataChannel(e,i,n){var r;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={stream_id:i.streamId,ordered:i.ordered?1:0,max_retrans_times:(r=i.maxRetransmits)!==null&&r!==void 0?r:10,channel_id:i.channelId,metadata:i.metadata};try{await this.signal.request(it.PUBLISH_DATASTREAM,s,!0)}catch(o){if(n&&o.data&&o.data.code===$.ERR_PUBLISH_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),o.toString()),await this.tryUnpubDataChannelBeforeRepub(e,i),this.publishDataChannel(e,i,!1);throw o}}async unpublish(e,i){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(it.UNPUBLISH,{stream_id:i,ortc:e},!0)}catch(n){_.warning("[".concat(this.store.clientId,"] unpublish warning: "),n)}}async unpublishDataChannel(e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await G.all(e.map(i=>this.signal.request(it.UNPUBLISH_DATASTREAM,{channel_id:i},!0)))}catch(i){_.warning("unpublish datachannels warning: ",i)}}async presubscribe(e,i,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const r={stream_id:e,stream_type:i,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!C("SUBSCRIBE_TWCC"),rtx:!!C("USE_SUB_RTX")||void 0,extend:C("SUB_EXTEND"),svc:Array.isArray(C("SVC"))&&C("SVC").length!==0?C("SVC"):void 0};try{return await this.signal.request(it.PRE_SUBSCRIBE,r,!0)}catch(s){if(n&&s.data&&s.data.code===$.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),s.toString()),this.presubscribe(e,i,!1);throw s}}async subscribe(e,i,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const r={stream_id:e,stream_type:i.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!C("SUBSCRIBE_TWCC"),rtx:!!C("USE_SUB_RTX"),extend:C("SUB_EXTEND"),ssrcId:i.ssrcId,svc:Array.isArray(C("SVC"))&&C("SVC").length!==0?C("SVC"):void 0};try{return(await this.signal.request(it.SUBSCRIBE,r,!0))._message}catch(s){if(n&&s.data&&s.data.code===$.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),s.toString()),await this.tryUnsubBeforeResub(e,i),await this.subscribe(e,i,!1);throw s}}async subscribeDataChannel(e,i,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const r={uid:e,stream_id:i.id,channel_id:i.datachannelId};try{return void await this.signal.request(it.SUBSCRIBE_DATASTREAM,r,!0)}catch(s){if(n&&s.data&&s.data.code===$.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),s.toString()),await this.tryUnsubDataChannelBeforeResub(e,i),await this.subscribeDataChannel(e,i,!1);throw s}}async subscribeAll(e,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const n={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!C("USE_SUB_RTX"),twcc:!!C("SUBSCRIBE_TWCC"),svc:Array.isArray(C("SVC"))&&C("SVC").length!==0?C("SVC"):void 0};try{return await this.signal.request(it.SUBSCRIBE_STREAMS,n,!0)}catch(r){if(i&&r.data&&r.data.code===$.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),r.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw r}}async setVideoProfile(e){const i=function(n){if(!(n.bitrateMax&&n.bitrateMin&&n.frameRate&&n.height&&n.width))return;let r=n.frameRate,s=n.width,o=n.height,a=!0;return typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(a=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,s||(a=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,r||(a=!1)),a?{stream_type:0,width:s,height:o,fps:r,start_bps:1e3*n.bitrateMax,min_bps:1e3*n.bitrateMin,target_bps:1e3*n.bitrateMax}:void 0}(e);if(i)return this.signal.request(it.SET_VIDEO_PROFILE,i);_.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,i){try{await this.signal.request(it.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:i},!0)}catch(n){_.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),n)}}async unsubscribeDataChannel(e,i){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await G.all(e.map(n=>this.signal.request(it.UNSUBSCRIBE_DATASTREAM,{stream_id:n,uid:i},!0)))}catch(n){_.warning("unsubscribeDataChannel warning: ",n)}}async massUnsubscribe(e){try{await this.signal.request(it.UNSUBSCRIBE_STREAMS,e,!0)}catch(i){_.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),i)}}async reconnectPC(e){const{iceParameters:i,dtlsParameters:n,rtpCapabilities:r}=e;return{gatewayEstablishParams:await this.signal.request(it.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:i,dtlsParameters:n,rtpCapabilities:r}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(it.GATEWAY_INFO)}async renewToken(e){await this.signal.request(it.RENEW_TOKEN,e),this.key=e.token}updateClientRole(e,i){i&&(this._clientRoleOptions=Object.assign({},i)),C("CLIENT_ROLE_OPTIONS")&&(_.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(C("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," ")),this._clientRoleOptions=Object.assign({},C("CLIENT_ROLE_OPTIONS"))),this.role=e}async setClientRole(e,i){if(i&&(this._clientRoleOptions=Object.assign({},i)),C("CLIENT_ROLE_OPTIONS")&&(this._clientRoleOptions=Object.assign({},C("CLIENT_ROLE_OPTIONS")),_.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(C("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," "))),this.state!=="CONNECTED")return void(this.role=e);let n,r=0;e==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(n=this._clientRoleOptions.delay,r=1):r=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:r=0,await this.signal.request(it.SET_CLIENT_ROLE,{role:e,level:r,delay:n,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,i){await this.signal.request(it.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:i})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(it.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,i){await this.signal.request(it.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:i})}async pickSVCLayer(e,i){await this.signal.request(it.PICK_SVC_LAYER,{stream_id:e,spatial_layer:i.spatialLayer,temporal_layer:i.temporalLayer})}async setRTM2Flag(e){await this.signal.request(it.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,i,n){if(this.store.useP2P)return this.signal.sendExtensionMessage(e,i,n)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Or({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(it.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=lm.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(i){let n;return n=i.startsWith("dc")?i.match(/(dc\:\/\/)?([^:]+):(\d+)/):i.match(/(wss\:\/\/)?([^:]+):(\d+)/),n?{username:je.username,password:je.password,turnServerURL:n[2],tcpport:parseInt(n[3])+30,udpport:parseInt(n[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(Or(Or({},je),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const e=await this.signal.request(it.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.ntp_offset!=null&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach(i=>{const n=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(r=>r.peer_uid===i.peer_uid);n&&n.B_st!==i.B_st&&Gl(()=>{this.emit(Oe.STREAM_TYPE_CHANGE,i.peer_uid,i.B_st)})}),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new D(S.UNEXPECTED_ERROR,"can not generate join message, no join info");const i=Object.assign({},this.joinInfo.apResponse);let n=C("REPORT_APP_SCENARIO");if(typeof n!="string")try{n=JSON.stringify(n)}catch{n=void 0}var r;n&&n.length>128&&(n=void 0),this.store.hasStartJoinChannel=!0,this.store.isABTestSuccess||this.emit(Oe.UPDATE_GATEWAY_CONFIG),r=this.store.clientId,B(ra).call(ra,r)||ra.push(r);const s=!(te()||wI(87)||Ey())&&typeof C("ENABLE_PRE_SUB")=="boolean"&&C("ENABLE_PRE_SUB"),o=!Ey()&&nn("ENABLE_PREALLOC_PC","boolean"),a=lW(),c=Or({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Zi,browser:navigator.userAgent,process_id:C("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:i,extend:C("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:n,attributes:{userAttributes:Or({enableEncodedTransform:!!C("ENABLE_AUDIO_METADATA")&&Fo(87)||!!C("ENABLE_AUDIO_TOPN")&&rE(Ct.CHROME,87,116)||void 0,enableAudioMetadata:!!C("ENABLE_AUDIO_METADATA")&&Fo(87),topnSmoothLevel:C("TOPN_SMOOTH_LEVEL"),topnNewSpeakerDelay:C("TOPN_NEW_SPEAKER_DELAY"),topnSwitchHoldMs:C("TOPN_SWITCH_HOLD_MS"),topnAudioGain:C("TOPN_AUDIO_GAIN"),enablePublishedUserList:C("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:C("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:nn("SUBSCRIBE_AUDIO_FILTER_TOPN","number"),enablePublishAudioFilter:nn("ENABLE_PUBLISH_AUDIO_FILTER","boolean"),enableUserLicenseCheck:nn("ENABLE_USER_LICENSE_CHECK","boolean"),enableRTX:C("USE_PUB_RTX")===!0||C("USE_SUB_RTX")===!0||void 0,disableFEC:C("DISABLE_FEC"),enableNTPReport:!!C("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!C("ENABLE_INSTANT_VIDEO")||void 0,enableFulllinkAvSync:!!C("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:nn("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!C("ENABLE_AUT_FEEDBACK")||void 0,rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!C("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:nn("USE_XR","boolean"),enableLossbasedBwe:nn("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!C("ENABLE_AUT_CC")||void 0,enableCCFallback:nn("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:o,preSubNum:s?nn("PRE_SUB_NUM","number"):void 0,enablePubTWCC:nn("PUBLISH_TWCC","boolean"),enableSubTWCC:nn("SUBSCRIBE_TWCC","boolean"),enablePubRTX:nn("USE_PUB_RTX","boolean"),enableSubRTX:nn("USE_SUB_RTX","boolean"),enableSubSVC:C("ENABLE_SVC")?C("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(C("SVC"))&&C("SVC").length!==0?C("SVC"):void 0,enableSvcExtended:C("ENABLE_SVC")&&Array.isArray(C("SVC_EXTENDED"))&&C("SVC_EXTENDED").length!==0?C("SVC_EXTENDED"):void 0},a)},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(c.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(c.aes_mode=this.joinInfo.aesmode,C("ENCRYPT_AES")?(c.aes_secret=this.joinInfo.aespassword,c.aes_encrypt=!0):c.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(c.aes_salt=this.joinInfo.aessalt)),i.addresses[this.signal.websocket.currentURLIndex]&&(c.ap_response.ticket=i.addresses[this.signal.websocket.currentURLIndex].ticket,delete i.addresses),this.joinInfo.defaultVideoStream!==void 0&&(c.default_video_stream=this.joinInfo.defaultVideoStream),c}getRejoinMessage(){if(!this.joinInfo)throw new D(S.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(nt.WS_RECONNECT_CREATE_CONNECTION,e=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(nt.WS_RECONNECTING,e=>{this.joinInfo&&Q.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||Fe.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",Q.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(nt.WS_CLOSED,e=>{let i;switch(e){case It.LEAVE:i=Fe.LEAVE;break;case It.UID_BANNED:case It.IP_BANNED:case It.CHANNEL_BANNED:case It.SERVER_ERROR:i=Fe.SERVER_ERROR;break;case It.FALLBACK:i=Fe.FALLBACK;break;case It.LICENSE_MISSING:case It.LICENSE_EXPIRED:case It.LICENSE_MINUTES_EXCEEDED:case It.LICENSE_PERIOD_INVALID:case It.LICENSE_MULTIPLE_SDK_SERVICE:case It.LICENSE_ILLEGAL:case It.TOKEN_EXPIRE:i=e;break;default:i=Fe.NETWORK_ERROR}_.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(i||"undefined -> "+Fe.NETWORK_ERROR)),this.joinInfo&&Q.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===It.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:i}),this._disconnectedReason=e,e!==It.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(nt.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo){if(this.role==="audience"){const e=C("CLIENT_ROLE_OPTIONS")||this._clientRoleOptions;e&&(e.level||e.delay)&&(_.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(e.level,", delay: ").concat(e.delay)),this.setClientRole(this.role,e))}if(Q.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload,isABTestSuccess:this.store.isABTestSuccess}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void _.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));Ot("EVENT_REPORT_DOMAIN",e[1]),Ot("EVENT_REPORT_BACKUP_DOMAIN",e[1]),Ot("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}}}),this.signal.on(ut.ON_UPLINK_STATS,e=>{this._statsCollector.updateUplinkStats(e)}),this.signal.on(nt.REQUEST_RECOVER,(e,i,n)=>{if(!this.joinInfo)return n(new D(S.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,Be(this,Oe.REQUEST_NEW_GATEWAY_LIST).then(i).catch(n)}),this.signal.on(nt.REQUEST_JOIN_INFO,async(e,i,n)=>{var r;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));const{iceParameters:s,dtlsParameters:o,rtpCapabilities:a}=await Be(this,Oe.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:(r=this.joinInfo)===null||r===void 0?void 0:r.turnServer});try{e(this.getJoinMessage({ortc:{iceParameters:s,dtlsParameters:o,rtpCapabilities:a,version:"2"}}))}catch(c){i(c)}}),this.signal.on(nt.REQUEST_REJOIN_INFO,e=>{e(this.getRejoinMessage())}),this.signal.on(nt.REPORT_JOIN_GATEWAY,(e,i)=>{if(!this.joinInfo)return;let n,r="";var s;e instanceof D?(n=((s=e.data)===null||s===void 0?void 0:s.desc)||e.code,r=e.message):n=e,Q.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:n,errorMsg:r,addr:i,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload})}),this.signal.on(nt.IS_P2P_DISCONNECTED,e=>{e(mc(this,Oe.IS_P2P_DISCONNECTED))}),this.signal.on(nt.DISCONNECT_P2P,()=>{this.emit(Oe.DISCONNECT_P2P)}),this.signal.on(nt.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(nt.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(nt.JOIN_RESPONSE,e=>{const i=this.getCurrentGatewayAddress();this.emit(Oe.JOIN_RESPONSE,e,i)}),this.signal.on(nt.PRE_CONNECT_PC,async()=>{if(this.joinInfo){this.updateTurnConfigFromSignal();const e=this.getCurrentGatewayAddress(),i=C("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(e&&i){const n=qb(e);this.emit(Oe.PRE_CONNECT_PC,{candidates:n,fingerprint:i})}}}),this.signal.on(nt.RECOVER_NOTIFICATION,e=>{this.joinInfo&&typeof C("AP_REQUEST_DETAIL")=="string"&&(this.joinInfo.apRequestDetail="".concat(C("AP_REQUEST_DETAIL"),";").concat(e))})}async tryUnsubBeforeResub(e,i){try{await this.signal.request(it.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[i]},!0)}catch(n){throw _.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),n),n}}async tryUnsubDataChannelBeforeResub(e,i){try{await this.signal.request(it.UNSUBSCRIBE,{stream_id:i.id},!0)}catch(n){throw _.warning("unsubscribe datachannel warning",n),n}}async tryUnpubBeforeRepub(e,i){try{await this.signal.request(it.UNPUBLISH,{stream_id:e,ortc:i},!0)}catch(n){throw _.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),n),n}}async tryUnpubDataChannelBeforeRepub(e,i){try{await this.signal.request(it.UNPUBLISH_DATASTREAM,{channnel_id:i.channelId},!0)}catch(n){throw _.warning("unpublish datastream warning: ",n),n}}async tryMassUnsubBeforeResub(e){const i={users:e.map(n=>({stream_id:n.stream_id,stream_type:n.stream_type}))};try{await this.signal.request(it.UNSUBSCRIBE_STREAMS,i,!0)}catch(n){throw _.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),n),n}}async muteLocal(e,i){const n={action:e.find(r=>r.stream_type===At.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(it.CONTROL,n,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),r),r}}async unmuteLocal(e,i){const n={action:e.find(r=>r.stream_type===At.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(it.CONTROL,n,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),r),r}}async muteRemote(e,i){const n={action:e===q.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(it.CONTROL,n,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),r),r}}async unmuteRemote(e,i){const n={action:e===q.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(it.CONTROL,n,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),r),r}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,i){this.signal.upload(e,i)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const i={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(it.RESTART_ICE,i,!0)}catch(n){throw _.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),n),n}}reconnect(e,i){this.state==="CONNECTED"&&this.signal.reconnect(e||void 0,i||Fe.P2P_FAILED)}getCurrentGatewayAddress(){var e,i;if(!C("GATEWAY_WSS_ADDRESS"))return C("USE_CANDIDATE_FROM_AP_DETAIL")&&(e=this.joinInfo)!==null&&e!==void 0&&e.apGatewayAddress?(_.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):(i=this.joinInfo)!==null&&i!==void 0&&i.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(it.SET_PARAMETER,{enablePublishAudioFilter:e})}}let Cu=0,um=0;function jn(t,e,i,n){return new G((r,s)=>{e.timeout=e.timeout||C("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!i?(e.data=JSON.stringify(e.data),Cu+=$n(e.data)):i&&(e.data.size?Cu+=e.data.size:e.data instanceof FormData?Cu+=YI(e.data):Cu+=$n(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,li.request(e).then(o=>{typeof o.data=="string"?um+=$n(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?um+=o.data.byteLength:um+=$n(JSON.stringify(o.data)),n&&r({data:o.data,headers:o.headers}),r(o.data)}).catch(o=>{li.isCancel(o)?s(new D(S.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?s(new D(S.NETWORK_TIMEOUT,o.message)):o.response?s(new D(S.NETWORK_RESPONSE_ERROR,o.response.status)):s(new D(S.NETWORK_ERROR,o.message))})})}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */(function(){var t;function e(k){var F=0;return function(){return F<k.length?{done:!1,value:k[F++]}:{done:!0}}}var i=typeof Object.defineProperties=="function"?Object.defineProperty:function(k,F,X){return k==Array.prototype||k==Object.prototype||(k[F]=X.value),k},n,r=function(k){k=[typeof globalThis=="object"&&globalThis,k,typeof window=="object"&&window,typeof self=="object"&&self,typeof Ai=="object"&&Ai];for(var F=0;F<k.length;++F){var X=k[F];if(X&&X.Math==Math)return X}throw Error("Cannot find global object")}(this);function s(k,F){if(F)t:{var X=r;k=k.split(".");for(var M=0;M<k.length-1;M++){var E=k[M];if(!(E in X))break t;X=X[E]}(F=F(M=X[k=k[k.length-1]]))!=M&&F!=null&&i(X,k,{configurable:!0,writable:!0,value:F})}}function o(k){return(k={next:k})[Symbol.iterator]=function(){return this},k}function a(k){var F=typeof Symbol<"u"&&Symbol.iterator&&k[Symbol.iterator];return F?F.call(k):{next:e(k)}}if(s("Symbol",function(k){function F(E,I){this.A=E,i(this,"description",{configurable:!0,writable:!0,value:I})}if(k)return k;F.prototype.toString=function(){return this.A};var X="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",M=0;return function E(I){if(this instanceof E)throw new TypeError("Symbol is not a constructor");return new F(X+(I||"")+"_"+M++,I)}}),s("Symbol.iterator",function(k){if(k)return k;k=Symbol("Symbol.iterator");for(var F="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),X=0;X<F.length;X++){var M=r[F[X]];typeof M=="function"&&typeof M.prototype[k]!="function"&&i(M.prototype,k,{configurable:!0,writable:!0,value:function(){return o(e(this))}})}return k}),typeof Object.setPrototypeOf=="function")n=Object.setPrototypeOf;else{var c;t:{var d={};try{d.__proto__={a:!0},c=d.a;break t}catch{}c=!1}n=c?function(k,F){if(k.__proto__=F,k.__proto__!==F)throw new TypeError(k+" is not extensible");return k}:null}var l=n;function u(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function h(k){if(k.m)throw new TypeError("Generator is already running");k.m=!0}function p(k,F){return k.h=3,{value:F}}function T(k){this.g=new u,this.G=k}function m(k,F,X,M){try{var E=F.call(k.g.j,X);if(!(E instanceof Object))throw new TypeError("Iterator result "+E+" is not an object");if(!E.done)return k.g.m=!1,E;var I=E.value}catch(y){return k.g.j=null,k.g.s(y),f(k)}return k.g.j=null,M.call(k.g,I),f(k)}function f(k){for(;k.g.h;)try{var F=k.G(k.g);if(F)return k.g.m=!1,{value:F.value,done:!1}}catch(X){k.g.v=void 0,k.g.s(X)}if(k.g.m=!1,k.g.l){if(F=k.g.l,k.g.l=null,F.F)throw F.D;return{value:F.return,done:!0}}return{value:void 0,done:!0}}function R(k){this.next=function(F){return k.o(F)},this.throw=function(F){return k.s(F)},this.return=function(F){return function(X,M){h(X.g);var E=X.g.j;return E?m(X,"return"in E?E.return:function(I){return{value:I,done:!0}},M,X.g.return):(X.g.return(M),f(X))}(k,F)},this[Symbol.iterator]=function(){return this}}function v(k,F){return F=new R(new T(F)),l&&k.prototype&&l(F,k.prototype),F}if(u.prototype.o=function(k){this.v=k},u.prototype.s=function(k){this.l={D:k,F:!0},this.h=this.C||this.u},u.prototype.return=function(k){this.l={return:k},this.h=this.u},T.prototype.o=function(k){return h(this.g),this.g.j?m(this,this.g.j.next,k,this.g.o):(this.g.o(k),f(this))},T.prototype.s=function(k){return h(this.g),this.g.j?m(this,this.g.j.throw,k,this.g.o):(this.g.s(k),f(this))},s("Array.prototype.entries",function(k){return k||function(){return function(F,X){F instanceof String&&(F+="");var M=0,E=!1,I={next:function(){if(!E&&M<F.length){var y=M++;return{value:X(y,F[y]),done:!1}}return E=!0,{done:!0,value:void 0}}};return I[Symbol.iterator]=function(){return I},I}(this,function(F,X){return[F,X]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var A=function(k,F){for(var X=0;X<k.length;X++)F(k[X])},O=function(k){return k.replace(/\r?\n|\r/g,`\r
`)},w=function(k,F,X){return F instanceof Blob?(X=X!==void 0?X+"":typeof F.name=="string"?F.name:"blob",F.name===X&&Object.prototype.toString.call(F)!=="[object Blob]"||(F=new File([F],X)),[String(k),F]):[String(k),String(F)]},b=function(k,F){if(k.length<F)throw new TypeError(F+" argument required, but only "+k.length+" present.")},L=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,x=L.FormData,W=L.XMLHttpRequest&&L.XMLHttpRequest.prototype.send,K=L.Request&&L.fetch,ht=L.navigator&&L.navigator.sendBeacon,pt=L.Element&&L.Element.prototype,Vt=L.Symbol&&Symbol.toStringTag;Vt&&(Blob.prototype[Vt]||(Blob.prototype[Vt]="Blob"),"File"in L&&!File.prototype[Vt]&&(File.prototype[Vt]="File"));try{new File([],"")}catch{L.File=function(F,X,M){return F=new Blob(F,M||{}),Object.defineProperties(F,{name:{value:X},lastModified:{value:+(M&&M.lastModified!==void 0?new Date(M.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Vt&&Object.defineProperty(F,Vt,{value:"File"}),F}}var ce=function(k){return k.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},ne=function(k){this.i=[];var F=this;k&&A(k.elements,function(X){if(X.name&&!X.disabled&&X.type!=="submit"&&X.type!=="button"&&!X.matches("form fieldset[disabled] *"))if(X.type==="file"){var M=X.files&&X.files.length?X.files:[new File([],"",{type:"application/octet-stream"})];A(M,function(E){F.append(X.name,E)})}else X.type==="select-multiple"||X.type==="select-one"?A(X.options,function(E){!E.disabled&&E.selected&&F.append(X.name,E.value)}):X.type==="checkbox"||X.type==="radio"?X.checked&&F.append(X.name,X.value):(M=X.type==="textarea"?O(X.value):X.value,F.append(X.name,M))})};if((t=ne.prototype).append=function(k,F,X){b(arguments,2),this.i.push(w(k,F,X))},t.delete=function(k){b(arguments,1);var F=[];k=String(k),A(this.i,function(X){X[0]!==k&&F.push(X)}),this.i=F},t.entries=function k(){var F,X=this;return v(k,function(M){if(M.h==1&&(F=0),M.h!=3)return F<X.i.length?M=p(M,X.i[F]):(M.h=0,M=void 0),M;F++,M.h=2})},t.forEach=function(k,F){b(arguments,1);for(var X=a(this),M=X.next();!M.done;M=X.next()){var E=a(M.value);M=E.next().value,E=E.next().value,k.call(F,E,M,this)}},t.get=function(k){b(arguments,1);var F=this.i;k=String(k);for(var X=0;X<F.length;X++)if(F[X][0]===k)return F[X][1];return null},t.getAll=function(k){b(arguments,1);var F=[];return k=String(k),A(this.i,function(X){X[0]===k&&F.push(X[1])}),F},t.has=function(k){b(arguments,1),k=String(k);for(var F=0;F<this.i.length;F++)if(this.i[F][0]===k)return!0;return!1},t.keys=function k(){var F,X,M,E,I=this;return v(k,function(y){if(y.h==1&&(F=a(I),X=F.next()),y.h!=3)return X.done?void(y.h=0):(M=X.value,E=a(M),p(y,E.next().value));X=F.next(),y.h=2})},t.set=function(k,F,X){b(arguments,2),k=String(k);var M=[],E=w(k,F,X),I=!0;A(this.i,function(y){y[0]===k?I&&(I=!M.push(E)):M.push(y)}),I&&M.push(E),this.i=M},t.values=function k(){var F,X,M,E,I=this;return v(k,function(y){if(y.h==1&&(F=a(I),X=F.next()),y.h!=3)return X.done?void(y.h=0):(M=X.value,(E=a(M)).next(),p(y,E.next().value));X=F.next(),y.h=2})},ne.prototype._asNative=function(){for(var k=new x,F=a(this),X=F.next();!X.done;X=F.next()){var M=a(X.value);X=M.next().value,M=M.next().value,k.append(X,M)}return k},ne.prototype._blob=function(){var k="----formdata-polyfill-"+Math.random(),F=[],X="--"+k+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(M,E){return typeof M=="string"?F.push(X+ce(O(E))+`"\r
\r
`+O(M)+`\r
`):F.push(X+ce(O(E))+'"; filename="'+ce(M.name)+`"\r
Content-Type: `+(M.type||"application/octet-stream")+`\r
\r
`,M,`\r
`)}),F.push("--"+k+"--"),new Blob(F,{type:"multipart/form-data; boundary="+k})},ne.prototype[Symbol.iterator]=function(){return this.entries()},ne.prototype.toString=function(){return"[object FormData]"},pt&&!pt.matches&&(pt.matches=pt.matchesSelector||pt.mozMatchesSelector||pt.msMatchesSelector||pt.oMatchesSelector||pt.webkitMatchesSelector||function(k){for(var F=(k=(this.document||this.ownerDocument).querySelectorAll(k)).length;0<=--F&&k.item(F)!==this;);return-1<F}),Vt&&(ne.prototype[Vt]="FormData"),W){var Ei=L.XMLHttpRequest.prototype.setRequestHeader;L.XMLHttpRequest.prototype.setRequestHeader=function(k,F){Ei.call(this,k,F),k.toLowerCase()==="content-type"&&(this.B=!0)},L.XMLHttpRequest.prototype.send=function(k){k instanceof ne?(k=k._blob(),this.B||this.setRequestHeader("Content-Type",k.type),W.call(this,k)):W.call(this,k)}}K&&(L.fetch=function(k,F){return F&&F.body&&F.body instanceof ne&&(F.body=F.body._blob()),K.call(this,k,F)}),ht&&(L.navigator.sendBeacon=function(k,F){return F instanceof ne&&(F=F._asNative()),ht.call(this,k,F)}),L.FormData=ne}})();const Nc=()=>{const t=C("AREAS");return t.length===0&&t.push(Rt.GLOBAL),wn(t).call(t,(e,i,n)=>{const r=ow(i);return r?n===0?r:"".concat(e,",").concat(r):e},"")},ow=t=>t===Rt.OVERSEA?"".concat(Ye.ASIA,",").concat(Ye.EUROPE,",").concat(Ye.AFRICA,",").concat(Ye.NORTH_AMERICA,",").concat(Ye.SOUTH_AMERICA,",").concat(Ye.OCEANIA):Ye[t],Iu={GLOBAL:{ASIA:[Rt.CHINA,Rt.JAPAN,Rt.INDIA,Rt.KOREA,Rt.HKMC],EUROPE:[],NORTH_AMERICA:[Rt.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},yu=Object.keys(Iu[Rt.GLOBAL]),hm=[Rt.CHINA,Rt.NORTH_AMERICA,Rt.EUROPE,Rt.ASIA,Rt.JAPAN,Rt.INDIA,Rt.OCEANIA,Rt.SOUTH_AMERICA,Rt.AFRICA,Rt.KOREA,Rt.HKMC,Rt.US],hW=function(t,e){let i=[];if(B(t).call(t,Rt.GLOBAL)){const s=[Rt.GLOBAL,Rt.OVERSEA],o=Object.keys(Eu);if(e===Rt.GLOBAL)throw new D(S.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===Rt.CHINA)i=[Rt.OVERSEA];else if(r=e,B(yu).call(yu,r)){const a=(n=e,Iu[Rt.GLOBAL][n]||[]),c=[...s,e,...a];i=o.filter(d=>!B(c).call(c,d))}else if(function(a){let c=!1;return yu.forEach(d=>{var l;B(l=Iu[Rt.GLOBAL][d]).call(l,a)&&(c=!0)}),c}(e)){const a=function(d){let l;return yu.forEach(u=>{var h;B(h=Iu[Rt.GLOBAL][u]).call(h,d)&&(l=u)}),l}(e),c=[...s,a,e];i=o.filter(d=>!B(c).call(c,d))}else i=t;i=function(a){const c=[];return hm.forEach(d=>{B(a).call(a,d)&&c.push(d)}),c.concat(a.filter(d=>!B(hm).call(hm,d)))}(i)}else i=t;var n,r;return i};function aw(t){var e,i;if(!t&&B(e=C("AREAS")).call(e,Rt.EXTENSIONS))return _.debug("update area from ap : reset"),void pm(v3,!0);if(!B(i=C("AREAS")).call(i,Rt.GLOBAL)||!t)return;let n=Eu.EXTENSIONS;n&&(n={CODE:ow(Rt.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(t,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(t,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(t,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(t,".agora.io"),"cds-ap-web-2-".concat(t,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(t,".agora.io"),"sua-ap-web-2-".concat(t,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(t,".agora.io"),"uap-ap-web-2-".concat(t,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(t,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(t,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(t,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(t,".agora.io")]},_.debug("update area from ap success: ".concat(t,",config is "),n),Ot("AREAS",[Rt.EXTENSIONS],!0),Object.keys(n).map(r=>{r==="LOG_UPLOAD_SERVER"||r==="EVENT_REPORT_DOMAIN"||r==="EVENT_REPORT_BACKUP_DOMAIN"||r==="PROXY_SERVER_TYPE3"?Ot(r,n[r][0]):Ot(r,n[r])}))}function pm(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i=Q.reportApiInvoke(null,{name:fe.SET_AREA,options:t,tag:Qt.TRACER});try{let n=[];if(typeof t=="string"&&(n=[t]),Array.isArray(t)&&(t.forEach(s=>{if(!B(bb).call(bb,s))throw new D(S.INVALID_PARAMS,"invalid area code")}),n=t),Object.prototype.toString.call(t)==="[object Object]"){const{areaCode:s,excludedArea:o}=t;if(!s)throw new D(S.INVALID_PARAMS,"area code is needed");let a=s;typeof s=="string"&&(a=[s]),n=o?hW(a,o):a}if(!e){if(xn.AREAS){const s=new D(S.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return i.onError(s),void _.warning("setArea is prohibited because of config-distribute")}if(B(n).call(n,Rt.GLOBAL)&&C("AREAS")===Rt.EXTENSIONS){const s=new D(S.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return i.onError(s),void _.warning("setArea is prohibited because of ap extensions")}}Ot("AREAS",n,e);const r=(s=>{const o={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return s.map(a=>{const c=Eu[a],d=Object.keys(c);d&&d.map(l=>{l!=="CODE"&&(o[l]=o[l].concat(c[l]))})}),o})(n);Object.keys(r).map(s=>{s==="LOG_UPLOAD_SERVER"||s==="EVENT_REPORT_DOMAIN"||s==="EVENT_REPORT_BACKUP_DOMAIN"||s==="PROXY_SERVER_TYPE3"?Ot(s,r[s][0]):Ot(s,r[s])}),_.debug("set area success:",n.join(","))}catch(n){throw i.onError(n),n}i.onSuccess()}function cw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function sr(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?cw(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):cw(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let _m=1;function pW(t,e,i,n,r){_m+=1;const s={sid:i.sid,command:"convergeAllocateEdge",uid:"666",appId:i.appId,ts:Math.floor(Date.now()/1e3),seq:_m,requestId:_m,version:Zi,cname:i.cname},o={service_name:e,json_body:JSON.stringify(s)};let a,c,d=t[0];return Un(async()=>{a=Date.now();const l=await jn(d,{data:o,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,l.code!==0){const p=new D(S.UNEXPECTED_RESPONSE,"live streaming ap error, code"+l.code,{retry:!0,responseTime:c});throw _.error(p.toString()),p}const u=JSON.parse(l.json_body);if(u.code!==200){const p=new D(S.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(u.code,", reason: ").concat(u.reason),{code:u.code,responseTime:c});throw _.error(p.toString()),p}if(!u.servers||u.servers.length===0){const p=new D(S.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:u.code,responseTime:c});throw _.error(p.toString()),p}const h=function(p,T){return{addressList:p.servers.map(m=>"wss://".concat(m.address.replace(/\./g,"-"),".").concat(C("WORKER_DOMAIN"),":").concat(m.wss,"?serviceName=").concat(encodeURIComponent(T))),workerToken:p.workerToken,vid:p.vid}}(u,e);return C("LIVE_STREAMING_ADDRESS")&&(h.addressList=C("LIVE_STREAMING_ADDRESS")instanceof Array?C("LIVE_STREAMING_ADDRESS"):[C("LIVE_STREAMING_ADDRESS")]),sr(sr({},h),{},{responseTime:c})},(l,u)=>(Q.apworkerEvent(i.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(l.addressList),firstSuccess:u===0,responseTime:c,serverIp:t[u%t.length]}),!1),(l,u)=>(Q.apworkerEvent(i.sid,{success:!1,sc:l.data&&l.data.code||200,serviceName:e,responseTime:c,serverIp:t[u%t.length]}),!!(l.code!==S.OPERATION_ABORTED&&l.code!==S.UNEXPECTED_RESPONSE||l.data&&l.data.retry)&&(d=t[(u+1)%t.length],!0)),r)}let Em=1;function dw(t,e,i,n){let{url:r,areaCode:s}=t;const{clientId:o,sid:a}=e,c=Date.now();let d;const l=e.role,[u,h]=fm(e,s,[he.CHOOSE_SERVER]);let p=ue.networkState;return Un(async()=>{p&&ue.networkState===Ni.OFFLINE&&ue.onlineWaiter&&await G.race([ue.onlineWaiter,ke(n&&n.maxRetryTimeout||ge.maxRetryTimeout)]),p=ue.networkState;const{data:T,headers:m}=await jn(r,{data:u,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d=m.http3==="1"?1:-1,Q.reportResourceTiming(r,a),uw(T,r,e,c,[he.CHOOSE_SERVER],d);const f=bc(T,he.CHOOSE_SERVER);return mm(f),sm(f,r)},T=>(T&&Q.joinChooseServer(a,{role:l,lts:c,succ:!0,csAddr:r,opid:h,serverList:T.gatewayAddrs.map(m=>m.address),ec:null,cid:T.cid.toString(),uid:T.uid.toString(),csIp:T.csIp,unilbsServerIds:[he.CHOOSE_SERVER].toString(),isHttp3:d,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:T.res.detail&&T.res.detail[38]}),!1),T=>T.code!==S.OPERATION_ABORTED&&(T.code===S.CAN_NOT_GET_GATEWAY_SERVER?T.data.retry:(Q.joinChooseServer(a,{role:l,lts:c,succ:!1,csAddr:r,serverList:null,opid:h,ec:T.code,csIp:T.data&&T.data.csIp,unilbsServerIds:[he.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:p}),isHttp3:d,corssRegionTagReq:e.apRequestDetail}),_.warning("[".concat(o||"sid-".concat(a.slice(0,6)),"] Choose server network error, retry"),T),!0)),n)}function lw(t,e,i,n){let r,{url:s,areaCode:o,serviceIds:a}=t;const c=Date.now(),d=e.role,[l,u]=fm(e,o,a);let h;return Un(async()=>{h&&ue.networkState===Ni.OFFLINE&&ue.onlineWaiter&&await G.race([ue.onlineWaiter,ke(n&&n.maxRetryTimeout||ge.maxRetryTimeout)]),h=ue.networkState;const{data:p,headers:T}=await jn(s,{data:l,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r=T.http3==="1"?1:-1,Q.reportResourceTiming(s,e.sid),uw(p,s,e,c,a,r);const m=bc(p,he.CHOOSE_SERVER),f=bc(p,e.cloudProxyServer==="proxy5"?he.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?he.CLOUD_PROXY:he.CLOUD_PROXY_FALLBACK);return mm(m),{gatewayInfo:sm(m,s),proxyInfo:f,url:s}},p=>(p.gatewayInfo&&Q.joinChooseServer(e.sid,{role:d,lts:c,succ:!0,csAddr:s,serverList:p.gatewayInfo.gatewayAddrs.map(T=>T.address),ec:null,opid:u,cid:p.gatewayInfo.cid.toString(),uid:p.gatewayInfo.uid.toString(),csIp:p.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:p.gatewayInfo.res.detail&&p.gatewayInfo.res.detail[38]}),p.proxyInfo&&Q.joinWebProxyAP(e.sid,{lts:c,sucess:1,apServerAddr:s,turnServerAddrList:p.proxyInfo.addresses.map(T=>T.ip).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:a.toString()}),!1),p=>p.code!==S.OPERATION_ABORTED&&(p.code===S.CAN_NOT_GET_GATEWAY_SERVER?p.data.retry:(Q.joinWebProxyAP(e.sid,{lts:c,sucess:0,apServerAddr:s,turnServerAddrList:null,errorCode:p.code,eventType:e.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:h})}),_.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),p),!0)),n)}const uw=(t,e,i,n,r,s)=>{const{sid:o,clientId:a,cloudProxyServer:c}=i,d=[],l=u=>{u.flag===4096?Q.joinChooseServer(o,{role:i.role,lts:n,succ:!1,csAddr:e,opid:t.opid,serverList:null,ec:u.error.message,csIp:u.error.data&&u.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:s,corssRegionTagReq:i.apRequestDetail}):u.flag!==1048576&&u.flag!==4194304&&u.flag!==4194310||Q.joinWebProxyAP(o,{lts:n,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:u.error.code,eventType:c,unilbsServerIds:r.toString()})};if(t.response_body.forEach(u=>{const h=u.buffer.code;if(u.uri===23&&h===0&&!u.buffer.edges_services)if(u.buffer.flag===4194310)_.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),u.buffer.edges_services=[];else{const p={error:new D(S.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:t.detail[502]}),flag:u.buffer.flag};d.push(p),l(p)}if(h!==0){const p=ca(h),T={error:new D(S.CAN_NOT_GET_GATEWAY_SERVER,p.desc,{desc:p.desc,retry:p.retry,csIp:t.detail[502]}),flag:u.buffer.flag};u.buffer.flag===4194310?_.warning(T.error.toString()):d.push(T),l(T)}}),d.length)throw _.warning("[".concat(a||"sid-".concat(o.slice(0,6)),"] multi unilbs ").concat(e," failed, ").concat(d.map(u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message,", retry: ").concat(u.error.data.retry)).join(" | "))),new D(S.CAN_NOT_GET_GATEWAY_SERVER,d.map(u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message)).join(" | "),{retry:!!d.find(u=>u.error.data.retry),csIp:t.detail[502],desc:[...new Set(d.map(u=>{var h;return u==null||(h=u.error)===null||h===void 0||(h=h.data)===null||h===void 0?void 0:h.desc}).filter(u=>!!u))]})},mm=t=>{var e,i,n,r;if(t.addresses&&t.addresses.length===0&&t.code===0)throw new D(S.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:t.detail&&t.detail[502]});if(C("AP_AREA")&&((n=t.detail)!==null&&n!==void 0&&n[23]&&typeof((r=t.detail)===null||r===void 0?void 0:r[23])=="string"?aw(t.detail[23].toLowerCase()):aw()),(e=t.detail)!==null&&e!==void 0&&e[19]&&typeof((i=t.detail)===null||i===void 0?void 0:i[19])=="string"){const o=t.detail[19],a=o==null?void 0:o.split(";");for(let c=0;c<a.length;c++){var s;const d=Xe(s=a[c]).call(s);t.addresses[c]&&a&&(t.addresses[c].fingerprint=d)}}if(C("GATEWAY_ADDRESS")&&C("GATEWAY_ADDRESS").length>0){_.debug("assign gateway address to",C("GATEWAY_ADDRESS"));const o=C("GATEWAY_ADDRESS").map(a=>{var c,d;const l=(c=(d=t.addresses.find(u=>u.ip===a.ip&&u.port===a.port))===null||d===void 0?void 0:d.fingerprint)!==null&&c!==void 0?c:"";return{ip:a.ip,port:a.port,ticket:t.addresses[0]&&t.addresses[0].ticket,fingerprint:l}});t.addresses=o}},_W=(t,e)=>{if(t.response_body&&t.response_body.length){const i=t.response_body[0];if(i.buffer.code!==0){const n=ca(i.buffer.code);throw new D(S.UPDATE_TICKET_FAILED,"[".concat(i.buffer.code,"]: ").concat(n.desc),{retry:n.retry})}return i.buffer.ticket}throw _.debug("update ticket request received ap response without response body:",e),new D(S.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},fm=(t,e,i)=>{const n=Math.floor(Math.random()*1e12),r=t.role==="host"?"1":t.role==="audience"?"2":void 0,s={appid:t.appId,client_ts:Date.now(),opid:n,sid:t.sid,request_bodies:[{uri:22,buffer:{cname:t.cname,detail:sr(sr(sr({6:t.stringUid,11:e,12:C("USE_NEW_TOKEN")?"1":void 0},r?{17:r}:{}),{},{22:e},t.apRequestDetail?{33:t.apRequestDetail}:{}),t.apRTM?{26:"RTM2"}:{}),key:t.token,service_ids:i,uid:t.uid||0}}]};s.request_bodies.forEach(a=>{t.multiIP&&t.multiIP.gateway_ip&&(a.buffer.detail[5]=JSON.stringify({vocs_ip:[t.multiIP.uni_lbs_ip],vos_ip:[t.multiIP.gateway_ip]}))});const o=new FormData;return o.append("request",JSON.stringify(s)),[o,n]},EW=(t,e)=>{const i=Math.floor(Math.random()*1e12),n={appid:t.appId,client_ts:Date.now(),opid:i,sid:t.sid,request_bodies:[{uri:28,buffer:{cname:t.cname,detail:{1:"",6:t.stringUid,12:"1"},token:t.token,service_ids:e,uid:t.uid||0,edges_services:t.apResponse.addresses.map(s=>({ip:s.ip,port:s.port}))}}]},r=new FormData;return r.append("request",JSON.stringify(n)),[r,i]};let pa=0;function _a(t){return G.all(t.map(e=>e.then(i=>{throw i},i=>i))).then(e=>{throw e},e=>e)}const Dc=async t=>{let{fragementLength:e,referenceList:i,asyncMapHandler:n,allFailedhandler:r,promisesCollector:s}=t,o=0;const a=e;let c,d=0;const l=async()=>{const u=(()=>{const h=o*a,p=h+a;return i.slice(h,p).map(n)})();s&&s.push(...u);try{c=await _a(u)}catch(h){if(d+=a,o++,!(d>=i.length))return void await l();r(h)}u.forEach(h=>h.cancel())};return await l(),c},hw=async t=>{let{referenceList:e,asyncMapHandler:i,closeFn:n}=t;const r=e.length;let s=0;const o=async()=>{const a=i(e.shift());try{return await a}catch(c){if(s++,s>=r||n!=null&&n(c))throw c;return o()}};return o()};async function gm(t,e,i,n){return{gatewayInfo:await async function(s,o,a,c){let d=null;const l=[],u=async()=>{const p=C("WEBCS_DOMAIN").slice(0,C("AJAX_REQUEST_CONCURRENT")).map(f=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(f+"/api/v2/transpond/webrtc?v=2"):"https://".concat(f,"/api/v2/transpond/webrtc?v=2"),areaCode:Nc()})),T=c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(f=>f.url)}),m=await Dc({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:f=>(_.debug("[".concat(s.clientId,"] Connect to choose_server:"),f.url),dw(f,s,o,a)),allFailedhandler:f=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:f},T),f[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},T),m},h=async()=>{if(await ke(1e3),d!==null)return d;const p=C("WEBCS_DOMAIN_BACKUP_LIST").map(f=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(f+"/api/v2/transpond/webrtc?v=2"):"https://".concat(f,"/api/v2/transpond/webrtc?v=2"),areaCode:Nc()})),T=c.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(f=>f.url)}),m=await Dc({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:f=>(_.debug("[".concat(s.clientId,"] Connect to backup choose_server:"),f.url),dw(f,s,o,a)),allFailedhandler:f=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:f},T),f[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},T),m};try{return d=await _a([u(),h()]),l.length&&l.forEach(p=>p.cancel&&typeof p.cancel=="function"&&p.cancel()),d}catch(p){throw p[0]}}(t,e,i,n)}}async function pw(t,e,i,n,r){const s=t.cloudProxyServer;if(s==="disabled"){if(t.useLocalAccessPoint)return await gm(t,e,i,r);if(C("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:h,proxyInfo:p}=await mw(t,e,i,r);if(t.turnServer&&t.turnServer.mode!=="auto")return{gatewayInfo:h};const T=p.map(m=>({turnServerURL:m.address,tcpport:m.tcpport||je.tcpport,udpport:m.udpport||je.udpport,username:m.username||je.username,password:m.password||je.password,forceturn:!1,security:!0}));if(r.useP2P){var o;const m=(o=t.uid)!==null&&o!==void 0?o:h.uid,f="glb:".concat(m.toString()),R=await hE(f),v=p.map(A=>({turnServerURL:A.address,tcpport:A.tcpport||je.tcpport,udpport:A.udpport||je.udpport,username:f,password:R,forceturn:!1,security:!0}));T.push(...v)}return t.turnServer={mode:"manual",servers:T},{gatewayInfo:h}}return await gm(t,e,i,r)}const{proxyInfo:a,gatewayInfo:c}=await mw(t,e,i,r),d={gatewayInfo:c},l=a.map(h=>({turnServerURL:h.address,tcpport:s==="proxy3"?void 0:h.tcpport?h.tcpport:je.tcpport,udpport:s==="proxy4"?void 0:h.udpport?h.udpport:je.udpport,username:h.username||je.username,password:h.password||je.password,forceturn:s!=="proxy4",security:s==="proxy5"}));if(r.useP2P){var u;const h=(u=t.uid)!==null&&u!==void 0?u:c.uid,p="glb:".concat(h.toString()),T=await hE(p),m=a.map(f=>({turnServerURL:f.address,tcpport:s==="proxy3"?void 0:f.tcpport||je.tcpport,udpport:s==="proxy4"?void 0:f.udpport||je.udpport,username:p,password:T,forceturn:s!=="proxy4",security:s==="proxy5"}));l.push(...m)}return t.turnServer={mode:"manual",servers:l},_.debug("[".concat(t.clientId,"] set proxy server: ").concat(t.proxyServer,", mode: ").concat(s)),d}async function _w(t,e,i,n,r){const s=C("ACCOUNT_REGISTER").slice(0,C("AJAX_REQUEST_CONCURRENT"));let o=[];o=e.proxyServer?s.map(c=>"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v1")):s.map(c=>"https://".concat(c,"/api/v1"));const a=r==null?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:o});try{const c=await async function(d,l,u,h,p){const T=Date.now(),m={sid:u.sid,opid:10,appid:u.appId,string_uid:l};let f=d[0];const R=await Un(()=>jn(f+"".concat(f.indexOf("?")===-1?"?":"&","action=stringuid"),{data:m,cancelToken:h,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(v,A)=>{if(v.code===0){if(v.uid<=0||v.uid>=Math.pow(2,32))throw _.error("Invalid Uint Uid ".concat(l," => ").concat(v.uid),v),Q.reqUserAccount(m.sid,{lts:T,success:!1,serverAddr:f,stringUid:m.string_uid,uid:v.uid,errorCode:S.INVALID_UINT_UID_FROM_STRING_UID,extend:m}),new D(S.INVALID_UINT_UID_FROM_STRING_UID);return Q.reqUserAccount(m.sid,{lts:T,success:!0,serverAddr:f,stringUid:m.string_uid,uid:v.uid,errorCode:null,extend:m}),!1}const O=ca(v.code);return O.retry&&(f=d[(A+1)%d.length]),Q.reqUserAccount(m.sid,{lts:T,success:!1,serverAddr:f,stringUid:m.string_uid,uid:v.uid,errorCode:O.desc,extend:m}),O.retry},(v,A)=>v.code!==S.OPERATION_ABORTED&&(Q.reqUserAccount(m.sid,{lts:T,success:!1,serverAddr:f,stringUid:m.string_uid,uid:null,errorCode:v.code,extend:m}),f=d[(A+1)%d.length],!0),p);if(R.code!==0){const v=ca(R.code);throw new D(S.UNEXPECTED_RESPONSE,v.desc)}return R}(o,t,e,i,n);return r==null||r.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw r==null||r.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}}async function mW(t,e,i){const n=C("ACCOUNT_REGISTER");let r=[];r=e.proxyServer?n.map(s=>"https://".concat(e.proxyServer,"/ap/?url=").concat(s+"/api/v1")):n.map(s=>"https://".concat(s,"/api/v1"));try{return await hw({referenceList:r,asyncMapHandler:o=>async function(a,c,d,l){const u=Date.now(),h={sid:d.sid,opid:10,appid:d.appId,string_uid:c};try{const p=await jn(a+"".concat(a.indexOf("?")===-1?"?":"&","action=stringuid"),{data:h,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(p.code!==0){const T=ca(p.code);throw new D(S.UNEXPECTED_RESPONSE,"preload sua error:".concat(T.desc),T)}if(p.uid<=0||p.uid>=Math.pow(2,32))throw new D(S.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:u,url:a,req:h,uid:p.uid,elapse:Date.now()-u}}catch(p){throw p}}(o,t,e,i),closeFn:o=>o.code===S.OPERATION_ABORTED||o.code===S.UNEXPECTED_RESPONSE&&!o.data.retry})}catch(s){throw s}}async function fW(t,e,i){const n=C("CDS_AP").slice(0,C("AJAX_REQUEST_CONCURRENT")).map(c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v1"):"https://".concat(c,"/api/v1?action=config")),r=n.map(c=>function(d,l,u,h){const p=Tt(),T={flag:64,cipher_method:0,features:sr(sr(sr(sr(sr({install_id:CE(),device:p.name,system:p.os,system_general:navigator.userAgent,vendor:l.appId,version:Zi,cname:l.cname,session_id:l.sid,proxyServer:l.proxyServer,sdk_type:dW.WEB_RTC,browser_name:p.name,browser_version:p.version,user_agent:navigator.userAgent,channel_name:l.cname},l.stringUid&&{string_uid:l.stringUid}),l.uid&&{uid:l.uid+""}),p.os&&{os_name:p.os}),p.osVersion&&{os_version:p.osVersion}),{},{detail:""})};return Un(()=>jn(d,{data:T,timeout:1e3,cancelToken:u,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,m=>m.code!==S.OPERATION_ABORTED,h)}(c,t,e,i));let s=null,o=null,a={};try{s=await _a(r)}catch(c){if(c.code===S.OPERATION_ABORTED)throw c;o=c}if(r.forEach(c=>c.cancel()),Q.reportApiInvoke(t.sid,{name:fe.REQUEST_CONFIG_DISTRIBUTE,options:{error:o,res:s}}).onSuccess(),s&&s.test_tags)try{a=function(c){if(!c.test_tags)return{};const d=c.test_tags,l=Object.keys(d),u={};return l.forEach(h=>{var p;const T=Xe(p=h.slice(4)).call(p),m=JSON.parse(d[h]),f=m[1];u[T]={tag:m[0]||"",value:f}}),u}(s)}catch{}return a}async function Ew(t,e){const i=C("WEBCS_DOMAIN").concat(C("WEBCS_DOMAIN_BACKUP_LIST")).map(n=>({url:"https://".concat(n,"/api/v2/transpond/webrtc?v=2"),areaCode:Nc(),serviceIds:[he.CHOOSE_SERVER,he.CLOUD_PROXY_FALLBACK]}));try{return await hw({referenceList:i,asyncMapHandler:r=>async function(s,o,a){let c,{url:d,areaCode:l,serviceIds:u}=s;const h=Date.now(),[p,T]=fm(o,l,u);let m=ue.networkState;try{m&&ue.networkState===Ni.OFFLINE&&ue.onlineWaiter&&await G.race([ue.onlineWaiter,ke(ge.maxRetryTimeout)]),m=ue.networkState;const{data:f,headers:R}=await jn(d,{data:p,cancelToken:a,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);c=R.http3==="1"?1:-1,(w=>{const b=[];if(w.response_body.forEach(L=>{const x=L.buffer.code;if(L.uri===23&&x===0&&!L.buffer.edges_services)if(L.buffer.flag===4194310)L.buffer.edges_services=[];else{const W={error:new D(S.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:w.detail[502]}),flag:L.buffer.flag};b.push(W)}if(x!==0){const W=ca(x),K={error:new D(S.CAN_NOT_GET_GATEWAY_SERVER,W.desc,{desc:W.desc,retry:W.retry,csIp:w.detail[502]}),flag:L.buffer.flag};L.buffer.flag===4194310?_.warning(K.error.toString()):b.push(K)}}),b.length)throw new D(S.CAN_NOT_GET_GATEWAY_SERVER,b.map(L=>"flag: ".concat(L.flag,", message: ").concat(L.error.message)).join(" | "),{retry:!!b.find(L=>L.error.data.retry),csIp:w.detail[502],desc:[...new Set(b.map(L=>{var x;return L==null||(x=L.error)===null||x===void 0||(x=x.data)===null||x===void 0?void 0:x.desc}).filter(L=>!!L))]})})(f);const A=bc(f,he.CHOOSE_SERVER),O=bc(f,he.CLOUD_PROXY_FALLBACK);return mm(A),{gatewayInfo:sm(A,d),proxyInfo:O,opid:T,requestTime:h,url:d,isHttp3:c,elapse:Date.now()-h}}catch(f){throw f}}(r,t,e),closeFn:r=>r.code===S.OPERATION_ABORTED||r.code===S.CAN_NOT_GET_GATEWAY_SERVER&&!r.data.retry})}catch(n){throw n}}async function mw(t,e,i,n){const r=C("PROXY_SERVER_TYPE3"),s=(p,T,m)=>{let f=m||r;return Array.isArray(f)&&(f=T%2==0?r[1]:r[0]),"https://".concat(f,"/ap/?url=").concat(p)};let o=null;const a=[],c=async()=>{const p=C("WEBCS_DOMAIN").slice(0,C("AJAX_REQUEST_CONCURRENT")).map((f,R)=>{let v;return v=t.cloudProxyServer==="disabled"&&t.proxyServer?s("".concat(f,"/api/v2/transpond/webrtc?v=2"),R,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(f,"/api/v2/transpond/webrtc?v=2"):s("".concat(f,"/api/v2/transpond/webrtc?v=2"),R),{url:v,areaCode:Nc(),serviceIds:[he.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?he.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?he.CLOUD_PROXY:he.CLOUD_PROXY_FALLBACK]}}),T=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(f=>f.url)}),m=await Dc({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:f=>(_.debug("[".concat(t.clientId,"] Connect to choose_server:"),f.url),lw(f,t,e,i)),allFailedhandler:f=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:f},T),f[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},T),m},d=async()=>{if(await ke(1e3),o!==null)return o;const p=C("WEBCS_DOMAIN_BACKUP_LIST").map((f,R)=>{let v;return v=t.cloudProxyServer==="disabled"&&t.proxyServer?s("".concat(f,"/api/v2/transpond/webrtc?v=2"),R,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(f,"/api/v2/transpond/webrtc?v=2"):s("".concat(f,"/api/v2/transpond/webrtc?v=2"),R),{url:v,areaCode:Nc(),serviceIds:[he.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?he.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?he.CLOUD_PROXY:he.CLOUD_PROXY_FALLBACK]}}),T=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(f=>f.url)}),m=await Dc({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:f=>(_.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),f.url),lw(f,t,e,i)),allFailedhandler:f=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:f},T),f[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},T),m};let l,u,h;try{({gatewayInfo:l,proxyInfo:u,url:h}=await _a([c(),d()]))}catch(p){throw p[0]}if(a.length&&a.forEach(p=>p.cancel&&typeof p.cancel=="function"&&p.cancel()),!l||!u)throw new D(S.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(t.apUrl=h,t.cloudProxyServer!=="disabled"&&Array.isArray(r)&&h){const p=/^https?:\/\/(.+?)(\/.*)?$/.exec(h)[1];B(r).call(r,p)&&(t.proxyServer=p,_.setProxyServer(p),Q.setProxyServer(p))}return o={gatewayInfo:l,proxyInfo:await Bb(u,l.uid)},o}async function gW(t,e,i){const n=C("UAP_AP").slice(0,C("AJAX_REQUEST_CONCURRENT")).map(s=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(s+"/api/v1?action=uap"):"https://".concat(s,"/api/v1?action=uap")),r=n.map(s=>function(o,a,c,d){const l={command:"convergeAllocateEdge",sid:a.sid,appId:a.appId,token:a.token,ts:Date.now(),version:Zi,cname:a.cname,uid:a.uid.toString(),requestId:Em,seq:Em};Em+=1;const u={service_name:"tele_channel",json_body:JSON.stringify(l)};return Un(async()=>{const h=await jn(o,{data:u,cancelToken:c,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(h.code!==0){const T=new D(S.UNEXPECTED_RESPONSE,"cross channel ap error, code"+h.code,{retry:!0});throw _.error(T.toString()),T}const p=JSON.parse(h.json_body);if(p.code!==200){const T=new D(S.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(p.code,", reason: ").concat(p.reason));throw _.error(T.toString()),T}if(!p.servers||p.servers.length===0){const T=new D(S.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw _.error(T.toString()),T}return{vid:p.vid,workerToken:p.workerToken,addressList:(C("CHANNEL_MEDIA_RELAY_SERVERS")||p.servers).map(T=>"wss://".concat(T.address.replace(/\./g,"-"),".").concat(C("WORKER_DOMAIN"),":").concat(T.wss))}},void 0,h=>!!(h.code!==S.OPERATION_ABORTED&&h.code!==S.UNEXPECTED_RESPONSE||h.data&&h.data.retry),d)}(s,t,e,i));try{const s=await _a(r);return r.forEach(o=>o.cancel()),s}catch(s){throw s[0]}}async function TW(t,e,i){let n=null;const r=[],s=async o=>{const a=C(o?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v2/transpond/webrtc?v=2"):"https://".concat(c,"/api/v2/transpond/webrtc?v=2"));return o&&(await ke(1e3),n!==null)?n:await Dc({fragementLength:C("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:c=>(_.debug("[".concat(t.clientId,"] update ticket, Connect to ").concat(o?"backup":""," choose_server:"),c),function(d,l,u,h){const[p]=EW(l,[he.CHOOSE_SERVER]);let T=ue.networkState;return Un(async()=>{T&&ue.networkState===Ni.OFFLINE&&ue.onlineWaiter&&await G.race([ue.onlineWaiter,ke(h&&h.maxRetryTimeout||ge.maxRetryTimeout)]),T=ue.networkState;const m=await jn(d,{data:p,cancelToken:u,headers:{"Content-Type":"multipart/form-data;"}},!0);return _W(m,d)},()=>!1,m=>m.code!==S.OPERATION_ABORTED&&(m.code===S.UPDATE_TICKET_FAILED?m.data.retry:(_.warning("[".concat(l.clientId,"] update ticket network error, retry"),m),!0)),h)}(c,t,e,i)),allFailedhandler:c=>{throw c[0]},promisesCollector:r})};try{return n=await _a([s(!1),s(!0)]),r.length&&r.forEach(o=>o.cancel&&typeof o.cancel=="function"&&o.cancel()),n}catch(o){throw o[0]}}function fw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Tm(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?fw(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):fw(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class SW extends qt{get isSuccess(){return!!this.configs}constructor(e,i){super(),g(this,"configs",void 0),g(this,"store",void 0),g(this,"joinInfo",void 0),g(this,"cancelToken",void 0),g(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),g(this,"interval",void 0),g(this,"mutex",void 0),g(this,"mutableParamsRead",!1),g(this,"configCache",{}),g(this,"limit_bitrate",void 0),this.mutex=new Ke("config-distribute",e),this.store=i}startGetConfigDistribute(e,i){this.joinInfo=e,this.cancelToken=i,this.interval&&this.stopGetConfigDistribute(),C("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},C("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.configs=void 0,this.limit_bitrate=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,Q.reportApiInvoke(null,{options:void 0,name:fe.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:Qt.TRACER}).onSuccess(JSON.stringify(xn))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void _.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const i=await this.mutex.lock();try{e=await fW(this.joinInfo,this.cancelToken,this.retryConfig),_.debug("[config-distribute] get config distribute",JSON.stringify(e));const n=function(r){var s;const o=tc(s=Object.keys(r).filter(d=>/^webrtc_ng_global_parameter/.test(d))).call(s);for(let d=0;d<o.length;d++)for(let l=o.length-1;l>d;l--){const u=o[l],h=r[u].value;if(typeof h.__priority=="number"){const p=h.__priority,T=o[l-1],m=r[T].value;if(typeof m.__priority=="number"){if(!(p>m.__priority))continue;{const f=u;o[l]=o[l-1],o[l-1]=f}}else{const f=u;o[l]=o[l-1],o[l-1]=f}}}const a=Date.now();let c={};return o.forEach(d=>{const l=r[d].value.__expires;l&&l<=a||(c[d]=r[d])}),c}(e);this.cacheGlobalParameterConfig(n),this.store.hasStartJoinChannel||(this.store.isABTestSuccess=!0),this.configs=n}catch(n){const r=new D(S.NETWORK_RESPONSE_ERROR,n);_.warning("[config-distribute] ".concat(r.toString()))}finally{i()}}getBitrateLimit(){return this.limit_bitrate||void 0}handleBitrateLimit(e){wb(e)&&(this.limit_bitrate?this.limit_bitrate&&this.limit_bitrate.id!==e.id&&this.emit(Ic.UPDATE_BITRATE_LIMIT,e):this.emit(Ic.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.limit_bitrate&&Tm({},this.limit_bitrate.low_stream_uplink)}handleABTestConfigDistribute(e){try{const i={},n=Object.keys(e),r=[];n.forEach(s=>{const o=e[s].value;i[s]=o;const a=o.__id;if(a&&this.configCache[s]&&this.configCache[s].__id===a)return;const c=o.__type,d=e[s].value,l=e[s].tag;let u=0;c?c===cy.REALTIME&&(u=1):Object.keys(d).some(h=>Object.prototype.hasOwnProperty.call(bE,h)||!JE()&&Object.prototype.hasOwnProperty.call(ql,h)?(u=1,!0):void 0),r.push({tag:l,isApplied:u,feature:s,params:JSON.stringify(o)})}),r.forEach(s=>{let{tag:o,feature:a,params:c,isApplied:d}=s;this.store.sessionId&&Q.abTest(this.store.sessionId,{intSucc:1,isApplied:d,tag:o,feature:a,params:c,cid:this.store.cid,uid:this.store.intUid})}),this.configCache=i}catch(i){_.debug("handleABTestConfigDistribute error",i)}}cacheGlobalParameterConfig(e){const i=function(r){const s={};return Object.keys(r).forEach(o=>{const a=r[o].value,c=a.__expires,d=a.__type;Object.keys(a).forEach(l=>{l==="__id"||l==="__type"||l==="__priority"||l==="__expires"||Object.prototype.hasOwnProperty.call(s,l)||(s[l]=Tm(Tm({value:a[l]},c&&{expires:c}),d&&{type:d}))})}),s}(e);try{var n;const r=(n=i.LIMIT_BITRATE)===null||n===void 0?void 0:n.value;delete i.LIMIT_BITRATE,r&&wb(r)&&this.handleBitrateLimit(r),this.limit_bitrate=r,this.handleGlobalParameterConfig(i),this.handleABTestConfigDistribute(e),function(a){try{const c=Date.now();Object.keys(a).forEach(d=>{const{value:l,type:u,expires:h}=a[d];h&&h<=c||((u===cy.REALTIME||Object.prototype.hasOwnProperty.call(bE,d))&&(xn[d]=l,zt[d]=l,_.debug("Update realtime parameters from config distribute",d,l)),u||JE()||!Object.prototype.hasOwnProperty.call(ql,d)||(xn[d]=l,zt[d]=l,_.debug("Update gateway parameters from config distribute",d,l)))})}catch(c){_.error("Error update config immediately: ".concat(a),c.message)}}(i);const s=JSON.stringify(i),o=window.btoa(s);window.localStorage.setItem("websdk_ng_global_parameter",o),_.debug("Caching global parameters ".concat(s))}catch(r){_.error("Error caching global parameters:",r.message)}}handleGlobalParameterConfig(e){try{const i=Date.now();Object.keys(e).forEach(n=>{if(n==="CLIENT_ROLE_OPTIONS"&&Object.prototype.hasOwnProperty.call(zt,n)){const{value:r,expires:s}=e[n];if(s&&s<=i)return;(function(o,a){try{return typeof o=="object"&&typeof a=="object"&&JSON.stringify(o)===JSON.stringify(a)}catch{return!1}})(zt[n],r)||(xn[n]=r,zt[n]=r,this.emit(Ic.UPDATE_CLIENT_ROLE_OPTIONS,r),_.debug("Updating client role options: ".concat(JSON.stringify(r))))}})}catch(i){_.error("Error handling global parameter config:",i.message)}}}class RW extends qt{constructor(){super(...arguments),g(this,"resultStorage",new Map)}setLocalAudioStats(e,i,n){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(n,i)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(n,i))}setLocalVideoStats(e,i,n){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(n,i)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(n,i)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(n))}setRemoteAudioStats(e,i){const n=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",n,this.checkAudioOutputLevel(i))}setRemoteVideoStats(e,i){const n=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",n,this.checkVideoDecode(i))}record(e,i,n){if(C("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const r=this.resultStorage.get(e);if(r&&(r.result.push(n),r.result.length>=5)){var s;const o=B(s=r.result).call(s,!0);r.isPrevNormal&&!o&&this.emit("exception",gw[e],e,i),!r.isPrevNormal&&o&&this.emit("exception",gw[e]+2e3,e+"_RECOVER",i),r.isPrevNormal=o,r.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&e.receiveLevel===0)}checkAudioInputLevel(e,i){return i instanceof Re&&!i.isActive||!!i.muted||e.sendVolumeLevel!==0}checkFramerateInput(e,i){let n=null;i._encoderConfig&&i._encoderConfig.frameRate&&(n=Di(i._encoderConfig.frameRate));const r=e.captureFrameRate;return!n||!r||!(n>10&&r<5||n<10&&n>=5&&r<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,i){return!!i.muted||e.sendBitrate!==0}checkSendAudioBitrate(e,i){return i instanceof Re&&!i.isActive||!!i.muted||e.sendBitrate!==0}checkVideoDecode(e){return e.receiveBitrate===0||e.decodeFrameRate!==0}}const gw={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},qe=new class{markSubscribeStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/subscribe-").concat(e))}markPublishStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/publish-").concat(e))}measureFromSubscribeStart(t,e){const i=performance.getEntriesByName("agora-web-sdk/".concat(t,"/subscribe-").concat(e));if(i.length>0){const n=i[i.length-1];return Math.round(performance.now()-n.startTime)}return 0}measureFromPublishStart(t,e){const i=performance.getEntriesByName("agora-web-sdk/".concat(t,"/publish-").concat(e));if(i.length>0){const n=i[i.length-1];return Math.round(performance.now()-n.startTime)}return 0}};function Tw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Ks(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Tw(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Tw(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class Pc{constructor(e){g(this,"store",void 0),g(this,"onStatsException",void 0),g(this,"onUploadPublishDuration",void 0),g(this,"onStatsChanged",void 0),g(this,"localStats",new Map),g(this,"remoteStats",new Map),g(this,"updateStatsInterval",void 0),g(this,"trafficStats",void 0),g(this,"trafficStatsPeerList",[]),g(this,"uplinkStats",void 0),g(this,"exceptionMonitor",void 0),g(this,"p2pChannel",void 0),g(this,"scalabilityMode",Yl.L1T1),g(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=e,this.exceptionMonitor=new RW,this.exceptionMonitor.on("exception",(i,n,r)=>{this.onStatsException&&this.onStatsException(i,n,r)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(U.LocalAudioTrack)||Ks({},PE)}getLocalVideoTrackStats(){return this.localStats.get(U.LocalVideoTrack)||Ks({},LE)}getRemoteAudioTrackStats(e){const i=(s,o)=>{if(!this.trafficStats)return o;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===s);return a&&(o.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),o},n={};if(e){var r;const s=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.audioStats;s&&(n[e]=i(e,s))}else Array.from(this.remoteStats.entries()).forEach(s=>{let[o,{audioStats:a}]=s;a&&(n[o]=i(o,a))});return n}getRemoteNetworkQualityStats(e){const i={};if(e){var n;const r=(n=this.remoteStats.get(e))===null||n===void 0?void 0:n.networkStats;r&&(i[e]=r)}else Array.from(this.remoteStats.entries()).forEach(r=>{let[s,{networkStats:o}]=r;o&&(i[s]=o)});return i}getRemoteVideoTrackStats(e){const i=(s,o)=>{if(!this.trafficStats)return o;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===s);return a&&(o.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),o},n={};if(e){var r;const s=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.videoStats;s&&(n[e]=i(e,s))}else Array.from(this.remoteStats.entries()).forEach(s=>{let[o,{videoStats:a}]=s;a&&(n[o]=i(o,a))});return n}getRTCStats(){let e=0,i=0,n=0,r=0;const s=this.localStats.get(U.LocalAudioTrack);s&&(e+=s.sendBytes,i+=s.sendBitrate);const o=this.localStats.get(U.LocalVideoTrack);o&&(e+=o.sendBytes,i+=o.sendBitrate);const a=this.localStats.get(U.LocalVideoLowTrack);a&&(e+=a.sendBytes,i+=a.sendBitrate),this.remoteStats.forEach(d=>{let{audioStats:l,videoStats:u}=d;l&&(n+=l.receiveBytes,r+=l.receiveBitrate),u&&(n+=u.receiveBytes,r+=u.receiveBitrate)});let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:i,SendBytes:e,RecvBytes:n,RecvBitrate:r,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter(i=>i.B_ppad!==void 0||i.B_ppvd!==void 0),e.peer_delay.filter(i=>this.trafficStatsPeerList.indexOf(i.peer_uid)===-1).forEach(i=>{var n;const r=(n=this.p2pChannel)===null||n===void 0?void 0:n.getRemoteMedia(i.peer_uid),s=r!=null&&r.videoSSRC?qe.measureFromSubscribeStart(this.store.clientId,r.videoSSRC):0,o=r!=null&&r.audioSSRC?qe.measureFromSubscribeStart(this.store.clientId,r.audioSSRC):0;i.B_ppad!==void 0&&i.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(i.peer_uid,i.B_ppad,i.B_ppvd,s>o?s:o),this.trafficStatsPeerList.push(i.peer_uid))}),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&_.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,i,n){if(!e)return!1;const r=!!n&&i.framesDecodeFreezeTime>n.framesDecodeFreezeTime,s=!n||i.framesDecodeCount>n.framesDecodeCount;return r||!s}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach(i=>{let[n,r]=i;switch(n){case U.LocalVideoTrack:case U.LocalVideoLowTrack:{const o=r,a=Ks({},LE),c=e.getStats(),d=e.getLocalMedia(n);if(c){const l=c.videoSend.find(u=>u.ssrc===(d==null?void 0:d.ssrcs[0].ssrcId));if(l){const u=e.getLocalVideoSize(),h=e.getEncoderConfig(U.LocalVideoTrack);l.codec!=="H264"&&l.codec!=="H265"&&l.codec!=="VP8"&&l.codec!=="VP9"&&l.codec!=="AV1X"&&l.codec!=="AV1"||(a.codecType=l.codec),a.sendBytes=l.bytes,a.sendBitrate=o?8*Math.max(0,a.sendBytes-o.sendBytes):0,l.inputFrame?(a.captureFrameRate=l.inputFrame.frameRate,a.captureResolutionHeight=l.inputFrame.height,a.captureResolutionWidth=l.inputFrame.width):u&&(a.captureResolutionWidth=u.width,a.captureResolutionHeight=u.height),l.sentFrame?(a.sendFrameRate=l.sentFrame.frameRate,a.sendResolutionHeight=l.sentFrame.height,a.sendResolutionWidth=l.sentFrame.width):u&&(a.sendResolutionWidth=u.width,a.sendResolutionHeight=u.height),l.avgEncodeMs&&(a.encodeDelay=l.avgEncodeMs),h&&h.bitrateMax&&(a.targetSendBitrate=1e3*h.bitrateMax),a.sendPackets=l.packets,a.sendPacketsLost=l.packetsLost,a.sendJitterMs=l.jitterMs,a.sendRttMs=l.rttMs,a.totalDuration=o?o.totalDuration+1:1,a.totalFreezeTime=o?o.totalFreezeTime:0,this.isLocalVideoFreeze(l)&&(a.totalFreezeTime+=1),l.scalabilityMode&&this.scalabilityMode!==l.scalabilityMode&&(_.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(l.scalabilityMode)),this.scalabilityMode=l.scalabilityMode)}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var s;this.localStats.set(n,a),((o==null?void 0:o.sendResolutionWidth)!==a.sendResolutionWidth||(o==null?void 0:o.sendResolutionHeight)!==a.sendResolutionHeight)&&((s=this.onStatsChanged)===null||s===void 0||s.call(this,"resolution",{width:a.sendResolutionWidth,height:a.sendResolutionHeight})),a&&d&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,d.track,a);break}case U.LocalAudioTrack:{const o=r,a=Ks({},PE),c=e.getStats(),d=e.getLocalMedia(n);if(c){const l=c.audioSend.find(u=>u.ssrc===(d==null?void 0:d.ssrcs[0].ssrcId));if(l){if(l.codec!=="opus"&&l.codec!=="aac"&&l.codec!=="PCMU"&&l.codec!=="PCMA"&&l.codec!=="G722"||(a.codecType=l.codec),l.inputLevel)a.sendVolumeLevel=Math.round(32767*l.inputLevel);else{const u=e.getLocalAudioVolume();u&&(a.sendVolumeLevel=Math.round(32767*u))}a.sendBytes=l.bytes,a.sendPackets=l.packets,a.sendPacketsLost=l.packetsLost,a.sendJitterMs=l.jitterMs,a.sendRttMs=l.rttMs,a.sendBitrate=o?8*Math.max(0,a.sendBytes-o.sendBytes):0}}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(U.LocalAudioTrack,a),a&&d&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,d.track,a);break}}})}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach(i=>{var n,r;let[s,{videoStats:o,audioStats:a,videoPcStats:c}]=i;const d=a,l=o,u=c,h=Ks({},fy),p=Ks({},gy),T=Ks({},n3),{audioTrack:m,videoTrack:f,audioSSRC:R,videoSSRC:v}=e.getRemoteMedia(s);let A;A=this.store.useP2P?e.getStats(!0):e.getStats();const O=(n=A)===null||n===void 0?void 0:n.audioRecv.find(x=>x.ssrc===R),w=(r=A)===null||r===void 0?void 0:r.videoRecv.find(x=>x.ssrc===v),b=this.trafficStats&&this.trafficStats.peer_delay.find(x=>x.peer_uid===s);if(O&&(O.codec!=="opus"&&O.codec!=="aac"&&O.codec!=="PCMU"&&O.codec!=="PCMA"&&O.codec!=="G722"||(h.codecType=O.codec),O.outputLevel?h.receiveLevel=Math.round(32767*O.outputLevel):m&&(h.receiveLevel=Math.round(32767*m.getVolumeLevel())),h.receiveBytes=O.bytes,h.receivePackets=O.packets,h.receivePacketsLost=O.packetsLost,h.receivePacketsDiscarded=O.packetsDiscarded,h.packetLossRate=h.receivePacketsLost/(h.receivePackets+h.receivePacketsLost),h.receiveBitrate=d?8*Math.max(0,h.receiveBytes-d.receiveBytes):0,h.totalDuration=d?d.totalDuration+1:1,h.totalFreezeTime=d?d.totalFreezeTime:0,h.freezeRate=h.totalFreezeTime/h.totalDuration,h.receiveDelay=O.jitterBufferMs,h.totalDuration>10&&Pc.isRemoteAudioFreeze(m)&&(h.totalFreezeTime+=1)),w){var L;w.codec!=="H264"&&w.codec!=="H265"&&w.codec!=="VP8"&&w.codec!=="VP9"&&w.codec!=="AV1X"&&w.codec!=="AV1"||(p.codecType=w.codec),p.receiveBytes=w.bytes,p.receiveBitrate=l?8*Math.max(0,p.receiveBytes-l.receiveBytes):0,p.decodeFrameRate=w.decodeFrameRate<0?0:w.decodeFrameRate,p.renderFrameRate=w.decodeFrameRate<0?0:w.decodeFrameRate,w.outputFrame&&(p.renderFrameRate=w.outputFrame.frameRate),w.receivedFrame?(p.receiveFrameRate=w.receivedFrame.frameRate,p.receiveResolutionHeight=w.receivedFrame.height,p.receiveResolutionWidth=w.receivedFrame.width):f&&(p.receiveResolutionHeight=f._videoHeight||0,p.receiveResolutionWidth=f._videoWidth||0),w.framesRateFirefox!==void 0&&(p.receiveFrameRate=Math.round(w.framesRateFirefox)),p.receivePackets=w.packets,p.receivePacketsLost=w.packetsLost,p.packetLossRate=p.receivePacketsLost/(p.receivePackets+p.receivePacketsLost);const x=l?l.totalFreezeTime:0,W=l?l.totalDuration:0;p.totalDuration=l?l.totalDuration+1:1,p.totalFreezeTime=(L=w.totalFreezesDuration)!==null&&L!==void 0?L:x||0,p.receiveDelay=w.jitterBufferMs||0;const K=!!v&&e.getRemoteVideoIsReady(v);w.totalFreezesDuration===void 0&&f&&K&&Pc.isRemoteVideoFreeze(f,w,u)&&(p.totalFreezeTime+=1),p.freezeRate=Math.max(0,Math.min((p.totalFreezeTime-x)/(p.totalDuration-W),1))}b&&(h.end2EndDelay=b.B_ad,p.end2EndDelay=b.B_vd,h.transportDelay=b.B_ed,p.transportDelay=b.B_ed,h.currentPacketLossRate=b.B_ealr4/100,p.currentPacketLossRate=b.B_evlr4/100,T.uplinkNetworkQuality=b.B_punq?b.B_punq:0,T.downlinkNetworkQuality=b.B_pdnq?b.B_pdnq:0),this.remoteStats.set(s,{audioStats:h,videoStats:p,videoPcStats:w,networkStats:T}),m&&this.exceptionMonitor.setRemoteAudioStats(m,h),f&&this.exceptionMonitor.setRemoteVideoStats(f,p)})}}class Sw{constructor(){g(this,"destChannelMediaInfos",new Map),g(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){Ab(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){Ab(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){hu(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function Rw(t){if(!(t instanceof Sw))return new D(S.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const e=t.getSrcChannelMediaInfo(),i=t.getDestChannelMediaInfo();if(!e)return new D(S.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(i.size===0)return new D(S.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class rs{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,i){g(this,"uid",void 0),g(this,"_uintid",void 0),g(this,"_trust_in_room_",!0),g(this,"_trust_audio_enabled_state_",!0),g(this,"_trust_video_enabled_state_",!0),g(this,"_trust_audio_mute_state_",!0),g(this,"_trust_video_mute_state_",!0),g(this,"_audio_muted_",!1),g(this,"_video_muted_",!1),g(this,"_audio_enabled_",!0),g(this,"_video_enabled_",!0),g(this,"_audio_added_",!1),g(this,"_video_added_",!1),g(this,"_is_pre_created",!1),g(this,"_video_pre_subscribed",!1),g(this,"_audio_pre_subscribed",!1),g(this,"_trust_video_stream_added_state_",!0),g(this,"_trust_audio_stream_added_state_",!0),g(this,"_audioTrack",void 0),g(this,"_videoTrack",void 0),g(this,"_dataChannels",[]),g(this,"_audioSSRC",void 0),g(this,"_videoSSRC",void 0),g(this,"_audioOrtc",void 0),g(this,"_videoOrtc",void 0),g(this,"_cname",void 0),g(this,"_rtxSsrcId",void 0),g(this,"_videoMid",void 0),g(this,"_audioMid",void 0),this.uid=e,this._uintid=i}}function vw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Cw(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?vw(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):vw(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}const Lc="9",Iw=4e4;let vW=class{get localCapabilities(){return ee(this._localCapabilities)}get rtpCapabilities(){return ee(this._rtpCapabilities)}get candidates(){return ee(this._candidates)}get iceParameters(){return ee(this._iceParameters)}get dtlsParameters(){return ee(this._dtlsParameters)}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];g(this,"sessionDesc",void 0),g(this,"_localCapabilities",void 0),g(this,"_rtpCapabilities",void 0),g(this,"_candidates",void 0),g(this,"_originCandidates",void 0),g(this,"_iceParameters",void 0),g(this,"_isUseExtmapAllowMixed",void 0),g(this,"_dtlsParameters",void 0),g(this,"setup",void 0),g(this,"currentMidIndex",void 0),g(this,"cname",void 0),g(this,"firefoxSsrcMidMap",new Map),this._isUseExtmapAllowMixed=e,t=ee(t);const{iceParameters:i,dtlsParameters:n,candidates:r,rtpCapabilities:s,setup:o,localCapabilities:a,cname:c}=t;this._rtpCapabilities=s,this._candidates=r,this._originCandidates=ee(r),this._iceParameters=i,this._dtlsParameters=n,this._localCapabilities=a,this.setup=o,this.cname=c,this.sessionDesc=this.updateRemoteRTPCapabilities(s),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}preloadRemoteMedia(t){const e=this.candidates,i=this.dtlsParameters,n=this.iceParameters,r=this.rtpCapabilities.send;let s=this.sessionDesc.mediaDescriptions.length-1;for(let o=1;o<t;o++){const a=2*o+2e4,c=2*o+Iw,{ssrcs:d,ssrcGroups:l}=Ws([{ssrcId:a}],this.cname),{ssrcs:u,ssrcGroups:h}=Ws([{ssrcId:c,rtx:C("USE_SUB_RTX")?c+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Lc,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.videoCodecs.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:e,extmaps:r.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:u,ssrcGroups:h,rtcpFeedbackWildcards:[],payloads:r.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++s)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Lc,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.audioCodecs.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:e,extmaps:r.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:r.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++s)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Zr(this.sessionDesc)}send(t,e,i,n){const{ssrcs:r,ssrcGroups:s}=Ws(e,this.cname,C("SYNC_GROUP")?i:void 0),o=this.findPreloadMediaDesc(r);if(o){if(te()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,o.attributes.mid),n&&(n.twcc||n.remb)){const a=this.sessionDesc.mediaDescriptions.indexOf(o);return this.sessionDesc.mediaDescriptions[a]=this.mungSendMediaDesc(o,n),{mid:o.attributes.mid,needExchangeSDP:!0}}return{mid:o.attributes.mid,needExchangeSDP:!1}}{const a=this.findAvailableMediaIndex(t,r);let c;return a===-1||a===1&&(Ve()||function(){const d=Tt();return!(d.name!==Ct.CHROME||!d.osVersion)&&Number(d.version)<=90}()||C("ENABLE_ENCODED_TRANSFORM")&&Rr())||a===0&&C("USE_SUB_RTX")||PI()?(c=this.createOrRecycleSendMedia(t,r,s,"sendonly",n),this.updateBundleMids()):(c=ee(this.sessionDesc.mediaDescriptions[a]),c.attributes.direction="sendonly",c.attributes.ssrcs=r,c.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[a]=this.mungSendMediaDesc(c,n)),te()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,c.attributes.mid),{mid:c.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:t,needExchangeSDP:e}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:t.attributes.mid,needExchangeSDP:e}}batchSend(t){const e=t.map(r=>{let{kind:s,ssrcMsg:o,mslabel:a}=r;return this.send(s,o,a)}),i=[];let n=!1;return e.forEach(r=>{let{mid:s,needExchangeSDP:o}=r;o&&(n=!0),i.push(s)}),{mids:i,needExchangeSDP:n}}stopSending(t){const e=this.sessionDesc.mediaDescriptions.filter(i=>i.attributes.mid&&t.indexOf(i.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(i=>{i.attributes.mid==="0"||te()||PI()?i.attributes.ssrcs=[]:(i.attributes.ssrcs=[],i.attributes.direction="inactive",i.media.port="0")}),this.updateBundleMids()}mute(t){const e=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===t);if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));e.attributes.direction="inactive"}unmute(t){const e=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===t);if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));e.attributes.direction="sendonly"}muteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(i=>B(t).call(t,i.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(i=>{i.attributes.direction="inactive"})}unmuteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(i=>B(t).call(t,i.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(i=>{i.attributes.direction="recvonly"})}receive(t,e,i,n){t.forEach((r,s)=>{this.createOrRecycleRecvMedia(r,[],"recvonly",e,i,n[s])}),this.updateBundleMids()}stopReceiving(t){const e=this.sessionDesc.mediaDescriptions.filter(i=>t.indexOf(i.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(i=>{i.media.port="0",i.attributes.direction="inactive"}),this.updateBundleMids()}updateRemoteRTPCapabilities(t){const e=this.sessionDesc||Ti((i=this._isUseExtmapAllowMixed,`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite`.concat(i?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`)));var i;this._rtpCapabilities=t;const n=this.rtpCapabilities.send,r=this.localCapabilities.send;for(const s of e.mediaDescriptions){if(s.attributes.iceUfrag=this._iceParameters.iceUfrag,s.attributes.icePwd=this._iceParameters.icePwd,s.attributes.fingerprints=this._dtlsParameters.fingerprints,s.attributes.candidates=this._candidates,s.attributes.setup=this.setup,s.media.mediaType==="application"&&(s.attributes.sctpPort="5000"),s.media.mediaType==="video"){if(n.videoCodecs.length===0){const o=r.videoCodecs.filter(a=>{var c,d;return(c=a.rtpMap)===null||c===void 0?void 0:B(d=c.encodingName.toLowerCase()).call(d,"vp8")})||[r.videoCodecs[0]];s.media.fmts=o.map(a=>a.payloadType.toString(10)),s.attributes.payloads=o,s.attributes.extmaps=[]}else if(s.media.fmts=n.videoCodecs.map(o=>o.payloadType.toString(10)),s.attributes.payloads=n.videoCodecs,s.attributes.extmaps=n.videoExtensions,C("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:o,ssrcGroups:a}=Ws([{ssrcId:Iw,rtx:C("USE_SUB_RTX")?40001:void 0}],this.cname);s.attributes.ssrcs=o,s.attributes.ssrcGroups=a}}if(s.media.mediaType==="audio"){if(n.audioCodecs.length===0){const o=r.audioCodecs.filter(a=>{var c,d;return(c=a.rtpMap)===null||c===void 0?void 0:B(d=c.encodingName.toLowerCase()).call(d,"opus")})||[r.audioCodecs[0]];s.media.fmts=o.map(a=>a.payloadType.toString(10)),s.attributes.payloads=o,s.attributes.extmaps=[]}else if(s.media.fmts=n.audioCodecs.map(o=>o.payloadType.toString(10)),s.attributes.payloads=n.audioCodecs,s.attributes.extmaps=n.audioExtensions,ha(s),C("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:o,ssrcGroups:a}=Ws([{ssrcId:2e4}],this.cname);s.attributes.ssrcs=o,s.attributes.ssrcGroups=a}}}return this.sessionDesc=e,this.currentMidIndex=e.mediaDescriptions.length-1,this.sessionDesc}updateCandidates(t){const e=this._originCandidates.filter(n=>n.transport==="udp"),i=[];if(e.forEach(n=>{i.push(Cw(Cw({},n),{},{foundation:"tcpcandidate",priority:Number(n.priority)-1+"",transport:"tcp",port:Number(n.port)+90+""}))}),e.length!==0){switch(t){case Je.TCP_RELAY:this._candidates=i;break;case Je.UDP_TCP_RELAY:case Je.RELAY:this._candidates=[...e,...i];break;default:this._candidates=e}for(const n of this.sessionDesc.mediaDescriptions)n.attributes.candidates=this.candidates}}restartICE(t){t=ee(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd})}predictReceivingMids(t){const e=[];for(let i=0;i<t;i++)e.push((this.currentMidIndex+i+1).toString(10));return e}findAvailableMediaIndex(t,e){return this.sessionDesc.mediaDescriptions.findIndex(i=>{const n=i.media.mediaType===t&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(te()){if(n){const r=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(r||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!r||r!==i.attributes.mid)}return!1}return n})}createOrRecycleDataChannel(){for(const i of this.sessionDesc.mediaDescriptions)if(i.media.mediaType==="application")return{mediaDesc:i,needExchangeSDP:!1};this.currentMidIndex+=1;const t="".concat(this.currentMidIndex),e={media:{mediaType:"application",port:Lc,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(t),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(e),{mediaDesc:e,needExchangeSDP:!0}}createOrRecycleRecvMedia(t,e,i,n,r,s){const o=t._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=Oc(o,a,this.localCapabilities.send,o===q.VIDEO?n:r),d=o===q.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let u={media:{mediaType:o,port:Lc,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};u=this.mungRecvMediaDsec(u,t,s);const h=this.findFirstClosedMedia(o);if(h){const p=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[p]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}updateRemoteCodec(t,e,i){const n=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(u=>u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"").filter(u=>{var h;return B(h=Object.keys(zl)).call(h,u)}))],r=new Set(e);if(n.every(u=>r.has(u)))return _.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(e)),!1;const s=this._rtpCapabilities.recv.videoCodecs.filter(u=>e.some(h=>{var p;return B(p=u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"").call(p,h)}));if(s.length===0)return _.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(n," codecs: ").concat(e)),!1;const o=[...new Set(s.map(u=>u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||""))];let a;if(_.debug("updateRemoteCodec, from ".concat(n," to ").concat(o)),t.length===0)a=this.sessionDesc.mediaDescriptions.filter(u=>u.media.mediaType==="video"&&u.attributes.direction==="recvonly");else if(a=this.sessionDesc.mediaDescriptions.filter(u=>u.attributes.mid&&B(t).call(t,u.attributes.mid)&&u.attributes.direction==="recvonly"),a.length!==t.length)return _.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(t,", codecs: ").concat(e)),!1;if(C("USE_PUB_RTX")||C("USE_SUB_RTX")){const u=dm(s,this.rtpCapabilities.recv.videoCodecs);s.push(...u)}this._rtpCapabilities.recv.videoCodecs=s;const c=this.localCapabilities.send,d=this.rtpCapabilities.recv,l=Oc(q.VIDEO,d,c,i);return a.forEach(u=>{const h=l.map(p=>p.payloadType.toString(10));_.debug("updateRemoteCodec mid: ".concat(u.attributes.mid,", from"),u.attributes.payloads,"to",l),u.attributes.payloads=l,u.media.fmts=h}),!0}createOrRecycleSendMedia(t,e,i,n,r){const s=this.rtpCapabilities.send,o=t===q.VIDEO?s.videoCodecs:s.audioCodecs,a=t===q.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:t,port:Lc,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.map(u=>u.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:o,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,r);const l=this.findFirstClosedMedia(t);if(l){const u=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[u]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid)}mungRecvMediaDsec(t,e,i){const n=ee(t);return am(n),ua(n,e),cm(n,e),zb(n),Su(n,i,this.localCapabilities.send),n}mungSendMediaDesc(t,e){const i=ee(t);return Su(i,e,this.localCapabilities.recv),ha(i),i}updateRecvMedia(t,e){const i=this.sessionDesc.mediaDescriptions.findIndex(n=>n.attributes.mid===t);if(i!==-1){const n=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],e);this.sessionDesc.mediaDescriptions[i]=n}}bumpMid(t){this.currentMidIndex+=t}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(e=>te()?e.media.port==="0"&&e.media.mediaType===t:e.media.port==="0")}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(e=>{var i;return((i=e.attributes)===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId)===t[0].ssrcId})}getSSRC(t){var e;return(e=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===t))===null||e===void 0?void 0:e.attributes.ssrcs}};function yw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Nr(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?yw(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):yw(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}var Ea=function(t){return t[t.DOWN=0]="DOWN",t[t.UP=1]="UP",t}(Ea||{});const Au=new Map;function Aw(t,e,i,n){let{scale:r}=t;if(r===0&&n===Ea.UP||r>=e.length-1&&n===Ea.DOWN)return t;let s=Nr(Nr({},t),{},{scale:n===Ea.DOWN?++r:--r});switch(i){case"maintain-framerate":s=Nr(Nr({},s),e[r].motion);break;case"maintain-resolution":s=Nr(Nr({},s),e[r].detail);break;case"balanced":s=Nr(Nr({},s),e[r].balanced)}return s}function bw(t,e){if(e){const i={overUse:0,underUse:0,adaptationList:ww(e)};Au.set(t,i)}else Au.delete(t)}function ww(t){const e=Nr({},t),{bitrateMax:i,frameRate:n,scaleResolutionDownBy:r,bitrateMin:s}=e,{MIN_FRAME_RATE:o,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:l,BWE_SCALE_UP_THRESHOLD:u,BWE_SCALE_DOWN_THRESHOLD:h,PERF_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_UP_THRESHOLD:T,BALANCE_BITRATE_FACTOR:m,BALANCE_FRAMERATE_FACTOR:f,BALANCE_RESOLUTION_FACTOR:R,MOTION_RESOLUTION_FACTOR:v,MOTION_BITRATE_FACTOR:A,DETAIL_FRAMERATE_FACTOR:O,DETAIL_BITRATE_FACTOR:w}=yE,b=Math.min(e.frameRate,a),L=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(h,1)*i),bwe_up:i,fps_down:Math.round(Math.pow(p,1)*b),fps_up:n},balanced:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:i,bitrateMin:s},motion:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:i,bitrateMin:s},detail:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:i,bitrateMin:s}}];for(let x=1;x<=c;x++){const W={bwe_up:Math.round(Math.pow(u,x)*i),bwe_down:Math.round(Math.pow(h,x+1)*i),fps_up:Math.round(Math.pow(T,x)*b),fps_down:Math.round(Math.pow(p,x+1)*b)},K={scaleResolutionDownBy:r/Math.pow(R,x),frameRate:Math.max(Math.round(Math.pow(f,x)*n),o),bitrateMax:Math.max(Math.round(Math.pow(m,x)*i),l),bitrateMin:Math.max(Math.round(Math.pow(m,x)*s),d)},ht={scaleResolutionDownBy:r/Math.pow(v,x),frameRate:n,bitrateMax:Math.max(Math.round(Math.pow(A,x)*i),l),bitrateMin:Math.max(Math.round(Math.pow(A,x)*s),d)},pt={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(O,x)*n),o),bitrateMax:Math.max(Math.round(Math.pow(w,x)*i),l),bitrateMin:Math.max(Math.round(Math.pow(w,x)*s),d)};L.push({scale:x,threshold:W,balanced:K,motion:ht,detail:pt})}return L}function CW(t,e,i,n,r,s){const o=Au.get(t)||{overUse:0,underUse:0,adaptationList:ww(r)},{adaptationList:a}=o;Au.set(t,o);const{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:d}=yE,{scale:l}=n;let u,h;return typeof e=="number"&&e>0&&function(p,T,m,f){if(T>=m.length)return!1;let{threshold:{fps_down:R}}=m[T];return C("FORCE_AG_HIGH_FRAMERATE")&&f==="maintain-framerate"&&(R=m[0].threshold.fps_down),p<R}(e,l,a,s)&&(o.overUse++,h=gc.CPU,o.overUse>c)||typeof i=="number"&&i>0&&function(p,T,m){if(T>=m.length)return!1;const{threshold:{bwe_down:f}}=m[T];return p<f}(i,l,a)&&(o.overUse++,h=gc.BANDWIDTH,o.overUse>c)?(o.overUse=0,o.underUse=0,u=Aw(n,a,s,Ea.DOWN),[u,h]):(typeof e=="number"&&e>0&&typeof i=="number"&&i>0&&function(p,T,m,f){if(T===0)return;let{threshold:{fps_up:R}}=m[T];return C("FORCE_AG_HIGH_FRAMERATE")&&f==="maintain-framerate"&&(R=m[1].threshold.fps_up),p>R}(e,l,a,s)&&function(p,T,m){if(T===0)return;const{threshold:{bwe_up:f}}=m[T];return p>f}(i,l,a)&&(o.underUse++,o.underUse>d&&(o.overUse=0,o.underUse=0,u=Aw(n,a,s,Ea.UP),u.scale===0&&(h=gc.NONE))),[u,h])}function Ow(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Sm(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Ow(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Ow(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function IW(t){var e;return!!C("ENABLE_AG_ADAPTATION")&&!!(t instanceof GE||B(e=t._hints).call(e,xt.CUSTOM_TRACK))&&(!!C("FORCE_SUPPORT_AG_ADAPTATION")||!!(function(i){const n=Tt();if(n.os!==Ie.IOS||!n.osVersion)return!1;const r=n.osVersion.split(".");return Number(r[0])>=i}(14)&&NI(17,4)||OI(14)&&DI(17,4)))}const bu=new Map;function wu(t,e){const i=bu.get(t);if(i){const{timer:n}=i;window.clearTimeout(n),bu.delete(t)}e.qualityLimitationReason=gc.NONE,bw(t)}function yW(t,e){var i;let n;switch(e){case U.LocalAudioTrack:n=At.Audio;break;case U.LocalVideoTrack:n=B(i=t._hints).call(i,xt.SCREEN_TRACK)?At.Screen:At.High;break;case U.LocalVideoLowTrack:n=At.Low}return n}function Rm(t){const e=St();if(t.some(i=>i._bypassWebAudio))throw new P(S.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!e.webAudioMediaStreamDest)throw new P(S.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function vm(t,e){Rm(t);const i=new Re;return t.forEach(n=>i.addAudioTrack(n)),i}const AW=!St().supportUnifiedPlan||C("CHROME_FORCE_PLAN_B")&&vr();function Ou(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;return AW?(i={spec:e,store:t},ns("PlanBConnection").create(i)):new Dr(e,t)}function Cm(t){return t&&(t.iceConnectionState==="disconnected"||t.iceConnectionState==="checking"||t.iceConnectionState==="failed")}function Nw(t){try{if(t.iceServers)return!1;if(t.turnServer&&t.turnServer.mode!=="off"){if(Ec(t.turnServer.servers))return!1;if(C("FORCE_TURN_TCP")||t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).some(e=>e.forceturn))return!0}return!1}catch{return!1}}var Et;function Dw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Gn(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Dw(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Dw(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let Dr=(Et=class nd extends Nb{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,i;return(e=(i=this.peerConnection.getReceivers()[0])===null||i===void 0||(i=i.transport)===null||i===void 0?void 0:i.state)!==null&&e!==void 0?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var i;return B(i=Object.keys(zl)).call(i,e)}))]}constructor(e,i){super(e,i),g(this,"id",Ut(5,"connection-")),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"forceTurn",!1),g(this,"remoteSDP",void 0),g(this,"initialOffer",void 0),g(this,"transportEventReceiver",void 0),g(this,"statsFilter",void 0),g(this,"extension",{useXR:C("USE_XR")}),g(this,"localCapabilities",void 0),g(this,"remoteCodecs",void 0),g(this,"localCandidateCount",0),g(this,"allCandidatesReceived",!1),g(this,"isPreallocation",!1),g(this,"preSSRCMap",new Map),g(this,"dataStreamChannelMap",new Map),g(this,"establishPromise",void 0),g(this,"recoveredDataChannelIds",[]),g(this,"currentDataChannelId",1),g(this,"supportAV1RtpSpec",!1),g(this,"mutex",void 0),g(this,"qualityLimitationReason",gc.NONE),this.store=i,this.forceTurn=Nw(e),this.mutex=new Ke("P2PConnection-mutex",i.clientId),this.peerConnection=new RTCPeerConnection(nd.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=vE(this.peerConnection,C("STATS_UPDATE_INTERVAL"),void 0,te()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}getPreMedia(e){const i=this.preSSRCMap.get(e);if(i!==void 0){const n=this.peerConnection.getTransceivers().find(r=>r.mid===i);if(n)return{transceiver:n,track:n.receiver.track,id:i}}}async updateRemoteRTPCapabilities(e,i){if(this.remoteCodecs=i,!this.remoteSDP)return void _.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(e,i,this.store.codec)){const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n);const s=this.remoteSDP.toString();r==null||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}else _.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=is(n.sdp),s=await Xb({filterRTX:!C("USE_PUB_RTX")&&!C("USE_SUB_RTX"),filterVideoFec:C("FILTER_VIDEO_FEC"),filterAudioFec:C("FILTER_AUDIO_FEC"),filterVideoCodec:C("FILTER_VIDEO_CODEC")},this.extension);if(this.localCapabilities=Ru(s),this.initialOffer=n,C("ENABLE_SVC")&&this.store.codec=="av1"){const a=await async function(){try{const c=new RTCPeerConnection;c.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:Yl.L1T3}]});const d=await c.createOffer();if(!d.sdp)return void c.close();const l=Ti(d.sdp).mediaDescriptions[0];if(!l)return;const u=l.attributes.extmaps.find(h=>h.extensionName==="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension");return c.close(),u}catch{return}}();var e;a&&(this.supportAV1RtpSpec=!0,(e=s.send)===null||e===void 0||e.videoExtensions.push(a))}let o;return n.sdp&&tw(n.sdp)&&(o=ee(s),(i=o).send&&(la(q.VIDEO,i.send.videoExtensions),la(q.AUDIO,i.send.audioExtensions)),i.recv&&(la(q.VIDEO,i.recv.videoExtensions),la(q.AUDIO,i.recv.audioExtensions)),i.sendrecv&&(la(q.VIDEO,i.sendrecv.videoExtensions),la(q.AUDIO,i.sendrecv.audioExtensions))),Gn(Gn({},r),{},{rtpCapabilities:o||s,offerSDP:n.sdp})}catch(n){throw new P(S.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}var i}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&tw(this.initialOffer.sdp)&&(i=e.rtpCapabilities,n=this.localCapabilities,i.send&&(gu(q.VIDEO,i.send.videoExtensions,n.send.videoExtensions),gu(q.AUDIO,i.send.audioExtensions,n.send.audioExtensions)),i.recv&&(gu(q.VIDEO,i.recv.videoExtensions,n.recv.videoExtensions),gu(q.AUDIO,i.recv.audioExtensions,n.recv.audioExtensions))),this.remoteSDP=new vW(Gn(Gn({},e),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec),e.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const r=this.remoteSDP.toString(),s=Zb(this.initialOffer.sdp,this.extension),o=this.logSDPExchange(s||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:s}),o==null||o(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r});const a=this.peerConnection.getTransceivers()[0];if(a!=null&&a.receiver&&this.tryBindTransportEvents(a.receiver),C("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia(C("PRELOAD_MEDIA_COUNT"));const d=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:d});const l=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(l)}const{preSSRCs:c}=e;if(Array.isArray(c)&&c.length>0){const{mids:d}=this.remoteSDP.batchSend(c.map(l=>({kind:l.kind,ssrcMsg:[{ssrcId:l.ssrcId,rtx:l.rtx}],mslabel:l.mslabel})));d.forEach((l,u)=>{this.preSSRCMap.set(c[u].ssrcId,l)}),await vu(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [P2PConnection] pre-batchReceive exchange SDP."))}}catch(r){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(r.toString()))}var i,n}async updateRemoteConnect(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");const{rtpCapabilities:i}=e;this.remoteSDP.updateRemoteRTPCapabilities(i),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const{preSSRCs:n}=e;if(Array.isArray(n)&&n.length>0){const{mids:r}=this.remoteSDP.batchSend(n.map(s=>Object.assign({},{kind:s.kind,ssrcMsg:[{ssrcId:s.ssrcId,rtx:s.rtx}],mslabel:s.mslabel})));r.forEach((s,o)=>{this.preSSRCMap.set(n[o].ssrcId,s)})}await vu(this.peerConnection,this.remoteSDP,this.extension),_.debug("[P2PConnection] updateRemoteRTPCapabilities by exchanging SDP.")}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(i.toString()))}}send(e,i,n){var r=this;return Qi(function*(){const s=yield mt(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],a=fu();e.forEach(f=>{const R=r.peerConnection.addTransceiver(f._mediaStreamTrack,Gn({direction:"sendonly"},f.trackMediaType==="video"&&r.supportAV1RtpSpec&&a?{sendEncodings:[{scalabilityMode:a}]}:{}));o.push(R),f._updateRtpTransceiver(R)}),te()&&C("SIMULCAST")===!0&&(yield mt(r.applySimulcastForFirefox(o,e)));const c=yield mt(r.peerConnection.createOffer()),d=r.remoteSDP.predictReceivingMids(e.length),l=r.mungSendOfferSDP(c.sdp,e,d),u=Ti(l),h=d.map(f=>{const R=u.mediaDescriptions.find(v=>v.attributes.mid===f);if(!R)throw new Error("Cannot extract ssrc from mediaDescription.");return Kb(R,C("USE_PUB_RTX"))});let p;try{p=yield h}catch(f){p=[],r.remoteSDP.receive(e,i,n,p);const R=r.remoteSDP.toString();throw yield mt(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield mt(r.peerConnection.setRemoteDescription({type:"answer",sdp:R})),yield mt(r.stopSending(d,!0)),f}r.remoteSDP.receive(e,i,n,p);const T=r.remoteSDP.toString(),m=r.logSDPExchange(l,"offer","local","send");return yield mt(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield mt(r.applySimulcastEncodings(o,e)),yield mt(r.applySendEncodings(o,e)),m==null||m(T),yield mt(r.peerConnection.setRemoteDescription({type:"answer",sdp:T})),o.map((f,R)=>{const v=d[R];return{localSSRC:h[R],id:v,transceiver:f}})}catch(o){throw o instanceof P?o:new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{s()}})()}async createDataChannels(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(e);if(n&&n.readyState==="open")_.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const s=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof s!="number")throw new Error("create DataChannel error, because cannot get dc id");n=this.peerConnection.createDataChannel("datastream-channel",{id:s,negotiated:!0,ordered:!1,maxRetransmits:C("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,n)}i.forEach(s=>{s._updateOriginDataChannel(n)});const{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){const s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),_.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else _.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(n){throw n instanceof P?n:new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(n.toString()))}}async stopDataChannels(e){try{const i=this.dataStreamChannelMap.get(e);return i&&(i.id&&this.recoveredDataChannelIds.push(i.id),i.close()),void this.dataStreamChannelMap.delete(e)}catch(i){throw i instanceof P?i:new P(S.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(i.toString()))}}async stopSending(e,i){const n=i?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map(c=>{var d;wu(this.id+c.mid,this),c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(e);const a=this.remoteSDP.toString();o==null||o(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{n&&n()}}async receive(e,i,n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(e,i,n,r);o&&(await vu(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP.")));const a=this.peerConnection.getTransceivers().find(c=>c.mid===s);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:s,transceiver:a}}catch(s){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:n}=this.remoteSDP.batchSend(e);return n&&(await vu(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),i.map(r=>{const s=this.peerConnection.getTransceivers().find(o=>o.mid===r);if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:r,transceiver:s}})}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");e.forEach(s=>{Array.from(this.preSSRCMap.entries()).some(o=>{let[a,c]=o;if(c===s)return this.preSSRCMap.delete(a),!0})}),this.remoteSDP.stopSending(e);const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(i.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(i.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(o=>o.mid&&e.indexOf(o.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(o=>{o.direction="inactive"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();r==null||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(o=>o.mid&&e.indexOf(o.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async(o,a)=>{o.direction="sendonly"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(e,this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString();r==null||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(e){var i=this;return Qi(function*(){const n=yield mt(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=St().supportPCSetConfiguration,s=C("FORCE_TURN_TCP")||i.forceTurn;if(e===Je.RELAY&&!r)return;if(r&&!s){const u=e===Je.RELAY?"relay":"all",h=i.peerConnection.getConfiguration();h.iceTransportPolicy!==u&&(_.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(h.iceTransportPolicy,"] to [").concat(u,"]")),h.iceTransportPolicy=u,i.peerConnection.setConfiguration(h))}i.remoteSDP.updateCandidates(e);const o=yield mt(i.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const a=is(o.sdp),{remoteIceParameters:c}=yield a.iceParameters;i.remoteSDP.restartICE(c);const d=i.remoteSDP.toString(),l=i.logSDPExchange(o.sdp||"","offer","local","restartICE");i.store.descriptionStart(),yield mt(i.peerConnection.setLocalDescription(o)),l==null||l(d),yield mt(i.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(r){_.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),r)}finally{n()}})()}close(){var e;this.peerConnection.getTransceivers().forEach(i=>{wu(this.id+i.mid,this)}),this.preSSRCMap.clear(),this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return Gn(Gn({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(n.sdp,[i],[e]);this.remoteSDP.updateRecvMedia(e,i);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o==null||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new P(S.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(e,i){const n=this.peerConnection.getTransceivers().filter(r=>r.mid===e);n.length===1&&(this.isVP8Simulcast(i)?te()||await this.applySimulcastEncodings(n,[i]):await this.applySendEncodings(n,[i]))}setStatsRemoteVideoIsReady(e,i){this.statsFilter.setVideoIsReady2(e,i)}async replaceTrack(e,i){const n=this.peerConnection.getTransceivers().find(r=>r.mid===i);n&&await n.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const i=e[0].transport.iceTransport,{local:n,remote:r}=i.getSelectedCandidatePair();return{local:Gn(Gn({},tr),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:Gn(Gn({},tr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=e=>{if(e&&(e.errorCode||e.errorText)){var i;const n="code: ".concat(e.errorCode,", message: ").concat(e.errorText),r=e.port?"local: ".concat(e.port):"";_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(n,"), url: ").concat(e.url||"",", host_candidate:").concat(r)),(i=this.onICECandidateError)===null||i===void 0||i.call(this,n)}},this.peerConnection.onicegatheringstatechange=e=>{e&&e.target&&"iceGatheringState"in e.target&&_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(e.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},C("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const i={iceServers:[]};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Ec(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...nd.turnServerConfigToIceServers(e.turnServer.servers)),C("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...nd.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),C("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(i.iceTransportPolicy="relay")}))),C("ENABLE_ENCODED_TRANSFORM")&&St().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(e){const i=[];return e.forEach(n=>{n.security?n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(da(n.turnServerURL),":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&!C("FORCE_TURN_TCP")&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),i}tryBindTransportEvents(e){const i=e.transport;if(i){this.transportEventReceiver=e,i.onstatechange=()=>{var r;i!=null&&i.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,i.state))},i.onerror=r=>{var s;(s=this.onDTLSTransportError)===null||s===void 0||s.call(this,"error"in r?r.error:r)};const n=i.iceTransport;n&&(n.onstatechange=()=>{const r=i==null?void 0:i.iceTransport.state;var s;r&&((s=this.onICETransportStateChange)===null||s===void 0||s.call(this,r))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:r,remote:s}=n.getSelectedCandidatePair();_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol}),", remote ").concat(JSON.stringify({candidateType:s.type,protocol:s.protocol,address:s.address,port:s.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,i){var n,r;if(i||(i=this.peerConnection.getSenders().find(f=>f.track===e._mediaStreamTrack)),!i)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!St().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;case"balanced":s.degradationPreference="balanced"}const a=function(m,f){return m.getTransceivers().find(R=>R.sender.track===f||R.receiver.track===f)}(this.peerConnection,e._mediaStreamTrack),c=c3(e);if(IW(e)&&a&&i&&c&&this.getLocalVideoStats&&B(n=["vp8","vp9"]).call(n,this.store.codec)){var d;const m=s.degradationPreference||(B(d=e._hints).call(d,xt.CUSTOM_TRACK)?C("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");(function(f,R,v,A,O,w){if(wu(f,v),O(R),A!=="balanced"&&A!=="maintain-framerate"&&A!=="maintain-resolution")return;let b=-1;bw(f,R);const L=window.setInterval(()=>{const W=bu.get(f);if(!C("ENABLE_AG_ADAPTATION")||!W)return wu(f,v),void O(R);const K=w();if(K.sendPackets>0&&K.OutgoingAvailableBandwidth>0){if(b===-1)return void(b=Date.now());if(Date.now()-b<1e3)return;const ht=K.sendFrameRate,pt=K.OutgoingAvailableBandwidth,[Vt,ce]=CW(f,ht,pt,W.adaptationConfig,R,A);ce&&(v.qualityLimitationReason=ce),Vt&&W.adaptationConfig.scale!==Vt.scale&&(_.debug("[".concat(f,"] applyAdaptation: ").concat(v.qualityLimitationReason,`
           sendFps `).concat(ht,", bwe ").concat(pt,", switch from ").concat(W.adaptationConfig.scale," to ").concat(Vt.scale," ")),W.adaptationConfig=Sm(Sm({},W.adaptationConfig),Vt),O(Vt))}},C("CHECK_LOCAL_STATS_INTERVAL")),x=Sm({},R);bu.set(f,{timer:L,adaptationConfig:x,originConfig:R,adaptationFunc:O}),_.debug("[".concat(f,"] start adaptation, originConfig: ").concat(JSON.stringify(R),", degradationPreference: ").concat(A))})(this.id+a.mid,c,this,m,f=>{i&&this.updateAdaptation(i,f)},this.getLocalVideoStats.bind(this))}if(e._encoderConfig){var l;const{bitrateMax:m,frameRate:f,scaleResolutionDownBy:R}=e._encoderConfig;m&&(o.maxBitrate=1e3*m),(B(l=e._hints).call(l,xt.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(f&&(o.maxFramerate=Di(f)),R&&R>=1&&(o.scaleResolutionDownBy=R))}const{maxFramerate:u}=C("ENCODER_CONFIG_LIMIT");if(u&&typeof u=="number"&&(o.maxFramerate=o.maxFramerate?Math.min(o.maxFramerate,u):u),C("DSCP_TYPE")&&vr()){var h;const m=C("DSCP_TYPE");B(h=["very-low","low","medium","high"]).call(h,m)&&(o.networkPriority=m)}const p=i.getParameters(),T=(r=p.encodings)===null||r===void 0?void 0:r[0];te()&&!T&&(s.encodings=[o]),T&&Object.assign(T,o),Object.assign(p,s),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(p.encodings))),await i.setParameters(p),await async function(m,f,R){try{var v;if(!St().supportSetRtpSenderParameters||!function(L){return L==="vp9"||L==="av1"}(m)||!C("ENABLE_SVC"))return;const A={},O={},w=f.getParameters(),b=(v=w.encodings)===null||v===void 0?void 0:v[0];O.scalabilityMode=fu(R),b&&Object.assign(b,O),Object.assign(w,A),await f.setParameters(w),_.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(w.encodings)))}catch(A){_.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",A)}}(this.store.codec,i,C("SVC_MODE"))}async updateAdaptation(e,i){var n,r;if(!e)return _.debug("[updateAdaptation] no rtpSender found");if(!St().supportSetRtpSenderParameters)return _.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const s={},{bitrateMax:o,frameRate:a,scaleResolutionDownBy:c}=i;o&&(s.maxBitrate=1e3*o),a&&(s.maxFramerate=Di(a)),c&&c>=1&&B(n=["vp8","vp9"]).call(n,this.store.codec)&&(s.scaleResolutionDownBy=c);const d=e.getParameters(),l=(r=d.encodings)===null||r===void 0?void 0:r[0];l&&Object.assign(l,s),Object.assign(d,{});try{await e.setParameters(d),_.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)))}catch(u){!("transport"in e)||e.transport&&e.transport.state==="connected"?this.peerConnectionState!=="connected"?_.debug("[updateAdaptation] peerConnection not connected}"):_.debug("[updateAdaptation] updateRtpSenderEncodings failed",u):_.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(e,i){try{if(!St().supportSetRtpSenderParameters||e.length!==i.length)return;for(let n=0;n<e.length;n++){const r=e[n],s=i[n];s instanceof Gt&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,r.sender)}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,i,n){const r=Ti(e);return i.forEach((s,o)=>{const a=n[o],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(ua(c,s),Jb(c,s,this.store.codec))}),Zr(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,i,n)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,i,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,i)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,i)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,i){if(e.length===i.length)for(let c=0;c<e.length;c++){var n,r,s,o,a;const d=e[c],l=i[c];if(l instanceof Gt&&!B(n=l._hints).call(n,xt.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=l._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=l._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const u={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];const p=d.sender.getParameters();await d.sender.setParameters(Object.assign(p,u))}}}async applySimulcastEncodings(e,i){if(!te()&&e.length===i.length)for(let n=0;n<e.length;n++){const r=i[n];if(r instanceof Gt&&this.isVP8Simulcast(r)){const s=e[n],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(e){var i,n,r,s,o;return!!(e instanceof Gt&&C("SIMULCAST")&&this.store.codec==="vp8"&&!B(i=e._hints).call(i,xt.LOW_STREAM)&&(n=e._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=e._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=e._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,i,n,r){if(C("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(i," SDP during P2PConnection.").concat(r,`
`),e),i==="offer"?s=>{this.logSDPExchange(s,"answer",n==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const i=this.remoteSDP.getSSRC(e);return i&&i.length!==0?i[0].ssrcId:void 0}setConfiguration(e){if(St().supportPCSetConfiguration){const i=nd.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}},J(Et.prototype,"updateRemoteRTPCapabilities",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"updateRemoteRTPCapabilities"),Et.prototype),J(Et.prototype,"connect",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"connect"),Et.prototype),J(Et.prototype,"updateRemoteConnect",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"updateRemoteConnect"),Et.prototype),J(Et.prototype,"createDataChannels",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"createDataChannels"),Et.prototype),J(Et.prototype,"receive",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"receive"),Et.prototype),J(Et.prototype,"batchReceive",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"batchReceive"),Et.prototype),J(Et.prototype,"stopReceiving",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"stopReceiving"),Et.prototype),J(Et.prototype,"muteRemote",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"muteRemote"),Et.prototype),J(Et.prototype,"unmuteRemote",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"unmuteRemote"),Et.prototype),J(Et.prototype,"muteLocal",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"muteLocal"),Et.prototype),J(Et.prototype,"unmuteLocal",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"unmuteLocal"),Et.prototype),J(Et.prototype,"close",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"close"),Et.prototype),J(Et.prototype,"updateEncoderConfig",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"updateEncoderConfig"),Et.prototype),J(Et.prototype,"updateSendParameters",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"updateSendParameters"),Et.prototype),J(Et.prototype,"replaceTrack",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"replaceTrack"),Et.prototype),J(Et.prototype,"updateAdaptation",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"updateAdaptation"),Et.prototype),J(Et.prototype,"getRemoteSSRC",[hi],Object.getOwnPropertyDescriptor(Et.prototype,"getRemoteSSRC"),Et.prototype),Et);function hi(t,e,i){const n=t[e];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const r=this.mutex,s=await r.lock("From P2PConnection.".concat(e));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{s()}},i}function Im(t,e){let i=document.createElement("video"),n=document.createElement("canvas");i.setAttribute("style","display:none"),n.setAttribute("style","display:none"),i.setAttribute("muted",""),i.muted=!0,i.setAttribute("autoplay",""),i.autoplay=!0,i.setAttribute("playsinline",""),n.width=Di(e.width),n.height=Di(e.height);const r=Di(e.framerate||15);document.body.append(i),document.body.append(n);let s=t._mediaStreamTrack;i.srcObject=new MediaStream([s]),i.play();const o=n.getContext("2d");if(!o)throw new D(S.UNEXPECTED_ERROR,"can not get canvas context");const a=St(),c=n.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0];c.canvas||(c.canvas=n),n.startCapture=()=>{if(!i)return n.stopCapture&&n.stopCapture();if(i.paused&&i.play(),i.videoHeight>2&&i.videoWidth>2){const l=i.videoWidth,u=i.videoHeight/l,h=n.width*u;Math.abs(h-n.height)>=2&&(_.debug("adjust low stream resolution","".concat(n.width,"x").concat(n.height," -> ").concat(n.width,"x").concat(h)),n.height=h)}o.drawImage(i,0,0,n.width,n.height),c.requestFrame&&c.requestFrame(),s!==t._mediaStreamTrack&&(s=t._mediaStreamTrack,i.srcObject=new MediaStream([s]))},n.stopCapture=UE(()=>n.startCapture&&n.startCapture(),r);const d=c.stop;return c.stop=()=>{d.call(c),i&&(i.remove(),i.srcObject=null,i=null),n&&(n.width=0,n.remove(),n.stopCapture&&n.stopCapture(),n.startCapture=void 0,n.stopCapture=void 0,n=null),_.debug("clean low stream renderer")},c}var Nu=function(t){return t[t.HEIGHT=2033]="HEIGHT",t[t.FRAME_RATE=2034]="FRAME_RATE",t[t.WIDTH=2035]="WIDTH",t}(Nu||{}),pe=function(t){return t[t.FRAME_RATE=2002]="FRAME_RATE",t[t.WIDTH=2003]="WIDTH",t[t.HEIGHT=2004]="HEIGHT",t[t.PACKAGE_LOST=2005]="PACKAGE_LOST",t[t.AVG_ENCODE=2007]="AVG_ENCODE",t[t.NACKS=2009]="NACKS",t[t.PLIS=2010]="PLIS",t[t.FIRS=2011]="FIRS",t[t.BITRATE=2012]="BITRATE",t[t.PACKAGE_RATE=2031]="PACKAGE_RATE",t[t.ADAPTATION=2032]="ADAPTATION",t[t.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",t[t.BANDWIDTH=2061]="BANDWIDTH",t[t.RETRANSMIT=2062]="RETRANSMIT",t[t.TARGET_ENCODED=2064]="TARGET_ENCODED",t[t.TRANSMIT=2066]="TRANSMIT",t[t.FREEZE=2082]="FREEZE",t[t.DISABLED=2095]="DISABLED",t[t.PLAYER_STATUS=2128]="PLAYER_STATUS",t[t.QP_SUM=2143]="QP_SUM",t[t.BYTES_RETRANSMIT=2173]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2172]="PACKAGES_RETRANSMIT",t[t.HUGE_FRAME_SENT=2174]="HUGE_FRAME_SENT",t[t.KEY_FRAMES_ENCODED=2207]="KEY_FRAMES_ENCODED",t}(pe||{}),Ys=function(t){return t[t.BITRATE=2069]="BITRATE",t[t.PACKAGE_LOST=2070]="PACKAGE_LOST",t[t.PACKAGE_RATE=2071]="PACKAGE_RATE",t[t.HEIGHT=2073]="HEIGHT",t[t.FRAME_RATE=2075]="FRAME_RATE",t[t.WIDTH=2077]="WIDTH",t}(Ys||{}),_e=function(t){return t[t.JITTER=-1]="JITTER",t[t.PACKAGE_LOST=2014]="PACKAGE_LOST",t[t.WIDTH=2018]="WIDTH",t[t.HEIGHT=2019]="HEIGHT",t[t.FRAME_RATE=2020]="FRAME_RATE",t[t.JITTER_BUFFER=2023]="JITTER_BUFFER",t[t.CURRENT_DELAY=2024]="CURRENT_DELAY",t[t.NACKS=2026]="NACKS",t[t.PLIS=2027]="PLIS",t[t.FIRS=2028]="FIRS",t[t.BITRATE=2029]="BITRATE",t[t.PACKAGE_RATE=2078]="PACKAGE_RATE",t[t.FREEZE=2084]="FREEZE",t[t.DISABLED=2101]="DISABLED",t[t.PLAYER_STATUS=2129]="PLAYER_STATUS",t[t.QP_SUM=2144]="QP_SUM",t[t.I_FRAME_DELAY=2149]="I_FRAME_DELAY",t[t.FRAMES_DROPPED=2181]="FRAMES_DROPPED",t[t.BYTES_RETRANSMIT=2175]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2176]="PACKAGES_RETRANSMIT",t[t.PACKAGES_DISCARDED=2198]="PACKAGES_DISCARDED",t[t.AVG_DECODE=2200]="AVG_DECODE",t[t.AVG_PROCESSING_DELAY=2202]="AVG_PROCESSING_DELAY",t[t.AVG_ASSEMBLY_TIME=2203]="AVG_ASSEMBLY_TIME",t[t.AVG_INTER_FRAME_DELAY=2204]="AVG_INTER_FRAME_DELAY",t[t.KEY_FRAMES_DECODED=2206]="KEY_FRAMES_DECODED",t}(_e||{}),qs=function(t){return t[t.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",t[t.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",t[t.FRAME_RATE_OUTPUT=2155]="FRAME_RATE_OUTPUT",t[t.FREEZE_TIME=2109]="FREEZE_TIME",t[t.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",t[t.FREEZE_DURATION=2156]="FREEZE_DURATION",t}(qs||{}),Pw=function(t){return t[t.PCM_LEVEL=2104]="PCM_LEVEL",t}(Pw||{}),or=function(t){return t[t.PACKAGE_LOST=-1]="PACKAGE_LOST",t[t.LEVEL=2038]="LEVEL",t[t.BITRATE=2039]="BITRATE",t[t.PACKAGE_RATE=2040]="PACKAGE_RATE",t[t.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",t[t.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",t[t.FREEZE=2081]="FREEZE",t[t.DISABLED=2096]="DISABLED",t[t.BYTES_RETRANSMIT=2179]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2180]="PACKAGES_RETRANSMIT",t}(or||{}),Ri=function(t){return t[t.BITRATE=2044]="BITRATE",t[t.PACKAGE_LOST=2045]="PACKAGE_LOST",t[t.PACKAGE_RATE=2046]="PACKAGE_RATE",t[t.CURRENT_DELAY=2047]="CURRENT_DELAY",t[t.JITTER_BUFFER=2054]="JITTER_BUFFER",t[t.JITTER=2055]="JITTER",t[t.FREEZE=2083]="FREEZE",t[t.DISABLED=2102]="DISABLED",t[t.PCM_LEVEL=2105]="PCM_LEVEL",t[t.PLAYER_STATUS=2130]="PLAYER_STATUS",t[t.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",t[t.BYTES_RETRANSMIT=2178]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2177]="PACKAGES_RETRANSMIT",t[t.PACKAGES_DISCARDED=2199]="PACKAGES_DISCARDED",t[t.AVG_PROCESSING_DELAY=2201]="AVG_PROCESSING_DELAY",t}(Ri||{}),Lw=function(t){return t[t.FREEZE_TIME=-1]="FREEZE_TIME",t[t.LEVEL=2043]="LEVEL",t}(Lw||{}),pi=function(t){return t[t.RTT=2006]="RTT",t[t.CONN_TYPE=801]="CONN_TYPE",t[t.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",t}(pi||{}),Du=function(t){return t[t.RTC_PEER_CONNECTION_STATE=2219]="RTC_PEER_CONNECTION_STATE",t}(Du||{});const Pu=1e3,bW=Math.max(6,3);function et(t,e,i){i!=null&&Number.isFinite(i)&&(t[e]=Math.round(Math.max(0,i)))}function kw(t){const e={[pi.CONN_TYPE]:0,[pi.RTT]:t.rtt,[pi.STATS_UPDATE_INTERVAL]:t.updateInterval?Math.round(Math.max(0,t.updateInterval)):void 0};switch(t.selectedCandidatePair.localCandidate.candidateType){case"relay":{const i=t.selectedCandidatePair.localCandidate.relayProtocol;i==="udp"&&(e[pi.CONN_TYPE]=1),i==="tcp"&&(e[pi.CONN_TYPE]=3),i==="tls"&&(e[pi.CONN_TYPE]=4);break}case"srflx":e[pi.CONN_TYPE]=2;break;case"unknown":e[pi.CONN_TYPE]=5;break;default:e[pi.CONN_TYPE]=0}return e}function Mw(t){let e=0;switch(t){case"none":e=0;break;case"cpu":e=1;break;case"bandwidth":e=2;break;case"other":e=3}return e}class Uw extends qt{constructor(e){super(),g(this,"store",void 0),g(this,"uploadWRTCStatsTimer",void 0),g(this,"uploadOutboundDenoiserStatsTimer",void 0),g(this,"uploadExtStatsTimer",void 0),g(this,"uploadExtUsageStatsTimer",void 0),g(this,"uploadInboundExtStatsTimer",void 0),g(this,"requestStats",void 0),g(this,"requestTransportStats",void 0),g(this,"requestLocalMedia",void 0),g(this,"requestRemoteMedia",void 0),g(this,"requestAllTracks",void 0),g(this,"requestVideoIsReady",void 0),g(this,"requestUploadStats",void 0),g(this,"requestUpload",void 0),g(this,"uploadOutboundStarted",!1),g(this,"uploadInboundStarted",!1),g(this,"uploadTransportStarted",!1),g(this,"uploadBaseStatsStarted",!1),g(this,"uploadExtensionUsageStarted",!1),g(this,"lastRecvStats",void 0),g(this,"lastSendStats",void 0),g(this,"lastRefRecvStats",void 0),g(this,"lastRefSendStats",void 0),g(this,"lastFullRecvStats",void 0),g(this,"lastFullSendStats",void 0),g(this,"needUploadRenderFreezeTime",!0),this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;const i=e%3==0,n=e%6==0;let r,s;if(this.uploadTransportStarted&&(r=this.requestStats(),this.store.useP2P&&(s=this.requestStats(!0))),!r&&this.uploadOutboundStarted&&(r=this.requestStats()),!s&&this.uploadInboundStarted&&(s=this.requestStats(!0)),r||s){var o;const a={};if(this.uploadTransportStarted&&r){const d=this.getTransportStats(r,s,i);d&&(a.misc=[d])}if(this.uploadOutboundStarted&&r){const d=this.getOutboundStats(r,n?this.lastFullSendStats:i?this.lastRefSendStats:this.lastSendStats,i,n);d&&(a.outbound=[d])}if(this.uploadInboundStarted&&s){const d=this.getInboundStats(s,n?this.lastFullRecvStats:i?this.lastRefRecvStats:this.lastRecvStats,i,n);d&&(a.inbound=d)}const c=(o=this.requestTransportStats)===null||o===void 0?void 0:o.call(this).connectState;c&&(Array.isArray(a.misc)?a.misc[0]&&a.misc[0].addition&&(a.misc[0].addition[Du.RTC_PEER_CONNECTION_STATE]=RE[c]):a.misc=[{addition:{[Du.RTC_PEER_CONNECTION_STATE]:RE[c]}}]),this.requestUploadStats(a)}this.lastRecvStats=s,this.lastSendStats=r,n&&(this.lastFullRecvStats=s,this.lastFullSendStats=r),i&&(this.lastRefRecvStats=s,this.lastRefSendStats=r)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;this.uploadBaseStatsStarted=!0;let e=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted){if(this.uploadBaseStatsStarted){var i,n;const r=(i=this.requestTransportStats)===null||i===void 0?void 0:i.call(this);return void(r&&((n=this.requestUploadStats)===null||n===void 0||n.call(this,{misc:[{addition:{[Du.RTC_PEER_CONNECTION_STATE]:RE[r.connectState]}}]})))}return this.stopUploadWRTCStats()}this.uploadWRTCStats(e),++e===bW+1&&(e=1)},Pu)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(e,i,n){if(!this.requestStats)return;if(!n)return e.rtt==null?void 0:{addition:{[pi.RTT]:e.rtt,[pi.CONN_TYPE]:void 0,[pi.STATS_UPDATE_INTERVAL]:e.updateInterval||void 0}};const r=kw(e);if(this.store.useP2P){if(i){const s=kw(i);r[pi.CONN_TYPE]+=s[pi.CONN_TYPE]<<3}r[pi.CONN_TYPE]+=110}else r[pi.CONN_TYPE]+=100;return{addition:r}}getOutboundStats(e,i,n,r){if(!this.requestUploadStats||!this.requestLocalMedia)return;const s=this.requestLocalMedia();if(!s||s.length===0)return;let o,a,c;return s.forEach(d=>{let[l,{track:u,ssrcs:h}]=d;switch(l){case U.LocalVideoLowTrack:case U.LocalVideoTrack:if(l===U.LocalVideoTrack){const p=function(f,R,v,A,O,w){const b=R.videoSend.find(K=>K.ssrc===f);if(!b)return;const L={},{sentFrame:x,inputFrame:W}=b;if(w&&(et(L,pe.QP_SUM,b.qpSumPerFrame),W&&x)){const K=W.frameRate,ht=x.frameRate;L[pe.FREEZE]=function(pt,Vt){let ce=!0;return ce=!(pt<=5)&&(pt<=10?Vt<3:pt<=20?Vt<4:Vt<5),ce}(K,ht)?1:0}if(O){switch(x&&(et(L,pe.HEIGHT,x.height),et(L,pe.WIDTH,x.width),et(L,pe.FRAME_RATE,x.frameRate)),L[pe.DISABLED]=A._originMediaStreamTrack&&!A._originMediaStreamTrack.enabled||A._mediaStreamTrack&&!A._mediaStreamTrack.enabled?1:0,b.adaptionChangeReason){case"none":L[pe.ADAPTATION]=0;break;case"cpu":L[pe.ADAPTATION]=1;break;case"bandwidth":L[pe.ADAPTATION]=2;break;case"other":L[pe.ADAPTATION]=3}let K=0;b.adaptionChangeReason&&(K+=Mw(b.adaptionChangeReason)),R.qualityLimitationReason&&(K+=Mw(R.qualityLimitationReason)<<3),L[pe.ADAPTATION]=K,L[pe.PLAYER_STATUS]=kE[A._player?A._player.videoElementStatus:"uninit"],et(L,pe.NACKS,b.nacksCount),et(L,pe.PLIS,b.plisCount),et(L,pe.FIRS,b.firsCount),et(L,pe.AVG_ENCODE,b.avgEncodeMs),et(L,pe.HUGE_FRAME_SENT,b.hugeFramesSent),et(L,pe.BYTES_RETRANSMIT,b.retransmittedBytesSent),et(L,pe.PACKAGES_RETRANSMIT,b.retransmittedPacketsSent),et(L,pe.KEY_FRAMES_ENCODED,b.keyFramesEncoded);const ht=v&&v.videoSend.find(pt=>pt.ssrc===f);if(ht){let pt=O?Pu:6e3;ht.timestamp&&b.timestamp&&(pt=b.timestamp-ht.timestamp),ht.packets!=null&&b.packets!=null&&et(L,pe.PACKAGE_RATE,1e3*(b.packets-ht.packets)/pt),b.packetsLost!=null&&ht.packetsLost!=null&&et(L,pe.PACKAGE_LOST,b.packetsLost-ht.packetsLost),ht.bytes!=null&&b.bytes!=null&&et(L,pe.BITRATE,8*(b.bytes-ht.bytes)/pt)}}return L}(h[0].ssrcId,e,i,u,n,r),T=u&&function(f,R,v,A){const O=R.videoSend.find(b=>b.ssrc===f);if(!O)return null;const w={};if(A){const b=O.inputFrame,L=b&&b.height||v.videoHeight||0,x=b&&b.width||v.videoWidth||0,W=b&&b.frameRate||0;et(w,Nu.HEIGHT,L),et(w,Nu.WIDTH,x),et(w,Nu.FRAME_RATE,W)}return w}(h[0].ssrcId,e,u,n),m=function(f,R){const v={};return R&&(et(v,pe.RETRANSMIT,f.bitrate.retransmit),et(v,pe.TARGET_ENCODED,f.bitrate.targetEncoded),et(v,pe.ACTUAL_ENCODED,f.bitrate.actualEncoded),et(v,pe.TRANSMIT,f.bitrate.transmit),et(v,pe.BANDWIDTH,f.sendBandwidth)),v}(e,n);a=Object.assign({},p,T,m)}else c=function(p,T,m,f){const R=T.videoSend.find(A=>A.ssrc===p);if(!R)return;const v={};if(f){const A=R.sentFrame;if(A&&(et(v,Ys.HEIGHT,A.height),et(v,Ys.WIDTH,A.width),et(v,Ys.FRAME_RATE,A.frameRate)),m){const O=m.videoSend.find(w=>w.ssrc===p);if(O){let w=6e3;O.timestamp&&R.timestamp&&(w=R.timestamp-O.timestamp),O.packets!=null&&R.packets!=null&&et(v,Ys.PACKAGE_RATE,1e3*(R.packets-O.packets)/w),R.packetsLost!=null&&O.packetsLost!=null&&et(v,Ys.PACKAGE_LOST,R.packetsLost-O.packetsLost),O.bytes!=null&&R.bytes!=null&&et(v,Ys.BITRATE,8*(R.bytes-O.bytes)/w)}}}return v}(h[0].ssrcId,e,i,n);break;case U.LocalAudioTrack:o=u&&function(p,T,m,f,R){const v=T.audioSend.find(O=>O.ssrc===p);if(!v)return;const A={};if(R){A[or.DISABLED]=f._originMediaStreamTrack&&!f._originMediaStreamTrack.enabled||f._mediaStreamTrack&&!f._mediaStreamTrack.enabled?1:0;const O=100*f._source.getAccurateVolumeLevel(),w=v.inputLevel;if(w!=null){const L=Math.ceil(50*Math.log10(100*w+1));et(A,or.LEVEL,L)}et(A,Pw.PCM_LEVEL,O),et(A,or.AEC_RETURN_LOSS,v.aecReturnLoss),et(A,or.AEC_RETURN_LOSS_ENH,v.aecReturnLossEnhancement),et(A,or.BYTES_RETRANSMIT,v.retransmittedBytesSent),et(A,or.PACKAGES_RETRANSMIT,v.retransmittedPacketsSent),A[or.FREEZE]=0;const b=m&&m.audioSend.find(L=>L.ssrc===p);if(b){let L=6e3;b.timestamp&&v.timestamp&&(L=v.timestamp-b.timestamp),b.bytes!=null&&v.bytes!=null&&et(A,or.BITRATE,8*(v.bytes-b.bytes)/L),b.packets!=null&&v.packets!=null&&et(A,or.PACKAGE_RATE,1e3*(v.packets-b.packets)/L)}}return A}(h[0].ssrcId,e,i,u,n)}}),{high:a,low:c,audio:o}}getInboundStats(e,i,n,r){if(!this.requestRemoteMedia)return;const s=this.requestRemoteMedia()||[],o=[];return s.forEach(a=>{let[c,d]=a;const l={peer:c.uid};if(d.has(q.VIDEO)&&c.videoTrack){const u=c._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(c._videoSSRC)||!1,h=c.videoTrack?function(p,T,m,f,R,v,A,O){const w=T.videoRecv.find(pt=>pt.ssrc===p);if(!w)return;const b={},{receivedFrame:L,outputFrame:x,decodeFrameRate:W}=w,K=m&&m.videoRecv.find(pt=>pt.ssrc===p);if(et(b,qs.FRAME_RATE_DECODE,W),w.framesRateFirefox&&et(b,_e.FRAME_RATE,w.framesRateFirefox),L&&et(b,_e.FRAME_RATE,L.frameRate),et(b,_e.FRAMES_DROPPED,w.framesDroppedCount),et(b,_e.BYTES_RETRANSMIT,w.retransmittedBytesReceived),et(b,_e.PACKAGES_RETRANSMIT,w.retransmittedPacketsReceived),et(b,_e.PACKAGES_DISCARDED,w.packetsDiscarded),et(b,_e.AVG_DECODE,w.avgDecodeMs),et(b,_e.AVG_PROCESSING_DELAY,w.avgProcessingDelayMs),et(b,_e.AVG_ASSEMBLY_TIME,w.avgFramesAssembledFromMultiplePacketsMs),et(b,_e.AVG_INTER_FRAME_DELAY,w.avgInterFrameDelayMs),et(b,_e.KEY_FRAMES_DECODED,w.keyFramesDecoded),K){const pt=T.timestamp-m.timestamp||Pu*(O?6:A?3:1);w.packetsLost!=null&&K.packetsLost!=null&&et(b,_e.PACKAGE_LOST,w.packetsLost-K.packetsLost),K.bytes!=null&&w.bytes!=null&&et(b,_e.BITRATE,8*(w.bytes-K.bytes)/pt),K.packets!=null&&w.packets!=null&&et(b,_e.PACKAGE_RATE,1e3*(w.packets-K.packets)/pt)}if(O&&(et(b,_e.QP_SUM,w.qpSumPerFrame),b[_e.FREEZE]=R&&Pc.isRemoteVideoFreeze(f,w,K)?1:0),A){var ht;L?(et(b,_e.HEIGHT,L.height),et(b,_e.WIDTH,L.width)):f&&(et(b,_e.HEIGHT,f._videoHeight||0),et(b,_e.WIDTH,f._videoWidth||0)),x&&et(b,qs.FRAME_RATE_OUTPUT,x.frameRate);const pt=(ht=f._player)===null||ht===void 0?void 0:ht.rendFrameRate.toFixed(0);if(pt&&et(b,qs.FRAME_RATE_RENDER,+pt),et(b,_e.JITTER_BUFFER,w.jitterBufferMs),et(b,_e.CURRENT_DELAY,w.currentDelayMs),et(b,_e.FIRS,w.firsCount),et(b,_e.NACKS,w.nacksCount),et(b,_e.PLIS,w.plisCount),f){b[_e.DISABLED]=f._originMediaStreamTrack.enabled&&f._mediaStreamTrack.enabled?0:1;const Vt=f._player;if(Vt){const{freezeTimeCounterList:ce,renderFreezeAccTime:ne,videoElementStatus:Ei}=Vt;if(ce&&ce.length>0&&et(b,qs.FREEZE_TIME,ce.splice(0,1)[0]),v&&yr.visibility==="visible"&&Ei===Qe.PLAYING&&St().supportRequestVideoFrameCallback){const k=Math.min(6e3,ne);Vt.renderFreezeAccTime=Math.max(0,ne-k),et(b,qs.FREEZE_TIME_RENDER,k)}if(typeof w.totalFreezesDuration=="number"){const k=K&&K.totalFreezesDuration?w.totalFreezesDuration-K.totalFreezesDuration:w.totalFreezesDuration;et(b,qs.FREEZE_DURATION,1e3*k)}}}if(b[_e.PLAYER_STATUS]=kE[f._player?f._player.videoElementStatus:"uninit"],K&&w.totalInterFrameDelay!==void 0&&w.totalSquaredInterFrameDelay!==void 0&&K.totalInterFrameDelay!==void 0&&K.totalSquaredInterFrameDelay!==void 0){const Vt=w.totalInterFrameDelay-K.totalInterFrameDelay,ce=w.totalSquaredInterFrameDelay-K.totalSquaredInterFrameDelay,ne=w.framesDecodeCount-K.framesDecodeCount,Ei=Vt/ne*1e3,k=Math.round(1e3*Math.sqrt((ce-Math.pow(Vt,2)/ne)/ne));!isNaN(k)&&Ei+k>Math.max(3*Ei,Ei+150)&&(b[_e.I_FRAME_DELAY]=k)}}return b}(c._videoSSRC,e,i,c.videoTrack,u===!0,this.needUploadRenderFreezeTime,n,r):void 0;h&&(l.video=h)}if(d.has(q.AUDIO)&&c.audioTrack){const u=c.audioTrack?function(h,p,T,m,f,R){const v=p.audioRecv.find(b=>b.ssrc===h);if(!v)return;const A={},O=T&&T.audioRecv.find(b=>b.ssrc===h);if(et(A,Ri.JITTER,v.jitterMs),et(A,Ri.BYTES_RETRANSMIT,v.retransmittedBytesReceived),et(A,Ri.PACKAGES_RETRANSMIT,v.retransmittedPacketsReceived),et(A,Ri.PACKAGES_DISCARDED,v.packetsDiscarded),et(A,Ri.AVG_PROCESSING_DELAY,v.avgProcessingDelayMs),O){const b=p.timestamp-T.timestamp||Pu*(R?6:f?3:1);v.packets!=null&&O.packets!=null&&et(A,Ri.PACKAGE_RATE,1e3*(v.packets-O.packets)/b),f&&O.bytes!=null&&v.bytes!=null&&et(A,Ri.BITRATE,8*(v.bytes-O.bytes)/b),v.packetsLost!=null&&O.packetsLost!=null&&et(A,Ri.PACKAGE_LOST,v.packetsLost-O.packetsLost)}if(R){const{receivedFrames:b,droppedFrames:L}=v;b!=null&&L!=null&&(A[Ri.FREEZE]=(w=b)===0||100*L/w>20?1:0)}var w;if(f){const b=100*m._source.getAccurateVolumeLevel(),L=v.outputLevel;if(L!=null){const x=Math.ceil(50*Math.log10(100*L+1));et(A,Lw.LEVEL,x)}if(et(A,Ri.PCM_LEVEL,b),m&&(A[Ri.DISABLED]=m._originMediaStreamTrack.enabled&&m._mediaStreamTrack.enabled?0:1),et(A,Ri.JITTER_BUFFER,v.jitterBufferMs),et(A,Ri.CURRENT_DELAY,v.jitterBufferMs),A[Ri.PLAYER_STATUS]=kE[ui.getPlayerState(m.getTrackId())],O){const x=v.concealedSamples-O.concealedSamples;x>0&&et(A,Ri.CONCEALED_SAMPLES,x)}}return A}(c._audioSSRC,e,i,c.audioTrack,n,r):void 0;u&&(l.audio=u)}(l.video||l.audio)&&o.push(l)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,o}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find(i=>i instanceof eu);if(e&&e._external.getDenoiserStats){const i=e._external.getDenoiserStats();i&&this.requestUpload(Cc.DENOISER_STATS,i)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(e=>{e.getProcessorStats().forEach(i=>{this.requestUpload&&this.requestUpload(i.type,i.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(e=>{let[i,n]=e;n.has(q.VIDEO)&&i.videoTrack&&i.videoTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)}),n.has(q.AUDIO)&&i.audioTrack&&i.audioTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const e=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{const i=Date.now(),n={connectionInterval:C("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:i};let r=[];const s=this.requestAllTracks&&this.requestAllTracks()||[];for(const d of s)!d.muted&&d.enabled&&(r=r.concat(await d.getProcessorUsage()));const o=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[d,l]of o)l.has(q.VIDEO)&&d.videoTrack&&(r=r.concat(await d.videoTrack.getProcessorUsage())),l.has(q.AUDIO)&&d.audioTrack&&(r=r.concat(await d.audioTrack.getProcessorUsage()));if(r.length===0)return;n.details=function(d,l){const u={};for(const{id:m,value:f,level:R,direction:v}of d){var h;const A=(h=l.get(m))!==null&&h!==void 0?h:0,O=f===2?A+C("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:A;var p,T;l.set(m,O),u[m]?(f===2&&(u[m].value=f),R>u[m].level&&(u[m].level=R),v==="remote"&&(u[m].remoteUidCount+=1),u[m].totalTs=(p=l.get(m))!==null&&p!==void 0?p:0):u[m]={value:f,level:R,remoteUidCount:v==="local"?0:1,totalTs:(T=l.get(m))!==null&&T!==void 0?T:0}}return Object.keys(u).map(m=>{const{level:f,value:R,totalTs:v}=u[m];return{id:m,level:f,value:R,totalTs:v}})}(r,e);const a=Date.now(),c=a>i?a:i+1;this.requestUpload&&this.requestUpload(Cc.EXTENSION_USAGE_STATS,{usageStats:n,sendTs:c})},C("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}stopUploadBaseStats(){this.uploadBaseStatsStarted=!1}}const wW=C("ICE_RESTART_INTERVAL");let Lu=new Map,ma=new Map,ss=[Je.UDP_TCP_RELAY,Je.TCP_RELAY,Je.RELAY],ym=C("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&St().supportPCSetConfiguration;function xw(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i=Lu.get(t.id);i&&(window.clearTimeout(i),Lu.delete(t.id));const n=ma.get(t.id);e&&n&&n.index===ss.length-1&&(_.debug("[".concat(t.id,"] reset ICE restart policy")),ma.delete(t.id))}function Vw(t,e,i){if(Lu.size===0&&ma.size===0&&(Array.isArray(C("RESTART_SEQUENCE"))&&C("RESTART_SEQUENCE").length>0&&!function(a,c){if(a.length!==c.length)return!1;for(let d=0;d<a.length;d+=1){const l=a[d];if(a.filter(u=>u===l).length!==c.filter(u=>u===l).length)return!1}return!0}(ss,C("RESTART_SEQUENCE"))&&(ss=C("RESTART_SEQUENCE").filter(a=>{var c;if(B(c=Object.values(Je)).call(c,a))return!0}),_.debug("use reconnection policy from config distribution, queues: ".concat(ss.join(" => ")))),ym=C("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&St().supportPCSetConfiguration),ss.length===0)return void i();let n,{index:r=0,type:s}=ma.get(t.id)||{};if(ym&&s===Je.RELAY)return void i();let o=s&&r>=ss.length-1;if(ym)s=Je.RELAY;else{if(o)return void i();s?(r++,s=ss[r]):(s=ss[0],r=0)}_.debug("[".concat(t.id,"] choose ICE restart policy: ").concat(s,", index: ").concat(r)),e(s),ma.set(t.id,{index:r,type:s}),n=window.setTimeout(()=>Vw(t,e,i),wW),Lu.set(t.id,n)}var ct;function Fw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function ar(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Fw(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Fw(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function Bw(t){var e,i,n,r=2;for(typeof Symbol<"u"&&(i=Q_,n=Symbol.iterator);r--;){if(i&&(e=t[i])!=null)return e.call(t);if(n&&(e=t[n])!=null)return new ku(e.call(t));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function ku(t){function e(i){if(Object(i)!==i)return G.reject(new TypeError(i+" is not an object."));var n=i.done;return G.resolve(i.value).then(function(r){return{value:r,done:n}})}return ku=function(i){this.s=i,this.n=i.next},ku.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(i){var n=this.s.return;return n===void 0?G.resolve({value:i,done:!0}):e(n.apply(this.s,arguments))},throw:function(i){var n=this.s.return;return n===void 0?G.reject(i):e(n.apply(this.s,arguments))}},new ku(t)}let kc=(ct=class extends qt{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(Z.StateChange,e,this._state)}constructor(t,e){super(),g(this,"isPlanB",void 0),g(this,"store",void 0),g(this,"statsUploader",void 0),g(this,"connection",void 0),g(this,"localTrackMap",new Map),g(this,"remoteUserMap",new Map),g(this,"localDataChannels",[]),g(this,"remoteDataChannelMap",new Map),g(this,"pendingLocalTracks",[]),g(this,"pendingRemoteTracks",[]),g(this,"pendingLocalDataChannels",[]),g(this,"pendingRemoteDataChannels",[]),g(this,"statsCollector",void 0),g(this,"shouldForwardP2PCreation",void 0),g(this,"iceFailedCount",0),g(this,"dtlsFailedCount",0),g(this,"mutex",void 0),g(this,"_state",yt.Disconnected),g(this,"_pcStatsUploadType",C("NEW_ICE_RESTART")?wr.FIRST_CONNECTION:wr.OLD_FIRST_CONNECTION),g(this,"_isStartRestartIce",!1),g(this,"_restartTimer",void 0),g(this,"_isTryConnecting",!1),g(this,"_iceError",null),g(this,"_forceTurn",!1),g(this,"_isWaitPcToRePub",!1),g(this,"handleMuteLocalTrack",async(i,n,r)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==yt.Connected)return void r(new P(S.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const o=this.filterTobeMutedTracks(i);if(o.length===0)return void n();const a=o.find(d=>d[0]==="videoLowTrack");a&&a[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(o.map(d=>{let[,{id:l}]=d;return l}));const c=this.createMuteMessage(o);await Mt(this,Z.RequestMuteLocal,c),n()}catch(o){r(o)}finally{s()}}),g(this,"handleUnmuteLocalTrack",async(i,n,r)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==yt.Connected)return void r(new P(S.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const o=this.filterTobeUnmutedTracks(i);if(o.length===0)return void n();const a=o.find(d=>d[0]==="videoLowTrack");if(a){const d=a[1];if(d.track._originMediaStreamTrack.stop(),!C("DISABLE_DUAL_STREAM_USE_ENCODING")&&St().supportDualStreamEncoding){const l=i._mediaStreamTrack.clone();d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}else{const l=Im(i,mc(this,Z.RequestLowStreamParameter));d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}await new G((l,u)=>{this.handleReplaceTrack(d.track,l,u,!0)})}await this.connection.unmuteLocal(o.map(d=>{let[,{id:l}]=d;return l}));const c=this.createUnmuteMessage(o);await Mt(this,Z.RequestUnmuteLocal,c),n()}catch(o){r(o)}finally{s()}}),g(this,"handleUpdateVideoEncoder",async(i,n,r,s)=>{let o;s||(o=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoEncoder"));try{const c=this.localTrackMap.get(U.LocalVideoTrack);if(!this.connection||!c||c.track!==i||this.state!==yt.Connected)return void n();const{id:d,track:l}=c;await this.connection.updateSendParameters(d,l),await this.connection.updateEncoderConfig(d,l),this.emit(Z.UpdateVideoEncoder,l),n()}catch(c){r(c)}finally{var a;(a=o)===null||a===void 0||a()}}),g(this,"handleUpdateVideoSendParameters",async(i,n,r)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const o=this.localTrackMap.get(U.LocalVideoTrack);if(!this.connection||!o||o.track!==i||this.state!==yt.Connected)return void n();const{id:a,track:c}=o;await this.connection.updateSendParameters(a,c),n()}catch(o){r(o)}finally{s()}}),g(this,"handleReplaceMixingTrack",async(i,n,r,s)=>{if(!this.connection||this.state!==yt.Connected)return void n();const o=vm([i]);let a;_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(o.getTrackId(),"]")),typeof s=="boolean"&&s||(a=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(i,o),n()}catch(d){r(d)}finally{var c;(c=a)===null||c===void 0||c()}}),g(this,"handleReplaceTrack",async(i,n,r,s)=>{let o;_.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(i.getTrackId(),"]")),typeof s=="boolean"&&s||(o=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var a;const d=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:u}]=l;return i===u});if(!this.connection||!d||this.state!==yt.Connected)return void n();if(await((a=this.connection)===null||a===void 0?void 0:a.replaceTrack(i,d[1].id)),this.isPlanB){const l=d[1];l.id=i._mediaStreamTrack.id,this.localTrackMap.set(d[0],l)}if(d[0]===U.LocalVideoTrack&&!C("DISABLE_DUAL_STREAM_USE_ENCODING")&&St().supportDualStreamEncoding){const l=this.localTrackMap.get(U.LocalVideoLowTrack);if(l){const u=i._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u,await new G((h,p)=>{this.handleReplaceTrack(l.track,h,p,!0)})}}n()}catch(d){r(d)}finally{var c;(c=o)===null||c===void 0||c()}}),g(this,"handleGetRTCStats",i=>{i(this.statsCollector.getRTCStats())}),g(this,"handleGetLocalVideoStats",i=>{i(this.statsCollector.getLocalVideoTrackStats())}),g(this,"handleGetLocalAudioStats",i=>{i(this.statsCollector.getLocalAudioTrackStats())}),g(this,"handleGetRemoteVideoStats",i=>this.statsCollector.getRemoteVideoTrackStats(i.uid)[i.uid]),g(this,"handleGetRemoteAudioStats",i=>this.statsCollector.getRemoteAudioTrackStats(i.uid)[i.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new Uw(this.store),this.bindStatsUploaderEvents(),this.mutex=new Ke("P2PChannel-mutex",this.store.clientId),this.isPlanB=!St().supportUnifiedPlan||C("CHROME_FORCE_PLAN_B")&&vr(),this.shouldForwardP2PCreation=C("FORWARD_P2P_CREATION")&&St().supportPCSetConfiguration&&cE(),this.shouldForwardP2PCreation&&(this.connection=Ou(this.store),this.emit(Z.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection))}async startP2PConnection(t){var e;this.state=yt.New,this._forceTurn=Nw(t),_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] forceTurn: ").concat(this._forceTurn));const i=this.shouldForwardP2PCreation&&((e=this.connection)===null||e===void 0?void 0:e.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!i||(i&&this.connection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.resetConnection(this.connection)),this.connection=Ou(this.store,t),this.emit(Z.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),!this.connection)throw new P(S.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=C("NEW_ICE_RESTART")?wr.FIRST_CONNECTION:wr.OLD_FIRST_CONNECTION,this._isTryConnecting=!0,this._isStartRestartIce=!1,this._iceError=null,this.connection.setConfiguration(t),this.connection.establishPromise}async connect(t){if(!this.connection)throw new P(S.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");C("ENABLE_PREALLOC_PC")&&this.state===yt.Connected?await this.connection.updateRemoteConnect(t):(this.store.peerConnectionStart(),await this.connection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=yt.Connected)}updateRemoteRTPCapabilities(t){const e=Array.from(this.localTrackMap.entries()).filter(r=>{var s;let[o]=r;return B(s=[U.LocalVideoLowTrack,U.LocalVideoTrack]).call(s,o)}),i=e.map(r=>{let[,{id:s}]=r;return s}),n=e.map(r=>{let[s]=r;return s});if(this.connection instanceof Dr){if(Q.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(n),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(t)}),!B(t).call(t,this.store.codec)){const r=["vp9","vp8","h264"].find(s=>B(t).call(t,s));r&&(this.store.codec=r,_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(r,".")))}this.connection.updateRemoteRTPCapabilities(i,t)}}async getEstablishParams(){var t;if(this.connection instanceof Dr&&this.connection.peerConnectionState!=="closed"&&B(t=[yt.New,yt.Connected]).call(t,this.state))return this.connection.establishPromise}async publishDataChannel(t){if(!this.connection||this.state!==yt.Connected){if(this.state===yt.Disconnected)throw new P(S.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return t.forEach(i=>{var n;B(n=this.pendingLocalDataChannels).call(n,i)||this.pendingLocalDataChannels.push(i)}),[]}const e=this.filterTobePublishedDataChannels(t);return e.length===0?[]:(e.forEach(i=>{const n=Date.now();this.store.publish(i.id.toString(),"datachannel",n)}),await this.connection.createDataChannels(this.store.uid,e),e.forEach(i=>{this.localDataChannels.push(i);const n=Date.now();this.store.publish(i.id+"","datachannel",void 0,n)}),t.map(i=>({streamId:i.id,ordered:i.ordered,maxRetransmits:i.maxRetransmits,metadata:i.metadata,channelId:i._originDataChannelId})))}publish(t,e,i){var n=this;return Qi(function*(){const r=yield mt(n.mutex.lock("From P2PChannel.publish"));try{var s;const o=n.connection&&B(s=["disconnected","failed"]).call(s,n.connection.peerConnectionState);if(!n.connection||n.state!==yt.Connected||o){if(n.state===yt.Disconnected)throw new P(S.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(t);const c=t.filter(d=>n.pendingLocalTracks.indexOf(d)===-1);return n.pendingLocalTracks=n.pendingLocalTracks.concat(c),void(o&&(n._isWaitPcToRePub=!0))}n.store.pubId=n.store.pubId+1,qe.markPublishStart(n.store.clientId,n.store.pubId);const a=n.filterTobePublishedTracks(t,e,i);if(a.length===0)return void(yield mt(n.tryToUnmuteAudio(t)));yield*wl(Bw(n.doPublish(n.connection,a)))}finally{r()}})()}doPublish(t,e){var i=this;return Qi(function*(){e.forEach(h=>{let{track:p,type:T}=h;const m=Date.now();i.store.publish(p.getTrackId(),T===U.LocalAudioTrack?"audio":"video",m)}),i.bindLocalTrackEvents(e);const n=e.map(h=>{let{track:p}=h;return p}),r=yield mt(t.send(n,i.store.codec,i.store.audioCodec)),s=(yield mt(r.next())).value,o=i.createGatewayPublishMessage(e,s);let a;try{a=yield o}catch(h){throw r.throw(h),(h==null?void 0:h.code)===S.WS_ABORT&&e.forEach(p=>{let{track:T}=p;i.pendingLocalTracks.indexOf(T)===-1&&i.pendingLocalTracks.push(T)}),i.unbindLocalTrackEvents(e),h}const c=i.mapPubResToRemoteConfig(o,a,n),d=(yield mt(r.next(c))).value;if(i.state===yt.Disconnected)throw new P(S.UNEXPECTED_ERROR,"PeerConnection already disconnected.");C("ENABLE_VIDEO_SEI");const l=C("ENABLE_ENCODED_TRANSFORM"),u=C("ENABLE_AUDIO_METADATA");n.forEach(async h=>{const p=h.getRTCRtpTransceiver();p&&l&&(h.trackMediaType===q.VIDEO?await R3(p.sender,h):h.trackMediaType===q.AUDIO&&await p3(p.sender,{metadata:u?()=>{const T=h.metadata.shift();return T&&T.value}:void 0}))}),e.forEach(h=>{let{type:p}=h;i.statsCollector.addLocalStats(p)}),i.assignLocalTracks(e,d),i.statsUploader.startUploadOutboundStats(),e.forEach(h=>{let{track:p,type:T}=h;const m=Date.now();i.store.publish(p.getTrackId(),T===U.LocalAudioTrack?"audio":"video",void 0,m)})})()}async updateVideoStreamParameter(t,e){const i=this.localTrackMap.get(e);if(!i||!this.connection)return;if(!(i.track instanceof Gt))return _.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");const{track:n}=i,r=function(s,o){const a={};return s.height&&s.width&&(a.scaleResolutionDownBy=om(s,o)),a.maxFramerate=s.framerate?Di(s.framerate):void 0,a.maxBitrate=s.bitrate?1e3*s.bitrate:void 0,a}(t,n);if(n._encoderConfig||(n._encoderConfig={}),e!==U.LocalVideoLowTrack||!C("DISABLE_DUAL_STREAM_USE_ENCODING")&&St().supportDualStreamEncoding)r.scaleResolutionDownBy!=null&&(n._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else{const s=n._originMediaStreamTrack;if(!s.canvas)return _.warn("[".concat(n.getTrackId(),"] no canvas on track"));(function(o,a){const c=o.canvas;a.width&&(c.width=Di(a.width)),a.height&&(c.height=Di(a.height)),a.framerate&&(c.stopCapture&&c.stopCapture(),c.stopCapture=UE(()=>{!c.startCapture&&c.stopCapture&&c.stopCapture(),c.startCapture&&c.startCapture()},Di(a.framerate)))})(s,t)}r.maxBitrate!=null&&(n._encoderConfig.bitrateMax=r.maxBitrate/1e3),r.maxFramerate!=null&&(n._encoderConfig.frameRate&&typeof n._encoderConfig.frameRate=="object"?n._encoderConfig.frameRate.max=r.maxFramerate:n._encoderConfig.frameRate={max:r.maxFramerate}),_.debug("[".concat(n.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(n._encoderConfig))),await this.connection.updateRtpSenderEncodings(n)}publishLowStream(t){var e=this;return Qi(function*(){if(!e.connection||e.state!==yt.Connected)return;const i=yield mt(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const r=e.localTrackMap.get(U.LocalVideoTrack);if(!r)throw new P(S.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(U.LocalVideoLowTrack))throw new P(S.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));const s=[{track:e.getLowVideoTrack(r.track,t),type:U.LocalVideoLowTrack}];if(yield*wl(Bw(e.doPublish(e.connection,s))),r.track.muted||!r.track.enabled){var n;const o=(n=e.localTrackMap.get(U.LocalVideoLowTrack))===null||n===void 0?void 0:n.id;o!==void 0&&(yield mt(e.connection.muteLocal([o])))}}finally{i()}})()}async republish(){this.pendingLocalTracks.length>0&&(_.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Be(this,Z.RequestRePublish,this.pendingLocalTracks),this.emit(Z.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(_.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await Be(this,Z.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[]),this._isWaitPcToRePub=!1}async reSubscribe(t){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){const{user:i,kind:n}=this.pendingRemoteTracks[e];(n!==q.AUDIO||i._audio_added_&&i._audioSSRC)&&(n!==q.VIDEO||i._video_added_&&i._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(t)await Be(this,Z.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:e,kind:i}of this.pendingRemoteTracks)await this.subscribe(e,i,i===q.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach(e=>{let{user:i}=e;this.emit(Z.MediaReconnectEnd,i.uid)}),this.pendingRemoteTracks=[]}async unpublish(t){if(!this.connection||this.state!==yt.Connected)return void t.forEach(n=>{const r=this.pendingLocalTracks.indexOf(n);r!==-1&&this.pendingLocalTracks.splice(r,1)});const e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;const i=e.find(n=>n[0]==="videoLowTrack");return i&&i[1].track.close(),this.doUnpublish(this.connection,e)}async unpublishDataChannel(t){if(!this.connection||this.state!==yt.Connected)return void t.forEach(i=>{const n=this.pendingLocalDataChannels.indexOf(i);n!==-1&&this.pendingLocalDataChannels.splice(n,1)});const e=this.filterTobeUnpublishedDataChannels(t);return e.length!==0?(e.forEach(i=>{const n=this.localDataChannels.indexOf(i);n!==-1&&this.localDataChannels.splice(n,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),e.map(i=>i.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==yt.Connected)return;const t=this.localTrackMap.get(U.LocalVideoLowTrack);if(!t)return;t.track.close();const e=[[U.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,e)}async doUnpublish(t,e){const i=this.createGatewayUnpublishMessage(e);return await t.stopSending(e.map(n=>{let[,{id:r}]=n;return r})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(n=>{let[r,{track:s}]=n;return{type:r,track:s}})),e.forEach(n=>{let[r]=n;this.statsCollector.removeLocalStats(r)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),i}async subscribeDataChannel(t,e){if(!this.connection||this.state!==yt.Connected)throw new P(S.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const i=e.filter(n=>{var r;return!((r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.get(n.id))});if(i.length!==0)return await this.connection.createDataChannels(t.uid,i),i.forEach(n=>{var r;this.remoteDataChannelMap.has(t)?(r=this.remoteDataChannelMap.get(t))===null||r===void 0||r.set(n.id,n):this.remoteDataChannelMap.set(t,new Map([[n.id,n]]));const s=this.pendingRemoteDataChannels.findIndex(o=>{let{user:a,id:c}=o;return a.uid===t.uid&&c===n.id});s!==-1&&this.pendingRemoteDataChannels.splice(s,1)}),i.map(n=>n.id)}async subscribe(t,e,i,n,r){var s;if(!this.connection||this.state!==yt.Connected)throw new P(S.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((s=this.remoteUserMap.get(t))!==null&&s!==void 0&&s.has(e))return;let o,a,c;const d=this.connection.getPreMedia(i);if(d)_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(i,", no need to send sub to gateway.")),c=d.transceiver,o=d.track,a=d.id;else if(r){const h=r.find(T=>{let{stream_type:m}=T;return m===e});if(!h)throw new P(S.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));const p=await this.connection.receive(e,h.ssrcs,String(t._uintid),h.attributes);this.connection instanceof Dr&&(c=p.transceiver),o=p.track,a=p.id}else{const h=await this.connection.receive(e,[{ssrcId:i,rtx:n}],String(t._uintid),void 0);this.connection instanceof Dr&&(c=h.transceiver),o=h.track,a=h.id}e===q.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(o):(t._audioTrack=new ea(o,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),c&&t._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(o):(t._videoTrack=new ta(o,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),c&&t._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._videoTrack)),c&&C("ENABLE_ENCODED_TRANSFORM")&&(e==q.VIDEO?await zE(c.receiver,{onSei:C("ENABLE_VIDEO_SEI")&&(h=>{var p;return(p=t._videoTrack)===null||p===void 0?void 0:p._onSei(h)})}):e==q.AUDIO&&await qE(c.receiver,{enableTopn:!!C("ENABLE_AUDIO_TOPN"),enableMetadata:!!C("ENABLE_AUDIO_METADATA"),onMetadata:h=>{this.safeEmit(Z.AudioMetadata,h)}}));const l=this.remoteUserMap.get(t);l?l.set(e,a):this.remoteUserMap.set(t,new Map([[e,a]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats();const u=this.pendingRemoteTracks.findIndex(h=>{let{user:p,kind:T}=h;return p.uid===t.uid&&e===T});u!==-1&&(this.pendingRemoteTracks.splice(u,1),this.emit(Z.MediaReconnectEnd,t.uid))}async massSubscribe(t){return this.massSubscribeNoLock(t)}async massSubscribeNoLock(t){if(!this.connection||this.state!==yt.Connected)throw new P(S.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter(r=>{var s;let{user:o,mediaType:a}=r;return!((s=this.remoteUserMap.get(o))!==null&&s!==void 0&&s.has(a))});const e=[],i=new Map;t.forEach(r=>{if(!this.connection)return;const s=this.connection.getPreMedia(r.ssrcId);s?i.set(r.ssrcId,s):e.push(r)});const n=await this.connection.batchReceive(e.map(r=>{let{user:s,mediaType:o,ssrcId:a,rtxSsrcId:c}=r;return{kind:o,ssrcMsg:[{ssrcId:a,rtx:c}],mslabel:String(s._uintid)}}));e.forEach((r,s)=>{i.set(r.ssrcId,n[s])});for(const{user:r,mediaType:s,ssrcId:o}of t){const a=i.get(o);if(!a)return void _.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(r.uid," subscribe data,").concat(s,", ").concat(o));const{track:c,id:d,transceiver:l}=a;l&&C("ENABLE_ENCODED_TRANSFORM")&&(s==q.VIDEO?await zE(l.receiver,{onSei:C("ENABLE_VIDEO_SEI")&&(p=>{var T;return(T=r._videoTrack)===null||T===void 0?void 0:T._onSei(p)})}):s==q.AUDIO&&await qE(l.receiver,{enableTopn:!!C("ENABLE_AUDIO_TOPN"),enableMetadata:!!C("ENABLE_AUDIO_METADATA"),onMetadata:p=>{this.safeEmit(Z.AudioMetadata,p)}})),s===q.AUDIO?(r._audioTrack?r._audioTrack._updateOriginMediaStreamTrack(c):(r._audioTrack=new ea(c,r.uid,r._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(r._audioTrack.getTrackId()))),l&&r._audioTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(r,r._audioTrack)):(r._videoTrack?r._videoTrack._updateOriginMediaStreamTrack(c):(r._videoTrack=new ta(c,r.uid,r._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(r._videoTrack.getTrackId()))),l&&r._videoTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(r,r._videoTrack)),C("ENABLE_VIDEO_SEI")&&l&&(s==q.VIDEO?await zE(l.receiver,{onSei:p=>{var T;(T=r._videoTrack)===null||T===void 0||T._onSei(p)}}):s==q.AUDIO&&await qE(l.receiver));const u=this.remoteUserMap.get(r);u?u.set(s,d):this.remoteUserMap.set(r,new Map([[s,d]])),this.statsCollector.addRemoteStats(r.uid),this.statsUploader.startUploadInboundStats();const h=this.pendingRemoteTracks.findIndex(p=>{let{user:T,kind:m}=p;return T.uid===r.uid&&s===m});h!==-1&&(this.pendingRemoteTracks.splice(h,1),this.emit(Z.MediaReconnectEnd,r.uid))}}async unsubscribe(t,e,i){const n=this.pendingRemoteTracks.filter(o=>{let{user:a,kind:c}=o;return e!==void 0?a.uid===t.uid&&e===c:a.uid===t.uid});if(n.forEach(o=>{const a=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(a,1)}),this.connection&&this.state===yt.Connected||i||n.forEach(o=>{let{kind:a}=o;var c;if(a===q.AUDIO)(c=t._audioTrack)===null||c===void 0||c._destroy(),t._audioTrack=void 0;else if(a===q.VIDEO){var d;(d=t._videoTrack)===null||d===void 0||d._destroy(),t._videoTrack=void 0}}),!this.connection||this.state!==yt.Connected)return;const r=this.filterTobeUnSubscribedTracks(t,e);if(r.length===0)return;await this.connection.stopReceiving(r.map(o=>{let[,{id:a}]=o;return a}));const s=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),r.forEach(o=>{let[a,{kind:c}]=o;var d,l;if(c===q.VIDEO&&a._videoSSRC&&((d=this.connection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===q.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),i||((l=a._videoTrack)===null||l===void 0||l._destroy(),a._videoTrack=void 0);else if(c===q.AUDIO){var u;this.unbindRemoteTrackEvents(a._audioTrack),!i&&((u=a._audioTrack)===null||u===void 0||u._destroy(),a._audioTrack=void 0)}}),s}async unsubscribeDataChannel(t,e){if(e.forEach(r=>{const s=this.pendingRemoteDataChannels.findIndex(o=>o.id===r.id);s!==-1&&this.pendingRemoteDataChannels.splice(s,1)}),!this.connection)return;const i=this.filterTobeUnSubscribedDataChannels(t,e);if(i.length===0)return;e.forEach(r=>{r._close()});const n=this.remoteDataChannelMap.get(t);return i.forEach(r=>{n&&n.delete(r.id)}),n&&n.size===0&&(this.remoteDataChannelMap.delete(t),await this.connection.stopDataChannels(t.uid)),i.map(r=>r.id)}async massUnsubscribe(t){return this.massUnsubscribeNoLock(t)}async massUnsubscribeNoLock(t){let e=[];for(const{user:r,mediaType:s}of t){const o=this.pendingRemoteTracks.filter(a=>{let{user:c,kind:d}=a;return s!==void 0?c.uid===r.uid&&s===d:c.uid===r.uid});o.forEach(a=>{const c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1)}),e=e.concat(o)}if(!this.connection||this.state!==yt.Connected)return void e.forEach(r=>{let{user:s,kind:o}=r;var a;if(o===q.AUDIO)(a=s._audioTrack)===null||a===void 0||a._destroy(),s._audioTrack=void 0;else if(o===q.VIDEO){var c;(c=s._videoTrack)===null||c===void 0||c._destroy(),s._videoTrack=void 0}});const i=wn(t).call(t,(r,s)=>{let{user:o,mediaType:a}=s;const c=this.filterTobeUnSubscribedTracks(o,a);return r.concat(c)},[]);if(i.length===0)return;await this.connection.stopReceiving(i.map(r=>{let[,{id:s}]=r;return s}));const n=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),i.forEach(r=>{let[s,{kind:o}]=r;var a,c;if(o===q.VIDEO&&s._videoSSRC&&((a=this.connection)===null||a===void 0||a.setStatsRemoteVideoIsReady(s._videoSSRC,!1)),o===q.VIDEO)this.unbindRemoteTrackEvents(s._videoTrack),(c=s._videoTrack)===null||c===void 0||c._destroy(),s._videoTrack=void 0;else if(o===q.AUDIO){var d;this.unbindRemoteTrackEvents(s._audioTrack),(d=s._audioTrack)===null||d===void 0||d._destroy(),s._audioTrack=void 0}}),n}isPreSubScribe(t){return!this.connection||this.state!==yt.Connected?!1:!!this.connection.getPreMedia(t)}async muteRemote(t,e){if(!this.connection)return;const i=this.remoteUserMap.get(t);if(!i)return void _.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!i.get(e))return void _.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const n=e===q.VIDEO?t._videoSSRC:t._audioSSRC;n!==void 0&&this.connection.setStatsRemoteVideoIsReady(n,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.connection)return;const i=this.remoteUserMap.get(t);if(!i)return void _.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."));i.get(e)||_.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}addAudioMetadata(t){const e=this.localTrackMap.get(U.LocalAudioTrack),i=e&&e.track;i&&i.metadata.push(t)}getAllTracks(t){const e=this.localTrackMap.get(U.LocalAudioTrack);if((e==null?void 0:e.track)instanceof Re){const i=e.track;return Array.from(this.localTrackMap.entries()).filter(n=>{let[r]=n;return r!==U.LocalAudioTrack}).filter(n=>{let[r]=n;return!(t&&r===U.LocalVideoLowTrack)}).map(n=>{let[,{track:r}]=n;return r}).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter(i=>{let[n]=i;return!(t&&n===U.LocalVideoLowTrack)}).map(i=>{let[,{track:n}]=i;return n})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(t,e,i,n,r){if(t){const o=this.localTrackMap.get(U.LocalAudioTrack),a=n?this.localTrackMap.get(U.LocalVideoLowTrack):this.localTrackMap.get(U.LocalVideoTrack);Q.publish(this.store.sessionId,{eventElapse:qe.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:o==null?void 0:o.track.getTrackLabel(),videoName:a==null?void 0:a.track.getTrackLabel(),screenshare:(a==null?void 0:a.track._hints.indexOf(xt.SCREEN_TRACK))!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var s;i||(i=[]);const o=i.find(c=>c instanceof ie),a=n?(s=this.localTrackMap.get(U.LocalVideoTrack))===null||s===void 0?void 0:s.track:i.find(c=>c instanceof Gt);Q.publish(this.store.sessionId,{eventElapse:qe.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:o==null?void 0:o.getTrackLabel(),videoName:a==null?void 0:a.getTrackLabel(),screenshare:(a==null?void 0:a._hints.indexOf(xt.SCREEN_TRACK))!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(t,e,i,n){const r=n===q.VIDEO?i._videoSSRC:i._audioSSRC;r&&Q.subscribe(this.store.sessionId,{succ:t,ec:e,video:n===q.VIDEO,audio:n===q.AUDIO,peerid:i.uid,subscribeRequestid:r,p2pid:this.store.p2pId,eventElapse:qe.measureFromSubscribeStart(this.store.clientId,r),preSsrc:this.isPreSubScribe(r)})}reset(){_.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new Ke("P2PChannel-mutex",this.store.clientId),this.connection&&(this.resetConnection(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=Ou(this.store),this.emit(Z.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.statsUploader.stopUploadBaseStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(U.LocalAudioTrack);if((t==null?void 0:t.track)instanceof Re){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach(i=>{e.removeAudioTrack(i)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=yt.Disconnected}getStats(){var t;return(t=this.connection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.connection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(U.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(U.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof Gt||e&&e.track instanceof ie?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}getRemoteMedia(t){var e;const i=Array.from(Fi(e=this.remoteUserMap).call(e)).find(n=>n.uid===t);return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(i=>{let[n]=i;return{uid:n.uid,level:n.audioTrack?100*n.audioTrack._source.getAccurateVolumeLevel():0}});const e=this.localTrackMap.get(U.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=tc(t).call(t,(i,n)=>i.level-n.level),t}async disconnectForReconnect(){this.connection&&(_.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=yt.Reconnecting,C("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var i;e._videoTrack&&e._videoTrack._player&&((i=e._videoTrack._player.getVideoElement())===null||i===void 0||i.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.resetConnection(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=Ou(this.store),this.emit(Z.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[i,{track:n}]=t;switch(i){case U.LocalVideoTrack:B(e=n._hints).call(e,xt.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case U.LocalAudioTrack:n instanceof Re?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case U.LocalVideoLowTrack:}}),this.emit(Z.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;Array.from(Fi(i).call(i)).forEach(n=>{this.setPendingRemoteMedia(e,n)}),this.emit(Z.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(t=>{this.pendingLocalDataChannels.push(t)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(t=>{let[e,i]=t;Array.from(Fi(i).call(i)).forEach(n=>{this.setPendingRemoteDataChannel(e,n)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),_.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(t,e){for(const i of this.pendingRemoteDataChannels){const{user:n,id:r}=i;if((t instanceof rs?t.uid:t)===n.uid&&r===e)return!0}return!1}setPendingRemoteDataChannel(t,e){this.hasPendingRemoteDataChannel(t,e)||this.pendingRemoteDataChannels.push({user:t,id:e})}hasPendingRemoteMedia(t,e){for(const i of this.pendingRemoteTracks){const{user:n,kind:r}=i;if((t instanceof rs?t.uid:t)===n.uid&&e===r)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(t){var e=this;return Qi(function*(){if(!e.connection||e.state!==yt.Connected)return;const i=yield mt(e.mutex.lock("From P2PChannel.restartICE"));let n;try{n=yield mt(e.connection.restartICE(t));const s=yield mt(n.next());if(s.done)return;const o=s.value,a=yield o;switch(Cm(e.connection)&&e.reportPCStats(Date.now(),!1,e._pcStatsUploadType),t){case Je.UDP_TCP_RELAY:e._pcStatsUploadType=wr.UDP_TCP_RESTART;break;case Je.TCP_RELAY:e._pcStatsUploadType=wr.TCP_RESTART;break;case Je.RELAY:e._pcStatsUploadType=wr.RELAY_RESTART;break;default:e._pcStatsUploadType=wr.OLD_RESTART}e._isTryConnecting=!0,n.next(a)}catch(s){var r;(r=n)===null||r===void 0||r.throw(s)}finally{i()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats(),e=this.localTrackMap.get(U.LocalVideoTrack),i=this.localTrackMap.get(U.LocalAudioTrack),n=t.videoSend.find(p=>p.ssrc===(e==null?void 0:e.ssrcs[0].ssrcId)),r=t.audioSend.find(p=>p.ssrc===(i==null?void 0:i.ssrcs[0].ssrcId));if(!n||!r)return 1;const s=xi(this,Z.NeedSignalRTT),o=n?n.rttMs:void 0,a=r?r.rttMs:void 0,c=o&&a?(o+a)/2:o||a,d=(c&&s?(c+s)/2:c||s)||0,l=100*t.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=e==null?void 0:e.track;if(h&&h._encoderConfig&&h._hints.indexOf(xt.SCREEN_TRACK)===-1){const p=h._encoderConfig.bitrateMax,T=t.bitrate.actualEncoded;if(p&&T){const m=(1e3*p-T)/(1e3*p);return Sb[m<.15?0:m<.3?1:m<.45?2:m<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach(i=>{let[n]=i;const r=n._audioSSRC,s=n._videoSSRC,o=t.audioRecv.find(T=>T.ssrc===r),a=t.videoRecv.find(T=>T.ssrc===s);if(!o&&!a)return void(e+=1);const c=xi(this,Z.NeedSignalRTT),d=t.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=o?o.jitterMs:void 0,h=t.recvPacketLossRate;let p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),e+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new G((e,i)=>{this.handleMuteLocalTrack(t,e,i)})}async replaceTrack(t,e){var i;if(_.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(t.getTrackId(),"] to [").concat(e.getTrackId(),"]")),!this.connection||this.state!==yt.Connected)return;const n=Array.from(this.localTrackMap.entries()).find(s=>{let[,{track:o}]=s;return t===o});if(!n)return;const r=n[0];if(t!==e&&(this.unbindLocalTrackEvents([{track:t,type:r}]),this.bindLocalTrackEvents([{track:e,type:r}]),n[1].track=e),await((i=this.connection)===null||i===void 0?void 0:i.replaceTrack(e,n[1].id)),this.isPlanB){const s=n[1];s.id=e._mediaStreamTrack.id,this.localTrackMap.set(r,s)}if(r===U.LocalVideoTrack&&!C("DISABLE_DUAL_STREAM_USE_ENCODING")&&St().supportDualStreamEncoding){const s=this.localTrackMap.get(U.LocalVideoLowTrack);if(s){const o=t._mediaStreamTrack.clone();s.track._originMediaStreamTrack.stop(),s.track._mediaStreamTrack=o,s.track._originMediaStreamTrack=o,await new G((a,c)=>{this.handleReplaceTrack(s.track,a,c,!0)})}}}filterTobePublishedTracks(t,e,i){const n=[],r=this.getAllTracks();t=Go(t=t.filter(c=>r.indexOf(c)===-1));let s,o=!1;const a=this.localTrackMap.get(U.LocalAudioTrack);for(const c of t){if(c instanceof Gt&&(this.localTrackMap.has(U.LocalVideoTrack)||o?new P(S.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:c,type:U.LocalVideoTrack}),o=!0),e)){const d=this.getLowVideoTrack(c,i);n.push({track:d,type:U.LocalVideoLowTrack})}if(c instanceof ie)if(a){const d=a.track;if(d instanceof Re)Rm([c]),d.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0);else{const l=vm([d,c]);_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(l.getTrackId(),"]")),this.replaceTrack(d,l)}}else s instanceof Re?(Rm([c]),s.addAudioTrack(c)):s||!c._useAudioElement&&St().webAudioMediaStreamDest&&!c._bypassWebAudio?s=vm(s?[c,s]:[c]):s=c}return s&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(s.getTrackId(),"]")),n.push({track:s,type:U.LocalAudioTrack})),n}filterTobeUnpublishedTracks(t){const e=[],i=this.getAllTracks();t=Go(t=t.filter(n=>i.indexOf(n)!==-1));for(const n of t){if(n instanceof ie){const r=this.localTrackMap.get(U.LocalAudioTrack);if(!r)continue;r.track instanceof Re?(r.track.removeAudioTrack(n),this.unbindLocalAudioTrackEvents(n),r.track.trackList.length===0&&(e.push([U.LocalAudioTrack,r]),r.track.close())):e.push([U.LocalAudioTrack,r])}if(n instanceof Gt){const r=this.localTrackMap.get(U.LocalVideoTrack);if(!r)continue;e.push([U.LocalVideoTrack,r]);const s=this.localTrackMap.get(U.LocalVideoLowTrack);s&&e.push([U.LocalVideoLowTrack,s])}}return e}filterTobePublishedDataChannels(t){return t=(t=Go(t)).filter(e=>this.localDataChannels.findIndex(i=>i.id===e.id)===-1)}filterTobeUnpublishedDataChannels(t){return t=(t=(t=Go(t)).filter(e=>this.localDataChannels.indexOf(e)!==-1)).filter(e=>e._originDataChannel)}bindLocalTrackEvents(t){t.forEach(e=>{let{track:i,type:n}=e;switch(n){case U.LocalVideoTrack:i.addListener(z.GET_STATS,this.handleGetLocalVideoStats),i.addListener(z.GET_RTC_STATS,this.handleGetRTCStats),i.addListener(z.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(z.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(z.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.addListener(z.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.addListener(z.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.addListener(z.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(z.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case U.LocalAudioTrack:this.bindLocalAudioTrackEvents(i);case U.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof Re?t.trackList.forEach(i=>{i.addListener(z.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(z.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(z.GET_STATS,this.handleGetLocalAudioStats),i.addListener(z.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(z.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(z.GET_STATS,this.handleGetLocalAudioStats),t.addListener(z.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(z.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(z.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(z.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||(t.addListener(z.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(z.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[i,{track:n}]=e;return{track:n,type:i}})),t.forEach(e=>{let{track:i,type:n}=e;switch(n){case U.LocalVideoTrack:i.off(z.GET_STATS,this.handleGetLocalVideoStats),i.off(z.GET_RTC_STATS,this.handleGetRTCStats),i.off(z.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(z.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(z.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.off(z.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.off(z.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.off(z.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(z.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case U.LocalAudioTrack:this.unbindLocalAudioTrackEvents(i);case U.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof Re?t.trackList.forEach(e=>{e.off(z.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(z.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(z.GET_STATS,this.handleGetLocalAudioStats),e.off(z.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(z.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(z.GET_STATS,this.handleGetLocalAudioStats),t.off(z.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(z.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(z.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(z.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),t.off(z.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(z.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof ta&&e.addListener(z.GET_STATS,i=>{i(this.handleGetRemoteVideoStats(t))}),e instanceof ea&&e.addListener(z.GET_STATS,i=>{i(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(z.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;i.has(q.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),i.has(q.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((i,n)=>{var r;let s,o,{track:a,type:c}=i;switch(c){case U.LocalAudioTrack:s=At.Audio,o={dtx:a instanceof eu&&a._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case U.LocalVideoTrack:s=B(r=a._hints).call(r,xt.SCREEN_TRACK)?At.Screen:At.High,o=ar(ar({},Vb(a)),{},{codec:this.store.codec,svc_mode:fu()});break;case U.LocalVideoLowTrack:s=At.Low,o=ar(ar({},Vb(a)),{},{codec:this.store.codec,svc_mode:fu()})}return{stream_type:s,attributes:o,ssrcs:e[n]}})}createGatewayUnpublishMessage(t){return t.map(e=>{var i;let n,[r,{track:s,ssrcs:o,id:a}]=e;switch(r){case U.LocalVideoTrack:n=B(i=s._hints).call(i,xt.SCREEN_TRACK)?At.Screen:At.High;break;case U.LocalAudioTrack:n=At.Audio;break;case U.LocalVideoLowTrack:n=At.Low}return{stream_type:n,ssrcs:o,mid:a}})}assignLocalTracks(t,e){t.forEach((i,n)=>{let{track:r,type:s}=i;this.localTrackMap.set(s,{track:r,id:e[n].id,ssrcs:e[n].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[i]=e;this.localTrackMap.delete(i)})}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{if(_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(Z.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(this._restartTimer&&(window.clearTimeout(this._restartTimer),this._restartTimer=void 0),t instanceof Dr&&xw(t,!0),this._isTryConnecting&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isTryConnecting=!1,this._isStartRestartIce=!1,this._pcStatsUploadType=wr.DISCONNECTED_OR_FAILED,xi(this,Z.QueryClientConnectionState)==="CONNECTED"&&this._isWaitPcToRePub)){const i=this.pendingLocalTracks.map(r=>r.getTrackId()),n=this.pendingLocalDataChannels.map(r=>"dc_".concat(r.id));Q.reportApiInvoke(this.store.sessionId,{name:fe.REPUB_AFTER_PC_CONNECTED,options:i.concat(n),tag:Qt.TRACER}).onSuccess(),this.republish()}if(C("NEW_ICE_RESTART")&&t instanceof Dr&&!te()&&!this._forceTurn){if(B(Db).call(Db,e)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const i=r=>{Cm(t)&&(_.debug("[".concat(this.store.clientId,"] [P2PChannel] try to restartICE, type is ").concat(r)),xi(this,Z.QueryClientConnectionState)==="CONNECTED"&&this.emit(Z.RequestRestartICE,r))},n=()=>{Cm(t)&&(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),_.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(Z.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())};return void(this._restartTimer=window.setTimeout(()=>{Vw(t,i,n)},800))}}else{if(e==="disconnected"&&t.iceConnectionState==="disconnected")return setTimeout(()=>{t.iceConnectionState==="disconnected"&&C("ICE_RESTART")&&xi(this,Z.QueryClientConnectionState)==="CONNECTED"&&this.emit(Z.RequestRestartICE)},800),void setTimeout(()=>{t.peerConnectionState==="disconnected"&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isTryConnecting=!1,setTimeout(()=>this.emit(Z.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);e==="failed"&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),setTimeout(()=>this.emit(Z.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),Q.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:Qt.TRACER}).onSuccess(),this.emit(Z.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var i;const n=Array.from(Fi(i=this.remoteUserMap).call(i)).find(s=>s._audioSSRC===e);var r;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),(r=n.audioTrack)===null||r===void 0||r.emit(Jo.FIRST_FRAME_DECODED),Q.firstRemoteFrame(this.store.sessionId,ye.FIRST_AUDIO_DECODE,Ht.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:qe.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var i;const n=Array.from(Fi(i=this.remoteUserMap).call(i)).find(r=>r._audioSSRC===e);n&&Q.firstRemoteFrame(this.store.sessionId,ye.FIRST_AUDIO_RECEIVED,Ht.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:qe.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,i,n)=>{this.reportVideoFirstFrameDecoded(e,i,n)},t.onFirstVideoReceived=e=>{var i;const n=Array.from(Fi(i=this.remoteUserMap).call(i)).find(r=>r._videoSSRC===e);n&&Q.firstRemoteFrame(this.store.sessionId,ye.FIRST_VIDEO_RECEIVED,Ht.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:qe.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,i)=>{const n=e.candidateType==="relay",r=i.candidateType==="relay";i.candidateType!=="unknown"&&n===r||this.emit(Z.ConnectionTypeChange,n),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(es(i))," -> ").concat(JSON.stringify(es(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,i)=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(es(i))," -> ").concat(JSON.stringify(es(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.getLocalVideoStats=()=>{const e=this.statsCollector.getLocalVideoTrackStats(),i=this.statsCollector.getRTCStats();return ar(ar({},e),i)},t.onICECandidateError=e=>{this._iceError=e}}resetConnection(t){t instanceof Dr&&function(e){ma.delete(e.id),xw(e)}(t),t.close(),this.emit(Z.PeerConnectionStateChange,"closed"),function(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.getLocalVideoStats=void 0}(t),this._isWaitPcToRePub=!1}filterTobeMutedTracks(t){const e=[];if(this.getAllTracks().indexOf(t)===-1)return e;const i=this.localTrackMap.get(U.LocalAudioTrack);if(t instanceof ie&&(i==null?void 0:i.track)instanceof Re)return i.track.isActive||e.push([U.LocalAudioTrack,i]),e;const n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:s}]=r;return t===s});if(n&&(e.push(n),n[0]===U.LocalVideoTrack)){const r=this.localTrackMap.get(U.LocalVideoLowTrack);r&&e.push([U.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(t){const e=[],i=this.localTrackMap.get(U.LocalAudioTrack);if(t instanceof ie&&(i==null?void 0:i.track)instanceof Re)return i.track.isActive&&e.push([U.LocalAudioTrack,i]),e;const n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:s}]=r;return t===s});if(n)if(n[0]===U.LocalVideoTrack){e.push(n);const r=this.localTrackMap.get(U.LocalVideoLowTrack);r&&e.push([U.LocalVideoLowTrack,r])}else e.push(n);return e}createMuteMessage(t){return t.map(e=>{var i;let n,[r,{track:s,ssrcs:o,id:a}]=e;switch(r){case U.LocalAudioTrack:n=At.Audio;break;case U.LocalVideoTrack:n=B(i=s._hints).call(i,xt.SCREEN_TRACK)?At.Screen:At.High;break;case U.LocalVideoLowTrack:n=At.Low}return{stream_type:n,ssrcs:o,mid:a}})}createUnmuteMessage(t){return t.map(e=>{var i;let n,[r,{track:s,ssrcs:o,id:a}]=e;switch(r){case U.LocalAudioTrack:n=At.Audio;break;case U.LocalVideoTrack:n=B(i=s._hints).call(i,xt.SCREEN_TRACK)?At.Screen:At.High;break;case U.LocalVideoLowTrack:n=At.Low}return{stream_type:n,ssrcs:o,mid:a}})}filterTobeUnSubscribedTracks(t,e){const i=[],n=this.remoteUserMap.get(t);if(!n)return i;if(e){const r=n.get(e);if(!r)return i;i.push([t,{kind:e,id:r}])}else Array.from(n.entries()).forEach(r=>{let[s,o]=r;i.push([t,{kind:s,id:o}])});return i}filterTobeUnSubscribedDataChannels(t,e){const i=[];return e.forEach(n=>{var r;(r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.has(n.id)&&i.push(n)}),i}createUnsubscribeMessage(t){const e=[];return t.forEach(i=>{let[n,{kind:r,id:s}]=i;switch(r){case q.VIDEO:return void(n._videoSSRC&&e.push({stream_type:q.VIDEO,ssrcId:n._videoSSRC}));case q.AUDIO:return void(n._audioSSRC&&e.push({stream_type:q.AUDIO,ssrcId:n._audioSSRC}))}}),e}createUnsubscribeAllMessage(t){const e=new Map;return t.forEach(i=>{let[n,{kind:r}]=i;if(e.has(n)){let s=e.get(n);r===q.VIDEO?s|=Ae.Video:s|=Ae.Audio,e.set(n,s)}else r===q.VIDEO?e.set(n,Ae.Video):e.set(n,Ae.Audio)}),{users:Array.from(e.entries()).map(i=>{let[n,r]=i;return{stream_id:n.uid,stream_type:r}})}}withdrawRemoteTracks(t){t.forEach(e=>{let[i,{kind:n}]=e;const r=this.remoteUserMap.get(i);r&&(r.delete(n),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(i))})}async updateBitrateLimit(t){const e=this.localTrackMap.get(U.LocalVideoTrack),i=this.localTrackMap.get(U.LocalVideoLowTrack);e&&(await e.track.setBitrateLimit(t.uplink),await new G((n,r)=>{this.handleUpdateVideoEncoder(e.track,n,r,!0)})),i&&t.low_stream_uplink&&(await i.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0}),await new G((n,r)=>{this.handleUpdateVideoEncoder(i.track,n,r,!0)}))}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(t,e,i){return t.map((n,r)=>{var s;let{stream_type:o}=n;const a=(s=e.find(c=>{let{stream_type:d}=c;return o===d}))===null||s===void 0?void 0:s.attributes;if(a&&C("DISABLE_SCREEN_SHARE_REMB")){const c=i[r]._hints;(B(c).call(c,xt.SCREEN_TRACK)||B(c).call(c,xt.SCREEN_LOW_TRACK))&&(a.remb=!1,_.debug("disable remb for screen share, hints:",c))}return a})}async tryToUnmuteAudio(t){for(let i=0;i<t.length;i++)if(t[i]instanceof ie){var e;const n=this.filterTobeUnmutedTracks(t[i]);if(n.length===0)continue;await((e=this.connection)===null||e===void 0?void 0:e.unmuteLocal(n.map(s=>{let[,{id:o}]=s;return o})));const r=this.createUnmuteMessage(n);return void await Mt(this,Z.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.connection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(Z.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(Z.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks(),this.statsUploader.requestTransportStats=()=>{var t;return{connectState:((t=this.connection)===null||t===void 0?void 0:t.peerConnectionState)||"closed"}}}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await ke(mE(this.dtlsFailedCount,ge)),this.emit(Z.RequestReconnect)}async reconnectP2P(){const t=Array.from(this.localTrackMap.entries()),e=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),e.length>0&&await Be(this,Z.RequestUnpublishForReconnectPC,e),this.disconnectForReconnect(),this.emit(Z.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(U.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof Gt)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof Gt).length>1)throw new P(S.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof ie).length>1&&(t.some(e=>e instanceof ie&&e._bypassWebAudio)||!St().webAudioMediaStreamDest))throw new P(S.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof Gt&&this.pendingLocalTracks.some(i=>i instanceof Gt))throw new P(S.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof ie&&this.pendingLocalTracks.some(i=>i instanceof ie)&&(!St().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(i=>i instanceof ie&&i._bypassWebAudio)))throw new P(S.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){var i;const n=!C("DISABLE_DUAL_STREAM_USE_ENCODING")&&St().supportDualStreamEncoding,r=ar(ar({},{width:160,height:120,framerate:15,bitrate:50}),e);let s;s=n?t._mediaStreamTrack.clone():Im(t,r);const o=Ut(8,"track-low-"),a=new Gt(s,ar(ar({},n&&{scaleResolutionDownBy:om(r,t)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,o);return a.on(Us.TRANSCEIVER_UPDATED,c=>{t._updateRtpTransceiver(c,qo.LOW_STREAM)}),a._hints.push(xt.LOW_STREAM),B(i=t._hints).call(i,xt.SCREEN_TRACK)&&a._hints.push(xt.SCREEN_LOW_TRACK),t.on("sei-to-send",c=>{a.emit("sei-to-send",c)}),t.addListener(z.NEED_CLOSE,()=>{a.close()}),a}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(t,e,i){let n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof Dr){var r,s,o,a;const c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:d,dtlsTransportState:l,peerConnectionState:u}=this.connection,{local:h,remote:p}=await this.connection.getSelectedCandidatePair();Q.pcStats(this.store.sessionId,{startTime:c,eventElapse:t-c||0,iceconnectionsate:d,dtlsstate:l,connectionstate:u,intSucc:e?1:2,error:this._iceError||n||"",selectedLocalCandidateProtocol:(r=h==null?void 0:h.protocol)!==null&&r!==void 0?r:"",selectedLocalCandidateType:(s=h.candidateType)!==null&&s!==void 0?s:"",selectedLocalCandidateAddress:"".concat(h.address,":").concat(h.port),selectedRemoteCandidateProtocol:(o=p.protocol)!==null&&o!==void 0?o:"",selectedRemoteCandidateType:(a=p.candidateType)!==null&&a!==void 0?a:"",selectedRemoteCandidateAddress:"".concat(p.address,":").concat(p.port),restartCnt:i,preallocation:this.connection.isPreallocation}),this._iceError=null}}reportVideoFirstFrameDecoded(t,e,i,n){var r;const s=Array.from(Fi(r=this.remoteUserMap).call(r)).find(o=>o._videoSSRC===t);if(s){n||this.store.subscribe(s.uid,"video",void 0,void 0,void 0,void 0,Date.now());const o=this.store.keyMetrics,a=o.subscribe.find(c=>c.userId===s.uid&&c.type==="video");Q.firstRemoteVideoDecode(this.store.sessionId,ye.FIRST_VIDEO_DECODE,Ht.FIRST_VIDEO_DECODE,{peer:s._uintid,videowidth:e,videoheight:i,subscribeElapse:qe.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:o.requestAPEnd||0,apStart:o.requestAPStart||0,joinGwEnd:o.joinGatewayEnd||0,joinGwStart:o.joinGatewayStart||0,pcEnd:o.peerConnectionEnd||0,pcStart:o.peerConnectionStart||0,subscriberEnd:(a==null?void 0:a.subscribeEnd)||0,subscriberStart:(a==null?void 0:a.subscribeStart)||0,videoAddNotify:(a==null?void 0:a.streamAdded)||0,state:n?1:0,firstFrame:(a==null?void 0:a.firstFrame)||0})}}async remoteMediaSsrcChanged(t,e,i){if(!this.connection)return!1;const n=this.remoteUserMap.get(t);if(!n)return!1;const r=n.get(e);if(!r)return!1;const s=await this.connection.getRemoteSSRC(r);return s!==void 0&&s!==i}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:i}]=t;e===U.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,qo.LOW_STREAM):i._updateRtpTransceiver(void 0)})}},J(ct.prototype,"startP2PConnection",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"startP2PConnection"),ct.prototype),J(ct.prototype,"connect",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"connect"),ct.prototype),J(ct.prototype,"updateRemoteRTPCapabilities",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"updateRemoteRTPCapabilities"),ct.prototype),J(ct.prototype,"publishDataChannel",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"publishDataChannel"),ct.prototype),J(ct.prototype,"unpublish",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"unpublish"),ct.prototype),J(ct.prototype,"unpublishDataChannel",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"unpublishDataChannel"),ct.prototype),J(ct.prototype,"unpublishLowStream",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"unpublishLowStream"),ct.prototype),J(ct.prototype,"subscribeDataChannel",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"subscribeDataChannel"),ct.prototype),J(ct.prototype,"subscribe",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"subscribe"),ct.prototype),J(ct.prototype,"massSubscribe",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"massSubscribe"),ct.prototype),J(ct.prototype,"unsubscribe",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"unsubscribe"),ct.prototype),J(ct.prototype,"unsubscribeDataChannel",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"unsubscribeDataChannel"),ct.prototype),J(ct.prototype,"massUnsubscribe",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"massUnsubscribe"),ct.prototype),J(ct.prototype,"muteRemote",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"muteRemote"),ct.prototype),J(ct.prototype,"unmuteRemote",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"unmuteRemote"),ct.prototype),J(ct.prototype,"hasRemoteMediaWithLock",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"hasRemoteMediaWithLock"),ct.prototype),J(ct.prototype,"disconnectForReconnect",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"disconnectForReconnect"),ct.prototype),J(ct.prototype,"updateBitrateLimit",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"updateBitrateLimit"),ct.prototype),J(ct.prototype,"remoteMediaSsrcChanged",[$e],Object.getOwnPropertyDescriptor(ct.prototype,"remoteMediaSsrcChanged"),ct.prototype),ct);function $e(t,e,i){const n=t[e];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const r=this.mutex,s=await r.lock("From P2PChannel.".concat(e));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{s()}},i}function jw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Gw(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?jw(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):jw(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}const OW=Date.now(),Am=new Map,Mu=new Map;async function Ww(t){const e=Am.get(t),i=Array.isArray(e)&&e[e.length-1],n=Mu.get(t);if(!i)return void(n.isSyncing=!1);const r={uid:i.uid,payload:i.payload};n.firstRecvTs===0&&(n.firstRecvTs=i.recvTs,n.firstSendTs=i.sendTs);const s=i.sendTs-n.firstSendTs,o=s-(Date.now()-n.firstRecvTs);o>0&&(n.firstRecvTs=Date.now()-s);let a=i.mediaDelay+o;a<=0?(e.pop(),Hw(i.context,r),a=0):a=Math.min(a,20),setTimeout(()=>e.length&&Ww(t),a)}function Hw(t,e){t.safeEmit(dt.STREAM_MESSAGE,e.uid,e.payload),t.onStreamMessage&&t.onStreamMessage(e)}function NW(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(!t.syncWithAudio)return Hw(i,{uid:t.uid,payload:t.payload});const n="".concat(i.id,"-").concat(t.uid),r=Am.get(n)||[],s=r.findIndex(d=>t.sendTs>=d.sendTs),o=Gw(Gw({},t),{},{context:i,mediaDelay:e,recvTs:Date.now()});s===-1?r.push(o):r.splice(s,0,o),Am.set(n,r);let a=!1;var c;Mu.has(n)?a=!((c=Mu.get(n))===null||c===void 0||!c.isSyncing):Mu.set(n,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||Ww(n)}const DW=Tt().name;function Kw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Yw(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?Kw(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Kw(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}const fa="websdk_ng_cache_parameter",PW=C("MAX_PRELOAD_ASYNC_LENGTH"),zs=new Map,Js=[];let bm=null,wm=0,Om=0;const Uu=new Map,LW=function(t,e){const i=[];let n=0;const r=async()=>{const s=i.shift();s&&await s(),i.length>0&&n<e?r():n--};return async function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return new G(async(c,d)=>{i.push(async()=>{try{const l=await t(...o);c(l)}catch(l){d(l)}}),n<e&&(n++,r())})}}(qw,PW),Nm=li.CancelToken.source();async function qw(t,e,i,n,r,s){try{if(!C("ENABLE_PRELOAD"))return;if(!St().supportWebCrypto)return void Xr(()=>{_.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!i&&i!==null)throw new P(S.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));i&&Le(i,"token",1,2047),Le(t,"appid",1,2047),hu(e),n&&pu(n);const o=ks();_.debug("preload channel ".concat(e,", uid is ").concat(n));const a={appId:t,cname:e,token:i||t,uid:typeof n!="string"?n:null,sid:o,proxyServer:r};let c,d;typeof n=="string"?(a.stringUid=n,[d,c]=await G.all([mW(n,{sid:o,appId:t},Nm.token),Ew(Yw(Yw({},a),{},{token:i||t,uid:0}),Nm.token)]),a.uid=d.uid,c.gatewayInfo.uid=a.uid,c.gatewayInfo.res.uid=a.uid):(s&&(a.stringUid=s),c=await Ew(a,Nm.token));const l={sid:o,appId:t,cname:e,token:i||t,uid:a.stringUid||n,intUid:a.uid||c.gatewayInfo.uid,stringUid:a.stringUid,ts:Date.now(),sua:d,ap:c};await async function(u){let h;try{u.uid&&Jw({appId:u.appId,cname:u.cname,token:u.token,uid:u.uid,stringUid:u.stringUid});const p=$w(u),T=await async function(f,R){try{const v=await window.crypto.subtle.importKey("raw",HI(R),"AES-GCM",!1,["encrypt"]),A=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},v,Ls(window.btoa(JSON.stringify(f))));return Qr(new Uint8Array(A))}catch{return}}(u,u.token||u.appId);if(!T)return;h=Zw(fa);const m=h?JSON.parse(h):[];m.push({[p]:T}),m.length>C("AP_CACHE_NUM")&&m.shift(),xu(fa,JSON.stringify(m))}catch(p){_.warn("Error caching server parameters:",p.message),xu(fa,"")}}(l),wm++}catch(o){throw Om++,function(a){bm||(bm=window.setTimeout(()=>{let d="";Uu.forEach((l,u)=>{d+="".concat(u,": ").concat(l," ;")}),Q.reportApiInvoke(null,{name:fe.PRELOAD,options:{success:wm,failed:Om,err:d}}).onError(a),wm=0,Om=0,Uu.clear(),bm=null},1e4));const c=Uu.get(a.code)||0;Uu.set(a.code,c+1)}(o),o}}async function zw(t){try{if(C("AP_REQUEST_DETAIL")||C("ENABLE_ROLE_SELECT_EDGE"))return;const e=Jw(t);if(!e||t.cloudProxyServer!=="disabled")return;const i=await async function(n,r){try{const s=await window.crypto.subtle.importKey("raw",HI(r),"AES-GCM",!1,["decrypt"]),o=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},s,Ls(n));return JSON.parse(window.atob(Qr(new Uint8Array(o))))}catch{return}}(e,t.token||t.appId);if(!i||!function(n,r){return n.cname===r.cname&&n.appId===r.appId&&n.token===r.token?r.stringUid?n.stringUid===r.stringUid:typeof r.uid=="number"?n.uid===r.uid:n.uid==r.uid:!1}(i,t))return;if(i&&Date.now()-i.ts<C("AP_CACHE_LIFETIME"))return i}catch(e){_.warn("Error get preloadInfo",e.message)}}function Jw(t){let e;try{if(e=Zw(fa),!e)return;const i=JSON.parse(e),n=$w(t),r=function(o,a){for(let c=o.length-1;c>=0;c--)if(a(o[c]))return c;return-1}(i,o=>n in o);if(r===-1)return;const s=i.splice(r,1)[0];return xu(fa,JSON.stringify(i)),s[n]}catch(i){_.warn("Error delete preload info: ".concat(e),i.message),xu(fa,"")}}function Dm(t){if(t){let e=zs.get(t);e&&(window.clearTimeout(e),e=null,zs.delete(t)),B(Js).call(Js,t)||t.cloudProxyServer!=="disabled"||Js.push(t)}if(zs.size<C("AP_CACHE_NUM")&&Js.length>0){const e=Js.shift();zs.set(e,window.setTimeout(async()=>{const{appId:i,cname:n,token:r,stringUid:s,uid:o,proxyServer:a}=e;try{await LW(i,n,r,o,a,s),zs.has(e)&&Dm(e)}catch(c){_.warn("update preload failed",c.message),Xw(e)}},C("AP_UPDATE_INTERVAL")))}}function Xw(t){const e=Js.indexOf(t);e!==-1&&Js.splice(e,1);let i=zs.get(t);i&&(window.clearTimeout(i),i=null,zs.delete(t),Dm())}function Qw(t,e){const i=t.sua,n=t.ap;e&&i&&Q.reqUserAccount(t.sid,{lts:i.requestTime,elapse:i.elapse,success:!0,serverAddr:i.url,stringUid:e,uid:t.intUid,errorCode:null,extend:i.req}),Q.reportResourceTiming(t.ap.url,t.sid),Q.joinWebProxyAP(t.sid,{lts:n.requestTime,elapse:n.elapse,sucess:1,apServerAddr:n.url,turnServerAddrList:n.proxyInfo.addresses.map(r=>r.ip).join(","),eventType:"disabled",unilbsServerIds:[he.CHOOSE_SERVER,he.CLOUD_PROXY_FALLBACK].toString()}),Q.joinChooseServer(t.sid,{lts:n.requestTime,elapse:n.elapse,succ:!0,csAddr:n.url,opid:n.opid,serverList:n.gatewayInfo.gatewayAddrs.map(r=>r.address),ec:null,cid:n.gatewayInfo.cid.toString(),uid:n.gatewayInfo.uid.toString(),csIp:n.gatewayInfo.csIp,unilbsServerIds:[he.CHOOSE_SERVER].toString(),isHttp3:n.isHttp3})}function Zw(t){return window.atob(window.localStorage.getItem(t)||"")}function xu(t,e){window.localStorage.setItem(t,window.btoa(e))}function $w(t){let e="".concat(t.appId,"_").concat(t.cname);return typeof t.uid=="string"&&(e+="_s_".concat(t.uid)),typeof t.uid=="number"&&(e+="_".concat(t.uid)),t.token&&(e+="_".concat(t.token)),QI(e)}function kW(t){let e=function(){const i=xW.pop();return i?(i.offset=i.limit=0,i):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(i,n){let r=i.appId;r!==void 0&&(Ee(n,10),os(n,r));let s=i.cid;s!==void 0&&(Ee(n,16),Ee(n,s));let o=i.cname;o!==void 0&&(Ee(n,26),os(n,o));let a=i.deviceId;a!==void 0&&(Ee(n,34),os(n,a));let c=i.elapse;c!==void 0&&(Ee(n,40),as(n,c));let d=i.fileSize;d!==void 0&&(Ee(n,48),as(n,ga(d)));let l=i.height;l!==void 0&&(Ee(n,56),as(n,ga(l)));let u=i.jpg;u!==void 0&&(Ee(n,66),Ee(n,u.length),eO(n,u));let h=i.networkType;h!==void 0&&(Ee(n,72),as(n,ga(h)));let p=i.osType;p!==void 0&&(Ee(n,80),as(n,ga(p)));let T=i.requestId;T!==void 0&&(Ee(n,90),os(n,T));let m=i.sdkVersion;m!==void 0&&(Ee(n,98),os(n,m));let f=i.sequence;f!==void 0&&(Ee(n,104),as(n,ga(f)));let R=i.sid;R!==void 0&&(Ee(n,114),os(n,R));let v=i.timestamp;v!==void 0&&(Ee(n,120),as(n,v));let A=i.uid;A!==void 0&&(Ee(n,128),Ee(n,A));let O=i.vid;O!==void 0&&(Ee(n,136),Ee(n,O));let w=i.width;w!==void 0&&(Ee(n,144),as(n,ga(w)));let b=i.service;b!==void 0&&(Ee(n,152),Ee(n,b));let L=i.callbackData;L!==void 0&&(Ee(n,162),Ee(n,L.length),eO(n,L));let x=i.ticket;x!==void 0&&(Ee(n,170),os(n,x));let W=i.vendorConfigs;W!==void 0&&(Ee(n,178),os(n,W))}(t,e),function(i){let n=i.bytes,r=i.limit;return n.length===r?n:n.subarray(0,r)}(e)}function MW(t){return function(i){let n={};t:for(;!VW(i);){let r=Mc(i);switch(r>>>3){case 0:break t;case 1:n.code=Mc(i);break;case 2:n.msg=iO(i,Mc(i));break;case 3:n.requestId=iO(i,Mc(i));break;case 4:n.timestamp=FW(i,!1);break;default:UW(i,7&r)}}return n}({bytes:e=t,offset:0,limit:e.length});var e}function UW(t,e){switch(e){case 0:for(;128&Cn(t););break;case 2:Pm(t,Mc(t));break;case 5:Pm(t,4);break;case 1:Pm(t,8);break;default:throw new Error("Unimplemented type: "+e)}}function ga(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let xW=[];function Pm(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function VW(t){return t.offset>=t.limit}function Vu(t,e){let i=t.bytes,n=t.offset,r=t.limit,s=n+e;if(s>i.length){let o=new Uint8Array(2*s);o.set(i),t.bytes=o}return t.offset=s,s>r&&(t.limit=s),n}function tO(t,e){let i=t.offset;if(i+e>t.limit)throw new Error("Read past limit");return t.offset+=e,i}function eO(t,e){let i=Vu(t,e.length);t.bytes.set(e,i)}function iO(t,e){let i=tO(t,e),n=String.fromCharCode,r=t.bytes,s="�",o="";for(let a=0;a<e;a++){let c,d,l,u,h=r[a+i];128&h?(224&h)==192?a+1>=e?o+=s:(c=r[a+i+1],(192&c)!=128?o+=s:(u=(31&h)<<6|63&c,u<128?o+=s:(o+=n(u),a++))):(240&h)==224?a+2>=e?o+=s:(c=r[a+i+1],d=r[a+i+2],(49344&(c|d<<8))!=32896?o+=s:(u=(15&h)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?o+=s:(o+=n(u),a+=2))):(248&h)==240?a+3>=e?o+=s:(c=r[a+i+1],d=r[a+i+2],l=r[a+i+3],(12632256&(c|d<<8|l<<16))!=8421504?o+=s:(u=(7&h)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?o+=s:(u-=65536,o+=n(55296+(u>>10),56320+(1023&u)),a+=3))):o+=s:o+=n(h)}return o}function os(t,e){let i=e.length,n=0;for(let o=0;o<i;o++){let a=e.charCodeAt(o);a>=55296&&a<=56319&&o+1<i&&(a=(a<<10)+e.charCodeAt(++o)-56613888),n+=a<128?1:a<2048?2:a<65536?3:4}Ee(t,n);let r=Vu(t,n),s=t.bytes;for(let o=0;o<i;o++){let a=e.charCodeAt(o);a>=55296&&a<=56319&&o+1<i&&(a=(a<<10)+e.charCodeAt(++o)-56613888),a<128?s[r++]=a:(a<2048?s[r++]=a>>6&31|192:(a<65536?s[r++]=a>>12&15|224:(s[r++]=a>>18&7|240,s[r++]=a>>12&63|128),s[r++]=a>>6&63|128),s[r++]=63&a|128)}}function Cn(t){return t.bytes[tO(t,1)]}function nO(t,e){let i=Vu(t,1);t.bytes[i]=e}function Mc(t){let e,i=0,n=0;do e=Cn(t),i<32&&(n|=(127&e)<<i),i+=7;while(128&e);return n}function Ee(t,e){for(e>>>=0;e>=128;)nO(t,127&e|128),e>>>=7;nO(t,e)}function FW(t,e){let i,n=0,r=0,s=0;return i=Cn(t),n=127&i,128&i&&(i=Cn(t),n|=(127&i)<<7,128&i&&(i=Cn(t),n|=(127&i)<<14,128&i&&(i=Cn(t),n|=(127&i)<<21,128&i&&(i=Cn(t),r=127&i,128&i&&(i=Cn(t),r|=(127&i)<<7,128&i&&(i=Cn(t),r|=(127&i)<<14,128&i&&(i=Cn(t),r|=(127&i)<<21,128&i&&(i=Cn(t),s=127&i,128&i&&(i=Cn(t),s|=(127&i)<<7))))))))),{low:n|r<<28,high:r>>>4|s<<24,unsigned:e}}function as(t,e){let i=e.low>>>0,n=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,s=r===0?n===0?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:r<128?9:10,o=Vu(t,s),a=t.bytes;switch(s){case 10:a[o+9]=r>>>7&1;case 9:a[o+8]=s!==9?128|r:127&r;case 8:a[o+7]=s!==8?n>>>21|128:n>>>21&127;case 7:a[o+6]=s!==7?n>>>14|128:n>>>14&127;case 6:a[o+5]=s!==6?n>>>7|128:n>>>7&127;case 5:a[o+4]=s!==5?128|n:127&n;case 4:a[o+3]=s!==4?i>>>21|128:i>>>21&127;case 3:a[o+2]=s!==3?i>>>14|128:i>>>14&127;case 2:a[o+1]=s!==2?i>>>7|128:i>>>7&127;case 1:a[o]=s!==1?128|i:127&i}}const rO={},sO={},oO=4294967296,BW=18446744073709552e3,aO=BW/2;dO(0,!0);const cO=dO(0),jW=Uc(0,-2147483648,!1),GW=Uc(-1,2147483647,!1);function dO(t,e){let i,n,r;return e?(r=0<=(t>>>=0)&&t<256)&&(n=sO[t],n)?n:(i=Uc(t,0,!0),r&&(sO[t]=i),i):(r=-128<=(t|=0)&&t<128)&&(n=rO[t],n)?n:(i=Uc(t,t<0?-1:0,!1),r&&(rO[t]=i),i)}function Uc(t,e,i){return{low:0|t,high:0|e,unsigned:!!i}}function lO(t,e){if(isNaN(t))return cO;{if(t<=-aO)return jW;if(t+1>=aO)return GW}return t<0?cO:Uc(t%oO|0,t/oO|0,e)}function uO(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}class Lm extends qt{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const i=this._connectionState;this._connectionState=e,this.emit(Bn.CONNECTION_STATE_CHANGE,e,i)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(e){var i;super(),g(this,"name","AgoraRTCImageModeration"),g(this,"_connectionState",en.CONNECTING),g(this,"_sequence",0),g(this,"_moderationStartTime",void 0),g(this,"_workerConnection",void 0),g(this,"_workerMessageLengthLimit",void 0),g(this,"_qualityRatio",void 0),g(this,"_connectInfo",void 0),g(this,"_cancelTokenSource",li.CancelToken.source()),g(this,"_retryConfig",void 0),g(this,"_moderationInterval",void 0),g(this,"_moderationTimer",null),g(this,"_moderationMode",1),g(this,"_quality",1),g(this,"_qualityTimer",null),g(this,"_ticket",void 0),g(this,"_moderationIntervalMinimum",void 0),g(this,"_uploadFailedNum",0),g(this,"_uploadNum",0),g(this,"_uploadTimer",null),g(this,"_extraInfo",void 0),g(this,"_vendor",""),g(this,"_encoder",new TextEncoder),g(this,"_moderationId",void 0),g(this,"inspectImage",()=>{if(this.connectionState!==en.CONNECTED)throw new D(S.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===en.CONNECTED?this.requestToInspectImage():_.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=Ut(5,"image-moderation-"),this._workerMessageLengthLimit=C("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=C("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(i=e.interval)!==null&&i!==void 0?i:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=C("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Ac("worker-"+this._moderationId,ge),this.on(Bn.STATE_CHANGE,(n,r)=>{_.debug("[".concat(this._moderationId,"] Moderation operation :").concat(oa[n]," ").concat(r||""))}),this.handleWorkerEvents()}async init(e,i){this.emit(Bn.STATE_CHANGE,oa.CONNECT_AP),this._connectInfo=e;const n=this._cancelTokenSource.token;return this._retryConfig=i,new G((r,s)=>{this.on(Bn.CONNECTION_STATE_CHANGE,(o,a)=>{o===en.CONNECTED&&r()}),this.requestAP(e,n,i).then(o=>{this.connectWorker(o)}).catch(o=>{s(o)})})}updateConfig(e){var i;this._moderationInterval=(i=e.interval)!==null&&i!==void 0?i:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),_.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===en.CONNECTED&&this.inspectImage()}async requestAP(e,i,n){const r=C("WEBCS_DOMAIN").map(c=>"https://".concat(c,"/api/v1")),s=await function(c,d,l,u){let{appId:h,areaCode:p,cname:T,sid:m,token:f,uid:R}=d;pa++;const v="moderation_plugin",A={service_name:v,json_body:JSON.stringify({appId:h,areaCode:p,cname:T,command:"allocateEdge",requestId:pa,seq:pa,sid:m,appToken:f,ts:Date.now(),uid:R+""})};let O,w,b=c[0];return Un(async()=>{O=Date.now();const L=await jn(b,{data:A,cancelToken:l,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(w=Date.now()-O,L.code!==0){const K=new D(S.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+L.code,{retry:!0,responseTime:w});throw _.error(K.toString()),K}const x=JSON.parse(L.json_body);if(x.code!==200){const K=new D(S.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(x.code,", reason: ").concat(x.reason),{code:x.code,responseTime:w});throw _.error(K.toString()),K}if(!x.servers||!Array.isArray(x.servers)||x.servers.length===0){const K=new D(S.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:x.code,responseTime:w});throw _.error(K.toString()),K}if(!x.servers.some(K=>!!K.wss)){const K=new D(S.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:x.code,responseTime:w});throw _.error(K.toString()),K}const W=C("IMAGE_MODERATION_WORKER_HOST");return{addressList:x.servers.map(K=>{let{address:ht,wss:pt}=K;if(ht&&pt)return"wss://".concat(ht.replace(/\./g,"-"),".").concat(W,":").concat(pt,"/moderation")}).filter(K=>!!K),workerToken:x.workerToken,vid:x.vid,ticket:x.appTicket,responseTime:w}},(L,x)=>(Q.apworkerEvent(m,{success:!0,sc:200,serviceName:v,responseDetail:JSON.stringify(L.addressList),firstSuccess:x===0,responseTime:w,serverIp:c[x%c.length]}),!1),(L,x)=>(Q.apworkerEvent(m,{success:!1,sc:L.data&&L.data.code||200,serviceName:v,responseTime:w,serverIp:c[x%c.length]}),!!(L.code!==S.OPERATION_ABORTED&&L.code!==S.UNEXPECTED_RESPONSE||L.data&&L.data.retry)&&(b=c[(x+1)%c.length],!0)),u)}(r,e,i,n);this.emit(Bn.STATE_CHANGE,oa.AP_CONNECTED);const{addressList:o,ticket:a}=s;return this._ticket=a,o}async connectWorker(e){this.emit(Bn.STATE_CHANGE,oa.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(ot.CONNECTED,async()=>{this.emit(Bn.STATE_CHANGE,oa.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=en.CONNECTED}),this._workerConnection.on(ot.CLOSED,()=>{this.connectionState=en.CLOSED}),this._workerConnection.on(ot.FAILED,()=>{this.connectionState=en.CLOSED}),this._workerConnection.on(ot.RECONNECTING,()=>{this.connectionState=this.connectionState===en.CONNECTED?en.RECONNECTING:en.CONNECTING}),this._workerConnection.on(ot.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){const i=MW(new Uint8Array(e.data));C("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(i)),this._uploadNum++,i.code===void 0||i.code===0||(this._uploadFailedNum++,_.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(i.code,", msg is ").concat(i.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{Q.reportApiInvoke(this._connectInfo.sid||null,{name:fe.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,i.code],tag:Qt.TRACER}).onError(new D(S.IMAGE_MODERATION_UPLOAD_FAILED,i.msg)),this._uploadTimer=null},C("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else _.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(ot.WILL_RECONNECT,(e,i,n)=>{e==="recover"&&n(e),n("tryNext")}),this._workerConnection.on(ot.REQUEST_NEW_URLS,(e,i)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(i)})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const e=xi(this,Bn.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(C("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("Only the track being played can be inspected"));this._sequence++;const n=await this.generateRequestData(e,i);this._workerConnection.sendMessage(n,!0,!0)}else C("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("Only the track being published can be inspected")}async generateRequestData(e,i){let{appId:n,cname:r,cid:s,vid:o,sid:a,uid:c}=i;const d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),u=await Vy(l,n,r),h=this._sequence+"-"+s+"-"+c+"-"+d+"-"+Ut(12,""),p={appId:n,cid:s,cname:r,deviceId:"",elapse:Lm.intToLong(Number(d-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:h,sdkVersion:"4.23.1",sequence:this._sequence,sid:a,timestamp:lO(d),uid:c,vid:o,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete p.callbackData;const T=kW(p);if(T.byteLength<this._workerMessageLengthLimit){if(C("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const m=function(f){for(var R=1;R<arguments.length;R++){var v=arguments[R]!=null?arguments[R]:{};R%2?uO(Object(v),!0).forEach(function(A){g(f,A,v[A])}):Object.getOwnPropertyDescriptors?Object.defineProperties(f,Object.getOwnPropertyDescriptors(v)):uO(Object(v)).forEach(function(A){Object.defineProperty(f,A,Object.getOwnPropertyDescriptor(v,A))})}return f}({},p);delete m.jpg,_.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(m))}return T}{const m=this.quality*this._qualityRatio;return this.quality=m,await this.generateRequestData(e,{appId:n,cname:r,cid:s,vid:o,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=li.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=en.CLOSED,this.emit(Bn.STATE_CHANGE,oa.CLOSED)}}function hO(t){if(Pt(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new D(S.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(t&&t.vendor&&t.vendor.length>1024)throw new D(S.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}const WW={name:"ImageModeration",create:function(t){let{config:e}=t;return hO(e),new Lm(e)}};var pO,_O,EO,mO,fO,gO,TO,SO,RO,vO,CO,IO,yO,AO,bO,wO,OO,NO,DO,PO,LO,kO,MO,UO,xO,VO,FO,BO,jO,GO,WO,HO,KO,YO,qO,zO,JO,XO,QO,ZO,$O,H;function t0(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function In(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?t0(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):t0(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}Ke.setLogger(_);let HW=(pO=tt(),_O=tt({argsMap:(t,e)=>{if(!Array.isArray(e)){if(!(e instanceof Qo))return[e];e=[e]}return e.map(i=>i?Object(i).toString():"null")}}),EO=tt({argsMap:(t,e)=>(e||(e=[]),Array.isArray(e)||e.trackMediaType!==Xo.DATA?(Array.isArray(e)||(e=[e]),e.map(i=>i.getTrackId())):[e.getChannelId()])}),mO=tt({argsMap:(t,e,i,n)=>[typeof e=="object"?e.uid:e,i,n]}),fO=tt({argsMap:(t,e,i)=>[e,i]}),gO=tt({argsMap:(t,e)=>e.map(i=>{let{user:n,mediaType:r}=i;return[n==null?void 0:n.uid,r]})}),TO=tt({argsMap:(t,e,i,n)=>[typeof e=="object"?e.uid:e,i,n]}),SO=tt({argsMap:(t,e)=>e.map(i=>{let{user:n,mediaType:r}=i;return{uid:n==null?void 0:n.uid,mediaType:r}})}),RO=tt(),vO=tt(),CO=tt(),IO=tt(),yO=tt(),AO=tt(),bO=tt(),wO=tt(),OO=tt(),NO=tt(),DO=tt(),PO=tt(),LO=tt(),kO=tt(),MO=tt(),UO=tt({argsMap:(t,e)=>[e]}),xO=tt(),VO=tt(),FO=tt(),BO=tt(),jO=tt(),GO=tt(),WO=tt(),HO=tt(),KO=tt({argsMap:(t,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),YO=tt(),qO=tt(),zO=tt(),JO=tt(),XO=tt(),QO=tt(),ZO=tt({reportResult:!0}),$O=tt(),H=class extends qt{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var t;return((t=this._config)===null||t===void 0?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t,e){let i;if(super(),g(this,"store",void 0),g(this,"_uid",void 0),g(this,"_channelName",void 0),g(this,"_uintUid",void 0),g(this,"_users",[]),g(this,"_config",void 0),g(this,"_clientId",void 0),g(this,"_appId",void 0),g(this,"_sessionId",null),g(this,"_key",void 0),g(this,"_rtmConfig",{}),g(this,"_joinInfo",void 0),g(this,"_gateway",void 0),g(this,"_statsCollector",void 0),g(this,"_configDistribute",void 0),g(this,"_leaveMutex",void 0),g(this,"_publishMutex",void 0),g(this,"_renewTokenMutex",void 0),g(this,"_subscribeMutex",void 0),g(this,"_encryptionMode","none"),g(this,"_encryptionSecret",null),g(this,"_encryptionSalt",null),g(this,"_encryptDataStream",!1),g(this,"_encryptDataStreamKey",null),g(this,"_encryptDataStreamIv",null),g(this,"_proxyServer",void 0),g(this,"_turnServer",{servers:[],mode:"auto"}),g(this,"_cloudProxyServerMode","disabled"),g(this,"_isDualStreamEnabled",!1),g(this,"_defaultStreamFallbackType",void 0),g(this,"_lowStreamParameter",void 0),g(this,"_streamFallbackTypeCacheMap",new Map),g(this,"_remoteStreamTypeCacheMap",new Map),g(this,"_axiosCancelSource",li.CancelToken.source()),g(this,"_audioVolumeIndicationInterval",void 0),g(this,"_networkQualityInterval",void 0),g(this,"_userOfflineTimeout",void 0),g(this,"_streamRemovedTimeout",void 0),g(this,"_liveTranscodeStreamingClient",void 0),g(this,"_liveRawStreamingClient",void 0),g(this,"_channelMediaRelayClient",void 0),g(this,"_networkQualitySensitivity","normal"),g(this,"_p2pChannel",void 0),g(this,"_useLocalAccessPoint",!1),g(this,"_setLocalAPVersion",void 0),g(this,"_joinAndNotLeaveYet",!1),g(this,"_numberOfJoinCount",0),g(this,"_remoteDefaultVideoStreamType",void 0),g(this,"_inspect",void 0),g(this,"_moderation",void 0),g(this,"_license",void 0),g(this,"_pendingPublishedUsers",[]),g(this,"ntpAlignErrorCount",0),g(this,"remoteInboundOffset",0),g(this,"_peerConnectionState",void 0),g(this,"_handleLocalTrackEnable",(r,s,o)=>{this.publish(r,!1).then(s).catch(o)}),g(this,"_handleLocalTrackDisable",(r,s,o)=>{this.unpublish(r).then(s).catch(o)}),g(this,"_handleUserOnline",r=>{if(C("BLOCK_LOCAL_CLIENT")&&Gs(r.uid,this.channelName))return void _.debug("[".concat(r.uid,"] will be ignored in local"));this.isStringUID&&typeof r.uid!="string"&&_.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const s=this._users.find(o=>o.uid===r.uid);if(s)s._trust_in_room_=!0,s._is_pre_created&&(s._is_pre_created=!1,this.safeEmit(dt.USER_JOINED,s));else{const o=new rs(r.uid,r.uint_id||r.uid);this._users.push(o),_.debug("[".concat(this._clientId,"] user online"),r.uid),this.safeEmit(dt.USER_JOINED,o)}}),g(this,"_handleUserOffline",r=>{if(C("BLOCK_LOCAL_CLIENT")&&Gs(r.uid,this.channelName))return;const s=this._users.find(o=>o.uid===r.uid);s&&(this._handleRemoveStream(r),this._handleRemoveDataChannels(r),s._audio_pre_subscribed||s._video_pre_subscribed?s._is_pre_created=!0:jl(this._users,s),this._remoteStreamTypeCacheMap.delete(s.uid),this._streamFallbackTypeCacheMap.delete(s.uid),_.debug("[".concat(this._clientId,"] user offline"),r.uid,"reason:",r.reason),this.safeEmit(dt.USER_LEAVED,s,r.reason))}),g(this,"_handleAddAudioOrVideoStream",(r,s,o,a,c,d,l)=>{if(C("BLOCK_LOCAL_CLIENT")&&Gs(s,this.channelName))return;const u=this._users.find(p=>p.uid===s);if(!u)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));_.debug("[".concat(this._clientId,"] stream added with uid ").concat(s,", type ").concat(r)),this.store.subscribe(u.uid,r,void 0,void 0,void 0,Date.now());const h=r==="audio"?u.hasAudio:u.hasVideo;u._uintid||(u._uintid=c||s),r==="audio"?u._trust_audio_stream_added_state_=!0:u._trust_video_stream_added_state_=!0,r==="audio"?(u._audio_added_=!0,o!==void 0&&(u._audioSSRC=o),a!==void 0&&(u._cname=a),d&&(u._audioOrtc=d)):(u._video_added_=!0,o!==void 0&&(u._videoSSRC=o),a!==void 0&&(u._cname=a),l!==void 0&&(u._rtxSsrcId=l),d&&(u._videoOrtc=d)),(r==="audio"?u.hasAudio:u.hasVideo)&&!h&&(_.info("[".concat(this._clientId,"] remote user ").concat(u.uid," published ").concat(r)),this.safeEmit(dt.USER_PUBLISHED,u,r)),r==="video"?Q.onGatewayStream(this._sessionId,ye.ON_ADD_VIDEO_STREAM,Ht.ON_ADD_VIDEO_STREAM,{peer:c||s,ssrc:u._videoSSRC}):Q.onGatewayStream(this._sessionId,ye.ON_ADD_AUDIO_STREAM,Ht.ON_ADD_AUDIO_STREAM,{peer:c||s,ssrc:u._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(u,r,o).then(p=>{if(p&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(u.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof kc))return this._p2pChannel.unsubscribe(u,r,!0).then(()=>this._subscribe(u,r,!0).catch(T=>{_.error("[".concat(this._clientId,"] resubscribe error"),T.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(u,r)&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(u.uid," after reconnect.")),this._subscribe(u,r,!0).catch(p=>{_.error("[".concat(this._clientId,"] resubscribe error"),p.toString())}))}),g(this,"_handleRemoveStream",r=>{if(C("BLOCK_LOCAL_CLIENT")&&Gs(r.uid,this.channelName))return;const s=this._users.find(a=>a.uid===r.uid);if(!s)return void _.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));_.debug("[".concat(this._clientId,"] stream removed with uid ").concat(r.uid));let o=()=>{};s.hasAudio&&s.hasVideo?o=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished audio track")),this.safeEmit(dt.USER_UNPUBLISHED,s,"audio"),_.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished video track")),this.safeEmit(dt.USER_UNPUBLISHED,s,"video")}:s.hasVideo?o=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished video track")),this.safeEmit(dt.USER_UNPUBLISHED,s,"video")}:s.hasAudio&&(o=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished audio track")),this.safeEmit(dt.USER_UNPUBLISHED,s,"audio")}),s._video_pre_subscribed||s._audio_pre_subscribed||(s._trust_audio_stream_added_state_=!0,s._trust_video_stream_added_state_=!0,s._audio_added_=!1,s._video_added_=!1,this._p2pChannel instanceof kc&&this._p2pChannel.unsubscribe(s).then(a=>{if(a)return this._gateway.unsubscribe(a,s.uid)}),s._audioSSRC=void 0,s._videoSSRC=void 0,s._audioOrtc=void 0,s._videoOrtc=void 0,s._rtxSsrcId=void 0),Q.onGatewayStream(this._sessionId,ye.ON_REMOVE_STREAM,Ht.ON_REMOVE_STREAM,{peer:r.uint_id||r.uid}),o()}),g(this,"_handleSetStreamLocalEnable",(r,s,o)=>{if(C("BLOCK_LOCAL_CLIENT")&&Gs(s,this.channelName))return;const a=this._users.find(l=>l.uid===s);if(!a)return void _.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));_.debug("[".concat(this._clientId,"] local ").concat(r," ").concat(o?"enabled":"disabled"," with uid ").concat(s));const c=r==="audio"?a.hasAudio:a.hasVideo;if(r==="audio"){a._trust_audio_enabled_state_=!0;const l=a._audio_enabled_;if(a._audio_enabled_=o,a._audio_enabled_===l)return;{const u=a._audio_enabled_?"enable-local-audio":"disable-local-audio";_.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(s,", msg: ").concat(u)),this.safeEmit(dt.USER_INFO_UPDATED,s,u)}}else{a._trust_video_enabled_state_=!0;const l=a._video_enabled_;if(a._video_enabled_=o,a._video_enabled_===l)return;{const u=a._video_enabled_?"enable-local-video":"disable-local-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(s,", msg: ").concat(u)),this.safeEmit(dt.USER_INFO_UPDATED,s,u)}}const d=r==="audio"?a.hasAudio:a.hasVideo;return c!==d?!c&&d?(_.info("[".concat(this._clientId,"] remote user ").concat(s," published ").concat(r)),void this.safeEmit(dt.USER_PUBLISHED,a,r)):(r==="video"&&a._videoTrack&&a._videoTrack._destroy(),r==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,r),_.info("[".concat(this._clientId,"] remote user ").concat(s," unpublished ").concat(r)),void this.safeEmit(dt.USER_UNPUBLISHED,a,r)):void 0}),g(this,"_handleMuteStream",(r,s,o)=>{if(C("BLOCK_LOCAL_CLIENT")&&Gs(r,this.channelName))return;_.debug("[".concat(this._clientId,"] receive mute message"),r,s,o);const a=this._users.find(l=>l.uid===r);if(!a)return void _.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r));const c=s==="audio"?a.hasAudio:a.hasVideo;if(s==="audio"){a._trust_audio_mute_state_=!0;const l=a._audio_muted_;if(a._audio_muted_=o,a._audio_muted_===l)return;{const u=a._audio_muted_?"mute-audio":"unmute-audio";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(u)),this.safeEmit(dt.USER_INFO_UPDATED,r,u)}}else{a._trust_video_mute_state_=!0;const l=a._video_muted_;if(a._video_muted_=o,a._video_muted_===l)return;{const u=a._video_muted_?"mute-video":"unmute-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(u)),this.safeEmit(dt.USER_INFO_UPDATED,r,u)}}const d=s==="audio"?a.hasAudio:a.hasVideo;if(c!==d){if(!c&&d)return(s==="audio"?a._audioSSRC:a._videoSSRC)?(_.info("[".concat(this._clientId,"] remote user ").concat(r," published ").concat(s)),void this.safeEmit(dt.USER_PUBLISHED,a,s)):void _.warning("[".concat(this._clientId,"] remote user ").concat(r," receive ").concat(s," unmute message  before add stream message, ").concat(s," SSRC doesn't exist yet."));s==="video"&&a._videoTrack&&!a._video_pre_subscribed&&a._videoTrack._destroy(),s==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,s),_.info("[".concat(this._clientId,"] remote user ").concat(r," unpublished ").concat(s)),this.safeEmit(dt.USER_UNPUBLISHED,a,s)}}),g(this,"_handleP2PLost",async r=>{_.debug("[".concat(this._clientId,"] receive p2p lost"),r),parseInt(r.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():_.warning("[".concat(this._clientId,"] P2PLost stream not found"),r)}),g(this,"_handleTokenWillExpire",()=>{_.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(dt.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),g(this,"_handleBeforeUnload",r=>{r.type==="beforeunload"&&r.returnValue!==void 0&&r.returnValue!==""||(this.leave(),_.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),g(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(dt.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const r={downlinkNetworkQuality:0,uplinkNetworkQuality:0};r.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),r.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(dt.NETWORK_QUALITY,r)}),g(this,"_handleP2PAddAudioOrVideoStream",(r,s,o,a)=>{const c=this._users.find(l=>l.uid===s);if(!c)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));_.debug("[".concat(this._clientId,"] stream added with uid ").concat(s,", type ").concat(r)),this.store.subscribe(c.uid,r,void 0,void 0,void 0,Date.now());const d=r==="audio"?c.hasAudio:c.hasVideo;r==="audio"?c._trust_audio_stream_added_state_=!0:c._trust_video_stream_added_state_=!0,r==="audio"?(c._audio_added_=!0,o!==void 0&&(c._audioSSRC=o),a!==void 0&&(c._audioMid=a)):(c._video_added_=!0,o!==void 0&&(c._videoSSRC=o),a!==void 0&&(c._videoMid=a)),(r==="audio"?c.hasAudio:c.hasVideo)&&!d&&(_.info("[".concat(this._clientId,"] remote user ").concat(c.uid," published ").concat(r)),this.safeEmit(dt.USER_PUBLISHED,c,r)),this._p2pChannel.hasPendingRemoteMedia(c,r)&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(c.uid," after reconnect.")),this._subscribe(c,r,!0).catch(l=>{_.error("[".concat(this._clientId,"] resubscribe error"),l.toString())}))}),this._config=t,this._clientId=e||Ut(5,"client-"),this.store=new VG(t.codec,t.audioCodec,t.mode,this._clientId),this._leaveMutex=new Ke("client-leave",this._clientId),this._publishMutex=new Ke("client-publish",this._clientId),this._renewTokenMutex=new Ke("client-renewtoken",this._clientId),this._subscribeMutex=new Ke("client-subscribe",this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),_.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Zi," build: ").concat(AE,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{pE(t.clientRoleOptions),i=Object.assign({},t.clientRoleOptions)}catch(r){_.warning("[".concat(this._clientId,"] ").concat(r.toString()))}var n;this._statsCollector=new Pc(this.store),this._statsCollector.onStatsException=(r,s,o)=>{_.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(r,", msg: ").concat(s,", uid: ").concat(o)),this.safeEmit(dt.EXCEPTION,{code:r,msg:s,uid:o})},this._statsCollector.onUploadPublishDuration=(r,s,o,a)=>{const c=this._users.find(d=>d.uid===r);c&&Q.peerPublishStatus(this._sessionId,{subscribeElapse:a,audioPublishDuration:s,videoPublishDuration:o,peer:c._uintid})},this.store.useP2P=t.mode==="p2p",this._gateway=new uW(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||ge,httpRetryConfig:t.httpRetryConfig||ge,forceWaitGatewayResponse:t.forceWaitGatewayResponse===void 0||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:i}),this._configDistribute=new SW(this._clientId,this.store),this.store.useP2P?(this._p2pChannel=(n={store:this.store,statsCollector:this._statsCollector},ns("P2PChannel").create(n)),this._handleP2PEvents()):this._p2pChannel=new kc(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(t,e,i,n,r){let s=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],o=arguments.length>6&&arguments[6]!==void 0&&arguments[6];Ot("JOIN_GATEWAY_USE_443PORT_ONLY",s),Ot("JOIN_GATEWAY_USE_DUAL_DOMAIN",o);const a=this._gateway.signal.websocket;return a instanceof rm&&(a.use443PortOnly=s,a.tryDoubleDomain=o),async function(c,d,l){Ul.get(c)||Ul.set(c,[]),xl.get(c)||xl.set(c,d),Zn.get(c)||Zn.set(c,0);const u=Ul.get(c),h=xl.get(c);if(!u||!h)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(Zn.get(c)===h){const R=uc();u.push(R),await R.promise}Zn.set(c,Zn.get(c)+1);for(var p=arguments.length,T=new Array(p>3?p-3:0),m=3;m<p;m++)T[m-3]=arguments[m];const f=await l(...T);return Zn.set(c,Zn.get(c)-1),Zn.get(c)===h-1&&u.length>0&&(u[0].resolve(),u.shift()),Zn.get(c)===0&&(Ul.set(c,[]),xl.set(c,0),Zn.set(c,0)),f}("client.join",C("JOIN_MAX_CONCURRENCY"),this.join.bind(this),t,e,i,n,r)}async join(t,e,i,n,r){const s=++this._numberOfJoinCount;this.store.joinStart(),n&&(this.store.uid=n);const o=(Hl||Hl||(Hl=(window.location.protocol.split(":")[0]||"").toUpperCase(),Hl))==="HTTPS",a=ty()?window.isSecureContext:"Browser Not Support";(!ty()&&!o||!window.isSecureContext)&&_.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser"),this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),_.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart))),Q.setAppId(t);try{if(!i&&i!==null)throw new D(S.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));i&&Le(i,"token",1,2047),Le(t,"appid",1,2047),hu(e),n&&pu(n),r&&Le(r,"optionalInfo",1,2047)}catch(m){throw Q.reportApiInvoke(ks(),{name:fe.JOIN,options:[t,e,i,n],states:{isHttps:o,isSecureContext:a},tag:Qt.TRACER}).onError(m),m}if(this._leaveMutex.isLocked&&(_.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),_.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const m=new D(S.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw Q.reportApiInvoke(ks(),{name:fe.JOIN,options:[t,e,i,n],states:{isHttps:o,isSecureContext:a},tag:Qt.TRACER}).onError(m),m}this._gateway.state="CONNECTING";const c=await zw({appId:t,cname:e,uid:n,stringUid:typeof n=="string"?n:void 0,token:i||t,cloudProxyServer:this._cloudProxyServerMode});if(!this._joinAndNotLeaveYet)throw new D(S.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));const d=(c==null?void 0:c.sid)||ks();_.info("[".concat(this._clientId,"] start join channel ").concat(e,", join number: ").concat(s)),this._sessionId||(this._sessionId=d,this.store.sessionId=this._sessionId);const l=Q.reportApiInvoke(d,{id:this._clientId,name:fe.JOIN,options:[t,e,i,n],states:{isHttps:o,isSecureContext:a},tag:Qt.TRACER}),u=In(In(In({},this._rtmConfig),{},{role:this.role,clientId:this._clientId,appId:t,sid:this._sessionId,cname:e,uid:typeof n!="string"?n:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:i||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:r,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!c},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:C("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(u.setLocalAPVersion=this._setLocalAPVersion),typeof n=="string"&&(u.stringUid=n,this._uintUid?(u.uid=this._uintUid,this._uintUid=void 0):u.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(u.aesmode=this._encryptionMode,u.aespassword=await(async m=>{const f=function(){const O=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),w=new Uint8Array(new ArrayBuffer(O.length));for(let b=0;b<O.length;b+=1)w[b]=O.charCodeAt(b);return w}(),R=await window.crypto.subtle.importKey("spki",f,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),v=uE(m),A=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},R,v);return function(O){let w="";for(let b=0;b<O.length;b+=1)w+=String.fromCharCode(O[b]);return window.btoa(w)}(new Uint8Array(A))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new D(S.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(u.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const m=new TextEncoder,f=C("USE_PURE_ENCRYPTION_MASTER_KEY")?m.encode(u.appId+this._encryptionSecret+this._encryptionSecret):m.encode(u.appId+u.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(R,v,A){const O=await window.crypto.subtle.importKey("raw",v,"PBKDF2",!1,["deriveBits","deriveKey"]),w=R==="aes-128-gcm2"?128:256,b=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:1e3,hash:"SHA-256",salt:A},O,w+96);return new Uint8Array(b).subarray(w/8)}(this._encryptionMode,f,Ls(this._encryptionSalt)),this._encryptDataStreamKey=await async function(R,v,A){const O=await window.crypto.subtle.importKey("raw",v,"PBKDF2",!1,["deriveBits","deriveKey"]),w=R==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:1e3,hash:"SHA-256",salt:A},O,{name:"AES-GCM",length:w},!0,["encrypt","decrypt"])}(this._encryptionMode,f,Ls(this._encryptionSalt))}else a?_.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):_.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,_.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:e,appId:t,stringUid:u.stringUid});const h=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&h===this._sessionId&&Q.joinChannelTimeout(this._sessionId,5)},5e3);try{var p;let m;const f=u.cloudProxyServer;if(B(p=["proxy3","proxy4","proxy5"]).call(p,f)){const w=C("PROXY_SERVER_TYPE3");Array.isArray(w)?u.proxyServer=w[0]:u.proxyServer=w}if(Q.setProxyServer(u.proxyServer),_.setProxyServer(u.proxyServer),this.store.requestAPStart(),c){if(_.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(u.stringUid?", ".concat(u.stringUid," => ").concat(c.intUid):""," ")),u.stringUid&&!u.uid&&(u.uid=c.intUid),m={gatewayInfo:c.ap.gatewayInfo},C("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&u.turnServer.mode==="auto")if(c.ap.proxyInfo.addresses.length===0)_.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const w=(await Bb(c.ap.proxyInfo,c.ap.gatewayInfo.uid)).map(b=>({turnServerURL:b.address,tcpport:b.tcpport||je.tcpport,udpport:b.udpport||je.udpport,username:b.username||je.username,password:b.password||je.password,forceturn:!1,security:!0}));u.turnServer={mode:"manual",servers:w}}Qw(c,u.stringUid)}else{if(u.stringUid&&!u.uid){let w;[w,m]=await G.all([_w(u.stringUid,u,this._axiosCancelSource.token,this._config.httpRetryConfig||ge,this.store),pw(u,this._axiosCancelSource.token,this._config.httpRetryConfig||ge,!0,this.store)]),_.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(u.stringUid," => ").concat(w)),u.uid=w,m.gatewayInfo.uid=w,m.gatewayInfo.res.uid=w}else m=await pw(u,this._axiosCancelSource.token,this._config.httpRetryConfig||ge,!0,this.store);if(!this._joinAndNotLeaveYet)throw new D(S.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(u,this._axiosCancelSource.token),this._configDistribute.on(Ic.UPDATE_BITRATE_LIMIT,w=>{this._p2pChannel.updateBitrateLimit(w)}),this._configDistribute.on(Ic.UPDATE_CLIENT_ROLE_OPTIONS,w=>{this._setClientRoleOptions(w)})},0),this._key=i||t;const R=m.gatewayInfo,v=u.uid?u.uid:R.uid;this._joinInfo=In(In({},u),{},{cid:R.cid,uid:v,vid:R.vid,apResponse:R.res,apGatewayAddress:R.apGatewayAddress,uni_lbs_ip:R.uni_lbs_ip,gatewayAddrs:R.gatewayAddrs}),this.store.intUid=v,this.store.cid=R.cid;const A=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new D(S.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));l.onSuccess(A),this._appId=t,this._channelName=u.cname,this._uid=A,this.store.uid=A,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(Ve()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()},0);const O=u.stringUid?"string uid: ".concat(u.stringUid,",uid: ").concat(u.uid):"uid: ".concat(this._uid);return _.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(e,",").concat(O)),setTimeout(()=>{_.startUpload()},5e3),this.store.joinEnd(),T=this,B(js).call(js,T)||js.push(T),this._cloudProxyServerMode==="disabled"&&St().supportWebCrypto&&C("ENABLE_PRELOAD")&&Dm(this._joinInfo),A}catch(m){const f=Array.isArray(m)?m[0]:m;throw f&&f.code===S.OPERATION_ABORTED?_.warning("[".concat(this._clientId,"] join number: ").concat(s,", Joining channel failed, rollback"),f):_.error("[".concat(this._clientId,"] join number: ").concat(s,", Joining channel failed, rollback"),f),f.code!==S.OPERATION_ABORTED&&this._numberOfJoinCount===s&&(this._gateway.state="DISCONNECTED",this._reset()),l.onError(f),f}var T}_joinGateway(){if(!this._joinInfo||!this._key)throw new D(S.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!C("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}async leave(){_.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(Ve()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const i=js.indexOf(e);i!==-1&&js.splice(i,1)}(this),this._statsCollector.stopUpdateStats();const t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return _.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED",It.LEAVE),_.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t()}async publish(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(t)){if(!(t instanceof Qo))return this._publishDataChannel(t);t=[t]}if(t.length===0)throw new D(S.INVALID_PARAMS,"param list is empty");const i=t;if(this._gateway.role==="audience")throw new D(S.INVALID_OPERATION,"audience can not publish stream");for(const r of i){if(!(r instanceof Qo))throw new D(S.INVALID_PARAMS,"parameter is not local track");if(!r._enabled&&e)throw new D(S.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(r.getTrackId()))}_.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(i.map(r=>"".concat(r.getTrackId()," "))));const n=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),e&&i.forEach(r=>{const s=this._configDistribute.getBitrateLimit();r instanceof Gt&&s&&r.setBitrateLimit(s.uplink)});try{await this._publishHighStream(i),_.info("[".concat(this._clientId,"] Publish success, id ").concat(i.map(r=>"".concat(r.getTrackId()," "))))}catch(r){throw _.error("[".concat(this._clientId,"] publish error"),r.toString()),r}finally{n()}}async _publishDataChannel(t){Pt(t.id,"id",0,65535,!0),Cr(t.ordered,"ordered"),Le(t.metadata,"metadata",0,512),_.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(t.id));const e=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(r=>r.id===t.id)!==-1)throw new D(S.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new D(S.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&C("FORCE_TURN")&&!C("TURN_ENABLE_TCP")&&!C("TURN_ENABLE_UDP"))throw new D(S.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const i=function(r){return rw(r,!1)}(t),n=await this._p2pChannel.publishDataChannel([i]);if(n.length>0){if(typeof i._originDataChannelId!="number")throw _.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new D(S.CREATE_DATACHANNEL_ERROR);try{await G.all(n.map(r=>this._uid&&this._gateway.publishDataChannel(this._uid,r,!0))),await i._waitTillOpen()}catch(r){if(r.code!==S.DISCONNECT_P2P)throw r}}return _.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(i.id)),i}catch(i){throw _.error("[".concat(this._clientId,"] publish datachannels error"),i.toString()),i}finally{e()}}async unpublish(t){if(!this._joinInfo||this._uid===void 0)throw new D(S.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let e=[];if(t)if(Array.isArray(t))e=t;else{if(!(t instanceof Qo))return this._unpublishDataChannel([t]);e=[t]}else this.store.useP2P||await this._unpublishDataChannel(),e=this._p2pChannel.getAllTracks(!0);_.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(e.map(n=>"".concat(n.getTrackId()," "))," "));const i=await this._publishMutex.lock();try{if(this.store.useP2P){const n=await this._p2pChannel.unpublish(e);n&&await this._gateway.sendExtensionMessage(ae.UNPUBLISH,{unpubMsg:n},!0)}else{const n=await this._p2pChannel.unpublish(e);n&&await this._gateway.unpublish(n,this._uid),_.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(e.map(r=>"".concat(r.getTrackId()))))}}catch(n){throw _.error("[".concat(this._clientId,"] unpublish error"),n.toString()),n}finally{i&&i()}}async _unpublishDataChannel(t){t!==void 0&&t.length!==0||(t=this._p2pChannel.getAllDataChannels()),_.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(t.map(i=>"".concat(i.id," "))," "));const e=await this._publishMutex.lock();try{const i=await this._p2pChannel.unpublishDataChannel(t);i&&await this._gateway.unpublishDataChannel(i),_.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map(n=>"".concat(n.id))))}catch(i){throw _.error("[".concat(this._clientId,"] unpublish dataChannel error"),i.toString()),i}finally{e&&e()}}async subscribe(t,e,i){if(!(t instanceof rs)){const n=this.remoteUsers.find(r=>r.uid===t);if(!n)throw new D(S.INVALID_REMOTE_USER,"user is not in the channel");t=n}return e==="datachannel"?this._subscribeDataChannel(t,i):this._subscribe(t,e)}async presubscribe(t,e){if(Ce(e,"mediaType",["audio","video"]),this.store.useP2P)throw new D(S.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new D(S.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const i=e===q.AUDIO,n=e===q.VIDEO,r=await this._subscribeMutex.lock();try{const{ssrcId:s,ortc:o,rtxSsrcId:a,cname:c,uint_id:d}=await this._gateway.presubscribe(t,e,!0);if(s==null)throw new D(S.UNEXPECTED_RESPONSE,"no ssrc id");let l=this._users.find(h=>h.uid===t);l||(l=new rs(t,d||t),l._is_pre_created=!0,this._users.push(l)),c&&(l._cname=c),l._uintid||(l._uintid=d||t),i&&(l._audioSSRC=s,l._audio_pre_subscribed=!0,o&&(l._audioOrtc=o)),n&&(l._videoSSRC=s,l._video_pre_subscribed=!0,o&&(l._videoOrtc=o),a!=null&&(l._rtxSsrcId=a)),_.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(s)),await this._p2pChannel.subscribe(l,e,s,a,o);const u=i?l._audioTrack:l._videoTrack;if(!u)throw new D(S.UNEXPECTED_ERROR,"can not find remote track in user");return i&&(l._trust_audio_stream_added_state_=!0,l._audio_added_=!0),n&&(l._trust_video_stream_added_state_=!0,l._video_added_=!0),u}catch(s){throw _.error("[".concat(this._clientId,"] presub user ").concat(t," error"),s),s}finally{r()}}async _subscribeDataChannel(t,e){var i;if(Pt(e,"channelId",0,65535,!0),!this._joinInfo)throw new D(S.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(a=>a===t))throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new D(S.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&t._dataChannels.length===0)throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new D(S.INVALID_REMOTE_USER,"user is not published");const r=(i=t._dataChannels)===null||i===void 0?void 0:i.find(a=>a.id===e);if(!r)throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new D(S.REMOTE_USER_IS_NOT_PUBLISHED);const s=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{const a=await this._p2pChannel.subscribeDataChannel(t,[r]);if(a&&B(a).call(a,r.id))try{var o;if(typeof r._originDataChannelId!="number")throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new D(S.CREATE_DATACHANNEL_ERROR);const c={id:r.id,datachannelId:r._originDataChannelId,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:(o=r.metadata)!==null&&o!==void 0?o:""};await this._gateway.subscribeDataChannel(t.uid,c,!0),await r._waitTillOpen()}catch(c){if((c==null?void 0:c.code)!==S.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(t,[r]),c;await this._p2pChannel.unsubscribeDataChannel(t,[r]),this._p2pChannel.setPendingRemoteDataChannel(t,r.id)}return _.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),r}finally{s()}}async _p2pSubscribe(t,e,i){if(Ce(e,"mediaType",["audio","video"]),!this._joinInfo)throw new D(S.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(s=>s===t)){const s=new D(S.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),s}if(!t.hasAudio&&!t.hasVideo){const s=new D(S.INVALID_REMOTE_USER,"user is not published");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),s}if(!i&&(e==="audio"&&!t.hasAudio||e==="video"&&!t.hasVideo)){const s=new D(S.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),s}const r=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{const o=e==="audio"?t._audioSSRC:t._videoSSRC,a=e==="audio"?t._audioMid:t._videoMid;this.store.subscribe(t.uid,e,Date.now()),this.store.useP2P&&await this._p2pChannel.subscribe(t,e,o,a)}catch(o){throw o}_.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(o=>{_.warning("[".concat(this._clientId,"] auto set fallback failed"),o)});const s=e==="audio"?t._audioTrack:t._videoTrack;if(!s)throw new D(S.UNEXPECTED_ERROR,"can not find remote track in user object");return s}catch(s){throw _.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),s),s}finally{r()}}async _subscribe(t,e,i){if(this.store.useP2P)return this._p2pSubscribe(t,e);if(Ce(e,"mediaType",["audio","video"]),!this._joinInfo)throw new D(S.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(d=>d===t)){const d=new D(S.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),d}if(!t.hasAudio&&!t.hasVideo){const d=new D(S.INVALID_REMOTE_USER,"user is not published");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),d}if(!(i||(e!=="audio"||t.hasAudio&&t._audioSSRC!==void 0)&&(e!=="video"||t.hasVideo&&t._videoSSRC!==void 0))){const d=new D(S.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),d}let r=e==="audio"?t._audioSSRC:t._videoSSRC,s=e==="audio"?t._audioOrtc:t._videoOrtc,o=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?q.AUDIO:q.VIDEO,ssrcId:r};const c=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{const l=e==="audio"?t._audioSSRC:t._videoSSRC;l!==void 0&&l!==r&&(r=l,s=e==="audio"?t._audioOrtc:t._videoOrtc,o=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?q.AUDIO:q.VIDEO,ssrcId:r}),qe.markSubscribeStart(this.store.clientId,r),this.store.subscribe(t.uid,e,Date.now()),await this._p2pChannel.subscribe(t,e,r,o,s);try{this._p2pChannel.isPreSubScribe(r)||await this._gateway.subscribe(t.uid,a,!0)}catch(u){if((u==null?void 0:u.code)!==S.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,e),u;await this._p2pChannel.unsubscribe(t,e,!0),this._p2pChannel.setPendingRemoteMedia(t,e)}this.store.subscribe(t.uid,e,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,e)}catch(l){throw this._p2pChannel.reportSubscribeEvent(!1,l==null?void 0:l.code,t,e),l}_.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(l=>{_.warning("[".concat(this._clientId,"] auto set fallback failed"),l)});const d=e==="audio"?t._audioTrack:t._videoTrack;if(!d)throw new D(S.UNEXPECTED_ERROR,"can not find remote track in user object");return d}catch(d){throw _.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),d),d}finally{c()}}async massSubscribe(t){if(Ir(t,"subscribeList"),!this._joinInfo)throw new D(S.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const e=Date.now(),i=new Map,n=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map(a=>{let{user:c,mediaType:d}=a;return"user: ".concat(c==null?void 0:c.uid,", mediaType: ").concat(d)}).join("; ")));const r=(t=[...t]).map(a=>{let{user:c,mediaType:d}=a;return{user:c,mediaType:d}}),s=await this._p2pChannel.globalLock();try{var o;for(let c=t.length-1;c>=0;c--){const d=t[c],{user:l,mediaType:u}=d;if(Ce(u,"mediaType",["audio","video"]),!l){const m=new D(S.INVALID_PARAMS,"user property does not exist in subscribeList item");throw _.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),m}if(!this._users.find(m=>m===l)){const m=new D(S.INVALID_REMOTE_USER,"user is not in the channel");_.error("[".concat(this._clientId,"] can not massSubscribe ").concat(l.uid,", this user is not in the channel")),r[c].error=m,t.splice(c,1);continue}if(u==="audio"&&(!l.hasAudio||l._audioSSRC===void 0)||u==="video"&&(!l.hasVideo||l._videoSSRC===void 0)){const m=new D(S.REMOTE_USER_IS_NOT_PUBLISHED);_.error("[".concat(this._clientId,"] can not subscribe ").concat(l.uid," with mediaType ").concat(u,", remote user is not published")),r[c].error=m,t.splice(c,1);continue}const p=Ae.Video|Ae.LwoVideo,T=i.get(l);if(T){if(u==="video"?T&p:T&Ae.Audio){t.splice(c,1),_.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(l.uid,", mediaType:").concat(u," twice"));continue}i.set(l,T|(u==="video"?p:Ae.Audio))}else i.set(l,u==="video"?p:Ae.Audio)}for(let c=t.length-1;c>=0;c--){const d=t[c],{user:l,mediaType:u}=d,h=Ae.Video|Ae.LwoVideo;if(this._p2pChannel.hasRemoteMedia(l,u)){await this._p2pChannel.unmuteRemoteNoLock(l,u);const p=i.get(l);i.set(l,u==="video"?p^h:p^Ae.Audio),t.splice(c,1)}}this.store.massSubscribe(t.map(c=>({userId:c.user.uid,type:c.mediaType})),e);let a=wn(o=Array.from(i.entries())).call(o,(c,d)=>{let[l,u]=d;if(u===0)return c;const h={stream_id:l.uid,stream_type:u};return u&Ae.Audio&&(h.audio_ssrc=l._audioSSRC),u&Ae.Video&&(h.video_ssrc=l._videoSSRC),c.push(h),c},[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map(d=>{let{user:l,mediaType:u}=d;return{user:l,mediaType:u,ssrcId:u===q.VIDEO?l._videoSSRC:l._audioSSRC,rtxSsrcId:u===q.VIDEO?l._rtxSsrcId:void 0}}));const c=new Map;if(a=a.filter(d=>d.video_ssrc&&!this._p2pChannel.isPreSubScribe(d.video_ssrc)||d.audio_ssrc&&!this._p2pChannel.isPreSubScribe(d.audio_ssrc)||!d.video_ssrc&&!d.audio_ssrc),a.length>0){const d=await this._gateway.subscribeAll(a,!0);((d==null?void 0:d.users)||[]).forEach(l=>{let{stream_id:u,video_error_code:h,audio_error_code:p,error_code:T}=l;(h||p||T)&&c.set(u,{video_error_code:h,audio_error_code:p,error_code:T})})}if(Array.from(c.entries()).length>0){const d=[];Array.from(c.entries()).forEach(l=>{let[u,h]=l;const p=this.remoteUsers.find(T=>T.uid===u);if(p){let T;h.error_code||h.video_error_code&&h.audio_error_code?T=void 0:h.video_error_code?T=q.VIDEO:h.audio_error_code&&(T=q.AUDIO),d.push({user:p,mediaType:T})}}),d.length>0&&await this._p2pChannel.massUnsubscribeNoLock(d)}for(const d of r){const l=c.get(d.user.uid);if(l){const u=l.error_code||d.mediaType==="audio"&&l.audio_error_code||d.mediaType==="video"&&l.video_error_code;if(u){const h=yc(u);_.error("user:".concat(d.user.uid," mediaType:").concat(d.mediaType," has massSubscribe error ").concat(h.desc)),d.error=new D(S.SUBSCRIBE_FAILED,"code ".concat(u,": ").concat(h.desc))}}d.error||(d.mediaType==="video"?d.track=d.user.videoTrack:d.track=d.user.audioTrack)}return this.store.massSubscribe(r.filter(d=>!d.error).map(d=>({userId:d.user.uid,type:d.mediaType})),void 0,Date.now()),r.forEach(d=>{var l;Q.subscribe(this.store.sessionId,{succ:!!d.error,ec:((l=d.error)===null||l===void 0?void 0:l.code)||null,video:d.mediaType===q.VIDEO,audio:d.mediaType===q.AUDIO,peerid:d.user.uid,subscribeRequestid:d.mediaType===q.VIDEO?d.user._videoSSRC:d.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-e),preSsrc:this._p2pChannel.isPreSubScribe(d.user._videoSSRC)},!0)}),_.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map(d=>{let{user:l,mediaType:u}=d;return"user: ".concat(l==null?void 0:l.uid,", mediaType: ").concat(u)}).join("; "))),r}catch(c){throw await this._p2pChannel.massUnsubscribeNoLock(t),c}}finally{s(),n()}}async unsubscribe(t,e,i){if(!(t instanceof rs)){const s=this.remoteUsers.find(o=>o.uid===t);if(!s)throw new D(S.INVALID_REMOTE_USER,"user is not in the channel");t=s}if(e||this.store.useP2P){if(e==="datachannel")return this._unsubscribeDataChannel(t,i)}else await this._unsubscribeDataChannel(t,i);if(e&&Ce(e,"mediaType",["audio","video"]),!this._joinInfo)throw new D(S.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(s=>s===t)){const s=new D(S.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),s}_.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(e));const r=await this._subscribeMutex.lock();try{if(this.store.useP2P)await this._p2pChannel.unsubscribe(t,e);else{const s=await this._p2pChannel.unsubscribe(t,e);s&&await this._gateway.unsubscribe(s,t.uid),e&&e!=="audio"||(t._audio_pre_subscribed=!1),e&&e!=="video"||(t._video_pre_subscribed=!1),t._is_pre_created&&jl(this._users,t),_.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(e))}}catch(s){if(s.code===S.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),s.toString()),s}finally{r()}}async _unsubscribeDataChannel(t,e){if(e&&Pt(e,"id",0,65535,!0),!this._joinInfo)throw new D(S.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(r=>r===t)){const r=new D(S.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),r}let n;if(typeof e=="number"){const r=t._dataChannels.find(s=>s.id===e);r&&(n=[r])}else n=t._dataChannels;if(n===void 0){const r=new D(S.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(e,", remote datachannel is not published")),r}_.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(n.map(r=>r.id)));try{const r=await this._p2pChannel.unsubscribeDataChannel(t,n);r&&await this._gateway.unsubscribeDataChannel(r,t.uid),_.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(r))}catch(r){if(r.code===S.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),r.toString()),r}}async massUnsubscribe(t){if(Ir(t,"unsubscribeList"),!this._joinInfo)throw new D(S.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");_.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map(i=>{let{user:n,mediaType:r}=i;return"user: ".concat(n==null?void 0:n.uid,", mediaType: ").concat(r,";")}).join())),t=[...t];const e=new Map;for(let i=t.length-1;i>=0;i--){const{user:n,mediaType:r}=t[i];if(!n){const a=new D(S.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw _.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),a}if(Ce(r,"mediaType",["video","audio",void 0]),!this._users.find(a=>a===n)){_.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(n.uid,", user is not in the channel")),t.splice(i,1);continue}const o=Ae.Video|Ae.LwoVideo;if(e.has(n)){const a=e.get(n);let c;switch(r){case"video":c=a&o;break;case"audio":c=a&Ae.Audio;break;default:c=a&(Ae.Audio|o)}if(c){_.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(n.uid,",mediaType:").concat(r," twice.")),t.splice(i,1);continue}r?r==="audio"?e.set(n,a|Ae.Audio):r==="video"&&e.set(n,a|o):e.set(n,a|Ae.Audio|o)}else r?r==="audio"?e.set(n,Ae.Audio):r==="video"&&e.set(n,o):e.set(n,Ae.Audio|o)}try{const i=await this._p2pChannel.massUnsubscribe(t);i&&await this._gateway.massUnsubscribe(i),_.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map(n=>{let{user:r,mediaType:s}=n;return"user: ".concat(r==null?void 0:r.uid,", mediaType: ").concat(s,";")}).join()))}catch(i){if(i.code===S.DISCONNECT_P2P)return void _.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw _.error("[".concat(this._clientId,"] massUnsubscribe error"),i.toString()),i}}async setLowStreamParameter(t){(function(i){if(!i)throw new P(S.INVALID_PARAMS);Xt(i.width)||dE(i.width,"streamParameter.width"),Xt(i.height)||dE(i.height,"streamParameter.height"),Xt(i.framerate)||dE(i.framerate,"streamParameter.framerate"),Xt(i.bitrate)||Pt(i.bitrate,"streamParameter.bitrate")})(t),(!t.width&&t.height||t.width&&!t.height)&&_.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),_.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));const e=this._configDistribute.getLowStreamConfigDistribute();if(e&&e.bitrate&&t.bitrate&&e.bitrate<t.bitrate&&(t.bitrate=e.bitrate),this._lowStreamParameter=t,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(t,U.LocalVideoLowTrack)}async enableDualStream(){if(!St().supportDualStream)throw Q.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new D(S.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new D(S.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(t){throw Q.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,Q.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),_.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new D(S.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(U.LocalVideoLowTrack))try{const t=await this._p2pChannel.unpublishLowStream();t&&await this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid)}catch(t){throw Q.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,Q.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),_.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(t,e){if(function(n){Ce(n,"role",["audience","host"])}(t),e&&pE(e),this.mode==="rtc"||this.mode==="p2p")throw _.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new D(S.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(e&&e.level&&t==="host")throw new D(S.INVALID_OPERATION,"host mode can not set audience latency level");if(t==="audience"&&this._p2pChannel.hasLocalMedia())throw new D(S.INVALID_OPERATION,"can not set client role to audience when publishing stream");const i=this._config.role;this._joinInfo&&(this._joinInfo.role=t),t!==i&&C("ENABLE_ROLE_SELECT_EDGE")?(this._gateway.updateClientRole(t,e),this._config.role=t,this._gateway.reconnect("recover",Fe.REGIONAL_DISTRIBUTION)):(await this._gateway.setClientRole(t,e),this._config.role=t),_.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(e&&e.level))}async _setClientRoleOptions(t){if(this.mode==="rtc"||this.mode==="p2p"||this._config.role!=="audience"||this._p2pChannel.hasLocalMedia())return;let e=!1;try{t&&pE(t),await this._gateway.setClientRole(this._config.role,t),e=!0}catch{}finally{_.info("[".concat(this._clientId,"] set client role options ").concat(e?"succeed":"failed",", options is ").concat(t))}}getRemoteInboundOffset(){var t;const e=(t=this._p2pChannel.getStats())===null||t===void 0?void 0:t.audioSend[0];if(!e||!e.timestamp)return 0;const i=e.timestamp-Date.now();return Math.abs(i)>1e3+e.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?i:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(t,e){if(Le(t,"proxyServer"),!e){if(this.connectionState!=="DISCONNECTED")throw new D(S.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new D(S.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,Q.setProxyServer(this._proxyServer),_.setProxyServer(this._proxyServer),_.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."))}setTurnServer(t,e){if(Array.isArray(t)||(t=[t]),!e){if(this.connectionState!=="DISCONNECTED")throw new D(S.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new D(S.INVALID_OPERATION,"You have already set the proxy")}if(Ec(t))return this._turnServer={servers:t,mode:"original-manual"},void _.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(t.map(i=>i.urls).join(","),"."));t.forEach(i=>GI(i)),this._turnServer={servers:t,mode:"manual"},_.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."))}setLicense(t){if(this.connectionState!=="DISCONNECTED")throw new D(S.INVALID_OPERATION,"you should set license before join channel");if(Le(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new D(S.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,_.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if(this.connectionState!=="DISCONNECTED")throw new D(S.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new D(S.INVALID_OPERATION,"You have already set the proxy");const e=[3,4,5];let i;switch(t===void 0&&(t=3),t){case 1:case 2:throw new D(S.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:i="proxy3";break;case 4:i="proxy4";break;case 5:i="proxy5";break;default:throw new D(S.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=i,this.store.cloudProxyServerMode=i,_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new D(S.INVALID_OPERATION,"Stop proxy server after leave channel");Q.setProxyServer(),_.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new D(S.INVALID_PARAMS,"accessPoints is required.");Ir(t.accessPoints.serverList,"accessPoints.serverList"),Le(t.accessPoints.domain,"accessPoints.domain");const e=(h,p)=>{Pt(h,p,0,65535,!0)};let i=443;if(t.accessPoints.port&&(e(t.accessPoints.port,"accessPoints.port"),i=t.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new D(S.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");C("CLOSE_AFB_FOR_LOCAL_AP")&&(Ot("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Ot("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const n=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=t.accessPoints.domain,s=t.accessPoints.serverList.map(h=>n.test(h)?"".concat(h.replace(/\./g,"-"),".").concat(r):h),o=s.map(h=>"".concat(h,":").concat(i));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Ot("WEBCS_DOMAIN",o),Ot("WEBCS_DOMAIN_BACKUP_LIST",o),Ot("GATEWAY_DOMAINS",[r]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(Ir(t.report.hostname,"report.hostname"),Ot("EVENT_REPORT_DOMAIN",t.report.hostname[0]),Ot("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(Ot("EVENT_REPORT_DOMAIN",s[0]),Ot("EVENT_REPORT_BACKUP_DOMAIN",s[1]||s[0]));let a=6443;t.report&&t.report.port&&(e(t.report.port,"report.port"),a=t.report.port),Ot("STATS_COLLECTOR_PORT",a),t.report?Ot("ENABLE_EVENT_REPORT",!0):Ot("ENABLE_EVENT_REPORT",!1);let c="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(Ir(t.log.hostname,"log.hostname"),c=t.log.hostname[0]):c=s[0];let d=6444;t.log&&t.log.port&&(e(t.log.port,"log.port"),d=t.log.port),Ot("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let l=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(Ir(t.cds.hostname,"cds.hostname"),l=t.cds.hostname):l=s;let u=443;t.cds&&t.cds.port&&(e(t.cds.port,"cds.port"),u=t.cds.port),Ot("CDS_AP",l.map(h=>"".concat(h,":").concat(u))),t.cds?Ot("ENABLE_CONFIG_DISTRIBUTE",!0):Ot("ENABLE_CONFIG_DISTRIBUTE",!1),_.info("set local access point v2 success")}setLocalAccessPoints(t,e){if(Ir(t,"serverList"),Le(e,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new D(S.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const i=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map(n=>i.test(n)?"".concat(n.replace(/\./g,"-"),".").concat(e):n),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Ot("WEBCS_DOMAIN",t),Ot("WEBCS_DOMAIN_BACKUP_LIST",t),Ot("GATEWAY_DOMAINS",[e]),Ot("EVENT_REPORT_DOMAIN",t[0]),Ot("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),Ot("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),_.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(t){if(Ce(t,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw _.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else _.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))}async setRemoteVideoStreamType(t,e){Ce(e,"streamType",[0,1,4,5,6,7,8,9]);try{await this._gateway.setRemoteVideoStreamType(t,e),setTimeout(()=>{const i=this._users.find(n=>n.uid===t);i&&i.videoTrack&&i.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(i){throw _.error("[".concat(this._clientId,"] set remote video stream type error"),i.toString()),i}_.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(e)),this._remoteStreamTypeCacheMap.set(t,e)}async setStreamFallbackOption(t,e){Ce(e,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{await this._gateway.setStreamFallbackOption(t,e)}catch(i){throw _.error("[".concat(this._clientId,"] set stream fallback option"),i.toString()),i}_.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(e)),this._streamFallbackTypeCacheMap.set(t,e)}setEncryptionConfig(t,e,i,n){(function(s){Ce(s,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(t),Le(e,"secret");const r=["aes-128-gcm2","aes-256-gcm2"];if(B(r).call(r,t)){if(!i||!(i instanceof Uint8Array&&i.length===32))throw new D(S.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(i)throw new D(S.INVALID_PARAMS,"current encrypt mode does not need salt");if(n){if(Cr(n,"encryptDataStream"),!B(r).call(r,t))throw new D(S.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(e)||_.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=t,this._encryptionSecret=e,i&&(this._encryptionSalt=Qr(i))}async renewToken(t){if(Le(t,"token",1,2047),!this._key||!this._joinInfo)throw new D(S.INVALID_OPERATION,"renewToken should not be called before user join");const e=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);const i=await this._renewTokenMutex.lock();try{if(C("USE_NEW_TOKEN")){_.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const n=await TW(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||ge);_.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:n})}else _.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:t});_.debug("[".concat(this._clientId,"] renewToken success"))}catch(n){throw this._key=e,this._joinInfo.token=e,_.error("[".concat(this._clientId,"] renewToken failed"),n.toString()),n}finally{i()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?_.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const t=this._p2pChannel.getAudioLevels();this.safeEmit(dt.VOLUME_INDICATOR,t)},C("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const t=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return t.Duration=Math.round(e.duration/1e3),t}async startLiveStreaming(t,e){if(!e){if(this.codec!=="h264")throw new D(S.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new D(S.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new D(S.LIVE_STREAMING_TASK_CONFLICT);const i=e?Ar.TRANSCODE:Ar.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(t,i)}setLiveTranscoding(t){return this._createLiveStreamingClient(Ar.TRANSCODE).setTranscodingConfig(t)}async stopLiveStreaming(t){const e=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(i=>i&&i.hasUrl(t));if(!e.length)throw new D(S.INVALID_PARAMS,"can not find live streaming url to stop");await G.all(e.map(i=>i&&i.stopLiveStreamingTask(t)))}async startChannelMediaRelay(t){Rw(t),await this._createChannelMediaRelayClient().startChannelMediaRelay(t)}async updateChannelMediaRelay(t){Rw(t),await this._createChannelMediaRelayClient().updateChannelMediaRelay(t)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendAudioMetadata(t){this._p2pChannel instanceof kc&&this._p2pChannel.addAudioMetadata(t)}async sendStreamMessage(t){var e;let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new D(S.INVALID_OPERATION,"can not send data stream, not joined");if((typeof t=="string"||t instanceof Uint8Array)&&(t={payload:t}),typeof t.payload=="string"){const r=new TextEncoder;t.payload=r.encode(t.payload)}let n=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&B(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)&&(n=!0,t.payload=await async function(r,s,o){var a;const c=wn(a=Array.from(o)).call(a,(m,f)=>m+f,0),d={serverTs:0,seq:FG++,length:o.length,checkSum:c},l=new Uint8Array(XI(c,2)),u=new ArrayBuffer(10),h=new DataView(u);h.setUint32(0,d.serverTs),h.setUint16(4,d.seq),h.setUint16(6,d.length),h.setUint16(8,d.checkSum);const p=16-o.length%16;o=KI(o,new Uint8Array(p));const T=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r,tagLength:128,additionalData:l},s,o);return KI(new Uint8Array(u),new Uint8Array(T))}(this._encryptDataStreamIv,this._encryptDataStreamKey,t.payload)),new Blob([t.payload]).size>1024)throw new D(S.INVALID_PARAMS,n?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(it.DATA_STREAM,{payload:Qr(t.payload),syncWithAudio:t.syncWithAudio,sendTs:Date.now()-OW},!i)}sendMetadata(t){if(!this._joinInfo)throw new D(S.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new D(S.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(it.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Qr(t)})}async sendCustomReportMessage(t){if(Array.isArray(t)||(t=[t]),t.forEach(zG),!this._joinInfo)throw new D(S.INVALID_OPERATION,"can not send custom report, not joined");await Q.sendCustomReportMessage(this._joinInfo.sid,t)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(t,e){Ce(e.spatialLayer,"spatialLayer",[0,1,2,3]),Ce(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,e)}catch(i){throw _.error("[".concat(this._clientId,"] pick SVC layer failed"),i.toString()),i}}async setRTMConfig(t){const{apRTM:e=!1,rtmFlag:i}=t;if(Cr(e,"apRTM"),Pt(i,"rtmFlag",0),this._rtmConfig.apRTM=e,this._rtmConfig.rtmFlag=i,_.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(t)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=e,this._joinInfo.rtmFlag=i,this._gateway.setRTM2Flag(i)}_reset(){if(_.debug("[".concat(this._clientId,"] reset client")),function(t){const e=ra.indexOf(t);e!==-1&&ra.splice(e,1)}(this._clientId),this.store.hasStartJoinChannel=!1,this.store.isABTestSuccess=!1,this._axiosCancelSource.cancel(),this._axiosCancelSource=li.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&Xw(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&Q.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy(),t._dataChannels&&(t._dataChannels.forEach(e=>e._close()),t._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Ke("client-publish",this._clientId),this._subscribeMutex=new Ke("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(t,e){var i;const n=t||ks();t?_.debug("[".concat(this._clientId,"] new Session ").concat(n)):_.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(n));const r=t?"":this._sessionId||"";this._sessionId=n,this.store.sessionId=n,Q.addSid(n);const s={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:(e==null?void 0:e.stringUid)||((i=this._joinInfo)===null||i===void 0?void 0:i.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:this.role==="audience"?2:1};Q.sessionInit(this._sessionId,In({cname:e.channel,appid:e.appId},s)),this._joinInfo&&(this._joinInfo.sid=n),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=n)}async _publishHighStream(t){if(!this._joinInfo||this._uid===void 0)throw new D(S.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&C("FORCE_TURN")&&!C("TURN_ENABLE_TCP")&&!C("TURN_ENABLE_UDP"))throw new D(S.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");_.debug("[".concat(this._clientId,"] publish high stream"));try{const i=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter);if(this.store.useP2P){const n=(await i.next()).value;if(n){try{await this._gateway.sendExtensionMessage(ae.PUBLISH,n,!0)}catch(r){throw i.throw(r),r}await i.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const n=(await i.next()).value;if(n){var e;let r;try{r=await this._gateway.publish(this._uid,n,!0)}catch(s){if(s.code!==S.DISCONNECT_P2P)throw i.throw(s),s}await i.next(((e=r)===null||e===void 0?void 0:e.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const r of t)r instanceof Gt&&r._encoderConfig&&this._gateway.setVideoProfile(r._encoderConfig).catch(s=>{_.debug("[".concat(this._clientId,"] stop setVideoProfile, because websocket is closed"))}),!r.muted&&r.enabled||await this._p2pChannel.muteLocalTrack(r)}}catch(i){if(this._p2pChannel.reportPublishEvent(!1,i==null?void 0:i.code,t),(i==null?void 0:i.code)===S.WS_ABORT)return;throw i}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new D(S.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(S.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));_.debug("[".concat(this._clientId,"] publish low stream"));const t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{const i=await this._p2pChannel.publishLowStream(this._lowStreamParameter),n=(await i.next()).value;if(n){var e;let r;try{r=await this._gateway.publish(this._uid,n,!0)}catch(s){if(s.code!==S.DISCONNECT_P2P)throw i.throw(s),s}i.next(((e=r)===null||e===void 0?void 0:e.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(i){if(this._p2pChannel.reportPublishEvent(!1,i==null?void 0:i.code,void 0,!0),(i==null?void 0:i.code)===S.WS_ABORT)return;throw i}}_createLiveStreamingClient(t){const e=()=>{if(!this._joinInfo||!this._appId)return new D(S.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const i=(n={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},ns("LiveStreaming").create(n));var n;return i.onLiveStreamError=(r,s)=>{Q.reportApiInvoke(this._sessionId,{name:fe.ON_LIVE_STREAM_ERROR,options:[r,s],tag:Qt.TRACER}).onSuccess(),this.safeEmit(dt.LIVE_STREAMING_ERROR,r,s)},i.onLiveStreamWarning=(r,s)=>{Q.reportApiInvoke(this._sessionId,{name:fe.ON_LIVE_STREAM_WARNING,options:[r,s],tag:Qt.TRACER}).onSuccess(),this.safeEmit(dt.LIVE_STREAMING_WARNING,r,s)},i.on(im.REQUEST_WORKER_MANAGER_LIST,(r,s,o)=>{if(!this._joinInfo)return o(new D(S.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(a,c,d,l){const u=C("UAP_AP").slice(0,C("AJAX_REQUEST_CONCURRENT")).map(h=>c.proxyServer?"https://".concat(c.proxyServer,"/ap/?url=").concat(h+"/api/v1?action=uap"):"https://".concat(h,"/api/v1?action=uap"));return await pW(u,a,c,d,l)})(r,this._joinInfo,this._axiosCancelSource.token,ge).then(s).catch(o)}),i};return t===Ar.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||e(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||e(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new D(S.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:i}=this.getLocalVideoStats(),n=(t={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:e,height:i}},ns("ChannelMediaRelay").create(t));n.on("state",r=>{r===Si.RELAY_STATE_FAILURE&&n&&n.dispose(),this.safeEmit(dt.CHANNEL_MEDIA_RELAY_STATE,r)}),n.on("event",r=>{this.safeEmit(dt.CHANNEL_MEDIA_RELAY_EVENT,r)}),this._channelMediaRelayClient=n,this._statsCollector.onStatsChanged=(r,s)=>{var o;r==="resolution"&&((o=this._channelMediaRelayClient)===null||o===void 0||o.setVideoProfile(s))}}var t;return this._channelMediaRelayClient}_handleUpdateDataChannel(t,e){const{added:i,deleted:n}=t,r=[];if(e){const s=[];this._users.forEach(o=>{o._dataChannels.forEach(a=>{i.every(c=>c.uid!==o._uintid||c.stream_id!==a.id)&&s.push({uid:o._uintid,stream_id:a.id,ordered:a.ordered,max_retrans_times:a.maxRetransmits,metadata:a.metadata})})}),s.length>0&&this._handleUpdateDataChannel({added:[],deleted:s})}Array.isArray(i)&&i.length>0&&i.forEach(s=>{const{uid:o,stream_id:a,ordered:c,max_retrans_times:d,metadata:l}=s,u=this._users.find(h=>h._uintid===o);if(!u)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(_.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(o)),B(r).call(r,u)||r.push(u),u._uintid||(u._uintid=o),u._dataChannels.findIndex(h=>h.id===s.stream_id)===-1){const h={id:a,ordered:!!c,maxRetransmits:d,metadata:l},p=function(T){return rw(T,!0)}(h);u._dataChannels.push(p),_.info("[".concat(this._clientId,"] remote user ").concat(u.uid," published datachannel")),e||this.safeEmit(dt.USER_PUBLISHED,u,"datachannel",h)}this._p2pChannel.hasPendingRemoteDataChannel(u,s.stream_id)&&(_.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(u.uid," after reconnect.")),this._subscribeDataChannel(u,s.stream_id).catch(h=>{_.error("[".concat(this._clientId,"] resubscribe datachannel error"),h.toString())}))}),e&&(this.safeEmit(dt.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(n)&&n.length>0&&n.forEach(s=>{const{uid:o,stream_id:a}=s,c=this._users.find(l=>l._uintid===o);if(!c)return void _.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const d=c._dataChannels.find(l=>l.id===s.stream_id);d&&(_.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(o)),this._p2pChannel.unsubscribeDataChannel(c,[d]).then(l=>{if(c._dataChannels=c._dataChannels.filter(u=>u!==d),l)return this._gateway.unsubscribeDataChannel(l,c.uid)}),_.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished datachannel ,id:").concat(d.id)),this.safeEmit(dt.USER_UNPUBLISHED,c,"datachannel",d._config))})}_handleRemoveDataChannels(t){const e=this._users.find(i=>i.uid===t.uid);if(e){if(e._dataChannels!==void 0&&e._dataChannels.length>0){_.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));const i=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished datachannel")),e._dataChannels.forEach(n=>{this.safeEmit(dt.USER_UNPUBLISHED,e,"datachannel",n._config)})};this._p2pChannel.unsubscribeDataChannel(e,e._dataChannels).then(n=>{if(n)return this._gateway.unsubscribeDataChannel(n,e.uid)}),i()}}else _.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Oe.UPDATE_GATEWAY_CONFIG,()=>{(function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void _.error("Error loading sdk config",e.message)}if(t)try{const e=JSON.parse(window.atob(t)),i=Date.now();Object.keys(e).forEach(n=>{const{value:r,type:s,expires:o}=e[n];o&&o<=i||s||JE()||!Object.prototype.hasOwnProperty.call(ql,n)||(xn[n]=r,zt[n]=r,_.debug("Update gateway parameters from config distribute",n,r))})}catch(e){_.error("Error update config from local cache",e.message)}})()}),this._gateway.on(Oe.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(Oe.CONNECTION_STATE_CHANGE,(t,e,i)=>{var n;if(i===It.FALLBACK)return;const r=()=>{this.safeEmit(dt.CONNECTION_STATE_CHANGE,t,e,i)};if(Q.reportApiInvoke(this._sessionId||((n=this._gateway.joinInfo)===null||n===void 0?void 0:n.sid)||null,{name:fe.CONNECTION_STATE_CHANGE,options:[t,e,i],tag:Qt.TRACER}).onSuccess(JSON.stringify({cur:t,prev:e,reason:i})),_.info("[".concat(this._clientId,"] signal connection state change: ").concat(e," -> ").concat(t)),t==="DISCONNECTED")return this._reset(),void r();if(t==="RECONNECTING")this._users.forEach(o=>{o._trust_in_room_=!1,o._trust_audio_enabled_state_=!1,o._trust_video_enabled_state_=!1,o._trust_audio_mute_state_=!1,o._trust_video_mute_state_=!1,o._trust_audio_stream_added_state_=!1,o._trust_video_stream_added_state_=!1,o._is_pre_created||(o._audio_pre_subscribed||(o._audioSSRC=void 0,o._audioOrtc=void 0),o._video_pre_subscribed||(o._videoSSRC=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),o._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(t==="CONNECTED"){var s;this._streamFallbackTypeCacheMap.forEach((o,a)=>{this._gateway.setStreamFallbackOption(a,o).catch(c=>{_.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),c)})}),this._remoteStreamTypeCacheMap.forEach((o,a)=>{this._gateway.setRemoteVideoStreamType(a,o).catch(c=>{_.warning("[".concat(this._clientId,"] auto set remote stream type failed"),c)})}),this._remoteDefaultVideoStreamType!==void 0&&((s=this._joinInfo)===null||s===void 0?void 0:s.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{_.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(o=>{_.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(o))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(o=>!o._trust_in_room_).forEach(o=>{_.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(o.uid)),this._handleUserOffline({uid:o.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(o=>{o._trust_audio_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(o.uid)),this._handleMuteStream(o.uid,q.AUDIO,!1)),o._trust_video_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(o.uid)),this._handleMuteStream(o.uid,q.VIDEO,!1)),o._trust_audio_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(o.uid)),this._handleSetStreamLocalEnable("audio",o.uid,!0)),o._trust_video_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(o.uid)),this._handleSetStreamLocalEnable("video",o.uid,!0)),o._trust_video_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(o.uid)),this._handleResetAddStream(o,"video")),o._trust_audio_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(o.uid)),this._handleResetAddStream(o,"audio")),o._video_added_||o._audio_added_||(_.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(o.uid)),this._handleRemoveStream({uid:o.uid,uint_id:o._uintid}))}))},1e3))}r()}),this._gateway.on(Oe.REQUEST_NEW_GATEWAY_LIST,async(t,e)=>{if(!this._joinInfo)return e(new D(S.UNEXPECTED_ERROR,"can not recover, no join info"));try{let i;const n=await zw(In(In({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));n?(i=n.ap,Qw(n),this._joinInfo.preload=!0):(i=await gm(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||ge,this.store),this._joinInfo.preload=!1),this._joinInfo&&(this._joinInfo.apResponse=i.gatewayInfo.res,this._joinInfo.gatewayAddrs=i.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=i.gatewayInfo.uni_lbs_ip);const r=[];i.gatewayInfo.gatewayAddrs.forEach(s=>{let{address:o}=s;const[a,c]=o.split(":");this._joinInfo&&this._joinInfo.proxyServer?r.push({proxy:this._joinInfo.proxyServer,host:a,port:c}):r.push({host:a,port:c})}),t(r)}catch(i){e(i)}}),this._gateway.on(Oe.NETWORK_QUALITY,t=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(dt.NETWORK_QUALITY,t)}),this._gateway.on(Oe.STREAM_TYPE_CHANGE,(t,e)=>{this.safeEmit(dt.STREAM_TYPE_CHANGED,t,e),Q.reportApiInvoke(this._sessionId,{name:fe.STREAM_TYPE_CHANGE,options:[t,e],tag:Qt.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:e}))}),this._gateway.on(Oe.IS_P2P_DISCONNECTED,t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0)}),this._gateway.on(Oe.REQUEST_P2P_CONNECTION_PARAMS,async(t,e,i)=>{try{let n=await this._p2pChannel.getEstablishParams();C("ENABLE_PREALLOC_PC")&&n||(n=await this._p2pChannel.startP2PConnection(t)),e(n)}catch(n){i(n)}}),this._gateway.on(Oe.JOIN_RESPONSE,(t,e)=>{if(this.store.useP2P)return;let i;t.attributes?i=t.attributes.userAttributes.preSubSsrcs:_.debug("no attributes in joinResponse");const n=Yb(t.ortc,e,i);this._p2pChannel.connect(n)}),this._gateway.on(Oe.PRE_CONNECT_PC,async t=>{const{candidates:e,fingerprint:i}=t;if(this._joinInfo&&e.length>0&&!this._p2pChannel.isPlanB){var n;await this._p2pChannel.startP2PConnection({turnServer:this._joinInfo.turnServer});const{cert:r,cid:s}=this._joinInfo.apResponse;await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(s,"_").concat(r),icePwd:"".concat(s,"_").concat(r)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:(n=C("FINGERPRINT"))!==null&&n!==void 0?n:i}]},candidates:e,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0})}})}_handleGatewaySignalEvents(){this._gateway.signal.on(ut.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(ut.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(ut.ON_ADD_AUDIO_STREAM,t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc)),this._gateway.signal.on(ut.ON_ADD_VIDEO_STREAM,t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc,t.rtxSsrcId)),this._gateway.signal.on(ut.ON_REMOTE_DATASTREAM_UPDATE,t=>{this._handleUpdateDataChannel(t)}),this._gateway.signal.on(ut.ON_REMOTE_FULL_DATASTREAM_INFO,t=>{this._handleUpdateDataChannel({added:t.datastreams||[],deleted:[]},!0)}),this._gateway.signal.on(ut.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(ut.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(ut.MUTE_AUDIO,t=>this._handleMuteStream(t.uid,q.AUDIO,!0)),this._gateway.signal.on(ut.UNMUTE_AUDIO,t=>this._handleMuteStream(t.uid,q.AUDIO,!1)),this._gateway.signal.on(ut.MUTE_VIDEO,t=>this._handleMuteStream(t.uid,q.VIDEO,!0)),this._gateway.signal.on(ut.UNMUTE_VIDEO,t=>this._handleMuteStream(t.uid,q.VIDEO,!1)),this._gateway.signal.on(ut.RECEIVE_METADATA,t=>{const e=Ls(t.metadata);this.safeEmit(dt.RECEIVE_METADATA,t.uid,e)}),this._gateway.signal.on(ut.ON_DATA_STREAM,async t=>{var e;if(!t)return;let i=Ls(t.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&B(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)){if(t.payload.length<10)throw new D(S.UNEXPECTED_RESPONSE,"payload length ".concat(t.payload.length," is less than header length ").concat(10));i=await async function(s,o,a){const c=a.subarray(0,10),d=c.slice(8,10),l=(d[0]<<8)+d[1],u=(c[6]<<8)+c[7],h=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:s,tagLength:128,additionalData:new Uint8Array(XI(l,2))},o,a.subarray(10));return new Uint8Array(h).subarray(0,u)}(this._encryptDataStreamIv,this._encryptDataStreamKey,i)}let n=0;if(t.ordered||t.syncWithAudio){const r=this._p2pChannel.getStats(),s=this.remoteUsers.find(a=>a.uid===t.uid),o=r==null?void 0:r.audioRecv.find(a=>a.ssrc===(s==null?void 0:s._audioSSRC));n=o==null?void 0:o.jitterBufferMs}(n==null||Number.isNaN(n))&&(n=0),NW(In(In({},t),{},{payload:i}),n,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(ut.ON_CRYPT_ERROR,()=>{Xr(()=>{_.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(dt.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(ut.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(ut.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{_.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,It.TOKEN_EXPIRE),this.safeEmit(dt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(ut.ON_STREAM_FALLBACK_UPDATE,t=>{_.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(dt.STREAM_FALLBACK,t.stream_id,t.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(ut.ON_PUBLISH_STREAM,t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),_.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))}),this._gateway.signal.on(ut.ENABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!0)}),this._gateway.signal.on(ut.DISABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!1)}),this._gateway.signal.on(nt.REQUEST_TIMEOUT,(t,e)=>{if(this._joinInfo)switch(t){case it.PUBLISH:{if(!e)return;const r=e.ortc;if(r){var i,n;const s=r.some(c=>{let{stream_type:d}=c;return d===At.Audio}),o=r.some(c=>{let{stream_type:d}=c;return d!==At.Audio}),a=r.some(c=>{let{stream_type:d}=c;return d===At.Screen||d===At.ScreenLow});e.state==="offer"&&Q.publish(this._joinInfo.sid,{eventElapse:qe.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:S.TIMEOUT,audio:s,video:o,p2pid:e.p2p_id,publishRequestid:this.store.pubId,screenshare:a,audioName:s?(i=r.find(c=>{let{stream_type:d}=c;return d===At.Audio}))===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId.toString():void 0,videoName:o?(n=r.find(c=>{let{stream_type:d}=c;return d!==At.Audio}))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0})}break}case it.SUBSCRIBE:e&&Q.subscribe(this._joinInfo.sid,{succ:!1,ec:S.TIMEOUT,audio:e.stream_type===q.AUDIO,video:e.stream_type===q.VIDEO,peerid:e.stream_id,subscribeRequestid:e.ssrcId,p2pid:this.store.p2pId,eventElapse:qe.measureFromSubscribeStart(this.store.clientId,e.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(e.ssrcId)})}}),this._gateway.signal.on(ut.ON_P2P_OK,t=>{this.uid,this._uid}),this._gateway.signal.on(ut.ON_PUBLISHED_USER_LIST,t=>{if(t==null||!t.users)return;C("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter(n=>!Gs(n.string_id||n.stream_id,this.channelName)));const e=[],i=[];for(const n of t.users){let r=this._users.find(l=>l._uintid===n.stream_id);r?r._trust_in_room_=!0:(r=new rs(n.string_id||n.stream_id,n.stream_id),this._users.push(r),this.getListeners(dt.PUBLISHED_USER_LIST).length===0&&(_.debug("[".concat(this._clientId,"] user online"),n.stream_id),this.safeEmit(dt.USER_JOINED,r)));const s=Ae.Audio&n.stream_type,o=(Ae.Video|Ae.LwoVideo)&n.stream_type,a=!!(65280&n.stream_type),c=s&&r.hasAudio,d=o&&r.hasVideo;o&&(r._trust_video_stream_added_state_=!0,r._video_added_=!0,r._videoSSRC=n.video_ssrc,r._rtxSsrcId=n.video_rtx),s&&(r._trust_audio_stream_added_state_=!0,r._audio_added_=!0,r._audioSSRC=n.audio_ssrc),s&&!c&&this.getListeners(dt.PUBLISHED_USER_LIST).length===0&&(_.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published audio")),this.safeEmit(dt.USER_PUBLISHED,r,"audio")),o&&!d&&this.getListeners(dt.PUBLISHED_USER_LIST).length===0&&(_.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published video")),this.safeEmit(dt.USER_PUBLISHED,r,"video")),(s&&!c||o&&!d||a)&&e.push(r),o&&this._p2pChannel.hasPendingRemoteMedia(r,"video")&&i.push({user:r,mediaType:"video"}),s&&this._p2pChannel.hasPendingRemoteMedia(r,"audio")&&i.push({user:r,mediaType:"audio"})}i.length>0&&(_.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(i.map(n=>"user: ".concat(n.user.uid,", mediaType: ").concat(n.mediaType)).join("; ")," ")),this.massSubscribe(i).catch(n=>{_.error("[".concat(this._clientId,"] mass resubscribe error"),n.toString())})),this.getListeners(dt.PUBLISHED_USER_LIST).length>0?C("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=e:(_.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(e.map(n=>n.uid).join(", "))),this.safeEmit(dt.PUBLISHED_USER_LIST,e)):_.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(e.map(n=>n.uid).join(", ")))}),this._gateway.signal.on(ut.ON_RTP_CAPABILITY_CHANGE,t=>{const{video_codec:e}=t;this._p2pChannel instanceof kc&&this._p2pChannel.updateRemoteRTPCapabilities(e.map(i=>i.toLowerCase()).filter(i=>{var n;return B(n=Object.keys(zl)).call(n,i)}))})}_handleP2PEvents(){this._gateway.signal.on(ut.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(ae.PUBLISH,(t,e,i)=>{const{uid:n}=t;t.forEach(r=>{const{kind:s,ssrcs:o,mid:a,isMuted:c}=r;this._handleP2PAddAudioOrVideoStream(s,n,o[0].ssrcId,a);const d=this._users.find(l=>l.uid===n);return d&&this.store.useP2P?this._p2pChannel.mockSubscribe(d,s,o[0].ssrcId,a).then(()=>{e()}).catch(i):e(),this._handleMuteStream(n,s,!!c)})}),this._gateway.signal.on(ae.CALL,async(t,e,i)=>{if(this.store.useP2P)try{var n;e(await this._p2pChannel.startP2P({turnServer:(n=this._joinInfo)===null||n===void 0?void 0:n.turnServer},t))}catch(r){i(r)}}),this._gateway.signal.on(nt.P2P_CONNECTION,async t=>{this.store.useP2P&&(await this._p2pChannel).p2pConnect(t)}),this._gateway.signal.on(ae.UNPUBLISH,async(t,e,i)=>{if(this.store.useP2P){const{unpubMsg:n,uid:r}=t,s=this._users.find(o=>o.uid===r);if(!s)return _.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void e();try{n.forEach(async o=>{let{stream_type:a}=o;const c=a===At.Audio?q.AUDIO:q.VIDEO;await this._p2pChannel.unsubscribe(s,c),this._handleMuteStream(r,c,!0)}),e()}catch(o){i(o)}}}),this._gateway.signal.on(ae.CONTROL,async(t,e)=>{const{action:i}=t;switch(i){case ts.MUTE_LOCAL_VIDEO:this._handleMuteStream(e,q.VIDEO,!0);break;case ts.MUTE_LOCAL_AUDIO:this._handleMuteStream(e,q.AUDIO,!0);break;case ts.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",e),this._handleMuteStream(e,q.VIDEO,!1);break;case ts.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",e),this._handleMuteStream(e,q.AUDIO,!1)}}),this._gateway.signal.on(ae.RESTART_ICE,async(t,e,i)=>{if(this.store.useP2P)try{const{direction:n,iceParameter:r}=t;n!==oi.SEND_ONLY||r?e(await this._p2pChannel.restartICE(n,r)):(this._p2pChannel.handleDisconnect(n),e())}catch(n){i(n)}}),this._gateway.signal.on(ae.CANDIDATE,t=>{if(this.store.useP2P){const{candidate:e,direction:i}=t;this._p2pChannel.addRemoteCandidate(e,i)}}),this._p2pChannel.on(Z.RequestP2PRestartICE,async(t,e,i)=>{try{const{direction:n}=t;e(await this._gateway.sendExtensionMessage(ae.RESTART_ICE,t,n===oi.SEND_ONLY))}catch(n){i(n)}}),this._p2pChannel.on(Z.LocalCandidate,t=>{this._gateway.sendExtensionMessage(ae.CANDIDATE,JSON.stringify(t),!0)}),this._p2pChannel.on(Z.RequestP2PMuteLocal,async(t,e,i)=>{try{await this._gateway.sendExtensionMessage(ae.CONTROL,t,!0),e()}catch(n){i(n)}}),this._p2pChannel.on(Z.RequestP2PUnmuteRemote,async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(n){n.code===S.DISCONNECT_P2P?e():i(n)}else e()}),this._p2pChannel.on(Z.RequestP2PMuteRemote,async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.muteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(n){n.code===S.DISCONNECT_P2P?e():i(n)}else e()}),this._p2pChannel.on(Z.StateChange,(t,e)=>{e===yt.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(Z.PeerConnectionStateChange,t=>{const e=this._peerConnectionState;t!==e&&(this.safeEmit(dt.PEERCONNECTION_STATE_CHANGE,t,e),this._peerConnectionState=t)}),this._p2pChannel.on(Z.RequestMuteLocal,async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(n){n.code===S.DISCONNECT_P2P?e():i(n)}else e()}),this._p2pChannel.on(Z.RequestUnmuteLocal,async(t,e,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(n){n.code===S.DISCONNECT_P2P?e():i(n)}else e()}),this._p2pChannel.on(Z.RequestRePublish,(t,e,i)=>{this.publish(t,!1).then(e).catch(i)}),this._p2pChannel.on(Z.RequestRePublishDataChannel,(t,e,i)=>{G.all(t.map(async n=>{const r=await this._p2pChannel.publishDataChannel([n]);try{r.forEach(s=>{this._uid&&this._gateway.publishDataChannel(this._uid,s,!0)})}catch(s){if(s.code!==S.DISCONNECT_P2P)throw s}})).then(e).catch(i)}),this._p2pChannel.on(Z.RequestReSubscribe,async(t,e,i)=>{try{for(const{user:n,kind:r}of t)r===q.VIDEO?await this.subscribe(n,"video"):await this.subscribe(n,"audio");e()}catch(n){i(n)}}),this._p2pChannel.on(Z.RequestUpload,(t,e)=>{this._gateway.upload(t,e)}),this._p2pChannel.on(Z.RequestUploadStats,t=>{this._gateway.uploadWRTCStats(t)}),this._p2pChannel.on(Z.MediaReconnectStart,t=>{this.safeEmit(dt.MEDIA_RECONNECT_START,t)}),this._p2pChannel.on(Z.MediaReconnectEnd,t=>{this.safeEmit(dt.MEDIA_RECONNECT_END,t)}),this._p2pChannel.on(Z.NeedSignalRTT,t=>{t(this._gateway.getSignalRTT())}),this._p2pChannel.on(Z.RequestRestartICE,async t=>{if(this.store.useP2P)return;const e=await this._p2pChannel.restartICE(t),i=await e.next();if(i.done)return;const n=i.value;let r;try{r=await this._gateway.restartICE({iceParameters:n})}catch(o){return void e.throw(o)}const{iceParameters:s}=function(o){const a=o.iceParameters;return{iceParameters:{iceUfrag:a.iceUfrag,icePwd:a.icePwd}}}(r);await e.next({remoteIceParameters:s})}),this._p2pChannel.on(Z.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(Z.RequestReconnectPC,async()=>{var t;const{iceParameters:e,dtlsParameters:i,rtpCapabilities:n}=await this._p2pChannel.startP2PConnection({turnServer:(t=this._joinInfo)===null||t===void 0?void 0:t.turnServer}),{gatewayEstablishParams:r,gatewayAddress:s}=await this._gateway.reconnectPC({iceParameters:e,dtlsParameters:i,rtpCapabilities:n}),o=Yb(r,s);await this._p2pChannel.connect(o),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(Z.RequestUnpublishForReconnectPC,async(t,e,i)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(t,this._uid),e()):i()}),this._p2pChannel.on(Z.P2PLost,()=>{this.safeEmit(dt.P2P_LOST,this.store.uid)}),this._p2pChannel.on(Z.UpdateVideoEncoder,t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig)}),this._p2pChannel.on(Z.ConnectionTypeChange,t=>{this.safeEmit(dt.IS_USING_CLOUD_PROXY,t)}),this._p2pChannel.on(Z.RequestLowStreamParameter,t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(Z.QueryClientConnectionState,t=>{t(this.connectionState)}),this._p2pChannel.on(Z.AudioMetadata,t=>{this.safeEmit(dt.AUDIO_METADATA,t)})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(t){if(!this._joinInfo||this.connectionState!=="CONNECTED")throw new D(S.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new D(S.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{const i=(e={config:t},ns("ContentInspect").create(e));this._inspect=i,this.handleVideoInspectEvents(i);const{appId:n,cname:r,sid:s,token:o,uid:a,cid:c,vid:d}=this._joinInfo;await i.init({appId:n,areaCode:"",cname:r,sid:s,token:o,uid:a,cid:c,vid:d?Number(d):0},ge)}catch(i){throw Array.isArray(i)?i[0]:i}var e}handleVideoInspectEvents(t){t.on(Ne.CONNECTION_STATE_CHANGE,(e,i)=>{if(this.safeEmit(dt.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,i),i===Sn.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(dt.CONTENT_INSPECT_ERROR,new D(S.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}}),t.on(Ne.INSPECT_RESULT,(e,i)=>{var n;if((i==null?void 0:i.code)===S.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return _.debug("Stop inspect content because that has left channel"),this==null||(n=this._inspect)===null||n===void 0||n.close(),void(this._inspect=void 0);this.safeEmit(dt.CONTENT_INSPECT_RESULT,e,i)}),t.on(Ne.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(i=>i.trackMediaType==="video")[0])})}async disableContentInspect(){if(!this._inspect)throw new D(S.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}async setImageModeration(t,e){if(Cr(t,"enabled"),t){if(!e)throw new D(S.INVALID_PARAMS,"config is required");if(hO(e),!this._joinInfo)throw new D(S.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(e);else{const n=(i={config:e},ns("ImageModeration").create(i));this._moderation=n,this.handleImageModerationEvents(n);const{appId:r,cname:s,sid:o,token:a,uid:c,cid:d,vid:l}=this._joinInfo;await n.init({appId:r,areaCode:"",cname:s,sid:o,token:a,uid:c,cid:d,vid:l?Number(l):0},ge)}}catch(n){throw Array.isArray(n)?n[0]:n}}else{var i;if(!this._moderation)throw new D(S.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(n){throw Array.isArray(n)?n[0]:n}}}handleImageModerationEvents(t){t.on(Bn.CONNECTION_STATE_CHANGE,(e,i)=>{if(this.safeEmit(dt.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,e,i),e===en.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new D(S.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage()}}),t.on(Bn.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(i=>i.trackMediaType==="video")[0])})}setP2PTransport(t){if(function(e){Ce(e,"transport",["default","auto","relay","sd-rtn"])}(t),this.mode!=="p2p")throw new D(S.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=t,_.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(t))}getJoinChannelServiceRecords(){return _.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(t){Cr(t,"enabled"),Ot("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(t)}_handleResetAddStream(t,e){switch(e){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}},J(H.prototype,"leave",[pO],Object.getOwnPropertyDescriptor(H.prototype,"leave"),H.prototype),J(H.prototype,"publish",[_O],Object.getOwnPropertyDescriptor(H.prototype,"publish"),H.prototype),J(H.prototype,"unpublish",[EO],Object.getOwnPropertyDescriptor(H.prototype,"unpublish"),H.prototype),J(H.prototype,"subscribe",[mO],Object.getOwnPropertyDescriptor(H.prototype,"subscribe"),H.prototype),J(H.prototype,"presubscribe",[fO],Object.getOwnPropertyDescriptor(H.prototype,"presubscribe"),H.prototype),J(H.prototype,"massSubscribe",[gO],Object.getOwnPropertyDescriptor(H.prototype,"massSubscribe"),H.prototype),J(H.prototype,"unsubscribe",[TO],Object.getOwnPropertyDescriptor(H.prototype,"unsubscribe"),H.prototype),J(H.prototype,"massUnsubscribe",[SO],Object.getOwnPropertyDescriptor(H.prototype,"massUnsubscribe"),H.prototype),J(H.prototype,"setLowStreamParameter",[RO],Object.getOwnPropertyDescriptor(H.prototype,"setLowStreamParameter"),H.prototype),J(H.prototype,"enableDualStream",[vO],Object.getOwnPropertyDescriptor(H.prototype,"enableDualStream"),H.prototype),J(H.prototype,"disableDualStream",[CO],Object.getOwnPropertyDescriptor(H.prototype,"disableDualStream"),H.prototype),J(H.prototype,"setClientRole",[IO],Object.getOwnPropertyDescriptor(H.prototype,"setClientRole"),H.prototype),J(H.prototype,"_setClientRoleOptions",[yO],Object.getOwnPropertyDescriptor(H.prototype,"_setClientRoleOptions"),H.prototype),J(H.prototype,"setProxyServer",[AO],Object.getOwnPropertyDescriptor(H.prototype,"setProxyServer"),H.prototype),J(H.prototype,"setTurnServer",[bO],Object.getOwnPropertyDescriptor(H.prototype,"setTurnServer"),H.prototype),J(H.prototype,"setLicense",[wO],Object.getOwnPropertyDescriptor(H.prototype,"setLicense"),H.prototype),J(H.prototype,"startProxyServer",[OO],Object.getOwnPropertyDescriptor(H.prototype,"startProxyServer"),H.prototype),J(H.prototype,"stopProxyServer",[NO],Object.getOwnPropertyDescriptor(H.prototype,"stopProxyServer"),H.prototype),J(H.prototype,"setLocalAccessPointsV2",[DO],Object.getOwnPropertyDescriptor(H.prototype,"setLocalAccessPointsV2"),H.prototype),J(H.prototype,"setLocalAccessPoints",[PO],Object.getOwnPropertyDescriptor(H.prototype,"setLocalAccessPoints"),H.prototype),J(H.prototype,"setRemoteDefaultVideoStreamType",[LO],Object.getOwnPropertyDescriptor(H.prototype,"setRemoteDefaultVideoStreamType"),H.prototype),J(H.prototype,"setRemoteVideoStreamType",[kO],Object.getOwnPropertyDescriptor(H.prototype,"setRemoteVideoStreamType"),H.prototype),J(H.prototype,"setStreamFallbackOption",[MO],Object.getOwnPropertyDescriptor(H.prototype,"setStreamFallbackOption"),H.prototype),J(H.prototype,"setEncryptionConfig",[UO],Object.getOwnPropertyDescriptor(H.prototype,"setEncryptionConfig"),H.prototype),J(H.prototype,"renewToken",[xO],Object.getOwnPropertyDescriptor(H.prototype,"renewToken"),H.prototype),J(H.prototype,"enableAudioVolumeIndicator",[VO],Object.getOwnPropertyDescriptor(H.prototype,"enableAudioVolumeIndicator"),H.prototype),J(H.prototype,"startLiveStreaming",[FO],Object.getOwnPropertyDescriptor(H.prototype,"startLiveStreaming"),H.prototype),J(H.prototype,"setLiveTranscoding",[BO],Object.getOwnPropertyDescriptor(H.prototype,"setLiveTranscoding"),H.prototype),J(H.prototype,"stopLiveStreaming",[jO],Object.getOwnPropertyDescriptor(H.prototype,"stopLiveStreaming"),H.prototype),J(H.prototype,"startChannelMediaRelay",[GO],Object.getOwnPropertyDescriptor(H.prototype,"startChannelMediaRelay"),H.prototype),J(H.prototype,"updateChannelMediaRelay",[WO],Object.getOwnPropertyDescriptor(H.prototype,"updateChannelMediaRelay"),H.prototype),J(H.prototype,"stopChannelMediaRelay",[HO],Object.getOwnPropertyDescriptor(H.prototype,"stopChannelMediaRelay"),H.prototype),J(H.prototype,"sendCustomReportMessage",[KO],Object.getOwnPropertyDescriptor(H.prototype,"sendCustomReportMessage"),H.prototype),J(H.prototype,"pickSVCLayer",[YO],Object.getOwnPropertyDescriptor(H.prototype,"pickSVCLayer"),H.prototype),J(H.prototype,"setRTMConfig",[qO],Object.getOwnPropertyDescriptor(H.prototype,"setRTMConfig"),H.prototype),J(H.prototype,"enableContentInspect",[zO],Object.getOwnPropertyDescriptor(H.prototype,"enableContentInspect"),H.prototype),J(H.prototype,"disableContentInspect",[JO],Object.getOwnPropertyDescriptor(H.prototype,"disableContentInspect"),H.prototype),J(H.prototype,"setImageModeration",[XO],Object.getOwnPropertyDescriptor(H.prototype,"setImageModeration"),H.prototype),J(H.prototype,"setP2PTransport",[QO],Object.getOwnPropertyDescriptor(H.prototype,"setP2PTransport"),H.prototype),J(H.prototype,"getJoinChannelServiceRecords",[ZO],Object.getOwnPropertyDescriptor(H.prototype,"getJoinChannelServiceRecords"),H.prototype),J(H.prototype,"setPublishAudioFilterEnabled",[$O],Object.getOwnPropertyDescriptor(H.prototype,"setPublishAudioFilterEnabled"),H.prototype),H);class xc{constructor(e,i){g(this,"id",0),g(this,"element",void 0),g(this,"peerPair",void 0),g(this,"context",void 0),g(this,"audioPlayerElement",void 0),g(this,"audioTrack",void 0),xc.count+=1,this.id=xc.count,this.element=e,this.context=i}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const i=document.createElement("audio");i.srcObject=new MediaStream([e.track]),i.play(),this.audioPlayerElement=i}}async switchSdp(){if(!this.peerPair)return;const e=async(n,r)=>{const s=r==="offer"?await n.createOffer():await n.createAnswer();return await n.setLocalDescription(s),n.iceGatheringState==="complete"?n.localDescription:new G(o=>{n.onicegatheringstatechange=()=>{n.iceGatheringState==="complete"&&o(n.localDescription)}})},i=async(n,r)=>await n.setRemoteDescription(r);try{const n=await e(this.peerPair[0],"offer");await i(this.peerPair[1],n);const r=await e(this.peerPair[1],"answer");await i(this.peerPair[0],r)}catch(n){throw new D(S.LOCAL_AEC_ERROR,n.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let i;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),i=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(i)}catch(r){throw new D(S.LOCAL_AEC_ERROR,r.toString()).print()}if(!i)throw new D(S.LOCAL_AEC_ERROR,"no dest node when local aec").print();const n=i.stream.getAudioTracks()[0];return this.audioTrack=n,n}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,i=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(i),await this.switchSdp()}close(){_.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(e=>{e.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var e0,Fu;g(xc,"count",0);const KW=window.AudioContext||window.webkitAudioContext,YW=new(e0=tt({report:Q}),J((Fu=class{constructor(){g(this,"units",[]),g(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return _.debug("the system does not need to process local aec"),-1;this.context||(this.context=new KW);let e=this.units.find(i=>i&&i.getElement()===t);return e||(e=new xc(t,this.context),this.units.push(e)),e.startEchoCancellation(),_.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return Tt().name!==Ct.SAFARI}}).prototype,"processExternalMediaAEC",[e0],Object.getOwnPropertyDescriptor(Fu.prototype,"processExternalMediaAEC"),Fu.prototype),Fu);function i0(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function n0(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?i0(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):i0(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}const km=window||document;function r0(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!km)return;const i=Te._cspEventHandlerPointer;if(i&&e)return void console.error(i,e);const n=r=>{if(!(r&&r.blockedURI&&(Te.onSecurityPolicyViolation||Te.getListeners(rr.SECURITY_POLICY_VIOLATION).length>0)))return;const s=r.blockedURI;C("CSP_DETECTED_HOSTNAME_LIST").some(o=>B(s).call(s,o))&&(Te.onSecurityPolicyViolation&&typeof Te.onSecurityPolicyViolation=="function"&&Te.onSecurityPolicyViolation(r),Te.getListeners(rr.SECURITY_POLICY_VIOLATION).length>0&&Te.safeEmit(rr.SECURITY_POLICY_VIOLATION,r))};i&&km.removeEventListener("securitypolicyviolation",i),(e||t&&typeof t=="function"||Te.getListeners(rr.SECURITY_POLICY_VIOLATION).length>0)&&km.addEventListener("securitypolicyviolation",n),Te._cspEventHandlerPointer=n}var qW=ei,zW=HC,s0=RegExp.prototype,JW=function(t){return t===s0||qW(s0,t)?zW(t):t.flags},ti=Bt(JW);function Ta(t){let e=t.length;for(;--e>=0;)t[e]=0}const Mm=256,o0=286,Vc=30,Fc=15,Um=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Bu=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),XW=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),a0=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Pr=new Array(576);Ta(Pr);const Bc=new Array(60);Ta(Bc);const jc=new Array(512);Ta(jc);const Gc=new Array(256);Ta(Gc);const xm=new Array(29);Ta(xm);const ju=new Array(Vc);function Vm(t,e,i,n,r){this.static_tree=t,this.extra_bits=e,this.extra_base=i,this.elems=n,this.max_length=r,this.has_stree=t&&t.length}let c0,d0,l0;function Fm(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}Ta(ju);const u0=t=>t<256?jc[t]:jc[256+(t>>>7)],Wc=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255},qi=(t,e,i)=>{t.bi_valid>16-i?(t.bi_buf|=e<<t.bi_valid&65535,Wc(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=i-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=i)},cr=(t,e,i)=>{qi(t,i[2*e],i[2*e+1])},h0=(t,e)=>{let i=0;do i|=1&t,t>>>=1,i<<=1;while(--e>0);return i>>>1},p0=(t,e,i)=>{const n=new Array(16);let r,s,o=0;for(r=1;r<=Fc;r++)o=o+i[r-1]<<1,n[r]=o;for(s=0;s<=e;s++){let a=t[2*s+1];a!==0&&(t[2*s]=h0(n[a]++,a))}},_0=t=>{let e;for(e=0;e<o0;e++)t.dyn_ltree[2*e]=0;for(e=0;e<Vc;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0},E0=t=>{t.bi_valid>8?Wc(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},m0=(t,e,i,n)=>{const r=2*e,s=2*i;return t[r]<t[s]||t[r]===t[s]&&n[e]<=n[i]},Bm=(t,e,i)=>{const n=t.heap[i];let r=i<<1;for(;r<=t.heap_len&&(r<t.heap_len&&m0(e,t.heap[r+1],t.heap[r],t.depth)&&r++,!m0(e,n,t.heap[r],t.depth));)t.heap[i]=t.heap[r],i=r,r<<=1;t.heap[i]=n},f0=(t,e,i)=>{let n,r,s,o,a=0;if(t.sym_next!==0)do n=255&t.pending_buf[t.sym_buf+a++],n+=(255&t.pending_buf[t.sym_buf+a++])<<8,r=t.pending_buf[t.sym_buf+a++],n===0?cr(t,r,e):(s=Gc[r],cr(t,s+Mm+1,e),o=Um[s],o!==0&&(r-=xm[s],qi(t,r,o)),n--,s=u0(n),cr(t,s,i),o=Bu[s],o!==0&&(n-=ju[s],qi(t,n,o)));while(a<t.sym_next);cr(t,256,e)},jm=(t,e)=>{const i=e.dyn_tree,n=e.stat_desc.static_tree,r=e.stat_desc.has_stree,s=e.stat_desc.elems;let o,a,c,d=-1;for(t.heap_len=0,t.heap_max=573,o=0;o<s;o++)i[2*o]!==0?(t.heap[++t.heap_len]=d=o,t.depth[o]=0):i[2*o+1]=0;for(;t.heap_len<2;)c=t.heap[++t.heap_len]=d<2?++d:0,i[2*c]=1,t.depth[c]=0,t.opt_len--,r&&(t.static_len-=n[2*c+1]);for(e.max_code=d,o=t.heap_len>>1;o>=1;o--)Bm(t,i,o);c=s;do o=t.heap[1],t.heap[1]=t.heap[t.heap_len--],Bm(t,i,1),a=t.heap[1],t.heap[--t.heap_max]=o,t.heap[--t.heap_max]=a,i[2*c]=i[2*o]+i[2*a],t.depth[c]=(t.depth[o]>=t.depth[a]?t.depth[o]:t.depth[a])+1,i[2*o+1]=i[2*a+1]=c,t.heap[1]=c++,Bm(t,i,1);while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((l,u)=>{const h=u.dyn_tree,p=u.max_code,T=u.stat_desc.static_tree,m=u.stat_desc.has_stree,f=u.stat_desc.extra_bits,R=u.stat_desc.extra_base,v=u.stat_desc.max_length;let A,O,w,b,L,x,W=0;for(b=0;b<=Fc;b++)l.bl_count[b]=0;for(h[2*l.heap[l.heap_max]+1]=0,A=l.heap_max+1;A<573;A++)O=l.heap[A],b=h[2*h[2*O+1]+1]+1,b>v&&(b=v,W++),h[2*O+1]=b,O>p||(l.bl_count[b]++,L=0,O>=R&&(L=f[O-R]),x=h[2*O],l.opt_len+=x*(b+L),m&&(l.static_len+=x*(T[2*O+1]+L)));if(W!==0){do{for(b=v-1;l.bl_count[b]===0;)b--;l.bl_count[b]--,l.bl_count[b+1]+=2,l.bl_count[v]--,W-=2}while(W>0);for(b=v;b!==0;b--)for(O=l.bl_count[b];O!==0;)w=l.heap[--A],w>p||(h[2*w+1]!==b&&(l.opt_len+=(b-h[2*w+1])*h[2*w],h[2*w+1]=b),O--)}})(t,e),p0(i,d,t.bl_count)},g0=(t,e,i)=>{let n,r,s=-1,o=e[1],a=0,c=7,d=4;for(o===0&&(c=138,d=3),e[2*(i+1)+1]=65535,n=0;n<=i;n++)r=o,o=e[2*(n+1)+1],++a<c&&r===o||(a<d?t.bl_tree[2*r]+=a:r!==0?(r!==s&&t.bl_tree[2*r]++,t.bl_tree[32]++):a<=10?t.bl_tree[34]++:t.bl_tree[36]++,a=0,s=r,o===0?(c=138,d=3):r===o?(c=6,d=3):(c=7,d=4))},T0=(t,e,i)=>{let n,r,s=-1,o=e[1],a=0,c=7,d=4;for(o===0&&(c=138,d=3),n=0;n<=i;n++)if(r=o,o=e[2*(n+1)+1],!(++a<c&&r===o)){if(a<d)do cr(t,r,t.bl_tree);while(--a!=0);else r!==0?(r!==s&&(cr(t,r,t.bl_tree),a--),cr(t,16,t.bl_tree),qi(t,a-3,2)):a<=10?(cr(t,17,t.bl_tree),qi(t,a-3,3)):(cr(t,18,t.bl_tree),qi(t,a-11,7));a=0,s=r,o===0?(c=138,d=3):r===o?(c=6,d=3):(c=7,d=4)}};let S0=!1;const R0=(t,e,i,n)=>{qi(t,0+(n?1:0),3),E0(t),Wc(t,i),Wc(t,~i),i&&t.pending_buf.set(t.window.subarray(e,e+i),t.pending),t.pending+=i};var QW=t=>{S0||((()=>{let e,i,n,r,s;const o=new Array(16);for(n=0,r=0;r<28;r++)for(xm[r]=n,e=0;e<1<<Um[r];e++)Gc[n++]=r;for(Gc[n-1]=r,s=0,r=0;r<16;r++)for(ju[r]=s,e=0;e<1<<Bu[r];e++)jc[s++]=r;for(s>>=7;r<Vc;r++)for(ju[r]=s<<7,e=0;e<1<<Bu[r]-7;e++)jc[256+s++]=r;for(i=0;i<=Fc;i++)o[i]=0;for(e=0;e<=143;)Pr[2*e+1]=8,e++,o[8]++;for(;e<=255;)Pr[2*e+1]=9,e++,o[9]++;for(;e<=279;)Pr[2*e+1]=7,e++,o[7]++;for(;e<=287;)Pr[2*e+1]=8,e++,o[8]++;for(p0(Pr,287,o),e=0;e<Vc;e++)Bc[2*e+1]=5,Bc[2*e]=h0(e,5);c0=new Vm(Pr,Um,257,o0,Fc),d0=new Vm(Bc,Bu,0,Vc,Fc),l0=new Vm(new Array(0),XW,0,19,7)})(),S0=!0),t.l_desc=new Fm(t.dyn_ltree,c0),t.d_desc=new Fm(t.dyn_dtree,d0),t.bl_desc=new Fm(t.bl_tree,l0),t.bi_buf=0,t.bi_valid=0,_0(t)},ZW=(t,e,i,n)=>{let r,s,o=0;t.level>0?(t.strm.data_type===2&&(t.strm.data_type=(a=>{let c,d=4093624447;for(c=0;c<=31;c++,d>>>=1)if(1&d&&a.dyn_ltree[2*c]!==0)return 0;if(a.dyn_ltree[18]!==0||a.dyn_ltree[20]!==0||a.dyn_ltree[26]!==0)return 1;for(c=32;c<Mm;c++)if(a.dyn_ltree[2*c]!==0)return 1;return 0})(t)),jm(t,t.l_desc),jm(t,t.d_desc),o=(a=>{let c;for(g0(a,a.dyn_ltree,a.l_desc.max_code),g0(a,a.dyn_dtree,a.d_desc.max_code),jm(a,a.bl_desc),c=18;c>=3&&a.bl_tree[2*a0[c]+1]===0;c--);return a.opt_len+=3*(c+1)+5+5+4,c})(t),r=t.opt_len+3+7>>>3,s=t.static_len+3+7>>>3,s<=r&&(r=s)):r=s=i+5,i+4<=r&&e!==-1?R0(t,e,i,n):t.strategy===4||s===r?(qi(t,2+(n?1:0),3),f0(t,Pr,Bc)):(qi(t,4+(n?1:0),3),((a,c,d,l)=>{let u;for(qi(a,c-257,5),qi(a,d-1,5),qi(a,l-4,4),u=0;u<l;u++)qi(a,a.bl_tree[2*a0[u]+1],3);T0(a,a.dyn_ltree,c-1),T0(a,a.dyn_dtree,d-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,o+1),f0(t,t.dyn_ltree,t.dyn_dtree)),_0(t),n&&E0(t)},$W=(t,e,i)=>(t.pending_buf[t.sym_buf+t.sym_next++]=e,t.pending_buf[t.sym_buf+t.sym_next++]=e>>8,t.pending_buf[t.sym_buf+t.sym_next++]=i,e===0?t.dyn_ltree[2*i]++:(t.matches++,e--,t.dyn_ltree[2*(Gc[i]+Mm+1)]++,t.dyn_dtree[2*u0(e)]++),t.sym_next===t.sym_end),tH=t=>{qi(t,2,3),cr(t,256,Pr),(e=>{e.bi_valid===16?(Wc(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(t)},eH={_tr_init:QW,_tr_stored_block:R0,_tr_flush_block:ZW,_tr_tally:$W,_tr_align:tH},Hc=(t,e,i,n)=>{let r=65535&t,s=t>>>16&65535,o=0;for(;i!==0;){o=i>2e3?2e3:i,i-=o;do r=r+e[n++]|0,s=s+r|0;while(--o);r%=65521,s%=65521}return r|s<<16};const iH=new Uint32Array((()=>{let t,e=[];for(var i=0;i<256;i++){t=i;for(var n=0;n<8;n++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e})());var ci=(t,e,i,n)=>{const r=iH,s=n+i;t^=-1;for(let o=n;o<s;o++)t=t>>>8^r[255&(t^e[o])];return~t},Xs={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Sa={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:nH,_tr_stored_block:Gm,_tr_flush_block:rH,_tr_tally:cs,_tr_align:sH}=eH,{Z_NO_FLUSH:ds,Z_PARTIAL_FLUSH:oH,Z_FULL_FLUSH:aH,Z_FINISH:yn,Z_BLOCK:v0,Z_OK:_i,Z_STREAM_END:C0,Z_STREAM_ERROR:dr,Z_DATA_ERROR:cH,Z_BUF_ERROR:Wm,Z_DEFAULT_COMPRESSION:dH,Z_FILTERED:lH,Z_HUFFMAN_ONLY:Gu,Z_RLE:uH,Z_FIXED:hH,Z_DEFAULT_STRATEGY:pH,Z_UNKNOWN:_H,Z_DEFLATED:Wu}=Sa,Qs=258,lr=262,Ra=42,Zs=113,Kc=666,$s=(t,e)=>(t.msg=Xs[e],e),I0=t=>2*t-(t>4?9:0),ls=t=>{let e=t.length;for(;--e>=0;)t[e]=0},EH=t=>{let e,i,n,r=t.w_size;e=t.hash_size,n=e;do i=t.head[--n],t.head[n]=i>=r?i-r:0;while(--e);e=r,n=e;do i=t.prev[--n],t.prev[n]=i>=r?i-r:0;while(--e)};let us=(t,e,i)=>(e<<t.hash_shift^i)&t.hash_mask;const rn=t=>{const e=t.state;let i=e.pending;i>t.avail_out&&(i=t.avail_out),i!==0&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+i),t.next_out),t.next_out+=i,e.pending_out+=i,t.total_out+=i,t.avail_out-=i,e.pending-=i,e.pending===0&&(e.pending_out=0))},sn=(t,e)=>{rH(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,rn(t.strm)},se=(t,e)=>{t.pending_buf[t.pending++]=e},Yc=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e},Hm=(t,e,i,n)=>{let r=t.avail_in;return r>n&&(r=n),r===0?0:(t.avail_in-=r,e.set(t.input.subarray(t.next_in,t.next_in+r),i),t.state.wrap===1?t.adler=Hc(t.adler,e,r,i):t.state.wrap===2&&(t.adler=ci(t.adler,e,r,i)),t.next_in+=r,t.total_in+=r,r)},y0=(t,e)=>{let i,n,r=t.max_chain_length,s=t.strstart,o=t.prev_length,a=t.nice_match;const c=t.strstart>t.w_size-lr?t.strstart-(t.w_size-lr):0,d=t.window,l=t.w_mask,u=t.prev,h=t.strstart+Qs;let p=d[s+o-1],T=d[s+o];t.prev_length>=t.good_match&&(r>>=2),a>t.lookahead&&(a=t.lookahead);do if(i=e,d[i+o]===T&&d[i+o-1]===p&&d[i]===d[s]&&d[++i]===d[s+1]){s+=2,i++;do;while(d[++s]===d[++i]&&d[++s]===d[++i]&&d[++s]===d[++i]&&d[++s]===d[++i]&&d[++s]===d[++i]&&d[++s]===d[++i]&&d[++s]===d[++i]&&d[++s]===d[++i]&&s<h);if(n=Qs-(h-s),s=h-Qs,n>o){if(t.match_start=e,o=n,n>=a)break;p=d[s+o-1],T=d[s+o]}}while((e=u[e&l])>c&&--r!=0);return o<=t.lookahead?o:t.lookahead},va=t=>{const e=t.w_size;let i,n,r;do{if(n=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-lr)&&(t.window.set(t.window.subarray(e,e+e-n),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,t.insert>t.strstart&&(t.insert=t.strstart),EH(t),n+=e),t.strm.avail_in===0)break;if(i=Hm(t.strm,t.window,t.strstart+t.lookahead,n),t.lookahead+=i,t.lookahead+t.insert>=3)for(r=t.strstart-t.insert,t.ins_h=t.window[r],t.ins_h=us(t,t.ins_h,t.window[r+1]);t.insert&&(t.ins_h=us(t,t.ins_h,t.window[r+3-1]),t.prev[r&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=r,r++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<lr&&t.strm.avail_in!==0)},A0=(t,e)=>{let i,n,r,s=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,o=0,a=t.strm.avail_in;do{if(i=65535,r=t.bi_valid+42>>3,t.strm.avail_out<r||(r=t.strm.avail_out-r,n=t.strstart-t.block_start,i>n+t.strm.avail_in&&(i=n+t.strm.avail_in),i>r&&(i=r),i<s&&(i===0&&e!==yn||e===ds||i!==n+t.strm.avail_in)))break;o=e===yn&&i===n+t.strm.avail_in?1:0,Gm(t,0,0,o),t.pending_buf[t.pending-4]=i,t.pending_buf[t.pending-3]=i>>8,t.pending_buf[t.pending-2]=~i,t.pending_buf[t.pending-1]=~i>>8,rn(t.strm),n&&(n>i&&(n=i),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+n),t.strm.next_out),t.strm.next_out+=n,t.strm.avail_out-=n,t.strm.total_out+=n,t.block_start+=n,i-=n),i&&(Hm(t.strm,t.strm.output,t.strm.next_out,i),t.strm.next_out+=i,t.strm.avail_out-=i,t.strm.total_out+=i)}while(o===0);return a-=t.strm.avail_in,a&&(a>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=a&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-a,t.strm.next_in),t.strstart),t.strstart+=a,t.insert+=a>t.w_size-t.insert?t.w_size-t.insert:a),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),o?4:e!==ds&&e!==yn&&t.strm.avail_in===0&&t.strstart===t.block_start?2:(r=t.window_size-t.strstart,t.strm.avail_in>r&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,r+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),r>t.strm.avail_in&&(r=t.strm.avail_in),r&&(Hm(t.strm,t.window,t.strstart,r),t.strstart+=r,t.insert+=r>t.w_size-t.insert?t.w_size-t.insert:r),t.high_water<t.strstart&&(t.high_water=t.strstart),r=t.bi_valid+42>>3,r=t.pending_buf_size-r>65535?65535:t.pending_buf_size-r,s=r>t.w_size?t.w_size:r,n=t.strstart-t.block_start,(n>=s||(n||e===yn)&&e!==ds&&t.strm.avail_in===0&&n<=r)&&(i=n>r?r:n,o=e===yn&&t.strm.avail_in===0&&i===n?1:0,Gm(t,t.block_start,i,o),t.block_start+=i,rn(t.strm)),o?3:1)},Km=(t,e)=>{let i,n;for(;;){if(t.lookahead<lr){if(va(t),t.lookahead<lr&&e===ds)return 1;if(t.lookahead===0)break}if(i=0,t.lookahead>=3&&(t.ins_h=us(t,t.ins_h,t.window[t.strstart+3-1]),i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),i!==0&&t.strstart-i<=t.w_size-lr&&(t.match_length=y0(t,i)),t.match_length>=3)if(n=cs(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do t.strstart++,t.ins_h=us(t,t.ins_h,t.window[t.strstart+3-1]),i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart;while(--t.match_length!=0);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=us(t,t.ins_h,t.window[t.strstart+1]);else n=cs(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(n&&(sn(t,!1),t.strm.avail_out===0))return 1}return t.insert=t.strstart<2?t.strstart:2,e===yn?(sn(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(sn(t,!1),t.strm.avail_out===0)?1:2},Ca=(t,e)=>{let i,n,r;for(;;){if(t.lookahead<lr){if(va(t),t.lookahead<lr&&e===ds)return 1;if(t.lookahead===0)break}if(i=0,t.lookahead>=3&&(t.ins_h=us(t,t.ins_h,t.window[t.strstart+3-1]),i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,i!==0&&t.prev_length<t.max_lazy_match&&t.strstart-i<=t.w_size-lr&&(t.match_length=y0(t,i),t.match_length<=5&&(t.strategy===lH||t.match_length===3&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){r=t.strstart+t.lookahead-3,n=cs(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do++t.strstart<=r&&(t.ins_h=us(t,t.ins_h,t.window[t.strstart+3-1]),i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart);while(--t.prev_length!=0);if(t.match_available=0,t.match_length=2,t.strstart++,n&&(sn(t,!1),t.strm.avail_out===0))return 1}else if(t.match_available){if(n=cs(t,0,t.window[t.strstart-1]),n&&sn(t,!1),t.strstart++,t.lookahead--,t.strm.avail_out===0)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(n=cs(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===yn?(sn(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(sn(t,!1),t.strm.avail_out===0)?1:2};function ur(t,e,i,n,r){this.good_length=t,this.max_lazy=e,this.nice_length=i,this.max_chain=n,this.func=r}const qc=[new ur(0,0,0,0,A0),new ur(4,4,8,4,Km),new ur(4,5,16,8,Km),new ur(4,6,32,32,Km),new ur(4,4,16,16,Ca),new ur(8,16,32,32,Ca),new ur(8,16,128,128,Ca),new ur(8,32,128,256,Ca),new ur(32,128,258,1024,Ca),new ur(32,258,258,4096,Ca)];function mH(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Wu,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),ls(this.dyn_ltree),ls(this.dyn_dtree),ls(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),ls(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),ls(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const zc=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.status!==Ra&&e.status!==57&&e.status!==69&&e.status!==73&&e.status!==91&&e.status!==103&&e.status!==Zs&&e.status!==Kc?1:0},b0=t=>{if(zc(t))return $s(t,dr);t.total_in=t.total_out=0,t.data_type=_H;const e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?57:e.wrap?Ra:Zs,t.adler=e.wrap===2?0:1,e.last_flush=-2,nH(e),_i},w0=t=>{const e=b0(t);return e===_i&&(i=>{i.window_size=2*i.w_size,ls(i.head),i.max_lazy_match=qc[i.level].max_lazy,i.good_match=qc[i.level].good_length,i.nice_match=qc[i.level].nice_length,i.max_chain_length=qc[i.level].max_chain,i.strstart=0,i.block_start=0,i.lookahead=0,i.insert=0,i.match_length=i.prev_length=2,i.match_available=0,i.ins_h=0})(t.state),e},O0=(t,e,i,n,r,s)=>{if(!t)return dr;let o=1;if(e===dH&&(e=6),n<0?(o=0,n=-n):n>15&&(o=2,n-=16),r<1||r>9||i!==Wu||n<8||n>15||e<0||e>9||s<0||s>hH||n===8&&o!==1)return $s(t,dr);n===8&&(n=9);const a=new mH;return t.state=a,a.strm=t,a.status=Ra,a.wrap=o,a.gzhead=null,a.w_bits=n,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=e,a.strategy=s,a.method=i,w0(t)};var fH=(t,e)=>{if(zc(t)||e>v0||e<0)return t?$s(t,dr):dr;const i=t.state;if(!t.output||t.avail_in!==0&&!t.input||i.status===Kc&&e!==yn)return $s(t,t.avail_out===0?Wm:dr);const n=i.last_flush;if(i.last_flush=e,i.pending!==0){if(rn(t),t.avail_out===0)return i.last_flush=-1,_i}else if(t.avail_in===0&&I0(e)<=I0(n)&&e!==yn)return $s(t,Wm);if(i.status===Kc&&t.avail_in!==0)return $s(t,Wm);if(i.status===Ra&&i.wrap===0&&(i.status=Zs),i.status===Ra){let r=Wu+(i.w_bits-8<<4)<<8,s=-1;if(s=i.strategy>=Gu||i.level<2?0:i.level<6?1:i.level===6?2:3,r|=s<<6,i.strstart!==0&&(r|=32),r+=31-r%31,Yc(i,r),i.strstart!==0&&(Yc(i,t.adler>>>16),Yc(i,65535&t.adler)),t.adler=1,i.status=Zs,rn(t),i.pending!==0)return i.last_flush=-1,_i}if(i.status===57){if(t.adler=0,se(i,31),se(i,139),se(i,8),i.gzhead)se(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),se(i,255&i.gzhead.time),se(i,i.gzhead.time>>8&255),se(i,i.gzhead.time>>16&255),se(i,i.gzhead.time>>24&255),se(i,i.level===9?2:i.strategy>=Gu||i.level<2?4:0),se(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(se(i,255&i.gzhead.extra.length),se(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(t.adler=ci(t.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69;else if(se(i,0),se(i,0),se(i,0),se(i,0),se(i,0),se(i,i.level===9?2:i.strategy>=Gu||i.level<2?4:0),se(i,3),i.status=Zs,rn(t),i.pending!==0)return i.last_flush=-1,_i}if(i.status===69){if(i.gzhead.extra){let r=i.pending,s=(65535&i.gzhead.extra.length)-i.gzindex;for(;i.pending+s>i.pending_buf_size;){let a=i.pending_buf_size-i.pending;if(i.pending_buf.set(i.gzhead.extra.subarray(i.gzindex,i.gzindex+a),i.pending),i.pending=i.pending_buf_size,i.gzhead.hcrc&&i.pending>r&&(t.adler=ci(t.adler,i.pending_buf,i.pending-r,r)),i.gzindex+=a,rn(t),i.pending!==0)return i.last_flush=-1,_i;r=0,s-=a}let o=new Uint8Array(i.gzhead.extra);i.pending_buf.set(o.subarray(i.gzindex,i.gzindex+s),i.pending),i.pending+=s,i.gzhead.hcrc&&i.pending>r&&(t.adler=ci(t.adler,i.pending_buf,i.pending-r,r)),i.gzindex=0}i.status=73}if(i.status===73){if(i.gzhead.name){let r,s=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>s&&(t.adler=ci(t.adler,i.pending_buf,i.pending-s,s)),rn(t),i.pending!==0)return i.last_flush=-1,_i;s=0}r=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,se(i,r)}while(r!==0);i.gzhead.hcrc&&i.pending>s&&(t.adler=ci(t.adler,i.pending_buf,i.pending-s,s)),i.gzindex=0}i.status=91}if(i.status===91){if(i.gzhead.comment){let r,s=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>s&&(t.adler=ci(t.adler,i.pending_buf,i.pending-s,s)),rn(t),i.pending!==0)return i.last_flush=-1,_i;s=0}r=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,se(i,r)}while(r!==0);i.gzhead.hcrc&&i.pending>s&&(t.adler=ci(t.adler,i.pending_buf,i.pending-s,s))}i.status=103}if(i.status===103){if(i.gzhead.hcrc){if(i.pending+2>i.pending_buf_size&&(rn(t),i.pending!==0))return i.last_flush=-1,_i;se(i,255&t.adler),se(i,t.adler>>8&255),t.adler=0}if(i.status=Zs,rn(t),i.pending!==0)return i.last_flush=-1,_i}if(t.avail_in!==0||i.lookahead!==0||e!==ds&&i.status!==Kc){let r=i.level===0?A0(i,e):i.strategy===Gu?((s,o)=>{let a;for(;;){if(s.lookahead===0&&(va(s),s.lookahead===0)){if(o===ds)return 1;break}if(s.match_length=0,a=cs(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++,a&&(sn(s,!1),s.strm.avail_out===0))return 1}return s.insert=0,o===yn?(sn(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(sn(s,!1),s.strm.avail_out===0)?1:2})(i,e):i.strategy===uH?((s,o)=>{let a,c,d,l;const u=s.window;for(;;){if(s.lookahead<=Qs){if(va(s),s.lookahead<=Qs&&o===ds)return 1;if(s.lookahead===0)break}if(s.match_length=0,s.lookahead>=3&&s.strstart>0&&(d=s.strstart-1,c=u[d],c===u[++d]&&c===u[++d]&&c===u[++d])){l=s.strstart+Qs;do;while(c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&d<l);s.match_length=Qs-(l-d),s.match_length>s.lookahead&&(s.match_length=s.lookahead)}if(s.match_length>=3?(a=cs(s,1,s.match_length-3),s.lookahead-=s.match_length,s.strstart+=s.match_length,s.match_length=0):(a=cs(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++),a&&(sn(s,!1),s.strm.avail_out===0))return 1}return s.insert=0,o===yn?(sn(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(sn(s,!1),s.strm.avail_out===0)?1:2})(i,e):qc[i.level].func(i,e);if(r!==3&&r!==4||(i.status=Kc),r===1||r===3)return t.avail_out===0&&(i.last_flush=-1),_i;if(r===2&&(e===oH?sH(i):e!==v0&&(Gm(i,0,0,!1),e===aH&&(ls(i.head),i.lookahead===0&&(i.strstart=0,i.block_start=0,i.insert=0))),rn(t),t.avail_out===0))return i.last_flush=-1,_i}return e!==yn?_i:i.wrap<=0?C0:(i.wrap===2?(se(i,255&t.adler),se(i,t.adler>>8&255),se(i,t.adler>>16&255),se(i,t.adler>>24&255),se(i,255&t.total_in),se(i,t.total_in>>8&255),se(i,t.total_in>>16&255),se(i,t.total_in>>24&255)):(Yc(i,t.adler>>>16),Yc(i,65535&t.adler)),rn(t),i.wrap>0&&(i.wrap=-i.wrap),i.pending!==0?_i:C0)},gH=(t,e)=>{let i=e.length;if(zc(t))return dr;const n=t.state,r=n.wrap;if(r===2||r===1&&n.status!==Ra||n.lookahead)return dr;if(r===1&&(t.adler=Hc(t.adler,e,i,0)),n.wrap=0,i>=n.w_size){r===0&&(ls(n.head),n.strstart=0,n.block_start=0,n.insert=0);let c=new Uint8Array(n.w_size);c.set(e.subarray(i-n.w_size,i),0),e=c,i=n.w_size}const s=t.avail_in,o=t.next_in,a=t.input;for(t.avail_in=i,t.next_in=0,t.input=e,va(n);n.lookahead>=3;){let c=n.strstart,d=n.lookahead-2;do n.ins_h=us(n,n.ins_h,n.window[c+3-1]),n.prev[c&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=c,c++;while(--d);n.strstart=c,n.lookahead=2,va(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,t.next_in=o,t.input=a,t.avail_in=s,n.wrap=r,_i},Jc={deflateInit:(t,e)=>O0(t,e,Wu,15,8,pH),deflateInit2:O0,deflateReset:w0,deflateResetKeep:b0,deflateSetHeader:(t,e)=>zc(t)||t.state.wrap!==2?dr:(t.state.gzhead=e,_i),deflate:fH,deflateEnd:t=>{if(zc(t))return dr;const e=t.state.status;return t.state=null,e===Zs?$s(t,cH):_i},deflateSetDictionary:gH,deflateInfo:"pako deflate (from Nodeca project)"};const TH=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var N0=function(t){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const i=e.shift();if(i){if(typeof i!="object")throw new TypeError(i+"must be non-object");for(const n in i)TH(i,n)&&(t[n]=i[n])}}return t},D0=t=>{let e=0;for(let n=0,r=t.length;n<r;n++)e+=t[n].length;const i=new Uint8Array(e);for(let n=0,r=0,s=t.length;n<s;n++){let o=t[n];i.set(o,r),r+=o.length}return i};let P0=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{P0=!1}const Xc=new Uint8Array(256);for(let t=0;t<256;t++)Xc[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;Xc[254]=Xc[254]=1;var Ym=t=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(t);let e,i,n,r,s,o=t.length,a=0;for(r=0;r<o;r++)i=t.charCodeAt(r),(64512&i)==55296&&r+1<o&&(n=t.charCodeAt(r+1),(64512&n)==56320&&(i=65536+(i-55296<<10)+(n-56320),r++)),a+=i<128?1:i<2048?2:i<65536?3:4;for(e=new Uint8Array(a),s=0,r=0;s<a;r++)i=t.charCodeAt(r),(64512&i)==55296&&r+1<o&&(n=t.charCodeAt(r+1),(64512&n)==56320&&(i=65536+(i-55296<<10)+(n-56320),r++)),i<128?e[s++]=i:i<2048?(e[s++]=192|i>>>6,e[s++]=128|63&i):i<65536?(e[s++]=224|i>>>12,e[s++]=128|i>>>6&63,e[s++]=128|63&i):(e[s++]=240|i>>>18,e[s++]=128|i>>>12&63,e[s++]=128|i>>>6&63,e[s++]=128|63&i);return e},SH=(t,e)=>{const i=e||t.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(t.subarray(0,e));let n,r;const s=new Array(2*i);for(r=0,n=0;n<i;){let o=t[n++];if(o<128){s[r++]=o;continue}let a=Xc[o];if(a>4)s[r++]=65533,n+=a-1;else{for(o&=a===2?31:a===3?15:7;a>1&&n<i;)o=o<<6|63&t[n++],a--;a>1?s[r++]=65533:o<65536?s[r++]=o:(o-=65536,s[r++]=55296|o>>10&1023,s[r++]=56320|1023&o)}}return((o,a)=>{if(a<65534&&o.subarray&&P0)return String.fromCharCode.apply(null,o.length===a?o:o.subarray(0,a));let c="";for(let d=0;d<a;d++)c+=String.fromCharCode(o[d]);return c})(s,r)},RH=(t,e)=>{(e=e||t.length)>t.length&&(e=t.length);let i=e-1;for(;i>=0&&(192&t[i])==128;)i--;return i<0||i===0?e:i+Xc[t[i]]>e?i:e},L0=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const k0=Object.prototype.toString,{Z_NO_FLUSH:vH,Z_SYNC_FLUSH:CH,Z_FULL_FLUSH:IH,Z_FINISH:yH,Z_OK:Hu,Z_STREAM_END:AH,Z_DEFAULT_COMPRESSION:bH,Z_DEFAULT_STRATEGY:wH,Z_DEFLATED:OH}=Sa;function Qc(t){this.options=N0({level:bH,method:OH,chunkSize:16384,windowBits:15,memLevel:8,strategy:wH},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new L0,this.strm.avail_out=0;let i=Jc.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(i!==Hu)throw new Error(Xs[i]);if(e.header&&Jc.deflateSetHeader(this.strm,e.header),e.dictionary){let n;if(n=typeof e.dictionary=="string"?Ym(e.dictionary):k0.call(e.dictionary)==="[object ArrayBuffer]"?new Uint8Array(e.dictionary):e.dictionary,i=Jc.deflateSetDictionary(this.strm,n),i!==Hu)throw new Error(Xs[i]);this._dict_set=!0}}function qm(t,e){const i=new Qc(e);if(i.push(t,!0),i.err)throw i.msg||Xs[i.err];return i.result}Qc.prototype.push=function(t,e){const i=this.strm,n=this.options.chunkSize;let r,s;if(this.ended)return!1;for(s=e===~~e?e:e===!0?yH:vH,typeof t=="string"?i.input=Ym(t):k0.call(t)==="[object ArrayBuffer]"?i.input=new Uint8Array(t):i.input=t,i.next_in=0,i.avail_in=i.input.length;;)if(i.avail_out===0&&(i.output=new Uint8Array(n),i.next_out=0,i.avail_out=n),(s===CH||s===IH)&&i.avail_out<=6)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else{if(r=Jc.deflate(i,s),r===AH)return i.next_out>0&&this.onData(i.output.subarray(0,i.next_out)),r=Jc.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===Hu;if(i.avail_out!==0){if(s>0&&i.next_out>0)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else if(i.avail_in===0)break}else this.onData(i.output)}return!0},Qc.prototype.onData=function(t){this.chunks.push(t)},Qc.prototype.onEnd=function(t){t===Hu&&(this.result=D0(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var NH={Deflate:Qc,deflate:qm,deflateRaw:function(t,e){return(e=e||{}).raw=!0,qm(t,e)},gzip:function(t,e){return(e=e||{}).gzip=!0,qm(t,e)},constants:Sa};const Ku=16209;var DH=function(t,e){let i,n,r,s,o,a,c,d,l,u,h,p,T,m,f,R,v,A,O,w,b,L,x,W;const K=t.state;i=t.next_in,x=t.input,n=i+(t.avail_in-5),r=t.next_out,W=t.output,s=r-(e-t.avail_out),o=r+(t.avail_out-257),a=K.dmax,c=K.wsize,d=K.whave,l=K.wnext,u=K.window,h=K.hold,p=K.bits,T=K.lencode,m=K.distcode,f=(1<<K.lenbits)-1,R=(1<<K.distbits)-1;t:do{p<15&&(h+=x[i++]<<p,p+=8,h+=x[i++]<<p,p+=8),v=T[h&f];e:for(;;){if(A=v>>>24,h>>>=A,p-=A,A=v>>>16&255,A===0)W[r++]=65535&v;else{if(!(16&A)){if(64&A){if(32&A){K.mode=16191;break t}t.msg="invalid literal/length code",K.mode=Ku;break t}v=T[(65535&v)+(h&(1<<A)-1)];continue e}for(O=65535&v,A&=15,A&&(p<A&&(h+=x[i++]<<p,p+=8),O+=h&(1<<A)-1,h>>>=A,p-=A),p<15&&(h+=x[i++]<<p,p+=8,h+=x[i++]<<p,p+=8),v=m[h&R];;){if(A=v>>>24,h>>>=A,p-=A,A=v>>>16&255,16&A){if(w=65535&v,A&=15,p<A&&(h+=x[i++]<<p,p+=8,p<A&&(h+=x[i++]<<p,p+=8)),w+=h&(1<<A)-1,w>a){t.msg="invalid distance too far back",K.mode=Ku;break t}if(h>>>=A,p-=A,A=r-s,w>A){if(A=w-A,A>d&&K.sane){t.msg="invalid distance too far back",K.mode=Ku;break t}if(b=0,L=u,l===0){if(b+=c-A,A<O){O-=A;do W[r++]=u[b++];while(--A);b=r-w,L=W}}else if(l<A){if(b+=c+l-A,A-=l,A<O){O-=A;do W[r++]=u[b++];while(--A);if(b=0,l<O){A=l,O-=A;do W[r++]=u[b++];while(--A);b=r-w,L=W}}}else if(b+=l-A,A<O){O-=A;do W[r++]=u[b++];while(--A);b=r-w,L=W}for(;O>2;)W[r++]=L[b++],W[r++]=L[b++],W[r++]=L[b++],O-=3;O&&(W[r++]=L[b++],O>1&&(W[r++]=L[b++]))}else{b=r-w;do W[r++]=W[b++],W[r++]=W[b++],W[r++]=W[b++],O-=3;while(O>2);O&&(W[r++]=W[b++],O>1&&(W[r++]=W[b++]))}break}if(64&A){t.msg="invalid distance code",K.mode=Ku;break t}v=m[(65535&v)+(h&(1<<A)-1)]}}break}}while(i<n&&r<o);O=p>>3,i-=O,p-=O<<3,h&=(1<<p)-1,t.next_in=i,t.next_out=r,t.avail_in=i<n?n-i+5:5-(i-n),t.avail_out=r<o?o-r+257:257-(r-o),K.hold=h,K.bits=p};const Yu=15,PH=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),LH=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),kH=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),MH=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Zc=(t,e,i,n,r,s,o,a)=>{const c=a.bits;let d,l,u,h,p,T,m=0,f=0,R=0,v=0,A=0,O=0,w=0,b=0,L=0,x=0,W=null;const K=new Uint16Array(16),ht=new Uint16Array(16);let pt,Vt,ce,ne=null;for(m=0;m<=Yu;m++)K[m]=0;for(f=0;f<n;f++)K[e[i+f]]++;for(A=c,v=Yu;v>=1&&K[v]===0;v--);if(A>v&&(A=v),v===0)return r[s++]=20971520,r[s++]=20971520,a.bits=1,0;for(R=1;R<v&&K[R]===0;R++);for(A<R&&(A=R),b=1,m=1;m<=Yu;m++)if(b<<=1,b-=K[m],b<0)return-1;if(b>0&&(t===0||v!==1))return-1;for(ht[1]=0,m=1;m<Yu;m++)ht[m+1]=ht[m]+K[m];for(f=0;f<n;f++)e[i+f]!==0&&(o[ht[e[i+f]]++]=f);if(t===0?(W=ne=o,T=20):t===1?(W=PH,ne=LH,T=257):(W=kH,ne=MH,T=0),x=0,f=0,m=R,p=s,O=A,w=0,u=-1,L=1<<A,h=L-1,t===1&&L>852||t===2&&L>592)return 1;for(;;){pt=m-w,o[f]+1<T?(Vt=0,ce=o[f]):o[f]>=T?(Vt=ne[o[f]-T],ce=W[o[f]-T]):(Vt=96,ce=0),d=1<<m-w,l=1<<O,R=l;do l-=d,r[p+(x>>w)+l]=pt<<24|Vt<<16|ce;while(l!==0);for(d=1<<m-1;x&d;)d>>=1;if(d!==0?(x&=d-1,x+=d):x=0,f++,--K[m]==0){if(m===v)break;m=e[i+o[f]]}if(m>A&&(x&h)!==u){for(w===0&&(w=A),p+=R,O=m-w,b=1<<O;O+w<v&&(b-=K[O+w],!(b<=0));)O++,b<<=1;if(L+=1<<O,t===1&&L>852||t===2&&L>592)return 1;u=x&h,r[u]=A<<24|O<<16|p-s}}return x!==0&&(r[p+x]=m-w<<24|64<<16),a.bits=A,0};const{Z_FINISH:M0,Z_BLOCK:UH,Z_TREES:qu,Z_OK:to,Z_STREAM_END:xH,Z_NEED_DICT:VH,Z_STREAM_ERROR:An,Z_DATA_ERROR:U0,Z_MEM_ERROR:x0,Z_BUF_ERROR:FH,Z_DEFLATED:V0}=Sa,zu=16180,Ju=16190,Lr=16191,zm=16192,Jm=16194,Xu=16199,Qu=16200,Xm=16206,De=16209,F0=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function BH(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const eo=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.mode<zu||e.mode>16211?1:0},B0=t=>{if(eo(t))return An;const e=t.state;return t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=zu,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,to},j0=t=>{if(eo(t))return An;const e=t.state;return e.wsize=0,e.whave=0,e.wnext=0,B0(t)},G0=(t,e)=>{let i;if(eo(t))return An;const n=t.state;return e<0?(i=0,e=-e):(i=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?An:(n.window!==null&&n.wbits!==e&&(n.window=null),n.wrap=i,n.wbits=e,j0(t))},W0=(t,e)=>{if(!t)return An;const i=new BH;t.state=i,i.strm=t,i.window=null,i.mode=zu;const n=G0(t,e);return n!==to&&(t.state=null),n};let Qm,Zm,H0=!0;const jH=t=>{if(H0){Qm=new Int32Array(512),Zm=new Int32Array(32);let e=0;for(;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(Zc(1,t.lens,0,288,Qm,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;Zc(2,t.lens,0,32,Zm,0,t.work,{bits:5}),H0=!1}t.lencode=Qm,t.lenbits=9,t.distcode=Zm,t.distbits=5},K0=(t,e,i,n)=>{let r;const s=t.state;return s.window===null&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Uint8Array(s.wsize)),n>=s.wsize?(s.window.set(e.subarray(i-s.wsize,i),0),s.wnext=0,s.whave=s.wsize):(r=s.wsize-s.wnext,r>n&&(r=n),s.window.set(e.subarray(i-n,i-n+r),s.wnext),(n-=r)?(s.window.set(e.subarray(i-n,i),0),s.wnext=n,s.whave=s.wsize):(s.wnext+=r,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=r))),0};var GH=(t,e)=>{let i,n,r,s,o,a,c,d,l,u,h,p,T,m,f,R,v,A,O,w,b,L,x=0;const W=new Uint8Array(4);let K,ht;const pt=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(eo(t)||!t.output||!t.input&&t.avail_in!==0)return An;i=t.state,i.mode===Lr&&(i.mode=zm),o=t.next_out,r=t.output,c=t.avail_out,s=t.next_in,n=t.input,a=t.avail_in,d=i.hold,l=i.bits,u=a,h=c,L=to;t:for(;;)switch(i.mode){case zu:if(i.wrap===0){i.mode=zm;break}for(;l<16;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}if(2&i.wrap&&d===35615){i.wbits===0&&(i.wbits=15),i.check=0,W[0]=255&d,W[1]=d>>>8&255,i.check=ci(i.check,W,2,0),d=0,l=0,i.mode=16181;break}if(i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&d)<<8)+(d>>8))%31){t.msg="incorrect header check",i.mode=De;break}if((15&d)!==V0){t.msg="unknown compression method",i.mode=De;break}if(d>>>=4,l-=4,b=8+(15&d),i.wbits===0&&(i.wbits=b),b>15||b>i.wbits){t.msg="invalid window size",i.mode=De;break}i.dmax=1<<i.wbits,i.flags=0,t.adler=i.check=1,i.mode=512&d?16189:Lr,d=0,l=0;break;case 16181:for(;l<16;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}if(i.flags=d,(255&ti(i))!==V0){t.msg="unknown compression method",i.mode=De;break}if(57344&ti(i)){t.msg="unknown header flags set",i.mode=De;break}i.head&&(i.head.text=d>>8&1),512&ti(i)&&4&i.wrap&&(W[0]=255&d,W[1]=d>>>8&255,i.check=ci(i.check,W,2,0)),d=0,l=0,i.mode=16182;case 16182:for(;l<32;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}i.head&&(i.head.time=d),512&ti(i)&&4&i.wrap&&(W[0]=255&d,W[1]=d>>>8&255,W[2]=d>>>16&255,W[3]=d>>>24&255,i.check=ci(i.check,W,4,0)),d=0,l=0,i.mode=16183;case 16183:for(;l<16;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}i.head&&(i.head.xflags=255&d,i.head.os=d>>8),512&ti(i)&&4&i.wrap&&(W[0]=255&d,W[1]=d>>>8&255,i.check=ci(i.check,W,2,0)),d=0,l=0,i.mode=16184;case 16184:if(1024&ti(i)){for(;l<16;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}i.length=d,i.head&&(i.head.extra_len=d),512&ti(i)&&4&i.wrap&&(W[0]=255&d,W[1]=d>>>8&255,i.check=ci(i.check,W,2,0)),d=0,l=0}else i.head&&(i.head.extra=null);i.mode=16185;case 16185:if(1024&ti(i)&&(p=i.length,p>a&&(p=a),p&&(i.head&&(b=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Uint8Array(i.head.extra_len)),i.head.extra.set(n.subarray(s,s+p),b)),512&ti(i)&&4&i.wrap&&(i.check=ci(i.check,n,p,s)),a-=p,s+=p,i.length-=p),i.length))break t;i.length=0,i.mode=16186;case 16186:if(2048&ti(i)){if(a===0)break t;p=0;do b=n[s+p++],i.head&&b&&i.length<65536&&(i.head.name+=String.fromCharCode(b));while(b&&p<a);if(512&ti(i)&&4&i.wrap&&(i.check=ci(i.check,n,p,s)),a-=p,s+=p,b)break t}else i.head&&(i.head.name=null);i.length=0,i.mode=16187;case 16187:if(4096&ti(i)){if(a===0)break t;p=0;do b=n[s+p++],i.head&&b&&i.length<65536&&(i.head.comment+=String.fromCharCode(b));while(b&&p<a);if(512&ti(i)&&4&i.wrap&&(i.check=ci(i.check,n,p,s)),a-=p,s+=p,b)break t}else i.head&&(i.head.comment=null);i.mode=16188;case 16188:if(512&ti(i)){for(;l<16;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}if(4&i.wrap&&d!==(65535&i.check)){t.msg="header crc mismatch",i.mode=De;break}d=0,l=0}i.head&&(i.head.hcrc=ti(i)>>9&1,i.head.done=!0),t.adler=i.check=0,i.mode=Lr;break;case 16189:for(;l<32;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}t.adler=i.check=F0(d),d=0,l=0,i.mode=Ju;case Ju:if(i.havedict===0)return t.next_out=o,t.avail_out=c,t.next_in=s,t.avail_in=a,i.hold=d,i.bits=l,VH;t.adler=i.check=1,i.mode=Lr;case Lr:if(e===UH||e===qu)break t;case zm:if(i.last){d>>>=7&l,l-=7&l,i.mode=Xm;break}for(;l<3;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}switch(i.last=1&d,d>>>=1,l-=1,3&d){case 0:i.mode=16193;break;case 1:if(jH(i),i.mode=Xu,e===qu){d>>>=2,l-=2;break t}break;case 2:i.mode=16196;break;case 3:t.msg="invalid block type",i.mode=De}d>>>=2,l-=2;break;case 16193:for(d>>>=7&l,l-=7&l;l<32;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}if((65535&d)!=(d>>>16^65535)){t.msg="invalid stored block lengths",i.mode=De;break}if(i.length=65535&d,d=0,l=0,i.mode=Jm,e===qu)break t;case Jm:i.mode=16195;case 16195:if(p=i.length,p){if(p>a&&(p=a),p>c&&(p=c),p===0)break t;r.set(n.subarray(s,s+p),o),a-=p,s+=p,c-=p,o+=p,i.length-=p;break}i.mode=Lr;break;case 16196:for(;l<14;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}if(i.nlen=257+(31&d),d>>>=5,l-=5,i.ndist=1+(31&d),d>>>=5,l-=5,i.ncode=4+(15&d),d>>>=4,l-=4,i.nlen>286||i.ndist>30){t.msg="too many length or distance symbols",i.mode=De;break}i.have=0,i.mode=16197;case 16197:for(;i.have<i.ncode;){for(;l<3;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}i.lens[pt[i.have++]]=7&d,d>>>=3,l-=3}for(;i.have<19;)i.lens[pt[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,K={bits:i.lenbits},L=Zc(0,i.lens,0,19,i.lencode,0,i.work,K),i.lenbits=K.bits,L){t.msg="invalid code lengths set",i.mode=De;break}i.have=0,i.mode=16198;case 16198:for(;i.have<i.nlen+i.ndist;){for(;x=i.lencode[d&(1<<i.lenbits)-1],f=x>>>24,R=x>>>16&255,v=65535&x,!(f<=l);){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}if(v<16)d>>>=f,l-=f,i.lens[i.have++]=v;else{if(v===16){for(ht=f+2;l<ht;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}if(d>>>=f,l-=f,i.have===0){t.msg="invalid bit length repeat",i.mode=De;break}b=i.lens[i.have-1],p=3+(3&d),d>>>=2,l-=2}else if(v===17){for(ht=f+3;l<ht;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}d>>>=f,l-=f,b=0,p=3+(7&d),d>>>=3,l-=3}else{for(ht=f+7;l<ht;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}d>>>=f,l-=f,b=0,p=11+(127&d),d>>>=7,l-=7}if(i.have+p>i.nlen+i.ndist){t.msg="invalid bit length repeat",i.mode=De;break}for(;p--;)i.lens[i.have++]=b}}if(i.mode===De)break;if(i.lens[256]===0){t.msg="invalid code -- missing end-of-block",i.mode=De;break}if(i.lenbits=9,K={bits:i.lenbits},L=Zc(1,i.lens,0,i.nlen,i.lencode,0,i.work,K),i.lenbits=K.bits,L){t.msg="invalid literal/lengths set",i.mode=De;break}if(i.distbits=6,i.distcode=i.distdyn,K={bits:i.distbits},L=Zc(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,K),i.distbits=K.bits,L){t.msg="invalid distances set",i.mode=De;break}if(i.mode=Xu,e===qu)break t;case Xu:i.mode=Qu;case Qu:if(a>=6&&c>=258){t.next_out=o,t.avail_out=c,t.next_in=s,t.avail_in=a,i.hold=d,i.bits=l,DH(t,h),o=t.next_out,r=t.output,c=t.avail_out,s=t.next_in,n=t.input,a=t.avail_in,d=i.hold,l=i.bits,i.mode===Lr&&(i.back=-1);break}for(i.back=0;x=i.lencode[d&(1<<i.lenbits)-1],f=x>>>24,R=x>>>16&255,v=65535&x,!(f<=l);){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}if(R&&!(240&R)){for(A=f,O=R,w=v;x=i.lencode[w+((d&(1<<A+O)-1)>>A)],f=x>>>24,R=x>>>16&255,v=65535&x,!(A+f<=l);){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}d>>>=A,l-=A,i.back+=A}if(d>>>=f,l-=f,i.back+=f,i.length=v,R===0){i.mode=16205;break}if(32&R){i.back=-1,i.mode=Lr;break}if(64&R){t.msg="invalid literal/length code",i.mode=De;break}i.extra=15&R,i.mode=16201;case 16201:if(i.extra){for(ht=i.extra;l<ht;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}i.length+=d&(1<<i.extra)-1,d>>>=i.extra,l-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=16202;case 16202:for(;x=i.distcode[d&(1<<i.distbits)-1],f=x>>>24,R=x>>>16&255,v=65535&x,!(f<=l);){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}if(!(240&R)){for(A=f,O=R,w=v;x=i.distcode[w+((d&(1<<A+O)-1)>>A)],f=x>>>24,R=x>>>16&255,v=65535&x,!(A+f<=l);){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}d>>>=A,l-=A,i.back+=A}if(d>>>=f,l-=f,i.back+=f,64&R){t.msg="invalid distance code",i.mode=De;break}i.offset=v,i.extra=15&R,i.mode=16203;case 16203:if(i.extra){for(ht=i.extra;l<ht;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}i.offset+=d&(1<<i.extra)-1,d>>>=i.extra,l-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){t.msg="invalid distance too far back",i.mode=De;break}i.mode=16204;case 16204:if(c===0)break t;if(p=h-c,i.offset>p){if(p=i.offset-p,p>i.whave&&i.sane){t.msg="invalid distance too far back",i.mode=De;break}p>i.wnext?(p-=i.wnext,T=i.wsize-p):T=i.wnext-p,p>i.length&&(p=i.length),m=i.window}else m=r,T=o-i.offset,p=i.length;p>c&&(p=c),c-=p,i.length-=p;do r[o++]=m[T++];while(--p);i.length===0&&(i.mode=Qu);break;case 16205:if(c===0)break t;r[o++]=i.length,c--,i.mode=Qu;break;case Xm:if(i.wrap){for(;l<32;){if(a===0)break t;a--,d|=n[s++]<<l,l+=8}if(h-=c,t.total_out+=h,i.total+=h,4&i.wrap&&h&&(t.adler=i.check=ti(i)?ci(i.check,r,h,o-h):Hc(i.check,r,h,o-h)),h=c,4&i.wrap&&(ti(i)?d:F0(d))!==i.check){t.msg="incorrect data check",i.mode=De;break}d=0,l=0}i.mode=16207;case 16207:if(i.wrap&&ti(i)){for(;l<32;){if(a===0)break t;a--,d+=n[s++]<<l,l+=8}if(4&i.wrap&&d!==(4294967295&i.total)){t.msg="incorrect length check",i.mode=De;break}d=0,l=0}i.mode=16208;case 16208:L=xH;break t;case De:L=U0;break t;case 16210:return x0;default:return An}return t.next_out=o,t.avail_out=c,t.next_in=s,t.avail_in=a,i.hold=d,i.bits=l,(i.wsize||h!==t.avail_out&&i.mode<De&&(i.mode<Xm||e!==M0))&&K0(t,t.output,t.next_out,h-t.avail_out),u-=t.avail_in,h-=t.avail_out,t.total_in+=u,t.total_out+=h,i.total+=h,4&i.wrap&&h&&(t.adler=i.check=ti(i)?ci(i.check,r,h,t.next_out-h):Hc(i.check,r,h,t.next_out-h)),t.data_type=i.bits+(i.last?64:0)+(i.mode===Lr?128:0)+(i.mode===Xu||i.mode===Jm?256:0),(u===0&&h===0||e===M0)&&L===to&&(L=FH),L},kr={inflateReset:j0,inflateReset2:G0,inflateResetKeep:B0,inflateInit:t=>W0(t,15),inflateInit2:W0,inflate:GH,inflateEnd:t=>{if(eo(t))return An;let e=t.state;return e.window&&(e.window=null),t.state=null,to},inflateGetHeader:(t,e)=>{if(eo(t))return An;const i=t.state;return 2&i.wrap?(i.head=e,e.done=!1,to):An},inflateSetDictionary:(t,e)=>{const i=e.length;let n,r,s;return eo(t)?An:(n=t.state,n.wrap!==0&&n.mode!==Ju?An:n.mode===Ju&&(r=1,r=Hc(r,e,i,0),r!==n.check)?U0:(s=K0(t,e,i,i),s?(n.mode=16210,x0):(n.havedict=1,to)))},inflateInfo:"pako inflate (from Nodeca project)"},WH=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const Y0=Object.prototype.toString,{Z_NO_FLUSH:HH,Z_FINISH:KH,Z_OK:$c,Z_STREAM_END:$m,Z_NEED_DICT:tf,Z_STREAM_ERROR:YH,Z_DATA_ERROR:q0,Z_MEM_ERROR:qH}=Sa;function td(t){this.options=N0({chunkSize:65536,windowBits:15,to:""},t||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(15&e.windowBits||(e.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new L0,this.strm.avail_out=0;let i=kr.inflateInit2(this.strm,e.windowBits);if(i!==$c)throw new Error(Xs[i]);if(this.header=new WH,kr.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=Ym(e.dictionary):Y0.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(i=kr.inflateSetDictionary(this.strm,e.dictionary),i!==$c)))throw new Error(Xs[i])}function ef(t,e){const i=new td(e);if(i.push(t),i.err)throw i.msg||Xs[i.err];return i.result}td.prototype.push=function(t,e){const i=this.strm,n=this.options.chunkSize,r=this.options.dictionary;let s,o,a;if(this.ended)return!1;for(o=e===~~e?e:e===!0?KH:HH,Y0.call(t)==="[object ArrayBuffer]"?i.input=new Uint8Array(t):i.input=t,i.next_in=0,i.avail_in=i.input.length;;){for(i.avail_out===0&&(i.output=new Uint8Array(n),i.next_out=0,i.avail_out=n),s=kr.inflate(i,o),s===tf&&r&&(s=kr.inflateSetDictionary(i,r),s===$c?s=kr.inflate(i,o):s===q0&&(s=tf));i.avail_in>0&&s===$m&&i.state.wrap>0&&t[i.next_in]!==0;)kr.inflateReset(i),s=kr.inflate(i,o);switch(s){case YH:case q0:case tf:case qH:return this.onEnd(s),this.ended=!0,!1}if(a=i.avail_out,i.next_out&&(i.avail_out===0||s===$m))if(this.options.to==="string"){let c=RH(i.output,i.next_out),d=i.next_out-c,l=SH(i.output,c);i.next_out=d,i.avail_out=n-d,d&&i.output.set(i.output.subarray(c,c+d),0),this.onData(l)}else this.onData(i.output.length===i.next_out?i.output:i.output.subarray(0,i.next_out));if(s!==$c||a!==0){if(s===$m)return s=kr.inflateEnd(this.strm),this.onEnd(s),this.ended=!0,!0;if(i.avail_in===0)break}}return!0},td.prototype.onData=function(t){this.chunks.push(t)},td.prototype.onEnd=function(t){t===$c&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=D0(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var zH={Inflate:td,inflate:ef,inflateRaw:function(t,e){return(e=e||{}).raw=!0,ef(t,e)},ungzip:ef,constants:Sa};const{Deflate:U5,deflate:JH,deflateRaw:x5,gzip:V5}=NH,{Inflate:F5,inflate:XH,inflateRaw:B5,ungzip:j5}=zH;var QH=JH,ZH=XH,z0=function(t){return t[t.ONE_BYTE=0]="ONE_BYTE",t[t.TWO_BYTE=1]="TWO_BYTE",t}(z0||{});class $H{constructor(){g(this,"_sequence",0),g(this,"_startTime",Date.now()),g(this,"isUseOneByte",!0)}get startTime(){const e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){const i={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){const a=new Uint8Array(4);a.set([1,0,0,0]);const c={id:0,length:4,data:a.buffer},d={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[c]};i.commonPacketHeader.extension=1,i.extension=d,i.payload=this.compress(e),i.commonPacketHeader.length=8+(i.extension.length+2)+i.payload.byteLength}else i.commonPacketHeader.length=8+i.payload.byteLength;C("SHOW_DATASTREAM2_LOG")&&_.debug("send data header: ".concat(JSON.stringify(i.commonPacketHeader)));const n=new ArrayBuffer(i.commonPacketHeader.length),r=new Uint8Array(n),s=new DataView(n);let o=0;if(s.setUint16(o,i.commonPacketHeader.extension<<15|i.commonPacketHeader.reserved<<14|i.commonPacketHeader.length,!0),o+=2,s.setUint32(o,i.commonPacketHeader.sequence,!0),o+=4,s.setUint16(o,i.commonStreamHeader,!0),o+=2,i.extension){const a=this.serializeExtension(i.extension);r.set(new Uint8Array(a),o),o+=a.byteLength}if(r.set(new Uint8Array(i.payload),o),o+=i.payload.byteLength,o!==i.commonPacketHeader.length)throw Error("serialize error!");return n}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);const i=new DataView(e);let n=0;const r=i.getUint16(n,!0);n+=2;const s={length:16383&r,reserved:(16384&r)>>14,extension:(32768&r)>>15,sequence:i.getUint16(n+2,!0)<<16|i.getUint16(n,!0)};let o,a;if(n+=4,C("SHOW_DATASTREAM2_LOG")&&_.debug("receive data header: ".concat(JSON.stringify(s))),i.getUint16(n,!0),n+=2,s.extension){a=this.deserializeExtension(e.slice(n)),n+=2+a.length,o=e.slice(n);let c=!1;if(a.datas.length>0){const d=a.datas.find(l=>l.id===0);d&&(c=!(1&~new DataView(d.data).getUint32(0,!0)))}o=c?this.decompress(o):o}else o=e.slice(8);return o}serializeExtension(e){const{profile:i,length:n,datas:r}=e,s=new ArrayBuffer(n+2),o=new Uint8Array(s),a=new DataView(s);let c=0;if(a.setUint8(c++,i),a.setUint8(c++,n),r.forEach(d=>{i?(a.setUint8(c++,d.id),a.setUint8(c++,d.length),o.set(new Uint8Array(d.data),c),c+=d.data.byteLength):(a.setUint8(c++,d.id|d.length<<4),o.set(new Uint8Array(d.data),c),c+=d.data.byteLength)}),c!==n+2)throw Error("serialize extension error, is ".concat(c,"!==").concat(n+2));return s}deserializeExtension(e){const i=new DataView(e);let n=0;const r=i.getUint8(n);n++;const s=i.getUint8(n);n++;const o=r===z0.TWO_BYTE,a=[],c=new DataView(e,2);let d=0;for(;d<s;){let l=0,u=0,h=new ArrayBuffer(0);o?(l=c.getUint8(d),d++,u=c.getUint8(d),d++):(l=15&c.getUint8(d),u=c.getUint8(d)>>4,d++),u>0&&(h=c.buffer.slice(d+2,d+2+u),d+=h.byteLength),a.push({id:l,length:u,data:h})}if(d!==s)throw Error("parse error");return{profile:r,length:s,datas:a}}decompress(e){return ZH(new Uint8Array(e))}compress(e){return QH(new Uint8Array(e))}}const t5={name:"DataStream",create:(t,e)=>{const i=e?new u3(t):new h3(t);return i.useDataStream(new $H),i}};class e5 extends qt{constructor(e,i,n){super(),g(this,"ws",void 0),g(this,"requestId",1),g(this,"heartBeatTimer",void 0),g(this,"joinInfo",void 0),g(this,"clientId",void 0),g(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),g(this,"onClose",r=>{this.emit("close"),this.dispose()}),g(this,"onMessage",r=>{const s=JSON.parse(r.data);if(!s||s.command!=="serverResponse"||!s.requestId)return s&&s.command==="serverStatus"&&s.serverStatus&&s.serverStatus.command?(this.emit("status",s.serverStatus),void this.emit(s.serverStatus.command,s.serverStatus)):void 0;this.emit("req_".concat(s.requestId),s)}),this.joinInfo=e,this.clientId=i,this.ws=new Ac("cross-channel-".concat(this.clientId),n),this.ws.on(ot.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(ot.CONNECTED,this.onOpen),this.ws.on(ot.ON_MESSAGE,this.onMessage),this.ws.on(ot.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(e){const i=this.requestId++;return e.requestId=i,e.seq=i,this.ws.sendMessage(e),i}waitStatus(e){return new G((i,n)=>{const r=window.setTimeout(()=>{n(new D(S.TIMEOUT,"wait status timeout, status: ".concat(e)))},5e3);this.once(e,s=>{window.clearTimeout(r),s.state&&s.state!==0?n(new D(S.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):i(void 0)}),this.once("dispose",()=>{window.clearTimeout(r),n(new D(S.WS_ABORT))})})}async request(e){if(this.ws.state==="closed")throw new D(S.WS_DISCONNECT);const i=()=>new G((o,a)=>{this.ws.once(ot.CLOSED,()=>a(new D(S.WS_ABORT))),this.ws.once(ot.CONNECTED,o)});this.ws.state!=="connected"&&await i();const n=this.sendMessage(e),r=new G((o,a)=>{const c=()=>{a(new D(S.WS_ABORT))};this.ws.once(ot.RECONNECTING,c),this.ws.once(ot.CLOSED,c),this.once("req_".concat(n),o),ke(3e3).then(()=>{this.removeAllListeners("req_".concat(n)),this.ws.off(ot.RECONNECTING,c),this.ws.off(ot.CLOSED,c),a(new D(S.TIMEOUT,"cross channel ws request timeout"))})}),s=await r;if(!s||s.code!==200)throw new D(S.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(s)));return s}async connect(e){this.ws.removeAllListeners(ot.REQUEST_NEW_URLS),this.ws.on(ot.REQUEST_NEW_URLS,i=>{i(e)}),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const i=this.requestId++;return e.requestId=i,this.ws.sendMessage(e),i}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class i5 extends qt{set state(e){e!==this._state&&(e!==Si.RELAY_STATE_FAILURE&&(this.errorCode=sa.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,i,n,r,s){super(),g(this,"joinInfo",void 0),g(this,"sid",void 0),g(this,"clientId",void 0),g(this,"cancelToken",li.CancelToken.source()),g(this,"workerToken",void 0),g(this,"requestId",0),g(this,"signal",void 0),g(this,"prevChannelMediaConfig",void 0),g(this,"httpRetryConfig",void 0),g(this,"_resolution",void 0),g(this,"_state",Si.RELAY_STATE_IDLE),g(this,"errorCode",sa.RELAY_OK),g(this,"onStatus",o=>{_.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(o))),o&&o.command&&(o.command==="onAudioPacketReceived"&&this.emit("event",br.PACKET_RECEIVED_AUDIO_FROM_SRC),o.command==="onVideoPacketReceived"&&this.emit("event",br.PACKET_RECEIVED_VIDEO_FROM_SRC),o.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=sa.SRC_TOKEN_EXPIRED,this.state=Si.RELAY_STATE_FAILURE),o.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=sa.DEST_TOKEN_EXPIRED,this.state=Si.RELAY_STATE_FAILURE))}),g(this,"onReconnect",async()=>{_.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",br.NETWORK_DISCONNECTED),this.state=Si.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(o=>{this.state!==Si.RELAY_STATE_IDLE&&(_.error("auto restart channel media relay failed",o.toString()),this.errorCode=sa.SERVER_CONNECTION_LOST,this.state=Si.RELAY_STATE_FAILURE)})}),this.joinInfo=e,this.clientId=i,this.sid=ks(),this.signal=new e5(this.joinInfo,this.clientId,n),this.httpRetryConfig=r,this._resolution=s}async startChannelMediaRelay(e){if(this.state!==Si.RELAY_STATE_IDLE)throw new D(S.INVALID_OPERATION);this.state=Si.RELAY_STATE_CONNECTING,await this.connect(),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(i){throw i.data&&i.data.serverResponse&&i.data.serverResponse.command==="SetSourceChannel"?new D(S.CROSS_CHANNEL_FAILED_JOIN_SRC):i.data&&i.data.serverResponse&&i.serverResponse.command==="SetDestChannelStatus"?new D(S.CROSS_CHANNEL_FAILED_JOIN_DEST):i.data&&i.data.serverResponse&&i.serverResponse.command==="StartPacketTransfer"?new D(S.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):i}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==Si.RELAY_STATE_RUNNING)throw new D(S.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==Si.RELAY_STATE_RUNNING)throw new D(S.INVALID_OPERATION);const i=this.genMessage(ai.SetVideoProfile);await this.signal.request(i),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),_.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=Si.RELAY_STATE_IDLE,this.dispose()}dispose(){_.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=li.CancelToken.source(),this.state=Si.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await gW(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",br.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const i=this.genMessage(ai.StopPacketTransfer);await this.signal.request(i),await this.signal.waitStatus("Normal Quit"),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const n=this.genMessage(ai.SetSdkProfile,e);await this.signal.request(n),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const r=this.genMessage(ai.SetSourceChannel,e);await this.signal.request(r),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",br.PACKET_JOINED_SRC_CHANNEL),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const s=this.genMessage(ai.SetSourceUserId,e);await this.signal.request(s),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const o=this.genMessage(ai.SetDestChannel,e);await this.signal.request(o),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",br.PACKET_JOINED_DEST_CHANNEL),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const a=this.genMessage(ai.StartPacketTransfer,e);await this.signal.request(a),this.emit("event",br.PACKET_SENT_TO_DEST_CHANNEL),this.state=Si.RELAY_STATE_RUNNING,_.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){const i=this.genMessage(ai.UpdateDestChannel,e);await this.signal.request(i),this.emit("event",br.PACKET_UPDATE_DEST_CHANNEL),_.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(ai.StopPacketTransfer);await this.signal.request(e),_.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,i){const n=[],r=[],s=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Zi,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};o.sdkVersion==="4.23.1"&&(o.sdkVersion="0.0.1");let a=null,c=null;switch(e){case ai.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case ai.SetSourceChannel:if(c=i&&i.getSrcChannelMediaInfo(),!c)throw new D(S.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},o;case ai.SetSourceUserId:if(c=i&&i.getSrcChannelMediaInfo(),!c)throw new D(S.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:c.uid+""},o;case ai.SetDestChannel:if(a=i&&i.getDestChannelMediaInfo(),!a)throw new D(S.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{n.push(d.channelName),r.push(d.uid+""),s.push(d.token||this.joinInfo.appId)}),o.clientRequest={command:"SetDestChannel",channelName:n,uid:r,token:s},o;case ai.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case ai.Reconnect:return o.clientRequest={command:"Reconnect"},o;case ai.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case ai.UpdateDestChannel:if(a=i&&i.getDestChannelMediaInfo(),!a)throw new D(S.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{n.push(d.channelName),r.push(d.uid+""),s.push(d.token||this.joinInfo.appId)}),o.clientRequest={command:"UpdateDestChannel",channelName:n,uid:r,token:s},o;case ai.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}const n5={name:"ChannelMediaRelay",create:function(t){return new i5(t.joinInfo,t.clientId,t.websocketRetryConfig||ge,t.httpRetryConfig||ge,t.resolution)}};function J0(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function ed(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?J0(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):J0(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class r5 extends qt{constructor(e,i,n,r){super(),g(this,"spec",void 0),g(this,"token",void 0),g(this,"websocket",void 0),g(this,"pingpongTimer",void 0),g(this,"reconnectMode","retry"),g(this,"serviceMode",void 0),g(this,"reqId",0),g(this,"commandReqId",0),g(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),g(this,"handleWebSocketMessage",s=>{if(!s.data)return;const o=JSON.parse(s.data);o.requestId?this.emit("@".concat(o.requestId,"-").concat(o.sid),o):(Q.workerEvent(this.spec.sid,{actionType:"status",serverCode:o.code,workerType:this.serviceMode===Ar.TRANSCODE?1:2}),this.emit($r.PUBLISH_STREAM_STATUS,o))}),this.spec=i,this.token=e,this.serviceMode=r,this.websocket=new Ac("live-streaming",n),this.websocket.on(ot.CONNECTED,this.handleWebSocketOpen),this.websocket.on(ot.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(ot.REQUEST_NEW_URLS,(s,o)=>{Be(this,$r.REQUEST_NEW_ADDRESS).then(s).catch(o)}),this.websocket.on(ot.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(e){return this.websocket.init(e)}async request(e,i,n,r){this.reqId+=1,e==="request"&&(this.commandReqId+=1);const s=this.commandReqId,o=this.reqId;if(!o||!this.websocket)throw new D(S.UNEXPECTED_ERROR);const a=ed({command:e,sdkVersion:Zi==="4.23.1"?"0.0.1":Zi,seq:o,requestId:o,allocate:n,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},i);if(this.websocket.state==="closed")throw new D(S.WS_DISCONNECT);const c=()=>new G((h,p)=>{this.websocket.once(ot.CLOSED,()=>p(new D(S.WS_ABORT))),this.websocket.once(ot.CONNECTED,h)});this.websocket.state!=="connected"&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);const d=new G((h,p)=>{const T=()=>{p(new D(S.WS_ABORT))};this.websocket.once(ot.RECONNECTING,T),this.websocket.once(ot.CLOSED,T),this.once("@".concat(o,"-").concat(this.spec.sid),m=>{h(m)})});r&&Q.workerEvent(this.spec.sid,ed(ed({},r),{},{requestId:s,actionType:"request",payload:JSON.stringify(i.clientRequest),serverCode:0,code:0}));const l=Date.now();this.websocket.sendMessage(a);let u=null;try{u=await d}catch(h){if(this.websocket.state==="closed")throw h;return await c(),await this.request(e,i,n)}return r&&Q.workerEvent(this.spec.sid,ed(ed({},r),{},{requestId:s,actionType:"response",payload:JSON.stringify(u.serverResponse),serverCode:u.code,success:u.code===200,responseTime:Date.now()-l})),u.code!==200&&this.handleResponseError(u),u}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e=Zi==="4.23.1"?"0.0.1":Zi;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case ve.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void _.warning("live stream response already exists stream");case ve.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case ve.LIVE_STREAM_RESPONSE_BAD_STREAM:case ve.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new D(S.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case ve.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(e.serverResponse.command==="UnpublishStream")return;throw new D(S.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case ve.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new D(S.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case ve.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const i=new D(S.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit($r.WARNING,i,e.serverResponse.url)}case ve.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const i=new D(S.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit($r.WARNING,i,e.serverResponse.url)}case ve.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new D(S.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case ve.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new D(S.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case ve.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const i=new D(S.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit($r.WARNING,i,e.serverResponse.url)}case ve.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new D(S.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case ve.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new D(S.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case ve.LIVE_STREAM_RESPONSE_WORKER_LOST:case ve.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(e.serverResponse.command==="UnpublishStream")return;throw new D(S.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case ve.ERROR_FAIL_SEND_MESSAGE:if(e.serverResponse.command==="UnpublishStream")return;if(e.serverResponse.command==="UpdateTranscoding"||e.serverResponse.command==="ControlStream")return new D(S.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new D(S.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case ve.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case ve.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case ve.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case ve.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new D(S.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(Wl)},6e3)}}function X0(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function vi(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?X0(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):X0(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class s5 extends qt{constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ge,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:ge;super(),g(this,"onLiveStreamWarning",void 0),g(this,"onLiveStreamError",void 0),g(this,"spec",void 0),g(this,"retryTimeout",1e4),g(this,"connection",void 0),g(this,"httpRetryConfig",void 0),g(this,"wsRetryConfig",void 0),g(this,"streamingTasks",new Map),g(this,"isStartingStreamingTask",!1),g(this,"taskMutex",new Ke("live-streaming")),g(this,"cancelToken",li.CancelToken.source()),g(this,"transcodingConfig",void 0),g(this,"uapResponse",void 0),g(this,"lastTaskId",1),g(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=n,this.wsRetryConfig=i}async setTranscodingConfig(e){const i=vi(vi({},Z3),e);i.videoCodecProfile!==66&&i.videoCodecProfile!==77&&i.videoCodecProfile!==100&&(_.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(i.videoCodecProfile," -> 100")),i.videoCodecProfile=100),i.transcodingUsers||(i.transcodingUsers=i.userConfigs),i.transcodingUsers&&(i.transcodingUsers=i.transcodingUsers.map(o=>vi(vi(vi({},Q3),o),{},{zOrder:o.zOrder?o.zOrder+1:1}))),function(o){Xt(o.width)||Pt(o.width,"config.width",0,1e4),Xt(o.height)||Pt(o.height,"config.height",0,1e4),Xt(o.videoBitrate)||Pt(o.videoBitrate,"config.videoBitrate",1,1e6),Xt(o.videoFrameRate)||Pt(o.videoFrameRate,"config.videoFrameRate"),Xt(o.lowLatency)||Cr(o.lowLatency,"config.lowLatency"),Xt(o.audioSampleRate)||Ce(o.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Xt(o.audioBitrate)||Pt(o.audioBitrate,"config.audioBitrate",1,128),Xt(o.audioChannels)||Ce(o.audioChannels,"config.audioChannels",[1,2,3,4,5]),Xt(o.videoGop)||Pt(o.videoGop,"config.videoGop"),Xt(o.videoCodecProfile)||Ce(o.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Xt(o.userCount)||Pt(o.userCount,"config.userCount",0,17),Xt(o.backgroundColor)||Pt(o.backgroundColor,"config.backgroundColor",0,16777215),Xt(o.userConfigExtraInfo)||Le(o.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),o.transcodingUsers&&!Xt(o.transcodingUsers)&&(Ir(o.transcodingUsers,"config.transcodingUsers"),o.transcodingUsers.forEach((a,c)=>{pu(a.uid),Xt(a.x)||Pt(a.x,"transcodingUser[".concat(c,"].x"),0,1e4),Xt(a.y)||Pt(a.y,"transcodingUser[".concat(c,"].y"),0,1e4),Xt(a.width)||Pt(a.width,"transcodingUser[".concat(c,"].width"),0,1e4),Xt(a.height)||Pt(a.height,"transcodingUser[".concat(c,"].height"),0,1e4),Xt(a.zOrder)||Pt(a.zOrder-1,"transcodingUser[".concat(c,"].zOrder"),0,100),Xt(a.alpha)||Pt(a.alpha,"transcodingUser[".concat(c,"].alpha"),0,1,!1)})),Xt(o.watermark)||em(o.watermark,"watermark"),Xt(o.backgroundImage)||em(o.backgroundImage,"backgroundImage"),o.images&&!Xt(o.images)&&(Ir(o.images,"config.images"),o.images.forEach((a,c)=>{em(a,"images[".concat(c,"]"))}))}(i);const n=[];i.images&&n.push(...i.images.map(o=>vi(vi(vi({},tm),o),{},{zOrder:255}))),i.backgroundImage&&(n.push(vi(vi(vi({},tm),i.backgroundImage),{},{zOrder:0})),delete i.backgroundImage),i.watermark&&(n.push(vi(vi(vi({},tm),i.watermark),{},{zOrder:255})),delete i.watermark),i.images=n,i.transcodingUsers&&(i.userConfigs=i.transcodingUsers.map(o=>vi({},o)),i.userCount=i.transcodingUsers.length,delete i.transcodingUsers);const r=(i.userConfigs||[]).map(o=>typeof o.uid=="number"?G.resolve(o.uid):_w(o.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await G.all(r)).forEach((o,a)=>{i.userConfigs&&i.userConfigs[a]&&(i.userConfigs[a].uid=o)}),this.transcodingConfig=i,this.connection)try{var s;const o=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(Mi(s=this.streamingTasks).call(s)).map(a=>a.taskId).join("#")});_.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(o.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(o){if(!o.data||!o.data.retry)throw o;o.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(a=>{_.warning("[".concat(this.spec.clientId,"] live streaming receive error"),o.toString(),"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,o).then(()=>{_.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(a.url," success"))}).catch(c=>{_.error("[".concat(this.spec.clientId,"] live streaming republish failed"),a.url,c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)})})}}async startLiveStreamingTask(e,i,n){if(!this.transcodingConfig&&i===Ar.TRANSCODE)throw new D(S.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");const r={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};_.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(i));const s=await this.taskMutex.lock();if(!this.connection&&n)return void s();if(this.streamingTasks.get(e)&&!n)return s(),new D(S.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(i))}catch(a){throw s(),a}switch(i){case Ar.TRANSCODE:r.transcodingConfig=vi({},this.transcodingConfig)}this.uapResponse&&this.uapResponse.vid&&(r.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const o=this.lastTaskId++;try{const a=new G((d,l)=>{ke(this.retryTimeout).then(()=>{if(n)return l(n);const u=this.statusError.get(e);return u?(this.statusError.delete(e),l(u)):void 0})}),c=await G.race([this.connection.request("request",{clientRequest:r},!0,{url:e,command:"PublishStream",workerType:i===Ar.TRANSCODE?1:2,requestByUser:!n,tid:o.toString()}),a]);this.isStartingStreamingTask=!1,_.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(c.code)),this.streamingTasks.set(e,{clientRequest:r,mode:i,url:e,taskId:o}),s()}catch(a){if(s(),this.isStartingStreamingTask=!1,!a.data||!a.data.retry||n)throw a;return a.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,i,a)):await this.startLiveStreamingTask(e,i,a)}}stopLiveStreamingTask(e){return new G((i,n)=>{const r=this.streamingTasks.get(e);if(!r||!this.connection)return new D(S.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const s=r.mode;r.abortTask=()=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),i()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:r.url}},!1,{url:e,command:"UnPublishStream",workerType:s===Ar.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(o=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(o.code)),this.streamingTasks.delete(e),this.streamingTasks.size===0&&(this.connection&&this.connection.close(),this.connection=void 0),i()}).catch(n)})}resetAllTask(){var e;const i=Array.from(Mi(e=this.streamingTasks).call(e));this.terminate();for(const n of i)this.startLiveStreamingTask(n.url,n.mode).catch(r=>{this.onLiveStreamError&&this.onLiveStreamError(n.url,r)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=li.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new D(S.UNEXPECTED_ERROR,"live streaming connection has already connected");const i=await Be(this,im.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=i,this.connection=new r5(i.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on($r.WARNING,(n,r)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(r,n)),this.connection.on($r.PUBLISH_STREAM_STATUS,n=>this.handlePublishStreamServer(n)),this.connection.on($r.REQUEST_NEW_ADDRESS,(n,r)=>{if(!this.connection)return r(new D(S.UNEXPECTED_ERROR,"can not get new live streaming address list"));Be(this,im.REQUEST_WORKER_MANAGER_LIST,e).then(s=>{this.uapResponse=s,n(s.addressList)}).catch(r)}),await this.connection.init(i.addressList),this.connection}handlePublishStreamServer(e){const i=e.serverStatus&&e.serverStatus.url||"empty_url",n=this.streamingTasks.get(i),r=e.reason;switch(e.code){case ve.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case ve.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case ve.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case ve.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const o=new D(S.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(n)return _.error(o.toString()),this.onLiveStreamError&&this.onLiveStreamError(i,o);if(!this.isStartingStreamingTask)return;this.statusError.set(i,o)}case ve.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const o=new D(S.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,r);return this.onLiveStreamWarning&&this.onLiveStreamWarning(i,o)}case ve.LIVE_STREAM_RESPONSE_WORKER_LOST:case ve.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var s;if(!this.connection)return;this.connection.tryNextAddress();const o=Array.from(Mi(s=this.streamingTasks).call(s));for(const a of o)a.abortTask?a.abortTask():(_.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,new D(S.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then(()=>{_.debug("[".concat(this.spec.clientId,"] republish live stream success"),a.url)}).catch(c=>{_.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)}));return}}}hasUrl(e){return this.streamingTasks.has(e)}}const o5={name:"LiveStreaming",create:function(t){return new s5(t.joinInfo,t.websocketRetryConfig||ge,t.httpRetryConfig||ge)}};function a5(t){let e=$0();return function(i,n){let r=i.appId;r!==void 0&&(wt(n,10),hr(n,r));let s=i.cid;s!==void 0&&(wt(n,16),wt(n,s));let o=i.cname;o!==void 0&&(wt(n,26),hr(n,o));let a=i.deviceId;a!==void 0&&(wt(n,34),hr(n,a));let c=i.elapse;c!==void 0&&(wt(n,40),hs(n,c));let d=i.fileSize;d!==void 0&&(wt(n,48),hs(n,Ia(d)));let l=i.height;l!==void 0&&(wt(n,56),hs(n,Ia(l)));let u=i.jpg;u!==void 0&&(wt(n,66),wt(n,u.length),function(Ei,k){let F=ya(Ei,k.length);Ei.bytes.set(k,F)}(n,u));let h=i.networkType;h!==void 0&&(wt(n,72),hs(n,Ia(h)));let p=i.osType;p!==void 0&&(wt(n,80),hs(n,Ia(p)));let T=i.requestId;T!==void 0&&(wt(n,90),hr(n,T));let m=i.sdkVersion;m!==void 0&&(wt(n,98),hr(n,m));let f=i.sequence;f!==void 0&&(wt(n,104),hs(n,Ia(f)));let R=i.sid;R!==void 0&&(wt(n,114),hr(n,R));let v=i.timestamp;v!==void 0&&(wt(n,120),hs(n,v));let A=i.uid;A!==void 0&&(wt(n,128),wt(n,A));let O=i.vid;O!==void 0&&(wt(n,136),wt(n,O));let w=i.width;w!==void 0&&(wt(n,144),hs(n,Ia(w)));let b=i.service;b!==void 0&&(wt(n,152),wt(n,b));let L=i.callbackData;L!==void 0&&(wt(n,162),hr(n,L));let x=i.jpgEncryption;x!==void 0&&(wt(n,168),wt(n,x));let W=i.requestType;W!==void 0&&(wt(n,176),wt(n,W));let K=i.scorePorn;K!==void 0&&(wt(n,185),af(n,K));let ht=i.scoreSexy;ht!==void 0&&(wt(n,193),af(n,ht));let pt=i.scoreNeutral;pt!==void 0&&(wt(n,201),af(n,pt));let Vt=i.scene;Vt!==void 0&&(wt(n,208),wt(n,Vt));let ce=i.ossFilePrefix;ce!==void 0&&(wt(n,218),hr(n,ce));let ne=i.serviceVendor;if(ne!==void 0)for(let Ei of ne){wt(n,226);let k=$0();l5(Ei,k),wt(n,k.limit),_5(n,k),p5(k)}}(t,e),function(i){let n=i.bytes,r=i.limit;return n.length===r?n:n.subarray(0,r)}(e)}function c5(t){return function(i){let n={};t:for(;!tN(i);){let r=pr(i);switch(r>>>3){case 0:break t;case 1:n.code=pr(i);break;case 2:n.msg=eN(i,pr(i));break;case 3:{let s=u5(i);n.data=d5(i),i.limit=s;break}default:Q0(i,7&r)}}return n}({bytes:e=t,offset:0,limit:e.length});var e}function d5(t){let e={};t:for(;!tN(t);){let i=pr(t);switch(i>>>3){case 0:break t;case 1:e.requestId=eN(t,pr(t));break;case 2:e.requestType=pr(t)>>>0;break;case 3:e.scorePorn=of(t);break;case 4:e.scoreSexy=of(t);break;case 5:e.scoreNeutral=of(t);break;case 6:e.requestScene=pr(t)>>>0;break;case 7:e.scene=pr(t)>>>0;break;default:Q0(t,7&i)}}return e}function l5(t,e){let i=t.service;i!==void 0&&(wt(e,8),wt(e,i));let n=t.vendor;n!==void 0&&(wt(e,16),wt(e,n));let r=t.token;r!==void 0&&(wt(e,26),hr(e,r));let s=t.callbackUrl;s!==void 0&&(wt(e,34),hr(e,s))}function u5(t){let e=pr(t),i=t.limit;return t.limit=t.offset+e,i}function Q0(t,e){switch(e){case 0:for(;128&iN(t););break;case 2:rf(t,pr(t));break;case 5:rf(t,4);break;case 1:rf(t,8);break;default:throw new Error("Unimplemented type: "+e)}}let h5=new Float32Array(1);new Uint8Array(h5.buffer);let nf=new Float64Array(1),Ci=new Uint8Array(nf.buffer);function Ia(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let Z0=[];function $0(){const t=Z0.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}function p5(t){Z0.push(t)}function rf(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function tN(t){return t.offset>=t.limit}function ya(t,e){let i=t.bytes,n=t.offset,r=t.limit,s=n+e;if(s>i.length){let o=new Uint8Array(2*s);o.set(i),t.bytes=o}return t.offset=s,s>r&&(t.limit=s),n}function sf(t,e){let i=t.offset;if(i+e>t.limit)throw new Error("Read past limit");return t.offset+=e,i}function eN(t,e){let i=sf(t,e),n=String.fromCharCode,r=t.bytes,s="�",o="";for(let a=0;a<e;a++){let c,d,l,u,h=r[a+i];128&h?(224&h)==192?a+1>=e?o+=s:(c=r[a+i+1],(192&c)!=128?o+=s:(u=(31&h)<<6|63&c,u<128?o+=s:(o+=n(u),a++))):(240&h)==224?a+2>=e?o+=s:(c=r[a+i+1],d=r[a+i+2],(49344&(c|d<<8))!=32896?o+=s:(u=(15&h)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?o+=s:(o+=n(u),a+=2))):(248&h)==240?a+3>=e?o+=s:(c=r[a+i+1],d=r[a+i+2],l=r[a+i+3],(12632256&(c|d<<8|l<<16))!=8421504?o+=s:(u=(7&h)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?o+=s:(u-=65536,o+=n(55296+(u>>10),56320+(1023&u)),a+=3))):o+=s:o+=n(h)}return o}function hr(t,e){let i=e.length,n=0;for(let o=0;o<i;o++){let a=e.charCodeAt(o);a>=55296&&a<=56319&&o+1<i&&(a=(a<<10)+e.charCodeAt(++o)-56613888),n+=a<128?1:a<2048?2:a<65536?3:4}wt(t,n);let r=ya(t,n),s=t.bytes;for(let o=0;o<i;o++){let a=e.charCodeAt(o);a>=55296&&a<=56319&&o+1<i&&(a=(a<<10)+e.charCodeAt(++o)-56613888),a<128?s[r++]=a:(a<2048?s[r++]=a>>6&31|192:(a<65536?s[r++]=a>>12&15|224:(s[r++]=a>>18&7|240,s[r++]=a>>12&63|128),s[r++]=a>>6&63|128),s[r++]=63&a|128)}}function _5(t,e){let i=ya(t,e.limit),n=t.bytes,r=e.bytes;for(let s=0,o=e.limit;s<o;s++)n[s+i]=r[s]}function iN(t){return t.bytes[sf(t,1)]}function nN(t,e){let i=ya(t,1);t.bytes[i]=e}function of(t){let e=sf(t,8),i=t.bytes;return Ci[0]=i[e++],Ci[1]=i[e++],Ci[2]=i[e++],Ci[3]=i[e++],Ci[4]=i[e++],Ci[5]=i[e++],Ci[6]=i[e++],Ci[7]=i[e++],nf[0]}function af(t,e){let i=ya(t,8),n=t.bytes;nf[0]=e,n[i++]=Ci[0],n[i++]=Ci[1],n[i++]=Ci[2],n[i++]=Ci[3],n[i++]=Ci[4],n[i++]=Ci[5],n[i++]=Ci[6],n[i++]=Ci[7]}function pr(t){let e,i=0,n=0;do e=iN(t),i<32&&(n|=(127&e)<<i),i+=7;while(128&e);return n}function wt(t,e){for(e>>>=0;e>=128;)nN(t,127&e|128),e>>>=7;nN(t,e)}function hs(t,e){let i=e.low>>>0,n=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,s=r===0?n===0?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:r<128?9:10,o=ya(t,s),a=t.bytes;switch(s){case 10:a[o+9]=r>>>7&1;case 9:a[o+8]=s!==9?128|r:127&r;case 8:a[o+7]=s!==8?n>>>21|128:n>>>21&127;case 7:a[o+6]=s!==7?n>>>14|128:n>>>14&127;case 6:a[o+5]=s!==6?n>>>7|128:n>>>7&127;case 5:a[o+4]=s!==5?128|n:127&n;case 4:a[o+3]=s!==4?i>>>21|128:i>>>21&127;case 3:a[o+2]=s!==3?i>>>14|128:i>>>14&127;case 2:a[o+1]=s!==2?i>>>7|128:i>>>7&127;case 1:a[o]=s!==1?128|i:127&i}}function rN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}const E5=new Map([["moderation",1],["supervise",2]]);class m5 extends qt{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const i=this._connectionState;this._connectionState=e,this.emit(Ne.CONNECTION_STATE_CHANGE,i,e)}get inspectType(){return this._inspectType}set inspectType(e){var i;this._inspectMode=wn(i=e.map(n=>E5.get(n)||0)).call(i,(n,r)=>n+r),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(e){super(),g(this,"name","AgoraRTCVideoContentInspect"),g(this,"_connectionState",Sn.CONNECTING),g(this,"_innerConnectionState",void 0),g(this,"sequence",0),g(this,"inspectStartTime",void 0),g(this,"workerManagerConnection",void 0),g(this,"workerConnection",void 0),g(this,"workerMessageLengthLimit",void 0),g(this,"inspectIntervalMinimum",void 0),g(this,"qualityRatio",void 0),g(this,"_connectInfo",void 0),g(this,"_cancelTokenSource",li.CancelToken.source()),g(this,"_retryConfig",void 0),g(this,"wmSequence",0),g(this,"inspectInterval",void 0),g(this,"inspectTimer",null),g(this,"ossFilePrefix",void 0),g(this,"extraInfo",void 0),g(this,"_inspectType",void 0),g(this,"_inspectMode",void 0),g(this,"_quality",1),g(this,"qualityTimer",null),g(this,"_inspectId",void 0),g(this,"_needWorkUrlOnly",!1),g(this,"inspectImage",()=>{if(this.connectionState!==Sn.CONNECTED)throw new D(S.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===Sn.CONNECTED?this.requestToInspectImage():_.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=Ut(5,"inspect-"),this.workerMessageLengthLimit=C("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=C("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=C("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Ac("worker-manager-"+this._inspectId,ge),this.on(Ne.STATE_CHANGE,(i,n)=>{this._innerConnectionState=i,_.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Rn[i]," ").concat(n||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new Ac("worker-"+this._inspectId,ge),this.handleWorkerEvents()}async init(e,i){this.emit(Ne.STATE_CHANGE,Rn.CONNECT_AP),this._connectInfo=e;const n=this._cancelTokenSource.token;return this._retryConfig=i,new G((r,s)=>{this.on(Ne.CONNECTION_STATE_CHANGE,(o,a)=>{a===Sn.CONNECTED&&r()}),this.requestAP(e,n,i).then(o=>{this.connectWorkerManager(o)}).catch(o=>{s(o)})})}async requestAP(e,i,n){const r=C("WEBCS_DOMAIN").map(a=>"https://".concat(a,"/api/v1")),s=await function(a,c,d,l){let{appId:u,areaCode:h,cname:p,sid:T,token:m,uid:f}=c;pa++;const R="image_moderation_api",v={service_name:R,json_body:JSON.stringify({appId:u,areaCode:h,cname:p,command:"allocateEdge",requestId:pa,seq:pa,sid:T,token:m,ts:Date.now(),uid:f+""})};let A,O,w=a[0];return Un(async()=>{A=Date.now();const b=await jn(w,{data:v,cancelToken:d,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(O=Date.now()-A,b.code!==0){const K=new D(S.UNEXPECTED_RESPONSE,"image inspect ap error, code"+b.code,{retry:!0,responseTime:O});throw _.error(K.toString()),K}const L=JSON.parse(b.json_body);if(L.code!==200){const K=new D(S.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(L.code,", reason: ").concat(L.reason),{code:L.code,responseTime:O});throw _.error(K.toString()),K}if(!L.servers||!Array.isArray(L.servers)||L.servers.length===0){const K=new D(S.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:L.code,responseTime:O});throw _.error(K.toString()),K}const x=C("VIDEO_INSPECT_WORKER_MANAGER_HOST"),W=C("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:L.servers.map(K=>{let{address:ht,wss:pt}=K;if(ht&&pt)return"wss://".concat(ht.replace(/\./g,"-"),".").concat(x,":").concat(W||pt)}).filter(K=>!!K),workerToken:L.workerToken,vid:L.vid,responseTime:O}},(b,L)=>(Q.apworkerEvent(T,{success:!0,sc:200,serviceName:R,responseDetail:JSON.stringify(b.addressList),firstSuccess:L===0,responseTime:O,serverIp:a[L%a.length]}),!1),(b,L)=>(Q.apworkerEvent(T,{success:!1,sc:b.data&&b.data.code||200,serviceName:R,responseTime:O,serverIp:a[L%a.length]}),!!(b.code!==S.OPERATION_ABORTED&&b.code!==S.UNEXPECTED_RESPONSE||b.data&&b.data.retry)&&(w=a[(L+1)%a.length],!0)),l)}(r,e,i,n);this.emit(Ne.STATE_CHANGE,Rn.AP_CONNECTED);const{addressList:o}=s;return this.wmSequence++,o}async connectWorkerManager(e){let i=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=i,this.emit(Ne.STATE_CHANGE,Rn.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(ot.CONNECTED,async()=>{this.emit(Ne.STATE_CHANGE,Rn.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.23.1",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(ot.CLOSED,()=>{this._innerConnectionState<Rn.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(ot.FAILED,()=>{this._innerConnectionState<Rn.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(ot.RECONNECTING,()=>{this._innerConnectionState<Rn.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(ot.ON_MESSAGE,async e=>{this.emit(Ne.STATE_CHANGE,Rn.GET_WORKER_MANAGER_RESPONSE);const i=this.workerManagerConnection.url;this.workerManagerConnection.close();const n=JSON.parse(e.data);if(n.code!==200)throw _.error("[".concat(this._inspectId,"] Unexpected code ").concat(n.code," from worker manager")),new D(S.UNEXPECTED_RESPONSE,"response code of worker is unexpected",n);if(!(n.serverResponse&&n.serverResponse.portWss&&i))throw _.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(n))),new D(S.UNEXPECTED_RESPONSE,"response content of worker is unexpected",n);{const r=C("VIDEO_INSPECT_WORKER_PORT")||n.serverResponse.portWss,s=i.replace(/:\d+\/?$/,":".concat(r));this.emit(Ne.STATE_CHANGE,Rn.CONNECT_WORKER,s),this._needWorkUrlOnly?this.emit(Ne.REQUEST_NEW_WORKER_URL,s):await this.connectWorker(s)}}),this.workerManagerConnection.on(ot.WILL_RECONNECT,(e,i,n)=>{n(e)}),this.workerManagerConnection.on(ot.REQUEST_NEW_URLS,(e,i)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(i)})}handleWorkerEvents(){this.workerConnection.on(ot.CONNECTED,async()=>{this.emit(Ne.STATE_CHANGE,Rn.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=Sn.CONNECTED}),this.workerConnection.on(ot.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){const n=c5(new Uint8Array(e.data));if(C("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&_.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(n)),n.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(Ne.INSPECT_RESULT,void 0,void 0);if(n.data&&n.data.scorePorn&&n.data.scoreSexy&&n.data.scoreNeutral){var i;const r={porn:n.data.scorePorn,sexy:n.data.scoreSexy,neutral:n.data.scoreNeutral},s=wn(i=Object.keys(r)).call(i,(a,c)=>r[a]>r[c]?a:c,"porn"),o=Object.keys(r).find(a=>a===s);this.emit(Ne.INSPECT_RESULT,o)}else this.emit(Ne.INSPECT_RESULT,void 0,new D(S.UNEXPECTED_RESPONSE,n.code+"","There is an unexpected data on message"))}else this.emit(Ne.INSPECT_RESULT,void 0,new D(S.UNEXPECTED_RESPONSE,n.code+"",n.msg))}else _.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Ne.INSPECT_RESULT,void 0,new D(S.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(ot.CLOSED,()=>{this.connectionState=Sn.CLOSED}),this.workerConnection.on(ot.FAILED,()=>{this.connectionState=Sn.CLOSED}),this.workerConnection.on(ot.RECONNECTING,()=>{this.connectionState=this.connectionState===Sn.CONNECTED?Sn.RECONNECTING:Sn.CONNECTING}),this.workerConnection.on(ot.WILL_RECONNECT,(e,i,n)=>{e==="recover"&&n(e),n("tryNext")}),this.workerConnection.on(ot.REQUEST_NEW_URLS,(e,i)=>{this.workerManagerConnection.close(),this.once(Ne.REQUEST_NEW_WORKER_URL,n=>{e([n])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(n=>{this.connectWorkerManager(n,!0)}).catch(n=>{i(n)})})}async requestToInspectImage(){this.sequence++;const e=xi(this,Ne.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(Ne.INSPECT_RESULT,void 0,new D(S.INVALID_OPERATION,"Only the track being played can be inspected"));const n=await this.generateRequestData(e,i);this.workerConnection.sendMessage(n,!0,!0)}else this.emit(Ne.INSPECT_RESULT,void 0,new D(S.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,i){let{appId:n,cname:r,cid:s,vid:o,sid:a,uid:c}=i;const d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),u=await Vy(l,n,r),h=this.sequence+"-"+s+"-"+c+"-"+d+"-"+Ut(12,""),p={appId:n,cid:s,cname:r,deviceId:"",elapse:(T=Number(d-this.inspectStartTime),{low:T|=0,high:T>>31,unsigned:T>=0}),fileSize:u.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:h,sdkVersion:"4.23.1",sequence:this.sequence,sid:a,timestamp:lO(d),uid:c,vid:o,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};var T;this.extraInfo===void 0&&delete p.callbackData,this.ossFilePrefix===void 0&&delete p.ossFilePrefix;const m=a5(p);if(m.byteLength<this.workerMessageLengthLimit){if(C("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const f=function(R){for(var v=1;v<arguments.length;v++){var A=arguments[v]!=null?arguments[v]:{};v%2?rN(Object(A),!0).forEach(function(O){g(R,O,A[O])}):Object.getOwnPropertyDescriptors?Object.defineProperties(R,Object.getOwnPropertyDescriptors(A)):rN(Object(A)).forEach(function(O){Object.defineProperty(R,O,Object.getOwnPropertyDescriptor(A,O))})}return R}({},p);delete f.jpg,_.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(f))}return m}{const f=this.quality*this.qualityRatio;return this.quality=f,await this.generateRequestData(e,{appId:n,cname:r,cid:s,vid:o,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=li.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=Sn.CLOSED,this.emit(Ne.STATE_CHANGE,Rn.CLOSED)}}const f5={name:"ContentInspect",create:function(t){let{config:e}=t;return function(i){if(!i)throw new D(S.INVALID_PARAMS,"inspectConfig is necessary.");if(!i.inspectType||!Array.isArray(i.inspectType))throw new D(S.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{const n=[...new Set(i.inspectType)];n.forEach(r=>{var s;if(!B(s=["supervise","moderation"]).call(s,r))throw new D(S.INVALID_PARAMS,"".concat(r," is not a valid inspect type."))}),i.inspectType=n}if(i&&i.extraInfo&&i.extraInfo.length>1024)throw new D(S.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")}(e),new m5(e)}};var sN=Bt(zi.Object.getOwnPropertySymbols),g5=bt,T5=vh.indexOf,S5=_d,cf=Na([].indexOf),oN=!!cf&&1/cf([1],1,-0)<0;g5({target:"Array",proto:!0,forced:oN||!S5("indexOf")},{indexOf:function(t){var e=arguments.length>1?arguments[1]:void 0;return oN?cf(this,t,e)||0:T5(this,t,e)}});var R5=dn("Array","indexOf"),v5=ei,C5=R5,df=Array.prototype,I5=function(t){var e=t.indexOf;return t===df||v5(df,t)&&e===df.indexOf?C5:e},aN=Bt(I5);function y5(t,e){if(t==null)return{};var i,n,r=function(o,a){if(o==null)return{};var c,d,l={},u=Cb(o);for(d=0;d<u.length;d++)c=u[d],aN(a).call(a,c)>=0||(l[c]=o[c]);return l}(t,e);if(sN){var s=sN(t);for(n=0;n<s.length;n++)i=s[n],aN(e).call(e,i)>=0||Object.prototype.propertyIsEnumerable.call(t,i)&&(r[i]=t[i])}return r}let cN=class{get localCapabilities(){return ee(this._localCapabilities)}get rtpCapabilities(){return ee(this._rtpCapabilities)}get candidates(){return ee(this._candidates)}get iceParameters(){return ee(this._iceParameters)}get dtlsParameters(){return ee(this._dtlsParameters)}constructor(t){g(this,"sessionDesc",void 0),g(this,"_localCapabilities",void 0),g(this,"_rtpCapabilities",void 0),g(this,"_candidates",void 0),g(this,"_iceParameters",void 0),g(this,"_dtlsParameters",void 0),g(this,"setup",void 0),g(this,"currentMidIndex",void 0),g(this,"cname","o/i14u9pJrxRKAsu"),g(this,"firefoxSsrcMidMap",new Map),t=ee(t);const{remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:r,localCapabilities:s,direction:o,setup:a,videoCodec:c,audioCodec:d}=t;let l;this.setup=a,l=o===oi.RECEIVE_ONLY?Ti(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):Ti(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=r,this._candidates=n,this._iceParameters=e,this._dtlsParameters=i,this._localCapabilities=s;const u=o===oi.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,h=o===oi.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,p=o===oi.RECEIVE_ONLY?r.send.videoCodecs:Oc(q.VIDEO,u,h,c),T=o===oi.RECEIVE_ONLY?r.send.audioCodecs:Oc(q.AUDIO,u,h,d);for(const m of l.mediaDescriptions)m.attributes.iceUfrag=e.iceUfrag,m.attributes.icePwd=e.icePwd,m.attributes.fingerprints=i.fingerprints,m.attributes.candidates=n,m.attributes.setup=this.setup,m.media.mediaType==="application"&&(m.attributes.sctpPort="5000"),m.media.mediaType==="video"&&(m.media.fmts=p.map(f=>f.payloadType.toString(10)),m.attributes.payloads=p,m.attributes.extmaps=u.videoExtensions),m.media.mediaType==="audio"&&(m.media.fmts=T.map(f=>f.payloadType.toString(10)),m.attributes.payloads=T,m.attributes.extmaps=u.audioExtensions,ha(m));this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return Zr(this.sessionDesc)}hasMid(t){return Array.isArray(t)?t.every(e=>this.hasMid(e)):this.sessionDesc.mediaDescriptions.some(e=>e.attributes.mid===t)}send(t,e,i,n,r){i=i.replace(/ /g,"-");const{ssrcs:s,ssrcGroups:o}=Ws(e,this.cname,C("SYNC_GROUP")?i:void 0),a=this.findPreloadMediaDesc(s);if(a){if(te()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(t,s,n);let d;return c===-1?(d=this.createOrRecycleSendMedia(t,s,o,"sendonly",n,r),this.updateBundleMids()):(d=ee(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=s,d.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),te()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,d.attributes.mid),{needExchangeSDP:!0,mid:d.attributes.mid}}}stopSending(t){const e=this.sessionDesc.mediaDescriptions.filter(i=>i.attributes.mid&&t.indexOf(i.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(i=>{i.attributes.ssrcs=[]}),this.updateBundleMids()}receive(t,e,i){const n=[];return t.forEach(r=>{const s=r._mediaStreamTrack.kind,o=this.findAvailableRecvMediaIndex(s);let a,c=!1;o===-1?(c=!0,a=this.createOrRecycleRecvMedia(r,[],"recvonly",e,i),this.updateBundleMids()):(a=ee(this.sessionDesc.mediaDescriptions[o]),a.attributes.direction="recvonly"),n.push({mid:a.attributes.mid,needCreateTransceiver:c})}),n}stopReceiving(t){const e=this.sessionDesc.mediaDescriptions.filter(i=>t.indexOf(i.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(i=>{i.media.port="0",i.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(t){const{foundation:e,protocol:i,address:n,port:r,type:s,relatedAddress:o,relatedPort:a,priority:c}=new RTCIceCandidate(t),d={foundation:e??"",componentId:"1",transport:i??"",priority:c?c+"":"",connectionAddress:n??"",port:r?r+"":"",type:s?s+"":"",relAddr:o??"",relPort:a?a+"":"",extension:{}};this.candidates.some(l=>l.priority===d.priority&&l.connectionAddress===d.connectionAddress&&l.port===d.port)||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach(l=>{l.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(t,e,i,n,r){const s=t._mediaStreamTrack.kind,o=this.rtpCapabilities.recv,a=Oc(s,o,this.localCapabilities.send,s===q.AUDIO?r:n),c=s===q.VIDEO?o.videoExtensions:o.audioExtensions,d="".concat(++this.currentMidIndex);let l={media:{mediaType:s,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(h=>h.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,t);const u=this.findFirstClosedMedia(s);if(u){const h=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[h]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(i=>B(t).call(t,i.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(i=>{i.attributes.direction="inactive"})}unmuteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(i=>B(t).call(t,i.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(i=>{i.attributes.direction="recvonly"})}findAvailableMediaIndex(t,e,i){return this.sessionDesc.mediaDescriptions.findIndex(n=>{const r=n.media.mediaType===t&&n.media.port!=="0"&&(n.attributes.direction==="sendonly"||n.attributes.direction==="sendrecv")&&n.attributes.ssrcs.length===0;if(te()){if(r){const s=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(s||n.attributes.mid!=="0"&&n.attributes.mid!=="1")||!(!s||s!==n.attributes.mid)}return!1}return r&&n.attributes.mid===i})}findAvailableRecvMediaIndex(t){return this.sessionDesc.mediaDescriptions.findIndex(e=>{const i=e.media.mediaType===t&&e.media.port!=="0"&&(e.attributes.direction==="recvonly"||e.attributes.direction==="sendrecv");return e.attributes.mid!=="0"&&e.attributes.mid!=="1"&&i})}predictReceivingMids(t){const e=[];for(let i=0;i<t;i++)e.push((this.currentMidIndex+i+1).toString(10));return e}restartICE(t){t=ee(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd})}createOrRecycleSendMedia(t,e,i,n,r,s){const o=this.rtpCapabilities.send,a=t===q.VIDEO?o.videoCodecs:o.audioCodecs,c=t===q.VIDEO?o.videoExtensions:o.audioExtensions;te()&&(r="".concat(++this.currentMidIndex));let d={media:{mediaType:t,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(u=>u.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:r}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(t);if(l){const u=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[u]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(t,e,i){const n=ee(t);return am(n),ua(n,e),cm(n,e),zb(n),Su(n,i,this.localCapabilities.send),n}mungSendMediaDesc(t,e){const i=ee(t);return Su(i,e,this.localCapabilities.recv),ha(i),i}updateRecvMedia(t,e){const i=this.sessionDesc.mediaDescriptions.findIndex(n=>n.attributes.mid===t);if(i!==-1){const n=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],e);this.sessionDesc.mediaDescriptions[i]=n}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid)}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(e=>{var i;return((i=e.attributes)===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId)===t[0].ssrcId})}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(e=>te()?e.media.port==="0"&&e.media.mediaType===t:e.media.port==="0")}};const A5=["sdp"];var jt;function dN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function ps(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?dN(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):dN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let lN=(jt=class Aa extends Ob{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,i;return(e=(i=this.peerConnection.getReceivers()[0])===null||i===void 0||(i=i.transport)===null||i===void 0?void 0:i.state)!==null&&e!==void 0?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(e,i,n){super(e,i),g(this,"direction",void 0),g(this,"name",void 0),g(this,"store",void 0),g(this,"spec",void 0),g(this,"peerConnection",void 0),g(this,"initialOffer",void 0),g(this,"transport",void 0),g(this,"statsFilter",void 0),g(this,"localCandidateCount",0),g(this,"_isInRestartIce",!1),g(this,"mutex",void 0),g(this,"onLocalCandidate",void 0),g(this,"remoteSDP",void 0),g(this,"pendingCandidates",[]),g(this,"localCapabilities",void 0),g(this,"isReady",!1),g(this,"restartCnt",0),g(this,"curTurnServerIndex",0),this.store=i,this.spec=e,this.mutex=new Ke("P2PConnection-mutex",i.clientId),this.peerConnection=new RTCPeerConnection(Aa.resolvePCConfiguration(e,i.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=n??oi.SEND_ONLY,this.name=this.direction===oi.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=vE(this.peerConnection,C("STATS_UPDATE_INTERVAL"),void 0,te()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{const i=await Xb();if(this.localCapabilities=Ru(i),e){const{sdp:n}=e,r=y5(e,A5),s=function(){const l={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},u=wc(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},T={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(vn(u,l,"videoExtensions",h,p,T),vn(u,l,"videoCodecs",h,p,T),vn(u,l,"audioExtensions",h,p,T),vn(u,l,"audioCodecs",h,p,T),C("RAISE_H264_BASELINE_PRIORITY")){const m=T.videoCodecs.findIndex(f=>f.rtpMap&&f.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&f.fmtp&&f.fmtp.parameters["profile-level-id"]==="42001f");if(m!==-1){const f=T.videoCodecs.findIndex(R=>R.rtpMap&&R.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(f<m){_.debug("raising H264 baseline profile priority");const R=T.videoCodecs[m];T.videoCodecs.splice(m,1),T.videoCodecs.splice(f,0,R)}f!==-1&&C("FILTER_SEND_H264_BASELINE")&&(h.videoCodecs=h.videoCodecs.filter(R=>!(R.rtpMap&&R.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&R.fmtp&&R.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:h,recv:p,sendrecv:T}}({},{},n);this.remoteSDP=new cN({remoteIceParameters:r.iceParameters,remoteDtlsParameters:r.dtlsParameters,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const o=await this.peerConnection.createAnswer();if(!o.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const a=is(o.sdp);await this.peerConnection.setLocalDescription(o);const c=await Qb({},{},o.sdp);this.localCapabilities=Ru(c);const d=this.peerConnection.getTransceivers()[0];return d!=null&&d.receiver&&d.receiver.transport&&this.tryBindTransportEvents(d.receiver.transport),ps(ps({},a),{},{sdp:o.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=is(n.sdp);return this.initialOffer=n,ps(ps({},r),{},{sdp:n.sdp})}}catch(i){throw new P(S.GET_LOCAL_CONNECTION_PARAMS_FAILED,i.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:i,iceParameters:n,dtlsParameters:r}=e,s=await Qb({},{},i);this.remoteSDP=new cN({remoteIceParameters:n,remoteDtlsParameters:r,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const o=this.peerConnection.getTransceivers()[0];o!=null&&o.sender&&o.sender.transport&&this.tryBindTransportEvents(o.sender.transport)}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(i.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(i=>{this.peerConnection.addIceCandidate(i)}),this.pendingCandidates=[])}catch(i){throw new P(S.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(i.toString()))}}send(e,i,n){var r=this;return Qi(function*(){const s=yield mt(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],a=r.remoteSDP.receive(e,i,n);e.forEach((f,R)=>{if(a[R].needCreateTransceiver){const v=r.peerConnection.addTransceiver(f._mediaStreamTrack,{direction:"sendonly"});o.push(v),f._updateRtpTransceiver(v)}else{const v=r.peerConnection.getTransceivers().find(A=>A.mid===a[R].mid);if(!v)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[R].mid));o.push(v),f._updateRtpTransceiver(v)}}),te()&&C("SIMULCAST")===!0&&(yield mt(r.applySimulcastForFirefox(o,e)));const c=a.map(f=>f.mid),d=yield mt(r.peerConnection.createOffer()),l=r.mungSendOfferSDP(d.sdp,e,c),u=Ti(l),h=c.map(f=>{const R=u.mediaDescriptions.find(v=>v.attributes.mid===f);if(!R)throw new Error("Cannot extract ssrc from mediaDescription.");return Kb(R,C("USE_PUB_RTX"))}),p=o.map((f,R)=>{const v=c[R];return{localSSRC:h[R],id:v}});yield mt(r.peerConnection.setLocalDescription({type:"offer",sdp:l}));try{yield p}catch(f){const R=r.remoteSDP.toString();throw yield mt(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield mt(r.peerConnection.setRemoteDescription({type:"answer",sdp:R})),yield mt(r.stopSending(c,!0)),f}yield mt(r.applySimulcastEncodings(o,e)),yield mt(r.applySendEncodings(o,e));const T=r.remoteSDP.toString(),m=r.logSDPExchange(l,"offer","local","send");return m==null||m(T),yield mt(r.setRemoteDescription({type:"answer",sdp:T})),o.map((f,R)=>{const v=c[R];return{localSSRC:h[R],id:v}})}catch(o){throw o instanceof P?o:new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{s()}})()}async stopSending(e,i){const n=i?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length (".concat(r.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(e);const a=this.remoteSDP.toString();o==null||o(a),await this.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{n&&n()}}async receive(e,i,n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(e,i,n,r);if(o){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});const l=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(l.sdp,s,e);d==null||d(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else _.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===s);if(!a||a.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,mid:a.mid,transceiver:a}}catch(s){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async mockReceive(e,i,n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(e,i,n,r);if(o){const a=this.remoteSDP.toString(),c=this.logSDPExchange(a,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:a});const d=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(d.sdp,s,e);c==null||c(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else _.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(s){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();n==null||n(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async restartICE(e){try{if(this.store.p2pTransport===Ms.Auto&&(this.store.p2pTransport=Ms.SdRtn,St().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Aa.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,St().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Aa.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!e){this.restartCnt++,this.isReady=!1;const i=await this.peerConnection.createOffer({iceRestart:!0});if(!i.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:n}=is(i.sdp);return this.store.descriptionStart(),this.direction===oi.SEND_ONLY&&await this.peerConnection.setLocalDescription(i),n}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(e),this.store.descriptionStart(),this.direction===oi.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const i=await this.peerConnection.createAnswer();if(!i.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:n}=is(i.sdp);return await this.peerConnection.setLocalDescription(i),n}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(n.sdp,[i],[e]);this.remoteSDP.updateRecvMedia(e,i);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o==null||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new P(S.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(e,i){const n=this.peerConnection.getTransceivers().filter(r=>r.mid===e);n.length===1&&(this.isVP8Simulcast(i)?te()||await this.applySimulcastEncodings(n,[i]):await this.applySendEncodings(n,[i]))}setStatsRemoteVideoIsReady(e,i){this.statsFilter.setVideoIsReady2(e,i)}async replaceTrack(e,i){const n=this.peerConnection.getTransceivers().find(r=>r.mid===i);n&&await n.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const i=e[0].transport.iceTransport,{local:n,remote:r}=i.getSelectedCandidatePair();return{local:ps(ps({},tr),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:ps(ps({},tr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,i;B(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(i=this.onICEConnectionStateChange)===null||i===void 0||i.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var i;e.candidate.candidate&&((i=this.onLocalCandidate)===null||i===void 0||i.call(this,e.candidate.toJSON())),this.localCandidateCount+=1}else _.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e,i){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r={iceServers:[]};var s;return e.iceServers?r.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Ec(e.turnServer.servers)?r.iceServers=e.turnServer.servers:(r.iceServers&&r.iceServers.push(...Aa.turnServerConfigToIceServers(e.turnServer.servers,i,n)),C("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&e.turnServer.serversFromGateway&&r.iceServers.push(...Aa.turnServerConfigToIceServers(e.turnServer.serversFromGateway,i,n)),B(s=[Ms.Relay,Ms.SdRtn]).call(s,i)&&(r.iceTransportPolicy="relay"),C("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(r.iceTransportPolicy="relay")}))),C("ENABLE_ENCODED_TRANSFORM")&&St().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),_.debug("P2PConnection p2pTransport is ".concat(i)),r}static turnServerConfigToIceServers(e,i){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r=[],s=e.filter(a=>a.tcpport);_.debug("P2PConnection turnServers is ".concat(s,", current index is ").concat(n));const o=s.length>n?s[n]:s[0];switch(i){case Ms.SdRtn:const a=e.filter(d=>{var l;return B(l=d.username).call(l,"glb:")&&d.turnServerURL==d.turnServerURL}),c=a.length>n?a[n]:a[0];c&&(r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turn:".concat(da(c.turnServerURL),":").concat(c.tcpport,"?transport=udp")}),r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turns:".concat(da(c.turnServerURL),":").concat(c.tcpport,"?transport=tcp")}));break;case Ms.Relay:o&&(r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(da(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}));break;default:o&&(r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(da(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"stun:".concat(o.turnServerURL,":").concat(o.tcpport)}))}return r}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var n;e!=null&&e.state&&((n=this.onDTLSTransportStateChange)===null||n===void 0||n.call(this,e.state))},e.onerror=n=>{var r;(r=this.onDTLSTransportError)===null||r===void 0||r.call(this,"error"in n?n.error:n)};const i=e.iceTransport;i&&(i.onstatechange=()=>{const n=e==null?void 0:e.iceTransport.state;var r;n&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,n))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:n,remote:r}=i.getSelectedCandidatePair();_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:n.type,protocol:n.protocol}),", remote ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,i){var n;if(i||(i=this.peerConnection.getSenders().find(l=>l.track===e._mediaStreamTrack)),!i)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!St().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const r={},s={};switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(e._encoderConfig){var o;const{bitrateMax:l,frameRate:u,scaleResolutionDownBy:h}=e._encoderConfig;l&&(s.maxBitrate=1e3*l),B(o=e._hints).call(o,xt.LOW_STREAM)&&(u&&(s.maxFramerate=Di(u)),h&&h>=1&&(s.scaleResolutionDownBy=h))}if(C("DSCP_TYPE")&&vr()){var a;const l=C("DSCP_TYPE");B(a=["very-low","low","medium","high"]).call(a,l)&&(s.networkPriority=l)}const c=i.getParameters(),d=(n=c.encodings)===null||n===void 0?void 0:n[0];te()&&!d&&(r.encodings=[s]),d&&Object.assign(d,s),Object.assign(c,r),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await i.setParameters(c)}async applySendEncodings(e,i){try{if(!St().supportSetRtpSenderParameters||e.length!==i.length)return;for(let n=0;n<e.length;n++){const r=e[n],s=i[n];s instanceof Gt&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,r.sender)}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,i,n){const r=Ti(e);return i.forEach((s,o)=>{const a=n[o],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(ua(c,s),Jb(c,s,this.store.codec))}),Zr(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,i,n)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,i,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,i)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,i)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,i){if(e.length===i.length)for(let c=0;c<e.length;c++){var n,r,s,o,a;const d=e[c],l=i[c];if(l instanceof Gt&&!B(n=l._hints).call(n,xt.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=l._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=l._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const u={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];const p=d.sender.getParameters();await d.sender.setParameters(Object.assign(p,u))}}}async applySimulcastEncodings(e,i){if(!te()&&e.length===i.length)for(let n=0;n<e.length;n++){const r=i[n];if(r instanceof Gt&&this.isVP8Simulcast(r)){const s=e[n],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(e){var i,n,r,s,o;return!!(e instanceof Gt&&C("SIMULCAST")&&this.store.codec==="vp8"&&!B(i=e._hints).call(i,xt.LOW_STREAM)&&(n=e._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=e._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=e._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,i,n,r){if(C("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(i," SDP during P2PConnection.").concat(r,`
`),e),i==="offer"?s=>{this.logSDPExchange(s,"answer",n==="local"?"remote":"local",r)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(o=>o.mid&&e.indexOf(o.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(o=>{o.direction="inactive"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();r==null||r(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const i=this.peerConnection.getTransceivers().filter(o=>o.mid&&e.indexOf(o.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async o=>{o.direction="sendonly"});const n=await this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();r==null||r(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}async getRemoteSSRC(e,i){var n,r;if(i=(n=i)!==null&&n!==void 0?n:(r=this.currentRemoteDescription)===null||r===void 0?void 0:r.sdp){var s;const o=(s=Ti(i).mediaDescriptions.find(a=>a.attributes.mid===e))===null||s===void 0?void 0:s.attributes.ssrcs;return o==null?void 0:o[0].ssrcId}}async setRemoteDescription(e){var i;await this.peerConnection.setRemoteDescription(e),B(i=["connected","completed"]).call(i,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,i,n){const r=Ti(e),s=r.mediaDescriptions.find(o=>o.attributes.mid===i);return s&&n===q.AUDIO&&s.media.mediaType==="audio"&&ha(s),Zr(r)}},J(jt.prototype,"establish",[bn],Object.getOwnPropertyDescriptor(jt.prototype,"establish"),jt.prototype),J(jt.prototype,"connect",[bn],Object.getOwnPropertyDescriptor(jt.prototype,"connect"),jt.prototype),J(jt.prototype,"receive",[bn],Object.getOwnPropertyDescriptor(jt.prototype,"receive"),jt.prototype),J(jt.prototype,"mockReceive",[bn],Object.getOwnPropertyDescriptor(jt.prototype,"mockReceive"),jt.prototype),J(jt.prototype,"stopReceiving",[bn],Object.getOwnPropertyDescriptor(jt.prototype,"stopReceiving"),jt.prototype),J(jt.prototype,"restartICE",[bn],Object.getOwnPropertyDescriptor(jt.prototype,"restartICE"),jt.prototype),J(jt.prototype,"close",[bn],Object.getOwnPropertyDescriptor(jt.prototype,"close"),jt.prototype),J(jt.prototype,"updateEncoderConfig",[bn],Object.getOwnPropertyDescriptor(jt.prototype,"updateEncoderConfig"),jt.prototype),J(jt.prototype,"updateSendParameters",[bn],Object.getOwnPropertyDescriptor(jt.prototype,"updateSendParameters"),jt.prototype),J(jt.prototype,"replaceTrack",[bn],Object.getOwnPropertyDescriptor(jt.prototype,"replaceTrack"),jt.prototype),J(jt.prototype,"muteLocal",[bn],Object.getOwnPropertyDescriptor(jt.prototype,"muteLocal"),jt.prototype),J(jt.prototype,"unmuteLocal",[bn],Object.getOwnPropertyDescriptor(jt.prototype,"unmuteLocal"),jt.prototype),jt);function bn(t,e,i){const n=t[e];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const r=this.mutex,s=await r.lock("From P2PConnection.".concat(e));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{s()}},i}let Wn=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({});var uN,hN,pN,_N,EN,mN,fN,gN,TN,SN,RN,Yt;function vN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Zu(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?vN(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):vN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let b5=(uN=Hn(Wn.SEND_ONLY),hN=Hn(Wn.SEND_ONLY),pN=Hn(),_N=Hn(Wn.RECEIVE_ONLY),EN=Hn(Wn.RECEIVE_ONLY),mN=Hn(Wn.RECEIVE_ONLY),fN=Hn(Wn.RECEIVE_ONLY),gN=Hn(Wn.RECEIVE_ONLY),TN=Hn(Wn.RECEIVE_ONLY),SN=Hn(),RN=Hn(Wn.RECEIVE_ONLY),Yt=class extends qt{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(Z.StateChange,e,this._state)}constructor(t,e){super(),g(this,"isPlanB",!1),g(this,"store",void 0),g(this,"statsUploader",void 0),g(this,"sendConnection",void 0),g(this,"recvConnection",void 0),g(this,"localTrackMap",new Map),g(this,"remoteUserMap",new Map),g(this,"localDataChannels",[]),g(this,"pendingLocalTracks",[]),g(this,"pendingRemoteTracks",[]),g(this,"statsCollector",void 0),g(this,"dtlsFailedCount",0),g(this,"sendMutex",void 0),g(this,"recvMutex",void 0),g(this,"_state",yt.Disconnected),g(this,"_restartStates",["disconnected","failed"]),g(this,"reconnectInterval",void 0),g(this,"uploadUnplinkStarted",!1),g(this,"uploadDownlinkStarted",!1),g(this,"uplinkStateUploadInterval",void 0),g(this,"downlinkStatsUploadInterval",void 0),g(this,"handleMuteLocalTrack",async(i,n,r)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==yt.Connected)return void r(new P(S.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const c=this.filterTobeMutedTracks(i);if(c.length===0)return void n();const d=c.find(p=>p[0]==="videoLowTrack");d&&d[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(c.map(p=>{let[,{id:T}]=p;return T}));let l=!1;var o,a;i.trackMediaType==="video"?l=!((o=this.localTrackMap.get(U.LocalAudioTrack))===null||o===void 0||!o.track._muted):l=((a=this.localTrackMap.get(U.LocalVideoTrack))===null||a===void 0?void 0:a.id)===void 0;const u=this.createMuteMessage(c);await Mt(this,Z.RequestMuteLocal,u);const h=i.trackMediaType==="video"?ts.MUTE_LOCAL_VIDEO:ts.MUTE_LOCAL_AUDIO;await Mt(this,Z.RequestP2PMuteLocal,{action:h,message:u,isMuteAll:l}),n()}catch(c){r(c)}finally{s()}}),g(this,"handleUnmuteLocalTrack",async(i,n,r)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==yt.Connected)return void r(new P(S.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const o=this.filterTobeUnmutedTracks(i);if(o.length===0)return void n();await this.sendConnection.unmuteLocal(o.map(d=>{let[,{id:l}]=d;return l}));const a=this.createUnmuteMessage(o),c=i.trackMediaType==="video"?ts.UNMUTE_LOCAL_VIDEO:ts.UNMUTE_LOCAL_AUDIO;await Mt(this,Z.RequestP2PMuteLocal,{action:c,message:a}),n()}catch(o){r(o)}finally{s()}}),g(this,"handleUpdateVideoEncoder",async(i,n,r,s)=>{let o;typeof s=="boolean"&&s||(o=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoEncoder"));try{const c=this.localTrackMap.get(U.LocalVideoTrack);if(!this.sendConnection||!c||c.track!==i||this.state!==yt.Connected)return void n();const{id:d,track:l}=c;d&&(await this.sendConnection.updateSendParameters(d,l),await this.sendConnection.updateEncoderConfig(d,l),this.emit(Z.UpdateVideoEncoder,l)),n()}catch(c){r(c)}finally{var a;(a=o)===null||a===void 0||a()}}),g(this,"handleUpdateVideoSendParameters",async(i,n,r)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const o=this.localTrackMap.get(U.LocalVideoTrack);if(!this.sendConnection||!o||o.track!==i||this.state!==yt.Connected)return void n();const{id:a,track:c}=o;a&&await this.sendConnection.updateSendParameters(a,c),n()}catch(o){r(o)}finally{s()}}),g(this,"handleReplaceTrack",async(i,n,r,s)=>{let o;_.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(i.getTrackId(),"]")),typeof s=="boolean"&&s||(o=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var a;const d=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:u}]=l;return i===u});if(!this.sendConnection||!d||d[1].id===void 0||this.state!==yt.Connected)return void n();if(await((a=this.sendConnection)===null||a===void 0?void 0:a.replaceTrack(i,d[1].id)),d[0]===U.LocalVideoTrack&&St().supportDualStreamEncoding){const l=this.localTrackMap.get(U.LocalVideoLowTrack);if(l){const u=i._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u,await new G((h,p)=>{this.handleReplaceTrack(l.track,h,p,!0)})}}n()}catch(d){r(d)}finally{var c;(c=o)===null||c===void 0||c()}}),g(this,"handleGetLocalVideoStats",i=>{i(this.statsCollector.getLocalVideoTrackStats())}),g(this,"handleGetLocalAudioStats",i=>{i(this.statsCollector.getLocalAudioTrackStats())}),g(this,"handleGetRemoteVideoStats",i=>this.statsCollector.getRemoteVideoTrackStats(i.uid)[i.uid]),g(this,"handleGetRemoteAudioStats",i=>this.statsCollector.getRemoteAudioTrackStats(i.uid)[i.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new Uw(t),this.bindStatsUploaderEvents(),this.sendMutex=new Ke("P2PChannel2-send-mutex",t.clientId),this.recvMutex=new Ke("P2PChannel2-recv-mutex",t.clientId),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(i=>{i&&(i.iceConnectionState!=="disconnected"&&i.iceConnectionState!=="failed"||this.handleDisconnect(i.direction))})},C("ICE_RESTART_INTERVAL"))}async startP2PConnection(t,e){throw new P(S.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(t){throw new P(S.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(t,e){let i;try{if(e){this.recvConnection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),i=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new lN(t,this.store,oi.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const n=await this.recvConnection.establish(e);return{iceParameters:n.iceParameters,dtlsParameters:n.dtlsParameters,sdp:n.sdp}}{this.state=yt.New,this.sendConnection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),i=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new lN(t,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const n=await this.sendConnection.establish();return{iceParameters:n.iceParameters,dtlsParameters:n.dtlsParameters,sdp:n.sdp}}}finally{i&&i()}}async p2pConnect(t){if(!this.sendConnection)throw new P(S.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=yt.Connected}async addRemoteCandidate(t,e){if(e===oi.RECEIVE_ONLY){if(!this.sendConnection)throw new P(S.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(t)}else{if(!this.recvConnection)throw new P(S.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(t)}}publish(t,e,i){var n=this;return Qi(function*(){const r=yield mt(n.sendMutex.lock("From P2PChannel.publish"));try{if(!n.sendConnection||n.state!==yt.Connected){n.throwIfTrackTypeNotMatch(t);const d=t.filter(l=>n.pendingLocalTracks.indexOf(l)===-1);return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(d))}n.store.pubId=n.store.pubId+1,qe.markPublishStart(n.store.clientId,n.store.pubId);const s=n.filterTobePublishedTracks(t,e,i);if(s.length===0)return void(yield mt(n.tryToUnmuteAudio(t)));s.forEach(d=>{let{track:l,type:u}=d;const h=Date.now();n.store.publish(l.getTrackId(),u===U.LocalAudioTrack?"audio":"video",h)}),n.bindLocalTrackEvents(s);const o=yield mt(n.sendConnection.send(s.map(d=>{let{track:l}=d;return l}),n.store.codec,n.store.audioCodec)),a=(yield mt(o.next())).value,c=n.createGatewayPublishMessage(s,a);try{yield c}catch(d){throw o.throw(d),(d==null?void 0:d.code)===S.WS_ABORT&&s.forEach(l=>{let{track:u}=l;n.pendingLocalTracks.indexOf(u)===-1&&n.pendingLocalTracks.push(u)}),n.unbindLocalTrackEvents(s),d}yield mt(o.next()),s.forEach(d=>{let{type:l}=d;n.statsCollector.addLocalStats(l)}),n.statsUploader.startUploadOutboundStats(),n.assignLocalTracks(s,a),s.forEach(d=>{let{track:l,type:u}=d;const h=Date.now();n.store.publish(l.getTrackId(),u===U.LocalAudioTrack?"audio":"video",void 0,h)}),n.startUploadUplinkState()}finally{r()}})()}async unpublish(t){if(!this.sendConnection||this.state!==yt.Connected)return void(t.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(r=>!B(t).call(t,r)));const e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;const i=e.find(r=>r[0]==="videoLowTrack");i&&i[1].track.close();const n=this.createGatewayUnpublishMessage(e);if(await this.sendConnection.stopSending(e.map(r=>{let[,{id:s}]=r;return s})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(r=>{let[s,{track:o}]=r;return{type:s,track:o}})),e.forEach(r=>{let[s]=r;this.statsCollector.removeLocalStats(s)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===yt.Connected)return i&&i[1].track.close(),n;t.forEach(r=>{const s=this.pendingLocalTracks.indexOf(r);s!==-1&&this.pendingLocalTracks.splice(s,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const t=()=>{const e=[],i=[];Array.from(this.localTrackMap.entries()).forEach(n=>{let[r,{track:s,ssrcs:o}]=n;const a={stream_type:yW(s,r),ssrcs:o};s._muted||!s._enabled?e.push(a):i.push(a)}),e.length>0&&e.forEach(n=>{Mt(this,Z.RequestMuteLocal,[n])}),i.length>0&&i.forEach(n=>{Mt(this,Z.RequestUnmuteLocal,[n])})};t(),this.uplinkStateUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(t){return Qi(function*(){throw new P(S.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(_.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Be(this,Z.RequestRePublish,this.pendingLocalTracks),this.emit(Z.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new P(S.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(t,e,i,n){var r;if(!this.recvConnection)throw new P(S.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((r=this.remoteUserMap.get(t))!==null&&r!==void 0&&r.has(e))return;const{track:s,mid:o,transceiver:a}=await this.recvConnection.receive(e,[{ssrcId:i}],String(t.uid),n);e===q.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(s):(t._audioTrack=new ea(s,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),a&&t._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoSSRC=i,t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(s):(t._videoTrack=new ta(s,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),a&&t._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(t,t._videoTrack));const c=this.remoteUserMap.get(t);c?c.set(e,o):this.remoteUserMap.set(t,new Map([[e,o]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const d=this.pendingRemoteTracks.findIndex(l=>{let{user:u,kind:h}=l;return u.uid===t.uid&&e===h});d!==-1&&(this.pendingRemoteTracks.splice(d,1),this.emit(Z.MediaReconnectEnd,t.uid))}async mockSubscribe(t,e,i,n){if(!this.recvConnection)throw new P(S.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(e,[{ssrcId:i}],String(t.uid),n)}async unsubscribe(t,e,i){const n=this.pendingRemoteTracks.filter(s=>{let{user:o,kind:a}=s;return e!==void 0?o.uid===t.uid&&e===a:o.uid===t.uid});if(n.forEach(s=>{const o=this.pendingRemoteTracks.indexOf(s);this.pendingRemoteTracks.splice(o,1)}),this.recvConnection||i||n.forEach(s=>{let{kind:o}=s;var a;if(o===q.AUDIO)(a=t._audioTrack)===null||a===void 0||a._destroy(),t._audioTrack=void 0;else if(o===q.VIDEO){var c;(c=t._videoTrack)===null||c===void 0||c._destroy(),t._videoTrack=void 0}}),!this.recvConnection)return;const r=this.filterTobeUnSubscribedTracks(t,e);r.length!==0&&(await this.recvConnection.stopReceiving(r.map(s=>{let[,{id:o}]=s;return o})),this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach(s=>{let[o,{kind:a}]=s;var c,d;if(a===q.VIDEO&&o._videoSSRC&&((c=this.recvConnection)===null||c===void 0||c.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),a===q.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),i||((d=o._videoTrack)===null||d===void 0||d._destroy(),o._videoTrack=void 0);else if(a===q.AUDIO){var l;this.unbindRemoteTrackEvents(o._audioTrack),!i&&((l=o._audioTrack)===null||l===void 0||l._destroy(),o._audioTrack=void 0)}}),r.forEach(s=>{let[,{kind:o}]=s;Mt(this,Z.RequestP2PMuteRemote,o)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const t=()=>Array.from(this.remoteUserMap.entries()).forEach(e=>{let[,i]=e;[q.VIDEO,q.AUDIO].forEach(n=>{i.has(n)?Mt(this,Z.RequestP2PUnmuteRemote,n):Mt(this,Z.RequestP2PMuteRemote,n)})});t(),this.downlinkStatsUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(t){throw new P(S.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(t){throw new P(S.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(t){throw new P(S.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(t){throw new P(S.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(t,e){if(!this.recvConnection)return;const i=this.remoteUserMap.get(t);if(!i)return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid,"."));if(!i.get(e))return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const n=e===q.VIDEO?t._videoSSRC:t._audioSSRC;n!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(n,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.recvConnection)return;const i=this.remoteUserMap.get(t);if(!i)return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid,"."));i.get(e)||_.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}getAllTracks(t){const e=this.localTrackMap.get(U.LocalAudioTrack);if((e==null?void 0:e.track)instanceof Re){const i=e.track;return Array.from(this.localTrackMap.entries()).filter(n=>{let[r]=n;return r!==U.LocalAudioTrack}).filter(n=>{let[r]=n;return!(t&&r===U.LocalVideoLowTrack)}).map(n=>{let[,{track:r}]=n;return r}).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter(i=>{let[n]=i;return!(t&&n===U.LocalVideoLowTrack)}).map(i=>{let[,{track:n}]=i;return n})}reportPublishEvent(t,e,i,n,r){if(t){const o=this.localTrackMap.get(U.LocalAudioTrack),a=n?this.localTrackMap.get(U.LocalVideoLowTrack):this.localTrackMap.get(U.LocalVideoTrack);Q.publish(this.store.sessionId,{eventElapse:qe.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:o==null?void 0:o.track.getTrackLabel(),videoName:a==null?void 0:a.track.getTrackLabel(),screenshare:(a==null?void 0:a.track._hints.indexOf(xt.SCREEN_TRACK))!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var s;i||(i=[]);const o=i.find(c=>c instanceof ie),a=n?(s=this.localTrackMap.get(U.LocalVideoTrack))===null||s===void 0?void 0:s.track:i.find(c=>c instanceof Gt);Q.publish(this.store.sessionId,{eventElapse:qe.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:o==null?void 0:o.getTrackLabel(),videoName:a==null?void 0:a.getTrackLabel(),screenshare:(a==null?void 0:a._hints.indexOf(xt.SCREEN_TRACK))!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(t,e,i,n){const r=n===q.VIDEO?i._videoSSRC:i._audioSSRC;r&&Q.subscribe(this.store.sessionId,{succ:t,ec:e,video:n===q.VIDEO,audio:n===q.AUDIO,peerid:i.uid,subscribeRequestid:n===q.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:qe.measureFromSubscribeStart(this.store.clientId,r)})}reset(){_.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new Ke("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new Ke("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(U.LocalAudioTrack);if((t==null?void 0:t.track)instanceof Re){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach(i=>{e.removeAudioTrack(i)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=yt.Disconnected}getStats(t){var e,i;return t?(i=this.recvConnection)===null||i===void 0?void 0:i.getStats():(e=this.sendConnection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.recvConnection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(U.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(U.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof Gt||e&&e.track instanceof ie?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}getRemoteMedia(t){var e;const i=Array.from(Fi(e=this.remoteUserMap).call(e)).find(n=>n.uid===t);return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(i=>{let[n]=i;return{uid:n.uid,level:n.audioTrack?100*n.audioTrack._source.getAccurateVolumeLevel():0}});const e=this.localTrackMap.get(U.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=tc(t).call(t,(i,n)=>i.level-n.level),t}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(_.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=yt.Reconnecting,C("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var i;e._videoTrack&&e._videoTrack._player&&((i=e._videoTrack._player.getVideoElement())===null||i===void 0||i.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[i,{track:n}]=t;switch(i){case U.LocalVideoTrack:B(e=n._hints).call(e,xt.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case U.LocalAudioTrack:n instanceof Re?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case U.LocalVideoLowTrack:}}),this.emit(Z.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;Array.from(Fi(i).call(i)).forEach(n=>{this.setPendingRemoteMedia(e,n)}),this.emit(Z.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),_.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(t,e){for(const i of this.pendingRemoteTracks){const{user:n,kind:r}=i;if((t instanceof rs?t.uid:t)===n.uid&&e===r)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}async restartICE(t,e){let i,n;if(t===oi.SEND_ONLY){if(!this.sendConnection)throw new P(S.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");i=await this.sendMutex.lock("From P2PChannel.restartICE"),n=this.sendConnection}else{if(!this.recvConnection)throw new P(S.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");i=await this.recvMutex.lock("From P2PChannel.restartICE"),n=this.recvConnection}try{if(e){const r=await n.restartICE(e);return n.isInRestartIce=!1,r}{const r=await n.restartICE();if(r){const s=await Be(this,Z.RequestP2PRestartICE,{direction:oi.RECEIVE_ONLY,iceParameter:r});await n.restartICE(s),n.isInRestartIce=!1}}}finally{i()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const t=this.sendConnection.getStats(),e=this.localTrackMap.get(U.LocalVideoTrack),i=this.localTrackMap.get(U.LocalAudioTrack),n=t.videoSend.find(p=>{var T;return p.ssrc===(e==null||(T=e.ssrcs)===null||T===void 0?void 0:T[0].ssrcId)}),r=t.audioSend.find(p=>{var T;return p.ssrc===(i==null||(T=i.ssrcs)===null||T===void 0?void 0:T[0].ssrcId)});if(!n||!r)return 1;const s=xi(this,Z.NeedSignalRTT),o=n?n.rttMs:void 0,a=r?r.rttMs:void 0,c=o&&a?(o+a)/2:o||a,d=(c&&s?(c+s)/2:c||s)||0,l=100*t.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=e==null?void 0:e.track;if(h&&h._encoderConfig&&h._hints.indexOf(xt.SCREEN_TRACK)===-1){const p=h._encoderConfig.bitrateMax,T=t.bitrate.actualEncoded;if(p&&T){const m=(1e3*p-T)/(1e3*p);return Sb[m<.15?0:m<.3?1:m<.45?2:m<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const t=this.recvConnection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach(i=>{let[n]=i;const r=n._audioSSRC,s=n._videoSSRC,o=t.audioRecv.find(T=>T.ssrc===r),a=t.videoRecv.find(T=>T.ssrc===s);if(!o&&!a)return void(e+=1);const c=xi(this,Z.NeedSignalRTT),d=t.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=o?o.jitterMs:void 0,h=t.recvPacketLossRate;let p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),e+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new G((e,i)=>{this.handleMuteLocalTrack(t,e,i)})}filterTobePublishedTracks(t,e,i){const n=[],r=St(),s=this.getAllTracks();t=Go(t=t.filter(c=>s.indexOf(c)===-1));let o=!1,a=!1;for(const c of t){if(c instanceof Gt&&(this.localTrackMap.has(U.LocalVideoTrack)||o?new P(S.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:c,type:U.LocalVideoTrack}),o=!0),e)){const d=this.getLowVideoTrack(c,i);n.push({track:d,type:U.LocalVideoLowTrack})}if(c instanceof ie){const d=this.localTrackMap.get(U.LocalAudioTrack);if(d){if(!(d.track instanceof Re))throw new P(S.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new P(S.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");d.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){const l=n.find(u=>{let{type:h}=u;return h===U.LocalAudioTrack});if(!(l.track instanceof Re))throw new P(S.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new P(S.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");l.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof Re||c._bypassWebAudio)n.push({track:c,type:U.LocalAudioTrack});else{const l=new Re;l.addAudioTrack(c),n.push({track:l,type:U.LocalAudioTrack})}a=!0}}}return n}filterTobeUnpublishedTracks(t){const e=[],i=this.getAllTracks();t=Go(t=t.filter(n=>i.indexOf(n)!==-1));for(const n of t){if(n instanceof ie){const r=this.localTrackMap.get(U.LocalAudioTrack);if(!r)continue;r.track instanceof Re?(r.track.removeAudioTrack(n),this.unbindLocalAudioTrackEvents(n),r.track.trackList.length===0&&(e.push([U.LocalAudioTrack,r]),r.track.close())):e.push([U.LocalAudioTrack,r])}if(n instanceof Gt){const r=this.localTrackMap.get(U.LocalVideoTrack);if(!r)continue;e.push([U.LocalVideoTrack,r]);const s=this.localTrackMap.get(U.LocalVideoLowTrack);s&&e.push([U.LocalVideoLowTrack,s])}}return e}bindLocalTrackEvents(t){t.forEach(e=>{let{track:i,type:n}=e;switch(n){case U.LocalVideoTrack:i.addListener(z.GET_STATS,this.handleGetLocalVideoStats),i.addListener(z.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(z.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(z.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.addListener(z.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.addListener(z.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.addListener(z.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(z.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case U.LocalAudioTrack:this.bindLocalAudioTrackEvents(i);case U.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof Re?t.trackList.forEach(i=>{i.addListener(z.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(z.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(z.GET_STATS,this.handleGetLocalAudioStats),i.addListener(z.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(z.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(z.GET_STATS,this.handleGetLocalAudioStats),t.addListener(z.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(z.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(z.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(z.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(z.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[i,{track:n}]=e;return{track:n,type:i}})),t.forEach(e=>{let{track:i,type:n}=e;switch(n){case U.LocalVideoTrack:i.off(z.GET_STATS,this.handleGetLocalVideoStats),i.off(z.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(z.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(z.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.off(z.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.off(z.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.off(z.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(z.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case U.LocalAudioTrack:this.unbindLocalAudioTrackEvents(i);case U.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof Re?t.trackList.forEach(e=>{e.off(z.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(z.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(z.GET_STATS,this.handleGetLocalAudioStats),e.off(z.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(z.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(z.GET_STATS,this.handleGetLocalAudioStats),t.off(z.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(z.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(z.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(z.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(z.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof ta&&e.addListener(z.GET_STATS,i=>{i(this.handleGetRemoteVideoStats(t))}),e instanceof ea&&e.addListener(z.GET_STATS,i=>{i(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(z.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;i.has(q.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),i.has(q.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((i,n)=>{var r;let s,{track:o,type:a}=i;switch(a){case U.LocalAudioTrack:s=At.Audio;break;case U.LocalVideoTrack:s=B(r=o._hints).call(r,xt.SCREEN_TRACK)?At.Screen:At.High;break;case U.LocalVideoLowTrack:s=At.Low}return{kind:a===U.LocalAudioTrack?q.AUDIO:q.VIDEO,stream_type:s,mid:e[n].id,ssrcs:e[n].localSSRC,isMuted:o.muted||!o.enabled}})}createGatewayUnpublishMessage(t){return t.map(e=>{var i;let n,[r,{track:s,ssrcs:o,id:a}]=e;switch(r){case U.LocalVideoTrack:n=B(i=s._hints).call(i,xt.SCREEN_TRACK)?At.Screen:At.High;break;case U.LocalAudioTrack:n=At.Audio;break;case U.LocalVideoLowTrack:n=At.Low}return{stream_type:n,ssrcs:o,mid:a}})}assignLocalTracks(t,e){t.forEach((i,n)=>{let{track:r,type:s}=i;this.localTrackMap.set(s,{track:r,id:e[n].id,ssrcs:e[n].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[i]=e;this.localTrackMap.delete(i)})}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{var i;_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(t.name,".onConnectionStateChange(").concat(e,")")),this.emit(Z.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(t.isInRestartIce=!1),B(i=this._restartStates).call(i,e)&&!t.isInRestartIce&&(e==="disconnected"&&await ke(800),t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="failed"||this.handleDisconnect(t.direction))},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),Q.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:Qt.TRACER}).onSuccess(),this.emit(Z.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var i;const n=Array.from(Fi(i=this.remoteUserMap).call(i)).find(s=>s._audioSSRC===e);var r;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),(r=n.audioTrack)===null||r===void 0||r.emit(Jo.FIRST_FRAME_DECODED),Q.firstRemoteFrame(this.store.sessionId,ye.FIRST_AUDIO_DECODE,Ht.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:qe.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var i;const n=Array.from(Fi(i=this.remoteUserMap).call(i)).find(r=>r._audioSSRC===e);n&&Q.firstRemoteFrame(this.store.sessionId,ye.FIRST_AUDIO_RECEIVED,Ht.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:qe.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,i,n)=>{this.reportVideoFirstFrameDecoded(e,i,n)},t.onFirstVideoReceived=e=>{var i;const n=Array.from(Fi(i=this.remoteUserMap).call(i)).find(r=>r._videoSSRC===e);n&&Q.firstRemoteFrame(this.store.sessionId,ye.FIRST_VIDEO_RECEIVED,Ht.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:qe.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,i)=>{const n=e.candidateType==="relay",r=i.candidateType==="relay";i.candidateType!=="unknown"&&n===r||this.emit(Z.ConnectionTypeChange,n),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(es(i))," -> ").concat(JSON.stringify(es(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,i)=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(es(i))," -> ").concat(JSON.stringify(es(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.onLocalCandidate=e=>{this.emit(Z.LocalCandidate,{candidate:e,direction:t.direction})}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.onLocalCandidate=void 0}async handleDisconnect(t){const e=t===oi.SEND_ONLY?this.sendConnection:this.recvConnection;e&&!e.isInRestartIce&&(e.isInRestartIce=!0,_.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(e.name,"] start use restartICE")),t===oi.SEND_ONLY?this.restartICE(t):Be(this,Z.RequestP2PRestartICE,{direction:oi.SEND_ONLY}))}filterTobeMutedTracks(t){const e=[];if(this.getAllTracks().indexOf(t)===-1)return e;const i=this.localTrackMap.get(U.LocalAudioTrack);if(t instanceof ie&&(i==null?void 0:i.track)instanceof Re)return i.track.isActive||e.push([U.LocalAudioTrack,i]),e;const n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:s}]=r;return t===s});if(n&&(e.push(n),n[0]===U.LocalVideoTrack)){const r=this.localTrackMap.get(U.LocalVideoLowTrack);r&&e.push([U.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(t){const e=[],i=this.localTrackMap.get(U.LocalAudioTrack);if(t instanceof ie&&(i==null?void 0:i.track)instanceof Re)return i.track.isActive&&e.push([U.LocalAudioTrack,i]),e;const n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:s}]=r;return t===s});if(n)if(n[0]===U.LocalVideoTrack){e.push(n);const r=this.localTrackMap.get(U.LocalVideoLowTrack);r&&e.push([U.LocalVideoLowTrack,r])}else e.push(n);return e}createMuteMessage(t){return t.map(e=>{var i;let n,[r,{track:s,ssrcs:o,id:a}]=e;switch(r){case U.LocalAudioTrack:n=At.Audio;break;case U.LocalVideoTrack:n=B(i=s._hints).call(i,xt.SCREEN_TRACK)?At.Screen:At.High;break;case U.LocalVideoLowTrack:n=At.Low}return{stream_type:n,ssrcs:o,mid:a}})}createUnmuteMessage(t){return t.map(e=>{var i;let n,[r,{track:s,ssrcs:o,id:a}]=e;switch(r){case U.LocalAudioTrack:n=At.Audio;break;case U.LocalVideoTrack:n=B(i=s._hints).call(i,xt.SCREEN_TRACK)?At.Screen:At.High;break;case U.LocalVideoLowTrack:n=At.Low}return{stream_type:n,ssrcs:o,mid:a}})}filterTobeUnSubscribedTracks(t,e){const i=[],n=this.remoteUserMap.get(t);if(!n)return i;if(e){const r=n.get(e);if(!r)return i;i.push([t,{kind:e,id:r}])}else Array.from(n.entries()).forEach(r=>{let[s,o]=r;i.push([t,{kind:s,id:o}])});return i}createUnsubscribeMessage(t){const e=[];return t.forEach(i=>{let[n,{kind:r,id:s}]=i;switch(r){case q.VIDEO:return void(n._videoSSRC&&e.push({stream_type:q.VIDEO,ssrcId:n._videoSSRC}));case q.AUDIO:return void(n._audioSSRC&&e.push({stream_type:q.AUDIO,ssrcId:n._audioSSRC}))}}),e}withdrawRemoteTracks(t){t.forEach(e=>{let[i,{kind:n}]=e;const r=this.remoteUserMap.get(i);r&&(r.delete(n),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(i))})}async updateBitrateLimit(t){const e=this.localTrackMap.get(U.LocalVideoTrack),i=this.localTrackMap.get(U.LocalVideoLowTrack);e&&(await e.track.setBitrateLimit(t.uplink),await new G((n,r)=>{this.handleUpdateVideoEncoder(e.track,n,r,!0)})),i&&t.low_stream_uplink&&(await i.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0}),await new G((n,r)=>{this.handleUpdateVideoEncoder(i.track,n,r,!0)}))}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const t=this.sendConnection.peerConnectionState,e=this.recvConnection.peerConnectionState;return t!=="connected"&&e!=="connected"}return!0}async tryToUnmuteAudio(t){for(let e=0;e<t.length;e++)if(t[e]instanceof ie){const i=this.filterTobeUnmutedTracks(t[e]);if(i.length===0)continue;const n=this.createUnmuteMessage(i);return void await Mt(this,Z.RequestUnmuteLocal,n)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=t=>this.getStats(t),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(t=>{let[,{ssrcs:e}]=t;return!!e}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.recvConnection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(Z.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(Z.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await ke(mE(this.dtlsFailedCount,ge)),this.emit(Z.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(U.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof Gt)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof Gt).length>1)throw new P(S.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof ie).length>1&&(t.some(e=>e instanceof ie&&e._bypassWebAudio)||!St().webAudioMediaStreamDest))throw new P(S.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof Gt&&this.pendingLocalTracks.some(i=>i instanceof Gt))throw new P(S.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof ie&&this.pendingLocalTracks.some(i=>i instanceof ie)&&(!St().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(i=>i instanceof ie&&i._bypassWebAudio)))throw new P(S.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const i=!C("DISABLE_DUAL_STREAM_USE_ENCODING")&&St().supportDualStreamEncoding,n=Zu(Zu({},{width:160,height:120,framerate:15,bitrate:50}),e);let r;r=i?t._mediaStreamTrack.clone():Im(t,n);const s=Ut(8,"track-low-"),o=new Gt(r,Zu(Zu({},i&&{scaleResolutionDownBy:om(n,t)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,s);return o.on(Us.TRANSCEIVER_UPDATED,a=>{t._updateRtpTransceiver(a,qo.LOW_STREAM)}),o._hints.push(xt.LOW_STREAM),t.addListener(z.NEED_CLOSE,()=>{o.close()}),o}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(t,e,i,n){var r;const s=Array.from(Fi(r=this.remoteUserMap).call(r)).find(o=>o._videoSSRC===t);if(s){n||this.store.subscribe(s.uid,"video",void 0,void 0,void 0,void 0,Date.now());const o=this.store.keyMetrics,a=o.subscribe.find(c=>c.userId===s.uid&&c.type==="video");Q.firstRemoteVideoDecode(this.store.sessionId,ye.FIRST_VIDEO_DECODE,Ht.FIRST_VIDEO_DECODE,{peer:s._uintid,videowidth:e,videoheight:i,subscribeElapse:qe.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:o.requestAPEnd||0,apStart:o.requestAPStart||0,joinGwEnd:o.joinGatewayEnd||0,joinGwStart:o.joinGatewayStart||0,pcEnd:o.peerConnectionEnd||0,pcStart:o.peerConnectionStart||0,subscriberEnd:(a==null?void 0:a.subscribeEnd)||0,subscriberStart:(a==null?void 0:a.subscribeStart)||0,videoAddNotify:(a==null?void 0:a.streamAdded)||0,state:n?1:0})}}async remoteMediaSsrcChanged(t,e,i){if(!this.recvConnection)return!1;const n=this.remoteUserMap.get(t);if(!n)return!1;const r=n.get(e);if(!r)return!1;const s=await this.recvConnection.getRemoteSSRC(r);return s!==void 0&&s!==i}isPreSubScribe(t){return!1}async publishDataChannel(t){throw new P(S.NOT_SUPPORTED)}async unpublishDataChannel(t){throw new P(S.NOT_SUPPORTED)}async subscribeDataChannel(t,e){throw new P(S.NOT_SUPPORTED)}async unsubscribeDataChannel(t,e){throw new P(S.NOT_SUPPORTED)}hasPendingRemoteDataChannel(t,e){throw new P(S.NOT_SUPPORTED)}setPendingRemoteDataChannel(t,e){throw new P(S.NOT_SUPPORTED)}async preConnect(t){throw new P(S.NOT_SUPPORTED)}getEstablishParams(){throw new P(S.NOT_SUPPORTED)}async reSubscribe(t){throw new P(S.NOT_SUPPORTED)}async updateVideoStreamParameter(t,e){throw new P(S.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:i}]=t;e===U.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,qo.LOW_STREAM):i._updateRtpTransceiver(void 0)})}},J(Yt.prototype,"p2pConnect",[uN],Object.getOwnPropertyDescriptor(Yt.prototype,"p2pConnect"),Yt.prototype),J(Yt.prototype,"unpublish",[hN],Object.getOwnPropertyDescriptor(Yt.prototype,"unpublish"),Yt.prototype),J(Yt.prototype,"unpublishLowStream",[pN],Object.getOwnPropertyDescriptor(Yt.prototype,"unpublishLowStream"),Yt.prototype),J(Yt.prototype,"subscribe",[_N],Object.getOwnPropertyDescriptor(Yt.prototype,"subscribe"),Yt.prototype),J(Yt.prototype,"mockSubscribe",[EN],Object.getOwnPropertyDescriptor(Yt.prototype,"mockSubscribe"),Yt.prototype),J(Yt.prototype,"unsubscribe",[mN],Object.getOwnPropertyDescriptor(Yt.prototype,"unsubscribe"),Yt.prototype),J(Yt.prototype,"muteRemote",[fN],Object.getOwnPropertyDescriptor(Yt.prototype,"muteRemote"),Yt.prototype),J(Yt.prototype,"unmuteRemote",[gN],Object.getOwnPropertyDescriptor(Yt.prototype,"unmuteRemote"),Yt.prototype),J(Yt.prototype,"hasRemoteMediaWithLock",[TN],Object.getOwnPropertyDescriptor(Yt.prototype,"hasRemoteMediaWithLock"),Yt.prototype),J(Yt.prototype,"disconnectForReconnect",[SN],Object.getOwnPropertyDescriptor(Yt.prototype,"disconnectForReconnect"),Yt.prototype),J(Yt.prototype,"remoteMediaSsrcChanged",[RN],Object.getOwnPropertyDescriptor(Yt.prototype,"remoteMediaSsrcChanged"),Yt.prototype),Yt);function Hn(t){return function(e,i,n){const r=e[i];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];switch(t){case Wn.SEND_ONLY:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(i));try{return await r.apply(this,o)}finally{c()}}case Wn.RECEIVE_ONLY:{const c=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await r.apply(this,o)}finally{c()}}default:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(i)),d=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await r.apply(this,o)}finally{c(),d()}}}},n}}class io extends qt{constructor(e,i){super(),g(this,"signal",void 0),g(this,"token",void 0),g(this,"tokenTimeout",void 0),g(this,"tokenInterval",void 0),g(this,"_sequence",0),g(this,"userMap",new Map),g(this,"encoder",new TextEncoder),this.signal=e,this.token=i;const n=()=>{this.signal.connectionState===Ft.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(n,1e3):this.tokenInterval=window.setTimeout(n,3*C("P2P_TOKEN_INTERVAL"))};n()}async send(e,i,n,r,s){var o,a,c;if(this.userMap.size===0)return;const d=Array.from(Mi(o=this.userMap).call(o))[0].token;typeof i!="string"&&(i=JSON.stringify(i)),r=(a=r)!==null&&a!==void 0?a:Ut(6,""),s=(c=s)!==null&&c!==void 0?c:this._sequence++;const l={_id:r,_type:e,_seq:s,_message:i,token:"".concat(this.token,"_").concat(d)};C("SHOW_P2P_LOG")&&_.debug("send message",l,"noNeedResponse : ".concat(n)),this.splitMessage(JSON.stringify(l)).forEach(h=>{this.signal.request(it.DATA_STREAM,{payload:Qr(this.encoder.encode(h))})});const u=new G((h,p)=>{const T=window.setTimeout(()=>{this.off("res-@".concat(r,"_ack"),m),this.off("res-@".concat(r),R),this.off(aa.ABORT,f),_.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(r)),this.userMap.size===0?p(new P(S.INVALID_REMOTE_USER)):p(new P(S.TIMEOUT))},C("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),m=()=>{T&&window.clearTimeout(T),this.off(aa.ABORT,f),n&&h()},f=()=>{T&&window.clearTimeout(T),this.off("res-@".concat(r,"_ack"),m),this.off("res-@".concat(r),R),p(new P(S.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(r)))};this.once(aa.ABORT,f),this.once("res-@".concat(r,"_ack"),m);const R=(A,O)=>{v=!0,T&&window.clearTimeout(T),this.off("res-@".concat(r,"_ack"),m),this.off(aa.ABORT,f),A==="success"?h(O):p(new P(S.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(r)))};let v=!1;n||(this.once("res-@".concat(r),R),ke(C("SIGNAL_REQUEST_TIMEOUT")).then(()=>{v||_.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(r,", ").concat(l))}))});try{return await u}catch(h){if(h.code===S.TIMEOUT)return await this.send(e,i,n,r,s);throw h}}onMessage(e){var i;const{_uid:n}=e;let r,s=this.userMap.get(n);if(s)r=s.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==ae.CHECK)return;const{token:d}=e;r=new Map,s={uid:n,isStart:!0,token:d,splitMessageMap:r,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(n,s),this.signal.emit(ut.ON_USER_ONLINE,{uid:n}),this.handleUserOnline()}if("id"in e&&"total"in e){var o;const{id:d,total:l}=e,u=(o=r.get(d))!==null&&o!==void 0?o:[];if(u.push(e),r.has(d)||r.set(d,u),u.length!==l)return;{const h=tc(u).call(u,(p,T)=>p.index-T.index).map(p=>p.payload).join("");r.delete(d),(e=JSON.parse(h))._uid=n}}const{_type:a,token:c}=e;if(B(i=[ae.ACK,ae.CHECK]).call(i,a))return a===ae.CHECK&&this.handleCheckToken(s,c),void this.receiveMessage(e);c==="".concat(s.token,"_").concat(this.token)?this.handleReceivedMessage(e):_.debug('Receive unexpected message", '.concat(c,", cur_token: ").concat(s.token,"_").concat(this.token),e)}check(){const e={_id:Ut(6,""),token:this.token,_type:ae.CHECK};C("SHOW_P2P_LOG")&&_.debug("send message",e),this.signal.request(it.DATA_STREAM,{payload:Qr(this.encoder.encode(JSON.stringify(e)))})}ack(e){const i={_id:e,_type:ae.ACK,token:this.token};C("SHOW_P2P_LOG")&&_.debug("send message",i),this.signal.request(it.DATA_STREAM,{payload:Qr(this.encoder.encode(JSON.stringify(i)))})}response(e,i,n){this.send(ae.RESPONSE,JSON.stringify({success:!n,message:i}),!0,e)}handleReceivedMessage(e){const i=()=>{this.userMap.forEach(d=>{const{receivedMessagesMap:l,nextExpectedSequenceNumber:u}=d;for(;l.has(u);){const h=l.get(u);l.delete(u),this.receiveMessage(h),d.nextExpectedSequenceNumber++}})};if(!e)return void i();const{_uid:n,_seq:r}=e,s=this.userMap.get(n),{receivedMessagesMap:o,isStart:a,nextExpectedSequenceNumber:c}=s;if(r<c)return this.ack(e._id),void _.debug("[external-signal] receive old message, seq: ".concat(r,", ").concat(e._message));o.set(r,e),a&&r===c&&(this.receiveMessage(e),o.delete(c),s.nextExpectedSequenceNumber++,i())}receiveMessage(e){const{_id:i,_type:n,_message:r,_uid:s}=e;if(C("SHOW_P2P_LOG")&&_.debug("receive message",e),i){let o;switch(e._type!==ae.ACK&&(r&&(o=JSON.parse(r)),this.ack(e._id)),e._type){case ae.CANDIDATE:case ae.CONTROL:this.signal.emit(n,o,s);break;case ae.PUBLISH:case ae.UNPUBLISH:case ae.RESTART_ICE:case ae.CALL:o.uid=s,Be(this.signal,n,o).then(a=>{this.response(e._id,a)}).catch(()=>{this.response(e._id,void 0,!0)});break;case ae.ACK:this.getListeners("res-@".concat(i,"_ack")).length>0&&this.emit("res-@".concat(i,"_ack"));break;case ae.RESPONSE:{const{success:a,message:c}=o;this.emit("res-@".concat(i),a?"success":"failed",c);break}}}}splitMessage(e){if(e.length<io.MAX_MESSAGE_SIZE)return[e];const i=[],{remoteToken:n}=JSON.parse(e),r=Ut(6,"");let s=0,o=800;const a=Math.ceil(e.length/o);for(;e.length>0;){s++;const c={id:r,index:s,total:a,payload:e.slice(0,o),token:"".concat(this.token,"_").concat(n)};JSON.stringify(c).length>io.MAX_MESSAGE_SIZE?o-=50:(i.push(c),e=e.slice(o))}return i.map(c=>JSON.stringify(c))}handleCheckToken(e,i){return e.token!==i?(_.debug("token changed, from ".concat(e.token," to ").concat(i)),this.reset(e.uid,i),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{_.debug("token timeout, ".concat(i)),this.reset(e.uid)},C("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const e=await Be(this.signal,ae.CALL,void 0),i=await this.send(ae.CALL,e);this.signal.emit(nt.P2P_CONNECTION,i,!0)}async reset(e,i){const n=this.userMap.get(e);n&&(this.emit(aa.ABORT),this.signal.emit(ut.ON_USER_OFFLINE,{uid:n.uid,reason:$3.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),i||(_.debug("change local token from ".concat(i," to ").concat(i)),this.token=Ut(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(aa.ABORT)}}g(io,"MAX_SIZE",1),g(io,"MAX_MESSAGE_SIZE",1024);class w5 extends qt{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Ft.CONNECTED?this.emit(nt.WS_CONNECTED):e===Ft.RECONNECTING?this.emit(nt.WS_RECONNECTING,this._websocketReconnectReason):e===Ft.CLOSED&&this.emit(nt.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,i){super(),g(this,"_disconnectedReason",void 0),g(this,"_websocketReconnectReason",void 0),g(this,"_connectionState",Ft.CLOSED),g(this,"reconnectToken",void 0),g(this,"p2pToken",void 0),g(this,"websocket",void 0),g(this,"openConnectionTime",void 0),g(this,"clientId",void 0),g(this,"lastMsgTime",Date.now()),g(this,"uploadCache",[]),g(this,"uploadCacheInterval",void 0),g(this,"rttRolling",new $I(5)),g(this,"pingpongTimer",void 0),g(this,"pingpongTimeoutCount",0),g(this,"joinResponse",void 0),g(this,"multiIpOption",void 0),g(this,"initError",void 0),g(this,"spec",void 0),g(this,"store",void 0),g(this,"_external_signal",void 0),g(this,"onWebsocketMessage",n=>{if(n.data instanceof ArrayBuffer)return void this.emit(nt.ON_BINARY_DATA,n.data);const r=JSON.parse(n.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){switch(r._type){case ut.ON_DATA_STREAM:return void this.handleDataStream(r._message);case ut.MUTE_AUDIO:case ut.MUTE_VIDEO:case ut.ON_P2P_LOST:case ut.ON_USER_ONLINE:return;case ut.ON_USER_OFFLINE:const{uid:s}=r._message;return _.debug("[".concat(this.clientId,"] user-offline uid: ").concat(s)),void this._external_signal.reset(s)}if(this.emit(r._type,r._message),r._type===ut.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===ut.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(It.UID_BANNED);break;case 15:this.close(It.IP_BANNED);break;case 16:this.close(It.CHANNEL_BANNED)}if(r._type===ut.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case $.ERR_LICENSE_MISSING:this.close(It.LICENSE_MISSING);break;case $.ERR_LICENSE_EXPIRED:this.close(It.LICENSE_EXPIRED);break;case $.ERR_LICENSE_MINUTES_EXCEEDED:this.close(It.LICENSE_MINUTES_EXCEEDED);break;case $.ERR_LICENSE_PERIOD_INVALID:this.close(It.LICENSE_PERIOD_INVALID);break;case $.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(It.LICENSE_MULTIPLE_SDK_SERVICE);break;case $.ERR_LICENSE_ILLEGAL:this.close(It.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=i,this.websocket=new rm("gateway-".concat(this.clientId),this.spec.retryConfig,!0,C("JOIN_GATEWAY_USE_DUAL_DOMAIN"),C("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Ft.CONNECTED&&this.reconnect("retry",Fe.OFFLINE)}),this.p2pToken=Ut(6,""),this._external_signal=new io(this,this.p2pToken)}async request(e,i,n,r){const s=Ut(6,""),o={_id:s,_type:e,_message:i},a=this.websocket.connectionID,c=()=>new G((T,m)=>{if(this.connectionState===Ft.CONNECTED)return T();const f=()=>{this.off(nt.WS_CLOSED,R),T()},R=()=>{this.off(nt.WS_CONNECTED,f),m(new P(S.WS_ABORT))};this.once(nt.WS_CONNECTED,f),this.once(nt.WS_CLOSED,R)});if(this.connectionState!==Ft.CONNECTING&&this.connectionState!==Ft.RECONNECTING||e===it.JOIN||e===it.REJOIN||await c(),this.websocket.sendMessage(o,!0),r)return;const d=new G((T,m)=>{let f=!1;const R=(A,O)=>{f=!0,T({isSuccess:A==="success",message:O||{}}),this.off(nt.WS_CLOSED,v),this.off(nt.WS_RECONNECTING,v),this.emit(nt.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(s),R);const v=()=>{m(new P(S.WS_ABORT,"type: ".concat(e))),this.off(nt.WS_CLOSED,v),this.off(nt.WS_RECONNECTING,v),this.off("res-@".concat(s),R)};this.once(nt.WS_CLOSED,v),this.once(nt.WS_RECONNECTING,v),ke(C("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||f||(_.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(nt.REQUEST_TIMEOUT,e,i))})});let l=null;try{l=await d}catch(T){if(this.connectionState===Ft.CLOSED||e===it.LEAVE)throw new P(S.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?T.throw():e===it.JOIN||e===it.REJOIN?null:(await c(),await this.request(e,i))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),h=yc(u),p=new P(S.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message,desc:h.desc});return h.action==="success"?l.message:(_.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===$.ERR_TOO_MANY_BROADCASTERS?((e===it.JOIN||e===it.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===$.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Fe.MULTI_IP)):this.reconnect(h.action,Fe.SERVER_ERROR),e===it.JOIN||e===it.REJOIN?null:await this.request(e,i)))}waitMessage(e,i){return new G(n=>{const r=s=>{(!i||i(s))&&(this.off(e,r),n(s))};this.on(e,r)})}uploadWRTCStats(e){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Cc.WRTC_STATS,i)}upload(e,i){const n={_type:e,_message:i};try{this.websocket.sendMessage(n)}catch{const s=C("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Ft.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},C("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,i){const n={_type:e,_message:i};this.websocket.sendMessage(n)}async sendExtensionMessage(e,i,n){return await this._external_signal.send(e,i,n)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new G((i,n)=>{this.once(nt.WS_CONNECTED,()=>i(this.joinResponse)),this.once(nt.WS_CLOSED,()=>n(this.initError||new P(S.WS_ABORT))),this.connectionState=Ft.CONNECTING,this.websocket.init(e).catch(n)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||It.LEAVE,this.connectionState=Ft.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=Ut(6,""),this._external_signal.clear(),this._external_signal=new io(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(nt.ABORT_P2P_EXECUTION);const e=await Be(this,nt.REQUEST_JOIN_INFO),i=await this.request(it.JOIN,e);if(!i)return this.emit(nt.REPORT_JOIN_GATEWAY,S.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(nt.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Ft.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,i)}handleDataStream(e){try{var i;const n=Ls(e.payload),r=new TextDecoder().decode(n),s=JSON.parse(r);"total"in s&&"id"in s||B(i=Object.values(ae)).call(i,s._type)?(s._uid=e.uid,this._external_signal.onMessage(s)):this.emit(ut.ON_DATA_STREAM,e)}catch{this.emit(ut.ON_DATA_STREAM,e)}}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);const i=yc(e.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(It.UID_BANNED),void this.close()):void this.reconnect(i.action,Fe.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=C("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>C("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Fe.TIMEOUT):this.request(it.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const n=Date.now()-i;this.rttRolling.add(n),C("REPORT_STATS")&&this.send(it.PING_BACK,{pingpongElapse:n})}).catch(n=>{})}handleWebsocketEvents(){this.websocket.on(ot.RECONNECT_CREATE_CONNECTION,e=>{this.emit(nt.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(ot.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(ot.CLOSED,()=>{this.connectionState=Ft.CLOSED}),this.websocket.on(ot.FAILED,()=>{this._disconnectedReason=It.NETWORK_ERROR,this.connectionState=Ft.CLOSED}),this.websocket.on(ot.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Ft.CONNECTED?this.connectionState=Ft.RECONNECTING:this.connectionState=Ft.CONNECTING}),this.websocket.on(ot.WILL_RECONNECT,(e,i,n)=>{e!=="retry"?(_.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0):_.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),n(e)}),this.websocket.on(ot.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(e=>{if(this.emit(nt.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof P&&e.code===S.UNEXPECTED_RESPONSE&&e.data.code===$.ERR_NO_AUTHORIZED)return _.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Fe.SERVER_ERROR);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Fe.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(ot.REQUEST_NEW_URLS,(e,i)=>{Be(this,nt.REQUEST_RECOVER,this.multiIpOption).then(e).catch(i)}),this.websocket.on(ot.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(ut.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}const O5={name:"P2PChannel",create:function(t){let{store:e,statsCollector:i}=t;return new b5(e,i)},createSubmodule:function(t){let{store:e,spec:i}=t;return new w5(i,e)}};function CN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function IN(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?CN(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):CN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class N5{constructor(e){g(this,"sessionDesc",void 0),g(this,"localCapabilities",void 0),g(this,"rtpCapabilities",void 0),g(this,"candidates",void 0),g(this,"_originCandidates",void 0),g(this,"iceParameters",void 0),g(this,"dtlsParameters",void 0),g(this,"setup",void 0),g(this,"currentMidIndex",void 0),g(this,"cname",void 0),e=ee(e);const{iceParameters:i,dtlsParameters:n,candidates:r,rtpCapabilities:s,setup:o,localCapabilities:a,sdkCodec:c,cname:d}=e,l=Ti(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=s,this.candidates=r,this._originCandidates=ee(r),this.iceParameters=i,this.dtlsParameters=n,this.setup=o,this.localCapabilities=a,this.cname=d;for(let u=0;u<l.mediaDescriptions.length;u++){const h=l.mediaDescriptions[u];if(h.attributes.iceUfrag=i.iceUfrag,h.attributes.icePwd=i.icePwd,h.attributes.fingerprints=n.fingerprints,h.attributes.candidates=r,h.attributes.setup=o,h.media.mediaType==="video"){h.media.fmts=s.videoCodecs.map(T=>T.payloadType.toString(10));let p=s.videoCodecs.filter(T=>{var m,f;return(m=T.rtpMap)===null||m===void 0?void 0:B(f=m.encodingName.toLowerCase()).call(f,c)});p.length===0&&(p=s.videoCodecs),h.attributes.payloads=p,h.attributes.extmaps=s.videoExtensions}h.media.mediaType==="audio"&&(h.media.fmts=s.audioCodecs.map(p=>p.payloadType.toString(10)),h.attributes.payloads=s.audioCodecs,h.attributes.extmaps=s.audioExtensions),l.mediaDescriptions[u]=this.mungMediaDesc(h)}this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return Zr(this.sessionDesc)}send(e,i,n){const{ssrcs:r,ssrcGroups:s}=Ws(i,this.cname),o=this.sessionDesc.mediaDescriptions.find(d=>e===q.VIDEO?d.media.mediaType==="video":d.media.mediaType==="audio"),a=r[0].attributes.label,c=r[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(r),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(s),{id:a,mslabel:c}}batchSend(e){return e.map(i=>{let{kind:n,ssrcMsg:r}=i;return this.send(n,r,void 0)})}stopSending(e){this.sessionDesc.mediaDescriptions.forEach(i=>{const n=[],r=[],s=[];i.attributes.ssrcs.forEach(o=>{B(e).call(e,o.attributes.label||"")?s.push(o):n.push(o)}),i.attributes.ssrcGroups.forEach(o=>{var a;B(a=s.map(c=>c.ssrcId)).call(a,o.ssrcIds[0])||r.push(o)}),i.attributes.ssrcs=n,i.attributes.ssrcGroups=r})}mute(e){const i=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e);if(!i)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));i.attributes.direction="inactive"}unmute(e){const i=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e);if(!i)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));i.attributes.direction="sendonly"}receive(e,i,n){e.forEach((r,s)=>{const o=r._mediaStreamTrack,a=this.sessionDesc.mediaDescriptions.findIndex(d=>d.attributes.mid===o.kind),c=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[a],r);this.sessionDesc.mediaDescriptions[a]=c})}stopReceiving(e){}updateCandidates(e){const i=this._originCandidates.filter(r=>r.transport==="udp"),n=[];if(i.forEach(r=>{n.push(IN(IN({},r),{},{foundation:"tcpcandidate",priority:Number(r.priority)-1+"",transport:"tcp",port:Number(r.port)+90+""}))}),i.length!==0){switch(e){case Je.TCP_RELAY:this.candidates=n;break;case Je.UDP_TCP_RELAY:case Je.RELAY:this.candidates=[...i,...n];break;default:this.candidates=i}for(const r of this.sessionDesc.mediaDescriptions)r.attributes.candidates=this.candidates}}restartICE(e){e=ee(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(i=>{i.attributes.iceUfrag=e.iceUfrag,i.attributes.icePwd=e.icePwd})}predictReceivingMids(e){const i=[];for(let n=0;n<e;n++)i.push((this.currentMidIndex+n+1).toString(10));return i}mungRecvMediaDsec(e,i){const n=ee(e);return ua(n,i),cm(n,i),n}updateRecvMedia(e,i){const n=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(n!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],i);this.sessionDesc.mediaDescriptions[n]=r}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,i,n){const r=this.sessionDesc.mediaDescriptions.find(o=>e===q.VIDEO?o.attributes.mid==="video":o.attributes.mid==="audio");if(r){const o=r.attributes.ssrcs.find(a=>a.attributes.label===i);var s;o&&(o.attributes.label=n,(s=o.attributes.msid)===null||s===void 0||s.replace(i,n))}}mungMediaDesc(e){const i=ee(e);return am(i),function(n){const r=n.attributes.extmaps.find(s=>Tu(s.extensionName));r&&n.attributes.extmaps.splice(n.attributes.extmaps.indexOf(r),1),n.attributes.payloads.forEach(s=>{const o=s.rtcpFeedbacks.findIndex(a=>a.type==="transport-cc");o!==-1&&s.rtcpFeedbacks.splice(o,1)})}(i),i}getSSRC(e){for(const i of this.sessionDesc.mediaDescriptions)for(const n of i.attributes.ssrcs)if(n.attributes.label===e)return[n]}}var kt;function yN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function $u(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?yN(Object(i),!0).forEach(function(n){g(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):yN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let D5=(kt=class rd extends Nb{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var i;return B(i=Object.keys(zl)).call(i,e)}))]}constructor(e,i){super(e,i),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"remoteSDP",void 0),g(this,"initialOffer",void 0),g(this,"statsFilter",void 0),g(this,"useRTX",!1),g(this,"localCapabilities",void 0),g(this,"localCandidateCount",0),g(this,"allCandidatesReceived",!1),g(this,"establishPromise",void 0),g(this,"mutex",void 0),this.store=i,this.mutex=new Ke("P2PConnection-mutex",i.clientId),this.peerConnection=new RTCPeerConnection(rd.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=vE(this.peerConnection,C("STATS_UPDATE_INTERVAL"),void 0,te()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=is(e.sdp),n=wc(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:C("FILTER_VIDEO_FEC"),filterAudioFec:C("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=n,this.initialOffer=e,$u($u({},i),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:n},offerSDP:e.sdp})}catch(e){throw new P(S.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async updateRemoteConnect(){}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new N5($u($u({},e),{},{rtpCapabilities:e.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));const i=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(i.toString()))}}async updateRemoteRTPCapabilities(e,i){throw new P(S.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(e){}send(e,i){var n=this;return Qi(function*(){const r=yield mt(n.mutex.lock());try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=e.map(h=>n.peerConnection.addTrack(h._mediaStreamTrack)),o=yield mt(n.peerConnection.createOffer()),a=Ti(o.sdp),c=e.map(h=>{const p=h._mediaStreamTrack,T=a.mediaDescriptions.find(m=>m.attributes.mid===p.kind);if(!T)throw new Error("Cannot extract ssrc from mediaDescription.");return function(m,f,R){const v=m.attributes.ssrcs.filter(O=>O.attributes.label===f),A=m.attributes.ssrcGroups;if(v.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(A&&v.length>1){const O=A.find(w=>w.ssrcIds.indexOf(v[0].ssrcId)!==-1);return O?[{ssrcId:O.ssrcIds[0],rtx:R?O.ssrcIds[1]:void 0}]:[{ssrcId:v[0].ssrcId}]}return[{ssrcId:v[0].ssrcId}]}(T,p.id,n.useRTX)});let d;try{d=yield c}catch(h){throw s.forEach(p=>{Ve()&&p.replaceTrack(null),n.peerConnection.removeTrack(p)}),h}const l=n.mungSendOfferSDP(o.sdp,e);n.remoteSDP.receive(e,i,d);const u=n.remoteSDP.toString();return yield mt(n.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield mt(n.applySendEncodings(s,e)),yield mt(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),e.map((h,p)=>{const T=h._mediaStreamTrack.id;return{localSSRC:c[p],id:T}})}catch(s){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{r()}})()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const i=this.peerConnection.getSenders().filter(s=>{var o;return e.indexOf(((o=s.track)===null||o===void 0?void 0:o.id)||"")!==-1});if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");i.map(s=>{Ve()&&s.replaceTrack(null),this.peerConnection.removeTrack(s)});const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(i.toString()))}}async receive(e,i,n,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:s,mslabel:o}=this.remoteSDP.send(e,i,r),a=new G((l,u)=>{const h=setTimeout(()=>{u(new Error("Cannot receive track, id: ".concat(s)))},1e4),p=T=>{const m=Tt();if((m.name==="Safari"&&Number(m.version)===11||ni())&&T.track.id!==s&&T.streams[0].id===o){var f;const R=T.streams[0].getTracks()[0];return(f=this.remoteSDP)===null||f===void 0||f.updateTrackLabel(e,s,T.track.id),this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l(R)}if(T.track.id===s)return this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l(T.track)};this.peerConnection.addEventListener("track",p)}),c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const d=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(d),{track:await a,id:s}}catch(s){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const n=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(n)}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const i=this.peerConnection.getSenders().filter(n=>{var r;return e.indexOf(((r=n.track)===null||r===void 0?void 0:r.id)||"")!==-1});if(i.length!==e.length)throw new Error("sender' length doesn't match mids' length.");i.map(n=>{if(Ve()&&n.track)n.track.enabled=!1;else{const r=n.getParameters();r.encodings.forEach(s=>s.active=!1),n.setParameters(r)}})}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const i=this.peerConnection.getSenders().filter(s=>{var o;return e.indexOf(((o=s.track)===null||o===void 0?void 0:o.id)||"")!==-1});if(i.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");i.map(async s=>{if(Ve()&&s.track)s.track.enabled=!0;else{const o=s.getParameters();o.encodings.forEach(a=>a.active=!0),await s.setParameters(o)}});const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(e){var i=this;return Qi(function*(){const n=yield mt(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=St().supportPCSetConfiguration;if(e===Je.RELAY&&!r)return;if(r){const d=i.peerConnection.getConfiguration(),l=e===Je.RELAY?"relay":"all";d.iceTransportPolicy!==l&&(_.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(l,"]")),d.iceTransportPolicy=l,i.peerConnection.setConfiguration(d))}e!==Je.RELAY&&i.remoteSDP.updateCandidates(e);const s=yield mt(i.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=is(s.sdp),{remoteIceParameters:a}=yield o.iceParameters;i.remoteSDP.restartICE(a);const c=i.remoteSDP.toString();yield mt(i.peerConnection.setLocalDescription(s)),yield mt(i.peerConnection.setRemoteDescription({type:"answer",sdp:c}))}catch(r){_.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),r)}finally{n()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(n.sdp,[i]);this.remoteSDP.updateRecvMedia(i._mediaStreamTrack.kind,i);const s=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new P(S.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(e,i){const n=this.peerConnection.getSenders().filter(r=>{var s;return((s=r.track)===null||s===void 0?void 0:s.id)===e});n.length===1&&await this.applySendEncodings(n,[i])}setStatsRemoteVideoIsReady(e,i){this.statsFilter.setVideoIsReady2(e,i)}async replaceTrack(e,i){const n=this.peerConnection.getSenders().find(r=>{var s;return((s=r.track)===null||s===void 0?void 0:s.id)===i});n&&await n.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,i){throw new P(S.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new P(S.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},C("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const i={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Ec(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...rd.turnServerConfigToIceServers(e.turnServer.servers)),C("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...rd.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(e){const i=[];return e.forEach(n=>{n.security?n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),i}async updateRtpSenderEncodings(e,i){var n;if(i||(i=this.peerConnection.getSenders().find(d=>{var l;return((l=d.track)===null||l===void 0?void 0:l.id)===e._mediaStreamTrack.id})),!i)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!St().supportSetRtpSenderParameters)return _.warn("Browser not support set rtp-sender parameters");const r={},s={};if(e instanceof Gt)switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(C("DSCP_TYPE")&&vr()){var o;const d=C("DSCP_TYPE");B(o=["very-low","low","medium","high"]).call(o,d)&&(s.networkPriority=d)}const a=i.getParameters(),c=(n=a.encodings)===null||n===void 0?void 0:n[0];c&&Object.assign(c,s),Object.assign(a,r),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await i.setParameters(a)}async applySendEncodings(e,i){try{if(!St().supportSetRtpSenderParameters||e.length!==i.length)return;for(let n=0;n<e.length;n++){const r=e[n],s=i[n];r&&s&&await this.updateRtpSenderEncodings(s,r)}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,i){const n=Ti(e);return i.forEach((r,s)=>{const o=r._mediaStreamTrack,a=n.mediaDescriptions.find(c=>c.attributes.mid===o.kind);a&&ua(a,r)}),Zr(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,i,n)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,i,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,i)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,i)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,e,i)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const i=this.remoteSDP.batchSend(e).map((s,o)=>{let{id:a,mslabel:c}=s;const{kind:d}=e[o];return new G((l,u)=>{const h=setTimeout(()=>{u(new Error("Cannot receive track, id: ".concat(a)))},1e4),p=T=>{const m=Tt();if(m.name==="Safari"&&Number(m.version)===11&&T.track.id!==a&&T.streams[0].id===c){var f;const R=T.streams[0].getTracks()[0];return(f=this.remoteSDP)===null||f===void 0||f.updateTrackLabel(d,a,T.track.id),this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l({track:R,id:a})}if(T.track.id===a)return this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l({track:T.track,id:a})};this.peerConnection.addEventListener("track",p)})}),n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(r),await G.all(i)}catch(i){throw new P(S.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const i=this.remoteSDP.getSSRC(e);return i==null?void 0:i[0].ssrcId}setConfiguration(e){if(St().supportPCSetConfiguration){const i=rd.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}},J(kt.prototype,"connect",[on],Object.getOwnPropertyDescriptor(kt.prototype,"connect"),kt.prototype),J(kt.prototype,"stopSending",[on],Object.getOwnPropertyDescriptor(kt.prototype,"stopSending"),kt.prototype),J(kt.prototype,"receive",[on],Object.getOwnPropertyDescriptor(kt.prototype,"receive"),kt.prototype),J(kt.prototype,"stopReceiving",[on],Object.getOwnPropertyDescriptor(kt.prototype,"stopReceiving"),kt.prototype),J(kt.prototype,"muteRemote",[on],Object.getOwnPropertyDescriptor(kt.prototype,"muteRemote"),kt.prototype),J(kt.prototype,"unmuteRemote",[on],Object.getOwnPropertyDescriptor(kt.prototype,"unmuteRemote"),kt.prototype),J(kt.prototype,"muteLocal",[on],Object.getOwnPropertyDescriptor(kt.prototype,"muteLocal"),kt.prototype),J(kt.prototype,"unmuteLocal",[on],Object.getOwnPropertyDescriptor(kt.prototype,"unmuteLocal"),kt.prototype),J(kt.prototype,"close",[on],Object.getOwnPropertyDescriptor(kt.prototype,"close"),kt.prototype),J(kt.prototype,"updateEncoderConfig",[on],Object.getOwnPropertyDescriptor(kt.prototype,"updateEncoderConfig"),kt.prototype),J(kt.prototype,"updateSendParameters",[on],Object.getOwnPropertyDescriptor(kt.prototype,"updateSendParameters"),kt.prototype),J(kt.prototype,"replaceTrack",[on],Object.getOwnPropertyDescriptor(kt.prototype,"replaceTrack"),kt.prototype),J(kt.prototype,"getRemoteSSRC",[on],Object.getOwnPropertyDescriptor(kt.prototype,"getRemoteSSRC"),kt.prototype),kt);function on(t,e,i){const n=t[e];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const r=this.mutex,s=await r.lock("Locking from P2PConnection.".concat(e));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{s()}},i}const P5={name:"PlanBConnection",create:function(t){let{store:e,spec:i}=t;return new D5(i,e)}};CE(),Ot("PROCESS_ID","process-".concat(Ut(8,""),"-").concat(Ut(4,""),"-").concat(Ut(4,""),"-").concat(Ut(4,""),"-").concat(Ut(12,""))),function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void _.error("Error loading sdk config",e.message)}if(t)try{const e=JSON.parse(window.atob(t)),i=Date.now();_.debug("Loading global parameters from cache",e),Object.keys(e).forEach(n=>{if(Object.prototype.hasOwnProperty.call(zt,n)){const{value:r,expires:s}=e[n];if(s&&s<=i)return;xn[n]=r,zt[n]=r}})}catch(e){_.error("Error loading mutableParamsCache: ".concat(t),e.message)}}(),Array.isArray(xn.AREAS)&&xn.AREAS.length>0&&pm(xn.AREAS,!0);const AN=(t,e,i)=>{_.debug("setParameter key:".concat(t,", value:").concat(JSON.stringify(e))),Ot(t,e,i)};Hs(n5,!1),Hs(o5,!1),Hs(WW,!1),Hs(f5,!1),Hs(t5,!1),Hs(O5,!1),Hs(P5,!1);const Te=function(t){const e=new qt,i=t,n={getListeners:e.getListeners.bind(e),on:(r,s)=>(function(o,a){o===rr.SECURITY_POLICY_VIOLATION&&r0(a,!0)}(r,s),e.on.bind(e)(r,s)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return n0(n0({},i),n)}({__TRACK_LIST__:Yo,VERSION:Zi,BUILD:AE,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:AN,getParameter:C,getSupportedCodec:async function(){let t={audio:[],video:[]};try{let e=new RTCPeerConnection;const i=await async function(n){let r;return St().supportUnifiedPlan?(n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"}),r=(await n.createOffer()).sdp):r=(await n.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,r}(e);if(!i)return t;e.close(),e=null,t=function(n){const r={video:[],audio:[]};return n.match(/ VP8/i)&&r.video.push("VP8"),n.match(/ VP9/i)&&r.video.push("VP9"),n.match(/ AV1/i)&&r.video.push("AV1"),n.match(/ H264/i)&&r.video.push("H264"),n.match(/ H265/i)&&r.video.push("H265"),n.match(/ opus/i)&&r.audio.push("OPUS"),n.match(/ PCMU/i)&&r.audio.push("PCMU"),n.match(/ PCMA/i)&&r.audio.push("PCMA"),n.match(/ G722/i)&&r.audio.push("G722"),r}(i)}catch(e){throw new D(S.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return t},checkSystemRequirements:function(){const t=Q.reportApiInvoke(null,{name:fe.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:Qt.TRACER});let e=!1;try{const s=window.RTCPeerConnection,o=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,a=window.WebSocket;e=!!(s&&o&&a),e&&cE()&&wI(75)&&new s().close()}catch(s){return _.error("check system requirement failed: ",s),!1}let i=!1;const n=Tt();n.name===Ct.CHROME&&Number(n.version)>=58&&(Mn.engine.name!=="WebKit"||function(){const s=Tt();if(Fl()){if(s.os===Ie.MAC_OS)return!0;if(s.os===Ie.IOS){const o=Mn.os.version&&Mn.os.version.split(".");if(o&&Number(o[0])===14&&o[1]&&Number(o[1])>=3||o&&Number(o[0])>14)return!0}}return!1}())&&(i=!0),(n.name===Ct.FIREFOX&&Number(n.version)>=56||n.name===Ct.OPERA&&Number(n.version)>=45||n.name===Ct.SAFARI&&Number(n.version)>=11||n.name==="WebKit"&&(ni()||mn())&&n.osVersion&&Number(n.osVersion.split(".")[0])>=11||kI()||Tt().name===Ct.QQ)&&(i=!0),_.debug("checkSystemRequirements, api:",e,"browser",i);const r=e&&i;return t.onSuccess(r),r},getDevices:function(t){return Hi.enumerateDevices(!0,!0,t)},getMicrophones:function(t){return Hi.getRecordingDevices(t)},getCameras:function(t){return Hi.getCamerasDevices(t)},getElectronScreenSources:Ay,getPlaybackDevices:function(t){return Hi.getSpeakers(t)},createClient:function(){var t;let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const i=Ut(5,"client-"),n=Q.reportApiInvoke(null,{id:i,name:fe.CREATE_CLIENT,options:[e],tag:Qt.TRACER});try{(function(r){Ce(r.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),Ce(r.mode,"config.mode",["rtc","live","p2p"]),r.audioCodec!==void 0&&Ce(r.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),r.proxyServer!==void 0&&Le(r.proxyServer,"config.proxyServer",1,1e4),r.turnServer!==void 0&&GI(r.turnServer),r.httpRetryConfig!==void 0&&jI(r.httpRetryConfig),r.websocketRetryConfig!==void 0&&jI(r.websocketRetryConfig)})(e)}catch(r){throw n.onError(r),r}return(NI(16,0)||DI(16,0))&&(e.codec==="vp9"&&(e.codec="vp8",_.debug("browser not support vp9, force use vp8")),Ot("UNSUPPORTED_VIDEO_CODEC",["vp9"])),e.audioCodec===void 0&&(e.audioCodec="opus"),n.onSuccess(),new HW(In(In({forceWaitGatewayResponse:!0},e),{},{role:B(t=["rtc","p2p"]).call(t,e.mode)?"host":e.role||"audience"}),i)},createCameraVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=C("CAMERA_CAPTURE_CONFIG"),i=Ut(8,"track-cam-"),n=Q.reportApiInvoke(null,{id:i,tag:Qt.TRACER,name:fe.CREATE_CAM_VIDEO_TRACK,options:[Kt({},t),e]});e&&(t.encoderConfig=e);const r=tu(t);let s=null;_.info("start create camera video track with config",JSON.stringify(t),"trackId",i);try{s=(await Wi({video:r},i)).getVideoTracks()[0]||null}catch(a){throw n.onError(a),a}if(!s){const a=new P(S.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(a),a.throw(_)}t.optimizationMode&&WE(i,s,t,er(t.encoderConfig));const o=new GE(s,t,r,t.scalabiltyMode?Xl(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,i);return n.onSuccess(o.getTrackId()),_.info("create camera video success, trackId:",i),o},createCustomVideoTrack:function(t){const e=Ut(8,"track-cus-"),i=Q.reportApiInvoke(null,{id:e,tag:Qt.TRACER,name:fe.CREATE_CUSTOM_VIDEO_TRACK,options:[t]}),n=new Gt(t.mediaStreamTrack,{width:t.width,height:t.height,frameRate:t.frameRate,bitrateMax:t.bitrateMax,bitrateMin:t.bitrateMin},t.scalabiltyMode?Xl(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,e,[xt.CUSTOM_TRACK]);return i.onSuccess(n.getTrackId()),_.info("create custom video track success with config",t,"trackId",n.getTrackId()),n},createScreenVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const i=typeof e=="object"?function(h){return Uy(h)}(e):void 0;i&&(e="auto");const n=Ut(8,"track-scr-v-"),r=Q.reportApiInvoke(null,{id:n,tag:Qt.TRACER,name:fe.CREATE_SCREEN_VIDEO_TRACK,options:[Kt({},t),e]});t.encoderConfig?typeof t.encoderConfig=="string"||t.encoderConfig.width&&t.encoderConfig.height||(t.encoderConfig.width={max:1920},t.encoderConfig.height={max:1080}):t.encoderConfig="1080p_2";const s=function(h){const p={};h.screenSourceType&&(p.mediaSource=h.screenSourceType),h.extensionId&&Rr()&&(p.extensionId=h.extensionId);const{displaySurface:T,selfBrowserSurface:m,surfaceSwitching:f,systemAudio:R,preferCurrentTab:v}=h;(Fo(107)||sE(107)||oE(93))&&(T&&(Ce(T,"displaySurface",["browser","window","monitor"]),p.displaySurface=T),m?(Ce(m,"selfBrowserSurface",["exclude","include"]),p.selfBrowserSurface=m):p.selfBrowserSurface="include",f&&(Ce(f,"surfaceSwitching",["exclude","include"]),p.surfaceSwitching=f)),(Fo(105)||sE(105)||oE(91))&&R&&(Ce(R,"systemAudio",["exclude","include"]),p.systemAudio=R),(Fo(94)||sE(94)||oE(80))&&v&&(p.preferCurrentTab=!0),h.electronScreenSourceId&&(p.sourceId=h.electronScreenSourceId);const A=h.encoderConfig?DE(h.encoderConfig):null;return p.mandatory={chromeMediaSource:"desktop",maxWidth:A?A.width:void 0,maxHeight:A?A.height:void 0},A&&(A.frameRate&&(typeof A.frameRate=="number"?(p.mandatory.maxFrameRate=A.frameRate,p.mandatory.minFrameRate=A.frameRate):(p.mandatory.maxFrameRate=A.frameRate.max||A.frameRate.ideal||A.frameRate.exact||void 0,p.mandatory.minFrameRate=A.frameRate.min||A.frameRate.ideal||A.frameRate.exact||void 0),p.frameRate=A.frameRate),A.width&&(p.width=A.width),A.height&&(p.height=A.height)),p}(t);let o=null,a=null;const c=St();if(!c.supportShareAudio&&e==="enable"){const h=new P(S.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return r.onError(h),h.throw(_)}_.info("start create screen video track with config",t,"withAudio",e,"trackId",n);const d=c.supportShareAudio&&e!=="disable";try{const h=await Wi({screen:s,screenAudio:d?i||!0:void 0},n);o=h.getVideoTracks()[0]||null,a=h.getAudioTracks()[0]||null}catch(h){throw r.onError(h),h}if(!o){const h=new P(S.UNEXPECTED_ERROR,"can not find track in media stream");return r.onError(h),h.throw(_)}if(!a&&e==="enable"){o&&o.stop();const h=new P(S.SHARE_AUDIO_NOT_ALLOWED);return r.onError(h),h.throw(_)}t.optimizationMode||(t.optimizationMode="detail"),t.optimizationMode&&(WE(n,o,t,t.encoderConfig&&DE(t.encoderConfig)||void 0),t.encoderConfig&&typeof t.encoderConfig!="string"&&(t.encoderConfig.bitrateMin=t.encoderConfig.bitrateMax));const l=new Gt(o,t.encoderConfig?DE(t.encoderConfig):{},t.scalabiltyMode?Xl(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,n,[xt.SCREEN_TRACK]);if(!a)return r.onSuccess(l.getTrackId()),_.info("create screen video track success","video:",l.getTrackId()),l;const u=new ie(a,void 0,Ut(8,"track-scr-a-"),!1);return r.onSuccess([l.getTrackId(),u.getTrackId()]),_.info("create screen video track success","video:",l.getTrackId(),"audio:",u.getTrackId()),[l,u]},createMicrophoneAndCameraTracks:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const i=C("CAMERA_CAPTURE_CONFIG"),n=Ut(8,"track-mic-"),r=Ut(8,"track-cam-"),s=Q.reportApiInvoke(null,{id:"".concat(n,"-").concat(r),tag:Qt.TRACER,name:fe.CREATE_MIC_AND_CAM_TRACKS,options:[t,e,i]});i&&(e.encoderConfig=i);const o=tu(e),a=xy(t);let c=null,d=null;_.info("start create camera video track(".concat(r,") and microphone audio track(").concat(n,") with config, audio: ").concat(JSON.stringify(t),", video: ").concat(JSON.stringify(e)));try{const h=await Wi({audio:a,video:o},"".concat(n,"-").concat(r));c=h.getAudioTracks()[0],d=h.getVideoTracks()[0]}catch(h){throw s.onError(h),h}if(!c||!d){const h=new P(S.UNEXPECTED_ERROR,"can not find tracks in media stream");return s.onError(h),h.throw(_)}e.optimizationMode&&WE(r,d,e,er(e.encoderConfig));const l=new eu(c,t,a,n),u=new GE(d,e,o,e.scalabiltyMode?Xl(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,r);return s.onSuccess([l.getTrackId(),u.getTrackId()]),_.info("create camera video track(".concat(r,") and microphone audio track(").concat(n,") success")),[l,u]},createMicrophoneAudioTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=Ut(8,"track-mic-"),i=Q.reportApiInvoke(null,{id:e,tag:Qt.TRACER,name:fe.CREATE_MIC_AUDIO_TRACK,options:[t]}),n=xy(t);let r=null;_.info("start create microphone audio track with config",JSON.stringify(t),"trackId",e);try{r=(await Wi({audio:n},e)).getAudioTracks()[0]||null}catch(o){throw i.onError(o),o}if(!r){const o=new P(S.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(o),o.throw(_)}const s=new eu(r,t,n,e);return i.onSuccess(s.getTrackId()),_.info("create microphone audio track success, trackId:",e),s},createCustomAudioTrack:function(t){const e=Ut(8,"track-cus-"),i=Q.reportApiInvoke(null,{id:e,tag:Qt.TRACER,name:fe.CREATE_CUSTOM_AUDIO_TRACK,options:[t]}),n=new ie(t.mediaStreamTrack,t.encoderConfig?Ql(t.encoderConfig):{},e,!1);return _.info("create custom audio track success with config",t,"trackId",n.getTrackId()),i.onSuccess(n.getTrackId()),n},createBufferSourceAudioTrack:async function(t){var e;const{cacheOnlineFile:i,encoderConfig:n}=t;let{source:r}=t;const s={source:r instanceof AudioBuffer?"AudioBuffer":r instanceof File?(e=File.name)!==null&&e!==void 0?e:"File":r,cacheOnlineFile:i,encoderConfig:n},o=Ut(8,"track-buf-"),a=Q.reportApiInvoke(null,{id:o,tag:Qt.TRACER,name:fe.CREATE_BUFFER_AUDIO_TRACK,options:[s]});if(C("DISABLE_WEBAUDIO"))throw new P(S.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");_.info("start create buffer source audio track with config",JSON.stringify(s),"trackId",o);const c=r;if(!(r instanceof AudioBuffer))try{r=await async function(u,h){let p=null;if(typeof u=="string"){const m=CA.get(u);if(m)return _.debug("use cached audio resource: ",u),m;try{p=(await Un(()=>li.get(u,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(f){throw new P(S.FETCH_AUDIO_FILE_FAILED,f.toString())}}else p=await new G((f,R)=>{const v=new FileReader;v.onload=A=>{A.target?f(A.target.result):R(new P(S.READ_LOCAL_AUDIO_FILE_ERROR))},v.onerror=()=>{R(new P(S.READ_LOCAL_AUDIO_FILE_ERROR))},v.readAsArrayBuffer(u)});const T=await function(m){const f=Zo();return new G((R,v)=>{f.decodeAudioData(m,A=>{R(A)},A=>{v(new P(S.DECODE_AUDIO_FILE_FAILED,A.toString()))})})}(p);return typeof u=="string"&&h&&CA.set(u,T),T}(r,i)}catch(u){return a.onError(u),u.throw(_)}const d=new l3(r),l=new d3(c,d,n?Ql(n):{},o);return _.info("create buffer source audio track success, trackId:",o),a.onSuccess(l.getTrackId()),l},setAppType:function(t){if(_.debug("setAppType: ".concat(t)),!(Number.isInteger(t)&&t>=0))throw _.debug("Invalid appType"),new D(S.INVALID_PARAMS,"invalid app type",t);Ot("APP_TYPE",Math.floor(t))},setLogLevel:function(t){_.setLogLevel(t)},enableLogUpload:function(){C("USE_NEW_LOG")?Ot("UPLOAD_LOG",!0):_.enableLogUpload()},disableLogUpload:function(){C("USE_NEW_LOG")?Ot("UPLOAD_LOG",!1):_.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new Sw},checkAudioTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=Q.reportApiInvoke(null,{tag:Qt.TRACER,name:fe.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof ie||t instanceof ea)){const c=new D(S.INVALID_TRACK,"the parameter is not a audio track");return i.onError(c),c.throw()}e&&e<1e3&&(e=1e3);const n=t instanceof ie?t.getTrackLabel():"remote_track",r=t.getVolumeLevel();let s=r,o=r;const a=Date.now();return new G(c=>{const d=setInterval(()=>{const l=t.getVolumeLevel();s=l>s?l:s,o=l<o?l:o;const u=s-o>1e-4,h=Date.now()-a;if(u||h>e){clearInterval(d);const p=u,T={duration:h,deviceLabel:n,maxVolumeLevel:s,result:p};_.info("[track-".concat(t.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(T))),i.onSuccess(T),c(p)}},200)})},checkVideoTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=Q.reportApiInvoke(null,{tag:Qt.TRACER,name:fe.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof Gt||t instanceof ta)){const u=new D(S.INVALID_TRACK,"the parameter is not a video track");return i.onError(u),u.throw()}e&&e<1e3&&(e=1e3);const n=t instanceof Gt?t.getTrackLabel():"remote_track",r=t.getMediaStreamTrack(!0),s=document.createElement("video");s.style.width="1px",s.style.height="1px",s.setAttribute("muted",""),s.muted=!0,s.setAttribute("playsinline",""),s.controls=!1,(Ve()||Fl())&&(s.style.opacity="0.01",s.style.position="fixed",s.style.left="0",s.style.top="0",document.body.appendChild(s)),s.srcObject=new MediaStream([r]),s.play();const o=document.createElement("canvas");o.width=160,o.height=120;let a=0,c=0;try{const u=Date.now();a=await function(h,p,T,m){let f,R=0,v=null;return new G((A,O)=>{function w(){R>m&&f&&(f(),A(R));const b=T.getContext("2d");if(!b){const W=new D(S.UNEXPECTED_ERROR,"can not get canvas 2d context.");return _.error(W.toString()),void O(W)}b.drawImage(h,0,0,160,120);const L=b.getImageData(0,0,T.width,T.height),x=Math.floor(L.data.length/3);if(v){for(let W=0;W<x;W+=3)if(L.data[W]!==v[W])return R+=1,void(v=L.data);v=L.data}else v=L.data}setTimeout(()=>{f&&(f(),A(R))},p),f=UE(()=>{w()},30)})}(s,e,o,4),c=Date.now()-u}catch(u){throw i.onError(u),u}DW===Ct.SAFARI&&(s.pause(),s.remove()),s.srcObject=null;const d=a>4,l={duration:c,changedPicNum:a,deviceLabel:n,result:d};return _.info("[track-".concat(t.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(l))),i.onSuccess(l),d},setArea:pm,audioElementPlayCenter:ui,resumeAudioContext:function(){ui.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(t){YW.processExternalMediaAEC(t)},registerExtensions:function(t){const e=C("PLUGIN_INFO")||[];t.forEach(i=>{"name"in i&&!B(e).call(e,i.name)&&e.push(i.name);const n=i;n.__registered__=!0,n.logger.hookLog=_.extLog,n.reporter.hookApiInvoke=Q.extApiInvoke,n.parameters&&Object.keys(n.parameters).forEach(r=>{n.parameters[r]=C(r)})}),AN("PLUGIN_INFO",e)},ChannelMediaRelayError:sa,ChannelMediaRelayEvent:br,ChannelMediaRelayState:Si,RemoteStreamFallbackType:i3,RemoteStreamType:e3,ConnectionDisconnectedReason:It,AudienceLatencyLevelType:PG,AREAS:Rt,preload:async function(t,e,i,n){return qw(t,e,i,n)}});return Object.defineProperties(Te,{onAudioAutoplayFailed:{get:()=>Ki.onAudioAutoplayFailed,set:t=>{Ki.onAudioAutoplayFailed=t}},onAutoplayFailed:{get:()=>Ki.onAutoplayFailed,set:t=>{Ki.onAutoplayFailed=t}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>Te._onSecurityPolicyViolation,set(t){Te._onSecurityPolicyViolation=t,r0(t)}},__CLIENT_LIST__:{get:()=>C("SHOW_GLOBAL_CLIENT_LIST")?js:[]}}),Hi.on(xs.CAMERA_DEVICE_CHANGED,t=>{_.info("camera device changed",JSON.stringify(t)),Te.onCameraChanged&&Te.onCameraChanged(t),Te.safeEmit(rr.CAMERA_CHANGED,t)}),Hi.on(xs.RECORDING_DEVICE_CHANGED,t=>{_.info("microphone device changed",JSON.stringify(t)),Te.onMicrophoneChanged&&Te.onMicrophoneChanged(t),Te.safeEmit(rr.MICROPHONE_CHANGED,t)}),Hi.on(xs.PLAYOUT_DEVICE_CHANGED,t=>{_.debug("playout device changed",JSON.stringify(t)),Te.onPlaybackDeviceChanged&&Te.onPlaybackDeviceChanged(t),Te.safeEmit(rr.PLAYBACK_DEVICE_CHANGED,t)}),ui.onAutoplayFailed=()=>{_.info("detect audio element autoplay failed"),Ki.onAudioAutoplayFailed&&Ki.onAudioAutoplayFailed()},Nt.on("autoplay-failed",()=>{_.info("detect webaudio autoplay failed"),Ki.onAudioAutoplayFailed&&Ki.onAudioAutoplayFailed(),Te.safeEmit(rr.AUTOPLAY_FAILED)}),Nt.on(Ue.STATE_CHANGE,(t,e)=>{_.info("audio context state changed: ".concat(e," => ").concat(t)),Te.onAudioContextStateChanged&&Te.onAudioContextStateChanged(t,e),Te.safeEmit(rr.AUDIO_CONTEXT_STATE_CHANGED,t,e)}),ue.on(jo.NETWORK_STATE_CHANGE,(t,e)=>{_.info("[network-indicator] network state changed, ".concat(e," => ").concat(t))}),window&&(window.__ARTC__=Te),Te})})(wN);var DN=wN.exports;const M5=L5(DN),W5=k5({__proto__:null,default:M5},[DN]);export{W5 as A};
